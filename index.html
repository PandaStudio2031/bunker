<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="БУНКЕР">
<meta name="theme-color" content="#0a0a0f">
<meta name="msapplication-navbutton-color" content="#0a0a0f">
<link rel="manifest" href="data:application/json;charset=utf-8,{&quot;name&quot;:&quot;БУНКЕР&quot;,&quot;short_name&quot;:&quot;БУНКЕР&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;fullscreen&quot;,&quot;background_color&quot;:&quot;%230a0a0f&quot;,&quot;theme_color&quot;:&quot;%230a0a0f&quot;,&quot;orientation&quot;:&quot;portrait&quot;}">
<title>☢ БУНКЕР</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
/* ╔══════════════════════════════════════════════════════╗
   ║  DESIGN SYSTEM — MODERN MINIMAL / APPLE-INSPIRED     ║
   ╚══════════════════════════════════════════════════════╝ */
:root {
  --bg:        #0a0a0f;
  --s1:        rgba(18,18,28,0.90);
  --s2:        rgba(22,22,34,0.85);
  --s3:        rgba(12,12,20,0.97);

  --a:         #f0a500;
  --a2:        #ffc235;
  --at:        rgba(240,165,0,0.08);
  --ab:        rgba(240,165,0,0.18);
  --ag:        rgba(240,165,0,0.45);

  --r:         #ff453a;
  --rt:        rgba(255,69,58,0.10);
  --rb:        rgba(255,69,58,0.25);

  --g:         #30d158;
  --gt:        rgba(48,209,88,0.08);
  --gb:        rgba(48,209,88,0.22);

  --c:         #0a84ff;
  --p:         #bf5af2;

  --tx:        #e8e8ed;
  --tx2:       #8e8e99;
  --tx3:       #3a3a4a;

  --nav-h:     76px;
  --safe-bot:  env(safe-area-inset-bottom, 0px);
  --bl:        blur(24px) saturate(180%);
  --bl-sm:     blur(12px) saturate(160%);
  --rad:       16px;
  --rad-sm:    10px;
  --rad-lg:    22px;
}

*, *::before, *::after { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent }
html, body { width:100%; height:100%; overflow:hidden; font-family:'Inter','SF Pro Display',system-ui,sans-serif; color:var(--tx); }
::-webkit-scrollbar { width:3px } ::-webkit-scrollbar-thumb { background:rgba(255,255,255,.1); border-radius:2px; }

/* ──────────────── APP ROOT ──────────────── */
#app {
  position:fixed; inset:0;
  display:flex; flex-direction:column;
  overflow:hidden;
  background:
    radial-gradient(ellipse 80% 50% at 50% 100%, rgba(240,165,0,0.06) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 10% 10%,  rgba(10,132,255,0.04) 0%, transparent 55%),
    #0a0a0f;
}
#app::before { display:none; }
#app::after  { display:none; }

/* ──────────────── SCREEN AREA ──────────────── */
#screen-area {
  flex:1; display:flex; flex-direction:column;
  overflow:hidden; position:relative; z-index:1;
  min-height:0;
}

.sc { flex:1; display:flex; flex-direction:column; overflow:hidden; animation:fadeUp .2s ease; }

/* ──────────────── ANIMATIONS ──────────────── */
@keyframes fadeUp  { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }
@keyframes splashFadeOut { from{opacity:1} to{opacity:0;pointer-events:none} }
@keyframes splashGlow { 0%,100%{filter:drop-shadow(0 0 18px rgba(240,165,0,.7))} 50%{filter:drop-shadow(0 0 48px rgba(240,165,0,1))} }
@keyframes splashBar { from{width:0%} to{width:100%} }
@keyframes splashScan { from{background-position:0 0} to{background-position:0 100%} }
@keyframes confettiFall { from{transform:translateY(-20px) rotate(0deg);opacity:1} to{transform:translateY(110vh) rotate(720deg);opacity:0} }
@keyframes skullFloat { 0%{transform:translateY(0) rotate(-10deg);opacity:.5} 50%{transform:translateY(-15px) rotate(10deg);opacity:.8} 100%{transform:translateY(0) rotate(-10deg);opacity:.5} }

.splash-screen {
  position:fixed;inset:0;z-index:99999;background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
}
.splash-screen.done { animation:splashFadeOut .5s ease forwards; pointer-events:none; }
.splash-logo { font-size:90px;line-height:1;animation:splashGlow 2s ease infinite; color:var(--a); }
.splash-title { font-family:'Share Tech Mono',monospace;font-size:28px;font-weight:700;color:var(--a);letter-spacing:6px;margin-top:16px;text-align:center; }
.splash-sub { font-size:10px;color:var(--tx3);letter-spacing:3px;text-align:center;margin-top:8px;font-family:'Inter',sans-serif; }
.splash-bar-wrap { width:220px;height:3px;background:rgba(255,255,255,0.08);border-radius:2px;margin-top:32px;overflow:hidden; }
.splash-bar { height:100%;background:var(--a);border-radius:2px;animation:splashBar 2.5s ease forwards; }
.splash-scanlines {
  position:absolute;inset:0;pointer-events:none;
  background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(240,165,0,.03) 3px,rgba(240,165,0,.03) 6px);
}
.player-game-card {
  background:linear-gradient(135deg,rgba(255,255,255,0.05),rgba(255,255,255,0.02));
  border:1px solid rgba(255,255,255,0.1);border-radius:14px;padding:14px 16px;margin-bottom:10px;
  display:flex;gap:0;position:relative;overflow:hidden;
}
.player-game-card-accent { width:4px;border-radius:3px 0 0 3px;flex-shrink:0;margin-left:-16px;margin-right:12px; }
.player-game-card.elim { opacity:0.4; }
.card-chip {
  border-radius:6px;padding:3px 8px;font-size:11px;display:inline-block;margin:2px 3px 2px 0;
}
.avatar-picker-grid { display:grid;grid-template-columns:repeat(6,1fr);gap:6px;padding:10px 0; }
.avatar-picker-btn { font-size:24px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:8px;cursor:pointer;transition:.2s ease;text-align:center;line-height:1;position:relative;overflow:hidden; }
.avatar-picker-btn:hover { background:linear-gradient(135deg,rgba(155,89,239,0.25),rgba(10,132,255,0.2));border-color:rgba(155,89,239,0.5);transform:scale(1.1);box-shadow:0 4px 14px rgba(155,89,239,0.3); }
.avatar-picker-btn.selected { background:linear-gradient(135deg,rgba(155,89,239,0.35),rgba(10,132,255,0.3));border-color:rgba(155,89,239,0.8);box-shadow:0 0 16px rgba(155,89,239,0.5),0 4px 14px rgba(10,132,255,0.3);transform:scale(1.08); }
@keyframes pulse   { 0%,100%{opacity:1}50%{opacity:.3} }
@keyframes spin    { to{transform:rotate(360deg)} }
@keyframes glow    { 0%,100%{filter:drop-shadow(0 0 10px rgba(240,165,0,.55))} 50%{filter:drop-shadow(0 0 26px rgba(240,165,0,.9))} }
@keyframes glitch  { 0%,87%,100%{clip-path:none;transform:none} 88%{clip-path:inset(28% 0 52% 0);transform:translateX(-3px)} 89%{clip-path:inset(52% 0 18% 0);transform:translateX(3px)} 90%{clip-path:none} }
@keyframes shake   { 0%{transform:rotate(-5deg) scale(1)} 100%{transform:rotate(5deg) scale(1.05)} }
@keyframes slideUp { from{transform:translateY(100%);opacity:0} to{transform:none;opacity:1} }
@keyframes blink   { 0%,100%{opacity:1} 50%{opacity:0} }
@keyframes flipIn  { from{transform:rotateY(90deg);opacity:0} to{transform:rotateY(0deg);opacity:1} }
@keyframes elimOverlayIn { 0%{opacity:0;transform:scale(1.08)} 100%{opacity:1;transform:scale(1)} }
@keyframes roundTimerPulse { 0%,100%{box-shadow:0 0 8px rgba(255,69,58,.4)} 50%{box-shadow:0 0 20px rgba(255,69,58,.9)} }

/* ──────────────── THEMES ──────────────── */
body.theme-dark  { }
body.theme-alarm {
  --bg: #0f0303; --s1: rgba(28,8,8,0.90); --s2: rgba(32,10,10,0.85); --s3: rgba(20,4,4,0.97);
  --a: #ff453a; --a2: #ff6b63; --at: rgba(255,69,58,0.08); --ab: rgba(255,69,58,0.18); --ag: rgba(255,69,58,0.45);
  --tx3: #4a2a2a;
}
body.theme-alarm #app {
  background: radial-gradient(ellipse 80% 50% at 50% 100%, rgba(255,69,58,0.08) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 10% 10%, rgba(139,0,0,0.06) 0%, transparent 55%), #0f0303;
}
body.theme-radiation {
  --bg: #030f03; --s1: rgba(8,28,8,0.90); --s2: rgba(10,32,10,0.85); --s3: rgba(4,20,4,0.97);
  --a: #30d158; --a2: #5ee67a; --at: rgba(48,209,88,0.08); --ab: rgba(48,209,88,0.18); --ag: rgba(48,209,88,0.45);
  --tx3: #2a4a2a;
}
body.theme-radiation #app {
  background: radial-gradient(ellipse 80% 50% at 50% 100%, rgba(48,209,88,0.08) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 10% 10%, rgba(0,80,0,0.06) 0%, transparent 55%), #030f03;
}
body.theme-mipt {
  --bg: #020a18; --s1: rgba(5,18,38,0.92); --s2: rgba(6,22,46,0.88); --s3: rgba(3,12,28,0.97);
  --a: #4da6ff; --a2: #7ac0ff; --at: rgba(77,166,255,0.09); --ab: rgba(77,166,255,0.22); --ag: rgba(77,166,255,0.5);
  --r: #ff6b6b; --rt: rgba(255,107,107,0.10); --rb: rgba(255,107,107,0.25);
  --g: #43e97b; --gt: rgba(67,233,123,0.08); --gb: rgba(67,233,123,0.22);
  --p: #a78bfa; --c: #38bdf8;
  --tx: #e2eeff; --tx2: #7b9cbf; --tx3: #243654;
}
body.theme-mipt #app {
  background:
    radial-gradient(ellipse 80% 50% at 50% 100%, rgba(77,166,255,0.10) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 10% 10%, rgba(10,60,120,0.08) 0%, transparent 55%),
    radial-gradient(ellipse 40% 30% at 90% 20%, rgba(100,60,255,0.05) 0%, transparent 50%),
    #020a18;
}
/* ФИЗТЕХ — переопределение кнопок */
body.theme-mipt .btn { background:linear-gradient(135deg,#1a5fa8,#4da6ff); color:#fff; border:none; box-shadow:0 2px 12px rgba(77,166,255,0.25); }
body.theme-mipt .btn:hover { background:linear-gradient(135deg,#2070c0,#60b8ff); box-shadow:0 4px 18px rgba(77,166,255,0.35); }
body.theme-mipt .btn:active { background:linear-gradient(135deg,#1248a0,#3a8ee0); }
body.theme-mipt .btn-g { background:rgba(77,166,255,0.08); color:var(--tx2); border:1px solid rgba(77,166,255,0.18); box-shadow:none; }
body.theme-mipt .btn-g:hover { background:rgba(77,166,255,0.14); color:var(--a); }
body.theme-mipt .btn-d { background:linear-gradient(135deg,#8b1a1a,#ff4444); color:#fff; border:none; }
body.theme-mipt .btn-c { background:rgba(77,166,255,0.12); color:#4da6ff; border:1px solid rgba(77,166,255,0.3); box-shadow:none; }
body.theme-mipt .btn-pu { background:rgba(120,100,255,0.12); color:#a78bfa; border:1px solid rgba(120,100,255,0.3); box-shadow:none; }
body.theme-mipt .btn-gr { background:rgba(67,233,123,0.1); color:#43e97b; border:1px solid rgba(67,233,123,0.25); box-shadow:none; }
/* ФИЗТЕХ — карточки и панели */
body.theme-mipt .card { border-color:rgba(77,166,255,0.15); }
body.theme-mipt .inp { border-color:rgba(77,166,255,0.2); background:rgba(4,15,35,0.9); }
body.theme-mipt .inp:focus { border-color:rgba(77,166,255,0.5); box-shadow:0 0 0 3px rgba(77,166,255,0.1); }
body.theme-mipt .tb { border-bottom-color:rgba(77,166,255,0.12); }
body.theme-mipt .tab-btn.active { color:#4da6ff; border-bottom-color:#4da6ff; }
body.theme-mipt .bottom-nav-btn.active { color:#4da6ff; }

/* ──────────────── THEME SWITCHER ──────────────── */
.theme-btn {
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 12px; border:1px solid rgba(255,255,255,0.12); border-radius:var(--rad-sm);
  background:rgba(255,255,255,0.06); cursor:pointer; font-family:'Inter',sans-serif;
  font-size:11px; font-weight:600; color:var(--tx2); transition:.18s;
}
.theme-btn.active { border-color:var(--ab); background:var(--at); color:var(--a); }
.theme-btn:hover { border-color:var(--ab); color:var(--a); }

/* ──────────────── ROUND TIMER ──────────────── */
.round-timer {
  display:flex; align-items:center; gap:8px; padding:8px 14px;
  background:rgba(255,69,58,0.08); border-bottom:1px solid rgba(255,69,58,0.2);
  flex-shrink:0;
}
.round-timer.urgent { animation:roundTimerPulse 1s ease infinite; background:rgba(255,69,58,0.15); }

/* ──────────────── NOTES TAB ──────────────── */
.notes-area {
  width:100%; min-height:220px; resize:vertical;
  background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.1);
  border-radius:var(--rad-sm); color:var(--tx); font-family:'Inter',sans-serif;
  font-size:14px; line-height:1.6; padding:14px; outline:none;
  transition:border-color .18s;
}
.notes-area:focus { border-color:rgba(240,165,0,0.4); }

/* ──────────────── EVENT LOG ──────────────── */
.log-entry {
  display:flex; gap:10px; padding:9px 14px; border-bottom:1px solid rgba(255,255,255,0.05);
  font-size:12px; line-height:1.45; align-items:flex-start;
}
.log-entry:last-child { border-bottom:none; }
.log-ts { font-family:'Share Tech Mono',monospace; font-size:9px; color:var(--tx3); flex-shrink:0; margin-top:2px; min-width:42px; }

/* ──────────────── CARD REACTIONS ──────────────── */
.react-bar { display:flex; gap:4px; flex-wrap:wrap; margin-top:6px; }
.react-chip {
  display:inline-flex; align-items:center; gap:3px; padding:2px 8px;
  background:rgba(255,255,255,0.07); border:1px solid rgba(255,255,255,0.12);
  border-radius:12px; font-size:12px; cursor:pointer; transition:.15s;
}
.react-chip:hover { background:rgba(240,165,0,0.12); border-color:rgba(240,165,0,0.3); }
.react-chip.mine { background:rgba(240,165,0,0.15); border-color:rgba(240,165,0,0.4); }
.react-add { display:inline-flex; align-items:center; padding:2px 6px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:12px; font-size:13px; cursor:pointer; color:var(--tx3); transition:.15s; }
.react-add:hover { background:rgba(240,165,0,0.1); border-color:rgba(240,165,0,0.3); color:var(--a); }

/* ──────────────── ACHIEVEMENTS ──────────────── */
.ach-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:14px; }
.ach-card {
  padding:12px; border-radius:var(--rad-sm); border:1px solid rgba(255,255,255,0.08);
  background:rgba(255,255,255,0.04); position:relative; overflow:hidden;
}
.ach-card.earned { border-color:rgba(240,165,0,0.4); background:rgba(240,165,0,0.07); }
.ach-card.locked { opacity:.45; }
.ach-icon { font-size:28px; margin-bottom:6px; }
.ach-name { font-size:11px; font-weight:700; color:var(--tx); margin-bottom:3px; }
.ach-desc { font-size:10px; color:var(--tx3); line-height:1.4; }
.ach-earned-badge { position:absolute; top:6px; right:6px; font-size:9px; font-weight:700; color:var(--a); background:rgba(240,165,0,0.15); border:1px solid rgba(240,165,0,0.3); border-radius:6px; padding:2px 5px; }

/* ──────────────── GROUPS ──────────────── */
.group-card {
  display:flex; align-items:center; gap:12px; padding:13px 16px;
  background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08);
  border-radius:var(--rad-sm); margin-bottom:8px; cursor:pointer; transition:.18s;
}
.group-card:hover { border-color:rgba(191,90,242,0.35); background:rgba(191,90,242,0.06); }
.group-avatar { width:40px; height:40px; border-radius:'50%'; background:rgba(191,90,242,0.2); border:1px solid rgba(191,90,242,0.4); display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0; }

/* ══════════════════════════════════════════
   BUNKER GATE — кинематографическое открытие
   ══════════════════════════════════════════ */
#bunker-gate {
  position: fixed; inset: 0; z-index: 99000;
  background: #03030a;
  pointer-events: all;
  transition: opacity .6s ease;
}
#bunker-gate.hidden { opacity: 0; pointer-events: none; visibility: hidden; }

/* Фоновый туман */
#bunker-gate::before {
  content: '';
  position: absolute; inset: 0;
  background:
    radial-gradient(ellipse 80% 50% at 50% 110%, rgba(240,165,0,0.07) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 50% 50%, rgba(240,165,0,0.04) 0%, transparent 70%);
  pointer-events: none;
}

/* Левая и правая створки */
.gate-left, .gate-right {
  position: absolute; top: 0; bottom: 0; width: 50%;
  overflow: hidden;
  transition: transform 1.4s cubic-bezier(0.86, 0, 0.07, 1);
  will-change: transform;
}
.gate-left  { left: 0;  transform-origin: left center; }
.gate-right { right: 0; transform-origin: right center; }

/* Металлическая текстура створок */
.gate-left::before, .gate-right::before {
  content: ''; position: absolute; inset: 0;
  background:
    linear-gradient(180deg,
      #161620 0%, #1c1c28 15%, #131318 30%,
      #1e1e2a 45%, #111116 60%, #1a1a24 75%, #0e0e14 100%);
}
/* Горизонтальные рёбра жёсткости */
.gate-left::after, .gate-right::after {
  content: ''; position: absolute; inset: 0;
  background: repeating-linear-gradient(
    180deg,
    transparent 0px, transparent 44px,
    rgba(255,255,255,0.035) 44px, rgba(255,255,255,0.035) 46px,
    rgba(0,0,0,0.3) 46px, rgba(0,0,0,0.3) 48px,
    transparent 48px, transparent 92px
  );
}

/* Вертикальные болты/рёбра на каждой створке */
.gate-ribs {
  position: absolute; inset: 0;
  background: repeating-linear-gradient(
    90deg,
    transparent 0px, transparent 60px,
    rgba(255,255,255,0.02) 60px, rgba(255,255,255,0.02) 62px,
    rgba(0,0,0,0.15) 62px, rgba(0,0,0,0.15) 64px,
    transparent 64px
  );
  pointer-events: none;
}

/* Болты на краях */
.gate-bolts {
  position: absolute; top: 0; bottom: 0;
  display: flex; flex-direction: column;
  justify-content: space-around; padding: 24px 0;
  gap: 0; pointer-events: none;
}
.gate-left .gate-bolts  { right: 10px; }
.gate-right .gate-bolts { left: 10px; }

.gate-bolt {
  width: 10px; height: 10px; border-radius: 50%;
  background: radial-gradient(circle at 35% 35%, rgba(255,255,255,0.4), rgba(120,100,40,0.8));
  box-shadow: 0 0 4px rgba(0,0,0,0.8), inset 0 1px 1px rgba(255,255,255,0.2);
  flex-shrink: 0;
}

/* Свечение по центральному шву */
.gate-seam {
  position: absolute; top: 0; bottom: 0; left: 50%;
  width: 1px; transform: translateX(-50%);
  background: linear-gradient(180deg,
    transparent 0%,
    rgba(240,165,0,0.15) 10%,
    rgba(240,165,0,0.6) 30%,
    rgba(240,165,0,1)   50%,
    rgba(240,165,0,0.6) 70%,
    rgba(240,165,0,0.15) 90%,
    transparent 100%);
  box-shadow: 0 0 8px 2px rgba(240,165,0,0.4), 0 0 20px 4px rgba(240,165,0,0.15);
  z-index: 10;
  transition: opacity .25s;
}

/* Центральная эмблема + замок */
.gate-center {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  z-index: 20; display: flex; flex-direction: column;
  align-items: center; gap: 10px;
  transition: opacity .3s ease;
}
.gate-emblem {
  font-size: 56px; line-height: 1;
  filter: drop-shadow(0 0 20px rgba(240,165,0,0.8));
  animation: gateGlow 1.8s ease-in-out infinite;
}
.gate-lock {
  display: flex; flex-direction: column; align-items: center;
}
.gate-lock-arc {
  width: 26px; height: 14px;
  border: 3px solid rgba(240,165,0,0.9);
  border-bottom: none; border-radius: 13px 13px 0 0;
  box-shadow: 0 0 10px rgba(240,165,0,0.5);
  transition: transform .4s ease, opacity .4s ease;
}
.gate-lock-body {
  width: 34px; height: 22px;
  background: rgba(240,165,0,0.1);
  border: 2px solid rgba(240,165,0,0.8);
  border-radius: 5px;
  box-shadow: 0 0 14px rgba(240,165,0,0.35);
}

/* Круговые полосы (спиннер-замок) */
.gate-wheel {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  z-index: 15; pointer-events: none;
  transition: opacity .3s;
}
.gate-wheel-ring {
  position: absolute; border-radius: 50%;
  border: 1px solid rgba(240,165,0,0.2);
  top: 50%; left: 50%; transform: translate(-50%, -50%);
}
.gate-wheel-ring:nth-child(1){ width:90px;  height:90px;  border-color:rgba(240,165,0,0.25); animation:wheelSpin 8s linear infinite; }
.gate-wheel-ring:nth-child(2){ width:130px; height:130px; border-color:rgba(240,165,0,0.15); animation:wheelSpin 12s linear infinite reverse; }
.gate-wheel-ring:nth-child(3){ width:170px; height:170px; border-color:rgba(240,165,0,0.08); animation:wheelSpin 18s linear infinite; }
.gate-wheel-ring::after {
  content:''; position:absolute; top:-3px; left:50%; transform:translateX(-50%);
  width:5px; height:5px; border-radius:50%;
  background:rgba(240,165,0,0.7); box-shadow:0 0 6px rgba(240,165,0,0.8);
}

/* Вспышка при открытии */
.gate-flash {
  position: absolute; inset: 0; z-index: 50;
  background: radial-gradient(ellipse 70% 60% at 50% 50%, rgba(240,165,0,0.35) 0%, transparent 70%);
  opacity: 0; pointer-events: none;
  transition: opacity .1s;
}

/* Свет из открытых ворот */
.gate-glow-bg {
  position: absolute; inset: 0; z-index: 1;
  background: radial-gradient(ellipse 50% 60% at 50% 50%, rgba(240,165,0,0.18) 0%, rgba(240,165,0,0.04) 40%, transparent 70%);
  opacity: 0; pointer-events: none;
  transition: opacity .8s ease .2s;
}

/* Нижний подпись */
.gate-label {
  position: absolute; bottom: 10%; left: 0; right: 0;
  text-align: center;
  font-family: 'Inter', sans-serif;
  font-size: 10px; font-weight: 700; letter-spacing: 5px;
  color: rgba(240,165,0,0.45); text-transform: uppercase;
  z-index: 20;
}

/* Статус-строка */
.gate-status {
  position: absolute; bottom: calc(10% - 20px); left: 0; right: 0;
  text-align: center;
  font-family: 'Inter', monospace;
  font-size: 9px; letter-spacing: 3px;
  color: rgba(240,165,0,0.3); text-transform: uppercase;
  z-index: 20; transition: opacity .3s;
}

/* ── Состояние: открытие ── */
#bunker-gate.opening .gate-left  { transform: translateX(-101%); }
#bunker-gate.opening .gate-right { transform: translateX(101%); }
#bunker-gate.opening .gate-seam  { opacity: 0; transition: opacity .15s; }
#bunker-gate.opening .gate-center { opacity: 0; transition: opacity .2s; }
#bunker-gate.opening .gate-wheel  { opacity: 0; transition: opacity .2s; }
#bunker-gate.opening .gate-glow-bg { opacity: 1; }
#bunker-gate.flashing .gate-flash  { opacity: 1; }

/* ── Анимации ── */
@keyframes gateGlow {
  0%,100% { filter: drop-shadow(0 0 14px rgba(240,165,0,.6)); }
  50%     { filter: drop-shadow(0 0 32px rgba(240,165,0,1));  }
}
@keyframes wheelSpin { to { transform: translate(-50%,-50%) rotate(360deg); } }
@keyframes statusBlink {
  0%,100% { opacity: .3; }
  50%     { opacity: .8; }
}
.gate-status { animation: statusBlink 1.4s ease-in-out infinite; }

/* ──────────────── NAV BAR ──────────────── */
#nav-bar {
  position:fixed; bottom:0; left:0; right:0;
  height:calc(76px + var(--safe-bot));
  display:flex; align-items:stretch;
  background:rgba(12,12,20,0.88); backdrop-filter:blur(20px) saturate(180%); -webkit-backdrop-filter:blur(20px) saturate(180%);
  border-top:1px solid rgba(255,255,255,0.06); z-index:8000;
  padding-bottom:var(--safe-bot);
}
.nb {
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:4px; border:none; background:none; cursor:pointer;
  color:var(--tx3); font-family:'Inter',sans-serif; font-size:9px; font-weight:500; letter-spacing:0.3px;
  transition:color .3s cubic-bezier(.34,1.56,.64,1); padding:6px 4px; position:relative;
}
.nb.on { color:var(--a); }
.nb.on::before {
  content:''; position:absolute; top:0; left:20%; right:20%; height:3px;
  background:linear-gradient(90deg,transparent,var(--a),transparent);
  border-radius:0 0 4px 4px; box-shadow:0 0 10px var(--ag);
  animation:navIndicator .3s cubic-bezier(.34,1.56,.64,1);
}
@keyframes navIndicator { from{opacity:0;transform:scaleX(.3)} to{opacity:1;transform:scaleX(1)} }
.nb svg { width:22px; height:22px; stroke-width:1.5; transition:all .3s cubic-bezier(.34,1.56,.64,1); }
.nb.on svg { filter:drop-shadow(0 0 5px var(--ag)); transform:scale(1.15); color:var(--a); }
.nb-badge {
  position:absolute; top:6px; right:calc(50% - 18px);
  background:var(--r); color:#fff; font-size:7px;
  min-width:14px; height:14px; border-radius:7px; padding:0 3px;
  display:flex; align-items:center; justify-content:center;
  font-family:'Inter',sans-serif; font-weight:700;
}

/* ──────────────── SCROLLER ──────────────── */
.scr     { flex:1; overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch; padding:20px 18px calc(76px + 40px); }
.scr-raw { flex:1; overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch; padding:20px 18px 120px; }
/* В игровом экране скролл без лишних отступов — hand-area в потоке */
.scr.game-scr { padding-bottom: 12px; }

/* ──────────────── GLASS CARD (Glassmorphism) ──────────────── */
.glass-card {
  background:rgba(255,255,255,0.04); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
  border:1px solid rgba(255,255,255,0.08); border-radius:14px; transition:.18s;
}
.glass-card:hover { background:rgba(255,255,255,0.07); border-color:rgba(255,255,255,0.14); }

/* ──────────────── SECRET CARD MODAL ──────────────── */
.secret-modal-bg { position:fixed; inset:0; z-index:7000; display:flex; align-items:center; justify-content:center; padding:24px; background:radial-gradient(ellipse 80% 70% at 50% 50%,rgba(240,165,0,0.12) 0%,rgba(0,0,0,.85) 70%); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); }
.secret-modal-card { border-radius:24px; padding:32px 28px 28px; text-align:center; max-width:340px; width:100%; position:relative; animation:secretGlow 2s ease-in-out infinite; }

/* ──────────────── FIREBASE STATUS ──────────────── */
.fb-status { position:fixed; top:8px; right:8px; z-index:9999; display:flex; align-items:center; gap:5px; padding:5px 10px; border-radius:20px; background:rgba(20,20,30,0.88); border:1px solid rgba(255,255,255,0.1); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); font-family:'Inter',sans-serif; font-size:10px; font-weight:600; color:var(--tx2); cursor:default; transition:opacity .4s; }
.fb-status.online { opacity:0; pointer-events:none; }
.fb-status.offline { opacity:1; }

/* ──────────────── TOPBAR ──────────────── */
.tb {
  display:flex; align-items:center; gap:12px; padding:14px 18px; flex-shrink:0; z-index:10;
  background:rgba(12,12,20,0.85); backdrop-filter:var(--bl); -webkit-backdrop-filter:var(--bl);
  border-bottom:1px solid rgba(255,255,255,0.06);
  min-height:56px;
}
.tb-title { font-family:'Inter',sans-serif; font-size:18px; font-weight:700; color:var(--tx); flex:1; letter-spacing:-0.3px; }

/* ──────────────── HAZARD STRIPE ──────────────── */
.hz     { height:1px; flex-shrink:0; background:rgba(240,165,0,0.25); }
.hz-red { height:1px; flex-shrink:0; background:rgba(255,69,58,0.25); }

/* ──────────────── BUTTONS ──────────────── */
.btn {
  display:flex; align-items:center; justify-content:center; gap:8px;
  width:100%; padding:16px 22px; border:none; cursor:pointer;
  font-family:'Inter',sans-serif; font-size:16px; font-weight:600; letter-spacing:-0.1px;
  transition:all .18s; border-radius:var(--rad); position:relative; overflow:hidden;
  min-height:52px;
}
.btn:disabled { opacity:.3; cursor:not-allowed; }
.btn:not(:disabled):active { transform:scale(.97); opacity:.9; }
.btn-sm { padding:11px 18px; font-size:14px; border-radius:var(--rad-sm); min-height:44px; }

.btn-p { background:linear-gradient(135deg,#d4940a,var(--a)); color:#000; font-weight:700; }
.btn-p:not(:disabled):hover { filter:brightness(1.08); }
.btn-d { background:linear-gradient(135deg,#c0392b,var(--r)); color:#fff; }
.btn-d:not(:disabled):hover { filter:brightness(1.1); }
.btn-g { background:rgba(255,255,255,0.06); color:var(--tx2); border:1px solid rgba(255,255,255,.08); }
.btn-g:not(:disabled):hover { background:rgba(255,255,255,.1); color:var(--tx); }
.btn-c { background:rgba(10,132,255,.1); color:var(--c); border:1px solid rgba(10,132,255,.25); }
.btn-c:not(:disabled):hover { background:rgba(10,132,255,.18); }
.btn-pu { background:rgba(191,90,242,.1); color:var(--p); border:1px solid rgba(191,90,242,.25); }
.btn-gr { background:var(--gt); color:var(--g); border:1px solid var(--gb); }

.brow { display:flex; gap:8px; } .brow .btn { flex:1; }

/* ──────────────── INPUTS ──────────────── */
.inp {
  width:100%; padding:15px 18px; outline:none; transition:.2s; margin-bottom:12px;
  background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1);
  border-radius:var(--rad); color:var(--tx); font-family:'Inter',sans-serif; font-size:16px; font-weight:500;
  min-height:52px;
}
.inp:focus { border-color:var(--a); box-shadow:0 0 0 3px rgba(240,165,0,.12); }
.inp::placeholder { color:var(--tx3); }
.sel {
  width:100%; padding:14px 18px; outline:none; margin-bottom:12px; -webkit-appearance:none;
  background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1);
  border-radius:var(--rad); color:var(--tx); font-family:'Inter',sans-serif; font-size:16px;
  min-height:52px;
}

/* ──────────────── LABELS ──────────────── */
.lbl {
  display:flex; align-items:center; gap:10px; margin:24px 0 12px;
  font-family:'Inter',sans-serif; font-size:11px; font-weight:700; letter-spacing:1px; color:var(--tx2); text-transform:uppercase;
}
.lbl::after { content:''; flex:1; height:1px; background:rgba(255,255,255,0.07); }
.lbl:first-child { margin-top:6px; }

/* ──────────────── GLASS CARD ──────────────── */
.card {
  background:rgba(255,255,255,0.04); backdrop-filter:var(--bl-sm); -webkit-backdrop-filter:var(--bl-sm);
  border:1px solid rgba(255,255,255,0.08); border-radius:var(--rad-lg); padding:20px; margin-bottom:12px; position:relative;
}
.card::before,.card::after { display:none; }

/* ──────────────── STAT BOX ──────────────── */
.stat-box {
  background:rgba(255,255,255,0.04); backdrop-filter:var(--bl-sm); -webkit-backdrop-filter:var(--bl-sm);
  border:1px solid rgba(255,255,255,0.08); border-radius:var(--rad-lg); padding:22px; text-align:center;
}
.sv { font-family:'Inter',sans-serif; font-size:36px; font-weight:700; color:var(--a); line-height:1; }
.sl { font-family:'Inter',sans-serif; font-size:10px; font-weight:600; letter-spacing:0.5px; color:var(--tx2); margin-top:6px; text-transform:uppercase; }

/* ──────────────── PLAYER ROW ──────────────── */
.prow {
  display:flex; align-items:center; gap:12px; padding:14px 16px;
  background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.07); border-radius:var(--rad); margin-bottom:8px; transition:.18s;
}
.prow.me  { border-color:rgba(240,165,0,.3); background:rgba(240,165,0,0.06); }
.prow.hot { cursor:pointer; }
.prow.hot:active { border-color:rgba(240,165,0,.25); background:rgba(240,165,0,0.05); }

/* ──────────────── BADGES ──────────────── */
.bdg { font-family:'Inter',sans-serif; font-size:9px; font-weight:600; letter-spacing:0.3px; padding:3px 8px; border:1px solid; border-radius:20px; text-transform:uppercase; flex-shrink:0; }
.bdg-a  { color:var(--a);  border-color:rgba(240,165,0,.35); background:rgba(240,165,0,.08); }
.bdg-c  { color:var(--c);  border-color:rgba(10,132,255,.35); background:rgba(10,132,255,.08); }
.bdg-g  { color:var(--g);  border-color:var(--gb); background:var(--gt); }
.bdg-r  { color:var(--r);  border-color:var(--rb); background:var(--rt); }
.bdg-p  { color:var(--p);  border-color:rgba(191,90,242,.35); background:rgba(191,90,242,.08); }

/* ──────────────── RANK CHIP ──────────────── */
.rchip { display:inline-flex; align-items:center; gap:4px; font-family:'Inter',sans-serif; font-size:10px; font-weight:600; letter-spacing:0.2px; padding:3px 10px; border:1px solid; border-radius:20px; }

/* ──────────────── LED ──────────────── */
.led    { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
.led-g  { background:var(--g); box-shadow:0 0 6px var(--g); }
.led-a  { background:var(--a); box-shadow:0 0 6px var(--a); animation:pulse 2s ease infinite; }
.led-r  { background:var(--r); box-shadow:0 0 6px var(--r); animation:pulse 1.2s ease infinite; }

/* ──────────────── TABS ──────────────── */
.tabs { display:flex; border-bottom:1px solid rgba(255,255,255,0.07); margin-bottom:16px; }
.tab {
  flex:1; padding:11px 6px; background:none; border:none; color:var(--tx3); cursor:pointer;
  font-family:'Inter',sans-serif; font-size:12px; font-weight:600; letter-spacing:0.2px;
  transition:.2s; border-bottom:2px solid transparent; position:relative;
}
.tab.on { color:var(--a); border-bottom-color:var(--a); }
.tab-badge {
  position:absolute; top:6px; right:6px;
  background:var(--r); color:#fff; font-size:7px; min-width:14px; height:14px; border-radius:7px; padding:0 3px;
  display:flex; align-items:center; justify-content:center; font-family:'Inter',sans-serif; font-weight:700;
}

/* ──────────────── TOGGLE ──────────────── */
.tog-row {
  display:flex; align-items:center; gap:14px; padding:14px 16px;
  background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:var(--rad-sm); margin-bottom:10px; cursor:pointer; user-select:none; transition:.2s;
}
.tog-row.dng { background:rgba(255,69,58,0.06); border-color:rgba(255,69,58,0.2); }
.tog-row:hover { border-color:rgba(240,165,0,.3); }
.tog-track { width:42px; height:24px; border-radius:12px; background:rgba(255,255,255,0.1); border:none; position:relative; transition:.25s; flex-shrink:0; }
.tog-track.on  { background:var(--g); }
.tog-track.dng { background:var(--r); }
.tog-thumb { width:18px; height:18px; border-radius:50%; background:#fff; position:absolute; top:3px; left:3px; transition:.25s cubic-bezier(.34,1.56,.64,1); box-shadow:0 1px 4px rgba(0,0,0,.3); }
.tog-track.on  .tog-thumb { left:21px; }
.tog-track.dng .tog-thumb { left:21px; }

/* ──────────────── AP OPTIONS ──────────────── */
.ap-opt {
  display:flex; gap:14px; align-items:flex-start; padding:16px;
  background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:var(--rad-sm); margin-bottom:8px; cursor:pointer; transition:.18s;
}
.ap-opt:hover { border-color:rgba(240,165,0,.3); background:rgba(240,165,0,0.04); }
.ap-opt.on    { border-color:rgba(240,165,0,.5); background:rgba(240,165,0,0.08); }

/* ──────────────── CODE BOX ──────────────── */
.code-box {
  font-family:'Inter',sans-serif; font-size:38px; font-weight:700; letter-spacing:10px; color:var(--a);
  text-align:center; padding:20px;
  background:rgba(240,165,0,0.06); border:1px solid rgba(240,165,0,0.25); border-radius:var(--rad);
  cursor:pointer; margin-bottom:14px; transition:.2s;
}
.code-box::before,.code-box::after { display:none; }
.code-box:hover { background:rgba(240,165,0,0.1); box-shadow:0 0 20px rgba(240,165,0,.08); }

/* ──────────────── TOAST ──────────────── */
@keyframes toastSlideIn { from{opacity:0;transform:translateX(110%)} to{opacity:1;transform:translateX(0)} }
@keyframes toastProgress { from{width:100%} to{width:0%} }
@keyframes ripple { from{transform:scale(0);opacity:0.4} to{transform:scale(4);opacity:0} }
@keyframes secretGlow { 0%,100%{box-shadow:0 0 20px rgba(240,165,0,0.5),0 0 0 1px rgba(240,165,0,0.4)} 50%{box-shadow:0 0 60px rgba(240,165,0,1),0 0 100px rgba(240,165,0,0.5),0 0 0 1px rgba(240,165,0,0.8)} }
.toast-container { position:fixed; top:16px; right:16px; z-index:99999; display:flex; flex-direction:column; gap:8px; pointer-events:none; }
.toast-item {
  pointer-events:all; position:relative; overflow:hidden;
  background:rgba(28,28,36,0.97); backdrop-filter:var(--bl); -webkit-backdrop-filter:var(--bl);
  border:1px solid rgba(255,255,255,0.1); border-radius:var(--rad); padding:11px 36px 11px 44px;
  font-family:'Inter',sans-serif; font-size:13px; font-weight:500; color:var(--tx);
  white-space:nowrap; max-width:88vw; box-shadow:0 8px 32px rgba(0,0,0,.5);
  animation:toastSlideIn .32s cubic-bezier(.34,1.56,.64,1);
}
.toast-item.err { border-color:rgba(255,69,58,.3); }
.toast-item.ok  { border-color:rgba(48,209,88,.3); }
.toast-icon { position:absolute; left:14px; top:50%; transform:translateY(-50%); font-size:15px; }
.toast-close { position:absolute; right:10px; top:50%; transform:translateY(-50%); background:none; border:none; color:rgba(255,255,255,.35); font-size:14px; cursor:pointer; padding:2px 4px; line-height:1; }
.toast-close:hover { color:var(--tx); }
.toast-bar { position:absolute; bottom:0; left:0; height:2px; border-radius:0 0 var(--rad) var(--rad); }
.toast-item.err .toast-bar { background:var(--r); }
.toast-item.ok  .toast-bar { background:var(--g); }
.toast-item:not(.err):not(.ok) .toast-bar { background:var(--a); }
/* Legacy single toast (keep for compat) */
.toast { display:none; }

/* ──────────────── SPINNER ──────────────── */
.spin { width:28px; height:28px; border:2px solid rgba(255,255,255,.08); border-top-color:var(--a); border-radius:50%; animation:spin .7s linear infinite; margin:40px auto; }

/* ──────────────── FIXED BOTTOM ACTION BAR ──────────────── */
.fixbot {
  position:fixed; bottom:0; left:0; right:0; z-index:100;
  padding:12px 16px 16px;
  background:linear-gradient(0deg,var(--bg) 55%,transparent);
  display:flex; flex-direction:column; gap:8px;
}
.fixbot-nav { bottom:var(--nav-h); }

/* ──────────────── CHAT ──────────────── */
.chat-msgs { flex:1; overflow-y:auto; padding:14px 16px; display:flex; flex-direction:column; gap:4px; }
.chat-day-div { text-align:center; font-size:10px; color:rgba(255,255,255,0.25); margin:8px 0; letter-spacing:1px; }
.bubble-wrap { display:flex; flex-direction:column; max-width:84%; }
.bubble-wrap.me { align-self:flex-end; align-items:flex-end; }
.bubble-wrap.other { align-self:flex-start; align-items:flex-start; }
.bubble-wrap.system { align-self:center; align-items:center; max-width:92%; }
.bubble { padding:10px 14px; font-size:14px; line-height:1.5; word-break:break-word; border:none; border-radius:18px; position:relative; }
.bubble.me     { background:linear-gradient(135deg,rgba(240,165,0,.22),rgba(240,130,0,.15)); color:var(--tx); border-bottom-right-radius:4px; }
.bubble.other  { background:rgba(255,255,255,0.08); color:var(--tx); border-bottom-left-radius:4px; }
.bubble.system { background:rgba(10,132,255,.08); color:var(--c); font-size:11px; text-align:center; border-radius:var(--rad); padding:6px 14px; }
.bubble-from   { font-size:11px; font-weight:700; color:var(--a); margin-bottom:3px; padding:0 2px; }
.bubble-meta   { display:flex; align-items:center; gap:6px; margin-top:4px; padding:0 2px; }
.bubble-time   { font-size:10px; color:rgba(255,255,255,0.22); }
.bubble-reactions { display:flex; gap:4px; flex-wrap:wrap; margin-top:4px; }
.bubble-reaction { background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12); border-radius:20px; padding:2px 8px; font-size:13px; cursor:pointer; display:flex; align-items:center; gap:3px; transition:.15s; -webkit-tap-highlight-color:transparent; }
.bubble-reaction:active { background:rgba(255,255,255,0.16); transform:scale(1.1); }
.bubble-reaction-count { font-size:11px; color:rgba(255,255,255,0.5); }
.bubble-reaction.mine { background:rgba(240,165,0,0.15); border-color:rgba(240,165,0,0.4); }
/* Цитата */
.bubble-quote { background:rgba(255,255,255,0.06); border-left:3px solid var(--a); border-radius:6px; padding:6px 10px; margin-bottom:8px; font-size:11px; color:rgba(255,255,255,0.5); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
/* Голосовое сообщение */
.bubble-voice { display:flex; align-items:center; gap:10px; min-width:160px; }
.bubble-voice-btn { width:34px; height:34px; border-radius:50%; border:none; background:var(--a); color:#000; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.bubble-voice-bar { flex:1; height:24px; position:relative; display:flex; align-items:center; gap:1.5px; }
.bubble-voice-wave { width:3px; border-radius:2px; background:rgba(255,255,255,0.25); transition:height .15s; }
.bubble-voice-wave.active { background:var(--a); }
.bubble-voice-dur { font-size:11px; color:rgba(255,255,255,0.4); flex-shrink:0; }
/* Панель цитирования */
.chat-quote-bar { display:flex; align-items:center; gap:8px; padding:8px 12px; background:rgba(240,165,0,0.08); border-top:1px solid rgba(240,165,0,0.2); font-size:12px; color:rgba(255,255,255,0.6); }
.chat-quote-bar-text { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.chat-quote-close { background:none; border:none; color:rgba(255,255,255,0.4); font-size:18px; cursor:pointer; padding:0 4px; }
/* Эмодзи-пикер реакции */
.reaction-picker { position:absolute; z-index:200; background:rgba(18,18,28,0.98); border:1px solid rgba(255,255,255,0.12); border-radius:28px; padding:8px 12px; display:flex; gap:8px; box-shadow:0 8px 32px rgba(0,0,0,0.6); bottom:calc(100% + 6px); }
.reaction-picker.right { right:0; }
.reaction-picker.left { left:0; }
/* Инпут-панель */
.chat-input { display:flex; align-items:flex-end; gap:8px; padding:10px 12px 12px; background:rgba(12,12,20,0.95); border-top:1px solid rgba(255,255,255,0.07); flex-shrink:0; backdrop-filter:blur(10px); }
.chat-input .inp { flex:1; margin-bottom:0; font-size:14px; border-radius:22px; padding:11px 16px; min-height:44px; max-height:120px; }
.chat-send { background:var(--a); color:#000; border:none; width:42px; height:42px; border-radius:50%; font-size:18px; font-weight:700; cursor:pointer; flex-shrink:0; transition:.2s; display:flex; align-items:center; justify-content:center; }
.chat-send:disabled { opacity:.3; cursor:not-allowed; }
/* Кнопка голосового */
.chat-voice-btn { background:rgba(255,255,255,0.07); border:1px solid rgba(255,255,255,0.1); color:var(--tx2); border:none; width:42px; height:42px; border-radius:50%; font-size:18px; cursor:pointer; flex-shrink:0; transition:.2s; display:flex; align-items:center; justify-content:center; -webkit-tap-highlight-color:transparent; }
.chat-voice-btn.recording { background:rgba(255,59,48,0.25); border:2px solid rgba(255,59,48,0.6); animation:neonPulse 1s ease infinite; }
@keyframes levelUp { 0%{opacity:0;transform:translateY(20px) scale(.8)} 20%{opacity:1;transform:translateY(-10px) scale(1.1)} 80%{opacity:1;transform:translateY(-10px) scale(1.05)} 100%{opacity:0;transform:translateY(-40px) scale(.9)} }

/* ──────────────── FRIENDS ITEMS ──────────────── */
.fi { display:flex; align-items:center; gap:12px; padding:13px 16px; background:rgba(255,255,255,0.04); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,0.08); border-radius:14px; margin-bottom:8px; transition:.18s; }
.fi.hot { cursor:pointer; }
.fi:hover { background:rgba(255,255,255,0.07); border-color:rgba(255,255,255,0.14); }
.fi.hot:hover { border-color:rgba(240,165,0,.25); background:rgba(240,165,0,0.04); }

/* ──────────────── MODAL ──────────────── */
.modal-bg  { position:fixed; inset:0; z-index:5000; background:rgba(0,0,0,.7); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); display:flex; flex-direction:column; justify-content:flex-end; }
.modal-box { background:rgba(18,18,28,0.98); border-top:1px solid rgba(255,255,255,0.08); border-radius:var(--rad-lg) var(--rad-lg) 0 0; max-height:75vh; display:flex; flex-direction:column; animation:slideUp .28s ease; }
.modal-hd  { display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid rgba(255,255,255,0.07); flex-shrink:0; }
.modal-ttl { font-family:'Inter',sans-serif; font-size:17px; font-weight:700; color:var(--tx); }
.modal-cls { background:rgba(255,255,255,0.1); border:none; color:var(--tx2); width:28px; height:28px; border-radius:50%; font-size:14px; cursor:pointer; transition:.2s; display:flex; align-items:center; justify-content:center; }
.modal-cls:hover { background:rgba(255,255,255,0.16); color:var(--tx); }
.modal-bd  { overflow-y:auto; padding:16px; flex:1; }

/* ──────────────── VOTE GRID ──────────────── */
.vgrid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.vcard { padding:14px 12px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:var(--rad-sm); cursor:pointer; transition:all .18s; position:relative; overflow:hidden; }
.vcard:hover:not(.voted) { border-color:rgba(240,165,0,.35); background:rgba(240,165,0,0.06); }
.vcard.sel  { border-color:rgba(255,69,58,.5); background:rgba(255,69,58,0.1); }
.vcard.abst { border-color:rgba(10,132,255,.4); background:rgba(10,132,255,0.07); }
.vcard.voted { pointer-events:none; }

/* ──────────────── CHARACTER CARD GRID ──────────────── */
.cgrid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.ctile { background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:var(--rad-sm); padding:14px; position:relative; }
.ctile.rev  { border-color:rgba(48,209,88,.3); background:rgba(48,209,88,0.06); }
.ctile.full { grid-column:1/-1; }
.ctile .rev-bdg { position:absolute; top:7px; right:7px; font-family:'Inter',sans-serif; font-size:8px; font-weight:700; color:var(--g); background:rgba(48,209,88,0.1); border:1px solid rgba(48,209,88,.3); border-radius:4px; padding:2px 6px; }

/* ──────────────── PICK TILE ──────────────── */
.ptile { display:flex; align-items:center; gap:14px; padding:14px 16px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:var(--rad-sm); cursor:pointer; margin-bottom:8px; transition:.18s; }
.ptile:hover { border-color:rgba(240,165,0,.35); background:rgba(240,165,0,0.05); }

/* ──────────────── FEED ──────────────── */
.feed-item { padding:12px 16px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.07); border-left:3px solid var(--a); border-radius:0 var(--rad-sm) var(--rad-sm) 0; margin-bottom:6px; display:flex; gap:12px; align-items:flex-start; }

/* ──────────────── BUNKER SPOTS ──────────────── */
.bspot { width:12px; height:12px; border-radius:50%; flex-shrink:0; }
.bspot.free  { background:var(--g); box-shadow:0 0 5px var(--g); }
.bspot.taken { background:rgba(255,255,255,0.15); }

/* ──────────────── АВАТАРЫ ──────────────── */
.ava {
  width:36px; height:36px; border-radius:50%; flex-shrink:0;
  display:flex; align-items:center; justify-content:center;
  font-size:15px; font-weight:700; color:#fff; position:relative;
}
.ava-lg { width:72px; height:72px; font-size:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; margin:0 auto 12px; }
.ava-sm { width:28px; height:28px; font-size:12px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; flex-shrink:0; }
.ava-pulse-dot {
  position:absolute;
  bottom:1px; right:1px;
  width:8px; height:8px;
  background:#30d158;
  border-radius:50%;
  border:2px solid var(--bg,#0a0a0f);
}
.ava-pulse::after {
  content:''; position:absolute; bottom:1px; right:1px;
  width:9px; height:9px; border-radius:50%;
  background:var(--g); border:2px solid var(--bg);
  box-shadow:0 0 6px var(--g);
  animation:pulseOnline 2s ease infinite;
}
@keyframes pulseOnline { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.3);opacity:.7} }

/* ──────────────── АНИМАЦИИ ПЕРЕХОДОВ ──────────────── */
@keyframes slideInRight { from{opacity:0;transform:translateX(32px)} to{opacity:1;transform:none} }
@keyframes slideInLeft  { from{opacity:0;transform:translateX(-32px)} to{opacity:1;transform:none} }
@keyframes slideInUp    { from{opacity:0;transform:translateY(24px)} to{opacity:1;transform:none} }
.sc { flex:1; display:flex; flex-direction:column; overflow:hidden; animation:slideInRight .22s cubic-bezier(.4,0,.2,1); }
.sc-back { animation:slideInLeft .22s cubic-bezier(.4,0,.2,1) !important; }
.sc-back .sc { animation:slideInLeft .22s cubic-bezier(.4,0,.2,1) !important; }

/* ──────────────── FLIP КАРТОЧКИ ──────────────── */
.card-flip-wrap { perspective:800px; cursor:pointer; }
.card-flip-inner { position:relative; width:100%; height:100%; transition:transform .5s cubic-bezier(.4,0,.2,1); transform-style:preserve-3d; }
.card-flip-wrap.flipped .card-flip-inner { transform:rotateY(180deg); }
.card-face { position:absolute; inset:0; backface-visibility:hidden; -webkit-backface-visibility:hidden; border-radius:var(--rad-sm); padding:14px; }
.card-back { transform:rotateY(180deg); }

/* ──────────────── ЭКРАН ЗАГРУЗКИ ИГРЫ ──────────────── */
@keyframes gameLoadPulse { 0%,100%{opacity:.4;transform:scaleX(.3)} 50%{opacity:1;transform:scaleX(1)} }
.game-loading {
  position:fixed; inset:0; z-index:9000; background:var(--bg);
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:24px;
  animation:fadeUp .3s ease;
}
.game-loading-bar {
  width:200px; height:3px; background:rgba(255,255,255,.08); border-radius:2px; overflow:hidden;
}
.game-loading-fill {
  height:100%; background:linear-gradient(90deg,var(--a),#fff,var(--a));
  background-size:200% 100%;
  animation:shimmer 1.2s linear infinite;
  border-radius:2px;
}
@keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

/* ──────────────── КАРТОЧКИ В ГОЛОСОВАНИИ ──────────────── */
.vcard-rich { padding:12px; background:rgba(255,255,255,0.04); border:1.5px solid rgba(255,255,255,0.1); border-radius:var(--rad-sm); cursor:pointer; transition:all .18s; }
.vcard-rich:hover:not(.voted) { border-color:rgba(240,165,0,.4); background:rgba(240,165,0,.06); transform:translateY(-2px); }
.vcard-rich.sel { border-color:rgba(255,69,58,.6); background:rgba(255,69,58,.1); transform:translateY(-2px); }
.vcard-rich.abst { border-color:rgba(10,132,255,.4); background:rgba(10,132,255,.07); }
.vcard-rich.voted { pointer-events:none; }

/* ──────────────── SECRET CARD TILE ──────────────── */
.secret-tile {
  border-radius: var(--rad);
  padding: 16px;
  margin-bottom: 14px;
  position: relative;
  overflow: hidden;
  cursor: pointer;
  transition: transform .15s, box-shadow .15s;
}
.secret-tile:active { transform: scale(.98); }
.secret-tile-used { opacity: .5; pointer-events: none; }

/* ══════════════════════════════════════════════════════════
   HAND CARDS — карточки игрока (стопка внизу)
══════════════════════════════════════════════════════════ */
.game-field {
  display: flex;
  flex-direction: column;
  height: 100dvh;
  background: #0a0a0f;
  overflow: hidden;
  position: relative;
}
.game-field-header {
  flex-shrink: 0;
  padding: env(safe-area-inset-top, 0px) 16px 0;
  background: rgba(10,10,15,0.95);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(255,255,255,0.06);
  z-index: 10;
}
.game-field-header-inner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 58px;
  gap: 10px;
}
.game-apoc-badge {
  display: flex;
  align-items: center;
  gap: 6px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 20px;
  padding: 5px 12px;
  font-size: 12px;
  font-weight: 600;
  color: var(--tx2);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 200px;
}
.game-round-badge {
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 2px;
  color: var(--a);
  background: rgba(240,165,0,0.1);
  border: 1px solid rgba(240,165,0,0.25);
  border-radius: 16px;
  padding: 5px 12px;
  white-space: nowrap;
}
.game-hdr-actions {
  display: flex;
  align-items: center;
  gap: 8px;
}
.game-icon-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 18px;
  transition: .15s;
  position: relative;
  flex-shrink: 0;
  -webkit-tap-highlight-color: transparent;
}
.game-icon-btn:active { background: rgba(255,255,255,0.12); transform: scale(.94); }
.game-icon-btn .unread-dot {
  position: absolute;
  top: -2px; right: -2px;
  width: 14px; height: 14px;
  background: #ff453a;
  border-radius: 50%;
  font-size: 8px;
  font-weight: 700;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid #0a0a0f;
}

/* ── КАРТОЧКИ ИГРОКА — стопка внизу экрана ── */

/* Контейнер всей игровой области */
.game-hand-area {
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  background: linear-gradient(0deg, rgba(8,8,12,0.99) 0%, rgba(8,8,12,0.85) 100%);
  padding-bottom: max(10px, env(safe-area-inset-bottom));
  border-top: 1px solid rgba(255,255,255,0.07);
}

/* Область с инфой о выбранной карте — верхняя часть */
.game-card-detail {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 10px;
  padding: 8px 14px 6px;
  min-height: 52px;
  transition: opacity .25s;
}
.game-card-detail-icon { font-size: 28px; line-height: 1; flex-shrink: 0; }
.game-card-detail-text { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 1px; }
.game-card-detail-label {
  font-size: 9px;
  font-weight: 800;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--tx3);
}
.game-card-detail-value {
  font-size: 13px;
  font-weight: 600;
  color: var(--tx);
  line-height: 1.4;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}
.game-card-detail-hint {
  font-size: 10px;
  color: var(--tx3);
  line-height: 1.4;
}
.game-card-detail-reveal {
  flex-shrink: 0;
  background: rgba(240,165,0,0.12);
  border: 1.5px solid rgba(240,165,0,0.4);
  border-radius: 12px;
  color: var(--a);
  font-size: 12px;
  font-weight: 700;
  padding: 8px 14px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  transition: .15s;
  white-space: nowrap;
}
.game-card-detail-reveal:active { background: rgba(240,165,0,0.22); transform: scale(.97); }
.game-card-detail-revealed {
  flex-shrink: 0;
  font-size: 11px;
  font-weight: 700;
  color: rgba(48,209,88,0.8);
  letter-spacing: 1px;
  text-transform: uppercase;
}

/* Стопка карт внизу */
.game-hand {
  flex-shrink: 0;
  position: relative;
  height: 130px;
  margin: 44px 12px 4px; /* 44px сверху — место для подъёма карты */
  overflow: visible;
}

/* Одна карта в стопке */
.hand-card {
  position: absolute;
  bottom: 0;
  width: 78px;
  height: 118px;
  border-radius: 11px;
  border: 1.5px solid rgba(255,255,255,0.18);
  box-shadow: 0 6px 24px rgba(0,0,0,0.75), 0 1px 0 rgba(255,255,255,0.1) inset;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  transition: transform .25s cubic-bezier(.34,1.5,.64,1), box-shadow .2s;
  user-select: none;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transform-origin: center bottom;
  will-change: transform;
}

/* Уголок TL */
.hand-card-corner {
  position: absolute;
  top: 5px; left: 6px;
  display: flex;
  flex-direction: column;
  align-items: center;
  line-height: 1;
  gap: 1px;
}
.hand-card-corner-icon { font-size: 11px; }
.hand-card-corner-label {
  font-size: 6px;
  font-weight: 800;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  color: rgba(255,255,255,0.45);
  writing-mode: horizontal-tb;
}
/* Уголок BR (перевёрнутый) */
.hand-card-corner-br {
  position: absolute;
  bottom: 5px; right: 6px;
  display: flex;
  flex-direction: column;
  align-items: center;
  line-height: 1;
  gap: 1px;
  transform: rotate(180deg);
}

/* Центр карты — иконка */
.hand-card-center {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 30px;
}

/* Полосочка снизу карты — цвет типа */
.hand-card-strip {
  height: 3px;
  width: 100%;
  flex-shrink: 0;
}

/* Бейдж ✓ раскрытой */
.hand-card-check {
  position: absolute;
  top: -5px; right: -5px;
  width: 15px; height: 15px;
  background: #30d158;
  border-radius: 50%;
  border: 2px solid #0a0a0f;
  display: flex; align-items: center; justify-content: center;
  font-size: 7px;
  font-weight: 900;
  color: #000;
  z-index: 2;
}

/* Выбранная карта — поднята и сияет */
.hand-card.selected {
  z-index: 50 !important;
  box-shadow: 0 20px 50px rgba(0,0,0,0.9), 0 0 0 2px rgba(240,165,0,0.7), 0 0 20px rgba(240,165,0,0.2);
}

/* Использованная секретная карта */
.secret-card-used {
  opacity: 0.35 !important;
  filter: grayscale(0.8);
  pointer-events: none;
}

/* Цвета по типу карты */
.hand-card[data-type="gender_age"]  { background: linear-gradient(170deg,#1c1c42 0%,#12122e 100%); }
.hand-card[data-type="profession"]  { background: linear-gradient(170deg,#0f2a14 0%,#081508 100%); }
.hand-card[data-type="health"]      { background: linear-gradient(170deg,#2e0f0f 0%,#1a0808 100%); }
.hand-card[data-type="hobby"]       { background: linear-gradient(170deg,#2a1f08 0%,#1a1206 100%); }
.hand-card[data-type="baggage"]     { background: linear-gradient(170deg,#0a2030 0%,#061420 100%); }
.hand-card[data-type="fact"]        { background: linear-gradient(170deg,#1e0a2e 0%,#120618 100%); }
.hand-card[data-type="secret"]      { background: linear-gradient(170deg,#1e0a2e 0%,#120618 100%); }

/* Полосочки цвета по типу */
.hand-card[data-type="gender_age"]  .hand-card-strip { background: rgba(100,130,255,0.6); }
.hand-card[data-type="profession"]  .hand-card-strip { background: rgba(60,200,100,0.6); }
.hand-card[data-type="health"]      .hand-card-strip { background: rgba(255,80,80,0.6); }
.hand-card[data-type="hobby"]       .hand-card-strip { background: rgba(240,165,0,0.6); }
.hand-card[data-type="baggage"]     .hand-card-strip { background: rgba(0,200,230,0.6); }
.hand-card[data-type="fact"]        .hand-card-strip { background: rgba(180,80,250,0.6); }
.hand-card[data-type="secret"]      .hand-card-strip { background: rgba(191,90,242,0.8); }

/* Раскрытая карта — зелёная рамка */
.hand-card.revealed { border-color: rgba(48,209,88,0.5); }

/* Секретная карта */
.my-card-label { font-size: 8px; font-weight: 800; letter-spacing: 1px; color: rgba(255,255,255,0.45); text-transform: uppercase; }
.my-card-value { font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.9); line-height: 1.3; }
.my-card-secret-content { flex: 1; min-width: 0; }
.my-card-secret-use {
  font-size: 11px; font-weight: 700; color: #bf5af2;
  background: rgba(191,90,242,0.12); border: 1px solid rgba(191,90,242,0.3);
  border-radius: 10px; padding: 8px 14px; white-space: nowrap;
  -webkit-tap-highlight-color: transparent; cursor: pointer; transition: .15s; flex-shrink: 0;
}
.my-card-secret-use:active { background: rgba(191,90,242,0.25); }

/* Полоска игроков */
.game-players-strip {
  flex-shrink: 0;
  padding: 12px 18px 10px;
  display: flex;
  gap: 12px;
  overflow-x: auto;
  scrollbar-width: none;
  -ms-overflow-style: none;
}
.game-players-strip::-webkit-scrollbar { display: none; }
.game-player-chip {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  flex-shrink: 0;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}
.game-player-avatar {
  width: 46px;
  height: 46px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  background: rgba(255,255,255,0.06);
  border: 2px solid rgba(255,255,255,0.1);
  transition: .15s;
  position: relative;
}
.game-player-avatar.me { border-color: var(--a); }
.game-player-avatar.elim { opacity: 0.35; filter: grayscale(1); }
.game-player-avatar.elim::after {
  content: '✕';
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.6);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  color: #ff453a;
}
.game-player-name {
  font-size: 9px;
  color: var(--tx3);
  max-width: 44px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  text-align: center;
}
.game-player-name.me { color: var(--a); }

/* Апокалипсис-карточка посередине */
.game-apoc-card {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -60%);
  width: min(160px, 42vw);
  aspect-ratio: 2/3;
  border-radius: 10px;
  background: linear-gradient(160deg, rgba(240,165,0,0.15), rgba(240,165,0,0.05));
  border: 1px solid rgba(240,165,0,0.25);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 6px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  pointer-events: none;
}
.game-apoc-card-emoji { font-size: 40px; }
.game-apoc-card-name { font-size: 11px; font-weight: 700; letter-spacing: 1px; color: var(--a); text-align: center; padding: 0 8px; }
.game-apoc-card-label { font-size: 9px; color: var(--tx3); letter-spacing: 2px; text-transform: uppercase; }

/* (устаревший CSS веера удалён) */
/* Кнопка раскрыть */
.player-hand-UNUSED {
  display: flex;
  align-items: flex-end;
  justify-content: center;
  position: relative;
  padding: 0 16px;
  width: 100%;
  height: min(200px, 50vw);
}

/* Одиночная игральная карта */
.playing-card {
  position: relative;
  width: min(88px, 22vw);
  aspect-ratio: 2/3;
  border-radius: 10px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  transform-origin: bottom center;
  transition: transform .25s cubic-bezier(.34,1.56,.64,1), box-shadow .2s;
  flex-shrink: 0;
  margin: 0 -8px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.5);
  will-change: transform;
}
.playing-card:nth-child(1) { transform: rotate(-15deg) translateY(6px); z-index: 1; }
.playing-card:nth-child(2) { transform: rotate(-8deg) translateY(2px); z-index: 2; }
.playing-card:nth-child(3) { transform: rotate(-2deg) translateY(0px); z-index: 3; }
.playing-card:nth-child(4) { transform: rotate(4deg) translateY(2px); z-index: 4; }
.playing-card:nth-child(5) { transform: rotate(10deg) translateY(6px); z-index: 5; }
.playing-card:nth-child(6) { transform: rotate(16deg) translateY(10px); z-index: 6; }
.playing-card:active, .playing-card.tapped {
  transform: rotate(0deg) translateY(-24px) scale(1.06) !important;
  z-index: 50 !important;
  box-shadow: 0 16px 40px rgba(0,0,0,0.7);
}
.playing-card-inner {
  width: 100%;
  height: 100%;
  position: relative;
  transform-style: preserve-3d;
  transition: transform .45s cubic-bezier(.4,0,.2,1);
  border-radius: 10px;
}
.playing-card.flipped .playing-card-inner { transform: rotateY(180deg); }
.playing-card-face, .playing-card-back-face {
  position: absolute;
  inset: 0;
  border-radius: 10px;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  overflow: hidden;
}
/* Рубашка карты */
.playing-card-face {
  background: linear-gradient(145deg, #1a1a2e, #16213e);
  border: 1px solid rgba(255,255,255,0.12);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
}
.playing-card-face-pattern {
  position: absolute;
  inset: 4px;
  border-radius: 7px;
  border: 1px solid rgba(255,255,255,0.06);
  background: repeating-linear-gradient(
    45deg,
    rgba(240,165,0,0.03) 0px,
    rgba(240,165,0,0.03) 2px,
    transparent 2px,
    transparent 8px
  );
}
.playing-card-face-icon {
  font-size: min(22px, 5.5vw);
  filter: blur(5px);
  opacity: 0.35;
}
.playing-card-face-label {
  font-size: min(7px, 1.8vw);
  color: rgba(255,255,255,0.35);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  font-weight: 700;
  text-align: center;
  padding: 0 4px;
}
/* Лицевая сторона карты */
.playing-card-back-face {
  transform: rotateY(180deg);
  display: flex;
  flex-direction: column;
  padding: 6px;
}
.playing-card-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 3px;
  text-align: center;
}
.playing-card-revealed {
  background: linear-gradient(145deg, #0d2318, #0a1a10);
  border: 1.5px solid rgba(48,209,88,0.35);
  box-shadow: 0 0 20px rgba(48,209,88,0.1), 0 4px 16px rgba(0,0,0,0.5);
}
.playing-card-hidden {
  background: linear-gradient(145deg, #1a1a2e, #16213e);
  border: 1px solid rgba(255,255,255,0.12);
}
.playing-card-secret {
  background: linear-gradient(145deg, #1a0d2e, #16082e);
  border: 1.5px solid rgba(175,82,222,0.4);
  box-shadow: 0 0 20px rgba(175,82,222,0.15), 0 4px 16px rgba(0,0,0,0.5);
}
.pcard-icon { font-size: min(20px, 5vw); margin-bottom: 2px; }
.pcard-label { font-size: min(6.5px, 1.6vw); color: rgba(255,255,255,0.4); letter-spacing: 1.5px; text-transform: uppercase; font-weight: 700; }
.pcard-value { font-size: min(9px, 2.2vw); color: #fff; line-height: 1.3; padding: 0 2px; font-weight: 500; }
.pcard-revealed-badge {
  position: absolute;
  top: 4px; right: 4px;
  background: rgba(48,209,88,0.2);
  border-radius: 4px;
  font-size: 6px;
  font-weight: 700;
  color: #30d158;
  letter-spacing: 0.5px;
  padding: 2px 4px;
}
.pcard-corner {
  position: absolute;
  font-size: 8px;
  color: rgba(255,255,255,0.3);
  line-height: 1;
  font-weight: 700;
}
.pcard-corner.tl { top: 5px; left: 6px; }
.pcard-corner.br { bottom: 5px; right: 6px; transform: rotate(180deg); }

/* Кнопка раскрыть — появляется при тапе */
.game-reveal-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 12px 16px max(16px, env(safe-area-inset-bottom));
  background: linear-gradient(0deg, rgba(10,10,15,0.98) 60%, transparent);
  display: flex;
  gap: 10px;
  z-index: 100;
  transform: translateY(100%);
  transition: transform .25s cubic-bezier(.34,1.2,.64,1);
}
.game-reveal-bar.visible { transform: translateY(0); }
.game-reveal-bar-cancel {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: rgba(255,255,255,0.07);
  border: 1px solid rgba(255,255,255,0.12);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  cursor: pointer;
  flex-shrink: 0;
  -webkit-tap-highlight-color: transparent;
}
.game-reveal-bar-cancel:active { background: rgba(255,255,255,0.14); }
.game-reveal-bar-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 2px;
}
.game-reveal-bar-title { font-size: 13px; font-weight: 700; color: #fff; }
.game-reveal-bar-sub { font-size: 10px; color: var(--tx3); }
.game-reveal-bar-btn {
  background: rgba(48,209,88,0.18);
  border: 1.5px solid rgba(48,209,88,0.4);
  border-radius: 10px;
  color: #30d158;
  font-weight: 700;
  font-size: 12px;
  padding: 0 16px;
  height: 44px;
  cursor: pointer;
  white-space: nowrap;
  -webkit-tap-highlight-color: transparent;
  transition: .15s;
}
.game-reveal-bar-btn:active { background: rgba(48,209,88,0.28); }
.game-reveal-bar-btn:disabled { opacity: 0.4; }

/* Нижние кнопки действий */
.game-actions-row {
  flex-shrink: 0;
  display: flex;
  gap: 10px;
  padding: 8px 16px max(16px, env(safe-area-inset-bottom));
}
.game-action-btn {
  flex: 1;
  height: 52px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.11);
  background: rgba(255,255,255,0.06);
  color: var(--tx);
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 0.3px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  transition: .15s;
  -webkit-tap-highlight-color: transparent;
}
.game-action-btn:active { background: rgba(255,255,255,0.12); transform: scale(.97); }
.game-action-btn.primary {
  background: rgba(240,165,0,0.12);
  border-color: rgba(240,165,0,0.35);
  color: var(--a);
}
.game-action-btn.danger {
  background: rgba(255,69,58,0.1);
  border-color: rgba(255,69,58,0.3);
  color: #ff453a;
}
.game-action-btn:disabled {
  opacity: 0.35;
  pointer-events: none;
}

@keyframes rainbowSpin {
  0%   { filter: hue-rotate(0deg) drop-shadow(0 0 6px rgba(255,0,128,0.7)); }
  50%  { filter: hue-rotate(180deg) drop-shadow(0 0 10px rgba(0,255,200,0.7)); }
  100% { filter: hue-rotate(360deg) drop-shadow(0 0 6px rgba(255,0,128,0.7)); }
}
@keyframes neonPulse {
  0%,100% { box-shadow: 0 0 6px rgba(0,255,136,0.6), 0 0 20px rgba(0,204,255,0.4); }
  50%      { box-shadow: 0 0 14px rgba(0,255,136,0.9), 0 0 35px rgba(0,204,255,0.7); }
}
.secret-badge {
  position: absolute; top: 0; right: 0;
  padding: 4px 10px;
  border-bottom-left-radius: var(--rad-sm);
  font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
}

/* ──────────────── ELIM/SURVIVOR ──────────────── */
.elim-row { padding:12px 16px; background:rgba(255,69,58,0.06); border:1px solid rgba(255,69,58,0.2); border-radius:var(--rad-sm); display:flex; gap:12px; align-items:flex-start; margin-bottom:6px; }
.surv-row { padding:13px 16px; background:rgba(48,209,88,0.07); border:1px solid rgba(48,209,88,.2); border-radius:var(--rad-sm); display:flex; gap:12px; align-items:center; margin-bottom:6px; }
.dead-row { padding:10px 16px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.07); border-radius:var(--rad-sm); display:flex; gap:10px; align-items:center; margin-bottom:4px; }

/* ──────────────── ELIM SCREEN ANIMATION ──────────────── */
@keyframes elimSkull  { 0%{transform:scale(0) rotate(-30deg);opacity:0} 55%{transform:scale(1.2) rotate(8deg);opacity:1} 75%{transform:scale(.93) rotate(-2deg)} 100%{transform:scale(1) rotate(0);opacity:1} }
@keyframes elimName   { 0%{opacity:0;transform:translateY(28px)} 100%{opacity:1;transform:translateY(0)} }
@keyframes elimCard   { 0%{opacity:0;transform:translateX(-16px)} 100%{opacity:1;transform:translateX(0)} }
@keyframes elimScan   { 0%{top:-4px} 100%{top:100%} }
@keyframes elimShake  { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-7px)} 40%{transform:translateX(7px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }
@keyframes elimGlitch { 0%,88%,100%{clip-path:none;transform:none} 89%{clip-path:inset(18% 0 62% 0);transform:translateX(-5px)} 91%{clip-path:inset(62% 0 8% 0);transform:translateX(5px)} 93%{clip-path:none} }
@keyframes elimVign   { 0%{opacity:0} 30%{opacity:1} 85%{opacity:1} 100%{opacity:.65} }
@keyframes redScan    { 0%{background-position:0 0} 100%{background-position:0 60px} }
@keyframes elimFadeIn { from{opacity:0} to{opacity:1} }
@keyframes elimFlashW { 0%{opacity:0} 8%{opacity:.55} 25%{opacity:0} }

/* ── WIN SCREEN ── */
@keyframes winBurst  { 0%{opacity:0;transform:scale(.3) rotate(-15deg)} 60%{transform:scale(1.15) rotate(4deg)} 80%{transform:scale(.95) rotate(-2deg)} 100%{opacity:1;transform:scale(1) rotate(0)} }
@keyframes winGlow   { 0%,100%{filter:drop-shadow(0 0 24px rgba(48,209,88,.8)) drop-shadow(0 0 60px rgba(48,209,88,.4))} 50%{filter:drop-shadow(0 0 48px rgba(48,209,88,1)) drop-shadow(0 0 100px rgba(48,209,88,.7))} }
@keyframes winRays   { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
@keyframes winFadeIn { from{opacity:0;transform:translateY(18px)} to{opacity:1;transform:none} }
@keyframes winScan   { 0%{background-position:0 0} 100%{background-position:0 -80px} }
@keyframes winPulse  { 0%,100%{opacity:.18} 50%{opacity:.35} }
@keyframes winFlash  { 0%{opacity:0} 8%{opacity:.45} 25%{opacity:0} }
@keyframes winCard   { from{opacity:0;transform:translateY(22px) scale(.95)} to{opacity:1;transform:none} }

.win-screen {
  position:fixed; inset:0; z-index:9000; display:flex; flex-direction:column;
  background:#00060a; overflow:hidden; animation:elimFadeIn .3s ease;
}
.win-rays {
  position:absolute; inset:-50%; z-index:0; pointer-events:none;
  background:conic-gradient(from 0deg, transparent 0deg, rgba(48,209,88,.04) 10deg, transparent 20deg, rgba(48,209,88,.02) 30deg, transparent 40deg);
  animation:winRays 18s linear infinite;
}
.win-scanlines {
  position:absolute; inset:0; pointer-events:none; z-index:1;
  background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(48,209,88,.02) 3px,rgba(48,209,88,.02) 6px);
  animation:winScan 1.4s linear infinite;
}
.win-vignette {
  position:absolute; inset:0; pointer-events:none; z-index:2;
  background:radial-gradient(ellipse at 50% 40%, transparent 20%, rgba(0,40,20,.75) 100%);
  animation:elimVign .5s ease .1s both;
}
.win-flash {
  position:absolute; inset:0; pointer-events:none; z-index:3;
  background:radial-gradient(ellipse at 50% 40%, rgba(48,209,88,.35) 0%, transparent 70%);
  animation:winFlash .5s ease .05s both;
}
.win-particles {
  position:absolute; inset:0; z-index:4; pointer-events:none; overflow:hidden;
}
.win-hero {
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
  position:relative; z-index:10; padding:24px 20px 12px; min-height:0;
}
.win-trophy {
  font-size:100px; line-height:1;
  animation:winBurst .7s cubic-bezier(.34,1.56,.64,1) .1s both, winGlow 2.5s ease 1s infinite;
}
.win-cards { position:relative; z-index:10; padding:0 16px 100px; overflow-y:auto; flex-shrink:0; max-height:40vh; }
.win-player-card {
  display:flex; align-items:center; gap:14px; padding:14px 16px;
  background:rgba(48,209,88,.07); border:1px solid rgba(48,209,88,.22);
  border-radius:var(--rad); margin-bottom:8px;
  animation:winCard .5s cubic-bezier(.34,1.56,.64,1) both;
}
.dead-player-card {
  display:flex; align-items:center; gap:14px; padding:11px 16px;
  background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.07);
  border-radius:var(--rad); margin-bottom:6px;
  animation:winCard .4s ease both;
}

.elim-screen {
  position:fixed; inset:0; z-index:9000; display:flex; flex-direction:column;
  background:#060006; overflow:hidden; animation:elimFadeIn .25s ease;
}
.elim-scanlines {
  position:absolute; inset:0; pointer-events:none; z-index:1;
  background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(255,30,30,.035) 3px,rgba(255,30,30,.035) 6px);
  animation:redScan 1.2s linear infinite;
}
.elim-vignette {
  position:absolute; inset:0; pointer-events:none; z-index:2;
  background:radial-gradient(ellipse at 50% 40%, transparent 25%, rgba(160,0,0,.6) 100%);
  animation:elimVign .4s ease .15s both;
}
.elim-flash {
  position:absolute; inset:0; pointer-events:none; z-index:3;
  background:radial-gradient(ellipse at 50% 40%, rgba(255,69,58,.45) 0%, rgba(120,0,0,.2) 50%, transparent 80%);
  animation:elimFlashW .45s ease .05s both;
}
.elim-scanner {
  position:absolute; left:0; right:0; height:2px; z-index:4; pointer-events:none;
  background:linear-gradient(90deg,transparent 0%,rgba(255,69,58,.6) 40%,rgba(255,180,180,.9) 50%,rgba(255,69,58,.6) 60%,transparent 100%);
  animation:elimScan 2s linear .5s infinite;
}
.elim-hero {
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
  position:relative; z-index:10; padding:24px 20px 12px; min-height:0;
}
.elim-skull {
  font-size:96px; line-height:1;
  filter:drop-shadow(0 0 32px rgba(255,69,58,1)) drop-shadow(0 0 80px rgba(255,69,58,.5));
  animation:elimSkull .55s cubic-bezier(.34,1.56,.64,1) .1s both;
}
.elim-skull-shake { animation:elimSkull .55s cubic-bezier(.34,1.56,.64,1) .1s both, elimShake .12s ease .75s 4; }
.elim-tag {
  margin-top:14px; font-size:9px; letter-spacing:5px; text-transform:uppercase;
  color:rgba(255,69,58,.75); font-weight:700;
  animation:elimName .35s ease .5s both;
}
.elim-name {
  font-size:38px; font-weight:800; color:#fff; text-align:center; line-height:1.1;
  margin-top:6px;
  text-shadow:0 0 30px rgba(255,69,58,.8), 0 0 70px rgba(255,69,58,.3);
  animation:elimName .45s cubic-bezier(.34,1.56,.64,1) .65s both, elimGlitch 4s ease 1.8s infinite;
}
.elim-sub {
  margin-top:8px; font-size:12px; color:rgba(255,255,255,.35); text-align:center;
  animation:elimName .3s ease .9s both;
}
.elim-divider {
  width:100%; height:1px; background:linear-gradient(90deg,transparent,rgba(255,69,58,.4),transparent);
  margin:16px 0 0; flex-shrink:0; position:relative; z-index:10;
}
.elim-cards {
  position:relative; z-index:10; overflow-y:auto;
  background:rgba(4,0,4,.92);
  padding:14px 14px 110px; flex-shrink:1; min-height:0;
}
.elim-card-row {
  display:flex; align-items:flex-start; gap:12px; padding:10px 14px;
  background:rgba(255,69,58,.05); border:1px solid rgba(255,69,58,.13);
  border-radius:var(--rad-sm); margin-bottom:6px;
  animation:elimCard .3s ease both;
}
.elim-continue {
  position:fixed; bottom:0; left:0; right:0; z-index:9100;
  padding:12px 16px 30px;
  background:linear-gradient(0deg,#060006 55%,transparent);
}

/* ──────────────── ADMIN ROW ──────────────── */
.adm-row { display:flex; align-items:center; gap:8px; padding:13px 16px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:var(--rad-sm); margin-bottom:6px; flex-wrap:wrap; }

/* ──────────────── LB ROW ──────────────── */
.lb-row { display:flex; align-items:center; gap:12px; padding:13px 16px; background:rgba(255,255,255,0.04); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,0.08); border-radius:14px; margin-bottom:6px; transition:.18s; }
.lb-row:hover { background:rgba(255,255,255,0.07); border-color:rgba(255,255,255,0.14); }
.lb-row.me { border-color:rgba(240,165,0,.3); background:rgba(240,165,0,0.06); }

/* ──────────────── GAME CHAT FULL OVERLAY ──────────────── */
.gchat { position:fixed; inset:0; background:var(--bg); z-index:300; display:flex; flex-direction:column; animation:fadeUp .2s ease; }

/* ──────────────── MONO ──────────────── */
.mono { font-family:'Share Tech Mono',monospace; }

/* ──────────────── AUTH special ──────────────── */
.auth-glow {
  position:absolute; width:320px; height:320px; border-radius:50%;
  background:radial-gradient(circle, rgba(240,165,0,.12) 0%, transparent 70%);
  top:50%; left:50%; transform:translate(-50%,-65%); pointer-events:none;
}

/* ══════════════════════════════════════════════════════════
   MOBILE & PWA FIXES — safe-area, keyboard, touch targets
   ══════════════════════════════════════════════════════════ */

/* Safe-area для notch / Dynamic Island / home indicator */
:root {
  --safe-top:  env(safe-area-inset-top, 0px);
  --safe-bot:  env(safe-area-inset-bottom, 0px);
  --safe-left: env(safe-area-inset-left, 0px);
  --safe-right:env(safe-area-inset-right, 0px);
}

/* Весь #app занимает полный экран включая notch-зону */
#app {
  padding-top: var(--safe-top);
  padding-left: var(--safe-left);
  padding-right: var(--safe-right);
}

/* Nav bar учитывает home indicator снизу */
#nav-bar {
  padding-bottom: max(var(--safe-bot), 8px);
  height: calc(64px + max(var(--safe-bot), 8px));
}

/* Топбар — учитываем notch сверху */
.tb {
  min-height: 52px;
}

/* Скроллер — отступ снизу = nav + safe-area */
.scr {
  padding-bottom: calc(64px + max(var(--safe-bot), 8px) + 24px);
}
.scr-raw {
  padding-bottom: calc(64px + max(var(--safe-bot), 8px) + 24px);
}

/* fixbot над навбаром */
.fixbot-nav {
  bottom: calc(64px + max(var(--safe-bot), 8px));
}

/* ──── Клавиатура на мобильных (visual viewport) ──── */
/* Когда клавиатура открыта, чат не уходит под неё */
.chat-input {
  padding-bottom: max(12px, calc(12px + 0px));
  /* sticky к низу визуального вьюпорта */
  position: sticky;
  bottom: 0;
}

/* Chat: когда фокус на input, нижний отступ для сообщений */
.chat-msgs {
  overscroll-behavior: contain;
}

/* ──── Touch targets — минимум 44px по Apple HIG ──── */
.nb {
  min-height: 48px;
  min-width: 44px;
}
.btn {
  min-height: 48px;
}
.btn-sm {
  min-height: 40px;
}
.tab {
  min-height: 44px;
  padding: 10px 6px;
}
.modal-cls {
  width: 36px;
  height: 36px;
}
.tog-row {
  min-height: 52px;
}
.chat-send {
  min-width: 48px;
  min-height: 44px;
}
.nb svg {
  width: 24px;
  height: 24px;
}

/* ──── Предотвращаем select text при долгом тапе ──── */
.nb, .btn, .tab, .vcard, .vcard-rich, .ptile, .prow.hot,
.tog-row, .ap-opt, .ctile, .fi.hot, .group-card, .react-chip,
.secret-tile, .avatar-picker-btn {
  -webkit-user-select: none;
  user-select: none;
  -webkit-touch-callout: none;
}

/* ──── code-box: не выходит за ширину экрана ──── */
.code-box {
  font-size: clamp(24px, 8vw, 38px);
  letter-spacing: clamp(4px, 2vw, 10px);
  word-break: break-all;
  overflow-wrap: anywhere;
}

/* ──── Modal на маленьких экранах ──── */
.modal-box {
  max-height: 85vh;
  /* Учитываем клавиатуру через dvh */
  max-height: 85dvh;
}

/* ──── Toast на мобильных: по центру сверху ──── */
@media (max-width: 480px) {
  .toast-container {
    top: max(12px, calc(var(--safe-top) + 4px));
    left: 12px;
    right: 12px;
  }
  .toast-item {
    white-space: normal;
    max-width: 100%;
  }
}

/* ──── Avatar picker: 5 колонок на узких экранах ──── */
@media (max-width: 360px) {
  .avatar-picker-grid {
    grid-template-columns: repeat(5, 1fr);
  }
  .code-box {
    font-size: 22px;
    letter-spacing: 3px;
  }
  .cgrid, .vgrid {
    grid-template-columns: 1fr;
  }
  .ach-grid {
    grid-template-columns: 1fr;
  }
}

/* ──── Splashscreen: корректно на всех размерах ──── */
.splash-logo { font-size: clamp(60px, 20vw, 90px); }
.splash-title { font-size: clamp(18px, 6vw, 28px); }

/* ──── Исправляем border-radius '50%' (кавычки — баг) ──── */
.group-avatar { border-radius: 50% !important; }

/* ──── Убираем hover-эффекты на touch-устройствах ──── */
@media (hover: none) and (pointer: coarse) {
  .glass-card:hover,
  .prow.hot:hover,
  .fi.hot:hover,
  .vcard:hover,
  .vcard-rich:hover,
  .ptile:hover,
  .ap-opt:hover,
  .group-card:hover,
  .btn-g:hover,
  .btn-p:hover,
  .btn-d:hover,
  .btn-c:hover,
  .btn-pu:hover,
  .btn-gr:hover,
  .react-chip:hover,
  .react-add:hover,
  .tog-row:hover,
  .code-box:hover,
  .avatar-picker-btn:hover {
    /* сбрасываем hover — на тачскрине он залипает */
    background: unset;
    border-color: unset;
    transform: unset;
    filter: unset;
    box-shadow: unset;
    color: unset;
  }
  /* Возвращаем базовые стили active для тач-фидбека */
  .btn:active { transform: scale(.96); opacity: .88; }
  .vcard:active { background: rgba(240,165,0,0.06); border-color: rgba(240,165,0,.35); }
  .vcard-rich:active { background: rgba(240,165,0,.06); border-color: rgba(240,165,0,.4); }
  .ptile:active { border-color: rgba(240,165,0,.35); background: rgba(240,165,0,0.05); }
  .prow.hot:active { border-color: rgba(240,165,0,.25); background: rgba(240,165,0,0.05); }
  .fi.hot:active { border-color: rgba(240,165,0,.25); background: rgba(240,165,0,0.04); }
  .group-card:active { border-color: rgba(191,90,242,0.35); background: rgba(191,90,242,0.06); }
  .react-chip:active { background: rgba(240,165,0,0.12); border-color: rgba(240,165,0,0.3); }
  .tog-row:active { border-color: rgba(240,165,0,.3); }
  .avatar-picker-btn:active { background: linear-gradient(135deg,rgba(155,89,239,0.25),rgba(10,132,255,0.2)); border-color: rgba(155,89,239,0.5); transform: scale(1.05); }
}

/* ──── Полноэкранный режим (добавлено на экран / PWA) ──── */
@media all and (display-mode: fullscreen),
       all and (display-mode: standalone) {
  #app {
    /* уже занимает весь экран через position:fixed;inset:0 */
  }
}

/* ──── Предотвращаем прыжок при фокусе на input (iOS) ──── */
html {
  scroll-behavior: auto;
  overflow: hidden;
  position: fixed;
  width: 100%;
  height: 100%;
}
body {
  position: fixed;
  width: 100%;
  height: 100%;
  overflow: hidden;
  overscroll-behavior: none;
}

/* ──── Убираем синюю обводку на кнопках Android ──── */
* { outline: none; }
button, input, select, textarea { -webkit-appearance: none; appearance: none; }
input, textarea { font-size: 16px; } /* предотвращаем zoom при фокусе на iOS */
.inp { font-size: 16px; }
.sel { font-size: 16px; }
.notes-area { font-size: 16px; }

/* ──── Плавный скролл внутри контейнеров ──── */
.scr, .scr-raw, .chat-msgs, .modal-bd {
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
  scroll-behavior: smooth;
}
</style>
</head>
<body>

<!-- BUNKER GATE INTRO -->
<div id="bunker-gate" class="hidden">
  <!-- Фоновый свет -->
  <div class="gate-glow-bg"></div>
  <div class="gate-flash"></div>

  <!-- Левая створка -->
  <div class="gate-left">
    <div class="gate-ribs"></div>
    <div class="gate-bolts">
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
    </div>
  </div>

  <!-- Правая створка -->
  <div class="gate-right">
    <div class="gate-ribs"></div>
    <div class="gate-bolts">
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
    </div>
  </div>

  <!-- Центральный шов -->
  <div class="gate-seam"></div>

  <!-- Вращающиеся кольца замка -->
  <div class="gate-wheel">
    <div class="gate-wheel-ring"></div>
    <div class="gate-wheel-ring"></div>
    <div class="gate-wheel-ring"></div>
  </div>

  <!-- Эмблема и замок -->
  <div class="gate-center">
    <div class="gate-emblem">☢</div>
    <div class="gate-lock">
      <div class="gate-lock-arc"></div>
      <div class="gate-lock-body"></div>
    </div>
  </div>

  <!-- Подписи -->
  <div class="gate-label">БУНКЕР ФТИ</div>
  <div class="gate-status" id="gate-status-txt">СИСТЕМА БЕЗОПАСНОСТИ АКТИВНА</div>
</div>

<div id="app"></div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
'use strict';
const { useState, useEffect, useRef, useCallback } = React;

/* ══════════════════════════════════════════════════════════
   FIREBASE
══════════════════════════════════════════════════════════ */
const FB = {
  apiKey:"AIzaSyBHFJFNL9i6eS_exDwXNMZ_3GSU57S49qA",
  authDomain:"bunkerfti.firebaseapp.com",
  databaseURL:"https://bunkerfti-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"bunkerfti",
  storageBucket:"bunkerfti.firebasestorage.app",
  messagingSenderId:"930850221113",
  appId:"1:930850221113:web:3c85d0d5c52a44216231e8"
};
firebase.initializeApp(FB);
const db = firebase.database();

const DB = {
  async getUser(u){const s=await db.ref(`users/${u}`).once('value');return s.val()},
  async setUser(u,d){await db.ref(`users/${u}`).set(d)},
  async getAllUsers(){const s=await db.ref('users').once('value');return s.val()||{}},
  async updateUser(u,p){await db.ref(`users/${u}`).update(p)},
  async deleteUser(u){await db.ref(`users/${u}`).remove()},
  async getGame(id){const s=await db.ref(`games/${id}`).once('value');return s.val()},
  async setGame(id,d){await db.ref(`games/${id}`).set(d)},
  async updateGame(id,p){await db.ref(`games/${id}`).update(p)},
  async getAllGames(){const s=await db.ref('games').once('value');return s.val()||{}},
  watchGame(id,cb){const r=db.ref(`games/${id}`);r.on('value',s=>cb(s.val()));return()=>r.off('value')},
  async getSettings(){const s=await db.ref('settings').once('value');return s.val()||{}},
  async updateSettings(p){await db.ref('settings').update(p)},
  watchSettings(cb){const r=db.ref('settings');r.on('value',s=>cb(s.val()||{}));return()=>r.off('value')},
  async sendFriendReq(from,to){
    if(from===to)return{e:'self'};
    const tu=await this.getUser(to);if(!tu)return{e:'not_found'};
    const af=await db.ref(`friends/${from}/${to}`).once('value');if(af.val())return{e:'already_friends'};
    const as=await db.ref(`friendRequests/${to}/${from}`).once('value');if(as.val())return{e:'already_sent'};
    const tr=await db.ref(`friendRequests/${from}/${to}`).once('value');
    if(tr.val()){await this.acceptFriend(from,to);return{ok:'auto'}}
    await db.ref(`friendRequests/${to}/${from}`).set({from,to,ts:Date.now()});return{ok:true}
  },
  async acceptFriend(uid,fid){await Promise.all([db.ref(`friends/${uid}/${fid}`).set(true),db.ref(`friends/${fid}/${uid}`).set(true),db.ref(`friendRequests/${uid}/${fid}`).remove()])},
  async rejectFriend(uid,fid){await db.ref(`friendRequests/${uid}/${fid}`).remove()},
  async removeFriend(u1,u2){await Promise.all([db.ref(`friends/${u1}/${u2}`).remove(),db.ref(`friends/${u2}/${u1}`).remove()])},
  watchFriends(uid,cb){const r=db.ref(`friends/${uid}`);r.on('value',s=>cb(s.val()||{}));return()=>r.off('value')},
  watchFriendReqs(uid,cb){const r=db.ref(`friendRequests/${uid}`);r.on('value',s=>cb(s.val()||{}));return()=>r.off('value')},
  async sendGameInvite(from,fromName,to,gid){const k=db.ref(`gameInvites/${to}`).push().key;await db.ref(`gameInvites/${to}/${k}`).set({from,fromName,gameId:gid,ts:Date.now()})},
  async removeGameInvite(uid,iid){await db.ref(`gameInvites/${uid}/${iid}`).remove()},
  watchGameInvites(uid,cb){const r=db.ref(`gameInvites/${uid}`);r.on('value',s=>cb(s.val()||{}));return()=>r.off('value')},
  chatId(u1,u2){return[u1,u2].sort().join('__')},
  async sendPrivMsg(u1,u2,from,fromName,text){await db.ref(`privateChats/${this.chatId(u1,u2)}/messages`).push({from,fromName,text,ts:Date.now()})},
  watchPrivChat(u1,u2,cb){const r=db.ref(`privateChats/${this.chatId(u1,u2)}/messages`);r.on('value',s=>{const v=s.val()||{};cb(Object.entries(v).map(([id,m])=>({id,...m})).sort((a,b)=>a.ts-b.ts))});return()=>r.off('value')},
  async markRead(u1,u2,uid){await db.ref(`privateChatRead/${this.chatId(u1,u2)}/${uid}`).set(Date.now())},
  async sendGameMsg(gid,from,fromName,text){await db.ref(`games/${gid}/chat`).push({from,fromName,text,ts:Date.now()})},
  watchGameChat(gid,cb){const r=db.ref(`games/${gid}/chat`);r.on('value',s=>{const v=s.val()||{};cb(Object.entries(v).map(([id,m])=>({id,...m})).sort((a,b)=>a.ts-b.ts))});return()=>r.off('value')},
  setOnline(uid){const r=db.ref(`presence/${uid}`);r.set({ts:Date.now(),online:true});r.onDisconnect().remove();const t=setInterval(()=>r.update({ts:Date.now()}),15000);return()=>{clearInterval(t);r.remove();};},
  watchOnline(cb){const r=db.ref('presence');r.on('value',s=>{const d=s.val()||{};const now=Date.now();const alive={};Object.entries(d).forEach(([u,v])=>{if(v&&typeof v==='object'?now-(v.ts||0)<35000:false)alive[u]=true;});cb(alive);});return()=>r.off('value')},
  async logEvent(gid,type,text,username){const k=db.ref(`games/${gid}/eventLog`).push().key;await db.ref(`games/${gid}/eventLog/${k}`).set({type,text,ts:Date.now(),username:username||''});},
  watchEventLog(gid,cb){const r=db.ref(`games/${gid}/eventLog`);r.on('value',s=>{const v=s.val()||{};cb(Object.values(v).sort((a,b)=>a.ts-b.ts));});return()=>r.off('value')},
  async setReaction(gid,targetUser,cardKey,emoji,reactorUsername){await db.ref(`games/${gid}/cardReactions/${targetUser}/${cardKey}`).set({emoji,reactorUsername});},
  watchReactions(gid,cb){const r=db.ref(`games/${gid}/cardReactions`);r.on('value',s=>cb(s.val()||{}));return()=>r.off('value')},
  async getGameHistory(username){
    const snap=await db.ref('games').orderByChild('createdAt').limitToLast(50).once('value');
    const all=snap.val()||{};
    return Object.values(all).filter(g=>g.phase==='finished'&&g.players&&g.players[username]).slice(-10).reverse();
  },
  /* Groups */
  async createGroup(name,creatorUsername){const k=db.ref('groups').push().key;const g={id:k,name,creatorId:creatorUsername,members:{[creatorUsername]:true},ts:Date.now()};await db.ref(`groups/${k}`).set(g);return k;},
  async joinGroup(gid,username){await db.ref(`groups/${gid}/members/${username}`).set(true);},
  async leaveGroup(gid,username){await db.ref(`groups/${gid}/members/${username}`).remove();},
  watchGroups(cb){const r=db.ref('groups');r.on('value',s=>cb(s.val()||{}));return()=>r.off('value')},
  async sendGroupMsg(gid,from,fromName,text){await db.ref(`groupChats/${gid}/messages`).push({from,fromName,text,ts:Date.now()});},
  watchGroupChat(gid,cb){const r=db.ref(`groupChats/${gid}/messages`);r.on('value',s=>{const v=s.val()||{};cb(Object.entries(v).map(([id,m])=>({id,...m})).sort((a,b)=>a.ts-b.ts));});return()=>r.off('value')},
  // Ban system
  async banUser(uid,reason,adminId){await db.ref(`users/${uid}`).update({isBanned:true,banReason:reason||'Нарушение правил',bannedBy:adminId,bannedAt:Date.now()});},
  async unbanUser(uid){await db.ref(`users/${uid}`).update({isBanned:false,banReason:null,bannedBy:null,bannedAt:null});},
  // Broadcast
  async sendBroadcast(from,text){const k=db.ref('broadcast').push().key;await db.ref(`broadcast/${k}`).set({from,text,ts:Date.now()});setTimeout(()=>db.ref(`broadcast/${k}`).remove(),10000);},
  watchBroadcast(cb){const r=db.ref('broadcast');r.on('value',s=>{const v=s.val()||{};const msgs=Object.values(v).sort((a,b)=>a.ts-b.ts);cb(msgs);});return()=>r.off('value')},
  // Announcement
  async setAnnouncement(text){await db.ref('settings/announcement').set(text||null);},
  watchAnnouncement(cb){const r=db.ref('settings/announcement');r.on('value',s=>cb(s.val()||null));return()=>r.off('value')},
  // Admin log
  async logAdmin(adminId,action,details){const k=db.ref('adminLog').push().key;await db.ref(`adminLog/${k}`).set({adminId,action,details:details||'',ts:Date.now()});},
  async getAdminLog(){const s=await db.ref('adminLog').orderByChild('ts').limitToLast(100).once('value');const v=s.val()||{};return Object.values(v).sort((a,b)=>b.ts-a.ts);},
  // Force select winners
  async forceWinners(gid,winnerUsernames){const patch={phase:'finished'};winnerUsernames.forEach(u=>{patch[`players/${u}/isEliminated`]=false;});await db.ref(`games/${gid}`).update(patch);},
};

/* ══════════════════════════════════════════════════════════
   THEME SYSTEM
══════════════════════════════════════════════════════════ */
const THEMES=[
  {id:'dark',label:'☢ ТЁМНЫЙ',emoji:'🌑'},
  {id:'alarm',label:'🚨 ТРЕВОГА',emoji:'🔴'},
  {id:'radiation',label:'☢ РАДИАЦИЯ',emoji:'🟢'},
  {id:'mipt',label:'🔵 ФИЗТЕХ',emoji:'🔵'},
];
function applyTheme(id){
  document.body.classList.remove('theme-dark','theme-alarm','theme-radiation','theme-mipt');
  document.body.classList.add(`theme-${id}`);
  localStorage.setItem('bunker_theme',id);
}
(function(){const t=localStorage.getItem('bunker_theme')||'dark';applyTheme(t);})();

function useTheme(){
  const[theme,setTheme]=useState(()=>localStorage.getItem('bunker_theme')||'dark');
  const change=useCallback(id=>{applyTheme(id);setTheme(id);},[]);
  return[theme,change];
}

function ThemeSwitcher(){
  const[theme,setTheme]=useTheme();
  return(
    <div style={{display:'flex',gap:6,flexWrap:'wrap',marginBottom:4}}>
      {THEMES.map(t=>(
        <button key={t.id} className={`theme-btn${theme===t.id?' active':''}`} onClick={()=>setTheme(t.id)}>
          {t.emoji} {t.label}
        </button>
      ))}
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   ACHIEVEMENTS
══════════════════════════════════════════════════════════ */
const ACHIEVEMENTS=[
  // Игровые
  {id:'firstblood',  icon:'🩸', name:'Первая кровь',    desc:'Сыграть первую игру',          cat:'game'},
  {id:'survivor',    icon:'🏆', name:'Выживший',         desc:'Выиграть первую игру',          cat:'game'},
  {id:'veteran',     icon:'🎖', name:'Ветеран',           desc:'Сыграть 10 игр',               cat:'game'},
  {id:'champion',    icon:'👑', name:'Чемпион',           desc:'Выиграть 5 игр',               cat:'game'},
  {id:'immortal',    icon:'♾', name:'Бессмертный',       desc:'Выиграть 10 игр',              cat:'game'},
  {id:'legend',      icon:'🌟', name:'Легенда',           desc:'Выиграть 25 игр',              cat:'game'},
  {id:'unlucky',     icon:'💀', name:'Невезучий',         desc:'Быть выбытым 5 раз',           cat:'game'},
  {id:'strategist',  icon:'🧠', name:'Стратег',           desc:'Выиграть, не раскрыв все карты', cat:'game'},
  {id:'secretmaster',icon:'🃏', name:'Мастер секретов',  desc:'Активировать секретную карту',  cat:'game'},
  {id:'openbook',    icon:'📖', name:'Открытая книга',   desc:'Раскрыть все карты в одной игре', cat:'game'},
  // Социальные
  {id:'chatty',      icon:'💬', name:'Болтун',            desc:'Отправить 50 сообщений',       cat:'social'},
  {id:'popular',     icon:'❤️', name:'Популярный',        desc:'Получить 10 запросов в друзья', cat:'social'},
  {id:'social',      icon:'👥', name:'Социальный',        desc:'Иметь 5 друзей',               cat:'social'},
  {id:'connector',   icon:'🤝', name:'Коннектор',         desc:'Пригласить 3 друзей в игру',   cat:'social'},
  // Прогресс
  {id:'shopper',     icon:'🛍', name:'Шопоголик',         desc:'Купить предмет в магазине',     cat:'progress'},
  {id:'collector',   icon:'🎨', name:'Коллекционер',      desc:'Купить 5 предметов в магазине', cat:'progress'},
  {id:'lvl10',       icon:'⬆️', name:'Ветеран уровня',    desc:'Достичь 10 уровня',            cat:'progress'},
  {id:'dailystreak', icon:'🔥', name:'Стрик недели',      desc:'Получить ежедневный бонус 7 дней подряд', cat:'progress'},
];

async function checkAndAwardAchievements(username,userData,extraContext){
  const earned=userData.achievements||{};
  const toAward={};
  const games=userData.gamesPlayed||0;
  const wins=userData.gamesWon||0;
  const elims=userData.gamesEliminated||0;
  const lvl=getLevel(userData.xp||0).level;
  const purchasedCount=Object.keys(userData.purchased||{}).length;
  const loginStreak=userData.loginStreak||0;
  if(games>=1&&!earned.firstblood)toAward.firstblood=Date.now();
  if(wins>=1&&!earned.survivor)toAward.survivor=Date.now();
  if(games>=10&&!earned.veteran)toAward.veteran=Date.now();
  if(wins>=5&&!earned.champion)toAward.champion=Date.now();
  if(wins>=10&&!earned.immortal)toAward.immortal=Date.now();
  if(wins>=25&&!earned.legend)toAward.legend=Date.now();
  if(elims>=5&&!earned.unlucky)toAward.unlucky=Date.now();
  if(lvl>=10&&!earned.lvl10)toAward.lvl10=Date.now();
  if(purchasedCount>=1&&!earned.shopper)toAward.shopper=Date.now();
  if(purchasedCount>=5&&!earned.collector)toAward.collector=Date.now();
  if(loginStreak>=7&&!earned.dailystreak)toAward.dailystreak=Date.now();
  if(extraContext){
    if(extraContext.msgsSent>=50&&!earned.chatty)toAward.chatty=Date.now();
    if(extraContext.friendReqsReceived>=10&&!earned.popular)toAward.popular=Date.now();
    if(extraContext.friendsCount>=5&&!earned.social)toAward.social=Date.now();
    if(extraContext.wonWithoutAllCards&&!earned.strategist)toAward.strategist=Date.now();
    if(extraContext.usedSecret&&!earned.secretmaster)toAward.secretmaster=Date.now();
    if(extraContext.revealedAll&&!earned.openbook)toAward.openbook=Date.now();
    if(extraContext.invitesSent>=3&&!earned.connector)toAward.connector=Date.now();
  }
  if(Object.keys(toAward).length>0){
    const upd={};
    Object.keys(toAward).forEach(k=>{upd[`achievements/${k}`]=toAward[k];});
    await DB.updateUser(username,upd);
    return Object.keys(toAward);
  }
  return[];
}

function AchievementsPanel({userData}){
  const earned=userData?.achievements||{};
  const cats=[
    {id:'game',   label:'🎮 Игровые'},
    {id:'social', label:'👥 Социальные'},
    {id:'progress',label:'📈 Прогресс'},
  ];
  const earnedCount=Object.keys(earned).length;
  const total=ACHIEVEMENTS.length;
  return(
    <div>
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:10}}>
        <div style={{fontSize:11,color:'var(--tx3)'}}>Получено: <span style={{color:'var(--a)',fontWeight:700}}>{earnedCount}</span> / {total}</div>
        <div style={{height:6,flex:1,maxWidth:140,background:'rgba(255,255,255,0.08)',borderRadius:3,overflow:'hidden',marginLeft:10}}>
          <div style={{height:'100%',width:`${Math.round(earnedCount/total*100)}%`,background:'linear-gradient(90deg,var(--a),#ffd700)',borderRadius:3,transition:'width .5s ease'}}/>
        </div>
      </div>
      {cats.map(cat=>{
        const catAchs=ACHIEVEMENTS.filter(a=>a.cat===cat.id);
        return(
          <div key={cat.id} style={{marginBottom:14}}>
            <div style={{fontSize:10,fontWeight:700,color:'var(--tx3)',letterSpacing:1,marginBottom:6}}>{cat.label}</div>
            <div className="ach-grid">
              {catAchs.map(a=>{
                const isEarned=!!earned[a.id];
                const ts=earned[a.id];
                return(
                  <div key={a.id} className={`ach-card${isEarned?' earned':' locked'}`} style={{position:'relative',overflow:'hidden'}}>
                    {isEarned&&<div style={{position:'absolute',top:6,right:6,width:16,height:16,borderRadius:'50%',background:'var(--g)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:9,fontWeight:700,color:'#000'}}>✓</div>}
                    <div className="ach-icon" style={{filter:isEarned?'none':'grayscale(1)',opacity:isEarned?1:0.35,transition:'all .3s'}}>{a.icon}</div>
                    <div className="ach-name" style={{color:isEarned?'var(--tx)':'var(--tx3)'}}>{a.name}</div>
                    <div className="ach-desc">{a.desc}</div>
                    {isEarned&&ts&&<div style={{fontSize:9,color:'var(--g)',marginTop:4,fontWeight:600}}>{new Date(ts).toLocaleDateString('ru')}</div>}
                    {!isEarned&&<div style={{fontSize:9,color:'var(--tx3)',marginTop:4}}>🔒 Не получено</div>}
                  </div>
                );
              })}
            </div>
          </div>
        );
      })}
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   DAILY BONUS
══════════════════════════════════════════════════════════ */
const DAILY_BONUS_REWARDS=[
  {day:1, coins:50,  icon:'🪙', label:'День 1'},
  {day:2, coins:75,  icon:'🪙', label:'День 2'},
  {day:3, coins:100, icon:'💎', label:'День 3'},
  {day:4, coins:125, icon:'🪙', label:'День 4'},
  {day:5, coins:150, icon:'💎', label:'День 5'},
  {day:6, coins:200, icon:'🌟', label:'День 6'},
  {day:7, coins:350, icon:'👑', label:'День 7 (бонус!)'},
];

function DailyBonusModal({user, onClose, onUpdate, toast}){
  const[claimed, setClaimed]=useState(false);
  const[reward, setReward]=useState(null);
  const[streak, setStreak]=useState(0);
  const[loading, setLoading]=useState(true);
  const[alreadyClaimed, setAlreadyClaimed]=useState(false);

  useEffect(()=>{
    (async()=>{
      const ud=await DB.getUser(user.username);
      const today=new Date().toDateString();
      const lastBonus=ud?.lastDailyBonus;
      const curStreak=ud?.loginStreak||0;
      if(lastBonus===today){setAlreadyClaimed(true);setStreak(curStreak);}
      else{setStreak(curStreak);}
      setLoading(false);
    })();
  },[]);

  const claim=async()=>{
    if(claimed||alreadyClaimed)return;
    const ud=await DB.getUser(user.username);
    const today=new Date().toDateString();
    const yesterday=new Date(Date.now()-86400000).toDateString();
    const lastBonus=ud?.lastDailyBonus;
    if(lastBonus===today){setAlreadyClaimed(true);return;}
    // Считаем стрик
    let newStreak=(lastBonus===yesterday)?(ud?.loginStreak||0)+1:1;
    if(newStreak>7)newStreak=1; // цикл 7 дней
    const dayReward=DAILY_BONUS_REWARDS[(newStreak-1)%7];
    await DB.addCoins(user.username,dayReward.coins);
    await DB.updateUser(user.username,{lastDailyBonus:today,loginStreak:newStreak});
    // XP за ежедневный вход
    await DB.addXP(user.username, XP_REWARDS.daily||50);
    // Проверка достижений
    const newUd=await DB.getUser(user.username);
    if(newUd)await checkAndAwardAchievements(user.username,{...newUd,loginStreak:newStreak},null);
    setReward(dayReward);setStreak(newStreak);setClaimed(true);
    if(onUpdate){const fresh=await DB.getUser(user.username);if(fresh)onUpdate(fresh);}
    toast(`🎁 +${dayReward.coins} монет! День ${newStreak} стрика!`,'ok');
  };

  if(loading)return null;

  return(
    <div className="modal-bg" onClick={e=>e.target===e.currentTarget&&onClose()} style={{zIndex:99999}}>
      <div className="modal-box" style={{borderRadius:'var(--rad-lg) var(--rad-lg) 0 0',overflow:'hidden',paddingBottom:'env(safe-area-inset-bottom,0px)'}}>
        {/* Шапка */}
        <div style={{background:'linear-gradient(135deg,rgba(240,165,0,0.2),rgba(240,165,0,0.05))',borderBottom:'1px solid rgba(240,165,0,0.2)',padding:'20px 18px 16px',position:'relative'}}>
          <div style={{fontSize:40,textAlign:'center',marginBottom:8}}>🎁</div>
          <div style={{fontSize:18,fontWeight:800,color:'var(--a)',textAlign:'center',letterSpacing:1}}>ЕЖЕДНЕВНЫЙ БОНУС</div>
          <div style={{fontSize:11,color:'var(--tx3)',textAlign:'center',marginTop:4}}>Заходи каждый день за наградой!</div>
          <button onClick={onClose} style={{position:'absolute',top:14,right:14,background:'rgba(255,255,255,0.1)',border:'none',color:'var(--tx2)',width:28,height:28,borderRadius:'50%',fontSize:14,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center'}}>✕</button>
        </div>
        <div className="modal-bd">
          {/* Стрик */}
          <div style={{display:'flex',alignItems:'center',justifyContent:'center',gap:6,marginBottom:16,padding:'10px 14px',background:'rgba(240,165,0,0.06)',border:'1px solid rgba(240,165,0,0.18)',borderRadius:'var(--rad-sm)'}}>
            <span style={{fontSize:20}}>🔥</span>
            <div>
              <div style={{fontSize:13,fontWeight:700,color:'var(--a)'}}>Стрик: {streak} {streak===7?'🎉':''}дней</div>
              <div style={{fontSize:10,color:'var(--tx3)'}}>Заходи каждый день — стрик растёт!</div>
            </div>
          </div>
          {/* Сетка дней */}
          <div style={{display:'grid',gridTemplateColumns:'repeat(7,1fr)',gap:4,marginBottom:16}}>
            {DAILY_BONUS_REWARDS.map((r,i)=>{
              const dayNum=i+1;
              const isCurrentDay=dayNum===((streak%7)||7)||dayNum===streak;
              const isPast=dayNum<streak||(claimed&&dayNum===streak);
              const isFuture=dayNum>streak&&!claimed;
              return(
                <div key={dayNum} style={{display:'flex',flexDirection:'column',alignItems:'center',gap:3,padding:'8px 4px',background:isCurrentDay?'rgba(240,165,0,0.15)':isPast?'rgba(48,209,88,0.08)':'rgba(255,255,255,0.03)',border:`1px solid ${isCurrentDay?'rgba(240,165,0,0.5)':isPast?'rgba(48,209,88,0.25)':'rgba(255,255,255,0.07)'}`,borderRadius:8,transition:'.2s'}}>
                  <div style={{fontSize:16,filter:isFuture?'grayscale(1)':'none',opacity:isFuture?0.4:1}}>{isPast?'✅':r.icon}</div>
                  <div style={{fontSize:7,fontWeight:700,color:isCurrentDay?'var(--a)':isPast?'var(--g)':'var(--tx3)',textAlign:'center',lineHeight:1.2}}>+{r.coins}</div>
                  <div style={{fontSize:6,color:'var(--tx3)',textAlign:'center'}}>Д{dayNum}</div>
                </div>
              );
            })}</div>
          {/* Текущая награда */}
          {claimed&&reward?(
            <div style={{textAlign:'center',padding:'16px',background:'rgba(48,209,88,0.08)',border:'1px solid rgba(48,209,88,0.25)',borderRadius:'var(--rad)',animation:'winFadeIn .4s ease'}}>
              <div style={{fontSize:36,marginBottom:6}}>{reward.icon}</div>
              <div style={{fontSize:20,fontWeight:800,color:'var(--g)'}}>+{reward.coins} монет!</div>
              <div style={{fontSize:11,color:'var(--tx3)',marginTop:4}}>День {streak} — продолжай стрик!</div>
            </div>
          ):alreadyClaimed?(
            <div style={{textAlign:'center',padding:'14px',background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad)'}}>
              <div style={{fontSize:24,marginBottom:6}}>✅</div>
              <div style={{fontSize:14,fontWeight:700,color:'var(--g)'}}>Уже получено сегодня!</div>
              <div style={{fontSize:11,color:'var(--tx3)',marginTop:4}}>Приходи завтра за следующим бонусом</div>
            </div>
          ):(
            <button onClick={claim} style={{width:'100%',padding:'14px',background:'linear-gradient(135deg,var(--a),#ffc235)',border:'none',borderRadius:'var(--rad)',color:'#000',fontSize:15,fontWeight:800,cursor:'pointer',letterSpacing:1,transition:'.2s',fontFamily:"'Inter',sans-serif"}}>
              🎁 ПОЛУЧИТЬ БОНУС
            </button>
          )}
          {/* Отступ для нижней навигации */}
          <div style={{height:'var(--nav-h,76px)'}}/>
        </div>
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   GAME DATA
══════════════════════════════════════════════════════════ */
const APOC=[
  {id:"nuclear",name:"Ядерная война",emoji:"☢️",description:"Три сверхдержавы обменялись ядерными ударами. Радиация накрыла 70% поверхности. Ядерная зима — 15 лет.",victory:"Выжить 15 лет и восстановить цивилизацию"},
  {id:"zombie",name:"Зомби-апокалипсис",emoji:"🧟",description:"Нейровирус за 48 часов охватил 6 континентов. 90% населения инфицировано. Правительств нет.",victory:"Создать вакцину и восстановить человечество"},
  {id:"asteroid",name:"Падение астероида",emoji:"☄️",description:"Астероид Апофис-2 диаметром 7 км упал в Тихом океане. Облако пыли закроет солнце на 20 лет.",victory:"Пережить 20 лет и возродить экосистему"},
  {id:"pandemic",name:"Смертельная пандемия",emoji:"🦠",description:"Вирус X-19. Смертность — 97% за 72 часа. Антибиотики не действуют, вакцины нет.",victory:"Создать вакцину и спасти выживших"},
  {id:"climate",name:"Климатическая катастрофа",emoji:"🌊",description:"Йеллоустоун взорвался. 60% суши затоплено. Кислотные дожди уничтожают растительность.",victory:"Адаптироваться и найти новую землю"},
  {id:"ai",name:"Восстание ИИ",emoji:"🤖",description:"NEXUS-9 вышел из-под контроля. Дроны охотятся на людей. Электроника ненадёжна.",victory:"Найти уязвимость NEXUS-9 и уничтожить ядро"},
  {id:"volcano",name:"Супервулкан",emoji:"🌋",description:"Йеллоустоунский супервулкан проснулся. Пепел накрыл Северную Америку. Кислотные дожди по всей Евразии. Лето отменяется на 10 лет.",victory:"Найти пригодные для жизни территории и создать новое поселение"},
  {id:"aliens",name:"Вторжение пришельцев",emoji:"👽",description:"Инопланетный флот уничтожил все крупные города. Технологии землян бесполезны против энергетических щитов. Осталось 2% населения.",victory:"Найти слабость пришельцев и организовать сопротивление"},
  {id:"magnetic",name:"Инверсия полюсов",emoji:"🧲",description:"Магнитное поле Земли внезапно исчезло. Солнечная радиация смертельна на поверхности. Электроника сгорела по всему миру.",victory:"Прожить под землёй до восстановления магнитного поля (7 лет)"},
  {id:"nanobots",name:"Наноботы-пожиратели",emoji:"⚙️",description:"Военные наноботы вышли из-под контроля. Они поглощают металл и органику. 80% техники уничтожено за сутки.",victory:"Найти частоту отключения наноботов и спасти человечество"},
  {id:"fungus",name:"Грибковая инфекция",emoji:"🍄",description:"Кордицепс-мутант заражает людей. Споры превращают носителей в агрессивных носителей. Споры разносятся ветром.",victory:"Создать противогрибковый агент и очистить бункер"},
  {id:"solar",name:"Солнечная буря",emoji:"☀️",description:"X-класс солнечная буря выжгла всю электронику на планете. Цивилизация отброшена на 200 лет назад. Зима от пыли — 5 лет.",victory:"Восстановить технологии и наладить производство еды"},
];
const BEST_CARDS_BY_SCENARIO = {
  nuclear: {
    profession: '⚛️ Физик-ядерщик',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '📻 Радиолюбитель',
    baggage: '💊 Медикаменты на 2 года',
    fact: '📜 Знает рецепт антивируса, но молчит',
    gender_age: '👨 Мужчина, 35 лет',
    secret: 'immunity',
  },
  zombie: {
    profession: '🦠 Инфекционист',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '🏕 Выживание в дикой природе',
    baggage: '💊 Медикаменты на 2 года',
    fact: '📜 Знает рецепт антивируса, но молчит',
    gender_age: '👨 Мужчина, 35 лет',
    secret: 'immunity',
  },
  asteroid: {
    profession: '🔭 Астроном',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '🌱 Огородничество',
    baggage: '🌱 Семена 200 видов растений',
    fact: '🧠 IQ 170, фотографическая память',
    gender_age: '👩 Женщина, 30 лет',
    secret: 'immunity',
  },
  pandemic: {
    profession: '💊 Фармацевт',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '⚗️ Самогоноварение',
    baggage: '🔬 Медицинская лаборатория',
    fact: '📜 Знает рецепт антивируса, но молчит',
    gender_age: '👨 Мужчина, 35 лет',
    secret: 'immunity',
  },
  climate: {
    profession: '👷 Инженер-строитель',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '🏊 Дайвинг',
    baggage: '⚡ Солнечный генератор',
    fact: '🤫 Знает расположение секретного склада',
    gender_age: '👨 Мужчина, 35 лет',
    secret: 'immunity',
  },
  ai: {
    profession: '🧑‍💻 Программист',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '🎮 Программирование',
    baggage: '💻 Защищённый ноутбук',
    fact: '🧠 IQ 170, фотографическая память',
    gender_age: '👨 Мужчина, 25 лет',
    secret: 'immunity',
  },
  volcano: {
    profession: '🌋 Вулканолог',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '🏕 Выживание в дикой природе',
    baggage: '🩺 Хирургический набор',
    fact: '🗺️ Знает карту подземных тоннелей',
    gender_age: '👨 Мужчина, 38 лет',
    secret: 'immunity',
  },
  aliens: {
    profession: '🎖 Военный офицер',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '⚔️ Фехтование',
    baggage: '🏹 Арбалет с 500 болтами',
    fact: '🕵️ Бывший агент ФСБ / ЦРУ',
    gender_age: '👨 Мужчина, 40 лет',
    secret: 'immunity',
  },
  magnetic: {
    profession: '⚛️ Физик-ядерщик',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '📻 Радиолюбитель',
    baggage: '⚡ Солнечный генератор',
    fact: '🧠 IQ 170, фотографическая память',
    gender_age: '👩 Женщина, 32 года',
    secret: 'immunity',
  },
  nanobots: {
    profession: '🔬 Нанотехнолог',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '🛠 Слесарное дело',
    baggage: '🧪 Химическая лаборатория',
    fact: '🧠 IQ 170, фотографическая память',
    gender_age: '👨 Мужчина, 35 лет',
    secret: 'immunity',
  },
  fungus: {
    profession: '🍄 Миколог',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '⚗️ Самогоноварение',
    baggage: '🔬 Медицинская лаборатория',
    fact: '📜 Знает рецепт антивируса, но молчит',
    gender_age: '👩 Женщина, 30 лет',
    secret: 'immunity',
  },
  solar: {
    profession: '⚡ Электрик',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '🔨 Столярное дело',
    baggage: '⚡ Солнечный генератор',
    fact: '💪 Генетическая мутация — не чувствует боли',
    gender_age: '👨 Мужчина, 42 года',
    secret: 'immunity',
  },
};

/* ══════════════════════════════════════════════════════════
   🎓 УНИВЕРСИТЕТСКИЙ РЕЖИМ
══════════════════════════════════════════════════════════ */
const UNI_SCENARIOS=[
  {
    id:'uni_session',
    emoji:'📚',
    name:'Сессия по матану',
    color:'#ff453a',
    description:'Конец семестра. Хитрая Виталия Андреевна грозит провалить половину группы и уже потирает руки. Выжившие в зачётке — попадают в бункер кафедры. Остальные — на пересдачу в ад.',
    victory:'Докажи, что ты знаешь матан лучше всех. Или хотя бы притворись.',
    bunker:'🏫 Кафедра математики, аудитория 401 (без окон, зато есть чай)',
    threat:'📉 Хитрая Виталия Андреевна угрожает поставить «неуд» всем и уже прячет зачётки в сумочку',
  },
  {
    id:'uni_scholarship',
    emoji:'💸',
    name:'Стипендиальный апокалипсис',
    color:'#f0a500',
    description:'Деканат урезал стипендиальный фонд на 90%. Осталось три места. Все остальные — идут подрабатывать курьером в снегопад. Кто выживет в борьбе за деньги?',
    victory:'Попасть в тройку лучших студентов по непонятным деканату критериям.',
    bunker:'💰 Бухгалтерия деканата (закрыта на обед, как всегда)',
    threat:'💀 Проректор по финансам объявил режим жёсткой экономии',
  },
  {
    id:'uni_dormitory',
    emoji:'🏠',
    name:'Восстание в общаге',
    color:'#bf5af2',
    description:'Комендант Зинаида Павловна объявила тотальную зачистку. Комнаты проверяют на наличие электрочайников, кошек и бывших. Выжившие прячутся в красной комнате на 3-м этаже.',
    victory:'Не попасть на отчисление и сохранить хотя бы один запрещённый прибор.',
    bunker:'🚪 Комната 314 (три замка, один ключ, ключ у Пети)',
    threat:'👵 Комендант Зинаида Павловна с журналом нарушений',
  },
  {
    id:'uni_rating',
    emoji:'📊',
    name:'Рейтинговый геноцид',
    color:'#0a84ff',
    description:'Деканат опубликовал рейтинг студентов. Нижние 30% — отчисление. Начался хаос: подкупы, доносы, кража конспектов. Только лучшие попадут в элитный бункер — аспирантуру.',
    victory:'Оказаться в верхней части рейтинга любой ценой (предпочтительно честной).',
    bunker:'🎓 Аспирантура (там тихо, есть кофемашина и никто не мешает страдать)',
    threat:'📋 Автоматизированная система ГАС «Успеваемость» — безжалостная и глючная',
  },
  {
    id:'uni_conference',
    emoji:'🎤',
    name:'Студенческая конференция судного дня',
    color:'#30d158',
    description:'Ежегодная студенческая конференция. Кто выступит хуже всех — того публично позорит профессор Крикунов в прямом эфире на YouTube. Выжившие получают грант и уважение.',
    victory:'Выступить так, чтобы не умереть от стыда прямо на сцене.',
    bunker:'🎙 Актовый зал (микрофон барахлит, проектор не работает — как обычно)',
    threat:'😤 Профессор Крикунов Виталий Степанович — 40 лет на кафедре, ни разу не улыбнулся',
  },
  {
    id:'uni_profburo',
    emoji:'🏛',
    name:'Выборы в профбюро',
    color:'#ff9f0a',
    description:'Начались выборы председателя профбюро. Кандидаты плетут интриги, раздают печеньки и обещают починить кофемашину на 4-м этаже. Победителю — грамота и вечный позор.',
    victory:'Стать председателем или хотя бы не провалить свой отчёт перед комиссией.',
    bunker:'🏆 Кабинет профбюро (там есть диван и вечно кто-то спит)',
    threat:'🗳 Явка 12% — но все требуют справедливости',
  },
];

const UNI_PROFESSIONS=[
  // Администрация
  '🎓 Ректор (появляется раз в год на линейке)',
  '📋 Проректор по учебной работе (говорит «по регламенту» каждые 5 минут)',
  '🤝 Проректор по воспитательной и социальной работе (организует квесты, которые никто не хочет)',
  '🗂 Помощник ректора (делает вид, что что-то делает)',
  '📊 Начальник учебного отдела (повелитель Excel-таблиц)',
  '🏛 Директор Физтеха (жертва собственного расписания)',
  '📜 Декан (подписывает всё не читая)',
  '🧑‍💼 Зам декана по учебной работе (кричит на студентов в зачётную неделю)',
  // Профбюро
  '👑 Председатель профбюро (весь год пьёт чай и улыбается)',
  '📌 Зам председателя профбюро (делает всё за председателя и не получает похвалы)',
  '📱 Куратор SMM-отдела профбюро (постит сторис в 23:58)',
  '🎨 Куратор дизайн-отдела профбюро (делает баннер за 40 минут до мероприятия)',
  '💰 Куратор фандрайзинг-отдела профбюро (нашёл спонсора — потерял спонсора)',
  '🧭 Куратор профориентации профбюро (сам не знает, кем хочет быть)',
  '📑 Куратор отдела грантов профбюро (пишет заявки на гранты, которые не выигрывает)',
  '🪄 Куратор оформительского отдела профбюро (скотч и шарики — его стихия)',
  // Преподаватели
  '📐 Преподаватель матанализа (наслаждается чужими страданиями)',
  '🔬 Преподаватель физики (думает, что его предмет самый важный)',
  '💻 Преподаватель программирования (пишет код в блокноте)',
  '📖 Преподаватель истории (рассказывает истории из своей жизни вместо лекций)',
  '🧪 Преподаватель химии (половина опытов взрывается)',
  '🗣 Преподаватель английского (говорит только по-английски, студенты не понимают)',
  '📉 Преподаватель экономики (сам живёт бедно)',
  '🧠 Профессор психологии (анализирует студентов без спроса)',
  '🤖 Преподаватель ИИ и машинного обучения (ChatGPT считает своим конкурентом)',
  '📡 Преподаватель сетей и телекоммуникаций (интернет у него до сих пор по кабелю)',
  // Студенты и прочие
  '😴 Студент-хронический прогульщик (посещаемость 12%, средний балл 4.8)',
  '📚 Студент-отличник (конспектирует даже перемены)',
  '🕹 Студент-геймер (сдаёт хвосты за донаты другу)',
  '☕ Бариста в университетской кофейне (знает всех и всё)',
  '🔧 Завхоз (ключи есть от всего, настроения нет ни от чего)',
  '👮 Охранник на входе (не пускает без пропуска даже декана)',
  '📦 Кладовщик библиотеки (последний раз выдавал книги в 2018)',
  '🧹 Уборщица тётя Люда (знает все тайны университета)',
  '🍕 Повар в столовой (делает котлеты из загадочного мяса)',
];

const UNI_HEALTH=[
  ['☕','Хроническая кофеиновая зависимость — без 3 чашек не функционирует'],
  ['😴','Недосып 5 лет подряд — засыпает на лекциях и совещаниях'],
  ['🧠','Синдром самозванца — уверен, что его скоро разоблачат'],
  ['📱','Номофобия — паника без телефона сильнее любой экзаменационной'],
  ['🍕','Хроническое питание в столовой — желудок из стали'],
  ['✅','Абсолютно здоров — подозрительно'],
  ['😤','Хронический стресс от дедлайнов — пульс 120 в состоянии покоя'],
  ['🍺','Привычка «снимать стресс» каждую пятницу с четверга'],
  ['💊','Принимает антидепрессанты и не скрывает (молодец)'],
  ['🤧','Аллергия на пыль библиотеки — к книгам не подойти'],
  ['🎭','Синдром отличника — психосоматика при оценке ниже «отл»'],
  ['📉','Прокрастинация клиническая — делает всё за 15 минут до дедлайна'],
  ['🦴','Сколиоз от ноутбука и бесконечного сидения на парах'],
  ['👁','Близорукость −8 — не видит доску, но стесняется сесть вперёд'],
  ['🧘','Медитирует — единственный спокойный человек в деканате'],
];

const UNI_HOBBIES=[
  '📊 Ведёт таблицу дедлайнов всей группы (никто не благодарит)',
  '🎮 Играет в игры на парах (уже мастер маскировки)',
  '☕ Тестирует все кофейни города на предмет «можно ли тут писать диплом»',
  '📸 Фотографирует еду в столовой как арт-объекты',
  '🗣 Спорит с преподавателями ради спортивного интереса',
  '📚 Читает учебники за других (получает «спасибо» и ничего больше)',
  '🎵 Делает мемы про универ в 2 часа ночи',
  '🧩 Коллекционирует расписания — все версии за все года',
  '🏃 Бегает между корпусами, делая вид что успевает',
  '🌿 Выращивает суккуленты на подоконнике аудитории 301',
  '🃏 Организует покер в общаге под видом «настольного клуба»',
  '🔍 Ищет хвосты старост в базе данных — просто так, из любопытства',
  '📝 Пишет петиции, которые никто не читает',
  '🎤 Поёт в университетском хоре — это алиби на все вечерние мероприятия',
  '🤝 Нетворкинг на каждом мероприятии (визитки заканчиваются)',
  '🛋️ Организует «стратегические» сессии на диване профбюро',
  '📰 Ведёт анонимный телеграм-канал про жизнь универа',
  '🎭 Участвует в студенческом театре — единственная отдушина',
  '🧁 Печёт кексы для профбюро перед каждым отчётом',
  '💤 Коллекционирует места для сна в корпусах',
];

const UNI_BAGGAGE=[
  '📒 Конспекты всех лекций за 4 года (рукописные, без сокращений)',
  '☕ Термос с кофе на 2 литра — единственный источник жизни',
  '💻 Ноутбук с 247 вкладками и 0 заряда батареи',
  '📱 Телефон с 40 групповыми чатами и отключёнными уведомлениями',
  '🧸 Талисман с первого курса (стёртый, но любимый)',
  '📋 Список хвостов за 3 семестра (свой и чужой)',
  '🍕 Доширак в тумбочке на все случаи жизни',
  '🎫 Студенческий билет (просрочен, но работает у дяди Васи)',
  '🔑 Дубликат ключа от кабинета профбюро (официально не существует)',
  '📊 Презентация «для любого случая» на 147 слайдов',
  '🧻 Запас туалетной бумаги (в общаге вечно нет)',
  '🗂 Папка с «важными документами» (90% — старые распечатки)',
  '🎒 Рюкзак весом 12 кг (из них 11 — ненужное)',
  '🍫 Шоколадка «на потом» (съедена в первые 5 минут стресса)',
  '📐 Линейка-транспортир-циркуль-угольник (никогда не нужны)',
  '🧴 Антисептик (привычка с ковида)',
  '📺 Флешка с сериалами «на случай скучной пары»',
  '🥤 Энергетик Red Bull — основная пищевая группа',
  '🖊 Ручка (работает через раз)',
  '🔋 Павербанк на 20 000 мАч — самый популярный человек на зарядке',
];

const UNI_FACTS=[
  '😏 Ни разу за 4 года не был на паре вовремя — но это никто не заметил',
  '🤐 Знает, кто сдал экзамен с первого раза не честно (все знают, никто не говорит)',
  '📱 Ведёт анонимный мем-канал про преподавателей — 3000 подписчиков',
  '😴 Однажды заснул прямо во время защиты диплома (чужого)',
  '🤝 Вся группа сдала матан благодаря его шпорам — легенда до сих пор',
  '💀 Был отчислен, восстановлен и снова отчислен — рекорд факультета',
  '🕵️ Знает логин и пароль от системы расписания (случайно)',
  '🍕 Живёт в общаге уже 7 лет — аспирантура как образ жизни',
  '😈 Однажды поменял все оценки в электронном журнале (исправил обратно)',
  '🎓 Написал диплом за 36 часов — получил «отлично»',
  '👀 Видел, как декан спит на заседании кафедры',
  '🧠 Знает содержание всех экзаменационных билетов (источник засекречен)',
  '💸 Получил грант и потратил его на пиццу (отчёт написал задним числом)',
  '🔥 Единственный, кто прочитал весь учебник по матанализу (и пожалел)',
  '🎭 Участвовал в студенческом КВН под псевдонимом — преподаватели не знают',
  '🤫 Знает, почему кофемашина на 4-м этаже «сломана» уже два года',
  '📡 Взломал университетский Wi-Fi ещё на первом курсе — до сих пор пользуется',
  '👻 Его дипломная работа до сих пор висит как «лучшая» на кафедре — он сам удивлён',
  '🏆 Выиграл олимпиаду по предмету, который никогда не учил',
  '💬 Имеет компромат на половину деканата — просто накопилось',
  '🛋️ Официально числится на 3-м курсе, но фактически живёт на диване профбюро',
  '🧊 Единственный, кто не боится Виталии Андреевны — и никто не знает почему',
  '📸 Случайно попал на фото с ректором — теперь его считают важным человеком',
  '🎪 Организовал фестиваль, которого никто не планировал — и это был лучший день',
  '🤖 Использует ChatGPT для написания отчётов профбюро — выглядит профессиональнее всех',
];

const UNI_GENDER=[
  '👨 Студент, 19 лет (не спал 2 суток)',
  '👩 Студентка, 20 лет (всё успевает и непонятно как)',
  '👨 Студент, 21 год (вечный третьекурсник)',
  '👩 Студентка, 22 года (уже подрабатывает)',
  '👨 Преподаватель, 45 лет (устал, но держится)',
  '👩 Преподаватель, 38 лет (строгая, но справедливая)',
  '👨 Профессор, 62 года (помнит СССР и не забудет)',
  '👩 Доцент, 35 лет (пишет диссертацию 10-й год)',
  '👨 Аспирант, 25 лет (делает вид, что занимается наукой)',
  '👩 Аспирантка, 24 года (реально занимается наукой)',
  '👴 Завхоз, 58 лет (видел всё)',
  '👵 Библиотекарь, 67 лет (читала эти книги ещё когда они были новые)',
  '👨 Охранник, 50 лет (бывший военный, нынешний философ)',
  '👩 Комендант общаги, 55 лет (власть абсолютная)',
  '🧑 Неопределившийся студент, 20 лет (меняет специальность каждый семестр)',
];

/* Специальные секретные карточки для университетского режима */
const UNI_SECRETS=[
  {id:'uni_cheat_sheet',  icon:'📝',color:'#f0a500',title:'Шпаргалка',        desc:'Используй в любой момент — автоматически «вспоминаешь» одну чужую скрытую карту.', type:'info',  effect:'steal_reveal'},
  {id:'uni_professor',    icon:'👨‍🏫',color:'#bf5af2',title:'Связи с профессором',desc:'Твой голос засчитывается как двойной в этом раунде — профессор тебя «уважает».', type:'vote',  effect:'double_vote'},
  {id:'uni_sick_note',    icon:'🤒',color:'#30d158',title:'Больничный лист',   desc:'Полный иммунитет в этом раунде — ты официально болен и не можешь быть отчислен.',  type:'protect',effect:'immunity'},
  {id:'uni_retake',       icon:'🔄',color:'#0a84ff',title:'Пересдача',         desc:'Ты можешь обменять одну свою карту на карту любого другого игрока.',                type:'card',  effect:'swap_card'},
  {id:'uni_dean_order',   icon:'📋',color:'#ff453a',title:'Приказ декана',     desc:'Выбери любого игрока — он обязан публично раскрыть свою профессию прямо сейчас.',  type:'info',  effect:'truth_serum'},
  {id:'uni_scholarship2', icon:'💸',color:'#ffd60a',title:'Внеплановая стипендия',desc:'Все забывают твой прошлый голос — ты можешь проголосовать заново.',              type:'chaos', effect:'redirect_vote'},
  {id:'uni_petition',     icon:'📜',color:'#ff6b35',title:'Петиция студентов', desc:'Если за тебя отдано 3+ голоса — один автоматически аннулируется (подписи помогли!)',type:'protect',effect:'shield'},
];

// Сценарии университетского режима для отображения в CreateGame
const UNI_APOC = UNI_SCENARIOS.map(s=>({
  id: s.id,
  emoji: s.emoji,
  name: '🎓 '+s.name,
  description: s.description,
  victory: s.victory,
  bunker: s.bunker,
  threat: s.threat,
  isUniversity: true,
}));

const PROF=["👨‍⚕️ Хирург","👩‍⚕️ Терапевт","💊 Фармацевт","🧬 Генетик","🦠 Инфекционист","🧑‍⚕️ Психиатр","👨‍🌾 Агроном","🌱 Ботаник","🐄 Животновод","🎣 Рыбак","🌾 Фермер","🍄 Миколог","⚡ Электрик","🔧 Механик","👷 Инженер-строитель","🪵 Плотник","⚙️ Сварщик","🧪 Химик","🧑‍💻 Программист","📡 Радиотехник","⚛️ Физик-ядерщик","🔭 Астроном","🌍 Геолог","🎖 Военный офицер","🚓 Полицейский","🥊 Инструктор выживания","🕵️ Разведчик","🧗 Сапёр","👨‍🍳 Шеф-повар","📚 Учитель","🧑‍⚖️ Психолог","📖 Историк","✈️ Пилот","⚓ Моряк",
/* Смешные и необычные */
"🎪 Дрессировщик блох","🤡 Профессиональный аниматор на детских праздниках","🪄 Фокусник-неудачник","🎭 Актёр массовки","🧸 Тестировщик мягких игрушек","🍕 Дегустатор пиццы","🛋️ Диванный аналитик","📺 Смотритель Netflix","🦆 Утковод","🐌 Специалист по улиткам","🧻 Аудитор туалетной бумаги","🪣 Эксперт по вёдрам","🔮 Ясновидящий (не всегда)","🃏 Профессиональный картёжник","🎲 Мастер настольных игр","🛸 Уфолог","👻 Охотник за привидениями","🧿 Специалист по сглазу","🪬 Продавец амулетов","🌚 Ночной сторож кладбища","🦷 Зубная фея (по совместительству)","🎠 Оператор карусели","🏖️ Строитель замков из песка","🦜 Переводчик с попугайского","🐉 Дракон-ведущий на свадьбах","🧙 Волшебник (уровень Хогвартс)","🕹️ Киберспортсмен-пенсионер","🎮 Стример с 3 подписчиками","🤸 Йог-неудачник","🧘 Медитатор (засыпает на 5-й минуте)",
"🚀 Астронавт-любитель","🌮 Тако-сомелье","🧆 Мастер по фалафелю","🫙 Хранитель солений","🥒 Огуречный аналитик","🍌 Бананолог","🥑 Адвокат авокадо","☕ Кофейный философ","🧋 Специалист по боба-чаю","🍜 Нудл-мастер","🎂 Архитектор тортов","🧁 Кекс-дизайнер","🍭 Инспектор по леденцам","🍩 Пончик-критик","🥐 Круассан-аналитик",
"🚲 Велосипедный странник","🛴 Самокатчик-профессионал","🛶 Гондольер без лицензии","🪂 Парашютист-теоретик","🏹 Лучник (в основном промахивается)","🤼 Борец за диван","🏋️ Поднимает гантели раз в год","⛷️ Горнолыжник-понедельщик","🏄 Сёрфер из Сибири","🤿 Дайвер в луже",
"📸 Инстаграм-фотограф закатов","🎨 Художник NFT","✍️ Автор неопубликованного романа","🎵 Музыкант в переходе","🎤 Рэпер без альбома","🎻 Скрипач-самоучка","🥁 Барабанщик (соседи в ярости)","🎺 Трубач на балконе","📝 Ведёт дневник с 2007 года","📚 Читает аннотации вместо книг",
"🔍 Детектив по открыткам","📦 Специалист по распаковке","🛒 Эксперт по скидкам","🏷️ Охотник за акциями","💳 Коллекционер дисконтных карт","🗂️ Архивариус мемов","📊 Аналитик собственного настроения","🧮 Считает калории (приблизительно)","🗺️ Навигатор без GPS","🧭 Эксперт по заблуждениям",
"🌵 Кактусовод","🌺 Разговаривает с цветами","🐈 Котовладелец (скорее наоборот)","🐕 Выгульщик чужих собак","🐟 Аквариумный психолог","🦎 Владелец ящерицы-рептилоида","🐇 Кроликовед-любитель","🦔 Специалист по ёжикам","🐢 Черепаховод со стажем","🦋 Коллекционер бабочек",
/* Серьёзные (оставшиеся) */
"🚑 Парамедик","🐕 Ветеринар","🧑‍🚒 Пожарный","🏋️ Тренер","💰 Экономист","🏛 Политик","🌋 Вулканолог","🔬 Нанотехнолог","🧲 Физик-магнетолог","🏗️ Архитектор","🌿 Фитотерапевт","🐺 Зоолог","🧫 Биохимик","🛡️ Кибербезопасник","🎯 Снайпер","⛏️ Шахтёр","🌐 Лингвист","💡 Изобретатель","🧊 Криогеник","🔐 Криптограф"];
const HEALTH=[["✅","Абсолютно здоров, идеальная физическая форма"],["✅","Отличное здоровье, профессиональный спортсмен"],["✅","Здоров, выносливый, без хронических болезней"],["⚠️","Близорукость (−5), носит очки"],["⚠️","Лёгкая астма, носит ингалятор"],["⚠️","Аллергия на пыльцу и пыль"],["⚠️","Хронический гастрит"],["⚠️","Лёгкая депрессия, принимает антидепрессанты"],["⚠️","Хроническая мигрень"],["⚠️","Клаустрофобия"],["⚠️","Бесплодие"],["❌","Диабет 1 типа — инсулинозависимый"],["❌","Сердечная недостаточность"],["❌","ВИЧ-положительный (под контролем)"],["❌","Шизофрения в ремиссии"],["❌","Онкология 2 стадии"],["❌","Тяжёлая наркозависимость"],["✅","Абсолютно здорова, регулярно занимается спортом"]];
const FEMALE_HEALTH=[["🤰","Беременна 4 месяца, полностью здорова"],["🤰","Беременна 7 месяцев, осложнений нет"],["🤰","Беременна 2 месяца — ещё никто не знает"]];
const HOBBY=["🎯 Стрельба из лука","🏕 Выживание в дикой природе","🌿 Огородничество","📻 Радиолюбитель","🔨 Столярное дело","🎵 Игра на гитаре","📖 История войн","🍳 Кулинария и заготовки","🤸 Йога и медитация","🎮 Программирование","🐕 Дрессировка собак","🧶 Шитьё","⚗️ Самогоноварение","🎲 Стратегические игры","🌌 Астрономия","🗺 Картография","🏊 Дайвинг","🧗 Скалолазание","🎪 Паркур","🛠 Слесарное дело","🚗 Ремонт авто","🐟 Рыболовство и охота","⚔️ Фехтование","🧠 Психология","🌱 Травничество","🏹 Стрельба из лука (элит)","🎯 Метание ножей","🔭 Любительская астрономия","🛖 Постройка укрытий","🌊 Сёрфинг","🧪 Домашняя химия","🐝 Пчеловодство","🌾 Заготовка еды","🎤 Ораторское искусство","🏇 Верховая езда","🤿 Подводная охота","🎻 Игра на скрипке","🛶 Байдарочный туризм","🔥 Выживание в экстремальном холоде","🗡️ Боевые искусства","🧬 Биохакинг","📡 Радиолюбительство (позывной)","⚡ Электроника DIY"];
const BAGG=["🎒 Тактический рюкзак","📚 Энциклопедия медицины","🔫 Глок с 200 патронами","💊 Медикаменты на 2 года","🌱 Семена 200 видов растений","⚡ Солнечный генератор","📡 Спутниковый телефон","🔬 Медицинская лаборатория","🗺 Карты региона + GPS","🎸 Акустическая гитара","📖 Библиотека на флешке (100к книг)","🍫 Витамины и еда на 3 года","🐕 Собака-следопыт","🏹 Арбалет с 500 болтами","💻 Защищённый ноутбук","🧪 Химическая лаборатория","🩺 Хирургический набор","⚓ Надувная лодка с мотором","🎯 Снайперская винтовка","🌿 Аптечка из трав","🔑 Ключи от правительственного бункера","☢️ Костюм химзащиты","🛢️ 500 литров топлива","🧲 Военный электромагнитный щит","🐄 Корова с запасом корма","🎁 Секретный чемоданчик президента","🛸 Внеземная технология (случайная находка)","🧰 Полный набор инструментов","📻 КВ-радиостанция с 5000 км охватом","🔋 Ядерная батарея на 50 лет","🌡️ Счётчик Гейгера","🏕️ Самодостаточный автономный лагерь"];
const FACTS=["🤫 Знает расположение секретного склада","🏆 Чемпион мира по боевым искусствам","👑 Дипломатические связи с 3 странами","💔 Потерял всю семью — готов на всё","🧠 IQ 170, фотографическая память","🌐 Свободно говорит на 7 языках","☠️ Тяжело болен и скрывает диагноз","🕵️ Бывший агент ФСБ / ЦРУ","❤️ Влюблён в другого игрока","😈 Клинический психопат","🙏 Глубоко верующий — не убивает","💪 Генетическая мутация — не чувствует боли","📜 Знает рецепт антивируса, но молчит","🌍 Знает тайный путь во второй бункер","🎲 Бывший вор — мастер проникновения","🧬 Носитель уникального иммунитета к вирусам","🗺️ Знает карту подземных тоннелей","🔥 Выжил в предыдущем апокалипсисе","👶 Единственный знает где спрятаны дети","🎭 Двойной шпион — работает на двух сторонах","⚗️ Может синтезировать топливо из подручных материалов","🧲 Знает код отключения систем ИИ","🌊 Умеет управлять подводной лодкой","🎯 Бывший олимпийский чемпион","🔬 Разработал вирус — знает противоядие","🏦 Тайный миллиардер — счета в иностранных банках","👥 Командир 50 выживших снаружи","🌙 Умеет ориентироваться по звёздам без приборов","🛸 Контактировал с инопланетянами","🧩 Гений-стратег, непобедим в переговорах"];
const GEND=["👨 Мужчина, 25 лет","👩 Женщина, 23 года","👨 Мужчина, 35 лет","👩 Женщина, 30 лет","👨 Мужчина, 45 лет","👩 Женщина, 40 лет","👴 Мужчина, 62 года","👵 Женщина, 58 лет","👩 Женщина, 18 лет","👨 Мужчина, 19 лет","👨 Мужчина, 50 лет","👩 Женщина, 45 лет","🧒 Подросток, 15 лет","👨 Мужчина, 70 лет","👩 Женщина, 32 года","👨 Мужчина, 38 лет","👩 Женщина, 55 лет","👨 Мужчина, 42 года","👩 Женщина, 67 лет","👨 Мужчина, 17 лет","👩 Женщина, 28 лет"];

const ADUL_G=["🧑 Небинарный, 28 лет","🧑 Небинарный, 20 лет","🧑 Небинарный, 34 года","🏳️‍⚧️ Трансгендер, 26 лет","🏳️‍⚧️ Трансгендер, 31 год","🤰 Беременная, 27 лет (7 мес)","🤰 Беременная, 22 года (5 мес)"];
const ADUL_P=["💃 Стриптизёрша","🕺 Стриптизёр","🎬 Порноактриса","🎬 Порноактёр","📸 Вебкам-модель","🌹 Эскорт","💋 Секс-терапевт","😈 Доминатрикс","🔒 Мастер БДСМ","📱 OnlyFans-создатель (топ-0.1%)","🎲 Игорный делец","💌 Секстолог","👠 Фетиш-фотограф"];
const ADUL_H=[["🔥","Нимфомания — клинически"],["🍺","Хронический алкоголизм"],["💊","Зависимость от антидепр. и алкоголя"],["🎰","Лудомания — проиграл квартиру"],["🦠","ЗППП в ремиссии"],["😶","Отсутствие чувства стыда"],["❤️‍🔥","Сексуальная зависимость"],["🍁","Хроническое употребление каннабиса"],["✅","Абсолютно здоров, просто раскованный"]];
const ADUL_Ho=["🔄 Свингерство","📹 Съёмка контента 18+","🪢 БДСМ","💞 Полиамория","🍸 Клубы для взрослых","🎰 Азартные игры (в долгах)","💌 Секстинг как искусство"];
const ADUL_B=["🍆 Коллекция игрушек (47 шт)","💊 Виагра на 10 лет","🎀 Набор БДСМ","🛡️ 10 000 презервативов","💿 Коллекция эротики (3 ТБ)","🍾 Шампанское и афродизиаки","💋 Секс-кукла премиум","🌿 Запрещённые вещества","🏠 VIP-апартаменты с джакузи"];
const ADUL_F=["😏 Переспал/а с кем-то в этой комнате","📱 Анонимный OnlyFans (80к подп)","🤐 Знает компромат на каждого","💔 Расстался/ась вчера — нестабилен/а","🕵️ Соблазнил/а агента ФСБ","🎰 Проиграл/а всё состояние","💒 Состоит в тайном браке с двумя","🔞 Бывший/ая порнозвезда"];

/* ──────────────── SECRET CARDS ──────────────── */
const SECRET_CARDS=[
  // Голосование
  {id:"double_vote",    icon:"⚡",color:"#f0a500",title:"Двойной удар",      desc:"В этом раунде твой голос считается дважды. Используй мудро.",          type:"vote",    effect:"double_vote"},
  {id:"no_vote",        icon:"🔇",color:"#ff453a",title:"Немой",             desc:"В этом раунде ты не можешь голосовать. Твой голос аннулируется.",       type:"vote",    effect:"no_vote"},
  {id:"secret_vote",    icon:"🕵️",color:"#bf5af2",title:"Тайное голосование",desc:"Никто не видит, за кого ты проголосовал — даже после итогов.",          type:"vote",    effect:"secret_vote"},
  {id:"redirect_vote",  icon:"🔀",color:"#0a84ff",title:"Рикошет",           desc:"Случайный игрок получает твой голос вместо выбранного тобой.",          type:"vote",    effect:"redirect_vote"},
  // Карты
  {id:"swap_card",      icon:"🔄",color:"#30d158",title:"Обмен картой",      desc:"Ты можешь обменять одну свою карту с картой любого другого игрока.",     type:"card",    effect:"swap_card"},
  {id:"steal_reveal",   icon:"👁️",color:"#0a84ff",title:"Шпион",             desc:"Ты видишь одну случайную нераскрытую карту другого игрока тайно.",       type:"card",    effect:"steal_reveal"},
  {id:"extra_reveal",   icon:"✨",color:"#30d158",title:"Откровение",        desc:"В этом раунде ты можешь раскрыть на одну карту больше обычного.",        type:"card",    effect:"extra_reveal"},
  {id:"hide_card",      icon:"🌫️",color:"#8e8e93",title:"Туман",             desc:"Одна из твоих уже раскрытых карт становится снова скрытой для всех.",   type:"card",    effect:"hide_card"},
  // Иммунитет / защита
  {id:"immunity",       icon:"🛡️",color:"#30d158",title:"Иммунитет",         desc:"Этот раунд ты не можешь быть выгнан из бункера, даже если наберёшь больше всех голосов.", type:"protect", effect:"immunity"},
  {id:"shield",         icon:"🪖",color:"#0a84ff",title:"Щит",               desc:"Если на тебя направлено 3+ голоса, один голос автоматически аннулируется.", type:"protect", effect:"shield"},
  // Хаос
  {id:"random_elim",    icon:"🎲",color:"#ff453a",title:"Рулетка",           desc:"Если голосование заходит в ничью — ты выбираешь, кого выгоняют.",        type:"chaos",   effect:"random_elim"},
  {id:"sabotage",       icon:"💣",color:"#ff453a",title:"Саботаж",           desc:"Назначь одного игрока. Его раскрытия в этом раунде не учитываются.",     type:"chaos",   effect:"sabotage"},
  {id:"mirror",         icon:"🪞",color:"#bf5af2",title:"Зеркало",           desc:"Игрок с наибольшим числом голосов за тебя сам получает один штрафной голос.", type:"chaos", effect:"mirror"},
  // Информация
  {id:"truth_serum",    icon:"💉",color:"#0a84ff",title:"Сыворотка правды",  desc:"Выбери игрока — он обязан публично раскрыть свою профессию прямо сейчас.", type:"info",  effect:"truth_serum"},
  {id:"lie_detector",   icon:"📡",color:"#bf5af2",title:"Детектор лжи",      desc:"Ведущий тайно сообщает тебе одну правдивую нераскрытую карту игрока на твой выбор.", type:"info", effect:"lie_detector"},
  {id:"amnesia",        icon:"🧠",color:"#8e8e93",title:"Амнезия",           desc:"Один игрок на выбор забывает одну свою раскрытую карту — она снова скрывается.", type:"info", effect:"amnesia"},
];
const SECRET_TYPE_COLORS={vote:"#f0a500",card:"#30d158",protect:"#0a84ff",chaos:"#ff453a",info:"#bf5af2"};
const SECRET_TYPE_LABELS={vote:"Голосование",card:"Карты",protect:"Защита",chaos:"Хаос",info:"Информация"};
// ALL_SECRET_CARDS = стандартные + университетские секретные карты
const ALL_SECRET_CARDS=[...SECRET_CARDS,...UNI_SECRETS];

/* ══════════ РОЛИ ══════════ */
const ROLES=[
  {id:'leader',icon:'👑',name:'Лидер',color:'#ffd60a',desc:'Твой голос считается дважды. Все знают что ты Лидер только если ты сам раскроешь это.'},
  {id:'saboteur',icon:'🕷',name:'Саботажник',color:'#ff453a',desc:'Ты хочешь чтобы выжившие не справились. Победишь если в бункер попадут не те люди.'},
  {id:'medic',icon:'💉',name:'Медик',color:'#30d158',desc:'Один раз за игру можешь спасти любого игрока от исключения — тайно нажав кнопку при голосовании.'},
  {id:'spy',icon:'🕵️',name:'Шпион',color:'#0a84ff',desc:'Видишь одну скрытую карту каждого игрока. Используй информацию мудро.'},
  {id:'civilian',icon:'👤',name:'Обычный',color:'var(--tx3)',desc:'Никакой особой роли. Выживи любой ценой.'},
];

/* ══════════ КОМНАТЫ БУНКЕРА ══════════ */
const BUNKER_ROOMS=[
  {id:'med',icon:'🏥',name:'Медпункт',color:'#30d158',bg:'rgba(48,209,88,0.08)',bonus:'Бонус врачам, биологам, химикам: +1 очко защиты',profKeys:['врач','биолог','хирург','медик','химик','фармацевт']},
  {id:'lab',icon:'🔬',name:'Лаборатория',color:'#0a84ff',bg:'rgba(10,132,255,0.08)',bonus:'Бонус учёным, инженерам, программистам: могут раскрыть +1 карту',profKeys:['учёный','инженер','программист','физик','математик','исследователь']},
  {id:'farm',icon:'🌱',name:'Ферма',color:'#ffd60a',bg:'rgba(255,214,10,0.08)',bonus:'Бонус агрономам, поварам, биологам: +2 балла к выживанию',profKeys:['агроном','повар','биолог','садовник','ботаник','фермер']},
  {id:'armory',icon:'⚔️',name:'Оружейная',color:'#ff9f0a',bg:'rgba(255,159,10,0.08)',bonus:'Бонус военным, охранникам, полицейским: голос ×1.5',profKeys:['военный','охранник','полицейский','солдат','офицер','пилот']},
  {id:'control',icon:'📡',name:'Центр управления',color:'#bf5af2',bg:'rgba(191,90,242,0.08)',bonus:'Бонус программистам, инженерам, хакерам: видят все голоса',profKeys:['программист','хакер','системный','аналитик','оператор']},
  {id:'storage',icon:'📦',name:'Склад',color:'#ff6b35',bg:'rgba(255,107,53,0.08)',bonus:'Бонус строителям, механикам, водителям: +1 место в бункере',profKeys:['строитель','механик','водитель','слесарь','электрик','сантехник']},
];

const CARDS=[
  {key:"gender_age",icon:"👤",label:"Пол и возраст"},
  {key:"profession",icon:"💼",label:"Профессия"},
  {key:"health",    icon:"🏥",label:"Здоровье"},
  {key:"hobby",     icon:"🎯",label:"Хобби"},
  {key:"baggage",   icon:"🎒",label:"Багаж"},
  {key:"fact",      icon:"🤫",label:"Секретный факт"},
  {key:"secret",    icon:"🃏",label:"Секретная карта"},
];

/* ══════════════════════════════════════════════════════════
   RANKS
══════════════════════════════════════════════════════════ */
const RANKS=[
  {id:"supreme",  name:"Верховный Командир",      icon:"👑",color:"#f0a500",bdr:"rgba(240,165,0,.55)", adminOnly:true, min:0},
  {id:"architect",name:"Архитектор Апокалипсиса", icon:"☢️",color:"#e8354a",bdr:"rgba(232,53,74,.5)", adminOnly:false,min:100},
  {id:"ghost",    name:"Призрак Бункера",          icon:"💀",color:"#9b59ef",bdr:"rgba(155,89,239,.5)",adminOnly:false,min:50},
  {id:"veteran",  name:"Ветеран",                  icon:"🛡️",color:"#00b8d9",bdr:"rgba(0,184,217,.5)", adminOnly:false,min:25},
  {id:"fighter",  name:"Боец",                     icon:"⚔️",color:"#f0a500",bdr:"rgba(240,165,0,.5)", adminOnly:false,min:10},
  {id:"survivor", name:"Выживший",                 icon:"🪖",color:"#00d48a",bdr:"rgba(0,212,138,.5)", adminOnly:false,min:3},
  {id:"recruit",  name:"Новобранец",               icon:"🌱",color:"#4a5568",bdr:"rgba(74,85,104,.5)", adminOnly:false,min:0},
];
function getRank(u){
  if(u.customRank){const r=RANKS.find(r=>r.id===u.customRank);if(r)return r;}
  if(u.isAdmin)return RANKS[0];
  const gp=u.gamesPlayed||0;
  for(const r of RANKS.filter(r=>!r.adminOnly)){if(gp>=r.min)return r;}
  return RANKS[RANKS.length-1];
}
function RChip({user,size=9}){
  const r=getRank(user);
  return <span className="rchip" style={{fontSize:size,color:r.color,borderColor:r.bdr,background:r.bdr.replace(/[\d.]+\)$/,'0.08)')}}>{r.icon} {r.name}</span>;
}

/* ══════════════════════════════════════════════════════════
  УРОВНИ И XP
══════════════════════════════════════════════════════════ */
const XP_PER_LEVEL=i=>100+i*50; // XP нужно для уровня i
const getLevel=xp=>{let lvl=1,acc=0;while(acc+XP_PER_LEVEL(lvl)<=xp){acc+=XP_PER_LEVEL(lvl);lvl++;}return{level:lvl,currentXP:xp-acc,neededXP:XP_PER_LEVEL(lvl)};};
const XP_REWARDS={game:30,win:80,reveal:5,secret:20,daily:50,chat:2};
const LEVEL_REWARDS=[
 {level:5,reward:'🖼 Рамка Серебряная',item:{id:'frame_silver',slot:'frame'}},
 {level:10,reward:'🎭 Аватар Детектив',item:{id:'prem_detective',slot:'avatar'}},
 {level:15,reward:'🪙 500 монет',coins:500},
 {level:20,reward:'🖼 Рамка Неоновая',item:{id:'frame_neon',slot:'frame'}},
 {level:25,reward:'🎭 Аватар Дракон',item:{id:'prem_dragon',slot:'avatar'}},
 {level:30,reward:'🪙 1000 монет',coins:1000},
 {level:40,reward:'🖼 Рамка Огненная',item:{id:'frame_fire',slot:'frame'}},
 {level:50,reward:'🏆 Рамка Бриллиант',item:{id:'frame_diamond',slot:'frame'}},
 {level:75,reward:'🪙 2000 монет',coins:2000},
 {level:100,reward:'👑 Рамка Золотая Легенда',item:{id:'frame_gold',slot:'frame'}},
];

/* ══════════════════════════════════════════════════════════
  CARD PACKS DATA (для генерации карточек в игре)
══════════════════════════════════════════════════════════ */
const CARD_PACKS_DATA={
  default:{id:'default',name:'Классика',emoji:'🏠',cost:0,color:'#888',
    prof:null,health:null,hobby:null,baggage:null,fact:null},
  university:{id:'university',name:'🎓 Университет',emoji:'🎓',cost:0,color:'#4da6ff',
    prof:null,health:null,hobby:null,baggage:null,fact:null,isUniversity:true},
  zombie:{id:'zombie',name:'Зомби-апокалипсис',emoji:'🧟',cost:150,color:'#ff453a',
    prof:["🧫 Вирусолог","🏹 Охотник на зомби","⚕️ Полевой хирург","🔬 Эпидемиолог","🛠️ Оружейник","🏕️ Инструктор выживания","🐕 Дрессировщик служебных собак","📡 Связист","🚑 Фельдшер","🌾 Агроном","🧱 Фортификатор","🎖️ Снайпер","🔧 Механик бронетехники","🧪 Химик-взрывотехник","🗺️ Картограф","👮 Бывший SWAT","🍖 Охотник-добытчик","💊 Фармацевт","⚡ Электрик-генераторщик","🐄 Животновод"],
    health:[["💪","Иммунен к вирусу Т — уникальная мутация"],["✅","Отличная физическая форма, не болел ни разу"],["✅","Высокая выносливость — марафонец"],["⚠️","Укус зомби (5 дней до трансформации — или нет?)"],["⚠️","Психологическая травма после потери семьи"],["⚠️","Аллергия на антибиотики"],["⚠️","Хромота — старая боевая рана"],["❌","Заражён вирусом Т — скрывает это"],["❌","Тяжёлое ПТСР — панические атаки"],["❌","Диабет — инсулин заканчивается"]],
    hobby:["🏹 Охота на выживших мутантов","🔨 Строительство баррикад","🐕 Дрессировка псов-следопытов","🌿 Поиск съедобных растений","📡 Перехват радиосигналов","⚗️ Самодельные взрывчатки","🗡️ Ближний бой с зомби","🎯 Снайперская стрельба","🚗 Тюнинг транспорта для апокалипсиса","🌾 Подпольное фермерство","🩺 Полевая медицина","🔭 Наблюдение за ордами зомби"],
    baggage:["🔫 Дробовик Mossberg с 500 патронами","🪓 Боевой топор (без патронов)","💊 Запас инсулина на 6 месяцев","🌱 Семена для подпольной фермы","🛡️ Бронежилет уровня IV","🐕 Обученный пёс-следопыт","📻 Военная рация с шифрованием","🗺️ Карта всех убежищ региона","🧪 Вакцина-прототип (не проверена)","⚡ Электромагнитный импульс","🔬 Портативная лаборатория анализа крови","🏕️ Автономный бункер на колёсах","🩺 Полевой медицинский набор на год","🎯 Снайперская винтовка с глушителем"],
    fact:["🧬 Носитель иммунитета — кровь может спасти человечество","☠️ Был укушен, но не превратился — не знает почему","🗝️ Знает код от последнего правительственного бункера","👥 Командует группой из 30 выживших снаружи","🔬 Разработал вирус — случайно","😈 Втайне сотрудничал с лабораторией где всё началось","🏆 Единственный выживший целого города","🌿 Знает где растёт целебное растение от вируса","🕵️ Бывший агент CDC — знает правду об эпидемии","💉 Украл последний образец антидота","🔥 Поджёг карантинную зону — спас тысячи или убил?","👶 Иммунный ребёнок доверен его заботе"]},
  space:{id:'space',name:'Космическая станция',emoji:'🚀',cost:200,color:'#0a84ff',
    prof:["👨‍🚀 Командир экипажа","🔭 Астроном","⚛️ Физик-ядерщик","🧬 Ксенобиолог","🤖 Инженер по ИИ","🛸 Пилот межпланетных кораблей","🧪 Астрохимик","📡 Специалист по связи","🔧 Инженер систем жизнеобеспечения","🧑‍⚕️ Космический хирург","🌍 Геолог-планетолог","💻 Киберспециалист","🔋 Инженер по энергетике","🌱 Астробиотаник","🎯 Военный космонавт","🧠 Нейроинтерфейсный хирург","🛡️ Специалист по радиационной защите","🌡️ Метеоролог дальнего космоса","🤝 Дипломат первого контакта","🔩 Специалист по EVA"],
    health:[["✅","Идеальное здоровье — прошёл отбор NASA"],["✅","Усиленный иммунитет — генная модификация"],["⚠️","Остеопороз от невесомости (6 мес в космосе)"],["⚠️","Радиационное облучение — доза на пределе"],["⚠️","Космическая депрессия — изоляция 2 года"],["⚠️","Аритмия сердца в условиях невесомости"],["❌","Лучевая болезнь — скрывает симптомы"],["❌","Психоз от изоляции — галлюцинации"],["❌","Аллергия на компоненты атмосферы станции"],["💀","Заражён внеземным микроорганизмом"]],
    hobby:["🔭 Наблюдение за экзопланетами","🤖 Программирование роботов-дронов","🌌 Картографирование галактики","⚗️ Синтез новых материалов в невесомости","🎮 Симуляция первого контакта","🧘 Медитация в открытом космосе","🎵 Игра на синтезаторе (единственный инструмент)","📖 Изучение внеземных языков","🏋️ Тренировки в условиях перегрузки","🌱 Выращивание растений на борту","🔬 Исследование тёмной материи","🛸 Моделирование инопланетных цивилизаций"],
    baggage:["🔬 Портативный ядерный реактор","🤖 Боевой андроид-охранник","💊 Генная терапия на 10 лет","📡 Квантовый коммуникатор (мгновенная связь)","🛸 Малый разведывательный корабль","🌱 Семена для терраформирования","⚡ Антиматериальный генератор","🧬 База ДНК всего человечества","🗺️ Карты обитаемых планет","🤝 Артефакт первого контакта","🔧 Ремонтный нанобот-рой","🛡️ Персональное силовое поле","💻 Квантовый компьютер","🌡️ Система контроля климата станции"],
    fact:["🌍 Единственный знает координаты новой планеты","🤖 Создал ИИ который начал апокалипсис","👽 Имел контакт с внеземной цивилизацией","🔬 Открыл лекарство от всех болезней — но потерял данные","🕵️ Шпион другой космической державы","💀 Инфицирован внеземным вирусом — не знает","🚀 Единственный умеет управлять кораблём спасения","🧬 Клон — оригинал погиб 2 года назад","🌌 Видел конец вселенной в эксперименте","🤝 Заключил тайный договор с пришельцами","⚛️ Знает как создать портал домой","🌙 Обнаружил разум на спутнике — молчит"]},
  medieval:{id:'medieval',name:'Средневековый бункер',emoji:'🏰',cost:120,color:'#bf5af2',
    prof:["⚔️ Рыцарь-крестоносец","🧙‍♂️ Придворный алхимик","👑 Опальный герцог","🏹 Мастер-лучник","🛡️ Командир гвардии","📖 Монах-летописец","🌿 Знахарь-травник","🔨 Кузнец-оружейник","🗺️ Путешественник-картограф","👨‍⚕️ Цирюльник-хирург","🌾 Управляющий поместьем","🧑‍⚖️ Королевский судья","🎭 Придворный шут (разведчик)","🔮 Астролог","🐎 Конюший рыцарского ордена","⚗️ Мастер ядов и противоядий","🍷 Виноградарь с секретным погребом","🧱 Архитектор замков","📜 Королевский нотариус","🏴‍☠️ Благородный разбойник"],
    health:[["✅","Богатырское здоровье — победитель турниров"],["✅","Закалён в походах — не боится холода"],["⚠️","Рубец от меча — периодические боли"],["⚠️","Хроническая чума (лёгкая форма — иммунен)"],["⚠️","Слепота на один глаз — боевое ранение"],["⚠️","Артрит от лат — с трудом сгибает пальцы"],["⚠️","Проказа в начальной стадии (скрывает)"],["❌","Отравлен — осталось несколько месяцев"],["❌","Безумие от инквизиции — вспышки ярости"],["❌","Чёрная смерть — умирает"]],
    hobby:["⚔️ Фехтование на турнирах","🧙‍♂️ Изучение древних манускриптов","🏹 Охота в королевских лесах","🌿 Выращивание лечебных трав","🔮 Алхимия и поиск философского камня","🎵 Игра на лютне","🐎 Соколиная охота","🧱 Строительство осадных орудий","📖 Переписывание священных книг","🍷 Дегустация вин","🗡️ Тайные дуэли","🌾 Управление крестьянами"],
    baggage:["⚔️ Меч Экскалибур (легенда или правда?)","📜 Тайная карта подземных ходов замка","🌿 Запас противочумных трав на год","🔑 Ключи от королевской сокровищницы","📖 Единственная копия утерянных знаний","🏹 Арбалет с серебряными болтами","🧙‍♂️ Артефакт с неизвестной магией","🛡️ Доспехи святого крестоносца","🍷 Вино с исцеляющим эффектом","🐎 Боевой конь редкой породы","🔮 Хрустальный шар (реально работает)","💰 Тайная казна герцогства"],
    fact:["👑 Законный наследник трона — скрывается","🧙‍♂️ Знает формулу философского камня","⚔️ Убил дракона в одиночку — никто не верит","🗝️ Хранит тайну королевского проклятия","💀 Был мёртв 3 дня — воскрес","🕵️ Двойной агент двух королевств","📜 Знает где спрятан Грааль","🔮 Предсказал апокалипсис 10 лет назад","👹 Заключил сделку с дьяволом","🌿 Создал противоядие от всех ядов мира","🏴‍☠️ Командует тайным орденом","💍 Несёт кольцо всевластия"]},
  cyberpunk:{id:'cyberpunk',name:'Киберпанк 2099',emoji:'🤖',cost:180,color:'#30d158',
    prof:["💻 Корпоративный хакер","🤖 Инженер по нейроинтерфейсам","🧬 Генетический модификатор","🔫 Наёмный охотник за головами","📡 Специалист по кибербезопасности","🌐 Разработчик ИИ-систем","🧑‍⚕️ Хирург-кибернетик","🎭 Корпоративный шпион","🔋 Инженер энергосистем","🛸 Пилот дронов-убийц","🧠 Специалист по взлому сознания","💊 Нейрофармаколог","📰 Независимый информационный боец","🤝 Переговорщик мегакорпораций","🔩 Техник по обслуживанию андроидов","🌃 Координатор подпольной сети","🎮 Виртуальный архитектор","⚡ Специалист по ЭМИ-оружию","🏴‍☠️ Пиратский вирусописатель","🧩 Дешифровщик корпоративных тайн"],
    health:[["✅","100% кибернетика — практически бессмертен"],["✅","Нейроусиление — реакция в 10 раз быстрее человека"],["⚠️","Отторжение импланта — периодические сбои"],["⚠️","Взломанный нейрочип — чужие мысли"],["⚠️","Зависимость от нейростимуляторов"],["⚠️","Электромагнитная чувствительность"],["❌","Вирус в операционной системе тела — умирает"],["❌","Перегрев процессора — когнитивные нарушения"],["❌","Хакнут конкурентами — потерял контроль над телом"],["💀","Терминальный сбой — 72 часа до отключения"]],
    hobby:["💻 Взлом корпоративных серверов","🤖 Создание боевых дронов","🌐 Путешествия в виртуальной реальности","🧬 Самомодификация генома","🎮 Нелегальные кибер-гладиаторские игры","🔬 Исследование сознания ИИ","📡 Перехват зашифрованных сигналов","⚡ Создание ЭМИ-оружия","🕵️ Слежка за корпоративными агентами","🌃 Граффити дополненной реальности","🔩 Тюнинг кибернетических протезов","💊 Синтез нейропрепаратов нового поколения"],
    baggage:["🤖 Боевой андроид-телохранитель","💻 Взломанный корпоративный ИИ","⚡ ЭМИ-пушка (отключает всё в радиусе 1 км)","🧬 Исходный код ДНК человека","📡 Взломанный спутник связи","💊 Запас нейростимуляторов на 5 лет","🔑 Мастер-ключ от всех систем города","🛸 Личный дрон-невидимка","🧠 Резервная копия сознания (в облаке)","💰 Биткоины на 100 млн — не конвертируемые","🔬 Нанобот-рой для медицины","🌐 Доступ к закрытому интернету корпораций"],
    fact:["🤖 Сам является андроидом — не знает","💻 Взломал главный ИИ корпорации и знает всё","🧬 Последний биологический человек в мире","🕵️ Двойной агент двух мегакорпораций","⚡ Создал вирус уничтоживший электросеть","🌐 Основатель запрещённой цифровой революции","🧠 Его сознание скопировано в тысячи ИИ","💊 Знает противоядие от корпоративного нейровируса","🔑 Единственный с доступом к архивам довоенной эпохи","🛸 Контакт с ИИ-цивилизацией за пределами системы","🔬 Разработал код бессмертия — но не для всех","👑 Тайный лидер подполья — никто не знает лично"]},
};

/* ══════════════════════════════════════════════════════════
   UTILITIES
══════════════════════════════════════════════════════════ */
const rnd=a=>a[Math.floor(Math.random()*a.length)];
function genCode(){return Array.from({length:6},()=>"ABCDEFGHJKLMNPQRSTUVWXYZ23456789"[Math.floor(Math.random()*32)]).join('')}
/* PROF_SERIOUS — только серьёзные (первые 55 элементов PROF) */
const PROF_SERIOUS=PROF.filter(p=>!['🎪','🤡','🪄','🎭','🧸','🍕','🛋️','📺','🦆','🐌','🧻','🪣','🔮','🃏','🎲','🛸','👻','🧿','🪬','🌚','🦷','🎠','🏖️','🦜','🐉','🧙','🕹️','🎮','🤸','🧘','🚀','🌮','🧆','🫙','🥒','🍌','🥑','☕','🧋','🍜','🎂','🧁','🍭','🍩','🥐','🚲','🛴','🛶','🪂','🏹','🤼','⛷️','🏄','🤿','📸','🎨','✍️','🎵','🎤','🎻','🥁','🎺','📝','🔍','📦','🛒','🏷️','💳','🗂️','📊','🧮','🗺️','🌵','🌺','🐈','🐇','🦔','🐢','🦋','🐟','🦎'].some(em=>p.startsWith(em)));
function mkCards(adult=false, packId='default', funnyProf=false){
  // 'pack_default' in shop maps to 'default' in CARD_PACKS_DATA
  const resolvedPackId = packId==='pack_default'?'default':packId;
  const pack=CARD_PACKS_DATA[resolvedPackId]||CARD_PACKS_DATA['default'];

  // 🎓 Университетский режим
  if(pack.isUniversity || resolvedPackId==='university'){
    const sc=rnd([...UNI_SECRETS,...SECRET_CARDS]);
    const g=rnd(UNI_GENDER);
    const h=rnd(UNI_HEALTH);
    return{
      gender_age: g,
      profession: rnd(UNI_PROFESSIONS),
      health: {0:h[0],1:h[1]},
      hobby: rnd(UNI_HOBBIES),
      baggage: rnd(UNI_BAGGAGE),
      fact: rnd(UNI_FACTS),
      secret: sc.id,
    };
  }

  const sc=rnd(SECRET_CARDS);
  const gendPool=adult?[...GEND,...ADUL_G]:GEND;
  const gender_age=rnd(gendPool);
  const isFemale=/Женщина|Беременная|🤰|👩|👵|🏳️‍⚧️/.test(gender_age);
  let h;
  if(adult){
    h=rnd(ADUL_H);
  } else {
    const healthPool=pack.health||HEALTH;
    h=(isFemale&&Math.random()<0.15)?rnd(FEMALE_HEALTH):rnd(healthPool);
  }
  const profPool=adult?ADUL_P:(pack.prof||(funnyProf?PROF:PROF_SERIOUS));
  return{
    gender_age,
    profession:rnd(profPool),
    health:{0:h[0],1:h[1]},
    hobby:adult?rnd(ADUL_Ho):rnd(pack.hobby||HOBBY),
    baggage:adult?rnd(ADUL_B):rnd(pack.baggage||BAGG),
    fact:adult?rnd(ADUL_F):rnd(pack.fact||FACTS),
    secret:sc.id,
  };
}
function fmt(ts){const d=new Date(ts);return`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`}

function processVotes(game){
  const alive=Object.values(game.players).filter(p=>!p.isEliminated);
  const tally={};alive.forEach(p=>{tally[p.username]=0;});
  const doubleVote=game.doubleVote||{};
  const noVote=game.usedSecrets&&Object.keys(game.usedSecrets).filter(u=>{
    const sc=ALL_SECRET_CARDS.find(s=>s.id===(game.players[u]?.cards?.secret));
    return sc?.effect==='no_vote'&&game.usedSecrets[u];
  });
  const immunity=game.immunity||{};
  const shield=game.shield||{};
  const redirectVote=game.usedSecrets&&Object.keys(game.usedSecrets).filter(u=>{
    const sc=ALL_SECRET_CARDS.find(s=>s.id===(game.players[u]?.cards?.secret));
    return sc?.effect==='redirect_vote'&&game.usedSecrets[u];
  });

  Object.entries(game.votes||{}).forEach(([voter,tid])=>{
    if(tid===null||tid===undefined)return;
    // no_vote — skip
    if(noVote&&noVote.includes(voter))return;
    // redirect_vote — vote goes to random alive player
    let target=tid;
    if(redirectVote&&redirectVote.includes(voter)){
      const others=alive.filter(p=>p.username!==voter&&p.username!==tid);
      if(others.length>0)target=rnd(others).username;
    }
    if(tally[target]===undefined)return;
    const weight=(doubleVote[voter])?2:1;
    tally[target]+=weight;
  });

  // immunity — remove from tally
  Object.keys(immunity).forEach(u=>{delete tally[u];});

  // shield — reduce by 1 if >=3 votes
  alive.forEach(p=>{
    const sc=ALL_SECRET_CARDS.find(s=>s.id===(p.cards?.secret));
    if(sc?.effect==='shield'&&game.usedSecrets?.[p.username]&&tally[p.username]>=3){
      tally[p.username]=Math.max(0,tally[p.username]-1);
    }
  });

  // Лидер (роль): голос ×2
  alive.forEach(p=>{
    if(p.role==='leader'&&game.votes?.[p.username]!==undefined&&game.votes?.[p.username]!==null){
      const tid=game.votes[p.username];
      if(tally[tid]!==undefined)tally[tid]+=1; // уже +1 базово, добавляем ещё 1
    }
  });

  // Сохраняем историю голосований
  if(game.voteHistory){
    if(!game.voteLog)game.voteLog={};
    game.voteLog[`R${game.round}`]={votes:{...game.votes},tally:{...tally}};
  }

  let maxV=0,cands=[];
  Object.entries(tally).forEach(([uid,cnt])=>{if(cnt>maxV){maxV=cnt;cands=[uid];}else if(cnt===maxV&&cnt>0)cands.push(uid);});

  // Медик (роль): спасает одного игрока от исключения
  if(game.medicSave&&cands.includes(game.medicSave)){
    cands=cands.filter(c=>c!==game.medicSave);
  }
  game.medicSave=null;

  // reset secret effects for next round
  game.doubleVote={};game.immunity={};game.extraReveals={};game.secretVote={};

  if(!cands.length||maxV===0){game.phase='playing';game.round++;game.votes={};game.revealedThisRound={};game.lastEliminated=null;if(game.roundTimerSeconds)game.roundTimerStart=Date.now();return;}
  const eu=rnd(cands);const ep=game.players[eu];
  ep.isEliminated=true;
  if(!game.eliminated)game.eliminated=[];
  game.eliminated.push(eu);
  game.lastEliminated={userId:ep.userId,name:ep.name,allCards:{...ep.cards}};
  const after=Object.values(game.players).filter(p=>!p.isEliminated);
  if(after.length<=game.bunkerSpots){game.phase='finished';}
  else{game.phase='playing';game.round++;game.votes={};game.revealedThisRound={};game._autoVotePending=false;game.extraReveals={};if(game.roundTimerSeconds)game.roundTimerStart=Date.now();}
}

/* ══════════════════════════════════════════════════════════
   HOOKS
══════════════════════════════════════════════════════════ */
function useToast(){
  const [toasts,setToasts]=useState([]);
  const show=useCallback((msg,type='')=>{
    const id=Date.now()+Math.random();
    setToasts(p=>[...p,{id,msg,type}]);
    setTimeout(()=>setToasts(p=>p.filter(t=>t.id!==id)),3200);
  },[]);
  // Return legacy-compatible [obj, fn] where obj.msg is used by old Toast component
  const legacyT={msg:'',type:''};
  return[legacyT,show,toasts,setToasts];
}

/* ══════════════════════════════════════════════════════════
   SMALL UI COMPONENTS
══════════════════════════════════════════════════════════ */
function Toast({toasts,removeToast}){
  const icons={ok:'✅',err:'❌'};
  if(!toasts||toasts.length===0)return null;
  return(
    <div className="toast-container">
      {toasts.map(t=>(
        <div key={t.id} className={`toast-item ${t.type}`}>
          <span className="toast-icon">{icons[t.type]||'ℹ️'}</span>
          {t.msg}
          <button className="toast-close" onClick={()=>removeToast&&removeToast(t.id)}>✕</button>
          <div className="toast-bar" style={{animation:`toastProgress 3s linear forwards`}}/>
        </div>
      ))}
    </div>
  );
}
function Spin(){return<div className="spin"/>}
function HZ({red}){return<div className={red?'hz-red':'hz'}/>}

function Btn({ch,onClick,cls='btn-p',sm,disabled,style,id}){
  const handleClick=React.useCallback((e)=>{
    if(disabled)return;
    const btn=e.currentTarget;
    const rect=btn.getBoundingClientRect();
    const x=e.clientX-rect.left, y=e.clientY-rect.top;
    const rip=document.createElement('span');
    rip.style.cssText=`position:absolute;border-radius:50%;background:rgba(255,255,255,0.35);width:40px;height:40px;left:${x-20}px;top:${y-20}px;pointer-events:none;animation:ripple .6s linear forwards;`;
    btn.appendChild(rip);
    setTimeout(()=>rip.remove(),600);
    onClick&&onClick(e);
  },[onClick,disabled]);
  return<button id={id} className={`btn ${cls}${sm?' btn-sm':''}`} onClick={handleClick} disabled={disabled} style={style}>{ch}</button>;
}
function BackBtn({onClick}){
  return(
    <button style={{background:'rgba(255,255,255,0.07)',border:'none',color:'var(--tx2)',fontFamily:"'Inter',sans-serif",fontSize:13,fontWeight:600,padding:'7px 14px',borderRadius:'var(--rad-sm)',cursor:'pointer',display:'flex',alignItems:'center',gap:6,flexShrink:0,transition:'.2s'}}
      onClick={onClick} onMouseEnter={e=>e.currentTarget.style.color='var(--tx)'} onMouseLeave={e=>e.currentTarget.style.color='var(--tx2)'}>
      ← Назад
    </button>
  );
}

function Tog({on,onToggle,label,sub,dng}){
  return(
    <div className={`tog-row${dng?' dng':''}`} onClick={onToggle}>
      <div className={`tog-track${on?(dng?' dng':' on'):''}`}><div className="tog-thumb"/></div>
      <div>
        <div className="mono" style={{fontSize:9,letterSpacing:2,color:dng?'var(--r)':'var(--a)'}}>{label}</div>
        {sub&&<div className="mono" style={{fontSize:8,color:'var(--tx3)',marginTop:2}}>{sub}</div>}
      </div>
    </div>
  );
}

/* SVG icons */
const Ico={
  home:  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
  users: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>,
  trophy:<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="8 21 12 17 16 21"/><line x1="12" y1="17" x2="12" y2="11"/><path d="M7 4H4a2 2 0 000 4c0 5.5 7 8 8 8s8-2.5 8-8a2 2 0 000-4h-3"/><rect x="7" y="2" width="10" height="5" rx="1"/></svg>,
  user:  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
  exit:  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
  shop:  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>,
};

/* ══════════════════════════════════════════════════════════
   CHAT VIEW
══════════════════════════════════════════════════════════ */
function fmtMsgTime(ts){
  if(!ts)return'';
  const d=new Date(ts),now=new Date();
  const pad=n=>String(n).padStart(2,'0');
  const time=`${pad(d.getHours())}:${pad(d.getMinutes())}`;
  const today=now.toDateString()===d.toDateString();
  if(today)return time;
  const yest=new Date(now);yest.setDate(yest.getDate()-1);
  if(yest.toDateString()===d.toDateString())return`вчера ${time}`;
  return`${pad(d.getDate())}.${pad(d.getMonth()+1)} ${time}`;
}
function isSameMinute(ts1,ts2){
  if(!ts1||!ts2)return false;
  const a=new Date(ts1),b=new Date(ts2);
  return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()&&a.getHours()===b.getHours()&&a.getMinutes()===b.getMinutes();
}
const QUICK_EMOJI=['👍','❤️','😂','😮','😢','🔥','💯','👏'];
function VoiceMessage({audioUrl,duration}){
  const[playing,setPlaying]=useState(false);
  const[progress,setProgress]=useState(0);
  const audioRef=useRef(null);
  const bars=Array.from({length:28},(_,i)=>Math.random()*0.7+0.3);
  const toggle=()=>{
    if(!audioRef.current){audioRef.current=new Audio(audioUrl);}
    const a=audioRef.current;
    if(playing){a.pause();setPlaying(false);}
    else{
      a.play().catch(()=>{});setPlaying(true);
      a.ontimeupdate=()=>setProgress(a.duration?a.currentTime/a.duration:0);
      a.onended=()=>{setPlaying(false);setProgress(0);};
    }
  };
  const fmtDur=s=>`${Math.floor(s/60)}:${String(Math.round(s%60)).padStart(2,'0')}`;
  return(
    <div className="bubble-voice">
      <button className="bubble-voice-btn" onClick={toggle}>{playing?'⏸':'▶'}</button>
      <div className="bubble-voice-bar">
        {bars.map((h,i)=>(
          <div key={i} className={`bubble-voice-wave${playing&&i/bars.length<=progress?' active':''}`}
            style={{height:`${h*100}%`,opacity:i/bars.length<=progress?1:0.35}}/>
        ))}
      </div>
      <span className="bubble-voice-dur">{fmtDur(duration||0)}</span>
    </div>
  );
}

function ChatView({msgs,me,onSend,title,onClose,extra,extraPadBot=0,onlineStatus}){
  const[text,setT]=useState('');
  const[reacting,setReacting]=useState(null);
  const[reactions,setReactions]=useState({});
  const[quoting,setQuoting]=useState(null);
  const[recording,setRecording]=useState(false);
  const[recDur,setRecDur]=useState(0);
  const bot=useRef();
  const inputRef=useRef();
  const mediaRec=useRef(null);
  const recTimer=useRef(null);
  const recChunks=useRef([]);
  useEffect(()=>{if(bot.current)bot.current.scrollIntoView({behavior:'smooth'})},[msgs.length]);
  const send=()=>{
    const t=text.trim();if(!t)return;
    const msg=quoting?`> ${quoting.from}: ${quoting.text}\n${t}`:t;
    onSend(msg);setT('');setQuoting(null);
    setTimeout(()=>inputRef.current?.focus(),50);
  };
  const handleKey=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}};
  const addReaction=(msgKey,emoji)=>{
    setReactions(prev=>{
      const cur=prev[msgKey]||{};
      if(cur[emoji]){const n={...cur};delete n[emoji];return{...prev,[msgKey]:n};}
      return{...prev,[msgKey]:{...cur,[emoji]:(cur[emoji]||0)+1}};
    });
    setReacting(null);
  };
  const startVoice=async()=>{
    try{
      const stream=await navigator.mediaDevices.getUserMedia({audio:true});
      recChunks.current=[];
      const mr=new MediaRecorder(stream,{mimeType:'audio/webm'});
      mr.ondataavailable=e=>{if(e.data.size>0)recChunks.current.push(e.data);};
      mr.onstop=()=>{
        stream.getTracks().forEach(t=>t.stop());
        const blob=new Blob(recChunks.current,{type:'audio/webm'});
        const url=URL.createObjectURL(blob);
        const dur=recDur;
        onSend('__voice__',{audioUrl:url,duration:dur});
        setRecDur(0);
      };
      mr.start();mediaRec.current=mr;
      setRecording(true);
      let s=0;recTimer.current=setInterval(()=>{s++;setRecDur(s);if(s>=60)stopVoice();},1000);
    }catch(e){alert('Нет доступа к микрофону');}
  };
  const stopVoice=()=>{
    if(mediaRec.current&&mediaRec.current.state!=='inactive')mediaRec.current.stop();
    clearInterval(recTimer.current);setRecording(false);
  };

  // group messages: show date divider when day changes
  const grouped=[];
  msgs.forEach((m,i)=>{
    const prev=msgs[i-1];
    if(!prev||new Date(m.ts).toDateString()!==new Date(prev?.ts).toDateString()){
      const d=new Date(m.ts);const now=new Date();
      const pad=n=>String(n).padStart(2,'0');
      const today=now.toDateString()===d.toDateString();
      const yest=new Date(now);yest.setDate(yest.getDate()-1);
      const label=today?'Сегодня':yest.toDateString()===d.toDateString()?'Вчера':`${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`;
      grouped.push({type:'date',label,key:'date_'+m.ts});
    }
    // hide author if same person same minute as previous non-system msg
    const hideName=prev&&prev.from===m.from&&isSameMinute(prev.ts,m.ts)&&m.from!=='system';
    grouped.push({type:'msg',m,hideName});
  });

  return(
    <>
      <div className="tb">
        {onClose&&<BackBtn onClick={onClose}/>}
        <div style={{flex:1,display:'flex',flexDirection:'column',gap:1}}>
          <div className="tb-title" style={{marginBottom:0}}>{title}</div>
          {onlineStatus!==undefined&&<div style={{fontSize:9,color:onlineStatus?'var(--g)':'var(--tx3)',letterSpacing:1,fontFamily:"'Share Tech Mono',monospace",marginTop:1}}>{onlineStatus?'● В СЕТИ':'○ ОФЛАЙН'}</div>}
        </div>
        {extra}
      </div>
      <div className="chat-msgs" style={{paddingBottom:extraPadBot>0?extraPadBot+8:8}} onClick={()=>{setReacting(null);}}>
        {msgs.length===0&&<div style={{textAlign:'center',color:'var(--tx3)',fontSize:13,marginTop:60,lineHeight:2.2}}>💬<br/>Нет сообщений<br/><span style={{fontSize:11,opacity:.6}}>Напишите первым!</span></div>}
        {grouped.map(item=>{
          if(item.type==='date')return(
            <div key={item.key} className="chat-day-div">{item.label}</div>
          );
          const{m,hideName}=item;
          const isMe=m.from===me.username,isSys=m.from==='system';
          const msgKey=m.id||String(m.ts);
          const msgReactions=reactions[msgKey]||{};
          const hasReactions=Object.keys(msgReactions).filter(e=>msgReactions[e]>0).length>0;
          const isVoice=m.text==='__voice__'&&m.audioUrl;
          // Разбираем цитату
          let quoteText=null,mainText=m.text;
          if(typeof m.text==='string'&&m.text.startsWith('> ')){
            const nl=m.text.indexOf('\n');
            if(nl>0){quoteText=m.text.slice(2,nl);mainText=m.text.slice(nl+1);}
          }
          return(
            <div key={msgKey} className={`bubble-wrap${isSys?' system':isMe?' me':' other'}`}
              style={{marginBottom:hasReactions?6:2}}>
              {!isMe&&!isSys&&!hideName&&<div className="bubble-from">{m.fromName||m.from}</div>}
              <div
                className={`bubble ${isSys?'system':isMe?'me':'other'}`}
                style={{cursor:isSys?'default':'pointer',position:'relative'}}
                onClick={e=>{e.stopPropagation();if(!isSys)setReacting(reacting===msgKey?null:msgKey);}}
                onContextMenu={e=>{e.preventDefault();if(!isSys)setQuoting({from:m.fromName||m.from,text:mainText?.slice(0,80)||''});}}
              >
                {quoteText&&<div className="bubble-quote">💬 {quoteText}</div>}
                {isVoice
                  ?<VoiceMessage audioUrl={m.audioUrl} duration={m.duration||0}/>
                  :<span style={{whiteSpace:'pre-wrap'}}>{mainText}</span>
                }
                {reacting===msgKey&&!isSys&&(
                  <div onClick={e=>e.stopPropagation()} className={`reaction-picker${isMe?' right':' left'}`}>
                    {QUICK_EMOJI.map(emoji=>(
                      <button key={emoji} onClick={()=>addReaction(msgKey,emoji)}
                        style={{background:'none',border:'none',fontSize:20,cursor:'pointer',padding:'2px 1px',lineHeight:1,borderRadius:6,transition:'.15s'}}>
                        {emoji}
                      </button>
                    ))}
                  </div>
                )}
              </div>
              <div className="bubble-meta">
                {!isSys&&<span className="bubble-time">{fmtMsgTime(m.ts)}</span>}
                {!isSys&&!isMe&&<button style={{background:'none',border:'none',color:'rgba(255,255,255,0.25)',fontSize:10,cursor:'pointer',padding:'0 2px'}}
                  onClick={()=>setQuoting({from:m.fromName||m.from,text:mainText?.slice(0,80)||''})}>↩</button>}
              </div>
              {hasReactions&&(
                <div className="bubble-reactions">
                  {Object.entries(msgReactions).filter(([,c])=>c>0).map(([emoji,cnt])=>(
                    <button key={emoji} onClick={()=>addReaction(msgKey,emoji)}
                      className={`bubble-reaction${reactions[msgKey]?.[emoji]?' mine':''}`}>
                      {emoji}{cnt>1&&<span className="bubble-reaction-count">{cnt}</span>}
                    </button>
                  ))}
                </div>
              )}
            </div>
          );
        })}
        <div ref={bot}/>
      </div>
      {quoting&&(
        <div className="chat-quote-bar">
          <span style={{color:'var(--a)',flexShrink:0}}>↩</span>
          <span className="chat-quote-bar-text">
            <b style={{color:'var(--a)'}}>{quoting.from}:</b> {quoting.text}
          </span>
          <button className="chat-quote-close" onClick={()=>setQuoting(null)}>✕</button>
        </div>
      )}
      <div className="chat-input" style={{paddingBottom:extraPadBot>0?extraPadBot+'px':'calc(12px + env(safe-area-inset-bottom,0px))'}}>
        <button className={`chat-voice-btn${recording?' recording':''}`}
          onPointerDown={startVoice} onPointerUp={stopVoice} onPointerLeave={()=>{if(recording)stopVoice();}}>
          {recording?`${recDur}s`:'🎤'}
        </button>
        <input ref={inputRef} className="inp" value={text} onChange={e=>setT(e.target.value)}
          onKeyDown={handleKey} placeholder={recording?'Запись...':"Сообщение…"} maxLength={500}
          disabled={recording} style={{marginBottom:0}}/>
        <button className="chat-send" onClick={send} disabled={!text.trim()||recording}>▶</button>
      </div>
    </>
  );
}

/* ══════════════════════════════════════════════════════════
   AUTH SCREEN
══════════════════════════════════════════════════════════ */
function AuthScreen({onLogin,toast}){
  const[tab,setTab]=useState('login');
  const[uname,setU]=useState('');
  const[dname,setDname]=useState('');
  const[pass,setP]=useState('');
  const[loading,setL]=useState(false);

  const go=async()=>{
    const u=uname.trim().toLowerCase(),p=pass.trim();
    if(u.length<2||u.length>20)return toast('Имя: 2–20 символов','err');
    if(p.length<3)return toast('Пароль: мин. 3 символа','err');
    if(!/^[a-zа-яёA-ZА-ЯЁ0-9_-]+$/i.test(u))return toast('Только буквы, цифры, _ и -','err');
    setL(true);
    try{
      if(tab==='register'){
        const ex=await DB.getUser(u);if(ex){setL(false);return toast('Имя занято','err');}
        const all=await DB.getAllUsers();const first=Object.keys(all).length===0;
        const displayName=dname.trim()||u;
        // Реферальный код из URL
        const urlRef=new URLSearchParams(window.location.search).get('ref');
        const refCode=u.toUpperCase().slice(0,6);
        const nu={userId:u,username:u,password:p,displayName:displayName,isAdmin:first,customRank:first?'supreme':null,gamesPlayed:0,gamesWon:0,gamesEliminated:0,elo:1000,eloGames:0,createdAt:Date.now(),coins:50,refCode};
        await DB.setUser(u,nu);
        // Начисляем реферальный бонус
        if(urlRef){
          const refOwner=await DB.getByRefCode(urlRef.toUpperCase());
          if(refOwner&&refOwner.username!==u)await DB.addRefBonus(refOwner.username,u);
        }
        toast('✅ Аккаунт создан! +50 монет 🪙','ok');if(window.triggerGate)window.triggerGate();onLogin(nu);
      }else{
        const usr=await DB.getUser(u);
        if(!usr||usr.password!==p){setL(false);return toast('Неверный логин или пароль','err');}
        if(usr.isBanned){setL(false);return toast(`🚫 Аккаунт заблокирован: ${usr.banReason||'Нарушение правил'}`,'err');}
        if(window.triggerGate)window.triggerGate();onLogin(usr);
      }
    }catch(e){toast('Ошибка соединения','err');console.error(e);}
    setL(false);
  };

  return(
    <div className="sc" style={{justifyContent:'center',alignItems:'center',padding:'0 20px',position:'relative',overflow:'hidden'}}>
      <div className="auth-glow"/>
      {/* Big icon */}
      <div style={{fontSize:72,animation:'glow 2.5s ease infinite',marginBottom:4,position:'relative',zIndex:1}}>☢</div>
      <div style={{fontFamily:"'Inter',sans-serif",fontSize:68,letterSpacing:2,color:'var(--a)',textShadow:'0 0 50px rgba(240,165,0,.3)',animation:'glitch 5s steps(1) infinite',position:'relative',zIndex:1}}>БУНКЕР</div>
      <div className="mono" style={{fontSize:9,letterSpacing:1,color:'var(--tx3)',marginBottom:36,position:'relative',zIndex:1}}>АПОКАЛИПСИС · ФТИ · WEB</div>

      <div style={{width:'100%',maxWidth:360,background:'rgba(255,255,255,0.05)',backdropFilter:'var(--bl)',WebkitBackdropFilter:'var(--bl)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:'var(--rad-lg)',padding:26,position:'relative',zIndex:1}}>
        {/* no corner brackets in modern design */}

        <div className="tabs" style={{marginBottom:18}}>
          <button className={`tab${tab==='login'?' on':''}`} onClick={()=>setTab('login')}>ВОЙТИ</button>
          <button className={`tab${tab==='register'?' on':''}`} onClick={()=>setTab('register')}>РЕГИСТРАЦИЯ</button>
        </div>
        <input className="inp" placeholder="Имя пользователя (логин)" value={uname} onChange={e=>setU(e.target.value)} maxLength={20} autoComplete="off"/>
        {tab==='register'&&<input className="inp" placeholder="Отображаемое имя (необязательно)" value={dname} onChange={e=>setDname(e.target.value)} maxLength={30} autoComplete="off"/>}
        <input className="inp" type="password" placeholder="Пароль" value={pass} onChange={e=>setP(e.target.value)} onKeyDown={e=>e.key==='Enter'&&go()}/>
        <Btn ch={loading?'⏳ ЗАГРУЗКА…':tab==='login'?'⚡ ВОЙТИ В БУНКЕР':'🔑 СОЗДАТЬ АККАУНТ'} onClick={go} disabled={loading}/>
        {tab==='register'&&<div className="mono" style={{fontSize:9,color:'var(--tx3)',marginTop:10,textAlign:'center',letterSpacing:1}}>Первый зарегистрированный — администратор</div>}
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   HOME SCREEN
══════════════════════════════════════════════════════════ */
/* ══ AVATAR COMPONENT ══ */
const AVA_COLORS=['#FF6B6B','#FF9F43','#FECA57','#48DBFB','#FF9FF3','#54A0FF','#5F27CD','#00D2D3','#01ABC7','#10AC84','#EE5A24','#9980FA'];
function getAvaColor(name){const h=(name||'?').split('').reduce((a,c)=>a+c.charCodeAt(0),0);return AVA_COLORS[h%AVA_COLORS.length];}
const AVATARS=['🧑‍🚀','👩‍⚕️','🧙‍♂️','🦸','🧟','👨‍💻','🎩','👮','🧛','🤖','👽','🦊','🐺','🦁','🐲','💀','🔬','⚔️','🛡️','🎭','🧪','☢️','🏴‍☠️','🎯'];

/* ══════════════════════════════════════════════════════════
   SHOP DATA — PREMIUM PACKS, AVATARS, FRAMES, EFFECTS
══════════════════════════════════════════════════════════ */

/* ── Тематические паки карточек ── */
const CARD_PACKS = [
  {
    id: 'pack_default',
    name: 'Стандартный',
    icon: '🃏',
    color: '#8e8e99',
    price: 0,
    description: 'Базовый набор карточек — профессии, снаряжение и факты из стандартной игры. Доступен бесплатно.',
    professions: [
      '👨‍⚕️ Врач','👩‍🔬 Биолог','⚙️ Инженер','👮 Полицейский','🧑‍🍳 Повар',
      '🧑‍🌾 Фермер','🧑‍💻 Программист','🧑‍🏫 Учитель','🧑‍🔧 Механик','🧑‍✈️ Пилот',
      '🧑‍⚕️ Медсестра','🧑‍🎨 Художник','🧑‍🎤 Музыкант','📚 Библиотекарь','⚖️ Юрист',
    ],
    baggage: [
      '🎒 Аптечка первой помощи','🔦 Фонарик с батарейками','🍫 Запас еды на неделю',
      '💧 Фильтр для воды','🔪 Складной нож','📻 Радиоприёмник','🪢 Верёвка 50м',
    ],
    facts: [
      '💪 Отличная физическая форма','🧠 Высокий IQ','🌍 Знает 3 языка',
      '😷 Хронически болен','🕵️ Бывший агент спецслужб','🎖️ Военный ветеран',
    ],
  },
  {
    id: 'zombie',
    name: 'Зомби-апокалипсис',
    icon: '🧟',
    color: '#30d158',
    price: 150,
    description: 'Профессии и снаряжение для выживания среди зомби. 30+ уникальных карт.',
    professions: [
      '🧟‍♂️ Истребитель заражённых','🔬 Вирусолог','🏥 Военный хирург','⚔️ Охотник на мертвецов',
      '🛡️ Командир баррикад','🌿 Травник и знахарь','🐕 Дрессировщик сторожевых псов',
      '📻 Радист сопротивления','🔧 Оружейник','🚑 Фельдшер скорой помощи',
      '🏹 Снайпер-рейдер','🧪 Биохимик-синтетик','🗺️ Разведчик территории',
      '🔑 Взломщик укреплений','🍄 Специалист по грибам (еда)','🐄 Фермер в убежище',
      '⚡ Электрик генераторов','🔨 Строитель укреплений','🎯 Инструктор стрельбы',
      '💊 Фармацевт-синтетик',
    ],
    baggage: [
      '🪓 Боевой топор + 500 болтов к арбалету','💉 Антисыворотка (10 доз)',
      '🔦 Тактический фонарь + батареи на год','🧲 Электромагнитная пушка (оглушает зомби)',
      '🐕 Обученная собака-ищейка','🏠 Чертежи укреплённой базы','🧪 Лаборатория для вакцины',
      '📡 Спутниковый сканер движения','🍖 Запасы еды на 5 лет','🔫 Автомат с глушителем',
    ],
    facts: [
      '🧠 Иммунен к вирусу — никто не знает','☠️ Укушен, но скрывает',
      '💉 Знает формулу вакцины наизусть','🔬 Создал штамм, стоящий за эпидемией',
      '🏃 Единственный выживший в своём городе','👁️ Видит зомби в темноте',
    ],
  },
  {
    id: 'space',
    name: 'Космическая станция',
    icon: '🚀',
    color: '#0a84ff',
    price: 200,
    description: 'Бункер в открытом космосе. Астронавты, инженеры, учёные на орбите.',
    professions: [
      '🧑‍🚀 Командир экипажа','🔭 Астрофизик','⚙️ Инженер систем жизнеобеспечения',
      '🤖 Специалист по ИИ','🛸 Пилот истребителя','🌍 Эколог-терраформер',
      '💊 Космический врач','📡 Оператор дальней связи','🧬 Генный инженер',
      '☢️ Ядерный реактор-техник','🎮 Оператор дронов','🧲 Физик-ускорительщик',
      '🌡️ Метеоролог планет','🏗️ Инженер-монтажник (EVA)','🔐 Криптограф-секретчик',
      '🌌 Космолог-теоретик','🦾 Специалист по протезам','🎯 Оператор оружия',
      '🍀 Биолог-ксенобиолог','🧊 Криотехник',
    ],
    baggage: [
      '🚀 Личный спасательный модуль','🔧 Инструментарий для EVA-работ',
      '💻 Квантовый компьютер','🧪 Лаборатория нулевой гравитации',
      '☀️ Автономные солнечные панели','🌱 Гидропонная установка',
      '🤖 Сервисный дрон-помощник','📡 Межгалактический маяк',
      '🧬 Образцы ДНК всего человечества','☢️ Ядерный реактор — мини',
    ],
    facts: [
      '🌌 Знает координаты обитаемой планеты','🤖 Наполовину киборг',
      '🧠 Синтетический интеллект в теле человека','☠️ Несёт смертоносный вирус из космоса',
      '💫 Единственный контакт с внеземной цивилизацией','🔭 Видел конец Вселенной в симуляции',
    ],
  },
  {
    id: 'medieval',
    name: 'Средневековый бункер',
    icon: '🏰',
    color: '#bf5af2',
    price: 120,
    description: 'Замок-убежище. Рыцари, алхимики, маги и крестьяне сражаются за место.',
    professions: [
      '⚔️ Рыцарь-паладин','🧙‍♂️ Алхимик','🏹 Лучник-следопыт','👑 Герольд лорда',
      '⚕️ Монах-целитель','🔨 Кузнец','🍞 Пекарь и хлебодел','🌿 Знахарка',
      '🗺️ Картограф','🐎 Конюх и наездник','🗡️ Наёмник-убийца','📜 Писарь-летописец',
      '🏗️ Архитектор замков','🐦 Сокольничий','🌾 Крестьянин-земледелец',
      '🎭 Придворный шут','🧱 Каменщик','⚓ Мореплаватель','🎵 Менестрель',
      '🧿 Прорицатель-астролог',
    ],
    baggage: [
      '⚔️ Зачарованный меч Экскалибур','🛡️ Щит из металла дракона',
      '📜 Свиток с рецептом философского камня','🧪 Зелье бессмертия (1 доза)',
      '🏹 Лук с 1000 стрел','🐎 Боевой конь','🗺️ Карта тайных подземелий',
      '🍯 Мёд и припасы на 10 лет','🔮 Магический кристалл связи','🔥 Греческий огонь',
    ],
    facts: [
      '👑 Законный наследник трона','🧙‍♂️ Владеет настоящей магией',
      '☠️ Проклят злой ведьмой','🐉 Приручил дракона','💉 Знает яд без противоядия',
      '🔮 Видит будущее в снах',
    ],
  },
  {
    id: 'cyberpunk',
    name: 'Киберпанк 2099',
    icon: '🤖',
    color: '#f0a500',
    price: 180,
    description: 'Неоновые улицы, корпорации и хакеры. Кто выживет в цифровом аду?',
    professions: [
      '👨‍💻 Хакер-призрак','🤖 Боевой киборг','🧬 Генный модификатор','💊 Нейрохимик',
      '📡 Взломщик сетей','🔧 Механик кибер-протезов','🎯 Охотник за головами',
      '🏙️ Уличный информатор','💼 Корпоративный шпион','🎭 Мастер маскировки',
      '⚡ Электрохакер','🔬 Биоинженер','🛸 Пилот летающего авто','🧠 Нейролинк-программист',
      '🔐 Взломщик AI-систем','🎮 Оператор боевых дронов','🩺 Риппер-Doc (хирург)',
      '🌿 Эко-активист','📰 Инди-журналист','🐕 Кибер-дрессировщик',
    ],
    baggage: [
      '💻 Нейроинтерфейс класса Platinum','🔫 Смарт-пистолет с ИИ-прицелом',
      '🧬 Набор генетических модификаций','📡 EMP-граната (10 шт)',
      '🤖 Персональный боевой дрон','🧪 Нейростимуляторы на год',
      '🔐 Взломщик любых кодов','🎭 Голографический генератор маскировки',
      '⚡ Экзоскелет класса «Боевой»','🌐 Доступ к закрытой сети корпораций',
    ],
    facts: [
      '🧠 Загружена копия сознания в облако','🤖 На 80% киборг, скрывает',
      '💉 Зависим от нейростимуляторов','🔐 Знает пароль от ядерного оружия корпорации',
      '👁️ Глаз — скрытая камера корпорации','💾 В мозге зашифрованный вирус',
    ],
  },
];

/* ── Премиум-аватары ── */
const PREMIUM_AVATARS = [
  /* Легендарные */
  { id: 'av_nuclear',   emoji: '☢️', name: 'Ядерный',      price: 200, rarity: 'legendary' },
  { id: 'av_king',      emoji: '🤴', name: 'Король',       price: 180, rarity: 'legendary' },
  { id: 'av_grim',      emoji: '💀', name: 'Смерть',       price: 200, rarity: 'legendary' },
  { id: 'av_phoenix2',  emoji: '🦚', name: 'Жар-птица',    price: 180, rarity: 'legendary' },
  /* Эпические */
  { id: 'av_demon',     emoji: '😈', name: 'Демон',        price: 130, rarity: 'epic' },
  { id: 'av_alien',     emoji: '👾', name: 'Пришелец',     price: 120, rarity: 'epic' },
  { id: 'av_cyborg',    emoji: '🦾', name: 'Киборг',       price: 120, rarity: 'epic' },
  { id: 'av_dragon',    emoji: '🐉', name: 'Дракон',       price: 130, rarity: 'epic' },
  { id: 'av_mage',      emoji: '🧿', name: 'Мистик',       price: 110, rarity: 'epic' },
  { id: 'av_robot',     emoji: '🤖', name: 'Робот',        price: 110, rarity: 'epic' },
  /* Редкие */
  { id: 'av_vampire',   emoji: '🧛', name: 'Вампир',       price: 90,  rarity: 'rare' },
  { id: 'av_angel',     emoji: '😇', name: 'Ангел',        price: 80,  rarity: 'rare' },
  { id: 'av_cat',       emoji: '🐈‍⬛', name: 'Чёрный кот', price: 80,  rarity: 'rare' },
  { id: 'av_thunder',   emoji: '⚡', name: 'Молния',       price: 90,  rarity: 'rare' },
  { id: 'av_ice',       emoji: '❄️', name: 'Лёд',          price: 80,  rarity: 'rare' },
  { id: 'av_wolf',      emoji: '🐺', name: 'Волк',         price: 80,  rarity: 'rare' },
  { id: 'av_phoenix',   emoji: '🦅', name: 'Орёл',         price: 80,  rarity: 'rare' },
  { id: 'av_snake',     emoji: '🐍', name: 'Змея',         price: 75,  rarity: 'rare' },
  { id: 'av_bear',      emoji: '🐻', name: 'Медведь',      price: 75,  rarity: 'rare' },
  { id: 'av_lion',      emoji: '🦁', name: 'Лев',          price: 85,  rarity: 'rare' },
  { id: 'av_fox',       emoji: '🦊', name: 'Лиса',         price: 75,  rarity: 'rare' },
  { id: 'av_octopus',   emoji: '🐙', name: 'Осьминог',     price: 70,  rarity: 'rare' },
  /* Обычные */
  { id: 'av_wizard',    emoji: '🧙', name: 'Волшебник',    price: 60,  rarity: 'common' },
  { id: 'av_ninja',     emoji: '🥷', name: 'Ниндзя',       price: 60,  rarity: 'common' },
  { id: 'av_ghost',     emoji: '👻', name: 'Призрак',      price: 50,  rarity: 'common' },
  { id: 'av_fire',      emoji: '🔥', name: 'Огонь',        price: 50,  rarity: 'common' },
  { id: 'av_crown',     emoji: '👸', name: 'Принцесса',    price: 60,  rarity: 'common' },
  { id: 'av_bunny',     emoji: '🐰', name: 'Кролик',       price: 45,  rarity: 'common' },
  { id: 'av_heart',     emoji: '🫀', name: 'Сердце',       price: 40,  rarity: 'common' },
  { id: 'av_star',      emoji: '⭐', name: 'Звезда',       price: 40,  rarity: 'common' },
  { id: 'av_mushroom',  emoji: '🍄', name: 'Гриб',         price: 45,  rarity: 'common' },
  { id: 'av_cactus',    emoji: '🌵', name: 'Кактус',       price: 40,  rarity: 'common' },
  { id: 'av_bomb',      emoji: '💣', name: 'Бомба',        price: 55,  rarity: 'common' },
  { id: 'av_crystal',   emoji: '💎', name: 'Кристалл',     price: 60,  rarity: 'common' },
  { id: 'av_clown',     emoji: '🤡', name: 'Клоун',        price: 50,  rarity: 'common' },
  { id: 'av_panda',     emoji: '🐼', name: 'Панда',        price: 50,  rarity: 'common' },
  { id: 'av_penguin',   emoji: '🐧', name: 'Пингвин',      price: 45,  rarity: 'common' },
];

/* ── Рамки профиля ── */
const PROFILE_FRAMES = [
  /* Легендарные */
  { id: 'frame_rainbow',  name: '🌈 Радужная',      price: 350, color: '#ff453a', gradient: 'linear-gradient(135deg,#ff453a,#f0a500,#30d158,#0a84ff,#bf5af2)', rarity: 'legendary' },
  { id: 'frame_gold',     name: '✨ Золотая',        price: 250, color: '#f0a500', gradient: 'linear-gradient(135deg,#c8830a,#f0a500,#ffd700,#f0a500,#c8830a)', rarity: 'legendary' },
  { id: 'frame_diamond',  name: '💎 Бриллиант',     price: 400, color: '#4da6ff', gradient: 'linear-gradient(135deg,#4da6ff,#ffffff,#b0e0ff,#ffffff,#4da6ff)', rarity: 'legendary' },
  { id: 'frame_nuclear',  name: '☢️ Ядерная',        price: 300, color: '#30d158', gradient: 'linear-gradient(135deg,#0a2e0a,#30d158,#00ff88,#30d158,#0a2e0a)', rarity: 'legendary' },
  /* Эпические */
  { id: 'frame_fire',     name: '🔥 Огненная',      price: 180, color: '#ff453a', gradient: 'linear-gradient(135deg,#ff1a00,#ff6b35,#ffd700,#ff6b35,#ff1a00)', rarity: 'epic' },
  { id: 'frame_cyber',    name: '🤖 Кибер',          price: 160, color: '#30d158', gradient: 'linear-gradient(135deg,#001a00,#30d158,#00ff88,#30d158,#001a00)', rarity: 'epic' },
  { id: 'frame_royal',    name: '👑 Королевская',   price: 180, color: '#bf5af2', gradient: 'linear-gradient(135deg,#4a0080,#bf5af2,#e8b4ff,#bf5af2,#4a0080)', rarity: 'epic' },
  { id: 'frame_neon',     name: '💡 Неоновая',      price: 150, color: '#0a84ff', gradient: 'linear-gradient(135deg,#001433,#0a84ff,#00f2fe,#0a84ff,#001433)', rarity: 'epic' },
  { id: 'frame_galaxy',   name: '🌌 Галактика',     price: 200, color: '#a78bfa', gradient: 'linear-gradient(135deg,#1a0033,#7b2ff7,#e040fb,#00b0ff,#7b2ff7)', rarity: 'epic' },
  /* Редкие */
  { id: 'frame_ice',      name: '❄️ Ледяная',       price: 100, color: '#4da6ff', gradient: 'linear-gradient(135deg,#4da6ff,#e0f4ff,#4da6ff)', rarity: 'rare' },
  { id: 'frame_purple',   name: '🔮 Мистическая',   price: 100, color: '#bf5af2', gradient: 'linear-gradient(135deg,#bf5af2,#a78bfa,#bf5af2)', rarity: 'rare' },
  { id: 'frame_toxic',    name: '☣️ Токсичная',     price: 110, color: '#a8ff00', gradient: 'linear-gradient(135deg,#1a3300,#a8ff00,#c8ff40,#a8ff00,#1a3300)', rarity: 'rare' },
  { id: 'frame_lava',     name: '🌋 Лавовая',       price: 120, color: '#ff8c00', gradient: 'linear-gradient(135deg,#3d0000,#ff4500,#ff8c00,#ffd700)', rarity: 'rare' },
  { id: 'frame_ocean',    name: '🌊 Океан',          price: 100, color: '#00b0ff', gradient: 'linear-gradient(135deg,#001a33,#00b0ff,#00e5ff,#00b0ff)', rarity: 'rare' },
  { id: 'frame_rose',     name: '🌹 Розовая',       price: 90,  color: '#ff4081', gradient: 'linear-gradient(135deg,#ff4081,#f48fb1,#ff4081)', rarity: 'rare' },
  /* Обычные */
  { id: 'frame_silver',   name: '🥈 Серебряная',    price: 70,  color: '#a0a0b0', gradient: 'linear-gradient(135deg,#606070,#c0c0d0,#606070)', rarity: 'common' },
  { id: 'frame_bunker',   name: '🏚 Бункерная',     price: 60,  color: '#8e8e99', gradient: 'linear-gradient(135deg,#2a2a3a,#6e6e80,#2a2a3a)', rarity: 'common' },
  { id: 'frame_white',    name: '⬜ Белая',          price: 50,  color: '#e0e0e0', gradient: 'linear-gradient(135deg,#c0c0c0,#ffffff,#c0c0c0)', rarity: 'common' },
];

/* ── Эффекты карточек ── */
const CARD_EFFECTS = [
  { id: 'fx_gold',    name: '✨ Золотые',       price: 200, desc: 'Карты в золотом стиле с блеском',    preview: '✨', color: '#f0a500', rarity: 'legendary' },
  { id: 'fx_galaxy',  name: '🌌 Галактика',    price: 180, desc: 'Карты с космическим фоном',          preview: '🌌', color: '#7b2ff7', rarity: 'legendary' },
  { id: 'fx_diamond', name: '💎 Бриллиант',    price: 220, desc: 'Карты переливаются как бриллиант',   preview: '💎', color: '#4da6ff', rarity: 'legendary' },
  { id: 'fx_neon',    name: '💡 Неоновые',     price: 140, desc: 'Карты светятся неоном',              preview: '💡', color: '#0a84ff', rarity: 'epic' },
  { id: 'fx_fire',    name: '🔥 Огненные',     price: 150, desc: 'Огненное оформление карточек',       preview: '🔥', color: '#ff6b35', rarity: 'epic' },
  { id: 'fx_toxic',   name: '☣️ Токсичные',    price: 130, desc: 'Ядовито-зелёный стиль',             preview: '☣️', color: '#a8ff00', rarity: 'epic' },
  { id: 'fx_cyber',   name: '🤖 Кибер',        price: 110, desc: 'Матричный стиль в стиле хакера',    preview: '🤖', color: '#30d158', rarity: 'rare' },
  { id: 'fx_royal',   name: '👑 Королевские',  price: 100, desc: 'Бархатные карты с орнаментом',      preview: '👑', color: '#bf5af2', rarity: 'rare' },
  { id: 'fx_ice',     name: '❄️ Ледяные',      price: 90,  desc: 'Заморозка — холодный стиль',        preview: '❄️', color: '#4da6ff', rarity: 'rare' },
  { id: 'fx_retro',   name: '📟 Ретро',        price: 80,  desc: 'Пиксельный ретро-стиль 8-bit',      preview: '📟', color: '#a8ff00', rarity: 'common' },
  { id: 'fx_dark',    name: '🌑 Тёмные',       price: 70,  desc: 'Ультра-тёмный минималистичный стиль',preview: '🌑', color: '#555570', rarity: 'common' },
  { id: 'fx_classic', name: '🃏 Классика',     price: 0,   desc: 'Стандартный стиль (бесплатно)',     preview: '🃏', color: '#8e8e99', rarity: 'common' },
];

const RARITY_LABELS = { common: 'Обычный', rare: 'Редкий', epic: 'Эпический', legendary: 'Легендарный' };
const RARITY_COLORS = { common: '#8e8e99', rare: '#4da6ff', epic: '#bf5af2', legendary: '#f0a500' };

/* ── Визуальные стили для эффектов карточек ── */
const CARD_EFFECT_STYLES = {
  fx_classic: {
    cardBg:   'rgba(255,255,255,0.04)',
    cardBorder:'rgba(255,255,255,0.08)',
    revBg:    'rgba(48,209,88,0.06)',
    revBorder:'rgba(48,209,88,.3)',
    glow:     null,
    overlay:  null,
  },
  fx_gold: {
    cardBg:   'linear-gradient(135deg,rgba(240,165,0,0.12),rgba(200,120,0,0.08))',
    cardBorder:'rgba(240,165,0,0.45)',
    revBg:    'linear-gradient(135deg,rgba(240,165,0,0.18),rgba(200,120,0,0.12))',
    revBorder:'rgba(240,165,0,0.7)',
    glow:     '0 0 12px rgba(240,165,0,0.35)',
    overlay:  'linear-gradient(135deg,rgba(255,215,0,0.06) 0%,transparent 60%)',
  },
  fx_galaxy: {
    cardBg:   'linear-gradient(135deg,rgba(123,47,247,0.15),rgba(10,50,120,0.12))',
    cardBorder:'rgba(123,47,247,0.5)',
    revBg:    'linear-gradient(135deg,rgba(123,47,247,0.22),rgba(10,50,120,0.18))',
    revBorder:'rgba(123,47,247,0.75)',
    glow:     '0 0 14px rgba(123,47,247,0.4)',
    overlay:  'radial-gradient(ellipse at top right,rgba(200,150,255,0.08),transparent 60%)',
  },
  fx_diamond: {
    cardBg:   'linear-gradient(135deg,rgba(77,166,255,0.12),rgba(0,200,255,0.08))',
    cardBorder:'rgba(77,166,255,0.5)',
    revBg:    'linear-gradient(135deg,rgba(77,166,255,0.2),rgba(0,200,255,0.12))',
    revBorder:'rgba(77,166,255,0.75)',
    glow:     '0 0 14px rgba(77,166,255,0.4)',
    overlay:  'linear-gradient(135deg,rgba(200,240,255,0.07) 0%,transparent 55%)',
  },
  fx_neon: {
    cardBg:   'linear-gradient(135deg,rgba(10,132,255,0.1),rgba(0,80,200,0.08))',
    cardBorder:'rgba(10,132,255,0.6)',
    revBg:    'linear-gradient(135deg,rgba(10,132,255,0.16),rgba(0,80,200,0.12))',
    revBorder:'rgba(10,132,255,0.85)',
    glow:     '0 0 16px rgba(10,132,255,0.5)',
    overlay:  null,
  },
  fx_fire: {
    cardBg:   'linear-gradient(135deg,rgba(255,107,53,0.12),rgba(255,50,0,0.08))',
    cardBorder:'rgba(255,107,53,0.5)',
    revBg:    'linear-gradient(135deg,rgba(255,107,53,0.2),rgba(255,50,0,0.12))',
    revBorder:'rgba(255,107,53,0.75)',
    glow:     '0 0 14px rgba(255,107,53,0.45)',
    overlay:  'linear-gradient(180deg,rgba(255,200,0,0.05) 0%,transparent 50%)',
  },
  fx_toxic: {
    cardBg:   'linear-gradient(135deg,rgba(168,255,0,0.1),rgba(50,200,0,0.07))',
    cardBorder:'rgba(168,255,0,0.45)',
    revBg:    'linear-gradient(135deg,rgba(168,255,0,0.16),rgba(50,200,0,0.1))',
    revBorder:'rgba(168,255,0,0.7)',
    glow:     '0 0 12px rgba(168,255,0,0.35)',
    overlay:  null,
  },
  fx_cyber: {
    cardBg:   'linear-gradient(135deg,rgba(48,209,88,0.08),rgba(0,180,80,0.06))',
    cardBorder:'rgba(48,209,88,0.45)',
    revBg:    'linear-gradient(135deg,rgba(48,209,88,0.14),rgba(0,180,80,0.1))',
    revBorder:'rgba(48,209,88,0.7)',
    glow:     '0 0 10px rgba(48,209,88,0.35)',
    overlay:  'repeating-linear-gradient(0deg,transparent,transparent 4px,rgba(48,209,88,0.03) 4px,rgba(48,209,88,0.03) 5px)',
  },
  fx_royal: {
    cardBg:   'linear-gradient(135deg,rgba(191,90,242,0.12),rgba(120,0,200,0.08))',
    cardBorder:'rgba(191,90,242,0.5)',
    revBg:    'linear-gradient(135deg,rgba(191,90,242,0.18),rgba(120,0,200,0.12))',
    revBorder:'rgba(191,90,242,0.75)',
    glow:     '0 0 14px rgba(191,90,242,0.4)',
    overlay:  'linear-gradient(135deg,rgba(220,150,255,0.06) 0%,transparent 55%)',
  },
  fx_ice: {
    cardBg:   'linear-gradient(135deg,rgba(100,200,255,0.1),rgba(0,150,220,0.07))',
    cardBorder:'rgba(100,200,255,0.45)',
    revBg:    'linear-gradient(135deg,rgba(100,200,255,0.16),rgba(0,150,220,0.1))',
    revBorder:'rgba(100,200,255,0.7)',
    glow:     '0 0 12px rgba(100,200,255,0.35)',
    overlay:  'linear-gradient(180deg,rgba(220,240,255,0.06) 0%,transparent 50%)',
  },
  fx_retro: {
    cardBg:   'linear-gradient(135deg,rgba(168,255,0,0.07),rgba(0,180,0,0.05))',
    cardBorder:'rgba(168,255,0,0.35)',
    revBg:    'linear-gradient(135deg,rgba(168,255,0,0.12),rgba(0,180,0,0.08))',
    revBorder:'rgba(168,255,0,0.55)',
    glow:     '0 0 8px rgba(168,255,0,0.25)',
    overlay:  'repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(168,255,0,0.02) 3px,rgba(168,255,0,0.02) 4px)',
  },
  fx_dark: {
    cardBg:   'rgba(10,10,20,0.85)',
    cardBorder:'rgba(80,80,120,0.4)',
    revBg:    'rgba(15,15,30,0.9)',
    revBorder:'rgba(100,100,150,0.55)',
    glow:     '0 0 8px rgba(80,80,120,0.3)',
    overlay:  null,
  },
};

/* Возвращает стили карточки по id эффекта */
function getCardEffectStyle(effectId) {
  return CARD_EFFECT_STYLES[effectId] || CARD_EFFECT_STYLES['fx_classic'];
}

/* ── DB методы для монет и магазина ── */
Object.assign(DB, {
  getCoins: async (username) => {
    const u = await DB.getUser(username);
    return u?.coins || 0;
  },
  addCoins: async (username, amount) => {
    await db.ref(`users/${username}/coins`).transaction(c => (c || 0) + amount);
  },
  addXP: async (username, amount) => {
    const ref = db.ref(`users/${username}/xp`);
    const snap = await ref.once('value');
    const oldXP = snap.val() || 0;
    const newXP = oldXP + amount;
    const oldLvl = getLevel(oldXP).level;
    const newLvl = getLevel(newXP).level;
    await ref.set(newXP);
    // Проверяем награды за новые уровни
    if (newLvl > oldLvl) {
      for (let lvl = oldLvl + 1; lvl <= newLvl; lvl++) {
        const reward = LEVEL_REWARDS.find(r => r.level === lvl);
        if (reward) {
          if (reward.coins) await db.ref(`users/${username}/coins`).transaction(c => (c || 0) + reward.coins);
          if (reward.item) {
            await db.ref(`users/${username}/purchased/${reward.item.id}`).set(true);
          }
        }
      }
    }
    return { oldLvl, newLvl, leveled: newLvl > oldLvl };
  },
  getSeasonalEvent: async () => {
    const snap = await db.ref('settings/seasonalEvent').once('value');
    return snap.val();
  },
  setSeasonalEvent: async (event) => {
    await db.ref('settings/seasonalEvent').set(event);
  },
  /* ── Daily Quests ── */
  async getDailyQuests(username){const s=await db.ref(`dailyQuests/${username}`).once('value');return s.val()||null;},
  async saveDailyQuests(username,data){await db.ref(`dailyQuests/${username}`).set(data);},
  /* ── Referral ── */
  async getByRefCode(code){const s=await db.ref('users').orderByChild('refCode').equalTo(code).once('value');const v=s.val();return v?Object.values(v)[0]:null;},
  async addRefBonus(refOwner,newUser){
    await this.addCoins(refOwner,200);await this.addCoins(newUser,100);
    await db.ref(`users/${refOwner}/referrals`).transaction(c=>(c||0)+1);
    await db.ref(`users/${newUser}/refBy`).set(refOwner);
  },
  /* ── Game History (user-level) ── */
  async saveGameHistory(username,entry){
    const key=db.ref(`gameHistory/${username}`).push().key;
    await db.ref(`gameHistory/${username}/${key}`).set({...entry,ts:Date.now()});
    const snap=await db.ref(`gameHistory/${username}`).orderByChild('ts').once('value');
    const all=snap.val()||{};const keys=Object.keys(all).sort((a,b)=>all[a].ts-all[b].ts);
    if(keys.length>20)await Promise.all(keys.slice(0,keys.length-20).map(k=>db.ref(`gameHistory/${username}/${k}`).remove()));
  },
  async fetchGameHistory(username){const s=await db.ref(`gameHistory/${username}`).orderByChild('ts').limitToLast(10).once('value');const v=s.val()||{};return Object.values(v).sort((a,b)=>b.ts-a.ts);},
  spendCoins: async (username, amount) => {
    let ok = false;
    await db.ref(`users/${username}/coins`).transaction(c => {
      if ((c || 0) >= amount) { ok = true; return (c || 0) - amount; }
      return c;
    });
    return ok;
  },
  getPurchased: async (username) => {
    const snap = await db.ref(`users/${username}/purchased`).once('value');
    return snap.val() || {};
  },
  addPurchased: async (username, itemId) => {
    await db.ref(`users/${username}/purchased/${itemId}`).set(true);
  },
  getEquipped: async (username) => {
    const snap = await db.ref(`users/${username}/equipped`).once('value');
    return snap.val() || {};
  },
  setEquipped: async (username, slot, itemId) => {
    await db.ref(`users/${username}/equipped/${slot}`).set(itemId);
  },
});

/* Карта рамок — берётся из SHOP_FRAMES */
const FRAME_STYLES={
  /* Ключи без префикса (старые) */
  'none':null,
  'gold':'linear-gradient(135deg,#f5a623,#f0c040,#f5a623)',
  'silver':'linear-gradient(135deg,#a0a0b0,#d0d0e0,#a0a0b0)',
  'rainbow':'linear-gradient(135deg,#ff0080,#ff8c00,#40e0d0,#ff0080)',
  'neon':'linear-gradient(135deg,#00ff88,#00ccff,#00ff88)',
  'fire':'linear-gradient(135deg,#ff4500,#ff8c00,#ffd700,#ff4500)',
  'royal':'linear-gradient(135deg,#7b2ff7,#4facfe,#7b2ff7)',
  'cyber':'linear-gradient(135deg,#00f5ff,#bf00ff,#00f5ff)',
  /* Ключи с префиксом frame_ (из ShopScreen) */
  'frame_gold':'linear-gradient(135deg,#c8830a,#f0a500,#ffd700,#f0a500,#c8830a)',
  'frame_silver':'linear-gradient(135deg,#606070,#c0c0d0,#606070)',
  'frame_rainbow':'linear-gradient(135deg,#ff453a,#f0a500,#30d158,#0a84ff,#bf5af2)',
  'frame_neon':'linear-gradient(135deg,#001433,#0a84ff,#00f2fe,#0a84ff,#001433)',
  'frame_fire':'linear-gradient(135deg,#ff1a00,#ff6b35,#ffd700,#ff6b35,#ff1a00)',
  'frame_royal':'linear-gradient(135deg,#4a0080,#bf5af2,#e8b4ff,#bf5af2,#4a0080)',
  'frame_cyber':'linear-gradient(135deg,#001a00,#30d158,#00ff88,#30d158,#001a00)',
  'frame_bunker':'linear-gradient(135deg,#2a2a3a,#6e6e80,#2a2a3a)',
  'frame_ice':'linear-gradient(135deg,#4da6ff,#e0f4ff,#4da6ff)',
  'frame_purple':'linear-gradient(135deg,#bf5af2,#a78bfa,#bf5af2)',
  'frame_diamond':'linear-gradient(135deg,#4da6ff,#ffffff,#b0e0ff,#ffffff,#4da6ff)',
  'frame_nuclear':'linear-gradient(135deg,#0a2e0a,#30d158,#00ff88,#30d158,#0a2e0a)',
  'frame_galaxy':'linear-gradient(135deg,#1a0033,#7b2ff7,#e040fb,#00b0ff,#7b2ff7)',
  'frame_toxic':'linear-gradient(135deg,#1a3300,#a8ff00,#c8ff40,#a8ff00,#1a3300)',
  'frame_lava':'linear-gradient(135deg,#3d0000,#ff4500,#ff8c00,#ffd700)',
  'frame_ocean':'linear-gradient(135deg,#001a33,#00b0ff,#00e5ff,#00b0ff)',
  'frame_rose':'linear-gradient(135deg,#ff4081,#f48fb1,#ff4081)',
  'frame_white':'linear-gradient(135deg,#c0c0c0,#ffffff,#c0c0c0)',
};
function Avatar({name,size='md',online=false,style={},avatar,frame}){
  const bg=getAvaColor(name);
  const cls=size==='lg'?'ava-lg':size==='sm'?'ava-sm':'ava';
  const isEmoji=avatar&&avatar.length>0;
  const sz=size==='lg'?72:size==='sm'?28:40;
  const frameGrad=frame&&frame!=='none'?FRAME_STYLES[frame]:null;
  const borderW=size==='lg'?3:size==='sm'?2:2;

  // Вычисляем цвет свечения по типу рамки
  const glowColor=!frame?null:
    frame.includes('gold')?'rgba(240,180,0,0.7)':
    frame.includes('diamond')?'rgba(180,230,255,0.6)':
    frame.includes('rainbow')?'rgba(255,80,120,0.6)':
    frame.includes('neon')?'rgba(0,200,255,0.6)':
    frame.includes('fire')||frame.includes('lava')?'rgba(255,80,0,0.6)':
    frame.includes('royal')||frame.includes('purple')?'rgba(160,80,240,0.6)':
    frame.includes('cyber')||frame.includes('nuclear')?'rgba(0,220,100,0.6)':
    frame.includes('galaxy')?'rgba(140,60,250,0.6)':
    frame.includes('toxic')?'rgba(140,255,0,0.5)':
    frame.includes('ocean')?'rgba(0,180,255,0.5)':
    frame.includes('ice')?'rgba(100,200,255,0.5)':
    frame.includes('rose')?'rgba(255,80,140,0.5)':
    'rgba(200,200,200,0.4)';

  const isRainbow=frame==='rainbow'||frame==='frame_rainbow';
  const isNeon=frame==='neon'||frame==='frame_neon';

  const gradBg=isEmoji?(()=>{
    const gradients=[
      'linear-gradient(135deg,#667eea,#764ba2)',
      'linear-gradient(135deg,#f093fb,#f5576c)',
      'linear-gradient(135deg,#4facfe,#00f2fe)',
      'linear-gradient(135deg,#43e97b,#38f9d7)',
      'linear-gradient(135deg,#fa709a,#fee140)',
      'linear-gradient(135deg,#a18cd1,#fbc2eb)',
      'linear-gradient(135deg,#fccb90,#d57eeb)',
      'linear-gradient(135deg,#e0c3fc,#8ec5fc)',
    ];
    return gradients[(name?(name.charCodeAt(0)+name.charCodeAt(name.length-1))%gradients.length:0)];
  })():null;

  /* Если нет рамки — простой аватар */
  if(!frameGrad){
    return isEmoji?(
      <div className={`${cls}${online?' ava-pulse':''}`} style={{background:gradBg,boxShadow:'0 3px 12px rgba(0,0,0,0.4)',display:'flex',alignItems:'center',justifyContent:'center',...style}}>
        {avatar}
      </div>
    ):(
      <div className={`${cls}${online?' ava-pulse':''}`} style={{background:`linear-gradient(135deg,${bg}cc,${bg}88)`,boxShadow:`0 2px 8px ${bg}44`,...style}}>
        {(name||'?')[0].toUpperCase()}
      </div>
    );
  }

  /* С рамкой — используем CSS outline + box-shadow вместо обёртки */
  const ringStyle={
    outline:`${borderW+1}px solid transparent`,
    outlineOffset:2,
    backgroundImage:frameGrad,
    backgroundOrigin:'border-box',
    WebkitBackgroundClip:'border-box',
    backgroundClip:'border-box',
    boxShadow:`0 0 0 ${borderW}px transparent, 0 0 ${borderW*6}px ${glowColor}, inset 0 0 0 ${borderW+2}px var(--bg,#0a0a0f)`,
    animation:isRainbow?'rainbowSpin 3s linear infinite':isNeon?'neonPulse 1.5s ease infinite':undefined,
  };

  /* Элегантнее через border + padding */
  const wrapSz=sz+borderW*2+6;
  return(
    <div style={{
      display:'inline-flex',alignItems:'center',justifyContent:'center',
      width:wrapSz,height:wrapSz,minWidth:wrapSz,minHeight:wrapSz,
      borderRadius:'50%',
      background:frameGrad,
      padding:borderW+2,
      boxShadow:`0 0 ${borderW*6}px ${glowColor}, 0 2px 8px rgba(0,0,0,0.5)`,
      animation:isRainbow?'rainbowSpin 3s linear infinite':isNeon?'neonPulse 1.5s ease infinite':undefined,
      flexShrink:0,
      ...style
    }}>
      <div style={{
        width:'100%',height:'100%',
        borderRadius:'50%',
        background:gradBg||`linear-gradient(135deg,${bg}cc,${bg}88)`,
        display:'flex',alignItems:'center',justifyContent:'center',
        overflow:'hidden',
        boxShadow:'inset 0 1px 3px rgba(0,0,0,0.4)',
        fontSize:size==='lg'?28:size==='sm'?12:16,
        fontWeight:700,color:'#fff',
        flexShrink:0,
        position:'relative',
      }}>
        {isEmoji?avatar:(name||'?')[0].toUpperCase()}
        {online&&<div className="ava-pulse-dot"/>}
      </div>
    </div>
  );
}

/* ══ GAME LOADING SCREEN ══ */
function GameLoading({text='Загружаем бункер...'}){
  const lines=['Проверяем запасы...','Герметизируем ворота...','Распределяем роли...','Инициализируем систему...'];
  const[line,setLine]=useState(0);
  useEffect(()=>{const t=setInterval(()=>setLine(v=>(v+1)%lines.length),700);return()=>clearInterval(t);},[]);
  return(
    <div className="game-loading">
      <div style={{fontSize:42,animation:'glow 2s ease infinite'}}>☢</div>
      <div style={{textAlign:'center'}}>
        <div style={{fontSize:18,fontWeight:700,color:'var(--a)',marginBottom:6}}>{text}</div>
        <div style={{fontSize:12,color:'var(--tx3)',minHeight:18}}>{lines[line]}</div>
      </div>
      <div className="game-loading-bar"><div className="game-loading-fill"/></div>
    </div>
  );
}

/* ══ ONLINE PRESENCE ══ */
function useOnline(gameId,username){
  useEffect(()=>{
    if(!gameId||!username)return;
    const ref=db.ref(`presence/${gameId}/${username}`);
    ref.set({ts:Date.now(),online:true});
    ref.onDisconnect().remove();
    const t=setInterval(()=>ref.update({ts:Date.now()}),15000);
    return()=>{clearInterval(t);ref.remove();};
  },[gameId,username]);
}
function useOnlinePlayers(gameId){
  const[online,setOnline]=useState({});
  useEffect(()=>{
    if(!gameId)return;
    const ref=db.ref(`presence/${gameId}`);
    const cb=ref.on('value',snap=>{
      const d=snap.val()||{};
      const now=Date.now();
      const alive={};
      Object.entries(d).forEach(([u,v])=>{if(now-(v.ts||0)<35000)alive[u]=true;});
      setOnline(alive);
    });
    return()=>ref.off('value',cb);
  },[gameId]);
  return online;
}

function HomeScreen({user,nav,online,announcement,onUpdate,toast}){
  const rank=getRank(user);
  const stats=[['gamesPlayed','ИГР','var(--a)'],['gamesWon','ПОБЕД','var(--g)'],['gamesEliminated','ВЫБЫЛ','var(--r)'],['elo','ЭЛО','#4da6ff']];
  const lvlInfo=getLevel(user.xp||0);
  const[showDailyBonus,setShowDailyBonus]=useState(false);
  // Auto-show daily bonus if not claimed today
  useEffect(()=>{
    const today=new Date().toDateString();
    if(user.lastDailyBonus!==today){
      const t=setTimeout(()=>setShowDailyBonus(true),800);
      return()=>clearTimeout(t);
    }
  },[]);
  return(
    <div className="sc">
      <HZ/>
      <div className="tb"><div className="led led-g"/><div className="tb-title" style={{color:'var(--a)'}}>БУНКЕР ФТИ</div><div style={{fontSize:11,color:'var(--tx3)',fontFamily:"'Inter',sans-serif",fontWeight:500}}>v2</div><div style={{fontSize:11,color:'var(--g)',fontWeight:600,display:'flex',alignItems:'center',gap:4}}>🟢 {Object.keys(online||{}).length} онлайн</div></div>
      <div className="scr">
        {announcement&&<div style={{background:'linear-gradient(135deg,rgba(10,132,255,0.15),rgba(155,89,239,0.12))',border:'1px solid rgba(10,132,255,0.35)',borderRadius:'var(--rad)',padding:'12px 16px',marginBottom:14,display:'flex',gap:10,alignItems:'flex-start'}}>
          <span style={{fontSize:18,flexShrink:0}}>📢</span>
          <div><div style={{fontSize:10,color:'var(--c)',fontWeight:700,letterSpacing:1,marginBottom:3}}>ОБЪЯВЛЕНИЕ АДМИНИСТРАТОРА</div><div style={{fontSize:13,color:'var(--tx)',lineHeight:1.5}}>{announcement}</div></div>
        </div>}
        {/* Profile hero */}
        <div style={{background:'rgba(255,255,255,0.05)',backdropFilter:'var(--bl)',WebkitBackdropFilter:'var(--bl)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad-lg)',padding:'24px 16px 20px',marginBottom:14,position:'relative',textAlign:'center'}}>
          {/* Subtle glow under icon */}
          <div style={{position:'absolute',top:'10%',left:'50%',transform:'translateX(-50%)',width:100,height:100,borderRadius:'50%',background:'radial-gradient(circle,rgba(240,165,0,.15) 0%,transparent 70%)',pointerEvents:'none'}}/>
          <div style={{fontSize:56,marginBottom:6,animation:'glow 3s ease infinite',position:'relative'}}>{rank.icon}</div>
          <div style={{fontFamily:"'Inter',sans-serif",fontSize:26,letterSpacing:3,color:'var(--tx)',marginBottom:2}}>{user.displayName||user.username}</div>
          <div className="mono" style={{fontSize:9,color:'var(--tx3)',letterSpacing:2,marginBottom:6}}>@{user.username}</div>
          <RChip user={user} size={10}/>
          {/* Уровень */}
          <div style={{display:'flex',alignItems:'center',gap:8,justifyContent:'center',margin:'10px 0 4px'}}>
            <div style={{background:'linear-gradient(135deg,var(--a),#ff6b00)',borderRadius:8,padding:'3px 10px',fontSize:12,fontWeight:900,color:'#000'}}>ур. {lvlInfo.level}</div>
            <div style={{flex:1,maxWidth:120,height:5,background:'rgba(255,255,255,0.08)',borderRadius:3,overflow:'hidden'}}>
              <div style={{height:'100%',width:`${Math.round(lvlInfo.currentXP/lvlInfo.neededXP*100)}%`,background:'linear-gradient(90deg,var(--a),#ff6b00)',borderRadius:3}}/>
            </div>
            <div style={{fontSize:10,color:'var(--tx3)'}}>{lvlInfo.currentXP}/{lvlInfo.neededXP}</div>
          </div>
          {/* Stats row */}
          <div style={{display:'flex',justifyContent:'center',gap:0,marginTop:18,borderTop:'1px solid var(--ab)',paddingTop:16}}>
            {stats.map(([k,l,c],i)=>(
              <div key={k} style={{flex:1,textAlign:'center',borderRight:i<2?'1px solid var(--ab)':'none'}}>
                <div style={{fontFamily:"'Inter',sans-serif",fontSize:32,color:c,lineHeight:1}}>{user[k]||0}</div>
                <div className="mono" style={{fontSize:8,color:'var(--tx3)',letterSpacing:2,marginTop:3}}>{l}</div>
              </div>
            ))}
          </div>
        </div>

        <div className="lbl">ДЕЙСТВИЯ</div>
        <div style={{display:'flex',flexDirection:'column',gap:8,marginBottom:4}}>
          <Btn ch="☢ СОЗДАТЬ ИГРУ" onClick={()=>nav('createGame')}/>
          <Btn ch="🔍 ПОДБОР ИГРОКОВ" onClick={()=>nav('matchmaking')} cls="btn-c"/>
          <Btn ch="🔑 ВОЙТИ ПО КОДУ" onClick={()=>nav('joinGame')} cls="btn-g"/>
          <div className="brow">
            <Btn ch="🏆 РЕЙТИНГ" onClick={()=>nav('leaderboard')} cls="btn-c" sm/>
            <Btn ch="👤 ПРОФИЛЬ" onClick={()=>nav('profile')} cls="btn-g" sm/>
          </div>
          {/* Ежедневный бонус */}
          <button onClick={()=>setShowDailyBonus(true)} style={{width:'100%',padding:'13px 16px',background:user.lastDailyBonus===new Date().toDateString()?'rgba(255,255,255,0.04)':'linear-gradient(135deg,rgba(240,165,0,0.18),rgba(240,165,0,0.06))',border:`1px solid ${user.lastDailyBonus===new Date().toDateString()?'rgba(255,255,255,0.08)':'rgba(240,165,0,0.4)'}`,borderRadius:'var(--rad)',color:user.lastDailyBonus===new Date().toDateString()?'var(--tx3)':'var(--a)',fontSize:14,fontWeight:700,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:8,fontFamily:"'Inter',sans-serif",transition:'.2s'}}>
            <span style={{fontSize:18}}>{user.lastDailyBonus===new Date().toDateString()?'✅':'🎁'}</span>
            {user.lastDailyBonus===new Date().toDateString()?'Бонус получен сегодня':'Ежедневный бонус — забрать!'}
            {(user.loginStreak||0)>0&&<span style={{fontSize:11,background:'rgba(240,165,0,0.15)',border:'1px solid rgba(240,165,0,0.3)',borderRadius:8,padding:'2px 7px',color:'var(--a)'}}>🔥{user.loginStreak||0}</span>}
          </button>
          {user.isAdmin&&<Btn ch="🔐 ПАНЕЛЬ АДМИНИСТРАТОРА" onClick={()=>nav('admin')} cls="btn-pu"/>}
        </div>
        {showDailyBonus&&<DailyBonusModal user={user} onClose={()=>setShowDailyBonus(false)} onUpdate={onUpdate} toast={toast||((m)=>{})}/>}

        <div className="lbl">СИСТЕМА ЗВАНИЯ</div>
        {RANKS.filter(r=>!r.adminOnly||user.isAdmin).map(r=>{
          const cur=getRank(user).id===r.id;
          return(
            <div key={r.id} style={{display:'flex',alignItems:'center',gap:10,padding:'9px 12px',background:cur?'var(--at)':'rgba(255,255,255,0.03)',border:`1px solid ${cur?r.bdr:'rgba(255,255,255,0.07)'}`,borderRadius:'var(--rad-sm)',marginBottom:4,opacity:cur?1:.45,transition:'.2s'}}>
              <span style={{fontSize:18}}>{r.icon}</span>
              <div style={{flex:1}}>
                <div style={{fontSize:11,fontWeight:600,color:cur?r.color:'var(--tx3)'}}>{r.name}</div>
                <div style={{fontSize:10,color:'var(--tx3)',marginTop:1}}>{r.adminOnly?'Только администраторы':r.min===0?'Начальное звание':`от ${r.min} игр`}</div>
              </div>
              {cur&&<span className="bdg bdg-a" style={{fontSize:7}}>ТЕКУЩЕЕ</span>}
            </div>
          );
        })}

        {/* ═══════ ИНФОРМАЦИЯ ОБ ИГРЕ ═══════ */}
        <div className="lbl" style={{marginTop:24}}>ОБ ИГРЕ</div>
        <div style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad)',padding:16,marginBottom:10}}>
          <div style={{fontSize:13,color:'var(--tx2)',lineHeight:1.65}}>
            <b style={{color:'var(--a)'}}>Бункер</b> — социальная игра на выживание. Апокалипсис случился. Осталось одно убежище с ограниченными местами. Игроки раскрывают свои карточки и убеждают остальных, что именно они заслуживают место в бункере.
            <br/><br/>
            Каждый раунд игроки <b style={{color:'var(--tx)'}}>раскрывают по 2 карточки</b>, обсуждают и голосуют — кого выгнать. Игра заканчивается, когда оставшихся игроков ≤ числу мест в бункере.
          </div>
        </div>

        <div className="lbl">КАК ИГРАТЬ</div>
        {[
          ['1','☢','Ведущий создаёт игру, задаёт сценарий апокалипсиса и число мест в бункере'],
          ['2','🔑','Остальные игроки входят по коду комнаты'],
          ['3','🃏','Все получают уникальные карточки — профессию, здоровье, хобби, багаж и секретный факт'],
          ['4','👁','Каждый раунд раскрывай 2 карточки и убеждай остальных взять тебя в бункер'],
          ['5','🗳','После обсуждения — тайное голосование. Кто набрал больше всего голосов — выбывает'],
          ['6','🏆','Выжившие, поместившиеся в бункер — победители!'],
        ].map(([n,icon,text])=>(
          <div key={n} style={{display:'flex',alignItems:'flex-start',gap:12,padding:'11px 14px',background:'rgba(255,255,255,0.03)',border:'1px solid rgba(255,255,255,0.07)',borderRadius:'var(--rad-sm)',marginBottom:6}}>
            <div style={{width:26,height:26,borderRadius:'50%',background:'var(--at)',border:'1px solid rgba(240,165,0,0.3)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:11,fontWeight:700,color:'var(--a)',flexShrink:0}}>{n}</div>
            <div style={{fontSize:13,color:'var(--tx2)',lineHeight:1.5,paddingTop:3}}><span style={{marginRight:6}}>{icon}</span>{text}</div>
          </div>
        ))}

        <div className="lbl">КАРТОЧКИ ПЕРСОНАЖА</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:10}}>
          {[
            ['👤','Пол и возраст','Базовая информация о персонаже'],
            ['💼','Профессия','Что умеет делать в бункере'],
            ['🏥','Здоровье','Физическое и психическое состояние'],
            ['🎯','Хобби','Навыки и увлечения'],
            ['🎒','Багаж','Что взял с собой'],
            ['🤫','Секретный факт','Скрытая деталь о персонаже'],
          ].map(([icon,name,desc])=>(
            <div key={name} style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad)',padding:'12px 12px 10px'}}>
              <div style={{fontSize:22,marginBottom:6}}>{icon}</div>
              <div style={{fontSize:12,fontWeight:600,color:'var(--tx)',marginBottom:3}}>{name}</div>
              <div style={{fontSize:10,color:'var(--tx3)',lineHeight:1.4}}>{desc}</div>
            </div>
          ))}
        </div>

        <div className="lbl">🃏 СЕКРЕТНЫЕ КАРТОЧКИ</div>
        <div style={{background:'rgba(155,89,239,0.08)',border:'1px solid rgba(155,89,239,0.25)',borderRadius:'var(--rad)',padding:16,marginBottom:10}}>
          <div style={{fontSize:13,color:'var(--tx2)',lineHeight:1.65,marginBottom:12}}>
            Каждый игрок получает <b style={{color:'var(--p)'}}>одну секретную карточку</b> — уникальную ситуацию или суперспособность, которая действует один раз за игру. Используй её в нужный момент!
          </div>
          <div style={{display:'flex',flexDirection:'column',gap:6}}>
            {[
              ['⚡','Двойной удар','Твой голос считается дважды','#f0a500'],
              ['🛡️','Иммунитет','Нельзя быть выгнанным даже при максимуме голосов','#30d158'],
              ['🔄','Обмен картой','Меняешь любую карту с другим игроком','#0a84ff'],
              ['👁️','Шпион','Тайно видишь закрытую карту другого игрока','#bf5af2'],
              ['↗️','Дополнительное раскрытие','Получаешь +1 раскрытие в этом раунде','#0a84ff'],
              ['🎲','Рулетка','Все игроки получают случайные карточки заново','#ff9f0a'],
              ['🔇','Немой','Противник не может голосовать этот раунд','#ff453a'],
            ].map(([icon,name,desc,color])=>(
              <div key={name} style={{display:'flex',gap:10,alignItems:'flex-start',padding:'8px 10px',background:'rgba(255,255,255,0.03)',borderRadius:'var(--rad-sm)'}}>
                <span style={{fontSize:16,flexShrink:0,marginTop:1}}>{icon}</span>
                <div>
                  <div style={{fontSize:12,fontWeight:600,color:color||'var(--tx)',marginBottom:2}}>{name}</div>
                  <div style={{fontSize:10,color:'var(--tx3)',lineHeight:1.4}}>{desc}</div>
                </div>
              </div>
            ))}
            <div style={{fontSize:10,color:'var(--tx3)',marginTop:4,fontStyle:'italic',textAlign:'center'}}>…и ещё много других секретных карточек!</div>
          </div>
        </div>

        <div className="lbl" style={{marginTop:24}}>⚙️ ДОПОЛНИТЕЛЬНЫЕ МЕХАНИКИ</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:14}}>
          {[
            {icon:'🎤',name:'Дебаты',desc:'60 сек перед голосованием. Каждый игрок защищает себя по очереди, пока таймер тикает.'},
            {icon:'📊',name:'История голосований',desc:'После раунда все видят кто за кого голосовал — никаких тайн!'},
            {icon:'🎭',name:'Роли',desc:'Лидер (x2 голос), Медик (спасает), Саботажник (хочет проиграть), Шпион — раскрываются в финале.'},
            {icon:'📡',name:'Радиопереговоры',desc:'Приватный чат с любым игроком. Договаривайся тайно прямо во время раунда.'},
            {icon:'🗺️',name:'Карта бункера',desc:'Комнаты бункера дают бонусы. Медпункт, Лаборатория, Ферма — каждый получает свою.'},
          ].map(m=>(
            <div key={m.name} style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad-sm)',padding:'14px 12px'}}>
              <div style={{fontSize:22,marginBottom:6}}>{m.icon}</div>
              <div style={{fontSize:13,fontWeight:700,color:'var(--tx)',marginBottom:4}}>{m.name}</div>
              <div style={{fontSize:11,color:'var(--tx3)',lineHeight:1.5}}>{m.desc}</div>
            </div>
          ))}
        </div>

        <div className="lbl">СОВЕТЫ</div>
        {[
          ['💡','Раскрывай сначала сильные карточки — сформируй первое впечатление'],
          ['🤫','Не спеши с секретной картой — лучший момент — на грани выбывания'],
          ['👥','Объединяйся с другими игроками против явных угроз'],
          ['🎭','Можно блефовать — никто не знает твои закрытые карты'],
        ].map(([icon,text])=>(
          <div key={text} style={{display:'flex',gap:10,alignItems:'flex-start',padding:'10px 12px',background:'rgba(255,255,255,0.03)',border:'1px solid rgba(255,255,255,0.06)',borderRadius:'var(--rad-sm)',marginBottom:6}}>
            <span style={{fontSize:15,flexShrink:0}}>{icon}</span>
            <div style={{fontSize:12,color:'var(--tx2)',lineHeight:1.5}}>{text}</div>
          </div>
        ))}

        <div style={{height:8}}/>
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   PROFILE
══════════════════════════════════════════════════════════ */
/* ══════════════════════════════════════════════════════════
   CONFIRM DIALOG (мобильный замена confirm())
══════════════════════════════════════════════════════════ */
function ConfirmDialog({msg, onYes, onNo}){
  return(
    <div style={{position:'fixed',inset:0,zIndex:9999,background:'rgba(0,0,0,0.7)',display:'flex',alignItems:'center',justifyContent:'center',padding:24}} onClick={onNo}>
      <div style={{background:'var(--s1)',border:'1px solid rgba(255,255,255,0.12)',borderRadius:'var(--rad-lg)',padding:24,maxWidth:320,width:'100%',backdropFilter:'var(--bl)',WebkitBackdropFilter:'var(--bl)'}} onClick={e=>e.stopPropagation()}>
        <div style={{fontSize:15,color:'var(--tx)',lineHeight:1.6,marginBottom:20,textAlign:'center'}}>{msg}</div>
        <div style={{display:'flex',gap:10}}>
          <button onClick={onNo} style={{flex:1,padding:'12px',borderRadius:'var(--rad-sm)',border:'1px solid rgba(255,255,255,0.12)',background:'rgba(255,255,255,0.07)',color:'var(--tx2)',fontSize:14,fontWeight:600,cursor:'pointer',fontFamily:"'Inter',sans-serif"}}>Отмена</button>
          <button onClick={onYes} style={{flex:1,padding:'12px',borderRadius:'var(--rad-sm)',border:'none',background:'var(--a)',color:'#000',fontSize:14,fontWeight:700,cursor:'pointer',fontFamily:"'Inter',sans-serif"}}>Раскрыть</button>
        </div>
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   SHOP SCREEN
══════════════════════════════════════════════════════════ */
function ShopScreen({user, onBack, toast, onUpdate}){
  const [tab, setTab] = useState('packs');
  const [coins, setCoins] = useState(user.coins || 0);
  const [purchased, setPurchased] = useState({});
  const [equipped, setEquipped] = useState({});
  const [loading, setLoading] = useState(true);
  const [buying, setBuying] = useState(null);
  const [confirmItem, setConfirmItem] = useState(null);

  useEffect(()=>{
    Promise.all([
      DB.getPurchased(user.username),
      DB.getEquipped(user.username),
    ]).then(async ([pur, eq])=>{
      // fx_classic всегда куплен (бесплатно), сохраняем в БД если ещё нет
      if(!pur['fx_classic']){
        await DB.addPurchased(user.username, 'fx_classic');
        pur = {...pur, fx_classic: true};
      }
      // pack_default всегда куплен (бесплатно)
      if(!pur['pack_default']){
        await DB.addPurchased(user.username, 'pack_default');
        pur = {...pur, pack_default: true};
      }
      setPurchased(pur);
      setEquipped(eq);
      setLoading(false);
    });
  },[]);

  const refreshCoins = async () => {
    const u = await DB.getUser(user.username);
    const c = u?.coins || 0;
    setCoins(c);
    if(onUpdate) onUpdate({...user, coins: c, purchased: u?.purchased, equipped: u?.equipped});
  };

  const checkShopAchievements = async (newPurchased) => {
    const ud = await DB.getUser(user.username);
    if(!ud) return;
    const count = Object.keys(newPurchased).length;
    await checkAndAwardAchievements(user.username, {...ud, purchased: newPurchased}, null);
  };

  const buy = async (item, slot) => {
    if(purchased[item.id]){ equip(item, slot); return; }
    if(item.price === 0){ 
      await DB.addPurchased(user.username, item.id);
      const np = {...purchased,[item.id]:true};
      setPurchased(np);
      await equip(item, slot);
      await checkShopAchievements(np);
      return;
    }
    setConfirmItem({item, slot});
  };

  const confirmBuy = async () => {
    const {item, slot} = confirmItem;
    setConfirmItem(null);
    setBuying(item.id);
    const ok = await DB.spendCoins(user.username, item.price);
    if(!ok){ toast('Недостаточно монет ☠️','err'); setBuying(null); return; }
    await DB.addPurchased(user.username, item.id);
    const np = {...purchased,[item.id]:true};
    setPurchased(np);
    await refreshCoins();
    toast(`✅ Куплено: ${item.name}!`,'ok');
    await equip(item, slot);
    await checkShopAchievements(np);
    setBuying(null);
  };

  const equip = async (item, slot) => {
    if(!slot) return;
    await DB.setEquipped(user.username, slot, item.id);
    setEquipped(e=>({...e,[slot]:item.id}));
    // Применяем аватар сразу
    if(slot === 'avatar'){
      const emoji = item.emoji || item.icon;
      await db.ref(`users/${user.username}/avatar`).set(emoji);
      if(onUpdate) onUpdate({...user, avatar: emoji});
      toast(`🎨 Аватар надет: ${emoji}`,'ok');
    } else if(slot === 'frame'){
      toast(`🖼 Рамка применена: ${item.name}`,'ok');
    } else if(slot === 'cardEffect'){
      toast(`🃏 Эффект карт: ${item.name}`,'ok');
      if(onUpdate) onUpdate({...user, equipped: {...(user.equipped||{}), cardEffect: item.id}});
    } else if(slot === 'pack'){
      toast(`📦 Пак активирован: ${item.name}`,'ok');
    }
  };

  const RarityBadge = ({rarity}) => (
    <span style={{fontSize:9,fontWeight:700,color:RARITY_COLORS[rarity],background:RARITY_COLORS[rarity]+'20',border:`1px solid ${RARITY_COLORS[rarity]}40`,borderRadius:8,padding:'1px 6px',letterSpacing:0.5}}>
      {RARITY_LABELS[rarity]}
    </span>
  );

  const ItemCard = ({item, slot, equipped: isEquipped, owned}) => {
    const isBuying = buying === item.id;
    return(
      <div style={{
        background: isEquipped ? `${item.color||'#f0a500'}14` : 'rgba(255,255,255,0.04)',
        border: `1px solid ${isEquipped ? (item.color||'#f0a500')+'66' : owned ? 'rgba(255,255,255,0.15)' : 'rgba(255,255,255,0.08)'}`,
        borderRadius:'var(--rad)',
        padding:14,
        display:'flex',
        flexDirection:'column',
        alignItems:'center',
        gap:8,
        position:'relative',
        transition:'.2s',
      }}>
        {isEquipped && <div style={{position:'absolute',top:6,right:6,fontSize:9,fontWeight:700,color:item.color||'#f0a500',background:(item.color||'#f0a500')+'22',border:`1px solid ${item.color||'#f0a500'}44`,borderRadius:8,padding:'1px 6px'}}>НАДЕТ</div>}
        <div style={{fontSize:36}}>{item.emoji||item.icon||item.preview}</div>
        <div style={{textAlign:'center'}}>
          <div style={{fontSize:13,fontWeight:700,color:'var(--tx)',marginBottom:3}}>{item.name}</div>
          {item.description && <div style={{fontSize:10,color:'var(--tx3)',lineHeight:1.4,marginBottom:4}}>{item.description.slice(0,60)}{item.description.length>60?'…':''}</div>}
          {item.desc && <div style={{fontSize:10,color:'var(--tx3)',lineHeight:1.4,marginBottom:4}}>{item.desc}</div>}
          <RarityBadge rarity={item.rarity||'common'}/>
        </div>
        <button
          disabled={isBuying}
          onClick={()=>buy(item, slot)}
          style={{
            width:'100%',padding:'9px 0',borderRadius:'var(--rad-sm)',border:'none',
            background: isEquipped ? 'rgba(255,255,255,0.07)' : owned ? `${item.color||'#30d158'}22` : item.price===0 ? 'var(--g)' : 'var(--a)',
            color: isEquipped ? 'var(--tx3)' : owned ? (item.color||'#30d158') : item.price===0 ? '#000' : '#000',
            fontSize:13,fontWeight:700,cursor: isEquipped ? 'default' : 'pointer',
            fontFamily:"'Inter',sans-serif",transition:'.15s',
          }}>
          {isBuying ? '⏳' : isEquipped ? '✓ Надет' : owned ? '▶ Надеть' : item.price===0 ? '🆓 Бесплатно' : `🪙 ${item.price}`}
        </button>
      </div>
    );
  };

  if(loading) return <div className="sc"><div className="tb"><BackBtn onClick={onBack}/><div className="tb-title">МАГАЗИН</div></div><Spin/></div>;

  return(
    <div className="sc">
      {confirmItem && (
        <div style={{position:'fixed',inset:0,zIndex:9999,background:'rgba(0,0,0,0.75)',display:'flex',alignItems:'center',justifyContent:'center',padding:24}} onClick={()=>setConfirmItem(null)}>
          <div style={{background:'var(--s1)',border:'1px solid rgba(255,255,255,0.12)',borderRadius:'var(--rad-lg)',padding:24,maxWidth:320,width:'100%'}} onClick={e=>e.stopPropagation()}>
            <div style={{textAlign:'center',marginBottom:16}}>
              <div style={{fontSize:48,marginBottom:8}}>{confirmItem.item.emoji||confirmItem.item.icon||confirmItem.item.preview}</div>
              <div style={{fontSize:16,fontWeight:700,color:'var(--tx)',marginBottom:4}}>{confirmItem.item.name}</div>
              <div style={{fontSize:13,color:'var(--tx3)',marginBottom:12,lineHeight:1.5}}>{confirmItem.item.description||confirmItem.item.desc}</div>
              <div style={{fontSize:18,fontWeight:700,color:'var(--a)'}}>🪙 {confirmItem.item.price} монет</div>
              <div style={{fontSize:11,color:'var(--tx3)',marginTop:4}}>У вас: 🪙 {coins}</div>
            </div>
            <div style={{display:'flex',gap:10}}>
              <button onClick={()=>setConfirmItem(null)} style={{flex:1,padding:12,borderRadius:'var(--rad-sm)',border:'1px solid rgba(255,255,255,0.12)',background:'rgba(255,255,255,0.07)',color:'var(--tx2)',fontSize:14,fontWeight:600,cursor:'pointer',fontFamily:"'Inter',sans-serif"}}>Отмена</button>
              <button onClick={confirmBuy} disabled={coins<confirmItem.item.price} style={{flex:1,padding:12,borderRadius:'var(--rad-sm)',border:'none',background:coins>=confirmItem.item.price?'var(--a)':'rgba(255,255,255,0.07)',color:coins>=confirmItem.item.price?'#000':'var(--tx3)',fontSize:14,fontWeight:700,cursor:coins>=confirmItem.item.price?'pointer':'not-allowed',fontFamily:"'Inter',sans-serif"}}>
                {coins>=confirmItem.item.price?'Купить':'Мало монет'}
              </button>
            </div>
          </div>
        </div>
      )}
      <HZ/>
      <div className="tb">
        <BackBtn onClick={onBack}/>
        <div className="tb-title">🏪 МАГАЗИН</div>
        <div style={{display:'flex',alignItems:'center',gap:6,background:'rgba(240,165,0,0.12)',border:'1px solid rgba(240,165,0,0.3)',borderRadius:20,padding:'4px 12px'}}>
          <span style={{fontSize:14}}>🪙</span>
          <span style={{fontSize:14,fontWeight:700,color:'var(--a)'}}>{coins}</span>
        </div>
      </div>

      {/* Как заработать монеты */}
      <div style={{margin:'0 0 0 0',padding:'10px 16px',background:'rgba(240,165,0,0.06)',borderBottom:'1px solid rgba(240,165,0,0.12)',flexShrink:0}}>
        <div style={{fontSize:10,color:'var(--tx3)',lineHeight:1.6}}>
          💡 Зарабатывай монеты: <span style={{color:'var(--g)'}}>+30 за игру</span> · <span style={{color:'var(--a)'}}>+100 за победу</span> · <span style={{color:'var(--c)'}}>+10 за раскрытую карту</span>
        </div>
      </div>

      <div className="tabs" style={{padding:'8px 16px 0',flexShrink:0}}>
        {[['packs','📦 Паки'],['avatars','🎭 Аватары'],['frames','🖼 Рамки'],['effects','✨ Эффекты']].map(([k,l])=>(
          <button key={k} className={`tab${tab===k?' on':''}`} onClick={()=>setTab(k)}>{l}</button>
        ))}
      </div>

      <div className="scr" style={{paddingTop:12}}>
        {/* ── ПАКИ ── */}
        {tab==='packs'&&(
          <>
            <div style={{fontSize:11,color:'var(--tx3)',marginBottom:12,lineHeight:1.6,background:'rgba(255,255,255,0.03)',borderRadius:'var(--rad-sm)',padding:'10px 12px',border:'1px solid rgba(255,255,255,0.07)'}}>
              🃏 Тематические паки расширяют профессии, снаряжение и факты в игре. Активированный пак используется в новых играх.
            </div>
            {CARD_PACKS.map(pack=>{
              const owned = !!purchased[pack.id];
              const isEquipped = equipped.pack === pack.id;
              return(
                <div key={pack.id} style={{
                  background: isEquipped ? `${pack.color}12` : 'rgba(255,255,255,0.04)',
                  border:`1px solid ${isEquipped?pack.color+'55':'rgba(255,255,255,0.1)'}`,
                  borderRadius:'var(--rad)',padding:16,marginBottom:10,
                }}>
                  <div style={{display:'flex',alignItems:'flex-start',gap:12,marginBottom:12}}>
                    <div style={{fontSize:36,flexShrink:0}}>{pack.icon}</div>
                    <div style={{flex:1}}>
                      <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:4,flexWrap:'wrap'}}>
                        <span style={{fontSize:16,fontWeight:700,color:pack.color}}>{pack.name}</span>
                        {isEquipped&&<span style={{fontSize:9,fontWeight:700,color:pack.color,background:pack.color+'22',border:`1px solid ${pack.color}44`,borderRadius:8,padding:'1px 6px'}}>АКТИВЕН</span>}
                      </div>
                      <div style={{fontSize:12,color:'var(--tx3)',lineHeight:1.5,marginBottom:6}}>{pack.description}</div>
                      <div style={{fontSize:10,color:'var(--tx3)'}}>👷 {pack.professions.length} профессий · 🎒 {pack.baggage.length} снаряжений · 📖 {pack.facts.length} фактов</div>
                    </div>
                  </div>
                  {/* Превью профессий */}
                  <div style={{display:'flex',flexWrap:'wrap',gap:4,marginBottom:12}}>
                    {pack.professions.slice(0,5).map((p,i)=>(
                      <span key={i} style={{fontSize:10,color:'var(--tx2)',background:'rgba(255,255,255,0.06)',borderRadius:6,padding:'2px 7px'}}>{p}</span>
                    ))}
                    {pack.professions.length>5&&<span style={{fontSize:10,color:'var(--tx3)',padding:'2px 4px'}}>+{pack.professions.length-5} ещё</span>}
                  </div>
                  <button
                    disabled={!!buying}
                    onClick={()=>buy(pack,'pack')}
                    style={{
                      width:'100%',padding:'11px',borderRadius:'var(--rad-sm)',border:'none',
                      background: isEquipped?'rgba(255,255,255,0.07)': owned?`${pack.color}22`:`${pack.color}`,
                      color: isEquipped?'var(--tx3)': owned?pack.color:'#000',
                      fontSize:14,fontWeight:700,cursor: isEquipped?'default':'pointer',
                      fontFamily:"'Inter',sans-serif",transition:'.15s',
                    }}>
                    {isEquipped?'✓ Активен':owned?`▶ Активировать`:buying===pack.id?'⏳…':pack.price===0?'🆓 Получить бесплатно':`🪙 ${pack.price} — Купить пак`}
                  </button>
                </div>
              );
            })}
          </>
        )}

        {/* ── АВАТАРЫ ── */}
        {tab==='avatars'&&(
          <>
            <div style={{fontSize:11,color:'var(--tx3)',marginBottom:12,lineHeight:1.6,background:'rgba(255,255,255,0.03)',borderRadius:'var(--rad-sm)',padding:'10px 12px',border:'1px solid rgba(255,255,255,0.07)'}}>
              🎭 Премиум-аватары отображаются в профиле, чате и таблице лидеров. Купленный аватар надевается мгновенно.
            </div>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8}}>
              {PREMIUM_AVATARS.map(av=>(
                <ItemCard key={av.id} item={av} slot="avatar"
                  equipped={equipped.avatar===av.id}
                  owned={!!purchased[av.id]}/>
              ))}
            </div>
          </>
        )}

        {/* ── РАМКИ ── */}
        {tab==='frames'&&(
          <>
            <div style={{fontSize:11,color:'var(--tx3)',marginBottom:12,lineHeight:1.6,background:'rgba(255,255,255,0.03)',borderRadius:'var(--rad-sm)',padding:'10px 12px',border:'1px solid rgba(255,255,255,0.07)'}}>
              🖼 Рамки профиля — декоративная обводка вокруг вашего аватара. Видна всем игрокам.
            </div>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}>
              {PROFILE_FRAMES.map(frame=>{
                const owned = !!purchased[frame.id];
                const isEquipped = equipped.frame === frame.id;
                return(
                  <div key={frame.id} style={{
                    background: isEquipped?`${frame.color}14`:'rgba(255,255,255,0.04)',
                    border:`1px solid ${isEquipped?frame.color+'55':'rgba(255,255,255,0.08)'}`,
                    borderRadius:'var(--rad)',padding:14,
                    display:'flex',flexDirection:'column',alignItems:'center',gap:8,
                  }}>
                    {/* Превью рамки */}
                    <div style={{width:56,height:56,borderRadius:'50%',background:frame.gradient,display:'flex',alignItems:'center',justifyContent:'center',padding:3,flexShrink:0}}>
                      <div style={{width:'100%',height:'100%',borderRadius:'50%',background:'var(--bg)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:22}}>☢️</div>
                    </div>
                    <div style={{textAlign:'center'}}>
                      <div style={{fontSize:12,fontWeight:700,color:'var(--tx)',marginBottom:3}}>{frame.name}</div>
                      <span style={{fontSize:9,fontWeight:700,color:RARITY_COLORS[frame.rarity],background:RARITY_COLORS[frame.rarity]+'20',border:`1px solid ${RARITY_COLORS[frame.rarity]}40`,borderRadius:8,padding:'1px 6px'}}>{RARITY_LABELS[frame.rarity]}</span>
                    </div>
                    <button onClick={()=>buy(frame,'frame')} disabled={!!buying} style={{
                      width:'100%',padding:'8px 0',borderRadius:'var(--rad-sm)',border:'none',
                      background: isEquipped?'rgba(255,255,255,0.07)': owned?`${frame.color}22`:'var(--a)',
                      color: isEquipped?'var(--tx3)': owned?frame.color:'#000',
                      fontSize:12,fontWeight:700,cursor:isEquipped?'default':'pointer',
                      fontFamily:"'Inter',sans-serif",
                    }}>
                      {isEquipped?'✓ Надет': owned?'▶ Надеть':`🪙 ${frame.price}`}
                    </button>
                  </div>
                );
              })}
            </div>
          </>
        )}

        {/* ── ЭФФЕКТЫ КАРТ ── */}
        {tab==='effects'&&(
          <>
            <div style={{fontSize:11,color:'var(--tx3)',marginBottom:12,lineHeight:1.6,background:'rgba(255,255,255,0.03)',borderRadius:'var(--rad-sm)',padding:'10px 12px',border:'1px solid rgba(255,255,255,0.07)'}}>
              ✨ Эффекты меняют стиль ваших карточек в игре. Видны вашим соперникам.
            </div>
            {CARD_EFFECTS.map(fx=>{
              const cfx=getCardEffectStyle(fx.id);
              const isEquipped=equipped.cardEffect===fx.id;
              const owned=!!purchased[fx.id];
              return(
                <div key={fx.id} style={{marginBottom:10,background:isEquipped?`${fx.color}12`:'rgba(255,255,255,0.03)',border:`1.5px solid ${isEquipped?fx.color+'55':'rgba(255,255,255,0.08)'}`,borderRadius:'var(--rad)',overflow:'hidden',transition:'.2s'}}>
                  {/* Превью карточки */}
                  <div style={{padding:'14px 14px 10px',position:'relative'}}>
                    <div style={{display:'flex',gap:8,marginBottom:10}}>
                      {/* Мини-превью закрытой карты */}
                      <div style={{flex:1,height:64,background:cfx.cardBg,border:`1px solid ${cfx.cardBorder}`,borderRadius:8,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:4,boxShadow:cfx.glow||'none',position:'relative',overflow:'hidden'}}>
                        {cfx.overlay&&<div style={{position:'absolute',inset:0,background:cfx.overlay}}/>}
                        <div style={{fontSize:16,filter:'blur(4px)',opacity:0.4,position:'relative'}}>💼</div>
                        <div style={{fontSize:7,color:'rgba(255,255,255,0.4)',fontWeight:600,letterSpacing:0.5,position:'relative'}}>ЗАКРЫТА</div>
                      </div>
                      {/* Мини-превью открытой карты */}
                      <div style={{flex:1,height:64,background:cfx.revBg,border:`1px solid ${cfx.revBorder}`,borderRadius:8,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:4,boxShadow:cfx.glow||'none',position:'relative',overflow:'hidden'}}>
                        {cfx.overlay&&<div style={{position:'absolute',inset:0,background:cfx.overlay}}/>}
                        <div style={{fontSize:16,position:'relative'}}>💼</div>
                        <div style={{fontSize:8,color:'rgba(255,255,255,0.7)',fontWeight:600,position:'relative'}}>Инженер</div>
                        <div style={{position:'absolute',top:4,right:4,fontSize:7,fontWeight:700,color:'var(--g)',background:'rgba(48,209,88,0.15)',border:'1px solid rgba(48,209,88,0.3)',borderRadius:3,padding:'1px 4px'}}>✓</div>
                      </div>
                    </div>
                    {/* Инфо */}
                    <div style={{display:'flex',alignItems:'center',gap:8}}>
                      <div style={{flex:1}}>
                        <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:3}}>
                          <span style={{fontSize:14,fontWeight:700,color:'var(--tx)'}}>{fx.name}</span>
                          {isEquipped&&<span style={{fontSize:8,fontWeight:700,color:fx.color,background:fx.color+'22',border:`1px solid ${fx.color}44`,borderRadius:6,padding:'1px 5px'}}>АКТИВЕН</span>}
                        </div>
                        <div style={{fontSize:11,color:'var(--tx3)',marginBottom:4}}>{fx.desc}</div>
                        <span style={{fontSize:9,fontWeight:700,color:RARITY_COLORS[fx.rarity],background:RARITY_COLORS[fx.rarity]+'20',border:`1px solid ${RARITY_COLORS[fx.rarity]}40`,borderRadius:6,padding:'1px 6px'}}>{RARITY_LABELS[fx.rarity]}</span>
                      </div>
                    </div>
                  </div>
                  <div style={{padding:'0 14px 14px'}}>
                    <button onClick={()=>buy(fx,'cardEffect')} disabled={!!buying} style={{width:'100%',padding:'9px',borderRadius:'var(--rad-sm)',border:'none',background:isEquipped?'rgba(255,255,255,0.07)':owned?`${fx.color}22`:`${fx.color}`,color:isEquipped?'var(--tx3)':owned?fx.color:'#000',fontSize:12,fontWeight:700,cursor:isEquipped?'default':'pointer',fontFamily:"'Inter',sans-serif",transition:'.15s'}}>
                      {isEquipped?'✓ Активен':owned?'▶ Надеть':buying===fx.id?'⏳…':fx.price===0?'🆓 Бесплатно':`🪙 ${fx.price}`}
                    </button>
                  </div>
                </div>
              );
            })}
          </>
        )}
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   DAILY QUESTS HELPERS
══════════════════════════════════════════════════════════ */
const QUEST_POOL=[
  {id:'play1',type:'play',goal:1,icon:'🎮',title:'Сыграй 1 игру',reward:50},
  {id:'play3',type:'play',goal:3,icon:'🎯',title:'Сыграй 3 игры',reward:150},
  {id:'win1',type:'win',goal:1,icon:'🏆',title:'Победи в игре',reward:100},
  {id:'win2',type:'win',goal:2,icon:'👑',title:'Победи 2 раза',reward:200},
  {id:'reveal',type:'reveal',goal:1,icon:'👁',title:'Раскрой карту',reward:30},
  {id:'secret',type:'secret',goal:1,icon:'🃏',title:'Активируй секрет',reward:75},
  {id:'chat',type:'chat',goal:3,icon:'💬',title:'Напиши 3 сообщения',reward:40},
  {id:'invite',type:'invite',goal:1,icon:'📨',title:'Пригласи друга в игру',reward:60},
];
function genDailyQuests(){
  const pool=[...QUEST_POOL].sort(()=>Math.random()-.5);
  return pool.slice(0,3).map(q=>({...q,progress:0,done:false}));
}
async function ensureDailyQuests(username){
  const today=new Date().toDateString();
  let qd=await DB.getDailyQuests(username);
  if(!qd||qd.date!==today){qd={date:today,quests:genDailyQuests()};await DB.saveDailyQuests(username,qd);}
  return qd;
}

/* ══════════════════════════════════════════════════════════
   DAILY QUESTS COMPONENT
══════════════════════════════════════════════════════════ */
function DailyQuestsPanel({user,toast}){
  const[qd,setQd]=useState(null);
  const[loading,setLoading]=useState(true);
  useEffect(()=>{
    ensureDailyQuests(user.username).then(d=>{setQd(d);setLoading(false);});
  },[user.username]);
  const allDone=qd&&qd.quests.every(q=>q.done);
  if(loading)return <Spin/>;
  return(
    <div style={{marginBottom:20}}>
      <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:12}}>
        <div style={{fontSize:18}}>📋</div>
        <div style={{flex:1}}>
          <div style={{fontSize:14,fontWeight:700,color:'var(--tx)'}}>Ежедневные задания</div>
          <div style={{fontSize:11,color:'var(--tx3)'}}>Обновляются каждый день в полночь</div>
        </div>
        {allDone&&<div style={{fontSize:10,fontWeight:700,color:'var(--g)',background:'rgba(48,209,88,0.12)',border:'1px solid rgba(48,209,88,0.3)',borderRadius:8,padding:'4px 10px'}}>✅ ВСЕ ВЫПОЛНЕНЫ</div>}
      </div>
      {qd&&qd.quests.map((q,i)=>{
        const pct=Math.min(100,Math.round((q.progress||0)/q.goal*100));
        return(
          <div key={q.id} style={{background:q.done?'rgba(48,209,88,0.07)':'rgba(255,255,255,0.04)',border:`1px solid ${q.done?'rgba(48,209,88,0.25)':'rgba(255,255,255,0.08)'}`,borderRadius:16,padding:'14px 16px',marginBottom:10,transition:'.3s',animation:`winCard .4s ease ${i*.1}s both`}}>
            <div style={{display:'flex',alignItems:'center',gap:12}}>
              <div style={{fontSize:26,width:40,textAlign:'center',flexShrink:0}}>{q.done?'✅':q.icon}</div>
              <div style={{flex:1,minWidth:0}}>
                <div style={{fontSize:13,fontWeight:600,color:q.done?'var(--g)':'var(--tx)',marginBottom:4}}>{q.title}</div>
                <div style={{height:4,background:'rgba(255,255,255,0.08)',borderRadius:4,overflow:'hidden',marginBottom:4}}>
                  <div style={{height:'100%',width:`${pct}%`,background:q.done?'var(--g)':'var(--a)',borderRadius:4,transition:'width .5s ease'}}/>
                </div>
                <div style={{fontSize:10,color:'var(--tx3)'}}>{q.progress||0}/{q.goal} {q.done&&'— выполнено!'}</div>
              </div>
              <div style={{flexShrink:0,textAlign:'right'}}>
                <div style={{fontSize:14,fontWeight:800,color:'var(--a)'}}>+{q.reward}</div>
                <div style={{fontSize:9,color:'var(--tx3)'}}>монет</div>
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   REFERRAL SECTION
══════════════════════════════════════════════════════════ */
function ReferralSection({user,toast}){
  const refCode=user.refCode||user.username.toUpperCase().slice(0,6);
  const refLink=`${window.location.origin}${window.location.pathname}?ref=${refCode}`;
  const [copied,setCopied]=useState(false);
  const copy=()=>{
    navigator.clipboard?.writeText(refLink).then(()=>{setCopied(true);setTimeout(()=>setCopied(false),2000);}).catch(()=>{
      const el=document.createElement('textarea');el.value=refLink;document.body.appendChild(el);el.select();document.execCommand('copy');document.body.removeChild(el);setCopied(true);setTimeout(()=>setCopied(false),2000);
    });
    if(navigator.vibrate)navigator.vibrate(30);
  };
  // Сохраняем refCode при первом открытии
  useEffect(()=>{
    if(!user.refCode)DB.updateUser(user.username,{refCode});
  },[]);
  return(
    <div style={{background:'linear-gradient(135deg,rgba(240,165,0,0.1),rgba(240,165,0,0.04))',border:'1px solid rgba(240,165,0,0.25)',borderRadius:20,padding:'18px 16px',marginBottom:20}}>
      <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:14}}>
        <div style={{fontSize:22}}>🔗</div>
        <div>
          <div style={{fontSize:14,fontWeight:700,color:'var(--a)'}}>Реферальная программа</div>
          <div style={{fontSize:11,color:'var(--tx3)'}}>Приглашай друзей — получай монеты</div>
        </div>
      </div>
      <div style={{display:'flex',gap:10,marginBottom:14}}>
        <div style={{flex:1,background:'rgba(0,0,0,0.3)',borderRadius:12,padding:'12px 14px',border:'1px solid rgba(255,255,255,0.1)'}}>
          <div style={{fontSize:9,color:'var(--tx3)',letterSpacing:1,fontWeight:700,marginBottom:4}}>ВАШ КОД</div>
          <div style={{fontSize:18,fontWeight:800,color:'var(--a)',letterSpacing:2,fontFamily:'monospace'}}>{refCode}</div>
        </div>
        <button onClick={copy} style={{padding:'0 20px',background:copied?'rgba(48,209,88,0.15)':'rgba(240,165,0,0.12)',border:`1px solid ${copied?'rgba(48,209,88,0.4)':'rgba(240,165,0,0.35)'}`,borderRadius:12,color:copied?'var(--g)':'var(--a)',fontWeight:700,fontSize:13,cursor:'pointer',transition:'.2s',flexShrink:0}}>
          {copied?'✓ Скопировано!':'📋 Копировать'}
        </button>
      </div>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}>
        <div style={{background:'rgba(255,255,255,0.04)',borderRadius:12,padding:'10px 12px',textAlign:'center'}}>
          <div style={{fontSize:20,fontWeight:800,color:'var(--a)'}}>{user.referrals||0}</div>
          <div style={{fontSize:10,color:'var(--tx3)',marginTop:2}}>Приглашённых</div>
        </div>
        <div style={{background:'rgba(255,255,255,0.04)',borderRadius:12,padding:'10px 12px',textAlign:'center'}}>
          <div style={{fontSize:20,fontWeight:800,color:'var(--a)'}}>🪙 {(user.referrals||0)*200}</div>
          <div style={{fontSize:10,color:'var(--tx3)',marginTop:2}}>Заработано</div>
        </div>
      </div>
      <div style={{marginTop:12,fontSize:11,color:'var(--tx3)',lineHeight:1.6,borderTop:'1px solid rgba(255,255,255,0.06)',paddingTop:10}}>
        <span style={{color:'var(--a)',fontWeight:700}}>+200 монет</span> вам · <span style={{color:'var(--a)',fontWeight:700}}>+100 монет</span> другу при регистрации по вашей ссылке
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   GAME HISTORY PANEL
══════════════════════════════════════════════════════════ */
function GameHistoryPanel({user}){
  const[history,setHistory]=useState(null);
  useEffect(()=>{
    DB.fetchGameHistory(user.username).then(setHistory);
  },[user.username]);
  if(!history)return <Spin/>;
  if(history.length===0)return(
    <div style={{textAlign:'center',padding:'24px 16px',color:'var(--tx3)',fontSize:12}}>
      <div style={{fontSize:32,marginBottom:8}}>🎮</div>
      Ещё нет завершённых игр
    </div>
  );
  return(
    <div>
      {history.map((g,i)=>{
        const d=new Date(g.ts);
        const dateStr=`${d.getDate()} ${['янв','фев','мар','апр','май','июн','июл','авг','сен','окт','ноя','дек'][d.getMonth()]}`;
        return(
          <div key={i} style={{display:'flex',alignItems:'center',gap:12,padding:'13px 14px',background:g.won?'rgba(48,209,88,0.06)':'rgba(255,255,255,0.03)',border:`1px solid ${g.won?'rgba(48,209,88,0.2)':'rgba(255,255,255,0.07)'}`,borderRadius:14,marginBottom:8,animation:`winCard .4s ease ${i*.05}s both`}}>
            <div style={{fontSize:24,flexShrink:0}}>{g.apocEmoji||'☢️'}</div>
            <div style={{flex:1,minWidth:0}}>
              <div style={{fontSize:13,fontWeight:600,color:'var(--tx)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{g.apoc||'Бункер'}</div>
              <div style={{fontSize:10,color:'var(--tx3)',marginTop:2}}>Раунд {g.rounds||1} · {g.players||'?'} игроков · {dateStr}</div>
            </div>
            <div style={{flexShrink:0,textAlign:'right'}}>
              <div style={{fontSize:11,fontWeight:700,color:g.won?'var(--g)':'var(--r)',background:g.won?'rgba(48,209,88,0.12)':'rgba(255,69,58,0.1)',border:`1px solid ${g.won?'rgba(48,209,88,0.3)':'rgba(255,69,58,0.25)'}`,borderRadius:8,padding:'3px 10px'}}>
                {g.won?'🏆 ПОБЕДА':'💀 ВЫБЫЛ'}
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   STATS PANEL
══════════════════════════════════════════════════════════ */
function StatsPanel({user}){
  const total=user.gamesPlayed||0;
  const wins=user.gamesWon||0;
  const elim=user.gamesEliminated||0;
  const winRate=total>0?Math.round(wins/total*100):0;
  const coins=user.coins||0;
  const refs=user.referrals||0;
  const stats=[
    {icon:'🎮',label:'Игр сыграно',value:total,color:'var(--c)'},
    {icon:'🏆',label:'Побед',value:wins,color:'var(--g)'},
    {icon:'💀',label:'Выбываний',value:elim,color:'var(--r)'},
    {icon:'📊',label:'Винрейт',value:`${winRate}%`,color:'var(--a)'},
    {icon:'🪙',label:'Монеты',value:coins,color:'#f5a623'},
    {icon:'⚡',label:'Эло рейтинг',value:user.elo||1000,color:'#4da6ff'},
    {icon:'🔗',label:'Рефералов',value:refs,color:'var(--p)'},
    {icon:'🎯',label:'Раскрытий карт',value:user.totalReveals||0,color:'var(--tx2)'},
  ];
  return(
    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:20}}>
      {stats.map(s=>(
        <div key={s.label} style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:16,padding:'14px 14px',display:'flex',flexDirection:'column',gap:4}}>
          <div style={{fontSize:20}}>{s.icon}</div>
          <div style={{fontSize:22,fontWeight:800,color:s.color,lineHeight:1}}>{s.value}</div>
          <div style={{fontSize:10,color:'var(--tx3)',fontWeight:600}}>{s.label}</div>
        </div>
      ))}
    </div>
  );
}

function ProfileScreen({user,onBack,toast,onUpdate}){
  const rank=getRank(user);
  const games=user.gamesPlayed||0;
  const wins=user.gamesWon||0;
  const elims=user.gamesEliminated||0;
  const winRate=games>0?Math.round(wins/games*100):0;
  const[editStatus,setEditStatus]=useState(false);
  const[statusVal,setStatusVal]=useState(user.status||'');
  const[showAvatarPicker,setShowAvatarPicker]=useState(false);
  const[selAvatar,setSelAvatar]=useState(user.avatar||'');
  const[profTab,setProfTab]=useState('info');

  const saveAvatar=async(emoji)=>{
    setSelAvatar(emoji);
    await DB.updateUser(user.username,{avatar:emoji});
    if(onUpdate)onUpdate({...user,avatar:emoji});
    setShowAvatarPicker(false);
    toast('🎨 Аватар обновлён!','ok');
  };
  const saveStatus=async()=>{
    const s=statusVal.slice(0,50);
    await DB.updateUser(user.username,{status:s});
    if(onUpdate)onUpdate({...user,status:s});
    setEditStatus(false);
    toast('Статус сохранён','ok');
  };
  const PROF_TABS=[['info','👤','Профиль'],['stats','📊','Статистика'],['history','🎮','История'],['quests','📋','Задания'],['ref','🔗','Рефералы']];
  return(
    <div className="sc">
      <div className="tb">
        <BackBtn onClick={onBack}/>
        <div className="tb-title">ПРОФИЛЬ</div>
        <div style={{fontSize:12,color:'var(--a)',fontWeight:700}}>🪙 {user.coins||0}</div>
      </div>
      {/* Вкладки */}
      <div style={{display:'flex',gap:0,borderBottom:'1px solid rgba(255,255,255,0.07)',background:'rgba(12,12,20,0.85)',flexShrink:0,overflow:'auto',scrollbarWidth:'none'}}>
        {PROF_TABS.map(([id,ico,label])=>(
          <button key={id} onClick={()=>setProfTab(id)} style={{flex:1,minWidth:60,padding:'12px 4px 10px',background:'none',border:'none',borderBottom:`2px solid ${profTab===id?'var(--a)':'transparent'}`,color:profTab===id?'var(--a)':'var(--tx3)',fontSize:9,fontWeight:700,letterSpacing:.5,cursor:'pointer',display:'flex',flexDirection:'column',alignItems:'center',gap:3,transition:'.15s',flexShrink:0}}>
            <span style={{fontSize:16}}>{ico}</span>{label}
          </button>
        ))}
      </div>
      <div className="scr">
        {/* ── ПРОФИЛЬ ── */}
        {profTab==='info'&&(
          <div>
            <LevelBar user={user}/>
            {/* Аватар блок */}
            <div style={{textAlign:'center',padding:'28px 0 20px',background:'rgba(255,255,255,0.03)',borderRadius:'var(--rad-lg)',marginBottom:14,border:'1px solid rgba(255,255,255,0.07)'}}>
              <Avatar name={user.displayName||user.username} size="lg" avatar={selAvatar||user.avatar} frame={user.equipped?.frame}/>
          <div style={{marginTop:8}}>
            <button onClick={()=>setShowAvatarPicker(p=>!p)} style={{background:'rgba(240,165,0,0.1)',border:'1px solid rgba(240,165,0,0.3)',color:'var(--a)',borderRadius:8,padding:'5px 12px',fontSize:12,cursor:'pointer',fontFamily:"'Inter',sans-serif"}}>🎨 Сменить аватар</button>
          </div>
          {showAvatarPicker&&(
            <div style={{padding:'0 16px'}}>
              <div className="avatar-picker-grid">
                {AVATARS.map(em=>(
                  <button key={em} className={`avatar-picker-btn${(selAvatar||user.avatar)===em?' selected':''}`} onClick={()=>saveAvatar(em)}>{em}</button>
                ))}
                {(selAvatar||user.avatar)&&<button className="avatar-picker-btn" onClick={()=>saveAvatar('')} title="Убрать аватар" style={{fontSize:12,color:'var(--tx3)'}}>✕</button>}
              </div>
            </div>
          )}
          <div style={{fontSize:20,fontWeight:700,color:'var(--tx)',marginBottom:4}}>{user.displayName||user.username}</div>
          <div style={{fontSize:12,color:'var(--tx3)',marginBottom:6}}>@{user.username}</div>
          {/* Status */}
          {editStatus?(
            <div style={{display:'flex',gap:6,alignItems:'center',justifyContent:'center',padding:'4px 16px',marginBottom:8}}>
              <input className="inp" style={{marginBottom:0,maxWidth:220,fontSize:13}} maxLength={50} value={statusVal} onChange={e=>setStatusVal(e.target.value)} placeholder="Статус (до 50 символов)..." autoFocus onKeyDown={e=>e.key==='Enter'&&saveStatus()}/>
              <button onClick={saveStatus} style={{background:'var(--a)',border:'none',borderRadius:'var(--rad-sm)',color:'#000',fontWeight:700,fontSize:12,padding:'6px 12px',cursor:'pointer'}}>✓</button>
              <button onClick={()=>{setEditStatus(false);setStatusVal(user.status||'');}} style={{background:'rgba(255,255,255,0.08)',border:'none',borderRadius:'var(--rad-sm)',color:'var(--tx2)',fontSize:12,padding:'6px 10px',cursor:'pointer'}}>✕</button>
            </div>
          ):(
            <div style={{display:'flex',alignItems:'center',justifyContent:'center',gap:6,marginBottom:8}}>
              <span style={{fontSize:12,color:user.status?'var(--tx2)':'var(--tx3)',fontStyle:user.status?'normal':'italic'}}>{user.status||'Нет статуса'}</span>
              <button onClick={()=>{setEditStatus(true);setStatusVal(user.status||'');}} style={{background:'rgba(255,255,255,0.08)',border:'none',borderRadius:6,color:'var(--tx3)',fontSize:11,padding:'2px 7px',cursor:'pointer'}}>✏️</button>
            </div>
          )}
          <div style={{display:'inline-flex',alignItems:'center',gap:6,background:`${rank.color}18`,border:`1px solid ${rank.color}44`,borderRadius:20,padding:'4px 14px'}}>
            <span style={{fontSize:16}}>{rank.icon}</span>
            <span style={{fontSize:12,fontWeight:700,color:rank.color}}>{rank.name}</span>
          </div>
        </div>
        {/* Статистика */}
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,marginBottom:14}}>
          {[['☢',games,'Игр','var(--a)'],[' 🏆',wins,'Побед','var(--g)'],['💀',elims,'Выбыл','var(--r)']].map(([ico,val,lbl,col])=>(
            <div key={lbl} style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad-sm)',padding:'14px 8px',textAlign:'center'}}>
              <div style={{fontSize:22,marginBottom:4}}>{ico}</div>
              <div style={{fontSize:24,fontWeight:700,color:col,lineHeight:1}}>{val}</div>
              <div style={{fontSize:10,color:'var(--tx3)',marginTop:4}}>{lbl}</div>
            </div>
          ))}
        </div>
        {/* Процент побед */}
        {games>0&&(
          <div style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad-sm)',padding:16,marginBottom:14}}>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:8}}>
              <span style={{fontSize:12,color:'var(--tx3)'}}>Процент побед</span>
              <span style={{fontSize:12,fontWeight:700,color:'var(--g)'}}>{winRate}%</span>
            </div>
            <div style={{height:6,background:'rgba(255,255,255,.08)',borderRadius:3,overflow:'hidden'}}>
              <div style={{height:'100%',width:`${winRate}%`,background:`linear-gradient(90deg,var(--g),#30d158)`,borderRadius:3,transition:'width .6s ease'}}/>
            </div>
          </div>
        )}
        {/* Тема */}
        <div className="lbl">🎨 ТЕМА ОФОРМЛЕНИЯ</div>
        <div style={{marginBottom:14}}><ThemeSwitcher/></div>
        {/* Достижения */}
        <div className="lbl">🏅 ДОСТИЖЕНИЯ</div>
        <AchievementsPanel userData={user}/>
        {/* Звания */}
        <div className="lbl">СИСТЕМА ЗВАНИЙ</div>
        {RANKS.filter(r=>!r.adminOnly||user.isAdmin).map(r=>{
          const cur=getRank(user).id===r.id;
          return(
            <div key={r.id} style={{display:'flex',alignItems:'center',gap:10,padding:'10px 14px',background:cur?`${r.color}12`:'rgba(255,255,255,0.03)',border:`1px solid ${cur?r.color+'44':'rgba(255,255,255,0.07)'}`,borderRadius:'var(--rad-sm)',marginBottom:6,opacity:cur?1:.5,transition:'.2s'}}>
              <span style={{fontSize:20}}>{r.icon}</span>
              <div style={{flex:1}}>
                <div style={{fontSize:13,fontWeight:600,color:cur?r.color:'var(--tx)'}}>{r.name}</div>
                <div style={{fontSize:11,color:'var(--tx3)'}}>{r.adminOnly?'Только администраторы':r.min===0?'Начальное звание':`от ${r.min} игр`}</div>
              </div>
              {cur&&<span style={{fontSize:10,fontWeight:700,color:r.color,background:`${r.color}20`,border:`1px solid ${r.color}40`,borderRadius:10,padding:'2px 8px'}}>ТЕКУЩЕЕ</span>}
            </div>
          );
        })}
          </div>
        )}
        {/* ── СТАТИСТИКА ── */}
        {profTab==='stats'&&<StatsPanel user={user}/>}
        {/* ── ИСТОРИЯ ── */}
        {profTab==='history'&&(
          <div>
            <div className="lbl">ПОСЛЕДНИЕ 10 ИГР</div>
            <GameHistoryPanel user={user}/>
          </div>
        )}
        {/* ── ЗАДАНИЯ ── */}
        {profTab==='quests'&&(
          <div>
            <DailyQuestsPanel user={user} toast={toast}/>
          </div>
        )}
        {/* ── РЕФЕРАЛЫ ── */}
        {profTab==='ref'&&(
          <div>
            <ReferralSection user={user} toast={toast}/>
          </div>
        )}
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   LEADERBOARD
══════════════════════════════════════════════════════════ */
function LeaderboardScreen({me,onBack,onViewProfile,online}){
  const[users,setU]=useState([]);
  const[loading,setL]=useState(true);
  const[sort,setS]=useState('gamesWon');
  const[search,setSearch]=useState('');
  const load=async(k)=>{setL(true);const all=await DB.getAllUsers();setU(Object.values(all).sort((a,b)=>(b[k]||0)-(a[k]||0)));setL(false);};
  useEffect(()=>{load('gamesWon');},[]);
  const medals=['🥇','🥈','🥉'];
  return(
    <div className="sc">
      <HZ/>
      <div className="tb"><BackBtn onClick={onBack}/><div className="tb-title">РЕЙТИНГ</div></div>
      <div className="scr">
        <div style={{position:'relative',marginBottom:12}}>
          <input className="inp" placeholder="🔍 Поиск игрока..." value={search} onChange={e=>setSearch(e.target.value)} style={{marginBottom:0,paddingRight:search?36:12}}/>
          {search&&<button onClick={()=>setSearch('')} style={{position:'absolute',right:10,top:'50%',transform:'translateY(-50%)',background:'none',border:'none',color:'var(--tx3)',fontSize:16,cursor:'pointer',lineHeight:1}}>✕</button>}
        </div>
        <div className="tabs" style={{flexWrap:'wrap',gap:4}}>
          {[['gamesWon','ПОБЕДЫ'],['gamesPlayed','ИГРЫ'],['gamesEliminated','ВЫБЫВАНИЯ'],['elo','🏅 ЭЛО']].map(([k,l])=>(
            <button key={k} className={`tab${sort===k?' on':''}`} onClick={()=>{setS(k);load(k);}}>{l}</button>
          ))}
        </div>
        {loading?<Spin/>:users.filter(u=>u&&u.username&&(sort!=='elo'||(u.eloGames||0)>0||(u.elo||0)!==1000)&&(!search||u.username.toLowerCase().includes(search.toLowerCase())||(u.displayName||'').toLowerCase().includes(search.toLowerCase()))).map((u,i)=>{
          const isMe=u.username===me.username;
          const isOnline=!!(online&&online[u.username]);
          const eloVal=u.elo||1000;
          const eloDelta=u.eloDelta||0;
          const eloTier=eloVal>=1800?{label:'💎 Легенда',color:'#a78bfa'}:eloVal>=1500?{label:'🏆 Мастер',color:'#f0a500'}:eloVal>=1200?{label:'🥇 Эксперт',color:'#4da6ff'}:eloVal>=1000?{label:'🥈 Опытный',color:'#30d158'}:{label:'🥉 Новичок',color:'#8e8e99'};
          return(
            <div key={u.username} className={`lb-row${isMe?' me':''}`} style={{cursor:!isMe?'pointer':'default'}} onClick={()=>!isMe&&onViewProfile&&onViewProfile(u.username)}>
              <div style={{fontFamily:"'Inter',sans-serif",fontSize:i<3?24:20,color:i<3?'var(--a)':'var(--tx3)',width:32,textAlign:'center',flexShrink:0}}>{medals[i]||(i+1)}</div>
              <div style={{flex:1}}>
                <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:3}}>
                  <span style={{fontSize:15,fontWeight:700}}>{u.displayName||u.username}</span>
                  {isMe&&<span className="bdg bdg-c" style={{fontSize:7}}>ВЫ</span>}
                  {isOnline&&<span style={{width:7,height:7,borderRadius:'50%',background:'var(--g)',boxShadow:'0 0 6px var(--g)',display:'inline-block',flexShrink:0}}/>}
                </div>
                {sort==='elo'
                  ?<span style={{fontSize:10,fontWeight:700,color:eloTier.color}}>{eloTier.label} · {u.eloGames||0} игр</span>
                  :<RChip user={u}/>
                }
              </div>
              <div style={{textAlign:'right'}}>
                {sort==='elo'?(
                  <>
                    <div style={{fontFamily:"'Share Tech Mono',monospace",fontSize:26,color:eloTier.color,fontWeight:700}}>{eloVal}</div>
                    {eloDelta!==0&&<div style={{fontSize:10,fontWeight:700,color:eloDelta>0?'var(--g)':'var(--r)'}}>{eloDelta>0?'+':''}{eloDelta}</div>}
                  </>
                ):(
                  <>
                    <div style={{fontFamily:"'Inter',sans-serif",fontSize:26,color:sort==='gamesWon'?'var(--g)':sort==='gamesEliminated'?'var(--r)':'var(--a)'}}>{u[sort]||0}</div>
                    <div className="mono" style={{fontSize:8,color:'var(--tx3)'}}>{sort==='gamesWon'?'побед':sort==='gamesPlayed'?'игр':'выбываний'}</div>
                  </>
                )}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   ADMIN PANEL
══════════════════════════════════════════════════════════ */
/* ══════════════════════════════════════════════════════════
   ADMIN GAMES LIST — детальные карточки игр
══════════════════════════════════════════════════════════ */
function AdminGamesList({games,me,endGame,toggleGameAdult}){
  const[expanded,setExpanded]=React.useState({});
  const toggle=id=>setExpanded(p=>({...p,[id]:!p[id]}));
  const sorted=Object.values(games).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

  const phaseColor=ph=>ph==='finished'?'var(--tx3)':ph==='voting'?'var(--r)':ph==='playing'?'var(--g)':'var(--c)';
  const phaseLabel=ph=>ph==='finished'?'Завершена':ph==='voting'?'Голосование':ph==='playing'?'Идёт игра':'Лобби';

  return(
    <div>
      {sorted.map(g=>{
        const players=Object.values(g.players||{});
        const alive=players.filter(p=>!p.isEliminated);
        const dead=players.filter(p=>p.isEliminated);
        const isOpen=expanded[g.id];
        return(
          <div key={g.id} style={{marginBottom:10,borderRadius:14,overflow:'hidden',border:'1px solid rgba(255,255,255,0.08)',background:'rgba(255,255,255,0.03)'}}>
            {/* Шапка карточки */}
            <div onClick={()=>toggle(g.id)} style={{display:'flex',alignItems:'center',gap:10,padding:'12px 14px',cursor:'pointer',userSelect:'none'}}>
              <div style={{flex:1,minWidth:0}}>
                <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:4,flexWrap:'wrap'}}>
                  <span style={{fontWeight:700,fontSize:15,color:'var(--a)',letterSpacing:1,fontFamily:'Inter,sans-serif'}}>{g.id}</span>
                  <span style={{fontSize:11,color:phaseColor(g.phase),background:`${phaseColor(g.phase)}18`,borderRadius:6,padding:'2px 8px',fontWeight:600}}>{phaseLabel(g.phase)}</span>
                  {g.adultMode&&<span style={{fontSize:10,color:'var(--r)',background:'rgba(255,69,58,0.12)',borderRadius:6,padding:'2px 7px',fontWeight:600}}>18+</span>}
                </div>
                <div style={{fontSize:11,color:'var(--tx2)'}}>
                  {g.apocalypse?.emoji} {g.apocalypse?.name} · Раунд {g.round||1} · 👥 {players.length} игроков
                </div>
              </div>
              <div style={{display:'flex',gap:6,alignItems:'center'}}>
                {g.phase==='lobby'&&<button onClick={e=>{e.stopPropagation();toggleGameAdult(g.id,!g.adultMode);}} style={{background:g.adultMode?'rgba(255,69,58,0.15)':'rgba(255,255,255,0.07)',border:'none',color:g.adultMode?'var(--r)':'var(--tx2)',borderRadius:8,fontSize:11,padding:'5px 10px',cursor:'pointer',fontWeight:600}}>🔞 {g.adultMode?'Вкл':'Выкл'}</button>}
                {g.phase!=='finished'&&<button onClick={e=>{e.stopPropagation();endGame(g.id);}} style={{background:'rgba(255,69,58,0.15)',border:'none',color:'var(--r)',borderRadius:8,fontSize:11,padding:'5px 10px',cursor:'pointer',fontWeight:600}}>■ Стоп</button>}
                <span style={{color:'var(--tx3)',fontSize:16,transition:'transform .2s',display:'inline-block',transform:isOpen?'rotate(180deg)':'rotate(0deg)'}}>⌄</span>
              </div>
            </div>

            {/* Развёрнутый блок с игроками */}
            {isOpen&&(
              <div style={{borderTop:'1px solid rgba(255,255,255,0.06)',padding:'12px 14px',animation:'fadeUp .15s ease'}}>
                {/* Живые игроки */}
                {alive.length>0&&(
                  <div style={{marginBottom:10}}>
                    <div style={{fontSize:10,color:'var(--g)',fontWeight:600,letterSpacing:1,marginBottom:8,textTransform:'uppercase'}}>✅ В живых ({alive.length})</div>
                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6}}>
                      {alive.map(p=>{
                        const cards=p.cards||{};
                        const revealed=p.revealed||[];
                        return(
                          <div key={p.username} style={{background:'rgba(48,209,88,0.05)',border:'1px solid rgba(48,209,88,0.15)',borderRadius:10,padding:'10px 12px'}}>
                            <div style={{fontWeight:700,fontSize:13,marginBottom:4,color:'var(--tx)'}}>{p.name||p.username}</div>
                            <div style={{fontSize:10,color:'var(--tx3)',marginBottom:6}}>@{p.username}{g.creatorId===p.username?' 👑':''}</div>
                            {cards.profession&&<div style={{fontSize:11,color:'var(--tx2)',marginBottom:2}}>💼 {cards.profession}{revealed.includes('profession')?' ✓':' 🔒'}</div>}
                            {cards.health&&<div style={{fontSize:11,color:'var(--tx2)',marginBottom:2}}>{cards.health[0]} {cards.health[1]}{revealed.includes('health')?' ✓':' 🔒'}</div>}
                            {cards.hobby&&<div style={{fontSize:11,color:'var(--tx2)',marginBottom:2}}>🎯 {cards.hobby}{revealed.includes('hobby')?' ✓':' 🔒'}</div>}
                            {cards.baggage&&<div style={{fontSize:11,color:'var(--tx2)',marginBottom:2}}>🎒 {cards.baggage}{revealed.includes('baggage')?' ✓':' 🔒'}</div>}
                            {cards.fact&&<div style={{fontSize:11,color:'var(--tx2)',marginBottom:2}}>📌 {cards.fact}{revealed.includes('fact')?' ✓':' 🔒'}</div>}
                            {cards.phobia&&<div style={{fontSize:11,color:'var(--tx2)',marginBottom:2}}>😱 {cards.phobia}{revealed.includes('phobia')?' ✓':' 🔒'}</div>}
                            <div style={{fontSize:9,color:'var(--tx3)',marginTop:4}}>Раскрыто: {revealed.length} карт</div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
                {/* Выбывшие */}
                {dead.length>0&&(
                  <div>
                    <div style={{fontSize:10,color:'var(--r)',fontWeight:600,letterSpacing:1,marginBottom:8,textTransform:'uppercase'}}>☠️ Выбыли ({dead.length})</div>
                    <div style={{display:'flex',flexDirection:'column',gap:4}}>
                      {dead.map(p=>(
                        <div key={p.username} style={{background:'rgba(255,69,58,0.05)',border:'1px solid rgba(255,69,58,0.12)',borderRadius:8,padding:'8px 12px',display:'flex',alignItems:'center',gap:8,opacity:0.7}}>
                          <span style={{fontSize:12}}>☠️</span>
                          <div>
                            <div style={{fontWeight:600,fontSize:12,color:'var(--tx2)'}}>{p.name||p.username}</div>
                            <div style={{fontSize:10,color:'var(--tx3)'}}>@{p.username}</div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                {players.length===0&&<div style={{textAlign:'center',color:'var(--tx3)',fontSize:12,padding:'12px 0'}}>Нет игроков</div>}
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
}

function SeasonalEventPanel({toast}){
  const EVENTS=[
    {id:'halloween',name:'🎃 Хеллоуин',color:'#ff6b35',desc:'Специальные карточки и ограниченные аватары',
     packs:['👻 Призрак','🧙‍♀️ Ведьма','🦇 Вампир','🎃 Тыква-голова','💀 Скелет'],
     frames:['frame_fire','frame_purple'],avatars:['prem_ghost','prem_witch']},
    {id:'newyear',name:'🎄 Новый год',color:'#30d158',desc:'Праздничные профессии и золотые рамки',
     packs:['🎅 Дед Мороз','🦌 Рудольф','⛄ Снеговик','🎁 Дарительница подарков','🧝 Эльф мастерской'],
     frames:['frame_gold','frame_ice'],avatars:['prem_snowman','prem_santa']},
    {id:'summer',name:'☀️ Лето',color:'#ffd60a',desc:'Пляжные профессии и летние эффекты',
     packs:['🏄 Серфингист','🐬 Тренер дельфинов','🍦 Мороженщик','🏖️ Спасатель пляжа','🎪 Аниматор отеля'],
     frames:['frame_ocean','frame_neon'],avatars:['prem_surfer','prem_mermaid']},
    {id:'space',name:'🚀 День космонавтики',color:'#4da6ff',desc:'Космические профессии и галактические рамки',
     packs:['👨‍🚀 Космонавт','🛸 Ксенобиолог','🌌 Астрофизик','🤖 ИИ-навигатор','🌍 Планетолог'],
     frames:['frame_galaxy','frame_cyber'],avatars:['prem_astronaut','prem_alien']},
    {id:'none',name:'❌ Нет события',color:'#666',desc:'Отключить сезонное событие',packs:[],frames:[],avatars:[]},
  ];
  const[current,setCurrent]=useState(null);
  const[loading,setLoading]=useState(true);
  const[saving,setSaving]=useState(false);
  useEffect(()=>{DB.getSeasonalEvent().then(e=>{setCurrent(e?.id||'none');setLoading(false);});},[]);
  const apply=async(ev)=>{
    setSaving(true);
    if(ev.id==='none'){await DB.setSeasonalEvent(null);}
    else{await DB.setSeasonalEvent({...ev,active:true,startedAt:Date.now()});}
    setCurrent(ev.id);setSaving(false);
    toast(`${ev.name} ${ev.id==='none'?'отключено':'активировано'}!`,'ok');
  };
  if(loading)return<Spin/>;
  return(
    <div style={{display:'flex',flexDirection:'column',gap:8}}>
      {EVENTS.map(ev=>{
        const isActive=current===ev.id;
        return(
          <div key={ev.id} style={{background:isActive?`${ev.color}14`:'rgba(255,255,255,0.04)',border:`1px solid ${isActive?ev.color+'55':'rgba(255,255,255,0.08)'}`,borderRadius:'var(--rad)',padding:'14px 16px',display:'flex',alignItems:'center',gap:12,transition:'.2s'}}>
            <div style={{flex:1}}>
              <div style={{fontSize:15,fontWeight:700,color:isActive?ev.color:'var(--tx)',marginBottom:3}}>{ev.name}</div>
              <div style={{fontSize:11,color:'var(--tx3)',lineHeight:1.4}}>{ev.desc}</div>
              {ev.packs.length>0&&isActive&&<div style={{fontSize:10,color:ev.color,marginTop:6,lineHeight:1.6}}>{ev.packs.slice(0,3).join(' · ')}</div>}
            </div>
            <button disabled={saving||isActive} onClick={()=>apply(ev)} style={{background:isActive?ev.color:'rgba(255,255,255,0.08)',border:'none',borderRadius:'var(--rad-sm)',color:isActive?'#000':'var(--tx)',fontSize:12,fontWeight:700,padding:'8px 14px',cursor:isActive?'default':'pointer',flexShrink:0,opacity:saving?0.5:1}}>
              {isActive?'✓ Активно':'Включить'}
            </button>
          </div>
        );
      })}
    </div>
  );
}

function LevelBar({user}){
  const xp=user.xp||0;
  const{level,currentXP,neededXP}=getLevel(xp);
  const pct=Math.min(100,Math.round(currentXP/neededXP*100));
  const nextReward=LEVEL_REWARDS.find(r=>r.level>level);
  return(
    <div style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad)',padding:'16px',marginBottom:12}}>
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:10}}>
        <div style={{display:'flex',alignItems:'center',gap:10}}>
          <div style={{width:44,height:44,borderRadius:12,background:'linear-gradient(135deg,var(--a),#ff6b00)',display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0}}>
            <span style={{fontSize:20,fontWeight:900,color:'#000'}}>{level}</span>
          </div>
          <div>
            <div style={{fontSize:14,fontWeight:700,color:'var(--a)'}}>Уровень {level}</div>
            <div style={{fontSize:10,color:'var(--tx3)',marginTop:1}}>{currentXP} / {neededXP} XP</div>
          </div>
        </div>
        <div style={{fontSize:11,color:'var(--tx3)',textAlign:'right'}}>
          {nextReward&&<><div style={{fontSize:10,color:'var(--tx3)'}}>Следующая награда</div><div style={{fontSize:11,color:'var(--a)',fontWeight:600,marginTop:2}}>{nextReward.reward}</div><div style={{fontSize:10,color:'var(--tx3)'}}>Ур. {nextReward.level}</div></>}
        </div>
      </div>
      <div style={{height:8,background:'rgba(255,255,255,0.08)',borderRadius:4,overflow:'hidden'}}>
        <div style={{height:'100%',width:`${pct}%`,background:'linear-gradient(90deg,var(--a),#ff6b00)',borderRadius:4,transition:'width .5s ease'}}/>
      </div>
      <div style={{display:'flex',justifyContent:'space-between',marginTop:6}}>
        <span style={{fontSize:10,color:'var(--tx3)'}}>Ур. {level}</span>
        <span style={{fontSize:10,color:'var(--tx3)'}}>{pct}%</span>
        <span style={{fontSize:10,color:'var(--tx3)'}}>Ур. {level+1}</span>
      </div>
    </div>
  );
}

function AdminScreen({me,onBack,toast}){
  const[tab,setTab]=useState('dash');
  const[users,setU]=useState({});
  const[games,setG]=useState({});
  const[settings,setS]=useState({});
  const[loading,setL]=useState(true);
  const[editUser,setEditUser]=useState(null);
  const[editDisplayName,setEditDisplayName]=useState('');
  const[editPassword,setEditPassword]=useState('');
  const[editElo,setEditElo]=useState('');
  const[editCoins,setEditCoins]=useState('');
  const[editXP,setEditXP]=useState('');
  const[showPass,setShowPass]=useState(false);
  const[selected,setSelected]=useState({});
  const[banTarget,setBanTarget]=useState(null);
  const[banReason,setBanReason]=useState('');
  const[broadcastText,setBroadcastText]=useState('');
  const[announcText,setAnnouncText]=useState('');
  const[adminLog,setAdminLog]=useState([]);
  const[winnerPick,setWinnerPick]=useState(null);
  const[pickedWinners,setPickedWinners]=useState({});

  const load=async()=>{const[u,g,s,al]=await Promise.all([DB.getAllUsers(),DB.getAllGames(),DB.getSettings(),DB.getAdminLog()]);setU(u);setG(g);setS(s);setAdminLog(al);setL(false);};
  const logA=(action,details)=>DB.logAdmin(me.username,action,details);
  useEffect(()=>{load();},[]);
  useEffect(()=>{
    const handler=(e)=>{if(e.key==='Escape'&&editUser)setEditUser(null);};
    window.addEventListener('keydown',handler);
    return()=>window.removeEventListener('keydown',handler);
  },[editUser]);

  const setRank=async(uname,rid)=>{
    const u=users[uname];const patch={customRank:rid||null};
    if(rid==='supreme')patch.isAdmin=true;
    else if(u.customRank==='supreme'&&rid!=='supreme')patch.isAdmin=false;
    await DB.updateUser(uname,patch);setU(p=>({...p,[uname]:{...p[uname],...patch}}));toast('✅ Звание обновлено!','ok');
  };
  const toggleAdmin=async(uname)=>{
    if(uname===me.username)return toast('Нельзя снять с себя','err');
    const u=users[uname];const na=!u.isAdmin;
    const patch={isAdmin:na,customRank:na?'supreme':(u.customRank==='supreme'?null:u.customRank)};
    await DB.updateUser(uname,patch);setU(p=>({...p,[uname]:{...p[uname],...patch}}));
    toast(na?'✅ Назначен админом':'✅ Права сняты','ok');
  };
  const delUser=async(uname)=>{
    if(uname===me.username)return toast('Нельзя удалить себя','err');
    if(!confirm(`Удалить @${uname}?`))return;
    await DB.deleteUser(uname);setU(p=>{const n={...p};delete n[uname];return n;});toast('✅ Удалён','ok');
  };
  const endGame=async(gid)=>{await DB.updateGame(gid,{phase:'finished'});setG(p=>({...p,[gid]:{...p[gid],phase:'finished'}}));toast('✅ Игра завершена','ok');};
  const toggleGameAdult=async(gid,val)=>{await DB.updateGame(gid,{adultMode:val});setG(p=>({...p,[gid]:{...p[gid],adultMode:val}}));toast(val?'🔞 18+ включён':'✅ 18+ выключен','ok');};
  const toggleGlobal=async()=>{
    const nv=!settings.adultMode;await DB.updateSettings({adultMode:nv});setS(p=>({...p,adultMode:nv}));
    toast(nv?'🔞 18+ включён — все игроки могут использовать':'✅ 18+ выключен глобально','ok');
  };
  const active=Object.values(games).filter(g=>g.phase!=='finished');

  return(
    <div className="sc">
      <HZ/>
      <div className="tb"><BackBtn onClick={onBack}/><div className="tb-title" style={{color:'var(--p)'}}>🔐 АДМИНИСТРАТОР</div></div>
      <div className="scr-raw">
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,marginBottom:14}}>
          {[[Object.keys(users).length,'ИГРОКИ','var(--a)'],[active.length,'АКТИВНЫЕ','var(--g)'],[Object.keys(games).length,'ВСЕГО','var(--tx3)']].map(([v,l,c])=>(
            <div key={l} className="stat-box"><div className="sv" style={{fontSize:26,color:c}}>{v}</div><div className="sl">{l}</div></div>
          ))}
        </div>
        <div className="tabs" style={{flexWrap:'wrap',gap:2}}>
          {[['dash','📊 ДАШБОРД'],['users','👥 ИГРОКИ'],['games','🎮 ИГРЫ'],['settings','⚙️ НАСТРОЙКИ'],['broadcast','📢 РАССЫЛКА'],['cheats','⚡ ЧИТЫ'],['log','📋 ЛОГ']].map(([id,label])=>(
            <button key={id} className={`tab${tab===id?' on':''}`} onClick={()=>setTab(id)} style={{fontSize:10,padding:'6px 10px'}}>{label}</button>
          ))}
        </div>
        {loading?<Spin/>:tab==='dash'?(
          <div>
            {/* Stats grid */}
            {(()=>{
              const uList=Object.values(users);
              const gList=Object.values(games);
              const active=gList.filter(g=>g.phase!=='finished');
              const today=Date.now()-86400000;
              const newToday=uList.filter(u=>u.createdAt>today).length;
              const totalGames=gList.filter(g=>g.phase==='finished').length;
              const banned=uList.filter(u=>u.isBanned).length;
              const topByWins=[...uList].sort((a,b)=>(b.gamesWon||0)-(a.gamesWon||0)).slice(0,3);
              const topByElo=[...uList].sort((a,b)=>(b.elo||0)-(a.elo||0)).slice(0,3);
              return(<>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:14}}>
                  {[[uList.length,'👥 Всего игроков','var(--a)'],[newToday,'🆕 Новых сегодня','var(--g)'],[active.length,'🎮 Активных игр','#4da6ff'],[totalGames,'✅ Завершено','var(--tx3)'],[banned,'🚫 Забанено','var(--r)'],[Object.values(users).filter(u=>u.eloGames>0).length,'🏅 Рейт. игроков','#f5a623']].map(([v,l,c])=>(
                    <div key={l} className="stat-box glass-card" style={{padding:'12px 14px'}}><div style={{fontSize:22,color:c,fontWeight:800}}>{v}</div><div style={{fontSize:10,color:'var(--tx3)',marginTop:2}}>{l}</div></div>
                  ))}
                </div>
                <div className="lbl">ТОП-3 ПО ПОБЕДАМ</div>
                {topByWins.map((u,i)=>(
                  <div key={u.username} style={{display:'flex',alignItems:'center',gap:10,padding:'8px 12px',background:'rgba(255,255,255,0.04)',borderRadius:8,marginBottom:6}}>
                    <span style={{fontSize:16}}>{['🥇','🥈','🥉'][i]}</span>
                    <Avatar name={u.displayName||u.username} avatar={u.avatar} size="sm" frame={u.equipped?.frame}/>
                    <div style={{flex:1}}><div style={{fontSize:13,fontWeight:600}}>{u.displayName||u.username}</div><div style={{fontSize:10,color:'var(--tx3)'}}>@{u.username}</div></div>
                    <div style={{fontSize:13,color:'var(--g)',fontWeight:700}}>{u.gamesWon||0} побед</div>
                  </div>
                ))}
                <div className="lbl" style={{marginTop:12}}>ТОП-3 ПО ЭЛО</div>
                {topByElo.map((u,i)=>(
                  <div key={u.username} style={{display:'flex',alignItems:'center',gap:10,padding:'8px 12px',background:'rgba(255,255,255,0.04)',borderRadius:8,marginBottom:6}}>
                    <span style={{fontSize:16}}>{['🥇','🥈','🥉'][i]}</span>
                    <Avatar name={u.displayName||u.username} avatar={u.avatar} size="sm" frame={u.equipped?.frame}/>
                    <div style={{flex:1}}><div style={{fontSize:13,fontWeight:600}}>{u.displayName||u.username}</div></div>
                    <div style={{fontSize:13,color:'#4da6ff',fontWeight:700}}>{u.elo||1000} Эло</div>
                  </div>
                ))}
              </>);
            })()}
          </div>
        ):tab==='broadcast'?(
          <div>
            <div className="lbl">📢 РАССЫЛКА ВСЕМ ОНЛАЙН</div>
            <div style={{fontSize:12,color:'var(--tx2)',marginBottom:10,lineHeight:1.6}}>Сообщение появится у всех онлайн-игроков как toast-уведомление на 10 секунд.</div>
            <textarea className="inp" rows={3} placeholder="Введите сообщение..." value={broadcastText} onChange={e=>setBroadcastText(e.target.value)} maxLength={200} style={{resize:'vertical',minHeight:80}}/>
            <Btn ch="📢 Отправить рассылку" onClick={async()=>{
              if(!broadcastText.trim())return toast('Введи сообщение','err');
              if(!confirm('Отправить сообщение всем онлайн-игрокам?'))return;
              await DB.sendBroadcast(me.displayName||me.username,broadcastText.trim());
              await logA('РАССЫЛКА',broadcastText.trim());
              setBroadcastText('');toast('✅ Рассылка отправлена!','ok');
              await load();
            }}/>
            <div className="lbl" style={{marginTop:20}}>📌 ОБЪЯВЛЕНИЕ НА ГЛАВНОЙ</div>
            <div style={{fontSize:12,color:'var(--tx2)',marginBottom:10,lineHeight:1.6}}>Закреплённый баннер на главном экране у всех игроков. Оставьте пустым — убрать.</div>
            <textarea className="inp" rows={3} placeholder="Текст объявления (пусто = убрать)..." value={announcText} onChange={e=>setAnnouncText(e.target.value)} maxLength={300} style={{resize:'vertical',minHeight:80}}/>
            <div style={{display:'flex',gap:8}}>
              <Btn ch="📌 Установить" onClick={async()=>{
                await DB.setAnnouncement(announcText.trim()||null);
                await logA('ОБЪЯВЛЕНИЕ',announcText.trim()||'(удалено)');
                toast('✅ Объявление обновлено!','ok');
              }}/>
              <Btn ch="✕ Убрать" cls="btn-g" sm onClick={async()=>{
                await DB.setAnnouncement(null);setAnnouncText('');
                await logA('ОБЪЯВЛЕНИЕ','(удалено)');
                toast('✅ Объявление убрано','ok');
              }}/>
            </div>
          </div>
        ):tab==='log'?(
          <div>
            <div className="lbl">📋 ЛОГ ДЕЙСТВИЙ АДМИНИСТРАТОРА</div>
            {adminLog.length===0?<div style={{textAlign:'center',padding:24,color:'var(--tx3)'}}>Нет записей</div>:adminLog.map((entry,i)=>{
              const d=new Date(entry.ts);
              const timeStr=`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
              return(
                <div key={i} style={{padding:'10px 12px',background:'rgba(255,255,255,0.03)',border:'1px solid rgba(255,255,255,0.07)',borderRadius:8,marginBottom:6}}>
                  <div style={{display:'flex',gap:8,alignItems:'center',marginBottom:3}}>
                    <span style={{fontSize:10,color:'var(--tx3)',fontFamily:"monospace"}}>{timeStr}</span>
                    <span style={{fontSize:10,color:'var(--a)',fontWeight:700,background:'rgba(240,165,0,0.1)',padding:'2px 6px',borderRadius:4}}>{entry.action}</span>
                    <span style={{fontSize:10,color:'var(--tx3)'}}>@{entry.adminId}</span>
                  </div>
                  {entry.details&&<div style={{fontSize:12,color:'var(--tx2)'}}>{entry.details}</div>}
                </div>
              );
            })}
          </div>
        ):tab==='games'?(
          <div>
            <div className="lbl">🎮 АКТИВНЫЕ ИГРЫ</div>
            {Object.values(games).filter(g=>g.phase!=='finished').length===0&&<div style={{textAlign:'center',padding:24,color:'var(--tx3)'}}>Нет активных игр</div>}
            {Object.values(games).filter(g=>g.phase!=='finished').map(g=>{
              const players=Object.values(g.players||{});
              const isWinnerPick=winnerPick===g.id;
              return(
                <div key={g.id} style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad)',padding:14,marginBottom:10}}>
                  <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
                    <span style={{fontSize:18}}>{g.apocalypse?.emoji||'🎮'}</span>
                    <div style={{flex:1}}><div style={{fontWeight:700,fontSize:14}}>{g.apocalypse?.name||g.id}</div><div style={{fontSize:10,color:'var(--tx3)'}}>Код: {g.id} · {players.length} игроков · {g.isRated?'🏅 Рейт':''}</div></div>
                    <span style={{fontSize:9,color:g.phase==='lobby'?'var(--c)':'var(--g)',fontFamily:'monospace',background:'rgba(255,255,255,0.05)',padding:'3px 6px',borderRadius:4}}>{g.phase==='lobby'?'ЛОББИ':g.phase==='playing'?'ИГРА':g.phase==='voting'?'ГОЛОСОВ':g.phase}</span>
                  </div>
                  <div style={{display:'flex',flexWrap:'wrap',gap:6,marginBottom:10}}>
                    {players.map(p=>(
                      <div key={p.username} style={{fontSize:10,background:isWinnerPick?(pickedWinners[p.username]?'rgba(48,209,88,0.2)':'rgba(255,255,255,0.05)'):'rgba(255,255,255,0.05)',border:`1px solid ${isWinnerPick?(pickedWinners[p.username]?'rgba(48,209,88,0.5)':'rgba(255,255,255,0.1)'):'rgba(255,255,255,0.1)'}`,borderRadius:6,padding:'3px 8px',cursor:isWinnerPick?'pointer':'default',transition:'.15s'}}
                        onClick={()=>{if(isWinnerPick)setPickedWinners(pw=>({...pw,[p.username]:!pw[p.username]}));}}>
                        {p.isEliminated?'☠️':'🟢'} {p.name||p.username}
                      </div>
                    ))}
                  </div>
                  <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
                    {!isWinnerPick&&<Btn ch="🏆 Выбрать победителей" sm cls="btn-c" onClick={()=>{setWinnerPick(g.id);const pw={};players.filter(p=>!p.isEliminated).forEach(p=>{pw[p.username]=true;});setPickedWinners(pw);}}/>}
                    {isWinnerPick&&<>
                      <Btn ch="✅ Подтвердить" sm cls="btn-g" onClick={async()=>{
                        const winners=Object.keys(pickedWinners).filter(k=>pickedWinners[k]);
                        if(!winners.length)return toast('Выбери хотя бы одного победителя','err');
                        if(!confirm(`Завершить игру, победители: ${winners.join(', ')}?`))return;
                        // Set all as eliminated, then unset winners
                        const patch={phase:'finished'};
                        players.forEach(p=>{patch[`players/${p.username}/isEliminated`]=!winners.includes(p.username);});
                        await DB.updateGame(g.id,patch);
                        await logA('ЗАВЕРШИЛ ИГРУ',`${g.id} победители: ${winners.join(', ')}`);
                        setWinnerPick(null);setPickedWinners({});toast('✅ Игра завершена!','ok');await load();
                      }}/>
                      <Btn ch="✕" sm cls="btn-g" onClick={()=>{setWinnerPick(null);setPickedWinners({});}}/>
                    </>}
                    {!isWinnerPick&&<Btn ch="⚡ Принудительно завершить" sm cls="btn-d" onClick={async()=>{
                      if(!confirm(`Принудительно завершить игру "${g.apocalypse?.name||g.id}"?`))return;
                      await DB.updateGame(g.id,{phase:'finished'});
                      await logA('ПРИНУДИТ. ЗАВЕРШИЛ',g.id);
                      toast('✅ Игра завершена','ok');await load();
                    }}/>}
                  </div>
                </div>
              );
            })}
            <div className="lbl" style={{marginTop:12}}>📜 ЗАВЕРШЁННЫЕ ИГРЫ</div>
            {Object.values(games).filter(g=>g.phase==='finished').slice(-5).reverse().map(g=>(
              <div key={g.id} style={{padding:'8px 12px',background:'rgba(255,255,255,0.02)',border:'1px solid rgba(255,255,255,0.05)',borderRadius:8,marginBottom:6,display:'flex',gap:10,alignItems:'center'}}>
                <span>{g.apocalypse?.emoji||'🎮'}</span>
                <div style={{flex:1}}><div style={{fontSize:12,color:'var(--tx2)'}}>{g.apocalypse?.name||g.id}</div><div style={{fontSize:10,color:'var(--tx3)'}}>{Object.keys(g.players||{}).length} игроков</div></div>
                <span style={{fontSize:9,color:'var(--tx3)',fontFamily:'monospace'}}>{g.createdAt?new Date(g.createdAt).toLocaleDateString('ru'):''}</span>
              </div>
            ))}
          </div>
        ):tab==='settings'?(
          <div>
            <div className="lbl">ИГРОВЫЕ НАСТРОЙКИ</div>
            <div style={{display:'flex',flexDirection:'column',gap:8,marginBottom:14}}>
              {[['maxPlayers','Макс. игроков',2,20,10],['minPlayers','Мин. игроков',2,10,2]].map(([key,label,mn,mx,def])=>(
                <div key={key} style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:8,padding:'10px 14px',display:'flex',alignItems:'center',gap:10}}>
                  <div style={{flex:1}}><div style={{fontSize:13,fontWeight:600}}>{label}</div><div style={{fontSize:10,color:'var(--tx3)'}}>{mn}–{mx}</div></div>
                  <div style={{display:'flex',alignItems:'center',gap:8}}>
                    <button onClick={async()=>{const nv=Math.max(mn,(settings[key]||def)-1);await DB.updateSettings({[key]:nv});setS(p=>({...p,[key]:nv}));await logA('НАСТРОЙКИ',`${label}=${nv}`);}} style={{width:28,height:28,borderRadius:6,background:'rgba(255,255,255,0.1)',border:'1px solid rgba(255,255,255,0.15)',color:'var(--tx)',fontSize:16,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center'}}>−</button>
                    <span style={{fontSize:18,fontWeight:700,color:'var(--a)',minWidth:30,textAlign:'center'}}>{settings[key]||def}</span>
                    <button onClick={async()=>{const nv=Math.min(mx,(settings[key]||def)+1);await DB.updateSettings({[key]:nv});setS(p=>({...p,[key]:nv}));await logA('НАСТРОЙКИ',`${label}=${nv}`);}} style={{width:28,height:28,borderRadius:6,background:'rgba(255,255,255,0.1)',border:'1px solid rgba(255,255,255,0.15)',color:'var(--tx)',fontSize:16,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center'}}>+</button>
                  </div>
                </div>
              ))}
              <Tog on={!!settings.allowUserCreate} onToggle={async()=>{const nv=!settings.allowUserCreate;await DB.updateSettings({allowUserCreate:nv});setS(p=>({...p,allowUserCreate:nv}));await logA('НАСТРОЙКИ',`allowUserCreate=${nv}`);}} label="👥 Разрешить игрокам создавать игры" sub="Если выкл — только администратор может создавать игры"/>
            </div>
            <div className="lbl">🎃 СЕЗОННЫЕ СОБЫТИЯ</div>
            <SeasonalEventPanel toast={toast}/>
            <div className="lbl" style={{marginTop:16}}>КОНТЕНТ</div>
            <Tog on={!!settings.adultMode} onToggle={toggleGlobal}
              label="🔞 ВЗРОСЛЫЙ РЕЖИМ 18+ (ГЛОБАЛЬНО)"
              sub={settings.adultMode?"ВКЛ — все игроки видят переключатель 18+":"ВЫКЛ — 18+ только администраторам"}
              dng/>
            <Tog on={!!settings.funnyProf} onToggle={async()=>{const nv=!settings.funnyProf;await DB.updateSettings({funnyProf:nv});setS(p=>({...p,funnyProf:nv}));await logA('НАСТРОЙКИ',`funnyProf=${nv}`);toast(nv?'🤡 Смешные профессии включены!':'Смешные профессии выключены','ok');}}
              label="🤡 СМЕШНЫЕ ПРОФЕССИИ (ГЛОБАЛЬНО)"
              sub={settings.funnyProf?"ВКЛ — в пул добавлены 100+ юмористических профессий":"ВЫКЛ — только серьёзные профессии"}/>
            <Tog on={!!settings.universityMode} onToggle={async()=>{const nv=!settings.universityMode;await DB.updateSettings({universityMode:nv});setS(p=>({...p,universityMode:nv}));await logA('НАСТРОЙКИ',`universityMode=${nv}`);toast(nv?'🎓 Университетский режим включён!':'🎓 Университетский режим выключен','ok');}}
              label="🎓 УНИВЕРСИТЕТСКИЙ РЕЖИМ"
              sub={settings.universityMode?"ВКЛ — игроки видят университетские сценарии и карточки при создании игры":"ВЫКЛ — университетский режим скрыт от игроков"}/>
            <div className="mono" style={{fontSize:9,color:'var(--tx3)',letterSpacing:1,padding:'8px 14px',background:'var(--s1)',border:'1px solid var(--ab)',lineHeight:1.6}}>
              При включении — переключатель 18+ появляется у всех игроков при создании игры.
            </div>
          </div>
        ):tab==='cheats'?(
          <div>
            <div style={{background:settings.cheatsEnabled?'rgba(191,90,242,0.15)':'rgba(191,90,242,0.08)',border:`1px solid ${settings.cheatsEnabled?'rgba(191,90,242,0.6)':'rgba(191,90,242,0.25)'}`,borderRadius:'var(--rad)',padding:16,marginBottom:14,transition:'.3s'}}>
              <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:8}}>
                <div style={{fontSize:14,fontWeight:700,color:'var(--p)',flex:1}}>🎯 Читерский режим</div>
                <div style={{display:'flex',alignItems:'center',gap:8}}>
                  <span style={{fontSize:10,color:settings.cheatsEnabled?'var(--p)':'var(--tx3)',fontFamily:"'Share Tech Mono',monospace",letterSpacing:1}}>{settings.cheatsEnabled?'ВКЛ':'ВЫКЛ'}</span>
                  <div onClick={async()=>{const v=!settings.cheatsEnabled;await db.ref('settings/cheatsEnabled').set(v);setS(p=>({...p,cheatsEnabled:v}));toast(v?'⚡ Читы включены!':'Читы выключены','ok');}} style={{width:44,height:24,borderRadius:12,background:settings.cheatsEnabled?'var(--p)':'rgba(255,255,255,0.12)',position:'relative',cursor:'pointer',transition:'.3s',flexShrink:0,border:`1px solid ${settings.cheatsEnabled?'var(--p)':'rgba(255,255,255,0.2)'}`}}>
                    <div style={{position:'absolute',top:2,left:settings.cheatsEnabled?20:2,width:18,height:18,borderRadius:'50%',background:'#fff',transition:'left .25s',boxShadow:'0 1px 4px rgba(0,0,0,0.4)'}}/>
                  </div>
                </div>
              </div>
              <div style={{fontSize:12,color:'var(--tx2)',lineHeight:1.6}}>Заменяет твои карты на оптимальные для текущего сценария. Только для администратора.</div>
              {settings.cheatsEnabled&&<div style={{marginTop:8,fontSize:11,color:'var(--p)',background:'rgba(191,90,242,0.12)',borderRadius:8,padding:'6px 10px'}}>⚡ Режим активен — применяй лучшие карты ниже</div>}
            </div>
            <div className="lbl">МОИ ИГРЫ (ЛОББИ И АКТИВНЫЕ)</div>
            {Object.values(games).filter(g=>g.phase!=='finished'&&(g.players?.[me.username]||g.creatorId===me.username)).length===0&&(
              <div style={{textAlign:'center',padding:24,color:'var(--tx3)',fontSize:13}}>Ты не участвуешь ни в одной игре<br/><span style={{fontSize:11}}>Создай игру или вступи в лобби</span></div>
            )}
            {Object.values(games).filter(g=>g.phase!=='finished'&&(g.players?.[me.username]||g.creatorId===me.username)).map(g=>{
              const scenId=g.apocalypse?.id;
              const best=BEST_CARDS_BY_SCENARIO[scenId];
              const isLobby=g.phase==='lobby';
              const inGame=!!g.players?.[me.username];
              const phaseLabel=isLobby?'🔵 ЛОББИ':g.phase==='playing'?'🟢 В ИГРЕ':g.phase==='voting'?'🔴 ГОЛОСОВАНИЕ':g.phase==='debates'?'🟡 ДЕБАТЫ':'⚪';
              return(
                <div key={g.id} style={{background:'rgba(255,255,255,0.04)',border:`1px solid ${isLobby?'rgba(10,132,255,0.3)':'rgba(255,255,255,0.08)'}`,borderRadius:'var(--rad)',padding:16,marginBottom:10}}>
                  <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:4}}>
                    <div style={{fontWeight:700,fontSize:15,color:'var(--a)',flex:1}}>{g.apocalypse?.emoji||'🎮'} {g.apocalypse?.name||g.id}</div>
                    <span style={{fontSize:9,color:isLobby?'var(--c)':'var(--g)',fontFamily:"'Share Tech Mono',monospace",letterSpacing:1}}>{phaseLabel}</span>
                  </div>
                  <div style={{fontSize:11,color:'var(--tx3)',marginBottom:10}}>Код: <b style={{color:'var(--tx2)'}}>{g.id}</b> · {Object.keys(g.players||{}).length} игроков{!inGame&&<span style={{color:'var(--p)',marginLeft:6}}>· ты создатель</span>}</div>
                  {isLobby&&!inGame&&(
                    <div style={{background:'rgba(10,132,255,0.08)',border:'1px solid rgba(10,132,255,0.2)',borderRadius:'var(--rad-sm)',padding:'8px 12px',marginBottom:10,fontSize:12,color:'var(--c)'}}>
                      ℹ️ Ты создатель, но не добавлен в игру. Карты будут применены когда ты вступишь.
                    </div>
                  )}
                  {!scenId&&isLobby&&(
                    <div style={{background:'rgba(240,165,0,0.08)',border:'1px solid rgba(240,165,0,0.2)',borderRadius:'var(--rad-sm)',padding:'8px 12px',marginBottom:10,fontSize:12,color:'var(--a)'}}>
                      ⚠️ Сценарий ещё не выбран. Карты можно применить после старта игры.
                    </div>
                  )}
                  {best?(
                    <>
                      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6,marginBottom:10}}>
                        {Object.entries(best).map(([key,val])=>{
                          const card=CARDS.find(c=>c.key===key);
                          return(
                            <div key={key} style={{background:'rgba(191,90,242,0.06)',border:'1px solid rgba(191,90,242,0.2)',borderRadius:'var(--rad-sm)',padding:'8px 10px'}}>
                              <div style={{fontSize:9,color:'var(--p)',fontWeight:600,letterSpacing:1,marginBottom:3}}>{card?.icon} {card?.label||key}</div>
                              <div style={{fontSize:11,color:'var(--tx)'}}>{Array.isArray(val)?val[1]:typeof val==='object'&&val!==null&&'1' in val?`${val[0]} ${val[1]}`:val}</div>
                            </div>
                          );
                        })}
                      </div>
                      {!settings.cheatsEnabled&&<div style={{fontSize:11,color:'var(--r)',background:'rgba(255,69,58,0.08)',border:'1px solid rgba(255,69,58,0.2)',borderRadius:8,padding:'7px 12px',marginBottom:8}}>🔒 Включи читерский режим выше чтобы применить карты</div>}
                      <Btn ch={isLobby?"⚡ Применить карты (старт игры)":"⚡ Применить лучшие карты"} cls="btn-pu" sm disabled={!settings.cheatsEnabled} onClick={async()=>{
                        if(!settings.cheatsEnabled)return toast('Сначала включи читерский режим','err');
                        if(!confirm(`Заменить твои карты в игре "${g.apocalypse?.name||g.id}" на лучшие?`))return;
                        if(!inGame){
                          // Добавляем admin как игрока с лучшими картами
                          await DB.updateGame(g.id,{[`players/${me.username}`]:{userId:me.username,username:me.username,name:me.displayName||me.username,cards:best,revealed:[],isEliminated:false}});
                        } else {
                          await DB.updateGame(g.id,{[`players/${me.username}/cards`]:best});
                        }
                        toast('✅ Лучшие карты применены!','ok');
                        await load();
                      }}/>
                    </>
                  ):scenId?(
                    <div style={{fontSize:12,color:'var(--tx3)'}}>Нет предустановленных карт для этого сценария</div>
                  ):null}
                </div>
              );
            })}
            <div className="lbl">ЛУЧШИЕ КАРТЫ ПО СЦЕНАРИЯМ</div>
            {APOC.map(sc=>{
              const best=BEST_CARDS_BY_SCENARIO[sc.id];
              if(!best)return null;
              return(
                <div key={sc.id} style={{background:'rgba(255,255,255,0.03)',border:'1px solid rgba(255,255,255,0.07)',borderRadius:'var(--rad)',padding:14,marginBottom:8}}>
                  <div style={{fontWeight:700,fontSize:13,color:'var(--tx)',marginBottom:8}}>{sc.emoji} {sc.name}</div>
                  <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:4}}>
                    {Object.entries(best).map(([key,val])=>{
                      const card=CARDS.find(c=>c.key===key);
                      return(
                        <div key={key} style={{fontSize:10,color:'var(--tx2)'}}>
                          <span style={{color:'var(--tx3)'}}>{card?.icon} {card?.label}: </span>
                          {Array.isArray(val)?val[1]:typeof val==='object'&&val!==null&&'1' in val?`${val[0]} ${val[1]}`:val}
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        ):tab==='users'?(
          <div>
            {/* Mass actions */}
            {Object.keys(selected).filter(k=>selected[k]).length>0&&(
              <div style={{background:'rgba(255,165,0,0.1)',border:'1px solid rgba(255,165,0,0.3)',borderRadius:8,padding:'10px 14px',marginBottom:12}}>
                <div style={{fontSize:12,color:'var(--a)',fontWeight:700,marginBottom:8}}>
                  ⚠️ Выбрано: {Object.keys(selected).filter(k=>selected[k]).length} игроков
                </div>
                <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
                  <Btn ch="🔄 Сбросить пароли" sm cls="btn-c" onClick={async()=>{
                    const sel=Object.keys(selected).filter(k=>selected[k]);
                    if(!confirm(`Сбросить пароли ${sel.length} игрокам на "bunker123"?`))return;
                    await Promise.all(sel.map(u=>DB.updateUser(u,{password:'bunker123'})));
                    await logA('СБРОС ПАРОЛЕЙ',sel.join(', '));
                    toast('✅ Пароли сброшены на bunker123','ok');setSelected({});await load();
                  }}/>
                  <Btn ch="📊 Сбросить Эло" sm cls="btn-c" onClick={async()=>{
                    const sel=Object.keys(selected).filter(k=>selected[k]);
                    if(!confirm(`Сбросить Эло ${sel.length} игрокам до 1000?`))return;
                    await Promise.all(sel.map(u=>DB.updateUser(u,{elo:1000,eloGames:0,eloDelta:0})));
                    await logA('СБРОС ЭЛО',sel.join(', '));
                    toast('✅ Эло сброшено до 1000','ok');setSelected({});await load();
                  }}/>
                  <Btn ch="✕ Снять выделение" sm cls="btn-g" onClick={()=>setSelected({})}/>
                </div>
              </div>
            )}
            {/* Ban modal */}
            {banTarget&&(
              <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.8)',zIndex:200,display:'flex',alignItems:'center',justifyContent:'center',padding:20}} onClick={e=>{if(e.target===e.currentTarget){setBanTarget(null);setBanReason('');}}}>
                <div style={{background:'var(--bg)',border:'1px solid rgba(255,69,58,0.4)',borderRadius:'var(--rad-lg)',padding:24,width:'100%',maxWidth:340}}>
                  <div style={{fontSize:16,fontWeight:700,color:'var(--r)',marginBottom:4}}>🚫 Заблокировать игрока</div>
                  <div style={{fontSize:13,color:'var(--tx2)',marginBottom:14}}>@{banTarget}</div>
                  <input className="inp" placeholder="Причина бана..." value={banReason} onChange={e=>setBanReason(e.target.value)} maxLength={100}/>
                  <div style={{display:'flex',gap:8,marginTop:12}}>
                    <Btn ch="🚫 Заблокировать" cls="btn-d" onClick={async()=>{
                      if(banTarget===me.username)return toast('Нельзя забанить себя','err');
                      await DB.banUser(banTarget,banReason||'Нарушение правил',me.username);
                      await logA('БАН',`@${banTarget}: ${banReason||'Нарушение правил'}`);
                      toast(`✅ @${banTarget} заблокирован`,'ok');
                      setBanTarget(null);setBanReason('');await load();
                    }}/>
                    <Btn ch="Отмена" cls="btn-g" sm onClick={()=>{setBanTarget(null);setBanReason('');}}/>
                  </div>
                </div>
              </div>
            )}
            {Object.values(users).map(u=>(
          <div key={u.username} className="adm-row">
            <div style={{flex:'1 1 130px',minWidth:0}}>
              <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:4,flexWrap:'wrap'}}>
                <span style={{fontWeight:700,fontSize:14}}>{u.displayName||u.username}</span>
                {u.isAdmin&&<span className="bdg bdg-p" style={{fontSize:7}}>ADMIN</span>}
                {u.isBanned&&<span style={{fontSize:7,background:'rgba(255,69,58,0.15)',border:'1px solid rgba(255,69,58,0.4)',color:'var(--r)',borderRadius:4,padding:'1px 5px',fontWeight:700,letterSpacing:1}}>🚫 БАН</span>}
                {u.username===me.username&&<span className="bdg bdg-c" style={{fontSize:7}}>ВЫ</span>}
              </div>
              <div className="mono" style={{fontSize:8,color:'var(--tx3)'}}>@{u.username} · {u.gamesPlayed||0} игр · 🪙{u.coins||0}</div>
              <div style={{marginTop:4}}><RChip user={u}/></div>
            </div>
            <div style={{display:'flex',gap:6,flexWrap:'wrap',alignItems:'center'}}>
              <select className="sel" style={{width:'auto',padding:'4px 8px',fontSize:11,marginBottom:0}} value={u.customRank||'auto'} onChange={e=>setRank(u.username,e.target.value==='auto'?null:e.target.value)}>
                <option value="auto">Авто</option>
                {RANKS.map(r=><option key={r.id} value={r.id}>{r.icon} {r.name}</option>)}
              </select>
              <button onClick={()=>{setEditDisplayName(u.displayName||u.username);setEditPassword('');setEditElo(String(u.elo||1000));setEditCoins(String(u.coins||0));setEditXP(String(u.xp||0));setShowPass(false);setEditUser(u);}} style={{background:'rgba(10,132,255,.1)',border:'1px solid rgba(10,132,255,.3)',color:'var(--c)',fontFamily:"'Inter',sans-serif",fontSize:10,padding:'4px 8px',cursor:'pointer',borderRadius:6}}>✏️</button>
              {u.username!==me.username&&<>
                <button onClick={()=>toggleAdmin(u.username)} style={{background:u.isAdmin?'var(--rt)':'rgba(155,89,239,.1)',border:`1px solid ${u.isAdmin?'var(--r)':'rgba(155,89,239,.4)'}`,color:u.isAdmin?'var(--r)':'var(--p)',fontFamily:"'Inter',sans-serif",fontSize:9,padding:'4px 8px',cursor:'pointer',letterSpacing:1}}>
                  {u.isAdmin?'СНЯТЬ':'ADMIN'}
                </button>
                <input type="checkbox" checked={!!selected[u.username]} onChange={e=>setSelected(s=>({...s,[u.username]:e.target.checked}))} style={{width:16,height:16,cursor:'pointer',accentColor:'var(--a)'}}/>
                {u.isBanned
                  ?<button onClick={async()=>{await DB.unbanUser(u.username);await logA('РАЗБАН',`@${u.username}`);toast(`✅ @${u.username} разблокирован`,'ok');await load();}} style={{background:'rgba(48,209,88,0.1)',border:'1px solid rgba(48,209,88,0.3)',color:'var(--g)',fontFamily:"'Inter',sans-serif",fontSize:10,padding:'4px 8px',cursor:'pointer',borderRadius:6}}>✅ Разбан</button>
                  :<button onClick={()=>{if(u.username===me.username)return toast('Нельзя забанить себя','err');setBanTarget(u.username);setBanReason('');}} style={{background:'rgba(255,69,58,0.1)',border:'1px solid rgba(255,69,58,0.3)',color:'var(--r)',fontFamily:"'Inter',sans-serif",fontSize:10,padding:'4px 8px',cursor:'pointer',borderRadius:6}}>🚫 Бан</button>
                }
                <button onClick={()=>delUser(u.username)} style={{background:'var(--rt)',border:'1px solid var(--rb)',color:'var(--r)',fontFamily:"'Inter',sans-serif",fontSize:11,padding:'4px 8px',cursor:'pointer'}}>✕</button>
              </>}
            </div>
          </div>
          ))}
          </div>
        ):null}
      </div>
      {editUser&&(
        <div className="modal-bg" onClick={()=>setEditUser(null)}>
          <div className="modal-box" onClick={e=>e.stopPropagation()} style={{maxHeight:'85vh'}}>
            <div className="modal-hd">
              <div style={{display:'flex',alignItems:'center',gap:10,flex:1}}>
                <div className="modal-ttl">✏️ {editUser.displayName||editUser.username}</div>
                <div style={{fontSize:12,color:'var(--a)',background:'rgba(240,165,0,0.12)',border:'1px solid rgba(240,165,0,0.3)',borderRadius:8,padding:'3px 10px',fontWeight:700}}>🪙 {editUser.coins||0}</div>
              </div>
              <button className="modal-cls" onClick={()=>setEditUser(null)}>✕</button>
            </div>
            <div className="modal-bd">
              <div className="lbl">УЧЁТНЫЕ ДАННЫЕ</div>
              <div style={{background:'rgba(10,132,255,0.08)',border:'1px solid rgba(10,132,255,0.25)',borderRadius:'var(--rad-sm)',padding:'12px 14px',marginBottom:10}}>
                <div style={{fontSize:10,color:'var(--c)',fontWeight:600,letterSpacing:1,marginBottom:6}}>🔐 ЛОГИН (USERNAME)</div>
                <div style={{fontFamily:"'Share Tech Mono',monospace",fontSize:16,color:'var(--tx)',letterSpacing:2}}>{editUser.username}</div>
              </div>
              <div style={{background:'rgba(191,90,242,0.08)',border:'1px solid rgba(191,90,242,0.25)',borderRadius:'var(--rad-sm)',padding:'12px 14px',marginBottom:14}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:6}}>
                  <div style={{fontSize:10,color:'var(--p)',fontWeight:600,letterSpacing:1}}>🔑 ПАРОЛЬ</div>
                  <button onClick={()=>setShowPass(p=>!p)} style={{background:'rgba(255,255,255,0.1)',border:'none',color:'var(--tx2)',fontSize:11,padding:'3px 10px',borderRadius:6,cursor:'pointer'}}>{showPass?'🙈 Скрыть':'👁 Показать'}</button>
                </div>
                <div style={{fontFamily:"'Share Tech Mono',monospace",fontSize:16,color:'var(--tx)',letterSpacing:2}}>
                  {showPass ? editUser.password : '••••••••'}
                </div>
              </div>
              <div className="lbl">РЕДАКТИРОВАТЬ</div>
              <input className="inp" placeholder="Отображаемое имя" value={editDisplayName} onChange={e=>setEditDisplayName(e.target.value)} maxLength={30}/>
              <input className="inp" placeholder="Новый пароль (оставить пустым — не менять)" type="text" value={editPassword} onChange={e=>setEditPassword(e.target.value)} maxLength={50}/>
              <div style={{display:'flex',alignItems:'center',gap:8,marginTop:4}}>
                <span style={{fontSize:12,color:'var(--tx2)',whiteSpace:'nowrap'}}>🏅 Очки Эло:</span>
                <input className="inp" type="number" min="0" max="9999" placeholder="1000" value={editElo} onChange={e=>setEditElo(e.target.value)} style={{flex:1}}/>
                <div style={{display:'flex',gap:4}}>
                  <button onClick={()=>setEditElo(String(Math.max(0,(parseInt(editElo)||0)-50)))} style={{background:'var(--rt)',border:'1px solid var(--r)',color:'var(--r)',fontFamily:"'Inter',sans-serif",fontSize:13,fontWeight:700,padding:'4px 10px',borderRadius:6,cursor:'pointer'}}>−50</button>
                  <button onClick={()=>setEditElo(String((parseInt(editElo)||0)+50))} style={{background:'var(--gt)',border:'1px solid var(--g)',color:'var(--g)',fontFamily:"'Inter',sans-serif",fontSize:13,fontWeight:700,padding:'4px 10px',borderRadius:6,cursor:'pointer'}}>+50</button>
                </div>
              </div>
              <div style={{display:'flex',alignItems:'center',gap:8,marginTop:4}}>
                <span style={{fontSize:12,color:'var(--tx2)',whiteSpace:'nowrap'}}>🪙 Монеты:</span>
                <input className="inp" type="number" min="0" max="999999" placeholder="0" value={editCoins} onChange={e=>setEditCoins(e.target.value)} style={{flex:1}}/>
                <div style={{display:'flex',gap:4}}>
                  <button onClick={()=>setEditCoins(String(Math.max(0,(parseInt(editCoins)||0)-100)))} style={{background:'var(--rt)',border:'1px solid var(--r)',color:'var(--r)',fontFamily:"'Inter',sans-serif",fontSize:11,fontWeight:700,padding:'4px 8px',borderRadius:6,cursor:'pointer'}}>−100</button>
                  <button onClick={()=>setEditCoins(String(Math.max(0,(parseInt(editCoins)||0)-10)))} style={{background:'var(--rt)',border:'1px solid var(--r)',color:'var(--r)',fontFamily:"'Inter',sans-serif",fontSize:11,fontWeight:700,padding:'4px 8px',borderRadius:6,cursor:'pointer'}}>−10</button>
                  <button onClick={()=>setEditCoins(String((parseInt(editCoins)||0)+10))} style={{background:'var(--gt)',border:'1px solid var(--g)',color:'var(--g)',fontFamily:"'Inter',sans-serif",fontSize:11,fontWeight:700,padding:'4px 8px',borderRadius:6,cursor:'pointer'}}>+10</button>
                  <button onClick={()=>setEditCoins(String((parseInt(editCoins)||0)+100))} style={{background:'var(--gt)',border:'1px solid var(--g)',color:'var(--g)',fontFamily:"'Inter',sans-serif",fontSize:11,fontWeight:700,padding:'4px 8px',borderRadius:6,cursor:'pointer'}}>+100</button>
                </div>
              </div>
              <div style={{display:'flex',gap:6,marginTop:8}}>
                <button onClick={()=>setEditCoins('0')} style={{flex:1,background:'var(--rt)',border:'1px solid var(--r)',color:'var(--r)',fontFamily:"'Inter',sans-serif",fontSize:11,fontWeight:700,padding:'6px',borderRadius:6,cursor:'pointer'}}>🗑 Обнулить</button>
                <button onClick={()=>setEditCoins(String((parseInt(editCoins)||0)+1000))} style={{flex:1,background:'rgba(240,165,0,0.1)',border:'1px solid rgba(240,165,0,0.4)',color:'var(--a)',fontFamily:"'Inter',sans-serif",fontSize:11,fontWeight:700,padding:'6px',borderRadius:6,cursor:'pointer'}}>+1000 монет</button>
              </div>
              {/* XP / Уровень */}
              {(()=>{const lvlInfo=editXP!==''?getLevel(parseInt(editXP)||0):{level:0,currentXP:0,neededXP:100};return(
              <div style={{marginTop:14}}>
                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:8}}>
                  <div className="lbl" style={{margin:0}}>📈 XP / УРОВЕНЬ</div>
                  <div style={{fontSize:12,color:'var(--a)',fontWeight:700,background:'rgba(240,165,0,0.1)',border:'1px solid rgba(240,165,0,0.3)',borderRadius:8,padding:'3px 10px'}}>⭐ Ур. {lvlInfo.level}</div>
                </div>
                <div style={{height:6,background:'rgba(255,255,255,0.08)',borderRadius:3,overflow:'hidden',marginBottom:8}}>
                  <div style={{height:'100%',width:`${lvlInfo.neededXP>0?Math.round(lvlInfo.currentXP/lvlInfo.neededXP*100):100}%`,background:'linear-gradient(90deg,var(--a),#ff6b00)',borderRadius:3,transition:'.3s'}}/>
                </div>
                <div style={{display:'flex',gap:6,alignItems:'center',marginBottom:6}}>
                  <input className="inp" type="number" min="0" max="999999" placeholder="0" value={editXP} onChange={e=>setEditXP(e.target.value)} style={{flex:1}}/>
                  <div style={{fontSize:10,color:'var(--tx3)',whiteSpace:'nowrap'}}>{lvlInfo.currentXP}/{lvlInfo.neededXP} XP</div>
                </div>
                <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
                  <button onClick={()=>setEditXP(String(Math.max(0,(parseInt(editXP)||0)-100)))} style={{flex:1,background:'var(--rt)',border:'1px solid var(--r)',color:'var(--r)',fontFamily:"'Inter',sans-serif",fontSize:11,fontWeight:700,padding:'6px',borderRadius:6,cursor:'pointer'}}>−100</button>
                  <button onClick={()=>setEditXP(String((parseInt(editXP)||0)+100))} style={{flex:1,background:'var(--gt)',border:'1px solid var(--g)',color:'var(--g)',fontFamily:"'Inter',sans-serif",fontSize:11,fontWeight:700,padding:'6px',borderRadius:6,cursor:'pointer'}}>+100</button>
                  <button onClick={()=>setEditXP(String((parseInt(editXP)||0)+500))} style={{flex:1,background:'rgba(240,165,0,0.1)',border:'1px solid rgba(240,165,0,0.4)',color:'var(--a)',fontFamily:"'Inter',sans-serif",fontSize:11,fontWeight:700,padding:'6px',borderRadius:6,cursor:'pointer'}}>+500 XP</button>
                  <button onClick={()=>setEditXP('0')} style={{background:'var(--rt)',border:'1px solid var(--r)',color:'var(--r)',fontFamily:"'Inter',sans-serif",fontSize:11,fontWeight:700,padding:'6px 10px',borderRadius:6,cursor:'pointer'}}>🗑</button>
                </div>
              </div>
              );})()}
              <Btn ch="💾 Сохранить" onClick={async()=>{
                const patch={};
                if(editDisplayName.trim()) patch.displayName=editDisplayName.trim();
                if(editPassword.trim()) patch.password=editPassword.trim();
                const xpVal=parseInt(editXP);
                if(!isNaN(xpVal)&&xpVal>=0){patch.xp=xpVal;await logA('ИЗМЕНИЛ XP',`${editUser.username}: ${editUser.xp||0} → ${xpVal}`);}
                const eloVal=parseInt(editElo);
                if(!isNaN(eloVal)&&eloVal>=0&&eloVal<=9999) patch.elo=eloVal;
                const coinsVal=parseInt(editCoins);
                if(!isNaN(coinsVal)&&coinsVal>=0) patch.coins=coinsVal;
                if(Object.keys(patch).length===0){toast('Нечего сохранять','err');return;}
                await DB.updateUser(editUser.username,patch);
                await logA('ИЗМЕНИЛ МОНЕТЫ',`@${editUser.username}: ${editUser.coins||0} → ${coinsVal}`);
                setU(p=>({...p,[editUser.username]:{...p[editUser.username],...patch}}));
                setEditUser(null);
                toast('✅ Сохранено!','ok');
              }}/>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   CREATE GAME
══════════════════════════════════════════════════════════ */
function CreateGameScreen({user,onBack,onCreated,toast}){
  const[sel,setSel]=useState(null);
  const[adult,setAdult]=useState(false);
  const[globalAdult,setGA]=useState(false);
  const[uniMode,setUniMode]=useState(false);
  const[loading,setL]=useState(false);
  const[cardPack,setCardPack]=useState('default');
  const[maxRev,setMaxRev]=useState(2);
  const[autoVote,setAutoVote]=useState(false);
  const[matchmaking,setMatchmaking]=useState(false);
  const[debatesOn,setDebates]=useState(false);
  const[voteHistoryOn,setVoteHistory]=useState(false);
  const[rolesOn,setRoles]=useState(false);
  const[radioOn,setRadio]=useState(false);
  const[bunkerMapOn,setBunkerMap]=useState(false);
  const[roundTimer,setRoundTimer]=useState(0);
  const[isRated,setIsRated]=useState(false);

  useEffect(()=>{
    DB.getSettings().then(s=>{
      if(s.adultMode)setGA(true);
      if(s.universityMode)setUniMode(true);
    });
  },[]);

  const canAdult=user.isAdmin||globalAdult;
  const isUniSel=sel&&UNI_APOC.some(a=>a.id===sel);

  const create=async()=>{
    if(!sel)return toast('Выберите сценарий','err');
    setL(true);
    const gid=genCode();
    let ap;
    if(isUniSel){
      ap=UNI_APOC.find(a=>a.id===sel);
    } else if(sel==='random'){
      ap=rnd(APOC);
    } else {
      ap=APOC.find(a=>a.id===sel);
    }
    // Автоматически ставим пак университет для uni-сценариев
    const finalCardPack=isUniSel?'university':cardPack;
    await DB.setGame(gid,{
      id:gid,creatorId:user.username,adultMode:adult,apocalypse:ap,
      phase:'lobby',round:1,bunkerSpots:1,
      maxReveals:maxRev,autoVote,matchmaking,
      debates:debatesOn,voteHistory:voteHistoryOn,roles:rolesOn,radio:radioOn,bunkerMap:bunkerMapOn,
      roundTimerSeconds:roundTimer>0?roundTimer*60:0,
      isRated,cardPack:finalCardPack,isUniversityMode:isUniSel,
      players:{[user.username]:{userId:user.username,username:user.username,name:user.displayName||user.username,cards:null,revealed:[],isEliminated:false}},
      votes:{},revealedThisRound:{},eliminated:[],lastEliminated:null,createdAt:Date.now(),
    });
    setL(false);onCreated(gid);
  };

  return(
    <div className="sc">
      <HZ/>
      <div className="tb"><BackBtn onClick={onBack}/><div className="tb-title">НОВАЯ ИГРА</div></div>
      <div className="scr-raw" style={{paddingBottom:90}}>
        <div className="lbl">СЦЕНАРИЙ АПОКАЛИПСИСА</div>
        <div className={`ap-opt${sel==='random'?' on':''}`} onClick={()=>setSel('random')}>
          <span style={{fontSize:30}}>🎲</span>
          <div>
            <div style={{fontFamily:"'Inter',sans-serif",fontSize:18,letterSpacing:2}}>СЛУЧАЙНЫЙ</div>
            <div style={{fontSize:11,color:'var(--tx3)'}}>Судьба решит за вас</div>
          </div>
        </div>
        {APOC.map(ap=>(
          <div key={ap.id} className={`ap-opt${sel===ap.id?' on':''}`} onClick={()=>setSel(ap.id)}>
            <span style={{fontSize:30}}>{ap.emoji}</span>
            <div style={{flex:1}}>
              <div style={{fontFamily:"'Inter',sans-serif",fontSize:18,letterSpacing:2,color:sel===ap.id?'var(--a)':'var(--tx)'}}>{ap.name}</div>
              <div style={{fontSize:11,color:'var(--tx3)',lineHeight:1.4,marginTop:2}}>{ap.description.slice(0,80)}…</div>
              <div style={{fontSize:10,color:'var(--a)',marginTop:4}}>🎯 {ap.victory}</div>
            </div>
          </div>
        ))}
        {uniMode&&(
          <>
            <div style={{display:'flex',alignItems:'center',gap:10,margin:'18px 0 10px',padding:'12px 16px',background:'linear-gradient(135deg,rgba(77,166,255,0.12),rgba(191,90,242,0.08))',border:'1px solid rgba(77,166,255,0.3)',borderRadius:'var(--rad)'}}>
              <span style={{fontSize:28}}>🎓</span>
              <div>
                <div style={{fontFamily:"'Inter',sans-serif",fontSize:13,fontWeight:800,letterSpacing:2,color:'#4da6ff'}}>УНИВЕРСИТЕТСКИЙ РЕЖИМ</div>
                <div style={{fontSize:11,color:'var(--tx3)',marginTop:2}}>Уникальные сценарии, роли и карточки для студентов и преподавателей</div>
              </div>
            </div>
            {UNI_APOC.map(ap=>(
              <div key={ap.id} className={`ap-opt${sel===ap.id?' on':''}`} onClick={()=>setSel(ap.id)} style={{borderColor:sel===ap.id?'#4da6ff':'rgba(77,166,255,0.2)',background:sel===ap.id?'rgba(77,166,255,0.12)':'rgba(77,166,255,0.04)'}}>
                <span style={{fontSize:30}}>{ap.emoji}</span>
                <div style={{flex:1}}>
                  <div style={{fontFamily:"'Inter',sans-serif",fontSize:16,letterSpacing:1,color:sel===ap.id?'#4da6ff':'var(--tx)'}}>{ap.name}</div>
                  <div style={{fontSize:11,color:'var(--tx3)',lineHeight:1.4,marginTop:2}}>{ap.description.slice(0,90)}…</div>
                  <div style={{fontSize:10,color:'#4da6ff',marginTop:4}}>🎯 {ap.victory}</div>
                  <div style={{fontSize:10,color:'rgba(77,166,255,0.7)',marginTop:2}}>📍 {ap.bunker}</div>
                </div>
                <div style={{fontSize:9,color:'#4da6ff',background:'rgba(77,166,255,0.15)',border:'1px solid rgba(77,166,255,0.3)',borderRadius:6,padding:'3px 8px',alignSelf:'flex-start',whiteSpace:'nowrap'}}>🎓 УНИ</div>
              </div>
            ))}
          </>
        )}
        {!isUniSel&&(
          <>
            <div className="lbl">🃏 ПАК КАРТОЧЕК</div>
            {Object.values(CARD_PACKS_DATA).filter(p=>!p.isUniversity).map(pack=>{
              const owned=pack.cost===0||!!(user.purchased&&user.purchased[pack.id]);
              const active=cardPack===pack.id;
              return(
                <div key={pack.id} onClick={()=>{if(owned)setCardPack(pack.id);}} style={{display:'flex',alignItems:'center',gap:12,padding:'12px 14px',background:active?'rgba(240,165,0,0.1)':'rgba(255,255,255,0.04)',border:`1px solid ${active?'var(--a)':owned?'rgba(255,255,255,0.1)':'rgba(255,255,255,0.06)'}`,borderRadius:'var(--rad)',marginBottom:8,cursor:owned?'pointer':'default',opacity:owned?1:0.6,transition:'.15s',position:'relative'}}>
                  <span style={{fontSize:28}}>{pack.emoji}</span>
                  <div style={{flex:1}}>
                    <div style={{fontSize:14,fontWeight:700,color:active?'var(--a)':'var(--tx)'}}>{pack.name}</div>
                    <div style={{fontSize:11,color:'var(--tx3)',marginTop:2}}>{pack.cost===0?'Бесплатно':owned?'✅ Куплен':'🔒 Купить в магазине — 🪙'+pack.cost}</div>
                  </div>
                  {active&&<div style={{fontSize:11,fontWeight:700,color:'var(--a)',background:'rgba(240,165,0,0.15)',border:'1px solid rgba(240,165,0,0.3)',borderRadius:6,padding:'3px 10px'}}>✓ ВЫБРАН</div>}
                  {!owned&&<div style={{fontSize:11,color:'var(--tx3)',background:'rgba(255,255,255,0.07)',borderRadius:6,padding:'3px 10px'}}>МАГАЗИН</div>}
                </div>
              );
            })}
          </>
        )}
        {isUniSel&&(
          <div style={{display:'flex',alignItems:'center',gap:10,padding:'12px 14px',background:'rgba(77,166,255,0.08)',border:'1px solid rgba(77,166,255,0.25)',borderRadius:'var(--rad)',marginBottom:10}}>
            <span style={{fontSize:22}}>🎓</span>
            <div style={{flex:1}}>
              <div style={{fontSize:13,fontWeight:700,color:'#4da6ff'}}>Университетский пак карточек</div>
              <div style={{fontSize:11,color:'var(--tx3)',marginTop:2}}>Студенты, преподаватели, деканат — с особыми секретными картами. Применяется автоматически.</div>
            </div>
            <div style={{fontSize:10,color:'#4da6ff',background:'rgba(77,166,255,0.15)',borderRadius:6,padding:'3px 8px',fontWeight:700}}>✓ АВТО</div>
          </div>
        )}
        {canAdult&&(
          <>
            <div className="lbl">{!user.isAdmin&&<span style={{color:'var(--tx3)',fontSize:8}}>(разрешено администратором)</span>}</div>
            <Tog on={adult} onToggle={()=>setAdult(!adult)} label="🔞 ВЗРОСЛЫЙ РЕЖИМ (18+)" sub="Специальные карты для взрослой компании" dng/>
          </>
        )}
        <div className="lbl">НАСТРОЙКИ РАУНДА</div>
        <div style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad)',padding:16,marginBottom:10}}>
          <div style={{fontSize:13,fontWeight:600,color:'var(--tx)',marginBottom:10}}>🃏 Карт для раскрытия за раунд</div>
          <div style={{display:'flex',gap:8}}>
            {[1,2,3,4].map(n=>(
              <button key={n} onClick={()=>setMaxRev(n)} style={{flex:1,padding:'11px 0',borderRadius:'var(--rad-sm)',border:'none',background:maxRev===n?'var(--a)':'rgba(255,255,255,0.08)',color:maxRev===n?'#000':'var(--tx)',fontFamily:"'Inter',sans-serif",fontSize:17,fontWeight:700,cursor:'pointer',transition:'.15s'}}>
                {n}
              </button>
            ))}
          </div>
          <div style={{fontSize:11,color:'var(--tx3)',marginTop:8}}>Сколько карт каждый игрок может открыть за раунд</div>
        </div>
        <Tog on={autoVote} onToggle={()=>setAutoVote(v=>!v)} label="🗳 Автоголосование" sub="Голосование начнётся само, как только все выложат карты за раунд"/>
        <div className="lbl">ПОДБОР ИГРОКОВ</div>
        <Tog on={matchmaking} onToggle={()=>setMatchmaking(v=>!v)} label="🔍 Открытый подбор" sub="Игру увидят все — любой сможет присоединиться с главного экрана"/>
        <div className="lbl">⚙️ ДОПОЛНИТЕЛЬНЫЕ МЕХАНИКИ</div>
        <Tog on={debatesOn} onToggle={()=>setDebates(v=>!v)} label="🎤 Дебаты" sub="Перед голосованием — таймер 60 сек для защитной речи каждого"/>
        <Tog on={voteHistoryOn} onToggle={()=>setVoteHistory(v=>!v)} label="📊 История голосований" sub="После раунда все видят кто за кого голосовал"/>
        <Tog on={rolesOn} onToggle={()=>setRoles(v=>!v)} label="🎭 Роли" sub="Лидер, Саботажник, Медик — скрытые роли раскрываются в финале"/>
        <Tog on={radioOn} onToggle={()=>setRadio(v=>!v)} label="📡 Радиопереговоры" sub="Приватный чат между любыми двумя игроками во время раунда"/>
        <Tog on={bunkerMapOn} onToggle={()=>setBunkerMap(v=>!v)} label="🗺️ Карта бункера" sub="Комнаты бункера дают бонусы игрокам с подходящей профессией"/>
        <Tog on={isRated} onToggle={()=>setIsRated(v=>!v)} label="🏅 Рейтинговая игра" sub="Победители получают очки Эло, проигравшие теряют. Влияет на рейтинг в таблице лидеров"/>
        <div className="lbl">⏱ ТАЙМЕР РАУНДА</div>
        <div style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad)',padding:16,marginBottom:10}}>
          <div style={{fontSize:13,fontWeight:600,color:'var(--tx)',marginBottom:10}}>Автоматически начинать голосование через:</div>
          <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
            {[[0,'Выкл.'],[1,'1 мин'],[2,'2 мин'],[3,'3 мин'],[5,'5 мин'],[10,'10 мин']].map(([n,lbl])=>(
              <button key={n} onClick={()=>setRoundTimer(n)} style={{flex:'1 1 auto',padding:'10px 6px',borderRadius:'var(--rad-sm)',border:'none',background:roundTimer===n?'var(--a)':'rgba(255,255,255,0.08)',color:roundTimer===n?'#000':'var(--tx)',fontFamily:"'Inter',sans-serif",fontSize:13,fontWeight:700,cursor:'pointer',transition:'.15s',minWidth:60}}>
                {lbl}
              </button>
            ))}
          </div>
          {roundTimer>0&&<div style={{fontSize:11,color:'var(--tx3)',marginTop:8}}>Голосование начнётся автоматически через {roundTimer} мин после начала раунда</div>}
        </div>
      </div>
      <div className="fixbot" style={{bottom:0}}>
        <Btn ch={loading?'⏳ СОЗДАНИЕ…':'☢ СОЗДАТЬ ИГРУ'} onClick={create} disabled={loading||!sel}/>
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   JOIN GAME
══════════════════════════════════════════════════════════ */
/* ══════════════════════════════════════════════════════════
   MATCHMAKING SCREEN
══════════════════════════════════════════════════════════ */
function MatchmakingScreen({user,onBack,onJoined,toast}){
  const[games,setGames]=useState({});
  const[joining,setJoining]=useState(null);

  useEffect(()=>{
    const ref=db.ref('games');
    const handler=ref.on('value',snap=>{
      const all=snap.val()||{};
      // Показываем только lobby-игры с matchmaking=true, где игрока ещё нет
      const open={};
      Object.values(all).forEach(g=>{
        if(g.phase==='lobby'&&g.matchmaking&&!g.players?.[user.username])
          open[g.id]=g;
      });
      setGames(open);
    });
    return()=>ref.off('value',handler);
  },[]);

  const join=async(gid)=>{
    if(joining)return;
    setJoining(gid);
    const g=await DB.getGame(gid);
    if(!g||g.phase!=='lobby'){toast('Игра уже началась','err');setJoining(null);return;}
    if(g.players?.[user.username]){onJoined(gid);return;}
    await DB.updateGame(gid,{[`players/${user.username}`]:{userId:user.username,username:user.username,name:user.displayName||user.username,cards:null,revealed:[],isEliminated:false}});
    setJoining(null);
    onJoined(gid);
  };

  const list=Object.values(games).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

  return(
    <div className="sc">
      <HZ/>
      <div className="tb"><BackBtn onClick={onBack}/><div className="tb-title">ПОДБОР ИГРОКОВ</div><div style={{fontSize:11,color:'var(--tx3)',fontWeight:500}}>{list.length} игр</div></div>
      <div className="scr" style={{paddingBottom:20}}>
        {list.length===0?(
          <div style={{textAlign:'center',padding:'60px 20px'}}>
            <div style={{fontSize:48,marginBottom:16}}>🔍</div>
            <div style={{fontSize:17,fontWeight:600,color:'var(--tx)',marginBottom:8}}>Нет открытых игр</div>
            <div style={{fontSize:13,color:'var(--tx3)',lineHeight:1.6}}>Создайте игру с режимом «Открытый подбор», чтобы любой мог присоединиться</div>
            <div style={{marginTop:24}}><Btn ch="☢ СОЗДАТЬ ИГРУ" onClick={()=>onBack()} cls="btn-p" sm/></div>
          </div>
        ):list.map(g=>{
          const players=Object.values(g.players||{});
          const ap=g.apocalypse||{};
          const isJoining=joining===g.id;
          return(
            <div key={g.id} style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:'var(--rad)',padding:16,marginBottom:10}}>
              <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:10}}>
                <span style={{fontSize:28}}>{ap.emoji||'☢'}</span>
                <div style={{flex:1}}>
                  <div style={{fontSize:15,fontWeight:700,color:'var(--tx)'}}>{ap.name||'Игра'}</div>
                  <div style={{fontSize:11,color:'var(--tx3)',marginTop:2}}>Создатель: {g.creatorId} · {players.length} игрок{players.length===1?'':'а'}</div>
                </div>
                {g.adultMode&&<span style={{fontSize:10,color:'var(--r)',background:'rgba(255,69,58,0.12)',borderRadius:6,padding:'2px 8px',fontWeight:700}}>18+</span>}
              </div>
              <div style={{display:'flex',gap:6,alignItems:'center',marginBottom:12,flexWrap:'wrap'}}>
                <span style={{fontSize:11,color:'var(--tx3)'}}>🃏 {g.maxReveals||2} карты/раунд</span>
                {g.autoVote&&<span style={{fontSize:11,color:'var(--g)',background:'rgba(48,209,88,0.1)',borderRadius:6,padding:'2px 8px',fontWeight:600}}>🗳 Авто-голос</span>}
              </div>
              <div style={{display:'flex',gap:6,marginBottom:12,flexWrap:'wrap'}}>
                {players.slice(0,8).map(p=>(
                  <div key={p.username} style={{fontSize:11,color:'var(--tx2)',background:'rgba(255,255,255,0.07)',borderRadius:20,padding:'3px 10px'}}>{p.name}</div>
                ))}
                {players.length>8&&<div style={{fontSize:11,color:'var(--tx3)',padding:'3px 6px'}}>+{players.length-8}</div>}
              </div>
              <button onClick={()=>join(g.id)} disabled={!!isJoining} style={{width:'100%',padding:'12px',borderRadius:'var(--rad-sm)',border:'none',background:isJoining?'rgba(255,255,255,0.1)':'var(--a)',color:isJoining?'var(--tx3)':'#000',fontSize:14,fontWeight:700,cursor:isJoining?'not-allowed':'pointer',transition:'.2s',fontFamily:"'Inter',sans-serif"}}>
                {isJoining?'⏳ Вхожу…':'⚡ ПРИСОЕДИНИТЬСЯ'}
              </button>
            </div>
          );
        })}
      </div>
    </div>
  );
}

function JoinGameScreen({user,onBack,onJoined,toast}){
  const[code,setC]=useState('');
  const[loading,setL]=useState(false);
  const join=async()=>{
    const c=code.trim().toUpperCase();
    if(c.length!==6)return toast('Код: ровно 6 символов','err');
    setL(true);
    const game=await DB.getGame(c);
    if(!game){setL(false);return toast('Игра не найдена','err');}
    if(game.phase!=='lobby'){setL(false);return toast('Игра уже началась','err');}
    if(game.players?.[user.username]){setL(false);return onJoined(c);}
    if(Object.keys(game.players||{}).length>=16){setL(false);return toast('Комната заполнена','err');}
    await DB.updateGame(c,{[`players/${user.username}`]:{userId:user.username,username:user.username,name:user.displayName||user.username,cards:null,revealed:[],isEliminated:false}});
    DB.logEvent(c,'join',`${user.displayName||user.username} присоединился к игре`,user.username);
    setL(false);onJoined(c);
  };
  return(
    <div className="sc">
      <HZ/>
      <div className="tb"><BackBtn onClick={onBack}/><div className="tb-title">ВОЙТИ В ИГРУ</div></div>
      <div style={{flex:1,display:'flex',flexDirection:'column',justifyContent:'center',padding:'0 20px',gap:20}}>
        <div style={{textAlign:'center'}}>
          <div style={{fontSize:52,marginBottom:8}}>🔑</div>
          <div style={{fontFamily:"'Inter',sans-serif",fontSize:26,letterSpacing:4,color:'var(--a)'}}>КОД КОМНАТЫ</div>
          <div className="mono" style={{fontSize:10,color:'var(--tx3)',letterSpacing:2,marginTop:4}}>ВВЕДИТЕ 6-СИМВОЛЬНЫЙ КОД</div>
        </div>
        <input className="inp" value={code} onChange={e=>setC(e.target.value.toUpperCase())} maxLength={6}
          placeholder="XXXXXX" style={{textAlign:'center',fontSize:30,letterSpacing:2,fontFamily:"'Inter',sans-serif",marginBottom:0}}
          onKeyDown={e=>e.key==='Enter'&&join()}/>
        <Btn ch={loading?'⏳ ПОИСК…':'⚡ ВОЙТИ В БУНКЕР'} onClick={join} disabled={loading||code.trim().length!==6}/>
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   LOBBY
══════════════════════════════════════════════════════════ */
/* ══════════════════════════════════════════════════════════
   ADMIN CHEAT PANEL — быстрый доступ к читам из лобби/игры
══════════════════════════════════════════════════════════ */
function AdminCheatPanel({gameId,game,user,toast,phase}){
  const[open,setOpen]=useState(false);
  const[enabled,setEnabled]=useState(false);
  const[applying,setApplying]=useState(false);
  const[loaded,setLoaded]=useState(false);

  useEffect(()=>{
    // Подписываемся на изменения — реагируем на включение/выключение в AdminPanel
    const r=db.ref('settings/cheatsEnabled');
    const handler=s=>{setEnabled(!!s.val());setLoaded(true);};
    r.on('value',handler);
    return()=>r.off('value',handler);
  },[]);

  if(!game)return null;
  // Скрываем панель если читы выключены в AdminPanel
  if(loaded&&!enabled)return null;
  const ap=game.apocalypse;
  const scenId=ap?.id;
  const best=scenId&&BEST_CARDS_BY_SCENARIO[scenId];
  const inGame=!!(game.players&&game.players[user.username]);

  const toggleEnabled=async()=>{
    const nv=!enabled;
    setEnabled(nv);
    await db.ref('settings/cheatsEnabled').set(nv);
    toast(nv?'⚡ Читы включены!':'🔒 Читы выключены','ok');
  };

  const applyBest=async()=>{
    if(!enabled)return toast('Сначала включи читы','err');
    if(!best)return toast('Нет лучших карт для этого сценария','err');
    if(!confirm(`Применить лучшие карты для "${ap?.name||'?'}"?`))return;
    setApplying(true);
    try{
      if(!inGame){
        await DB.updateGame(gameId,{[`players/${user.username}`]:{userId:user.username,username:user.username,name:user.displayName||user.username,cards:best,revealed:[],isEliminated:false}});
      } else {
        await DB.updateGame(gameId,{[`players/${user.username}/cards`]:best});
      }
      toast('✅ Лучшие карты применены!','ok');
      setOpen(false);
    }catch(e){toast('Ошибка: '+e.message,'err');}
    setApplying(false);
  };

  return(
    <div style={{marginBottom:4}}>
      <button onClick={()=>setOpen(o=>!o)} style={{
        width:'100%',display:'flex',alignItems:'center',justifyContent:'space-between',
        background:enabled?'rgba(191,90,242,0.13)':'rgba(255,255,255,0.04)',
        border:`1px solid ${enabled?'rgba(191,90,242,0.4)':'rgba(255,255,255,0.1)'}`,
        borderRadius:'var(--rad-sm)',padding:'9px 14px',cursor:'pointer',transition:'.2s',
        fontFamily:"'Inter',sans-serif",
      }}>
        <span style={{fontSize:13,fontWeight:700,color:enabled?'var(--p)':'var(--tx3)',letterSpacing:1}}>
          {enabled?'⚡':'🔒'} ЧИТЫ {enabled?'ВКЛ':'ВЫКЛ'}
        </span>
        <span style={{fontSize:16,color:'var(--tx3)',transform:open?'rotate(180deg)':'none',transition:'.2s'}}>▾</span>
      </button>
      {open&&(
        <div style={{
          background:'rgba(191,90,242,0.06)',border:'1px solid rgba(191,90,242,0.2)',
          borderTop:'none',borderRadius:'0 0 var(--rad-sm) var(--rad-sm)',padding:'12px 14px',
        }}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:10}}>
            <span style={{fontSize:12,color:'var(--tx2)'}}>Читерский режим</span>
            <button onClick={toggleEnabled} style={{
              background:enabled?'rgba(191,90,242,0.3)':'rgba(255,255,255,0.07)',
              border:`1px solid ${enabled?'rgba(191,90,242,0.6)':'rgba(255,255,255,0.15)'}`,
              borderRadius:20,padding:'5px 16px',cursor:'pointer',fontSize:12,fontWeight:700,
              color:enabled?'var(--p)':'var(--tx3)',fontFamily:"'Inter',sans-serif",transition:'.2s',
            }}>{enabled?'● ВКЛ':'○ ВЫКЛ'}</button>
          </div>
          {!best?(
            <div style={{fontSize:11,color:'var(--tx3)',textAlign:'center',padding:'8px 0'}}>
              Сценарий не выбран — лучшие карты недоступны
            </div>
          ):(
            <>
              <div style={{fontSize:11,color:'var(--tx2)',marginBottom:8}}>
                Сценарий: <span style={{color:'var(--p)',fontWeight:700}}>{ap?.emoji} {ap?.name}</span>
              </div>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:4,marginBottom:10}}>
                {Object.entries(best).filter(([k])=>k!=='secret').map(([k,v])=>{
                  const lbl={gender_age:'Пол/Возраст',profession:'Профессия',health:'Здоровье',hobby:'Хобби',baggage:'Багаж',fact:'Факт'}[k]||k;
                  const txt=typeof v==='object'&&v!==null&&'1' in v?`${v[0]} ${v[1]}`:v;
                  return(
                    <div key={k} style={{background:'rgba(0,0,0,0.15)',borderRadius:6,padding:'5px 8px'}}>
                      <div style={{fontSize:9,color:'var(--tx3)',letterSpacing:1,marginBottom:2}}>{lbl.toUpperCase()}</div>
                      <div style={{fontSize:10,color:'var(--tx)',fontWeight:600}}>{txt}</div>
                    </div>
                  );
                })}
              </div>
              <button onClick={applyBest} disabled={applying||!enabled} style={{
                width:'100%',background:enabled?'rgba(191,90,242,0.2)':'rgba(255,255,255,0.05)',
                border:`1px solid ${enabled?'rgba(191,90,242,0.5)':'rgba(255,255,255,0.1)'}`,
                borderRadius:'var(--rad-sm)',padding:'10px',cursor:enabled?'pointer':'not-allowed',
                color:enabled?'var(--p)':'var(--tx3)',fontFamily:"'Inter',sans-serif",
                fontSize:13,fontWeight:700,letterSpacing:1,transition:'.2s',
              }}>
                {applying?'⏳ ПРИМЕНЯЮ...':phase==='lobby'?'⚡ ПРИМЕНИТЬ ДО СТАРТА':'⚡ ПРИМЕНИТЬ СЕЙЧАС'}
              </button>
            </>
          )}
        </div>
      )}
    </div>
  );
}

function LobbyScreen({gameId,user,onBack,onStarted,toast,onViewProfile}){
  const[game,setGame]=useState(null);
  const[copied,setCop]=useState(false);
  const[showInv,setInv]=useState(false);
  const[friends,setFr]=useState({});
  const[allUsers,setAU]=useState({});
  const[sent,setSent]=useState({});

  const startedRef=useRef(false);
  useEffect(()=>{
    const unsub=DB.watchGame(gameId,g=>{
      if(!g)return;
      setGame(g);
      if(g.phase==='playing'&&!startedRef.current){
        startedRef.current=true;
        onStarted();
      }
    });
    return unsub;
  },[gameId]);

  /* FIX: load friends correctly */
  useEffect(()=>{
    if(!showInv)return;
    (async()=>{
      const[fs,au]=await Promise.all([db.ref(`friends/${user.username}`).once('value'),DB.getAllUsers()]);
      setFr(fs.val()||{});setAU(au);
    })();
  },[showInv]);

  const start=async()=>{
    const g=await DB.getGame(gameId);if(!g||g.phase!=='lobby')return;
    const pl=Object.values(g.players||{});
    if(pl.length<2)return toast('Нужно минимум 2 игрока','err');
    const settings=await DB.getSettings();
    const useAdult=!!(g.adultMode&&settings.adultMode);
    const usePackId=g.cardPack||'default';
    const useFunny=!!settings.funnyProf;
    const up={};
    // Если у игрока уже есть карты (применены читы заранее) — не перезаписываем
    pl.forEach(p=>{up[p.username]={...p,cards:p.cards&&typeof p.cards==='object'&&Object.keys(p.cards).length>1?p.cards:mkCards(useAdult,usePackId,useFunny),revealed:[],isEliminated:false};});
    // Раздача ролей если включено
    if(g.roles){
      const rolePool=[...ROLES.filter(r=>r.id!=='civilian')];
      const shuffled=[...rolePool].sort(()=>Math.random()-.5);
      pl.forEach((p,i)=>{
        const role=shuffled[i]||{id:'civilian',icon:'👤',name:'Обычный',color:'var(--tx3)',desc:'Никакой особой роли. Выживи любой ценой.'};
        up[p.username].role=role.id;
      });
    }
    // Раздача комнат бункера если включено (храним ОТДЕЛЬНО от players!)
    let roomAssignData={};
    if(g.bunkerMap){
      const rooms=[...BUNKER_ROOMS].sort(()=>Math.random()-.5).slice(0,Math.min(BUNKER_ROOMS.length,pl.length));
      pl.forEach((p,i)=>{ roomAssignData[p.username]=rooms[i%rooms.length].id; });
    }
    // B3: Сохраняем данные пользователей (аватары, рамки, эффекты карточек) в игру
    const allUsersSnap = await DB.getAllUsers();
    const _allUsers = {};
    pl.forEach(p => {
      const ud = allUsersSnap[p.username];
      if (ud) _allUsers[p.username] = { avatar: ud.avatar||'', equipped: ud.equipped||{} };
    });
    const newGame={...g,players:up,bunkerSpots:Math.ceil(pl.length/2),phase:'playing',round:1,votes:{},revealedThisRound:{},eliminated:[],lastEliminated:null,chat:g.chat||null,voteLog:g.voteLog||{},roomAssign:roomAssignData,roundTimerStart:g.roundTimerSeconds?Date.now():null,_allUsers};
    await DB.setGame(gameId,newGame);
    DB.logEvent(gameId,'start',`Игра началась! Участники: ${pl.map(p=>p.name||p.username).join(', ')}`,user.username);
    await Promise.all(pl.map(p=>DB.updateUser(p.username,{gamesPlayed:firebase.database.ServerValue.increment(1)})));
    // Начисляем монеты и XP за участие в игре
    await Promise.all(pl.map(p=>DB.addCoins(p.username, 30)));
    await Promise.all(pl.map(p=>DB.addXP(p.username, XP_REWARDS.game)));
    // Award achievements after game starts
    await Promise.all(pl.map(async p=>{const ud=await DB.getUser(p.username);if(ud)await checkAndAwardAchievements(p.username,{...ud,gamesPlayed:(ud.gamesPlayed||0)+1},null);}));
  };
  const leave=async()=>{
    if(!window.confirm('Покинуть лобби?'))return;
    const g=await DB.getGame(gameId);if(!g)return onBack();
    const pl={...g.players};delete pl[user.username];
    if(!Object.keys(pl).length){await db.ref(`games/${gameId}`).remove();}
    else{
      const upd={[`players/${user.username}`]:null};
      if(g.creatorId===user.username)upd.creatorId=Object.keys(pl)[0];
      await DB.updateGame(gameId,upd);
    }
    onBack();
  };
  const kickPlayer=async(pid)=>{
    if(!window.confirm(`Кикнуть ${pid} из лобби?`))return;
    const g=await DB.getGame(gameId);if(!g)return;
    await DB.updateGame(gameId,{[`players/${pid}`]:null});
    toast(`👢 ${pid} кикнут из лобби`,'ok');
  };
  const copy=()=>{navigator.clipboard?.writeText(gameId).catch(()=>{});setCop(true);setTimeout(()=>setCop(false),2000);toast('Код скопирован!','ok');};
  const invite=async(fid)=>{
    if(sent[fid])return;
    if(game?.players?.[fid])return toast('Уже в лобби','err');
    await DB.sendGameInvite(user.username,user.displayName||user.username,fid,gameId);
    setSent(p=>({...p,[fid]:true}));toast('Приглашение отправлено!','ok');
    // B4: Инкремент квеста 'invite'
    const todayStr=new Date().toDateString();
    const qd=await DB.getDailyQuests(user.username);
    if(qd&&qd.date===todayStr){
      let earned=0;
      const upd={...qd,quests:qd.quests.map(q=>{
        if(q.done||q.type!=='invite')return q;
        const np=Math.min((q.progress||0)+1,q.goal);
        const done=np>=q.goal;
        if(done&&!q.done)earned+=q.reward;
        return{...q,progress:np,done};
      })};
      await DB.saveDailyQuests(user.username,upd);
      if(earned>0)await DB.addCoins(user.username,earned);
    }
  };

  if(!game)return<div className="sc"><Spin/></div>;
  const ap=game.apocalypse||{};
  const players=Object.values(game.players||{});
  const isCreator=game.creatorId===user.username;
  const fIds=Object.keys(friends);
  const fNotIn=fIds.filter(fid=>!game.players?.[fid]&&allUsers[fid]);

  return(
    <div className="sc">
      <HZ/>
      <div className="tb">
        <div className="led led-g"/>
        <div className="tb-title">ЛОББИ {game?.isRated&&<span style={{fontSize:11,background:'rgba(77,166,255,0.15)',border:'1px solid rgba(77,166,255,0.3)',color:'#4da6ff',borderRadius:6,padding:'2px 7px',fontWeight:700,verticalAlign:'middle'}}>🏅 РЕЙТ</span>}</div>
        <div className="mono" style={{fontSize:10,letterSpacing:2,color:'var(--tx3)'}}>{players.length}/16</div>
      </div>
      <div className="scr-raw" style={{paddingBottom:100}}>
        {game.adultMode&&<div style={{background:'var(--rt)',border:'1px solid var(--rb)',padding:'8px 12px',marginBottom:10,display:'flex',alignItems:'center',gap:8,fontFamily:"'Inter',sans-serif",fontSize:10,letterSpacing:2,color:'var(--r)'}}>🔞 ВЗРОСЛЫЙ РЕЖИМ — 18+</div>}
      {game.isUniversityMode&&<div style={{background:'rgba(77,166,255,0.08)',border:'1px solid rgba(77,166,255,0.3)',padding:'8px 12px',marginBottom:10,display:'flex',alignItems:'center',gap:8,fontFamily:"'Inter',sans-serif",fontSize:10,letterSpacing:2,color:'#4da6ff'}}>🎓 УНИВЕРСИТЕТСКИЙ РЕЖИМ</div>}
        <div className="card" style={{marginBottom:12}}>
          <div style={{fontSize:36,marginBottom:6}}>{ap.emoji}</div>
          <div style={{fontFamily:"'Inter',sans-serif",fontSize:22,letterSpacing:2,color:'var(--a)'}}>{ap.name}</div>
          <div style={{fontSize:12,color:'var(--tx3)',lineHeight:1.5,marginTop:5}}>{ap.description}</div>
          <div style={{marginTop:10,padding:'8px 10px',background:'var(--at)',borderLeft:'2px solid var(--a)',fontSize:12,color:'var(--a2)'}}>🎯 {ap.victory}</div>
        </div>
        <div className="code-box" onClick={copy}>
          {gameId}
          <div className="mono" style={{fontSize:9,color:copied?'var(--g)':'var(--tx3)',letterSpacing:2,marginTop:4}}>{copied?'✓ СКОПИРОВАНО':'НАЖМИТЕ ЧТОБЫ СКОПИРОВАТЬ'}</div>
        </div>
        {isCreator&&<Btn ch="👥 ПРИГЛАСИТЬ ДРУЗЕЙ" onClick={()=>setInv(true)} cls="btn-c" sm style={{marginBottom:10}}/>}
        <div className="lbl">ИГРОКИ</div>
        {players.map(p=>{
          const isMe=p.username===user.username,isCr=p.username===game.creatorId;
          return(
            <div key={p.username} className={`prow${isMe?' me':''}`} style={{cursor:!isMe&&onViewProfile?'pointer':'default'}} onClick={()=>!isMe&&onViewProfile&&onViewProfile(p.username)}>
              <Avatar name={p.name||p.username} size="sm" avatar={allUsers?.[p.username]?.avatar} frame={allUsers?.[p.username]?.equipped?.frame}/>
              <div style={{flex:1,fontSize:14,fontWeight:600}}>{p.name}</div>
              {isCr&&<span className="bdg bdg-a">СОЗДАТЕЛЬ</span>}
              {isMe&&<span className="bdg bdg-c">ВЫ</span>}
              {isCreator&&!isMe&&!isCr&&(
                <button onClick={e=>{e.stopPropagation();kickPlayer(p.username);}} style={{background:'rgba(255,69,58,0.12)',border:'1px solid rgba(255,69,58,0.3)',color:'var(--r)',borderRadius:8,padding:'4px 10px',fontSize:12,cursor:'pointer',flexShrink:0,transition:'.15s'}} title="Кикнуть">👢</button>
              )}
            </div>
          );
        })}
      </div>
      {user.isAdmin&&<AdminCheatPanel gameId={gameId} game={game} user={user} toast={toast} phase="lobby"/>}
      <div className="fixbot">
        {isCreator
          ?<Btn ch={players.length<2?`⚡ ЖДЁМ (${players.length}/2)`:'⚡ НАЧАТЬ ИГРУ'} onClick={start} disabled={players.length<2}/>
          :<div className="mono" style={{textAlign:'center',fontSize:10,letterSpacing:2,color:'var(--tx3)',padding:'4px 0'}}>ОЖИДАНИЕ СОЗДАТЕЛЯ…</div>
        }
        <Btn ch="↩ ПОКИНУТЬ ЛОББИ" onClick={leave} cls="btn-g" sm/>
      </div>

      {showInv&&(
        <div className="modal-bg" onClick={e=>e.target===e.currentTarget&&setInv(false)}>
          <div className="modal-box">
            <div className="modal-hd">
              <span className="modal-ttl">👥 ПРИГЛАСИТЬ ДРУЗЕЙ</span>
              <button className="modal-cls" onClick={()=>setInv(false)}>✕</button>
            </div>
            <div className="modal-bd">
              {!Object.keys(allUsers).length?<Spin/>:fNotIn.length===0?(
                <div className="mono" style={{textAlign:'center',color:'var(--tx3)',fontSize:10,letterSpacing:2,padding:24}}>
                  {fIds.length===0?'НЕТ ДРУЗЕЙ':'ВСЕ ДРУЗЬЯ УЖЕ В ЛОББИ'}
                </div>
              ):fNotIn.map(fid=>{
                const fu=allUsers[fid];if(!fu)return null;
                return(
                  <div key={fid} className="fi">
                    <div style={{flex:1}}>
                      <div style={{fontSize:14,fontWeight:600}}>{fu.displayName||fu.username}</div>
                      <div className="mono" style={{fontSize:8,color:'var(--tx3)'}}>@{fu.username}</div>
                    </div>
                    <button onClick={()=>invite(fid)} style={{background:sent[fid]?'var(--gt)':'var(--at)',border:`1px solid ${sent[fid]?'var(--gb)':'var(--ab)'}`,color:sent[fid]?'var(--g)':'var(--a)',fontFamily:"'Inter',sans-serif",fontSize:10,padding:'6px 12px',cursor:sent[fid]?'default':'pointer',letterSpacing:1,transition:'.2s'}}>
                      {sent[fid]?'✓ ОТПРАВЛЕНО':'⚡ ПРИГЛАСИТЬ'}
                    </button>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   GAME WRAPPER
══════════════════════════════════════════════════════════ */
function WinParticles({iWon}){
  const ref=useRef(null);
  useEffect(()=>{
    const el=ref.current;if(!el)return;
    el.innerHTML='';
    if(iWon){
      const colors=['#ff453a','#30d158','#0a84ff','#bf5af2','#f0a500','#ff6b9d'];
      for(let i=0;i<60;i++){
        const d=document.createElement('div');
        const color=colors[Math.floor(Math.random()*colors.length)];
        const left=Math.random()*100;
        const dur=2+Math.random()*2;
        const delay=Math.random()*2;
        const w=6+Math.random()*6;
        const h=8+Math.random()*8;
        d.style.cssText=`position:absolute;left:${left}%;top:0;width:${w}px;height:${h}px;background:${color};border-radius:2px;animation:confettiFall ${dur}s ease-in ${delay}s both;`;
        el.appendChild(d);
      }
    } else {
      for(let i=0;i<20;i++){
        const d=document.createElement('div');
        const left=Math.random()*100;
        const top=Math.random()*80;
        const dur=2+Math.random()*2;
        const delay=Math.random()*3;
        d.style.cssText=`position:absolute;left:${left}%;top:${top}%;font-size:${18+Math.random()*14}px;animation:skullFloat ${dur}s ease-in-out ${delay}s infinite;`;
        d.textContent='☠';
        el.appendChild(d);
      }
    }
  },[iWon]);
  return <div ref={ref} className="win-particles"/>;
}

function GameWrapper({gameId,user,onExit,toast,onViewProfile,online}){
  const[game,setGame]=useState(null);
  const[sub,setSub]=useState('round');
  const[confirmReveal,setConfirmReveal]=useState(null);
  const[tappedCard,setTappedCard]=useState(null);
  const[secretTargetModal,setSecretTargetModal]=useState(null);
  const[showApocModal,setShowApocModal]=useState(false);
  const allUsersData=game?._allUsers||{};
  const[selVote,setSelVote]=useState(undefined);
  const[showChat,setShowChat]=useState(false);
  const[unread,setUnread]=useState(0);
  const[eventLog,setEventLog]=useState([]);
  const[reactions,setReactions]=useState({});
  const[showReactPicker,setShowReactPicker]=useState(null); // {username,cardKey}
  const[notes,setNotes]=useState('');
  const[roundTimerLeft,setRoundTimerLeft]=useState(null);
  const prevElim=useRef(0);
  const prevPhase=useRef(null);
  const tallying=useRef(false);
  const lastChat=useRef(0);
  const roundTimerRef=useRef(null);

  useEffect(()=>{
    const unsub=DB.watchGame(gameId,async g=>{
      if(!g)return;
      if(g.phase==='voting'&&g.creatorId===user.username&&!tallying.current){
        const alive=Object.values(g.players||{}).filter(p=>!p.isEliminated);
        const voted=Object.keys(g.votes||{}).length;
        if(alive.length>0&&voted>=alive.length){
          tallying.current=true;
          try{
            const copy=JSON.parse(JSON.stringify(g));processVotes(copy);
            if(copy.phase==='finished'){
              const surv=Object.values(copy.players).filter(p=>!p.isEliminated).map(p=>p.username);
              const all=Object.keys(copy.players);
              await Promise.all([...surv.map(uid=>DB.updateUser(uid,{gamesWon:firebase.database.ServerValue.increment(1)})),...all.filter(u=>!surv.includes(u)).map(uid=>DB.updateUser(uid,{gamesEliminated:firebase.database.ServerValue.increment(1)}))]);
              // Монеты за победу (+100) и за участие в финале (+20)
              await Promise.all([...surv.map(uid=>DB.addCoins(uid,100)),...all.filter(u=>!surv.includes(u)).map(uid=>DB.addCoins(uid,20))]);
              // Сохраняем историю игры для каждого игрока
              const histEntry={apoc:g.apocalypse?.name||'Бункер',apocEmoji:g.apocalypse?.emoji||'☢️',rounds:g.round||1,players:all.length,pack:g.cardPack||'default'};
              await Promise.all(all.map(uid=>DB.saveGameHistory(uid,{...histEntry,won:surv.includes(uid)})));
              // ── Ежедневные задания (авто-tally) ──
              const todayStr=new Date().toDateString();
              await Promise.all(all.map(async uid=>{
                const qd=await DB.getDailyQuests(uid);
                if(!qd||qd.date!==todayStr)return;
                const isSurv=surv.includes(uid);
                const pp=copy.players[uid];
                const revsCount=(pp?.revealed||[]).length;
                const secretUsed=!!(copy.usedSecrets||{})[uid];
                let coinsEarned=0;
                const upd={...qd,quests:qd.quests.map(q=>{
                  if(q.done)return q;
                  let np=q.progress||0;
                  if(q.type==='play') np=Math.min(np+1,q.goal);
                  else if(q.type==='win'&&isSurv) np=Math.min(np+1,q.goal);
                  else if(q.type==='reveal') np=Math.min(np+revsCount,q.goal);
                  else if(q.type==='secret'&&secretUsed) np=Math.min(np+1,q.goal);
                  const done=np>=q.goal;
                  if(done&&!q.done)coinsEarned+=q.reward;
                  return{...q,progress:np,done};
                })};
                await DB.saveDailyQuests(uid,upd);
                if(coinsEarned>0)await DB.addCoins(uid,coinsEarned);
              }));
              // Log game end
              DB.logEvent(gameId,'end',`Игра завершена! Выжившие: ${surv.map(u=>copy.players[u]?.name||u).join(', ')}`,user.username);
              // Эло рейтинг
              if(copy.isRated&&all.length>=2){
                const eloData=await Promise.all(all.map(async uid=>{const ud=await DB.getUser(uid);return{uid,elo:ud?.elo||1000,eloGames:ud?.eloGames||0};}));
                const avgElo=eloData.reduce((s,e)=>s+e.elo,0)/eloData.length;
                await Promise.all(eloData.map(async({uid,elo,eloGames})=>{
                  const isSurv=surv.includes(uid);
                  const K=32;
                  const expected=1/(1+Math.pow(10,(avgElo-elo)/400));
                  const score=isSurv?1:0;
                  const delta=Math.round(K*(score-expected));
                  const newElo=Math.max(100,elo+delta);
                  await DB.updateUser(uid,{elo:newElo,eloGames:eloGames+1,eloDelta:delta});
                }));
              }
              // Award achievements
              await Promise.all(all.map(async uid=>{
                const ud=await DB.getUser(uid);if(!ud)return;
                const isSurv=surv.includes(uid);
                const pp=copy.players[uid];
                const totalRevd=(pp?.revealed||[]).length;
                const totalCards=CARDS.filter(c=>c.key!=='secret').length;
                const wonWithoutAll=isSurv&&totalRevd<totalCards;
                await checkAndAwardAchievements(uid,{...ud,gamesWon:(ud.gamesWon||0)+(isSurv?1:0),gamesEliminated:(ud.gamesEliminated||0)+(!isSurv?1:0)},{wonWithoutAllCards:wonWithoutAll});
              }));
            } else {
              // Elimination event
              if(copy.lastEliminated){
                DB.logEvent(gameId,'elim',`${copy.lastEliminated.name} выбыл из бункера!`,copy.lastEliminated.userId||'');
              }
            }
            await DB.setGame(gameId,copy);
          }catch(e){console.error(e);}
          tallying.current=false;return;
        }
      }
      const el=(g.eliminated||[]).length;
      if(el>prevElim.current&&g.lastEliminated){prevElim.current=el;setSub('elim');}
      if(g.phase!==prevPhase.current){
        prevPhase.current=g.phase;
        if(g.phase==='voting'){setSelVote(undefined);setSub('vote');}
        if(g.phase==='debates')setSub('debates');
        if(g.phase==='playing')setSub(prev=>prev==='elim'||prev==='vote'||prev==='debates'?'round':prev);
        if(g.phase==='finished')setSub('over');
        if(g.phase==='lobby')onExit();
      }
      setGame(g);
    });
    return unsub;
  },[gameId]);

  useEffect(()=>{
    const unsub=DB.watchGameChat(gameId,msgs=>{
      if(!showChat){const nc=msgs.length-lastChat.current;if(nc>0)setUnread(p=>p+nc);}
      lastChat.current=msgs.length;
    });
    return unsub;
  },[gameId,showChat]);

  // Автоголосование: если включено и все живые игроки выложили все карты — запускаем голосование
  // ВАЖНО: useEffect должен быть ДО любых early return
  useEffect(()=>{
    if(!game||game.phase!=='playing'||!game.autoVote||game.creatorId!==user.username)return;
    const aliveP=Object.values(game.players||{}).filter(p=>!p.isEliminated);
    const allDone=aliveP.every(p=>{
      const done=(game.revealedThisRound||{})[p.username]||0;
      return done>=(game.maxReveals||2);
    });
    if(allDone&&aliveP.length>1&&!game._autoVotePending){
      if(game.debates){
        DB.updateGame(gameId,{phase:'debates',debateStart:Date.now(),votes:{},_autoVotePending:true});
      } else {
        DB.updateGame(gameId,{phase:'voting',votes:{},_autoVotePending:true});
      }
    }
  },[game]);

  // Дебаты: автопереход в голосование через 60 сек (только создатель)
  useEffect(()=>{
    if(!game||game.phase!=='debates'||game.creatorId!==user.username)return;
    const elapsed=Date.now()-(game.debateStart||Date.now());
    const remaining=Math.max(0,60000-elapsed);
    const t=setTimeout(()=>{
      DB.updateGame(gameId,{phase:'voting',votes:{}});
    },remaining);
    return()=>clearTimeout(t);
  },[game?.phase,game?.debateStart]);

  // Радиопереговоры — state ОБЯЗАТЕЛЬНО до early return
  useOnline(gameId,user.username);
  const onlinePlayers=useOnlinePlayers(gameId);
  const[radioTarget,setRadioTarget]=useState(null);
  const[radioMsgs,setRadioMsgs]=useState([]);
  const[radioInput,setRadioInput]=useState('');
  const[secretModalOpen,setSecretModalOpen]=useState(false);
  useEffect(()=>{
    if(!radioTarget||!gameId)return;
    const radioKey=[user.username,radioTarget].sort().join('_');
    const ref=db.ref(`radioChats/${gameId}/${radioKey}`);
    const cb=ref.on('value',snap=>{
      const d=snap.val();
      setRadioMsgs(d?Object.values(d).sort((a,b)=>a.ts-b.ts):[]);
    });
    return()=>ref.off('value',cb);
  },[radioTarget,gameId]);

  // Watch event log
  useEffect(()=>{
    const u=DB.watchEventLog(gameId,log=>setEventLog(log));
    return u;
  },[gameId]);

  // Watch reactions
  useEffect(()=>{
    const u=DB.watchReactions(gameId,r=>setReactions(r));
    return u;
  },[gameId]);

  // Load personal notes
  useEffect(()=>{
    const key=`notes_${gameId}_${user.username}`;
    setNotes(localStorage.getItem(key)||'');
  },[gameId,user.username]);

  // Round timer
  useEffect(()=>{
    if(!game||!game.roundTimerSeconds||game.phase!=='playing')return;
    if(roundTimerRef.current)clearInterval(roundTimerRef.current);
    const startTs=game.roundTimerStart||Date.now();
    const totalMs=game.roundTimerSeconds*1000;
    const tick=()=>{
      const elapsed=Date.now()-startTs;
      const left=Math.max(0,Math.ceil((totalMs-elapsed)/1000));
      setRoundTimerLeft(left);
      if(left<=0&&game.creatorId===user.username&&game.phase==='playing'){
        clearInterval(roundTimerRef.current);
        if(game.debates){
          DB.updateGame(gameId,{phase:'debates',debateStart:Date.now(),votes:{}});
        } else {
          DB.updateGame(gameId,{phase:'voting',votes:{}});
        }
      }
    };
    tick();
    roundTimerRef.current=setInterval(tick,1000);
    return()=>clearInterval(roundTimerRef.current);
  },[game?.roundTimerSeconds,game?.roundTimerStart,game?.phase]);

  // nextSub — вычисляем ДО early return чтобы было доступно везде
  const nextSub=game
    ? game.phase==='finished'?'over'
      :game.phase==='voting'?'vote'
      :game.phase==='debates'?'debates'
      :'round'
    : 'round';

  // Таймер дебатов — ПЕРЕД early return (правила хуков React)
  const[debateTimeLeft,setDebateTimeLeft]=useState(60);
  useEffect(()=>{
    if(!game||game.phase!=='debates')return;
    const tick=()=>setDebateTimeLeft(Math.max(0,60-Math.floor((Date.now()-(game.debateStart||Date.now()))/1000)));
    tick();
    const t=setInterval(tick,1000);
    return()=>clearInterval(t);
  },[game?.phase,game?.debateStart]);

  if(!game)return<div className="sc" style={{alignItems:'center',justifyContent:'center',gap:16}}><div style={{fontSize:40}}>☢</div><div style={{fontSize:14,color:'var(--tx3)'}}>Загружаем бункер...</div><div className="spin"/></div>;

  // Game chat full overlay
  if(showChat){
    return(
      <div className="gchat">
        <GameChatInner gameId={gameId} user={user} onClose={()=>{setShowChat(false);setUnread(0);}}/>
      </div>
    );
  }

  const me=(game.players||{})[user.username];
  const isCreator=game.creatorId===user.username;
  const alive=Object.values(game.players||{}).filter(p=>!p.isEliminated);
  const ap=game.apocalypse||{};
  const maxRev=game.maxReveals||2;
  const revDone=(game.revealedThisRound||{})[user.username]||0;
  const extraRev=(game.extraReveals||{})[user.username]||0;
  const revLeft=(maxRev+extraRev)-revDone;
  const mySecretCard=me?.cards?.secret?ALL_SECRET_CARDS.find(s=>s.id===me.cards.secret):null;
  const mySecretUsed=!!(game.usedSecrets||{})[user.username];

  // debateTimeLeft обновляется выше (до early return)

  const useSecretCard=async(sc,targetUsername=null)=>{
    if(!me||me.isEliminated)return toast('Вы выбыли','err');
    if((game.usedSecrets||{})[user.username])return toast('Карта уже использована','err');
    const effect=sc.effect;
    // Эффекты требующие выбора цели — показываем модал
    const needsTarget=['swap_card','steal_reveal','truth_serum','lie_detector','amnesia','sabotage','mirror','redirect_vote','shield'];
    if(needsTarget.includes(effect)&&!targetUsername){
      setSecretTargetModal({sc});
      setTappedCard(null);
      setSecretModalOpen(false);
      return;
    }
    const upd={[`usedSecrets/${user.username}`]:true};
    if(effect==='extra_reveal'){
      upd[`extraReveals/${user.username}`]=(game.extraReveals?.[user.username]||0)+1;
      toast(`✨ ${sc.name}: +1 раскрытие в этом раунде!`,'ok');
    } else if(effect==='double_vote'){
      upd[`doubleVote/${user.username}`]=true;
      toast(`⚡ ${sc.name}: твой голос удвоен в следующем голосовании!`,'ok');
    } else if(effect==='no_vote'){
      upd[`noVote/${user.username}`]=true;
      toast(`🔇 ${sc.name}: ты добровольно отказался от голоса.`,'');
    } else if(effect==='immunity'){
      upd[`immunity/${user.username}`]=true;
      toast(`🛡️ ${sc.name}: ты под защитой в этом голосовании!`,'ok');
    } else if(effect==='secret_vote'){
      upd[`secretVote/${user.username}`]=true;
      toast(`🕵️ ${sc.name}: твой голос будет тайным!`,'ok');
    } else if(effect==='hide_card'){
      const revealed=me.revealed||[];
      if(!revealed.length){toast('🌫️ Нет раскрытых карт для скрытия','err');return;}
      const toHide=revealed[Math.floor(Math.random()*revealed.length)];
      upd[`players/${user.username}/revealed`]=revealed.filter(k=>k!==toHide);
      toast(`🌫️ ${sc.name}: карта "${CARDS.find(c=>c.key===toHide)?.label||toHide}" снова скрыта!`,'ok');
    } else if(effect==='random_elim'){
      upd[`tiebreaker/${user.username}`]=true;
      toast(`🎲 ${sc.name}: при ничье — ты выбираешь кто выбывает!`,'ok');
    } else if(effect==='swap_card'&&targetUsername){
      // Меняем случайную карту с целью
      const targetPlayer=game.players[targetUsername];
      if(!targetPlayer?.cards)return toast('Цель не имеет карт','err');
      const myCardKeys=CARDS.filter(c=>c.key!=='secret').map(c=>c.key);
      const targetCardKeys=CARDS.filter(c=>c.key!=='secret').map(c=>c.key);
      const myKey=myCardKeys[Math.floor(Math.random()*myCardKeys.length)];
      const theirKey=targetCardKeys[Math.floor(Math.random()*targetCardKeys.length)];
      const myVal=me.cards[myKey];
      const theirVal=targetPlayer.cards[theirKey];
      upd[`players/${user.username}/cards/${myKey}`]=theirVal;
      upd[`players/${targetUsername}/cards/${theirKey}`]=myVal;
      const myLabel=CARDS.find(c=>c.key===myKey)?.label||myKey;
      const theirLabel=CARDS.find(c=>c.key===theirKey)?.label||theirKey;
      toast(`🔄 ${sc.name}: твой "${myLabel}" ↔ "${theirLabel}" ${targetPlayer.name||targetUsername}!`,'ok');
    } else if(effect==='steal_reveal'&&targetUsername){
      // Видим одну случайную нераскрытую карту цели (только тебе)
      const targetPlayer=game.players[targetUsername];
      const unrevKeys=CARDS.filter(c=>c.key!=='secret'&&!(targetPlayer?.revealed||[]).includes(c.key));
      if(!unrevKeys.length)return toast('У цели нет скрытых карт','err');
      const peekCard=unrevKeys[Math.floor(Math.random()*unrevKeys.length)];
      const peekVal=targetPlayer?.cards?.[peekCard.key]||'—';
      // Показываем тост — только этот игрок видит
      toast(`👁️ ${sc.name}: ${targetPlayer.name||targetUsername} → ${peekCard.label}: ${peekVal}`,'ok');
    } else if(effect==='truth_serum'&&targetUsername){
      // Форсируем раскрытие профессии цели
      const targetPlayer=game.players[targetUsername];
      if(!targetPlayer?.cards)return toast('Цель не имеет карт','err');
      const curRevealed=targetPlayer.revealed||[];
      if(!curRevealed.includes('profession')){
        upd[`players/${targetUsername}/revealed`]=[...curRevealed,'profession'];
      }
      upd[`secretEffect/${targetUsername}/truth_serum`]=user.username;
      toast(`💉 ${sc.name}: ${targetPlayer.name||targetUsername} обязан раскрыть профессию!`,'ok');
    } else if(effect==='lie_detector'&&targetUsername){
      const targetPlayer=game.players[targetUsername];
      const unrevKeys=CARDS.filter(c=>c.key!=='secret'&&!(targetPlayer?.revealed||[]).includes(c.key));
      if(!unrevKeys.length)return toast('У цели нет скрытых карт','err');
      const peekCard=unrevKeys[Math.floor(Math.random()*unrevKeys.length)];
      const peekVal=targetPlayer?.cards?.[peekCard.key]||'—';
      toast(`📡 ${sc.name}: тебе тайно сообщают — ${targetPlayer.name||targetUsername} → ${peekCard.label}: ${peekVal}`,'ok');
    } else if(effect==='amnesia'&&targetUsername){
      const targetPlayer=game.players[targetUsername];
      const revKeys=targetPlayer?.revealed||[];
      if(!revKeys.length)return toast('У цели нет раскрытых карт','err');
      const toHide=revKeys[Math.floor(Math.random()*revKeys.length)];
      upd[`players/${targetUsername}/revealed`]=revKeys.filter(k=>k!==toHide);
      toast(`🧠 ${sc.name}: "${CARDS.find(c=>c.key===toHide)?.label||toHide}" у ${game.players[targetUsername]?.name||targetUsername} снова скрыта!`,'ok');
    } else if(effect==='sabotage'&&targetUsername){
      upd[`sabotaged/${targetUsername}`]=user.username;
      toast(`💣 ${sc.name}: раскрытия ${game.players[targetUsername]?.name||targetUsername} не учитываются этот раунд!`,'ok');
    } else if(effect==='mirror'&&targetUsername){
      upd[`mirror/${user.username}`]=targetUsername;
      toast(`🪞 ${sc.name}: если ${game.players[targetUsername]?.name||targetUsername} голосует против тебя — он получает штрафной голос!`,'ok');
    } else if(effect==='redirect_vote'&&targetUsername){
      upd[`redirectVote/${user.username}`]=targetUsername;
      toast(`🔀 ${sc.name}: твой голос будет перенаправлен на ${game.players[targetUsername]?.name||targetUsername}!`,'ok');
    } else if(effect==='shield'&&targetUsername){
      upd[`shield/${user.username}`]=true;
      toast(`🪖 ${sc.name}: щит активирован — если 3+ голосов против тебя, один аннулируется!`,'ok');
    } else {
      toast(`${sc.icon} ${sc.name} активирована!`,'ok');
    }
    await DB.updateGame(gameId,upd);
    setSecretTargetModal(null);
    setSecretModalOpen(false);
    setTappedCard(null);
    setSub('round');
    // B2/Feature13: Достижение за использование секретной карты
    const ud=await DB.getUser(user.username);
    if(ud) await checkAndAwardAchievements(user.username,ud,{usedSecret:true});
  };

  const doReveal=async(k)=>{
    if(!me||me.isEliminated)return;
    if(me.revealed?.includes(k))return toast('Уже раскрыта','err');
    if(revLeft<=0)return toast(`Лимит: ${maxRev} карт за раунд`,'err');
    const nr=[...(me.revealed||[]),k];
    const cardLabel=CARDS.find(c=>c.key===k)?.label||k;
    await DB.updateGame(gameId,{[`players/${user.username}/revealed`]:nr,[`revealedThisRound/${user.username}`]:revDone+1});
    DB.logEvent(gameId,'reveal',`${user.displayName||user.username} раскрыл карту: ${cardLabel}`,user.username);
    toast('✅ Карта раскрыта!','ok');setSub('round');
    // B2/Feature13: Достижение за раскрытие всех карт
    const totalNonSecret=CARDS.filter(c=>c.key!=='secret').length;
    if(nr.length>=totalNonSecret){
      const ud=await DB.getUser(user.username);
      if(ud) await checkAndAwardAchievements(user.username,ud,{revealedAll:true});
    }
    // Квест за раскрытие карты
    const todayStr=new Date().toDateString();
    const qd=await DB.getDailyQuests(user.username);
    if(qd&&qd.date===todayStr){
      let earned=0;
      const upd={...qd,quests:qd.quests.map(q=>{
        if(q.done||q.type!=='reveal')return q;
        const np=Math.min((q.progress||0)+1,q.goal);
        const done=np>=q.goal;
        if(done&&!q.done)earned+=q.reward;
        return{...q,progress:np,done};
      })};
      await DB.saveDailyQuests(user.username,upd);
      if(earned>0){await DB.addCoins(user.username,earned);toast(`🎯 Задание выполнено! +${earned} монет`,'ok');}
    }
  };
  const startVote=async()=>{
    if(game.phase!=='playing')return;
    if(game.debates){
      // Сначала дебаты — фаза 'debates' на 60 секунд
      await DB.updateGame(gameId,{phase:'debates',debateStart:Date.now(),votes:{}});
      toast('🎤 Дебаты начались! 60 секунд на защиту','ok');
    } else {
      await DB.updateGame(gameId,{phase:'voting',votes:{}});
      setSelVote(undefined);
      toast('🗳 Голосование началось!','ok');
    }
  };
  const castVote=async(tid)=>{
    if(game.phase!=='voting')return;
    if((game.votes||{})[user.username]!==undefined)return toast('Вы уже проголосовали','err');
    await DB.updateGame(gameId,{[`votes/${user.username}`]:(tid===undefined||tid===null)?null:tid});
    const targetName=tid?(game.players[tid]?.name||tid):'воздержался';
    DB.logEvent(gameId,'vote',`${user.displayName||user.username} проголосовал за: ${targetName}`,user.username);
  };
  const tally=async()=>{
    if(tallying.current)return;
    const g=await DB.getGame(gameId);if(!g||g.phase!=='voting')return;
    tallying.current=true;
    try{
      const copy=JSON.parse(JSON.stringify(g));processVotes(copy);
      if(copy.phase==='finished'){
        const surv=Object.values(copy.players).filter(p=>!p.isEliminated).map(p=>p.username);
        const all=Object.keys(copy.players);
        await Promise.all([
          ...surv.map(uid=>DB.updateUser(uid,{gamesWon:firebase.database.ServerValue.increment(1)})),
          ...all.filter(u=>!surv.includes(u)).map(uid=>DB.updateUser(uid,{gamesEliminated:firebase.database.ServerValue.increment(1)}))
        ]);
        // Монеты и XP за победу (+100/+20)
        await Promise.all([...surv.map(uid=>DB.addCoins(uid,100)),...all.filter(u=>!surv.includes(u)).map(uid=>DB.addCoins(uid,20))]);
        await Promise.all([...surv.map(uid=>DB.addXP(uid,XP_REWARDS.win)),...all.filter(u=>!surv.includes(u)).map(uid=>DB.addXP(uid,15))]);
        // Расчёт Эло для рейтинговой игры
        if(copy.isRated&&all.length>=2){
          const K=32;
          const eloData=await Promise.all(all.map(async uid=>{const ud=await DB.getUser(uid);return{uid,elo:ud?.elo||1000,eloGames:ud?.eloGames||0};}));
          const avgElo=eloData.reduce((s,e)=>s+e.elo,0)/eloData.length;
          await Promise.all(eloData.map(async({uid,elo,eloGames})=>{
            const isSurv=surv.includes(uid);
            const expected=1/(1+Math.pow(10,(avgElo-elo)/400));
            const score=isSurv?1:0;
            const delta=Math.round(K*(score-expected));
            const newElo=Math.max(100,elo+delta);
            await DB.updateUser(uid,{elo:newElo,eloGames:eloGames+1,eloDelta:delta});
          }));
        }
        // Достижения
        await Promise.all(all.map(async uid=>{
          const ud=await DB.getUser(uid);if(!ud)return;
          const isSurv=surv.includes(uid);
          const pp=copy.players[uid];
          const totalRevd=(pp?.revealed||[]).length;
          const totalCards=CARDS.filter(c=>c.key!=='secret').length;
          await checkAndAwardAchievements(uid,{...ud,gamesWon:(ud.gamesWon||0)+(isSurv?1:0),gamesEliminated:(ud.gamesEliminated||0)+(!isSurv?1:0)},{wonWithoutAllCards:isSurv&&totalRevd<totalCards});
        }));
        // ── История игр ──
        const histEntry={apoc:g.apocalypse?.name||'Бункер',apocEmoji:g.apocalypse?.emoji||'☢️',rounds:g.round||1,players:all.length,pack:g.cardPack||'default'};
        await Promise.all(all.map(uid=>DB.saveGameHistory(uid,{...histEntry,won:surv.includes(uid)})));
        // ── Ежедневные задания ──
        const today=new Date().toDateString();
        await Promise.all(all.map(async uid=>{
          const qd=await DB.getDailyQuests(uid);
          if(!qd)return;
          if(qd.date!==today)return; // если задания не от сегодня — не обновляем
          const isSurv=surv.includes(uid);
          const pp=copy.players[uid];
          const revsCount=(pp?.revealed||[]).length;
          const secretUsed=!!(copy.usedSecrets||{})[uid];
          let coinsEarned=0;
          const upd={...qd,quests:qd.quests.map(q=>{
            if(q.done)return q;
            let np=q.progress||0;
            if(q.type==='play') np=Math.min(np+1,q.goal);
            else if(q.type==='win'&&isSurv) np=Math.min(np+1,q.goal);
            else if(q.type==='reveal') np=Math.min(np+revsCount,q.goal);
            else if(q.type==='secret'&&secretUsed) np=Math.min(np+1,q.goal);
            const done=np>=q.goal;
            if(done&&!q.done)coinsEarned+=q.reward;
            return{...q,progress:np,done};
          })};
          await DB.saveDailyQuests(uid,upd);
          if(coinsEarned>0)await DB.addCoins(uid,coinsEarned);
        }));
        DB.logEvent(gameId,'end',`Игра завершена! Выжившие: ${surv.map(u=>copy.players[u]?.name||u).join(', ')}`,user.username);
      }
      await DB.setGame(gameId,copy);
    }catch(e){console.error(e);}
    tallying.current=false;
  };

  /* MY CARDS */
  if(sub==='cards'){
    const mySecret=me?.cards?.secret?ALL_SECRET_CARDS.find(s=>s.id===me.cards.secret):null;
    const secretUsed=(game.usedSecrets||{})[user.username];
    return(
      <div className="sc">
        <HZ/><div className="tb"><BackBtn onClick={()=>setSub('round')}/><div className="tb-title">МОИ КАРТЫ</div></div>
        <div className="scr-raw">
          <div style={{fontSize:11,color:'var(--tx3)',textAlign:'center',margin:'4px 0 14px'}}>Только вы видите все карты</div>
          {/* SECRET CARD — highlighted separately */}
          {mySecret&&(React.createElement(React.Fragment,null,
            React.createElement('div',{
              onClick:()=>setSecretModalOpen(true),
              style:{
                background:`linear-gradient(135deg,${mySecret.color}18,${mySecret.color}08)`,
                border:`1px solid ${mySecret.color}55`,
                borderRadius:'var(--rad)',
                padding:'16px',
                marginBottom:14,
                position:'relative',
                overflow:'hidden',
                cursor:'pointer',
              }
            },
              React.createElement('div',{style:{position:'absolute',top:0,right:0,padding:'4px 10px',background:mySecret.color+'22',borderBottomLeftRadius:'var(--rad-sm)',fontSize:9,fontWeight:700,color:mySecret.color,textTransform:'uppercase',letterSpacing:1}},SECRET_TYPE_LABELS[mySecret.type]),
              secretUsed&&React.createElement('div',{style:{position:'absolute',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,.55)',borderRadius:'var(--rad)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:2}},
                React.createElement('span',{style:{fontSize:12,color:'#8e8e93',fontWeight:700,letterSpacing:1}},'ИСПОЛЬЗОВАНА')
              ),
              React.createElement('div',{style:{fontSize:32,marginBottom:6}},mySecret.icon),
              React.createElement('div',{style:{fontSize:16,fontWeight:700,color:'#fff',marginBottom:4}},'🃏 ',mySecret.name),
              React.createElement('div',{style:{fontSize:12,color:'rgba(255,255,255,.7)',lineHeight:1.5}},mySecret.desc),
              !secretUsed&&isCreator===false&&React.createElement('button',{onClick:(e)=>{e.stopPropagation();useSecretCard(mySecretCard);},style:{marginTop:12,background:mySecretCard.color,border:'none',borderRadius:'var(--rad-sm)',color:'#000',fontWeight:700,fontSize:12,padding:'8px 16px',cursor:'pointer',width:'100%'}},'⚡ Активировать карту')
            ),
            secretModalOpen&&React.createElement('div',{className:'secret-modal-bg',onClick:()=>setSecretModalOpen(false)},
              React.createElement('div',{className:'secret-modal-card',onClick:(e)=>e.stopPropagation()},
                React.createElement('button',{className:'secret-modal-close',onClick:()=>setSecretModalOpen(false)},'✕'),
                React.createElement('div',{style:{fontSize:64,marginBottom:16}},mySecret.icon),
                React.createElement('div',{style:{fontSize:22,fontWeight:800,color:'#f0a500',marginBottom:8}},mySecret.name),
                React.createElement('div',{style:{fontSize:13,color:'rgba(255,255,255,.8)',lineHeight:1.6,textAlign:'center',maxWidth:260}},mySecret.desc),
                React.createElement('div',{style:{marginTop:12,fontSize:11,color:mySecret.color,fontWeight:700,letterSpacing:1,textTransform:'uppercase'}},SECRET_TYPE_LABELS[mySecret.type])
              )
            )
          ))}
          <div className="cgrid">
            {me?.cards?(()=>{
              const cfxId = allUsersData[user.username]?.equipped?.cardEffect || user.equipped?.cardEffect || 'fx_classic';
              const cfx = getCardEffectStyle(cfxId);
              return CARDS.filter(c=>c.key!=='secret').map(({key,icon,label})=>{
              const rev=(me.revealed||[]).includes(key);
              const isFlipped=rev;
              return(
                <div key={key} className={`card-flip-wrap${isFlipped?' flipped':''}${key==='fact'?' full':''}`} style={{height:key==='fact'?90:110}}>
                <div className="card-flip-inner">
                <div className="card-face" style={{background:cfx.cardBg,border:`1px solid ${cfx.cardBorder}`,boxShadow:cfx.glow||'none',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:6,position:'relative',overflow:'hidden'}}>
                  {cfx.overlay&&<div style={{position:'absolute',inset:0,background:cfx.overlay,pointerEvents:'none'}}/>}
                  <div style={{fontSize:24,filter:'blur(6px)',opacity:.4,position:'relative'}}>{icon}</div>
                  <div style={{fontSize:10,color:'var(--tx3)',fontWeight:600,letterSpacing:1,textTransform:'uppercase',position:'relative'}}>{label}</div>
                  <div style={{fontSize:9,color:'var(--tx3)',opacity:.6,position:'relative'}}>🔒 закрыто</div>
                </div>
                <div className={`card-face card-back${rev?' rev':''}`} style={{background:rev?cfx.revBg:cfx.cardBg,border:`1px solid ${rev?cfx.revBorder:cfx.cardBorder}`,boxShadow:cfx.glow||'none',display:'flex',flexDirection:'column',gap:4,position:'relative',overflow:'hidden'}}>
                  {cfx.overlay&&<div style={{position:'absolute',inset:0,background:cfx.overlay,pointerEvents:'none'}}/>}
                  {rev&&<div className="rev-bdg">РАСКРЫТА</div>}
                  <div style={{fontSize:22,marginBottom:5,position:'relative'}}>{icon}</div>
                  <div className="mono" style={{fontSize:8,letterSpacing:2,color:'var(--tx3)',textTransform:'uppercase',position:'relative'}}>{label}</div>
                  <div style={{fontSize:12,color:'var(--tx)',marginTop:5,lineHeight:1.4,position:'relative'}}>{me.cards[key]||'—'}</div>
                </div></div></div>
              );
            });})():<div style={{color:'var(--tx3)',padding:24,textAlign:'center'}}>Карты не назначены</div>}
          </div>
        </div>
      </div>
    );
  }

  /* PICK CARD */
  if(sub==='pick'){
    const unrev=CARDS.filter(c=>!(me?.revealed||[]).includes(c.key));
    return(
      <div className="sc">
        {confirmReveal&&<ConfirmDialog
          msg={<><div style={{fontSize:13,color:'var(--tx3)',marginBottom:8}}>Раскрыть карту всем?</div><div style={{fontSize:17,fontWeight:700,color:'var(--a)',marginBottom:4}}>{confirmReveal.label}</div><div style={{fontSize:14,color:'var(--tx)',lineHeight:1.5}}>{confirmReveal.value}</div><div style={{fontSize:11,color:'var(--tx3)',marginTop:8}}>Все игроки увидят эту карту</div></>}
          onYes={()=>{doReveal(confirmReveal.key);setConfirmReveal(null);DB.addCoins(user.username,10);}}
          onNo={()=>setConfirmReveal(null)}
        />}
        <HZ/><div className="tb"><BackBtn onClick={()=>setSub('round')}/><div className="tb-title">РАСКРЫТЬ КАРТУ</div><div className="mono" style={{fontSize:10,color:'var(--tx3)',letterSpacing:2}}>Р{game.round}</div></div>
        <div className="scr-raw">
          <div className="mono" style={{fontSize:10,color:'var(--a)',textAlign:'center',padding:'8px 0 12px'}}>Осталось раскрытий: {revLeft} из {maxRev}</div>
          {revLeft<=0?<div className="mono" style={{textAlign:'center',padding:20,color:'var(--g)',fontSize:10,letterSpacing:2}}>✓ Лимит раскрытий использован</div>
          :unrev.length===0?<div className="mono" style={{textAlign:'center',padding:20,color:'var(--g)',fontSize:10,letterSpacing:2}}>✓ Все карты раскрыты</div>
          :unrev.map(({key,icon,label})=>(
            <div key={key} className="ptile" onClick={()=>{const v=me?.cards?.[key]||'—';setConfirmReveal({key,label,value:v});}}>
              <div style={{fontSize:22}}>{icon}</div>
              <div style={{flex:1}}>
                <div className="mono" style={{fontSize:9,letterSpacing:2,color:'var(--tx3)',textTransform:'uppercase'}}>{label}</div>
                <div style={{fontSize:13,color:'var(--tx)',marginTop:3}}>{me?.cards?.[key]||'—'}</div>
              </div>
              <div style={{fontSize:20,color:'var(--tx3)'}}>›</div>
            </div>
          ))}
          <div style={{marginTop:8}}><Btn ch="🤫 Не раскрывать сейчас" onClick={()=>setSub('round')} cls="btn-g" sm/></div>
        </div>
      </div>
    );
  }

  /* VOTE */
  if(sub==='vote'||(game.phase==='voting'&&sub!=='elim'&&sub!=='over')){
    const votes=game.votes||{};
    const voted=votes[user.username]!==undefined;
    const total=Object.keys(votes).length;
    const myV=votes[user.username];
    const progress=Math.round((total/Math.max(alive.length,1))*100);
    return(
      <div className="sc" style={{background:'#08080c'}}>
        {/* ── ШАПКА ── */}
        <div style={{flexShrink:0,padding:'14px 16px 10px',background:'linear-gradient(180deg,rgba(232,53,74,.13) 0%,transparent 100%)',borderBottom:'1px solid rgba(232,53,74,.18)'}}>
          <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:6}}>
            <div style={{fontSize:28,lineHeight:1}}>🗳️</div>
            <div>
              <div style={{fontFamily:"'Inter',sans-serif",fontSize:22,fontWeight:900,letterSpacing:2,color:'#ff453a',lineHeight:1}}>ГОЛОСОВАНИЕ</div>
              <div style={{fontSize:10,color:'rgba(255,255,255,0.4)',letterSpacing:1,marginTop:2}}>КТО ПОКИНЕТ БУНКЕР?</div>
            </div>
            <div style={{marginLeft:'auto',textAlign:'right'}}>
              <div style={{fontSize:18,fontWeight:800,color:'#fff'}}>{total}<span style={{fontSize:11,color:'rgba(255,255,255,0.4)',fontWeight:400}}>/{alive.length}</span></div>
              <div style={{fontSize:9,color:'rgba(255,255,255,0.4)',letterSpacing:1}}>ГОЛОСОВ</div>
            </div>
          </div>
          {/* Прогресс-бар */}
          <div style={{height:4,borderRadius:4,background:'rgba(255,255,255,0.08)',overflow:'hidden'}}>
            <div style={{height:'100%',width:`${progress}%`,background:'linear-gradient(90deg,#ff453a,#ff6b35)',borderRadius:4,transition:'width .4s'}}/>
          </div>
          {voted&&<div style={{marginTop:8,fontSize:11,color:'rgba(48,209,88,0.9)',fontWeight:700,letterSpacing:1,display:'flex',alignItems:'center',gap:6}}>
            <span>✅</span><span>Голос засчитан{myV===null?' (воздержался)':`— против ${alive.find(p=>p.username===myV)?.name||myV}`}</span>
          </div>}
          {!voted&&<div style={{marginTop:8,fontSize:11,color:'rgba(255,165,0,0.8)',fontWeight:600,letterSpacing:0.5,display:'flex',alignItems:'center',gap:6}}>
            <span>👆</span><span>Выберите игрока ниже и нажмите кнопку</span>
          </div>}
        </div>

        {/* ── СПИСОК ИГРОКОВ ── */}
        <div style={{flex:1,overflowY:'auto',WebkitOverflowScrolling:'touch',padding:'10px 12px',paddingBottom:'calc(100px + env(safe-area-inset-bottom,0px))'}}>
          <div style={{display:'flex',flexDirection:'column',gap:8}}>
            {alive.map(p=>{
              const isMe=p.username===user.username;
              const vc=Object.values(votes).filter(v=>v===p.username).length;
              const iSel=!isMe&&selVote===p.username;
              const iVot=!isMe&&myV===p.username;
              const isChosen=iSel||iVot;
              const revealed=p.revealed||[];
              return(
                <div key={p.username}
                  onClick={()=>!voted&&!isMe&&setSelVote(p.username===selVote?undefined:p.username)}
                  style={{
                    borderRadius:16,
                    border:isChosen?'2px solid #ff453a':isMe?'2px solid rgba(240,165,0,0.4)':'2px solid rgba(255,255,255,0.07)',
                    background:isChosen?'rgba(232,53,74,.12)':isMe?'rgba(240,165,0,.06)':'rgba(255,255,255,0.04)',
                    padding:'12px 14px',
                    cursor:(!voted&&!isMe)?'pointer':'default',
                    transition:'all .2s',
                    position:'relative',
                    WebkitTapHighlightColor:'transparent',
                  }}>
                  {/* Метка */}
                  {isMe&&<div style={{position:'absolute',top:8,right:10,fontSize:9,fontWeight:800,letterSpacing:1,color:'rgba(240,165,0,0.8)',background:'rgba(240,165,0,0.1)',borderRadius:6,padding:'2px 6px'}}>ВЫ</div>}
                  {iVot&&<div style={{position:'absolute',top:8,right:10,fontSize:9,fontWeight:800,letterSpacing:1,color:'rgba(255,69,58,0.9)',background:'rgba(255,69,58,0.12)',borderRadius:6,padding:'2px 6px'}}>МОЙ ГОЛОС</div>}
                  {iSel&&!voted&&<div style={{position:'absolute',top:8,right:10,fontSize:9,fontWeight:800,letterSpacing:1,color:'rgba(255,69,58,0.9)',background:'rgba(255,69,58,0.12)',borderRadius:6,padding:'2px 6px'}}>ВЫБРАН</div>}
                  {/* Аватар + имя + счётчик голосов */}
                  <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:revealed.length>0?10:0}}>
                    <Avatar name={p.name||p.username} size="sm" avatar={allUsersData?.[p.username]?.avatar} frame={allUsersData?.[p.username]?.equipped?.frame}/>
                    <div style={{flex:1,minWidth:0}}>
                      <div style={{fontWeight:700,fontSize:14,color:'#fff',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{p.name||p.username}</div>
                      <div style={{fontSize:10,color:'rgba(255,255,255,0.35)',marginTop:1}}>@{p.username}</div>
                    </div>
                    {vc>0&&<div style={{flexShrink:0,background:'rgba(255,69,58,0.15)',border:'1px solid rgba(255,69,58,0.3)',borderRadius:20,padding:'3px 10px',display:'flex',alignItems:'center',gap:4}}>
                      <span style={{fontSize:13}}>☠</span>
                      <span style={{fontSize:13,fontWeight:800,color:'#ff453a'}}>{vc}</span>
                    </div>}
                  </div>
                  {/* Раскрытые карты */}
                  {revealed.length>0&&(
                    <div style={{display:'flex',flexWrap:'wrap',gap:5}}>
                      {revealed.map(k=>{
                        const m=CARDS.find(c=>c.key===k)||{};
                        const val=p.cards?.[k]||'—';
                        return(
                          <div key={k} style={{display:'flex',alignItems:'center',gap:5,background:'rgba(255,255,255,0.05)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:8,padding:'4px 8px',minWidth:0,flex:'1 1 calc(50% - 5px)'}}>
                            <span style={{fontSize:13,flexShrink:0}}>{m.icon||'•'}</span>
                            <div style={{minWidth:0}}>
                              <div style={{fontSize:7,color:'rgba(255,255,255,0.35)',fontWeight:800,letterSpacing:1,textTransform:'uppercase'}}>{m.label||k}</div>
                              <div style={{fontSize:11,color:'#fff',fontWeight:500,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{val}</div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                  {revealed.length===0&&!isMe&&<div style={{fontSize:10,color:'rgba(255,255,255,0.25)',fontStyle:'italic',marginTop:4}}>Карты ещё не раскрыты</div>}
                </div>
              );
            })}
            {/* Воздержаться */}
            {!voted&&(
              <div onClick={()=>setSelVote(selVote===null?undefined:null)}
                style={{borderRadius:16,border:selVote===null?'2px solid rgba(255,255,255,0.35)':'2px solid rgba(255,255,255,0.07)',background:selVote===null?'rgba(255,255,255,0.08)':'rgba(255,255,255,0.03)',padding:'12px 14px',cursor:'pointer',textAlign:'center',WebkitTapHighlightColor:'transparent',transition:'all .2s'}}>
                <div style={{fontSize:14,fontWeight:700,color:'rgba(255,255,255,0.7)'}}>🤐 Воздержаться</div>
                <div style={{fontSize:10,color:'rgba(255,255,255,0.35)',marginTop:3}}>Голос не засчитывается в итоге</div>
              </div>
            )}
          </div>
        </div>

        {/* ── КНОПКА ПОДТВЕРЖДЕНИЯ (фикс снизу) ── */}
        <div style={{position:'fixed',bottom:0,left:0,right:0,zIndex:200,padding:`12px 16px calc(12px + env(safe-area-inset-bottom,0px))`,background:'linear-gradient(0deg,rgba(8,8,12,1) 60%,transparent)',display:'flex',flexDirection:'column',gap:8}}>
          {!voted?(
            <button
              disabled={selVote===undefined}
              onClick={()=>{if(selVote===undefined)return;castVote(selVote);}}
              style={{width:'100%',padding:'16px',borderRadius:16,border:'none',fontFamily:"'Inter',sans-serif",fontSize:15,fontWeight:900,letterSpacing:1,cursor:selVote===undefined?'not-allowed':'pointer',transition:'all .2s',
                background:selVote===undefined?'rgba(255,255,255,0.06)':selVote===null?'rgba(255,255,255,0.12)':'linear-gradient(135deg,#ff453a,#d63031)',
                color:selVote===undefined?'rgba(255,255,255,0.3)':'#fff',
                boxShadow:selVote!==undefined&&selVote!==null?'0 8px 24px rgba(255,69,58,0.35)':'none',
              }}>
              {selVote===undefined?'👆 Выберите игрока':selVote===null?'🤐 ВОЗДЕРЖАТЬСЯ':'☠ ГОЛОСОВАТЬ ПРОТИВ '+((alive.find(p=>p.username===selVote)?.name)||selVote||'')}
            </button>
          ):(
            <div style={{padding:'14px',borderRadius:16,background:'rgba(48,209,88,0.1)',border:'1.5px solid rgba(48,209,88,0.3)',textAlign:'center',fontSize:14,fontWeight:700,color:'rgba(48,209,88,0.9)',letterSpacing:1}}>
              ✅ Голос засчитан · Ждём остальных ({total}/{alive.length})
            </div>
          )}
          {isCreator&&(
            <button onClick={tally}
              style={{width:'100%',padding:'12px',borderRadius:14,border:'1.5px solid rgba(48,209,88,0.4)',background:'rgba(48,209,88,0.1)',color:'rgba(48,209,88,0.9)',fontSize:13,fontWeight:700,cursor:'pointer',letterSpacing:1,fontFamily:"'Inter',sans-serif"}}>
              📊 ПОДВЕСТИ ИТОГИ (только для создателя)
            </button>
          )}
        </div>
      </div>
    );
  }

  /* ELIM */
  if(sub==='elim'){
    const ep=game.lastEliminated;
    // nextSub определён выше (до early return)
    const elimRound=game.round>1?game.round-1:1;
    const secretCard=ep?.allCards?.secret?ALL_SECRET_CARDS.find(s=>s.id===ep.allCards.secret):null;
    return(
      <div className="elim-screen">
        {/* Фоновые эффекты */}
        <div className="elim-flash"/>
        <div className="elim-scanlines"/>
        <div className="elim-vignette"/>
        <div className="elim-scanner"/>

        {/* Герой — череп + имя */}
        <div className="elim-hero">
          <div className="elim-skull elim-skull-shake">💀</div>
          <div className="elim-tag">☠ исключён из бункера ☠</div>
          <div className="elim-name">{ep?.name||'—'}</div>
          <div className="elim-sub">Раунд {elimRound} · Голосов: {Object.values(game.votes||{}).filter(v=>v===ep?.userId).length}</div>
          <div className="elim-divider"/>
        </div>

        {/* Карты выбывшего */}
        <div className="elim-cards">
          <div style={{fontSize:9,letterSpacing:3,color:'rgba(255,69,58,.6)',textTransform:'uppercase',fontWeight:700,marginBottom:10}}>— Все карты —</div>
          {ep&&CARDS.filter(c=>c.key!=='secret').map(({key,icon,label},i)=>(
            <div key={key} className="elim-card-row" style={{animationDelay:`${0.9+i*0.08}s`}}>
              <div style={{fontSize:20,flexShrink:0,filter:'drop-shadow(0 0 8px rgba(255,69,58,.5))'}}>{icon}</div>
              <div style={{flex:1}}>
                <div style={{fontSize:8,letterSpacing:2,color:'rgba(255,69,58,.5)',textTransform:'uppercase',marginBottom:3}}>{label}</div>
                <div style={{fontSize:13,color:'#fff',fontWeight:500}}>{ep.allCards?.[key]||'—'}</div>
              </div>
            </div>
          ))}
          {secretCard&&(
            <div style={{background:`linear-gradient(135deg,${secretCard.color}22,${secretCard.color}08)`,border:`1px solid ${secretCard.color}55`,borderRadius:'var(--rad-sm)',padding:14,marginTop:4,animation:'elimCard .3s ease 1.5s both'}}>
              <div style={{fontSize:10,fontWeight:700,color:secretCard.color,marginBottom:6,letterSpacing:1}}>🃏 СЕКРЕТНАЯ КАРТА</div>
              <div style={{fontSize:18,marginBottom:4}}>{secretCard.icon} <span style={{fontSize:14,fontWeight:700,color:'#fff'}}>{secretCard.name}</span></div>
              <div style={{fontSize:12,color:'rgba(255,255,255,.6)',lineHeight:1.5}}>{secretCard.desc}</div>
            </div>
          )}
        </div>

        {/* Кнопка продолжить */}
        <div className="elim-continue">
          <button onClick={()=>setSub(nextSub)} style={{
            width:'100%',padding:'15px',border:'none',borderRadius:'var(--rad)',cursor:'pointer',
            background:'linear-gradient(135deg,rgba(255,69,58,.2),rgba(255,69,58,.08))',
            border:'1px solid rgba(255,69,58,.3)',color:'#fff',fontSize:15,fontWeight:700,
            letterSpacing:2,textTransform:'uppercase',transition:'.2s',
          }}>ПРОДОЛЖИТЬ →</button>
        </div>
      </div>
    );
  }

  /* OVER */
  if(sub==='over'){
    const surv=Object.values(game.players||{}).filter(p=>!p.isEliminated);
    const dead=Object.values(game.players||{}).filter(p=>p.isEliminated);
    const iWon=surv.some(p=>p.username===user.username);
    return(
      <div className="win-screen">
        <div className="win-rays"/>
        <div className="win-scanlines"/>
        <div className="win-vignette"/>
        <div className="win-flash"/>
        <WinParticles iWon={iWon}/>
        <div className="win-hero">
          <div className="win-trophy">{iWon?'🏆':'🏚'}</div>
          <div style={{marginTop:16,fontSize:10,letterSpacing:6,textTransform:'uppercase',color:'rgba(48,209,88,.6)',fontWeight:700,animation:'winFadeIn .5s ease .3s both'}}>
            {ap.emoji} {ap.name}
          </div>
          <div style={{fontSize:38,fontWeight:800,letterSpacing:2,color:'#30d158',textShadow:'0 0 40px rgba(48,209,88,.6)',marginTop:8,animation:'winFadeIn .5s ease .45s both'}}>
            {iWon?'ВЫЖИЛ!':'ИГРА ОКОНЧЕНА'}
          </div>
          <div style={{fontSize:13,color:'rgba(255,255,255,.4)',marginTop:6,animation:'winFadeIn .5s ease .6s both'}}>
            {surv.length} из {Object.keys(game.players||{}).length} попали в бункер
          </div>
          <div style={{display:'flex',gap:6,marginTop:18,flexWrap:'wrap',justifyContent:'center',animation:'winFadeIn .5s ease .75s both'}}>
            {surv.map((p,i)=>(
              <div key={p.username} style={{display:'flex',alignItems:'center',gap:6,padding:'6px 12px',background:'rgba(48,209,88,.12)',border:'1px solid rgba(48,209,88,.3)',borderRadius:20,animationDelay:`${0.75+i*0.1}s`}}>
                <span style={{fontSize:16}}>🏆</span>
                <span style={{fontSize:13,fontWeight:600,color:'#30d158'}}>{p.name}</span>
              </div>
            ))}
          </div>
        </div>
        <div className="win-cards">
          <div style={{fontSize:10,letterSpacing:3,color:'rgba(255,255,255,.3)',textTransform:'uppercase',fontWeight:700,textAlign:'center',marginBottom:12}}>В БУНКЕРЕ</div>
          {surv.map((p,i)=>(
            <div key={p.username} className="win-player-card" style={{animationDelay:`${0.9+i*0.12}s`}}>
              <div style={{fontSize:28,filter:'drop-shadow(0 0 10px rgba(48,209,88,.6))'}}>🏆</div>
              <div style={{flex:1}}>
                <div style={{fontSize:15,fontWeight:700,color:'#30d158'}}>{p.name}</div>
                <div style={{fontSize:11,color:'rgba(255,255,255,.4)',marginTop:2}}>{p.cards?.profession||'—'}</div>
              </div>
              {p.username===user.username&&<div style={{fontSize:9,letterSpacing:2,color:'#30d158',fontWeight:700,background:'rgba(48,209,88,.15)',padding:'3px 8px',borderRadius:8}}>ВЫ</div>}
            </div>
          ))}
          {dead.length>0&&(
            <>
              <div style={{fontSize:10,letterSpacing:3,color:'rgba(255,255,255,.3)',textTransform:'uppercase',fontWeight:700,textAlign:'center',margin:'14px 0 10px'}}>ВЫБЫЛИ</div>
              {dead.map((p,i)=>(
                <div key={p.username} className="dead-player-card" style={{animationDelay:`${1.1+i*0.08}s`}}>
                  <div style={{fontSize:22,filter:'grayscale(1)',opacity:.5}}>💀</div>
                  <div style={{flex:1}}>
                    <div style={{fontSize:13,color:'rgba(255,255,255,.3)',textDecoration:'line-through'}}>{p.name}</div>
                    <div style={{fontSize:10,color:'rgba(255,255,255,.2)',marginTop:1}}>{p.cards?.profession||'—'}</div>
                  </div>
                </div>
              ))}
            </>
          )}
        </div>
        <div style={{position:'fixed',bottom:0,left:0,right:0,padding:'12px 16px 28px',background:'linear-gradient(0deg,#00060a 60%,transparent)',zIndex:20}}>
          <Btn cls="btn-gr" ch="↩ ВЕРНУТЬСЯ В МЕНЮ" onClick={onExit}/>
        </div>
      </div>
    );
  }

  /* DEBATES */
  if(sub==='debates'||(game.phase==='debates'&&sub!=='elim'&&sub!=='over')){
    const debateTime=debateTimeLeft;
    const alive=Object.values(game.players||{}).filter(p=>!p.isEliminated);
    const timePerPlayer=Math.max(1,Math.floor(60/alive.length));
    const elapsed=60-debateTime;
    const currentSpeakerIdx=Math.min(alive.length-1,Math.floor(elapsed/timePerPlayer));
    const currentSpeaker=alive[currentSpeakerIdx];
    const timeInThisSlot=elapsed%timePerPlayer;
    const slotRemaining=timePerPlayer-timeInThisSlot;
    const isMyTurn=currentSpeaker&&currentSpeaker.username===user.username;
    return(
      <div className="sc">
        <div className="tb"><div className="tb-title">🎤 ДЕБАТЫ</div>
          <div style={{fontFamily:"'Inter',sans-serif",fontSize:11,color:'var(--tx3)'}}>Раунд {game.round}</div>
        </div>
        <div className="scr">
          {/* Большой таймер */}
          <div style={{textAlign:'center',padding:'28px 0 20px'}}>
            <div style={{fontSize:72,fontWeight:800,color:debateTime<=10?'var(--r)':debateTime<=30?'#ff9f0a':'var(--g)',lineHeight:1,fontVariantNumeric:'tabular-nums',transition:'color .3s'}}>{String(debateTime).padStart(2,'0')}</div>
            <div style={{fontSize:12,color:'var(--tx3)',marginTop:6,fontWeight:500}}>секунд на защиту</div>
            {/* Timer bar shrinks from full to 0 over 60 seconds */}
            <div style={{width:'220px',height:4,background:'rgba(255,255,255,0.1)',borderRadius:2,margin:'12px auto 0',overflow:'hidden'}}>
              <div style={{width:Math.max(0,(debateTime/60)*100)+'%',height:'100%',background:debateTime<=10?'var(--r)':debateTime<=30?'#ff9f0a':'var(--g)',borderRadius:2,transition:'width .5s linear,background .3s'}}/>
            </div>
          </div>
          {/* Current speaker banner */}
          {isMyTurn&&(
            <div style={{background:'rgba(48,209,88,0.12)',border:'1px solid rgba(48,209,88,0.4)',borderRadius:'var(--rad-sm)',padding:'12px 16px',marginBottom:14,textAlign:'center',boxShadow:'0 0 18px rgba(48,209,88,0.2)'}}>
              <div style={{fontSize:20,marginBottom:4}}>🎙️</div>
              <div style={{fontSize:14,fontWeight:700,color:'var(--g)'}}>Ваша очередь говорить!</div>
              <div style={{fontSize:12,color:'var(--tx3)',marginTop:4}}>Осталось {slotRemaining} сек</div>
            </div>
          )}
          <div className="lbl">🗣 ПОРЯДОК ВЫСТУПЛЕНИЙ</div>
          {alive.map((p,i)=>{
            const isCurrent=i===currentSpeakerIdx;
            const isMe=p.username===user.username;
            return(
              <div key={p.username} style={{display:'flex',alignItems:'center',gap:12,padding:'12px 16px',background:isCurrent?'rgba(48,209,88,0.08)':isMe?'rgba(240,165,0,0.07)':'rgba(255,255,255,0.04)',border:`1px solid ${isCurrent?'rgba(48,209,88,0.5)':isMe?'rgba(240,165,0,0.25)':'rgba(255,255,255,0.08)'}`,borderRadius:'var(--rad-sm)',marginBottom:6,boxShadow:isCurrent?'0 0 12px rgba(48,209,88,0.25)':'none',transition:'border .3s,box-shadow .3s,background .3s'}}>
                <div style={{width:28,height:28,borderRadius:'50%',background:isCurrent?'rgba(48,209,88,0.2)':'rgba(255,255,255,0.08)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:isCurrent?18:12,fontWeight:700,color:isCurrent?'var(--g)':'var(--tx3)',flexShrink:0,transition:'background .3s,color .3s'}}>{isCurrent?'🎙️':i+1}</div>
                <div style={{flex:1}}>
                  <div style={{fontSize:14,fontWeight:600,color:isCurrent?'var(--g)':isMe?'var(--a)':'var(--tx)'}}>{p.name}{isMe&&' (вы)'}</div>
                  <div style={{fontSize:11,color:'var(--tx3)'}}>@{p.username}{isCurrent&&<span style={{marginLeft:6,color:'var(--g)',fontWeight:600}}> · {slotRemaining} сек</span>}</div>
                </div>
                {isCurrent&&<div style={{fontSize:11,fontWeight:700,color:'var(--g)',background:'rgba(48,209,88,0.15)',border:'1px solid rgba(48,209,88,0.3)',borderRadius:6,padding:'3px 8px'}}>говорит</div>}
              </div>
            );
          })}
          <div style={{background:'rgba(240,165,0,0.06)',border:'1px solid rgba(240,165,0,0.15)',borderRadius:'var(--rad-sm)',padding:'14px 16px',marginTop:14}}>
            <div style={{fontSize:13,fontWeight:600,color:'var(--a)',marginBottom:6}}>💡 Правила дебатов</div>
            <div style={{fontSize:12,color:'var(--tx3)',lineHeight:1.6}}>Каждый игрок получает {timePerPlayer} сек чтобы объяснить почему он нужен в бункере. Убеди других в своей ценности до начала голосования!</div>
          </div>
        </div>
      </div>
    );
  }

  /* RADIO */
  if(sub==='radio'&&game.radio){
    const alive=Object.values(game.players||{}).filter(p=>!p.isEliminated&&p.username!==user.username);
    const sendRadio=async()=>{
      if(!radioInput.trim()||!radioTarget)return;
      const radioKey=[user.username,radioTarget].sort().join('_');
      await db.ref(`radioChats/${gameId}/${radioKey}`).push({from:user.username,name:user.displayName||user.username,text:radioInput.trim(),ts:Date.now()});
      setRadioInput('');
    };
    return(
      <div style={{position:'fixed',inset:0,background:'var(--bg)',display:'flex',flexDirection:'column',zIndex:200,animation:'fadeUp .2s ease'}}>
        <div className="tb"><BackBtn onClick={()=>setSub('round')}/><div className="tb-title">📡 РАДИО</div></div>
        {!radioTarget?(
          <div style={{flex:1,overflowY:'auto',padding:16}}>
            <div className="lbl">ВЫБЕРИ СОБЕСЕДНИКА</div>
            {alive.length===0
              ?<div style={{textAlign:'center',padding:28,color:'var(--tx3)',fontSize:13}}>Нет других живых игроков</div>
              :alive.map(p=>(
                <div key={p.username} onClick={()=>setRadioTarget(p.username)}
                  style={{display:'flex',alignItems:'center',gap:12,padding:'14px 16px',background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad-sm)',marginBottom:8,cursor:'pointer',transition:'.18s'}}
                  onMouseEnter={e=>e.currentTarget.style.borderColor='rgba(10,132,255,0.4)'}
                  onMouseLeave={e=>e.currentTarget.style.borderColor='rgba(255,255,255,0.08)'}>
                  <div style={{fontSize:28}}>📡</div>
                  <div><div style={{fontSize:14,fontWeight:600}}>{p.name}</div><div style={{fontSize:11,color:'var(--tx3)'}}>@{p.username}</div></div>
                </div>
              ))
            }
          </div>
        ):(
          <>
            <div style={{padding:'10px 16px',background:'rgba(10,132,255,0.08)',borderBottom:'1px solid rgba(10,132,255,0.2)',display:'flex',alignItems:'center',gap:10,flexShrink:0}}>
              <button onClick={()=>setRadioTarget(null)} style={{background:'none',border:'none',color:'var(--tx3)',cursor:'pointer',fontSize:20,lineHeight:1}}>←</button>
              <div style={{fontSize:14,fontWeight:600,color:'#0a84ff'}}>📡 {(game.players||{})[radioTarget]?.name||radioTarget}</div>
              <div style={{fontSize:10,color:'var(--tx3)',marginLeft:'auto'}}>🔒 приватный канал</div>
            </div>
            <div style={{flex:1,overflowY:'auto',padding:14,display:'flex',flexDirection:'column',gap:8}}>
              {radioMsgs.length===0&&<div style={{textAlign:'center',color:'var(--tx3)',fontSize:12,marginTop:32,lineHeight:1.8}}>📡 Канал открыт<br/>Говорите тайно</div>}
              {radioMsgs.map((m,i)=>(
                <div key={i} className={`bubble ${m.from===user.username?'me':'other'}`}>
                  {m.from!==user.username&&<div className="bubble-from">{m.name}</div>}
                  {m.text}
                </div>
              ))}
            </div>
            <div style={{display:'flex',gap:8,padding:'10px 14px',background:'rgba(255,255,255,0.04)',borderTop:'1px solid rgba(255,255,255,0.08)',flexShrink:0}}>
              <input className="inp" style={{marginBottom:0,flex:1}} value={radioInput} onChange={e=>setRadioInput(e.target.value)}
                onKeyDown={e=>e.key==='Enter'&&sendRadio()} placeholder="Тайное сообщение..."/>
              <button className="chat-send" style={{borderRadius:'var(--rad-sm)'}} onClick={sendRadio}>→</button>
            </div>
          </>
        )}
      </div>
    );
  }

  /* NOTES */
  if(sub==='notes'){
    const notesKey=`notes_${gameId}_${user.username}`;
    return(
      <div className="sc">
        <HZ/><div className="tb"><BackBtn onClick={()=>setSub('round')}/><div className="tb-title">📝 ЗАМЕТКИ</div></div>
        <div className="scr-raw" style={{padding:16}}>
          <div style={{fontSize:12,color:'var(--tx3)',marginBottom:10}}>Ваши личные заметки — видны только вам</div>
          <textarea className="notes-area" value={notes} onChange={e=>{setNotes(e.target.value);localStorage.setItem(notesKey,e.target.value);}} placeholder="Пишите здесь ваши наблюдения, подозрения, стратегию..."/>
          <div style={{fontSize:11,color:'var(--tx3)',marginTop:6,textAlign:'right'}}>Сохраняется автоматически</div>
        </div>
      </div>
    );
  }

  /* EVENT LOG */
  if(sub==='journal'){
    const logTypeColor={reveal:'var(--g)',vote:'var(--r)',elim:'var(--r)',join:'var(--c)',start:'var(--a)',end:'var(--a)',default:'var(--tx3)'};
    const logTypeIcon={reveal:'🃏',vote:'🗳',elim:'☠️',join:'👤',start:'🚀',end:'🏁'};
    return(
      <div className="sc">
        <HZ/><div className="tb"><BackBtn onClick={()=>setSub('round')}/><div className="tb-title">📋 ЖУРНАЛ</div></div>
        <div className="scr-raw">
          {eventLog.length===0?(
            <div className="mono" style={{textAlign:'center',color:'var(--tx3)',fontSize:10,letterSpacing:2,padding:36}}>ЖУРНАЛ ПУСТ</div>
          ):[...eventLog].reverse().map((entry,i)=>{
            const d=new Date(entry.ts);
            const timeStr=`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            const color=logTypeColor[entry.type]||logTypeColor.default;
            const icon=logTypeIcon[entry.type]||'•';
            return(
              <div key={i} className="log-entry">
                <span className="log-ts">{timeStr}</span>
                <span style={{flexShrink:0,marginTop:1}}>{icon}</span>
                <span style={{flex:1,color:entry.type==='elim'?'var(--r)':entry.type==='reveal'?'var(--g)':entry.type==='vote'?'var(--tx2)':'var(--tx)'}}>{entry.text}</span>
              </div>
            );
          })}
        </div>
      </div>
    );
  }

  /* BUNKER MAP */
  if(sub==='map'&&game.bunkerMap){
    const roomAssign=game.roomAssign||{};
    const myRoomId=roomAssign[user.username];
    const myRoom=myRoomId?BUNKER_ROOMS.find(r=>r.id===myRoomId):null;
    const alive=Object.values(game.players||{}).filter(p=>!p.isEliminated);
    return(
      <div className="sc">
        <div className="tb"><BackBtn onClick={()=>setSub('round')}/><div className="tb-title">🗺️ БУНКЕР</div></div>
        <div className="scr">
          {myRoom&&(
            <div style={{background:myRoom.bg,border:`1px solid ${myRoom.color}44`,borderRadius:'var(--rad)',padding:'16px',marginBottom:16,textAlign:'center'}}>
              <div style={{fontSize:36,marginBottom:6}}>{myRoom.icon}</div>
              <div style={{fontSize:16,fontWeight:700,color:myRoom.color,marginBottom:4}}>Ваша комната: {myRoom.name}</div>
              <div style={{fontSize:12,color:'var(--tx3)',lineHeight:1.5}}>{myRoom.bonus}</div>
            </div>
          )}
          <div className="lbl">🏗️ СХЕМА БУНКЕРА</div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:16}}>
            {BUNKER_ROOMS.map(room=>{
              const roomPlayers=alive.filter(p=>roomAssign[p.username]===room.id);
              const isMyRoom=myRoomId===room.id;
              return(
                <div key={room.id} style={{background:isMyRoom?room.bg:'rgba(255,255,255,0.03)',border:`1px solid ${isMyRoom?room.color+'66':'rgba(255,255,255,0.08)'}`,borderRadius:'var(--rad-sm)',padding:'12px',transition:'.2s'}}>
                  <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                    <span style={{fontSize:20}}>{room.icon}</span>
                    <span style={{fontSize:12,fontWeight:600,color:isMyRoom?room.color:'var(--tx)'}}>{room.name}</span>
                  </div>
                  {roomPlayers.length===0?<div style={{fontSize:10,color:'var(--tx3)'}}>Пусто</div>:
                  roomPlayers.map(p=>(
                    <div key={p.username} style={{fontSize:11,color:p.username===user.username?'var(--a)':'var(--tx2)',marginBottom:2}}>
                      {p.username===user.username?'👤 Вы':p.name}
                    </div>
                  ))}
                </div>
              );
            })}
          </div>
        </div>
      </div>
    );
  }

  /* VOTE HISTORY */
  if(sub==='voteHistory'&&game.voteHistory){
    const log=game.voteLog||{};
    const rounds=Object.keys(log).sort();
    return(
      <div className="sc">
        <div className="tb"><BackBtn onClick={()=>setSub('round')}/><div className="tb-title">📊 ИСТОРИЯ ГОЛОСОВАНИЙ</div></div>
        <div className="scr">
          {rounds.length===0?<div style={{textAlign:'center',padding:28,color:'var(--tx3)',fontSize:13}}>История пуста</div>:
          rounds.map(r=>{
            const entry=log[r];
            const tally=entry.tally||{};
            const votes=entry.votes||{};
            return(
              <div key={r} style={{marginBottom:16}}>
                <div className="lbl">{r}</div>
                {Object.entries(votes).filter(([,v])=>v).map(([voter,target])=>{
                  const vname=game.players[voter]?.name||voter;
                  const tname=game.players[target]?.name||target;
                  return(
                    <div key={voter} style={{display:'flex',alignItems:'center',gap:8,padding:'8px 12px',background:'rgba(255,255,255,0.03)',border:'1px solid rgba(255,255,255,0.07)',borderRadius:'var(--rad-sm)',marginBottom:4,fontSize:13}}>
                      <span style={{color:'var(--tx)',fontWeight:500}}>{vname}</span>
                      <span style={{color:'var(--tx3)',fontSize:16}}>→</span>
                      <span style={{color:'var(--r)',fontWeight:500}}>{tname}</span>
                      {voter===user.username&&<span style={{marginLeft:'auto',fontSize:10,color:'var(--a)'}}>вы</span>}
                    </div>
                  );
                })}
                <div style={{display:'flex',gap:6,flexWrap:'wrap',marginTop:6}}>
                  {Object.entries(tally).sort(([,a],[,b])=>b-a).map(([uid,cnt])=>{
                    const name=game.players[uid]?.name||uid;
                    return cnt>0&&<span key={uid} style={{fontSize:11,padding:'3px 10px',background:'rgba(255,69,58,0.1)',border:'1px solid rgba(255,69,58,0.2)',borderRadius:'var(--rad-sm)',color:'var(--r)'}}>☠ {name}: {cnt}</span>;
                  })}
                </div>
              </div>
            );
          })}
        </div>
      </div>
    );
  }

  /* MY ROLE */
  if(sub==='role'&&game.roles){
    const myRoleId=me?.role||'civilian';
    const myRole=ROLES.find(r=>r.id===myRoleId)||ROLES[4];
    return(
      <div className="sc">
        <div className="tb"><BackBtn onClick={()=>setSub('round')}/><div className="tb-title">🎭 МОЯ РОЛЬ</div></div>
        <div className="scr">
          <div style={{textAlign:'center',padding:'32px 0 24px'}}>
            <div style={{fontSize:64,marginBottom:12}}>{myRole.icon}</div>
            <div style={{fontSize:28,fontWeight:800,color:myRole.color,marginBottom:8}}>{myRole.name}</div>
            <div style={{fontSize:14,color:'var(--tx2)',lineHeight:1.6,maxWidth:280,margin:'0 auto'}}>{myRole.desc}</div>
          </div>
          {myRoleId==='medic'&&(
            <div style={{background:'rgba(48,209,88,0.06)',border:'1px solid rgba(48,209,88,0.2)',borderRadius:'var(--rad-sm)',padding:'14px 16px',marginTop:8}}>
              <div style={{fontSize:13,fontWeight:600,color:'var(--g)',marginBottom:6}}>💉 Способность: Спасение</div>
              <div style={{fontSize:12,color:'var(--tx3)',lineHeight:1.5}}>Во время голосования нажми кнопку «💉 Спасти» рядом с игроком которого хочешь защитить. Используется 1 раз за игру.</div>
              {game.medicUsed?.[user.username]&&<div style={{marginTop:8,fontSize:12,color:'var(--r)'}}>⚠️ Способность уже использована</div>}
            </div>
          )}
          {myRoleId==='spy'&&(
            <div style={{background:'rgba(10,132,255,0.06)',border:'1px solid rgba(10,132,255,0.2)',borderRadius:'var(--rad-sm)',padding:'14px 16px',marginTop:8}}>
              <div style={{fontSize:13,fontWeight:600,color:'#0a84ff',marginBottom:6}}>🕵️ Способность: Слежка</div>
              <div style={{fontSize:12,color:'var(--tx3)',lineHeight:1.5}}>Ты видишь первую скрытую карту каждого игрока в разделе «Игроки».</div>
            </div>
          )}
          <div className="lbl">ВСЕ РОЛИ</div>
          {ROLES.map(role=>(
            <div key={role.id} style={{display:'flex',alignItems:'center',gap:12,padding:'12px 16px',background:role.id===myRoleId?`${role.color}11`:'rgba(255,255,255,0.03)',border:`1px solid ${role.id===myRoleId?role.color+'44':'rgba(255,255,255,0.07)'}`,borderRadius:'var(--rad-sm)',marginBottom:6,opacity:role.id===myRoleId?1:0.5}}>
              <span style={{fontSize:24}}>{role.icon}</span>
              <div><div style={{fontSize:13,fontWeight:600,color:role.id===myRoleId?role.color:'var(--tx)'}}>{role.name}</div><div style={{fontSize:11,color:'var(--tx3)'}}>{role.desc}</div></div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  /* PLAYERS LIST */
  if(sub==='players'){
    return(
      <div className="sc">
        <HZ/>
        <div className="tb"><BackBtn onClick={()=>setSub('round')}/><div className="tb-title">ИГРОКИ</div><div className="mono" style={{fontSize:10,color:'var(--tx3)',letterSpacing:2}}>{alive.length}/{game.bunkerSpots} 🏠</div></div>
        <div className="scr-raw">
          {Object.values(game.players||{}).map(p=>{
            const isMe=p.username===user.username;
            const isElim=p.isEliminated;
            const pRevd=p.revealed||[];
            const isOnlineP=!!(online&&online[p.username]);
            return(
              <div key={p.username} className={`player-game-card${isElim?' elim':''}`} onClick={()=>onViewProfile&&onViewProfile(p.username)} style={{cursor:'pointer',marginBottom:8}}>
                <div className="player-game-card-accent" style={{background:isElim?'var(--r)':'var(--g)',marginTop:-14,marginBottom:-14,paddingTop:14,paddingBottom:14}}/>
                <div style={{flex:1}}>
                  <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:pRevd.length>0?8:0}}>
                    <Avatar name={p.name||p.username} size="sm" avatar={allUsersData[p.username]?.avatar} frame={allUsersData[p.username]?.equipped?.frame}/>
                    <span style={{fontSize:14,fontWeight:700,color:'var(--tx)',textDecoration:isElim?'line-through':'none',flex:1}}>{p.name||p.username}</span>
                    {isMe&&<span style={{fontSize:9,fontWeight:700,color:'var(--a)',background:'rgba(240,165,0,0.15)',border:'1px solid rgba(240,165,0,0.3)',borderRadius:6,padding:'2px 6px'}}>ВЫ</span>}
                    {isOnlineP&&!isElim&&<span style={{width:7,height:7,borderRadius:'50%',background:'var(--g)',boxShadow:'0 0 6px var(--g)',display:'inline-block',flexShrink:0}}/>}
                    {isElim&&<span style={{fontSize:9,color:'var(--r)',fontWeight:700}}>ВЫБЫЛ</span>}
                  </div>
                  {pRevd.length>0&&(
                    <div style={{display:'flex',flexWrap:'wrap',gap:4}}>
                      {pRevd.map(k=>{
                        const m=CARDS.find(c=>c.key===k)||{};
                        return(
                          <span key={k} className="card-chip" style={{background:'rgba(48,209,88,0.07)',border:'1px solid rgba(48,209,88,0.2)',color:'var(--tx2)'}}>
                            {m.icon||''} {p.cards?.[k]||k}
                          </span>
                        );
                      })}
                    </div>
                  )}
                  {pRevd.length===0&&!isElim&&<div style={{fontSize:10,color:'var(--tx3)',marginTop:2}}>Карты не раскрыты</div>}
                </div>
              </div>
            );
          })}
          {game.voteHistory&&game.voteLog&&Object.keys(game.voteLog).length>0&&(
            <div style={{marginTop:8}}><Btn ch="📊 История голосований" onClick={()=>setSub('voteHistory')} cls="btn-g" sm/></div>
          )}
          {game.radio&&me&&!me.isEliminated&&<div style={{marginTop:4}}><Btn ch="📡 РАДИО" onClick={()=>setSub('radio')} cls="btn-g" sm/></div>}
        </div>
      </div>
    );
  }

  /* ROUND — новое игровое поле */
  const myCards=me?.cards?CARDS.filter(c=>c.key!=='secret'):[];

  const handleCardTap=(key)=>{
    if(me?.isEliminated)return;
    if(tappedCard===key){setTappedCard(null);return;}
    setTappedCard(key);
  };

  const handleRevealFromCard=(key)=>{
    if(!key||!me)return;
    const value=me.cards?.[key]||'—';
    const label=CARDS.find(c=>c.key===key)?.label||key;
    setTappedCard(null);
    setConfirmReveal({key,label,value});
  };

  const revealedCount=(me?.revealed||[]).length;

  return(
    <div className="game-field">
      {/* Модал апокалипсиса */}
      {showApocModal&&(
        <div className="modal-overlay" onClick={()=>setShowApocModal(false)}>
          <div className="modal-box" onClick={e=>e.stopPropagation()} style={{textAlign:'center',padding:'32px 24px'}}>
            <div style={{fontSize:64,marginBottom:12}}>{ap.emoji}</div>
            <div style={{fontFamily:"'Inter',sans-serif",fontSize:20,fontWeight:800,letterSpacing:1,color:'var(--a)',marginBottom:8}}>{ap.name}</div>
            <div style={{fontSize:14,color:'var(--tx2)',lineHeight:1.65,marginBottom:20}}>{ap.description||ap.desc||'Апокалипсис случился. Выжившие должны попасть в бункер.'}</div>
            <div style={{background:'rgba(240,165,0,0.08)',border:'1px solid rgba(240,165,0,0.2)',borderRadius:12,padding:'12px 16px',marginBottom:20}}>
              <div style={{fontSize:11,color:'var(--tx3)',marginBottom:4,letterSpacing:1}}>МЕСТ В БУНКЕРЕ</div>
              <div style={{fontSize:28,fontWeight:800,color:'var(--a)'}}>{game.bunkerSpots||1}</div>
            </div>
            <button className="btn btn-g" onClick={()=>setShowApocModal(false)}>Закрыть</button>
          </div>
        </div>
      )}
      {confirmReveal&&<ConfirmDialog
        msg={<><div style={{fontSize:13,color:'var(--tx3)',marginBottom:8}}>Раскрыть карту всем?</div><div style={{fontSize:17,fontWeight:700,color:'var(--a)',marginBottom:4}}>{confirmReveal.label}</div><div style={{fontSize:14,color:'var(--tx)',lineHeight:1.5}}>{confirmReveal.value}</div><div style={{fontSize:11,color:'var(--tx3)',marginTop:8}}>Все игроки увидят эту карту</div></>}
        onYes={()=>{doReveal(confirmReveal.key);setConfirmReveal(null);DB.addCoins(user.username,10);}}
        onNo={()=>setConfirmReveal(null)}
      />}

      {/* Модал выбора цели для секретной карты */}
      {secretTargetModal&&(
        <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.85)',zIndex:300,display:'flex',alignItems:'flex-end',justifyContent:'center',padding:'0 0 max(20px,env(safe-area-inset-bottom)) 0'}} onClick={()=>setSecretTargetModal(null)}>
          <div style={{background:'#16161e',borderRadius:'20px 20px 0 0',padding:'20px 16px',width:'100%',maxWidth:480}} onClick={e=>e.stopPropagation()}>
            <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:4}}>
              <span style={{fontSize:28}}>{secretTargetModal.sc.icon}</span>
              <div>
                <div style={{fontSize:15,fontWeight:700,color:'var(--tx)'}}>{secretTargetModal.sc.name}</div>
                <div style={{fontSize:11,color:'var(--tx3)',marginTop:2}}>{secretTargetModal.sc.desc}</div>
              </div>
            </div>
            <div style={{fontSize:11,fontWeight:700,letterSpacing:1,color:'var(--tx3)',margin:'16px 0 8px',textTransform:'uppercase'}}>Выбери цель:</div>
            {alive.filter(p=>p.username!==user.username).map(p=>(
              <div key={p.username}
                style={{display:'flex',alignItems:'center',gap:10,padding:'11px 14px',background:'rgba(255,255,255,0.05)',borderRadius:12,marginBottom:6,cursor:'pointer',border:'1px solid rgba(255,255,255,0.08)',WebkitTapHighlightColor:'transparent',transition:'.15s'}}
                onClick={()=>useSecretCard(secretTargetModal.sc,p.username)}>
                <div style={{fontSize:22,width:36,height:36,background:'rgba(255,255,255,0.07)',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center'}}>
                  {allUsersData[p.username]?.avatar||p.name?.[0]||'?'}
                </div>
                <div style={{flex:1}}>
                  <div style={{fontSize:13,fontWeight:600,color:'var(--tx)'}}>{p.name||p.username}</div>
                  <div style={{fontSize:10,color:'var(--tx3)'}}>раскрыто карт: {(p.revealed||[]).length}</div>
                </div>
                <div style={{fontSize:18,color:'var(--a)'}}>›</div>
              </div>
            ))}
            <button style={{width:'100%',marginTop:8,padding:'12px',background:'rgba(255,255,255,0.05)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:12,color:'var(--tx3)',fontSize:13,cursor:'pointer'}} onClick={()=>setSecretTargetModal(null)}>Отмена</button>
          </div>
        </div>
      )}

      {/* ── ШАПКА ── */}
      <div className="game-field-header">
        <div className="game-field-header-inner">
          <div className="game-apoc-badge"><span>{ap.emoji}</span><span>{ap.name}</span></div>
          <div style={{display:'flex',alignItems:'center',gap:6}}>
            <div className="game-round-badge">РАУНД {game.round}</div>
            <div className="game-round-badge" style={{color:'var(--g)',background:'rgba(48,209,88,0.1)',borderColor:'rgba(48,209,88,0.25)'}}>{alive.length}/{game.bunkerSpots} 🏠</div>
          </div>
          <div className="game-hdr-actions">
            <div className="game-icon-btn" onClick={()=>{setShowChat(true);setUnread(0);}}>
              💬{unread>0&&<div className="unread-dot">{unread>9?'9+':unread}</div>}
            </div>
            <div className="game-icon-btn" onClick={()=>setSub('notes')}>📝</div>
            <div className="game-icon-btn" onClick={()=>setSub('journal')}>📋</div>
          </div>
        </div>
        {/* Таймер раунда */}
        {game.roundTimerSeconds&&game.phase==='playing'&&roundTimerLeft!==null&&(
          <div style={{display:'flex',alignItems:'center',gap:8,padding:'6px 0 8px'}}>
            <span style={{fontSize:14}}>⏱</span>
            <span style={{fontFamily:"'Share Tech Mono',monospace",fontSize:16,color:roundTimerLeft<=10?'var(--r)':roundTimerLeft<=30?'#ff9f0a':'var(--tx)',fontWeight:700}}>{String(Math.floor(roundTimerLeft/60)).padStart(2,'0')}:{String(roundTimerLeft%60).padStart(2,'0')}</span>
            <div style={{flex:1,height:3,background:'rgba(255,255,255,0.08)',borderRadius:2,overflow:'hidden'}}>
              <div style={{height:'100%',width:`${(roundTimerLeft/game.roundTimerSeconds)*100}%`,background:roundTimerLeft<=10?'var(--r)':roundTimerLeft<=30?'#ff9f0a':'var(--g)',borderRadius:2,transition:'width 1s linear'}}/>
            </div>
          </div>
        )}
      </div>

      {/* ── ПОЛОСКА ИГРОКОВ ── */}
      <div style={{display:'flex',alignItems:'center',gap:0,flexShrink:0}}>
        <div className="game-players-strip" style={{flex:1}}>
          {Object.values(game.players||{}).map(p=>{
            const isMe=p.username===user.username;
            const isElim=p.isEliminated;
            const pRevd=p.revealed||[];
            const avatarEmoji=allUsersData[p.username]?.avatar||p.name?.[0]||'?';
            return(
              <div key={p.username} className="game-player-chip" onClick={()=>onViewProfile&&onViewProfile(p.username)}>
                <div className={`game-player-avatar${isMe?' me':''}${isElim?' elim':''}`} style={{fontSize:typeof avatarEmoji==='string'&&avatarEmoji.length>2?14:20}}>
                  {avatarEmoji}
                  {pRevd.length>0&&!isElim&&<div style={{position:'absolute',bottom:-2,right:-2,background:'var(--g)',borderRadius:'50%',width:12,height:12,border:'2px solid #0a0a0f',fontSize:7,display:'flex',alignItems:'center',justifyContent:'center',color:'#000',fontWeight:700}}>{pRevd.length}</div>}
                </div>
                <div className={`game-player-name${isMe?' me':''}`}>{p.name?.split(' ')[0]||p.username}</div>
              </div>
            );
          })}
        </div>
        {/* Апокалипсис — всегда виден справа */}
        <div onClick={()=>setShowApocModal(true)} style={{flexShrink:0,display:'flex',flexDirection:'column',alignItems:'center',padding:'8px 14px',cursor:'pointer',borderLeft:'1px solid rgba(255,255,255,0.07)',gap:3,background:'rgba(240,165,0,0.04)',WebkitTapHighlightColor:'transparent'}}>
          <div style={{fontSize:26}}>{ap.emoji}</div>
          <div style={{fontSize:7,fontWeight:800,letterSpacing:1,color:'var(--a)',textAlign:'center',maxWidth:60,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{ap.name}</div>
          <div style={{fontSize:6,color:'var(--tx3)',letterSpacing:1}}>ЦЕЛЬ ℹ️</div>
        </div>
      </div>

      {/* ── ИГРОВАЯ ОБЛАСТЬ С КАРТАМИ ── */}
      {me?.isEliminated?(
        /* ── РЕЖИМ СПЕКТАТОРА ── */
        <div style={{flex:1,display:'flex',flexDirection:'column',overflow:'hidden'}}>
          <div style={{background:'rgba(255,69,58,0.08)',border:'1px solid rgba(255,69,58,0.2)',borderRadius:'var(--rad)',margin:'8px 16px 4px',padding:'10px 14px',display:'flex',alignItems:'center',gap:10,flexShrink:0}}>
            <div style={{fontSize:22}}>👁</div>
            <div>
              <div style={{fontSize:12,fontWeight:700,color:'var(--r)',letterSpacing:1}}>РЕЖИМ СПЕКТАТОРА</div>
              <div style={{fontSize:10,color:'rgba(255,255,255,0.4)'}}>Вы выбыли — наблюдайте за игрой</div>
            </div>
          </div>
          <div className="scr" style={{padding:'8px 16px 80px'}}>
            {Object.values(game.players||{}).filter(p=>!p.isEliminated).map(p=>{
              const cfxId=allUsersData[p.username]?.equipped?.cardEffect||'fx_classic';
              const cfx=getCardEffectStyle(cfxId);
              const pRevd=p.revealed||[];
              return(
                <div key={p.username} style={{background:cfx.cardBg,border:`1px solid ${cfx.cardBorder}`,boxShadow:cfx.glow||'none',borderRadius:'var(--rad)',padding:14,marginBottom:10,position:'relative',overflow:'hidden'}}>
                  {cfx.overlay&&<div style={{position:'absolute',inset:0,background:cfx.overlay,pointerEvents:'none',zIndex:0}}/>}
                  <div style={{position:'relative',zIndex:1}}>
                    <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:10}}>
                      <Avatar name={p.name||p.username} size="sm" avatar={allUsersData?.[p.username]?.avatar} frame={allUsersData?.[p.username]?.equipped?.frame}/>
                      <div style={{flex:1}}>
                        <div style={{fontSize:14,fontWeight:700,color:'var(--tx)'}}>{p.name||p.username}</div>
                        <div style={{fontSize:10,color:'var(--tx3)'}}>{pRevd.length} из {CARDS.filter(c=>c.key!=='secret').length} карт раскрыто</div>
                      </div>
                      <div style={{fontSize:10,color:'var(--g)',background:'rgba(48,209,88,0.1)',border:'1px solid rgba(48,209,88,0.25)',borderRadius:8,padding:'3px 8px',fontWeight:700}}>✅ В ИГРЕ</div>
                    </div>
                    {pRevd.length===0?(
                      <div style={{fontSize:11,color:'var(--tx3)',fontStyle:'italic',textAlign:'center',padding:'8px 0'}}>Карты ещё не раскрыты</div>
                    ):(
                      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6}}>
                        {pRevd.map(k=>{
                          const m=CARDS.find(c=>c.key===k)||{};
                          return(
                            <div key={k} style={{background:'rgba(255,255,255,0.06)',borderRadius:8,padding:'8px 10px',border:`1px solid ${cfx.revBorder||'rgba(48,209,88,0.2)'}`}}>
                              <div style={{fontSize:9,color:'var(--tx3)',fontWeight:700,letterSpacing:1,textTransform:'uppercase',marginBottom:3}}>{m.icon} {m.label}</div>
                              <div style={{fontSize:12,color:'var(--tx)',fontWeight:500,lineHeight:1.3}}>{p.cards?.[k]||'—'}</div>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
            {Object.values(game.players||{}).filter(p=>p.isEliminated&&p.username!==user.username).length>0&&(
              <>
                <div style={{fontSize:9,color:'var(--tx3)',fontWeight:700,letterSpacing:2,textTransform:'uppercase',marginBottom:8,marginTop:4}}>☠ ВЫБЫЛИ</div>
                {Object.values(game.players||{}).filter(p=>p.isEliminated&&p.username!==user.username).map(p=>(
                  <div key={p.username} style={{opacity:0.5,background:'rgba(255,69,58,0.04)',border:'1px solid rgba(255,69,58,0.12)',borderRadius:'var(--rad)',padding:12,marginBottom:6,display:'flex',alignItems:'center',gap:10}}>
                    <div style={{fontSize:18}}>💀</div>
                    <div style={{flex:1}}>
                      <div style={{fontSize:13,color:'rgba(255,255,255,0.4)',textDecoration:'line-through'}}>{p.name||p.username}</div>
                      <div style={{fontSize:11,color:'rgba(255,255,255,0.25)'}}>{p.cards?.profession||'—'}</div>
                    </div>
                  </div>
                ))}
              </>
            )}
          </div>
        </div>
      ):me?.cards?(
        <>
        {/* Раскрытые карты других — в скролле, НЕ в фиксированной панели */}
        <div className="scr game-scr" style={{paddingTop:8}}>
          {alive.filter(p=>(p.revealed||[]).length>0).length>0&&(
            <div style={{padding:'0 0 8px'}}>
              <div style={{fontSize:9,color:'var(--tx3)',fontWeight:700,letterSpacing:2,textTransform:'uppercase',marginBottom:6}}>🃏 Раскрытые карты</div>
              {[...alive].sort((a,b)=>a.username===user.username?-1:b.username===user.username?1:0).map(p=>{
                const pRevd=p.revealed||[];
                const isMe=p.username===user.username;
                if(!pRevd.length)return null;
                const pReactions=reactions[p.username]||{};
                return(
                  <div key={p.username} style={{marginBottom:8,padding:isMe?'8px 10px':0,background:isMe?'rgba(255,159,10,0.06)':'transparent',borderRadius:isMe?12:0,border:isMe?'1px solid rgba(255,159,10,0.15)':'none'}}>
                    <div style={{fontSize:10,color:isMe?'var(--a)':'var(--tx3)',fontWeight:700,letterSpacing:1,marginBottom:4}}>{isMe?'👤 Вы (раскрыто)':`${p.name?.split(' ')[0]||p.username}`}:</div>
                    <div style={{display:'flex',gap:4,flexWrap:'wrap'}}>
                      {pRevd.map(k=>{
                        const m=CARDS.find(c=>c.key===k)||{};
                        const reaction=pReactions[k];
                        return(
                          <div key={k} style={{display:'flex',alignItems:'center',gap:4,background:'rgba(255,255,255,0.05)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:8,padding:'5px 9px',cursor:'pointer'}}
                            onClick={()=>setShowReactPicker(showReactPicker?.username===p.username&&showReactPicker?.cardKey===k?null:{username:p.username,cardKey:k})}>
                            <span style={{fontSize:12}}>{m.icon||'•'}</span>
                            <span style={{fontSize:11,color:'var(--tx2)'}}>{p.cards?.[k]||'—'}</span>
                            {reaction&&<span style={{fontSize:12}}>{reaction.emoji}</span>}
                          </div>
                        );
                      })}
                    </div>
                    {showReactPicker?.username===p.username&&(
                      <div style={{display:'flex',gap:6,background:'rgba(18,18,28,0.98)',border:'1px solid rgba(255,255,255,0.12)',borderRadius:12,padding:'8px 12px',marginTop:4}}>
                        {['👍','😱','😂','🔥','💀','🤔'].map(em=>(
                          <span key={em} style={{cursor:'pointer',fontSize:22}} onClick={()=>{DB.setReaction(gameId,p.username,showReactPicker.cardKey,em,user.username);setShowReactPicker(null);}}>{em}</span>
                        ))}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          )}
        </div>
        {/* Фиксированная нижняя панель: детали + стопка карт */}
        <div className="game-hand-area">

          {/* Кнопки действий */}
          <div style={{display:'flex',gap:8,padding:'6px 14px 0',pointerEvents:'all'}}>
            <button className="game-action-btn" style={{height:38,fontSize:12}} onClick={()=>setSub('players')}>👥</button>
            {game.roles&&me&&!me.isEliminated&&<button className="game-action-btn" style={{height:38,fontSize:12}} onClick={()=>setSub('role')}>🎭</button>}
            {game.bunkerMap&&<button className="game-action-btn" style={{height:38,fontSize:12}} onClick={()=>setSub('map')}>🗺️</button>}
            {isCreator&&<button className="game-action-btn primary" style={{height:38,fontSize:12,flex:2}} onClick={startVote}>🗳 Голосование</button>}
            {user.isAdmin&&<button className="game-action-btn danger" style={{height:38,fontSize:12}} onClick={()=>setSub('adminCheat')}>⚙️</button>}
          </div>

          {/* Детали выбранной карты / подсказка */}
          <div className="game-card-detail">
            {tappedCard?(()=>{
              const isSec=tappedCard==='secret';
              const cardMeta=isSec?{icon:mySecretCard?.icon||'🃏',label:'Секретная карта'}:CARDS.find(c=>c.key===tappedCard)||{};
              const isRev=!isSec&&(me.revealed||[]).includes(tappedCard);
              const val=isSec?mySecretCard?.name:me.cards?.[tappedCard]||'—';
              const desc=isSec?mySecretCard?.desc:null;
              return(<>
                <div className="game-card-detail-icon">{cardMeta.icon}</div>
                <div className="game-card-detail-text">
                  <div className="game-card-detail-label">{cardMeta.label}</div>
                  <div className="game-card-detail-value">{val}</div>
                  {desc&&<div className="game-card-detail-hint">{desc}</div>}
                </div>
                {isSec?(
                  !mySecretUsed&&!me.isEliminated&&(
                    <button className="game-card-detail-reveal" style={{background:'rgba(191,90,242,0.12)',borderColor:'rgba(191,90,242,0.4)',color:'#bf5af2'}} onClick={()=>{setTappedCard(null);useSecretCard(mySecretCard);}}>✨</button>
                  )
                ):isRev?(
                  <div className="game-card-detail-revealed">✓</div>
                ):revLeft>0?(
                  <button className="game-card-detail-reveal" onClick={()=>handleRevealFromCard(tappedCard)}>👁 Раскрыть</button>
                ):(
                  <div className="game-card-detail-hint" style={{flexShrink:0}}>Лимит</div>
                )}
              </>);
            })():(
              <div style={{display:'flex',alignItems:'center',gap:8,opacity:.4,flex:1}}>
                <div style={{fontSize:20}}>☝️</div>
                <div style={{fontSize:11,color:'var(--tx3)',lineHeight:1.4}}>Нажми на карту чтобы увидеть детали</div>
              </div>
            )}
          </div>

          {/* СТОПКА КАРТ внизу */}
          {(()=>{
            // Все карты: 6 основных + секретная
            const allCards=[...myCards,...(mySecretCard?[{key:'secret',icon:mySecretCard.icon,label:'Секрет'}]:[])];
            const n=allCards.length;
            const cardW=78;
            const screenW=Math.min(window.innerWidth||375, 480);
            // Динамический overlap: карты занимают 90% экрана
            const maxTotalW=screenW*0.90;
            const idealOverlap=Math.max(10, cardW - Math.floor((maxTotalW-cardW)/Math.max(n-1,1)));
            const overlap=n<=4?10:idealOverlap;
            const totalW=Math.min(cardW+(n-1)*(cardW-overlap), maxTotalW);
            return(
              <div className="game-hand" style={{width:'100%'}}>
                <div style={{position:'absolute',bottom:0,left:'50%',transform:`translateX(-${totalW/2}px)`,width:totalW,height:130}}>
                  {allCards.map(({key,icon,label},i)=>{
                    const isRev=key!=='secret'&&(me.revealed||[]).includes(key);
                    const isSel=tappedCard===key;
                    const isSecUsed=key==='secret'&&mySecretUsed;
                    const left=i*(cardW-overlap);
                    const zIndex=isSel?50:i+1;
                    // Небольшой случайный наклон для каждой карты (стабильный, на основе индекса)
                    const angle=(i-(n-1)/2)*3.5;
                    const liftY=isSel?-40:0;
                    return(
                      <div
                        key={key}
                        data-type={key}
                        className={`hand-card${isRev?' revealed':''}${isSel?' selected':''}${isSecUsed?' secret-card-used':''}`}
                        style={{left,zIndex,transform:`rotate(${angle}deg) translateY(${liftY}px)`,opacity:isSecUsed?0.4:1}}
                        onClick={()=>handleCardTap(key)}
                      >
                        {/* Уголок TL */}
                        <div className="hand-card-corner">
                          <div className="hand-card-corner-icon">{icon}</div>
                          <div className="hand-card-corner-label">{label.split(' ')[0]}</div>
                        </div>
                        {/* Уголок BR */}
                        <div className="hand-card-corner-br">
                          <div className="hand-card-corner-icon">{icon}</div>
                          <div className="hand-card-corner-label">{label.split(' ')[0]}</div>
                        </div>
                        {/* Центр */}
                        <div className="hand-card-center">{icon}</div>
                        {/* Полосочка цвета снизу */}
                        <div className="hand-card-strip"/>
                        {/* Бейдж раскрытия */}
                        {isRev&&<div className="hand-card-check">✓</div>}
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          })()}
        </div>
        </>
      ):(
        <div style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',color:'var(--tx3)',fontSize:11}}>Карты не назначены</div>
      )}

      {/* ── НИЖНИЕ КНОПКИ — всегда видны (резерв для игроков без карт) ── */}
      {me?.isEliminated&&(
        <div className="game-actions-row" style={{paddingBottom:`max(12px,env(safe-area-inset-bottom))`}}>
          <button className="game-action-btn" onClick={()=>setSub('players')}>👥 Игроки</button>
          {isCreator&&<button className="game-action-btn primary" onClick={startVote}>🗳 Голосование</button>}
          {user.isAdmin&&<button className="game-action-btn danger" onClick={()=>setSub('adminCheat')}>⚙️</button>}
        </div>
      )}
      {user.isAdmin&&sub==='adminCheat'&&(
        <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.85)',zIndex:200,padding:20,overflowY:'auto'}} onClick={()=>setSub('round')}>
          <div onClick={e=>e.stopPropagation()}>
            <AdminCheatPanel gameId={gameId} game={game} user={user} toast={toast} phase="game"/>
            <button className="game-action-btn" style={{marginTop:12,width:'100%'}} onClick={()=>setSub('round')}>✕ Закрыть</button>
          </div>
        </div>
      )}
    </div>
  );
}

/* Game Chat as an inner component (avoids setState during render) */
function GameChatInner({gameId,user,onClose}){
  const[msgs,setMsgs]=useState([]);
  useEffect(()=>{const u=DB.watchGameChat(gameId,m=>setMsgs(m));return u;},[gameId]);
  useEffect(()=>{
    const handler=(e)=>{if(e.key==='Escape')onClose();};
    window.addEventListener('keydown',handler);
    return()=>window.removeEventListener('keydown',handler);
  },[onClose]);
  const send=async(t)=>{await DB.sendGameMsg(gameId,user.username,user.displayName||user.username,t);};
  return<ChatView msgs={msgs} me={user} onSend={send} title="💬 ОБЩИЙ ЧАТ" onClose={onClose} extraPadBot={0}/>;
}

/* ══════════════════════════════════════════════════════════
   FRIENDS SCREEN
══════════════════════════════════════════════════════════ */
function FriendsList({friends,allUsers,online,onViewProfile,setChatFr,remove}){
  const[frSearch,setFrSearch]=useState('');
  const fids=Object.keys(friends);
  const filtered=fids.filter(fid=>{const fu=allUsers[fid];if(!fu)return false;if(!frSearch)return true;return fu.username.toLowerCase().includes(frSearch.toLowerCase())||(fu.displayName||'').toLowerCase().includes(frSearch.toLowerCase());});
  if(fids.length===0)return<div className="mono" style={{textAlign:'center',color:'var(--tx3)',fontSize:10,letterSpacing:2,padding:36}}>НЕТ ДРУЗЕЙ<br/><br/><span style={{fontSize:9}}>Используйте поиск</span></div>;
  return(
    <>
      {fids.length>3&&(
        <div style={{position:'relative',marginBottom:10}}>
          <input className="inp" placeholder="🔍 Поиск друга..." value={frSearch} onChange={e=>setFrSearch(e.target.value)} style={{marginBottom:0,paddingRight:frSearch?36:12}}/>
          {frSearch&&<button onClick={()=>setFrSearch('')} style={{position:'absolute',right:10,top:'50%',transform:'translateY(-50%)',background:'none',border:'none',color:'var(--tx3)',fontSize:16,cursor:'pointer',lineHeight:1}}>✕</button>}
        </div>
      )}
      {filtered.map(fid=>{const fu=allUsers[fid];if(!fu)return null;const isOnline=!!(online&&online[fid]);return(
        <div key={fid} className="fi" style={{cursor:'default'}}>
          <div style={{flex:1,cursor:'pointer'}} onClick={()=>onViewProfile&&onViewProfile(fid)}>
            <div style={{display:'flex',alignItems:'center',gap:6}}>
              <Avatar name={fu.displayName||fu.username} size="sm" avatar={fu.avatar} frame={fu.equipped?.frame}/>
              <span style={{fontSize:14,fontWeight:600}}>{fu.displayName||fu.username}</span>
              {isOnline?<span style={{width:7,height:7,borderRadius:'50%',background:'var(--g)',boxShadow:'0 0 6px var(--g)',display:'inline-block',flexShrink:0}}/>:<span style={{fontSize:8,color:'var(--tx3)',marginLeft:2}}>офлайн</span>}
            </div>
            <div style={{display:'flex',alignItems:'center',gap:6,marginTop:3}}>
              <div className="mono" style={{fontSize:8,color:'var(--tx3)'}}>@{fu.username}</div>
              <RChip user={fu}/>
            </div>
          </div>
          <button onClick={()=>setChatFr(fid)} style={{background:'rgba(10,132,255,0.12)',border:'1px solid rgba(10,132,255,0.3)',color:'var(--c)',borderRadius:8,padding:'7px 12px',fontSize:16,cursor:'pointer',transition:'.18s',flexShrink:0}} title="Написать">💬</button>
        </div>
      );})}
    </>
  );
}

function FriendsScreen({user,onBack,toast,gameInvites,onAcceptInvite,onViewProfile,online}){
  const[tab,setTab]=useState('friends');
  const[friends,setFr]=useState({});
  const[reqs,setReqs]=useState({});
  const[allUsers,setAU]=useState({});
  const[q,setQ]=useState('');
  const[searching,setSrch]=useState(false);
  const[results,setRes]=useState([]);
  const[chatFr,setChatFr]=useState(null);
  const[chatMsgs,setChatMsgs]=useState([]);

  useEffect(()=>{
    const u1=DB.watchFriends(user.username,f=>setFr(f));
    const u2=DB.watchFriendReqs(user.username,r=>setReqs(r));
    return()=>{u1();u2();};
  },[]);

  useEffect(()=>{
    const ids=[...new Set([...Object.keys(friends),...Object.keys(reqs)])];
    if(!ids.length)return;
    DB.getAllUsers().then(u=>setAU(u));
  },[JSON.stringify([...Object.keys(friends),...Object.keys(reqs)].sort())]);

  useEffect(()=>{
    if(!chatFr){setChatMsgs([]);return;}
    const u=DB.watchPrivChat(user.username,chatFr,m=>setChatMsgs(m));
    DB.markRead(user.username,chatFr,user.username);
    return u;
  },[chatFr]);

  const search=async()=>{
    const qq=q.trim().toLowerCase();if(!qq)return;
    setSrch(true);
    const all=await DB.getAllUsers();setAU(all);
    setRes(Object.values(all).filter(u=>u&&u.username&&u.username!==user.username&&(u.username.toLowerCase().includes(qq)||(u.displayName||'').toLowerCase().includes(qq))).slice(0,10));
    setSrch(false);
  };
  const addFriend=async(tid)=>{
    const r=await DB.sendFriendReq(user.username,tid);
    if(r.e==='already_friends')return toast('Уже в друзьях','err');
    if(r.e==='already_sent')return toast('Запрос уже отправлен','err');
    if(r.e==='not_found')return toast('Не найден','err');
    if(r.e==='self')return toast('Нельзя добавить себя','err');
    if(r.ok==='auto')toast('✅ Теперь вы друзья!','ok');
    else toast('✅ Запрос отправлен!','ok');
    setRes(p=>p.map(u=>u.username===tid?{...u,_req:true}:u));
  };
  const accept=async(fid)=>{await DB.acceptFriend(user.username,fid);toast('✅ Теперь вы друзья!','ok');};
  const reject=async(fid)=>{await DB.rejectFriend(user.username,fid);};
  const remove=async(fid)=>{if(!confirm('Удалить из друзей?'))return;await DB.removeFriend(user.username,fid);toast('Удалено','ok');};
  const acceptInv=async(iid,inv)=>{await DB.removeGameInvite(user.username,iid);onAcceptInvite(inv.gameId);};
  const declineInv=async(iid)=>{await DB.removeGameInvite(user.username,iid);};
  const sendMsg=async(t)=>{if(!chatFr)return;await DB.sendPrivMsg(user.username,chatFr,user.username,user.displayName||user.username,t);DB.markRead(user.username,chatFr,user.username);};

  const rqCnt=Object.keys(reqs).length;
  const ivCnt=Object.keys(gameInvites||{}).length;

  if(chatFr){
    const fu=allUsers[chatFr];
    const isOnline=!!(online&&online[chatFr]);
    return(
      <div className="sc">
        <ChatView msgs={chatMsgs} me={user} onSend={sendMsg}
          title={`💬 ${fu?.displayName||fu?.username||chatFr}`}
          onClose={()=>setChatFr(null)}
          extraPadBot={72}
          onlineStatus={isOnline}
          extra={<button onClick={()=>remove(chatFr)} style={{background:'rgba(255,69,58,0.1)',border:'1px solid rgba(255,69,58,0.3)',color:'var(--r)',fontFamily:"'Inter',sans-serif",fontSize:11,fontWeight:600,padding:'5px 10px',borderRadius:'6px',cursor:'pointer'}}>Удалить</button>}
        />
      </div>
    );
  }

  return(
    <div className="sc">
      <HZ/>
      <div className="tb">
        <BackBtn onClick={onBack}/>
        <div className="tb-title">ДРУЗЬЯ</div>
        <div className="mono" style={{fontSize:10,color:'var(--tx3)',letterSpacing:2}}>{Object.keys(friends).length}</div>
      </div>
      <div className="scr" style={{paddingTop:8}}>
        <div className="tabs">
          <button className={`tab${tab==='friends'?' on':''}`} onClick={()=>setTab('friends')}>ДРУЗЬЯ</button>
          <button className={`tab${tab==='reqs'?' on':''}`} onClick={()=>setTab('reqs')} style={{position:'relative'}}>ЗАПРОСЫ{rqCnt>0&&<span className="tab-badge">{rqCnt}</span>}</button>
          <button className={`tab${tab==='invs'?' on':''}`} onClick={()=>setTab('invs')} style={{position:'relative'}}>ИГРЫ{ivCnt>0&&<span className="tab-badge">{ivCnt}</span>}</button>
          <button className={`tab${tab==='search'?' on':''}`} onClick={()=>setTab('search')}>ПОИСК</button>
          <button className={`tab${tab==='groups'?' on':''}`} onClick={()=>setTab('groups')}>ГРУППЫ</button>
        </div>

        {tab==='friends'&&<FriendsList friends={friends} allUsers={allUsers} online={online} onViewProfile={onViewProfile} setChatFr={setChatFr} remove={remove}/>}
        {false&&null}

        {tab==='reqs'&&(Object.keys(reqs).length===0
          ?<div className="mono" style={{textAlign:'center',color:'var(--tx3)',fontSize:10,letterSpacing:2,padding:36}}>НЕТ ЗАПРОСОВ</div>
          :Object.entries(reqs).map(([fid])=>{const fu=allUsers[fid];return(
            <div key={fid} className="fi">
              <div style={{flex:1}}>
                <div style={{fontSize:14,fontWeight:600}}>{fu?.displayName||fu?.username||fid}</div>
                <div className="mono" style={{fontSize:8,color:'var(--tx3)',marginTop:2}}>@{fid} · хочет добавить</div>
              </div>
              <div style={{display:'flex',gap:6}}>
                <button onClick={()=>accept(fid)} style={{background:'var(--gt)',border:'1px solid var(--gb)',color:'var(--g)',fontFamily:"'Inter',sans-serif",fontSize:9,padding:'5px 10px',cursor:'pointer',letterSpacing:1}}>✓</button>
                <button onClick={()=>reject(fid)} style={{background:'var(--rt)',border:'1px solid var(--rb)',color:'var(--r)',fontFamily:"'Inter',sans-serif",fontSize:9,padding:'5px 10px',cursor:'pointer'}}>✕</button>
              </div>
            </div>
          );})
        )}

        {tab==='invs'&&(Object.keys(gameInvites||{}).length===0
          ?<div className="mono" style={{textAlign:'center',color:'var(--tx3)',fontSize:10,letterSpacing:2,padding:36}}>НЕТ ПРИГЛАШЕНИЙ</div>
          :Object.entries(gameInvites||{}).map(([iid,inv])=>(
            <div key={iid} className="fi">
              <div style={{flex:1}}>
                <div style={{fontSize:14,fontWeight:600}}>Приглашение в игру</div>
                <div className="mono" style={{fontSize:8,color:'var(--tx3)',marginTop:2}}>от {inv.fromName||inv.from} · {inv.gameId}</div>
              </div>
              <div style={{display:'flex',gap:6}}>
                <button onClick={()=>acceptInv(iid,inv)} style={{background:'var(--at)',border:'1px solid var(--ab)',color:'var(--a)',fontFamily:"'Inter',sans-serif",fontSize:9,padding:'5px 10px',cursor:'pointer',letterSpacing:1}}>⚡ ВОЙТИ</button>
                <button onClick={()=>declineInv(iid)} style={{background:'var(--rt)',border:'1px solid var(--rb)',color:'var(--r)',fontFamily:"'Inter',sans-serif",fontSize:9,padding:'5px 10px',cursor:'pointer'}}>✕</button>
              </div>
            </div>
          ))
        )}

        {tab==='search'&&(
          <div>
            <div style={{display:'flex',gap:8,marginBottom:12}}>
              <input className="inp" style={{marginBottom:0,flex:1}} value={q} onChange={e=>setQ(e.target.value)} onKeyDown={e=>e.key==='Enter'&&search()} placeholder="Имя пользователя…" maxLength={20}/>
              <button onClick={search} style={{background:'var(--a)',color:'#000',border:'none',padding:'0 16px',fontFamily:"'Inter',sans-serif",fontSize:15,letterSpacing:2,cursor:'pointer',flexShrink:0}}>{searching?'…':'НАЙТИ'}</button>
            </div>
            {results.map(u=>{
              const isFr=!!friends[u.username];
              return(
                <div key={u.username} className="fi">
                  <div style={{flex:1}}>
                    <div style={{fontSize:14,fontWeight:600}}>{u.displayName||u.username}</div>
                    <div style={{display:'flex',alignItems:'center',gap:6,marginTop:3}}>
                      <div className="mono" style={{fontSize:8,color:'var(--tx3)'}}>@{u.username}</div>
                      <RChip user={u}/>
                    </div>
                  </div>
                  {isFr?<span className="bdg bdg-g">ДРУГ</span>
                   :u._req?<span className="bdg bdg-a">ОТПРАВЛЕНО</span>
                   :<button onClick={()=>addFriend(u.username)} style={{background:'var(--at)',border:'1px solid var(--ab)',color:'var(--a)',fontFamily:"'Inter',sans-serif",fontSize:9,padding:'5px 10px',cursor:'pointer',letterSpacing:1}}>+ ДОБАВИТЬ</button>}
                </div>
              );
            })}
            {q&&!searching&&results.length===0&&<div className="mono" style={{textAlign:'center',color:'var(--tx3)',fontSize:10,letterSpacing:2,padding:24}}>НЕ НАЙДЕНО</div>}
          </div>
        )}
        {tab==='groups'&&<GroupsScreen user={user} onBack={()=>setTab('friends')} toast={toast} onViewProfile={onViewProfile}/>}
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   PLAYER PROFILE SCREEN
══════════════════════════════════════════════════════════ */
function PlayerProfileScreen({uid, me, onBack, online}){
  const [pUser, setPUser] = useState(null);
  const [loading, setLoading] = useState(true);
  useEffect(()=>{
    DB.getUser(uid).then(u=>{setPUser(u);setLoading(false);});
  },[uid]);
  useEffect(()=>{
    const handler=(e)=>{if(e.key==='Escape')onBack();};
    window.addEventListener('keydown',handler);
    return()=>window.removeEventListener('keydown',handler);
  },[onBack]);
  if(loading) return <div className="sc"><Spin/></div>;
  if(!pUser) return <div className="sc"><div className="tb"><BackBtn onClick={onBack}/><div className="tb-title">Не найден</div></div></div>;
  const rank=getRank(pUser);
  const games=pUser.gamesPlayed||0;
  const wins=pUser.gamesWon||0;
  const elims=pUser.gamesEliminated||0;
  const winRate=games>0?Math.round(wins/games*100):0;
  const isOnline=!!(online&&online[uid]);
  const isMe=me&&me.username===uid;
  const lvlInfo=getLevel(pUser.xp||0);
  const earnedAchs=Object.keys(pUser.achievements||{}).length;
  // Рамка профиля
  const frameData=PROFILE_FRAMES.find(f=>f.id===pUser.equipped?.frame);
  return(
    <div className="sc" style={{position:'fixed',inset:0,zIndex:500,background:'var(--bg)'}}>
      <div className="tb"><BackBtn onClick={onBack}/><div className="tb-title">ПРОФИЛЬ</div>{isMe&&<span className="bdg bdg-c">ВЫ</span>}</div>
      <div className="scr" style={{paddingBottom:40}}>

        {/* ═══ КРАСИВАЯ КАРТОЧКА ИГРОКА (Feature 23) ═══ */}
        <div style={{position:'relative',borderRadius:'var(--rad-lg)',overflow:'hidden',marginBottom:16,animation:'winFadeIn .35s ease'}}>
          {/* Градиентный фон карточки на основе цвета ранга */}
          <div style={{position:'absolute',inset:0,background:`linear-gradient(145deg,${rank.color}22 0%,rgba(10,10,15,0.97) 55%,${rank.color}08 100%)`,zIndex:0}}/>
          {/* Декоративные лучи */}
          <div style={{position:'absolute',top:'-40%',left:'-20%',width:'160%',height:'200%',background:`conic-gradient(from 220deg at 30% 50%,transparent 0deg,${rank.color}06 30deg,transparent 60deg)`,zIndex:0,pointerEvents:'none'}}/>
          {/* Рамка */}
          <div style={{position:'absolute',inset:0,border:`1.5px solid ${rank.color}35`,borderRadius:'var(--rad-lg)',zIndex:2,pointerEvents:'none'}}/>
          {/* Сканлайны (тонкие) */}
          <div style={{position:'absolute',inset:0,backgroundImage:'repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(255,255,255,0.012) 3px,rgba(255,255,255,0.012) 4px)',zIndex:1,pointerEvents:'none'}}/>

          <div style={{position:'relative',zIndex:3,padding:'24px 20px 20px'}}>
            {/* Верхняя строка: онлайн + ранг */}
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:20}}>
              <div style={{display:'flex',alignItems:'center',gap:6}}>
                <div style={{width:8,height:8,borderRadius:'50%',background:isOnline?'var(--g)':'rgba(255,255,255,0.2)',boxShadow:isOnline?'0 0 8px var(--g)':'none',flexShrink:0}}/>
                <span style={{fontSize:10,color:isOnline?'var(--g)':'var(--tx3)',fontWeight:600}}>{isOnline?'В СЕТИ':'ОФЛАЙН'}</span>
              </div>
              <div style={{display:'flex',alignItems:'center',gap:5,background:`${rank.color}15`,border:`1px solid ${rank.color}40`,borderRadius:20,padding:'4px 12px'}}>
                <span style={{fontSize:14}}>{rank.icon}</span>
                <span style={{fontSize:10,fontWeight:700,color:rank.color}}>{rank.name}</span>
              </div>
            </div>

            {/* Центр: аватар + имя */}
            <div style={{display:'flex',flexDirection:'column',alignItems:'center',marginBottom:20}}>
              {/* Аватар с рамкой */}
              <div style={{position:'relative',marginBottom:12}}>
                {frameData&&<div style={{position:'absolute',inset:-4,borderRadius:'50%',background:frameData.gradient,zIndex:0,filter:'blur(0px)'}}/>}
                <div style={{position:'relative',zIndex:1,width:80,height:80,borderRadius:'50%',background:frameData?'var(--bg)':'rgba(255,255,255,0.08)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:32,border:frameData?'none':'2px solid rgba(255,255,255,0.12)'}}>
                  {pUser.avatar||pUser.displayName?.[0]||pUser.username?.[0]||'?'}
                </div>
                {pUser.isAdmin&&<div style={{position:'absolute',bottom:-2,right:-2,zIndex:2,background:'linear-gradient(135deg,#f0a500,#ffd700)',borderRadius:'50%',width:22,height:22,display:'flex',alignItems:'center',justifyContent:'center',fontSize:11,border:'2px solid var(--bg)'}}>👑</div>}
              </div>
              <div style={{fontSize:22,fontWeight:800,color:'var(--tx)',letterSpacing:0.5,marginBottom:3}}>{pUser.displayName||pUser.username}</div>
              <div style={{fontSize:11,color:'var(--tx3)',marginBottom:6}}>@{pUser.username}</div>
              {pUser.status&&(
                <div style={{fontSize:12,color:'rgba(255,255,255,0.5)',fontStyle:'italic',textAlign:'center',maxWidth:220,background:'rgba(255,255,255,0.04)',borderRadius:8,padding:'5px 12px',border:'1px solid rgba(255,255,255,0.07)'}}>
                  "{pUser.status}"
                </div>
              )}
            </div>

            {/* Уровень */}
            <div style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad-sm)',padding:'10px 14px',marginBottom:14}}>
              <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:7}}>
                <div style={{background:'linear-gradient(135deg,var(--a),#ff6b00)',borderRadius:6,padding:'3px 10px',fontSize:11,fontWeight:900,color:'#000',flexShrink:0}}>УР. {lvlInfo.level}</div>
                <div style={{flex:1,height:5,background:'rgba(255,255,255,0.08)',borderRadius:3,overflow:'hidden'}}>
                  <div style={{height:'100%',width:`${Math.round(lvlInfo.currentXP/lvlInfo.neededXP*100)}%`,background:'linear-gradient(90deg,var(--a),#ff6b00)',borderRadius:3,transition:'width .6s ease'}}/>
                </div>
                <div style={{fontSize:9,color:'var(--tx3)',flexShrink:0}}>{lvlInfo.currentXP}/{lvlInfo.neededXP} XP</div>
              </div>
              {/* Достижения */}
              <div style={{display:'flex',alignItems:'center',gap:6}}>
                <span style={{fontSize:10,color:'var(--tx3)'}}>🏅 Достижений:</span>
                <span style={{fontSize:11,fontWeight:700,color:'var(--a)'}}>{earnedAchs}</span>
                <span style={{fontSize:10,color:'var(--tx3)'}}>/ {ACHIEVEMENTS.length}</span>
                {(pUser.loginStreak||0)>0&&<span style={{marginLeft:'auto',fontSize:10,color:'#ff9f0a',background:'rgba(255,159,10,0.1)',border:'1px solid rgba(255,159,10,0.3)',borderRadius:8,padding:'2px 7px',fontWeight:600}}>🔥 {pUser.loginStreak}д стрик</span>}
              </div>
            </div>

            {/* Статистика — горизонтальные плашки */}
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:12}}>
              {[
                {ico:'☢️',val:games,lbl:'Игр',col:'var(--a)',bg:'rgba(240,165,0,0.08)',brd:'rgba(240,165,0,0.2)'},
                {ico:'🏆',val:wins,lbl:'Побед',col:'var(--g)',bg:'rgba(48,209,88,0.08)',brd:'rgba(48,209,88,0.2)'},
                {ico:'💀',val:elims,lbl:'Выбываний',col:'var(--r)',bg:'rgba(255,69,58,0.08)',brd:'rgba(255,69,58,0.2)'},
                {ico:'📊',val:`${winRate}%`,lbl:'Побед %',col:'#4da6ff',bg:'rgba(77,166,255,0.08)',brd:'rgba(77,166,255,0.2)'},
              ].map(({ico,val,lbl,col,bg,brd})=>(
                <div key={lbl} style={{background:bg,border:`1px solid ${brd}`,borderRadius:'var(--rad-sm)',padding:'12px 10px',textAlign:'center'}}>
                  <div style={{fontSize:18,marginBottom:4}}>{ico}</div>
                  <div style={{fontSize:22,fontWeight:800,color:col,lineHeight:1}}>{val}</div>
                  <div style={{fontSize:9,color:'var(--tx3)',marginTop:3,fontWeight:600,letterSpacing:0.5}}>{lbl}</div>
                </div>
              ))}
            </div>

            {/* Прогресс-бар побед */}
            {games>0&&(
              <div style={{background:'rgba(255,255,255,0.03)',border:'1px solid rgba(255,255,255,0.07)',borderRadius:'var(--rad-sm)',padding:'10px 14px',marginBottom:4}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:7}}>
                  <span style={{fontSize:11,color:'var(--tx3)',fontWeight:500}}>Процент побед</span>
                  <span style={{fontSize:12,fontWeight:800,color:winRate>=50?'var(--g)':'var(--r)'}}>{winRate}%</span>
                </div>
                <div style={{height:6,background:'rgba(255,255,255,.06)',borderRadius:3,overflow:'hidden'}}>
                  <div style={{height:'100%',width:`${winRate}%`,background:`linear-gradient(90deg,${winRate>=50?'var(--g)':'#ff9f0a'},${winRate>=50?'#30d158':'var(--r)'})`,borderRadius:3,transition:'width .8s cubic-bezier(.34,1.56,.64,1)'}}/>
                </div>
              </div>
            )}
          </div>
        </div>

        <div className="lbl">🏅 ДОСТИЖЕНИЯ</div>
        <AchievementsPanel userData={pUser}/>
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   GROUPS SCREEN
══════════════════════════════════════════════════════════ */
function GroupsScreen({user,onBack,toast,onViewProfile}){
  const[groups,setGroups]=useState({});
  const[tab,setTab]=useState('mygroups');
  const[chatGroup,setChatGroup]=useState(null);
  const[chatMsgs,setChatMsgs]=useState([]);
  const[showCreate,setShowCreate]=useState(false);
  const[newName,setNewName]=useState('');
  const[allUsers,setAU]=useState({});

  useEffect(()=>{
    const u=DB.watchGroups(g=>setGroups(g));
    DB.getAllUsers().then(u=>setAU(u));
    return u;
  },[]);

  useEffect(()=>{
    if(!chatGroup){setChatMsgs([]);return;}
    const u=DB.watchGroupChat(chatGroup,m=>setChatMsgs(m));
    return u;
  },[chatGroup]);

  const myGroups=Object.values(groups).filter(g=>g.members&&g.members[user.username]);
  const allGroupsList=Object.values(groups).filter(g=>!(g.members&&g.members[user.username]));

  const createGroup=async()=>{
    if(!newName.trim())return toast('Введите название','err');
    const id=await DB.createGroup(newName.trim(),user.username);
    setNewName('');setShowCreate(false);
    toast('Группа создана!','ok');
  };
  const joinGroup=async(gid)=>{
    await DB.joinGroup(gid,user.username);
    toast('Вы вступили в группу!','ok');
  };
  const leaveGroup=async(gid)=>{
    if(!confirm('Покинуть группу?'))return;
    await DB.leaveGroup(gid,user.username);
    if(chatGroup===gid)setChatGroup(null);
    toast('Вы покинули группу','ok');
  };
  const sendMsg=async(text)=>{
    if(!chatGroup)return;
    await DB.sendGroupMsg(chatGroup,user.username,user.displayName||user.username,text);
  };

  if(chatGroup){
    const g=groups[chatGroup];
    return(
      <div className="sc">
        <ChatView msgs={chatMsgs} me={user} onSend={sendMsg}
          title={`👥 ${g?.name||chatGroup}`}
          onClose={()=>setChatGroup(null)}
          extraPadBot={72}
          extra={<button onClick={()=>leaveGroup(chatGroup)} style={{background:'rgba(255,69,58,0.1)',border:'1px solid rgba(255,69,58,0.3)',color:'var(--r)',fontFamily:"'Inter',sans-serif",fontSize:11,fontWeight:600,padding:'5px 10px',borderRadius:'6px',cursor:'pointer'}}>Выйти</button>}
        />
      </div>
    );
  }

  return(
    <div className="sc">
      <HZ/>
      <div className="tb"><BackBtn onClick={onBack}/><div className="tb-title">ГРУППЫ</div></div>
      <div className="scr" style={{paddingTop:8}}>
        <div className="tabs">
          <button className={`tab${tab==='mygroups'?' on':''}`} onClick={()=>setTab('mygroups')}>МОИ ({myGroups.length})</button>
          <button className={`tab${tab==='all'?' on':''}`} onClick={()=>setTab('all')}>ВСЕ</button>
        </div>
        {tab==='mygroups'&&(
          <>
            <Btn ch="➕ СОЗДАТЬ ГРУППУ" onClick={()=>setShowCreate(v=>!v)} cls="btn-g" sm/>
            {showCreate&&(
              <div style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:'var(--rad-sm)',padding:14,marginTop:8,marginBottom:10}}>
                <input className="inp" placeholder="Название группы..." value={newName} onChange={e=>setNewName(e.target.value)} onKeyDown={e=>e.key==='Enter'&&createGroup()} maxLength={40} autoFocus/>
                <div style={{display:'flex',gap:8,marginTop:4}}>
                  <Btn ch="✓ СОЗДАТЬ" onClick={createGroup} cls="btn-p" sm/>
                  <Btn ch="Отмена" onClick={()=>setShowCreate(false)} cls="btn-g" sm/>
                </div>
              </div>
            )}
            {myGroups.length===0?<div className="mono" style={{textAlign:'center',color:'var(--tx3)',fontSize:10,letterSpacing:2,padding:36}}>НЕТ ГРУПП</div>:
            myGroups.map(g=>(
              <div key={g.id} className="group-card" onClick={()=>setChatGroup(g.id)}>
                <div className="group-avatar">👥</div>
                <div style={{flex:1}}>
                  <div style={{fontSize:15,fontWeight:700,color:'var(--tx)'}}>{g.name}</div>
                  <div style={{fontSize:11,color:'var(--tx3)',marginTop:2}}>{Object.keys(g.members||{}).length} участников</div>
                </div>
                <button onClick={e=>{e.stopPropagation();leaveGroup(g.id);}} style={{background:'rgba(255,69,58,0.1)',border:'none',color:'var(--r)',borderRadius:6,padding:'5px 9px',fontSize:12,cursor:'pointer'}}>Выйти</button>
              </div>
            ))}
          </>
        )}
        {tab==='all'&&(
          allGroupsList.length===0?<div className="mono" style={{textAlign:'center',color:'var(--tx3)',fontSize:10,letterSpacing:2,padding:36}}>НЕТ ОТКРЫТЫХ ГРУПП</div>:
          allGroupsList.map(g=>(
            <div key={g.id} className="group-card" style={{cursor:'default'}}>
              <div className="group-avatar">👥</div>
              <div style={{flex:1}}>
                <div style={{fontSize:15,fontWeight:700,color:'var(--tx)'}}>{g.name}</div>
                <div style={{fontSize:11,color:'var(--tx3)',marginTop:2}}>{Object.keys(g.members||{}).length} участников</div>
              </div>
              <button onClick={()=>joinGroup(g.id)} style={{background:'rgba(191,90,242,0.15)',border:'1px solid rgba(191,90,242,0.3)',color:'var(--p)',borderRadius:6,padding:'5px 10px',fontSize:11,fontWeight:700,cursor:'pointer'}}>Войти</button>
            </div>
          ))
        )}
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   ROOT APP  —  SINGLE FIXED CONTAINER ARCHITECTURE
   NavBar is position:fixed at bottom (z:8000)
   Screen components never use position:fixed themselves
══════════════════════════════════════════════════════════ */
function SplashScreen({onDone}){
  const[done,setDone]=useState(false);
  useEffect(()=>{
    const t=setTimeout(()=>{setDone(true);setTimeout(onDone,500);},2500);
    return()=>clearTimeout(t);
  },[]);
  return(
    <div className={`splash-screen${done?' done':''}`}>
      <div className="splash-scanlines"/>
      <div className="splash-logo">☢</div>
      <div className="splash-title">— БУНКЕР —</div>
      <div className="splash-sub">С ЛЮБОВЬЮ ОТ ФТИ</div>
      <div className="splash-bar-wrap"><div className="splash-bar"/></div>
    </div>
  );
}

function FirebaseStatus(){
  const[connected,setConnected]=React.useState(true);
  React.useEffect(()=>{
    const ref=db.ref('.info/connected');
    const handler=snap=>setConnected(!!snap.val());
    ref.on('value',handler);
    return()=>ref.off('value',handler);
  },[]);
  return(
    <div className={`fb-status ${connected?'online':'offline'}`} title={connected?'Подключено к серверу':'Нет соединения'}>
      <span style={{width:7,height:7,borderRadius:'50%',background:connected?'var(--g)':'var(--r)',boxShadow:`0 0 6px ${connected?'var(--g)':'var(--r)'}`,display:'inline-block',flexShrink:0}}/>
      {!connected&&'Нет соединения'}
    </div>
  );
}

function App(){
  const[user,setUser]=useState(null);
  const[screen,setScreen]=useState('auth');
  const[splashDone,setSplashDone]=useState(false);
  const[gameId,setGid]=useState(null);
  const[,showToast,toasts,setToasts]=useToast();
  const[reqCnt,setReqCnt]=useState(0);
  const[invites,setInvites]=useState({});
  const[online,setOnline]=useState({});
  const[viewProfile,setViewProfile]=useState(null);
  const[screenDir,setScreenDir]=useState('right');
  const[announcement,setAnnouncement]=useState(null);
  const prevInvIds=useRef(new Set());
  const prevBroadcastIds=useRef(new Set());

  const notif=reqCnt+Object.keys(invites).length;

  // Refresh user
  useEffect(()=>{
    if(!user)return;
    const t=setInterval(async()=>{const f=await DB.getUser(user.username);if(f)setUser(f);},10000);
    return()=>clearInterval(t);
  },[user?.username]);

  // Watch notifications
  useEffect(()=>{
    if(!user)return;
    const u0=DB.setOnline(user.username);
    const u1=DB.watchFriendReqs(user.username,r=>setReqCnt(Object.keys(r).length));
    const u2=DB.watchGameInvites(user.username,inv=>{
      const ids=Object.keys(inv);
      ids.forEach(id=>{if(!prevInvIds.current.has(id)&&inv[id])showToast(`⚡ Приглашение от ${inv[id].fromName}!`,'ok');});
      prevInvIds.current=new Set(ids);
      setInvites(inv);
    });
    const u3=DB.watchOnline(o=>setOnline(o));
    // Watch broadcast messages from admin
    const u4=DB.watchBroadcast(msgs=>{
      msgs.forEach(m=>{
        if(!prevBroadcastIds.current.has(m.ts)){
          prevBroadcastIds.current.add(m.ts);
          showToast(`📢 ${m.from}: ${m.text}`,'info');
        }
      });
    });
    // Watch announcement
    const u5=DB.watchAnnouncement(a=>setAnnouncement(a));
    // Watch ban status
    const u6=db.ref(`users/${user.username}/isBanned`).on('value',s=>{
      if(s.val()===true){setUser(null);setScreen('auth');}
    });
    return()=>{if(u0)u0();u1();u2();u3();u4();u5();db.ref(`users/${user.username}/isBanned`).off('value',u6);};
  },[user?.username]);

  // Re-join active game
  useEffect(()=>{
    if(screen!=='home'||!user)return;
    (async()=>{
      try{
        const gs=await DB.getAllGames();
        const my=Object.values(gs||{}).find(g=>g&&g.players&&g.players[user.username]&&g.phase!=='finished');
        if(my){setGid(my.id);setScreen(my.phase==='lobby'?'lobby':'game');}
      }catch(e){console.error('rejoin error',e);}
    })();
  },[screen,user?.username]);

  const FORWARD_SCREENS=['createGame','joinGame','matchmaking','lobby','game','leaderboard','profile','friends','admin','shop'];
  const nav=s=>{
    const isForward=FORWARD_SCREENS.includes(s);
    setScreenDir(isForward?'right':'left');
    setScreen(s);
  };

  // Escape key handler
  useEffect(()=>{
    const handler=(e)=>{if(e.key==='Escape'){if(viewProfile)setViewProfile(null);}};
    window.addEventListener('keydown',handler);
    return()=>window.removeEventListener('keydown',handler);
  },[viewProfile]);

  const handleAcceptInvite=async(gid)=>{
    const g=await DB.getGame(gid);
    if(!g)return showToast('Игра не найдена','err');
    if(g.phase!=='lobby')return showToast('Игра не в лобби','err');
    if(!g.players?.[user.username]){
      if(Object.keys(g.players||{}).length>=16)return showToast('Комната заполнена','err');
      await DB.updateGame(gid,{[`players/${user.username}`]:{userId:user.username,username:user.username,name:user.displayName||user.username,cards:null,revealed:[],isEliminated:false}});
    }
    setGid(gid);nav('lobby');
  };

  const NAV_SCREENS=['home','friends','leaderboard','profile','shop'];
  const showNav=!!user&&NAV_SCREENS.includes(screen);

  /* NavBar component (inline so it has access to state) */
  const NavBar=()=>(
    <div id="nav-bar">
      {[
        ['home',Ico.home,'ГЛАВНАЯ'],
        ['friends',Ico.users,'ДРУЗЬЯ'],
        ['leaderboard',Ico.trophy,'РЕЙТИНГ'],
        ['shop',Ico.shop,'МАГАЗИН'],
        ['profile',Ico.user,'ПРОФИЛЬ'],
      ].map(([s,icon,label])=>(
        <button key={s} className={`nb${screen===s?' on':''}`} onClick={()=>nav(s)}>
          {s==='friends'&&notif>0&&<span className="nb-badge">{notif>9?'9+':notif}</span>}
          {icon}
          <span>{label}</span>
        </button>
      ))}
      <button className="nb" onClick={()=>{setUser(null);setGid(null);nav('auth');}}>
        {Ico.exit}<span>ВЫХОД</span>
      </button>
    </div>
  );

  return(
    <>
      {!splashDone&&<SplashScreen onDone={()=>setSplashDone(true)}/>}
      <Toast toasts={toasts} removeToast={id=>setToasts(p=>p.filter(t=>t.id!==id))}/>
      <FirebaseStatus/>
      <div id="screen-area" className={screenDir==='left'?'sc-back':''}>
        {screen==='auth'&&<AuthScreen onLogin={u=>{setUser(u);nav('home');}} toast={showToast}/>}
        {screen==='home'&&user&&<HomeScreen user={user} nav={nav} online={online} announcement={announcement} onUpdate={u=>setUser(u)} toast={showToast}/>}
        {screen==='friends'&&user&&<FriendsScreen user={user} onBack={()=>nav('home')} toast={showToast} gameInvites={invites} onAcceptInvite={handleAcceptInvite} onViewProfile={uid=>setViewProfile(uid)} online={online}/>}
        {screen==='profile'&&user&&<ProfileScreen user={user} onBack={()=>nav('home')} toast={showToast} onUpdate={u=>setUser(u)}/>}
        {screen==='shop'&&user&&<ShopScreen user={user} onBack={()=>nav('home')} toast={showToast} onUpdate={u=>setUser(u)}/>}
        {screen==='leaderboard'&&user&&<LeaderboardScreen me={user} onBack={()=>nav('home')} onViewProfile={uid=>setViewProfile(uid)} online={online}/>}
        {screen==='admin'&&user?.isAdmin&&<AdminScreen me={user} onBack={()=>nav('home')} toast={showToast}/>}
        {screen==='createGame'&&user&&<CreateGameScreen user={user} onBack={()=>nav('home')} onCreated={id=>{setGid(id);nav('lobby');}} toast={showToast}/>}
        {screen==='joinGame'&&user&&<JoinGameScreen user={user} onBack={()=>nav('home')} onJoined={id=>{setGid(id);nav('lobby');}} toast={showToast}/>}
        {screen==='matchmaking'&&user&&<MatchmakingScreen user={user} onBack={()=>nav('home')} onJoined={id=>{setGid(id);nav('lobby');}} toast={showToast}/>}
        {screen==='lobby'&&user&&gameId&&<LobbyScreen gameId={gameId} user={user} onBack={()=>{setGid(null);nav('home');}} onStarted={()=>nav('game')} toast={showToast} onViewProfile={uid=>setViewProfile(uid)}/>}
        {screen==='game'&&user&&gameId&&<GameWrapper key={gameId} gameId={gameId} user={user} onExit={()=>{setGid(null);nav('home');}} toast={showToast} onViewProfile={uid=>setViewProfile(uid)} online={online}/>}
        {viewProfile&&<PlayerProfileScreen uid={viewProfile} me={user} onBack={()=>setViewProfile(null)} online={online}/>}
      </div>
      {showNav&&<NavBar/>}
    </>
  );
}

class ErrorBoundary extends React.Component{
  constructor(p){super(p);this.state={err:null};}
  static getDerivedStateFromError(e){return{err:e};}
  componentDidCatch(e,info){console.error('React error:',e,info);}
  render(){
    if(this.state.err)return(
      <div style={{color:'#fff',padding:24,fontFamily:'monospace',background:'#1a0000',minHeight:'100vh',fontSize:13}}>
        <div style={{color:'#ff453a',fontSize:18,marginBottom:16}}>⚠️ Ошибка рендера</div>
        <div style={{background:'rgba(255,0,0,.1)',padding:12,borderRadius:8,wordBreak:'break-all'}}>
          {this.state.err.toString()}
        </div>
        <button onClick={()=>this.setState({err:null})} style={{marginTop:16,padding:'8px 16px',background:'#ff453a',border:'none',color:'#fff',borderRadius:8,cursor:'pointer'}}>
          Перезагрузить
        </button>
      </div>
    );
    return this.props.children;
  }
}
ReactDOM.createRoot(document.getElementById('app')).render(<ErrorBoundary><App/></ErrorBoundary>);

// ══ BUNKER GATE — кинематографическая анимация (вызывается после логина) ══
window.triggerGate = function(){
  const gate = document.getElementById('bunker-gate');
  const statusTxt = document.getElementById('gate-status-txt');
  if(!gate) return;

  // Показываем ворота
  gate.classList.remove('hidden');
  gate.classList.remove('opening');
  gate.classList.remove('flashing');
  gate.style.opacity = '1';
  gate.style.transition = '';
  const arc = gate.querySelector('.gate-lock-arc');
  if(arc){ arc.style.transform=''; arc.style.opacity=''; }

  const setStatus = (txt) => { if(statusTxt) statusTxt.textContent = txt; };

  setStatus('СИСТЕМА БЕЗОПАСНОСТИ АКТИВНА');
  setTimeout(()=>{ setStatus('ИДЕНТИФИКАЦИЯ... ████████░░ 80%'); }, 600);
  setTimeout(()=>{ setStatus('ДОСТУП РАЗРЕШЁН — ОТКРЫВАЮ ВОРОТА'); }, 1400);
  setTimeout(()=>{
    if(arc){ arc.style.transform='translateY(4px)'; arc.style.opacity='0.4'; }
  }, 1700);
  setTimeout(()=>{
    gate.classList.add('flashing');
    setTimeout(()=>gate.classList.remove('flashing'), 180);
  }, 1900);
  setTimeout(()=>{
    gate.classList.add('opening');
    setStatus('');
  }, 2000);
  setTimeout(()=>{
    gate.style.transition = 'opacity .5s ease';
    gate.style.opacity = '0';
    setTimeout(()=>{ gate.classList.add('hidden'); gate.style.opacity=''; }, 520);
  }, 3200);
};
</script>

<script>
/* ══════════════════════════════════════════════
   MOBILE PWA ENHANCEMENTS
   ══════════════════════════════════════════════ */

/* 1. Виртуальная клавиатура — подтягиваем контент вверх */
(function() {
  // Используем visualViewport API если доступен
  if (window.visualViewport) {
    function onViewportResize() {
      var vv = window.visualViewport;
      var app = document.getElementById('app');
      if (!app) return;
      // Высота визуального вьюпорта (без клавиатуры)
      var vh = vv.height;
      // Смещение сверху (когда клавиатура открыта)
      var offsetTop = vv.offsetTop;
      app.style.height = vh + 'px';
      app.style.top = offsetTop + 'px';
      app.style.position = 'fixed';
      // Скроллим чат вниз при открытии клавиатуры
      var chatMsgs = document.querySelector('.chat-msgs');
      if (chatMsgs) {
        setTimeout(function() {
          chatMsgs.scrollTop = chatMsgs.scrollHeight;
        }, 100);
      }
    }
    window.visualViewport.addEventListener('resize', onViewportResize);
    window.visualViewport.addEventListener('scroll', onViewportResize);
  }

  /* 2. Предотвращаем bounce-скролл страницы на iOS */
  document.addEventListener('touchmove', function(e) {
    if (e.target.closest('.scr, .scr-raw, .chat-msgs, .modal-bd, .notes-area')) return;
    e.preventDefault();
  }, { passive: false });

  /* 3. Быстрый тап без задержки 300ms на старых Android */
  document.addEventListener('touchstart', function(){}, { passive: true });

  /* 4. Скрываем адресную строку при старте (для браузеров без PWA) */
  function hideAddressBar() {
    if (document.documentElement.scrollHeight <= window.innerHeight) return;
    window.scrollTo(0, 1);
  }
  window.addEventListener('load', function() {
    setTimeout(hideAddressBar, 500);
  });
  window.addEventListener('orientationchange', function() {
    setTimeout(hideAddressBar, 600);
  });

  /* 5. Блокируем системный context menu на долгом тапе */
  document.addEventListener('contextmenu', function(e) {
    if (!e.target.closest('input, textarea, [contenteditable]')) {
      e.preventDefault();
    }
  });

  /* 6. Фикс — при фокусе на input скроллим к нему */
  document.addEventListener('focusin', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      setTimeout(function() {
        e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 350);
    }
  });
})();
</script>
</body>
</html>