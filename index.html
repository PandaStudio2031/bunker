<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>☢ БУНКЕР</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
/* ╔══════════════════════════════════════════════════════╗
   ║  DESIGN SYSTEM — MODERN MINIMAL / APPLE-INSPIRED     ║
   ╚══════════════════════════════════════════════════════╝ */
:root {
  --bg:        #0a0a0f;
  --s1:        rgba(18,18,28,0.90);
  --s2:        rgba(22,22,34,0.85);
  --s3:        rgba(12,12,20,0.97);

  --a:         #f0a500;
  --a2:        #ffc235;
  --at:        rgba(240,165,0,0.08);
  --ab:        rgba(240,165,0,0.18);
  --ag:        rgba(240,165,0,0.45);

  --r:         #ff453a;
  --rt:        rgba(255,69,58,0.10);
  --rb:        rgba(255,69,58,0.25);

  --g:         #30d158;
  --gt:        rgba(48,209,88,0.08);
  --gb:        rgba(48,209,88,0.22);

  --c:         #0a84ff;
  --p:         #bf5af2;

  --tx:        #e8e8ed;
  --tx2:       #8e8e99;
  --tx3:       #3a3a4a;

  --nav-h:     76px;
  --safe-bot:  env(safe-area-inset-bottom, 0px);
  --bl:        blur(24px) saturate(180%);
  --bl-sm:     blur(12px) saturate(160%);
  --rad:       16px;
  --rad-sm:    10px;
  --rad-lg:    22px;
}

*, *::before, *::after { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent }
html, body { width:100%; height:100%; overflow:hidden; font-family:'Inter','SF Pro Display',system-ui,sans-serif; color:var(--tx); }
::-webkit-scrollbar { width:3px } ::-webkit-scrollbar-thumb { background:rgba(255,255,255,.1); border-radius:2px; }

/* ──────────────── APP ROOT ──────────────── */
#app {
  position:fixed; inset:0;
  display:flex; flex-direction:column;
  overflow:hidden;
  background:
    radial-gradient(ellipse 80% 50% at 50% 100%, rgba(240,165,0,0.06) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 10% 10%,  rgba(10,132,255,0.04) 0%, transparent 55%),
    #0a0a0f;
}
#app::before { display:none; }
#app::after  { display:none; }

/* ──────────────── SCREEN AREA ──────────────── */
#screen-area {
  flex:1; display:flex; flex-direction:column;
  overflow:hidden; position:relative; z-index:1;
  min-height:0;
}

.sc { flex:1; display:flex; flex-direction:column; overflow:hidden; animation:fadeUp .2s ease; }

/* ──────────────── ANIMATIONS ──────────────── */
@keyframes fadeUp  { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }
@keyframes splashFadeOut { from{opacity:1} to{opacity:0;pointer-events:none} }
@keyframes splashGlow { 0%,100%{filter:drop-shadow(0 0 18px rgba(240,165,0,.7))} 50%{filter:drop-shadow(0 0 48px rgba(240,165,0,1))} }
@keyframes splashBar { from{width:0%} to{width:100%} }
@keyframes splashScan { from{background-position:0 0} to{background-position:0 100%} }
@keyframes confettiFall { from{transform:translateY(-20px) rotate(0deg);opacity:1} to{transform:translateY(110vh) rotate(720deg);opacity:0} }
@keyframes skullFloat { 0%{transform:translateY(0) rotate(-10deg);opacity:.5} 50%{transform:translateY(-15px) rotate(10deg);opacity:.8} 100%{transform:translateY(0) rotate(-10deg);opacity:.5} }

.splash-screen {
  position:fixed;inset:0;z-index:99999;background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
}
.splash-screen.done { animation:splashFadeOut .5s ease forwards; pointer-events:none; }
.splash-logo { font-size:90px;line-height:1;animation:splashGlow 2s ease infinite; color:var(--a); }
.splash-title { font-family:'Share Tech Mono',monospace;font-size:28px;font-weight:700;color:var(--a);letter-spacing:6px;margin-top:16px;text-align:center; }
.splash-sub { font-size:10px;color:var(--tx3);letter-spacing:3px;text-align:center;margin-top:8px;font-family:'Inter',sans-serif; }
.splash-bar-wrap { width:220px;height:3px;background:rgba(255,255,255,0.08);border-radius:2px;margin-top:32px;overflow:hidden; }
.splash-bar { height:100%;background:var(--a);border-radius:2px;animation:splashBar 2.5s ease forwards; }
.splash-scanlines {
  position:absolute;inset:0;pointer-events:none;
  background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(240,165,0,.03) 3px,rgba(240,165,0,.03) 6px);
}
.player-game-card {
  background:linear-gradient(135deg,rgba(255,255,255,0.05),rgba(255,255,255,0.02));
  border:1px solid rgba(255,255,255,0.1);border-radius:14px;padding:14px 16px;margin-bottom:10px;
  display:flex;gap:0;position:relative;overflow:hidden;
}
.player-game-card-accent { width:4px;border-radius:3px 0 0 3px;flex-shrink:0;margin-left:-16px;margin-right:12px; }
.player-game-card.elim { opacity:0.4; }
.card-chip {
  border-radius:6px;padding:3px 8px;font-size:11px;display:inline-block;margin:2px 3px 2px 0;
}
.avatar-picker-grid { display:grid;grid-template-columns:repeat(6,1fr);gap:6px;padding:10px 0; }
.avatar-picker-btn { font-size:24px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:8px;cursor:pointer;transition:.2s ease;text-align:center;line-height:1;position:relative;overflow:hidden; }
.avatar-picker-btn:hover { background:linear-gradient(135deg,rgba(155,89,239,0.25),rgba(10,132,255,0.2));border-color:rgba(155,89,239,0.5);transform:scale(1.1);box-shadow:0 4px 14px rgba(155,89,239,0.3); }
.avatar-picker-btn.selected { background:linear-gradient(135deg,rgba(155,89,239,0.35),rgba(10,132,255,0.3));border-color:rgba(155,89,239,0.8);box-shadow:0 0 16px rgba(155,89,239,0.5),0 4px 14px rgba(10,132,255,0.3);transform:scale(1.08); }
@keyframes pulse   { 0%,100%{opacity:1}50%{opacity:.3} }
@keyframes spin    { to{transform:rotate(360deg)} }
@keyframes glow    { 0%,100%{filter:drop-shadow(0 0 10px rgba(240,165,0,.55))} 50%{filter:drop-shadow(0 0 26px rgba(240,165,0,.9))} }
@keyframes glitch  { 0%,87%,100%{clip-path:none;transform:none} 88%{clip-path:inset(28% 0 52% 0);transform:translateX(-3px)} 89%{clip-path:inset(52% 0 18% 0);transform:translateX(3px)} 90%{clip-path:none} }
@keyframes shake   { 0%{transform:rotate(-5deg) scale(1)} 100%{transform:rotate(5deg) scale(1.05)} }
@keyframes slideUp { from{transform:translateY(100%);opacity:0} to{transform:none;opacity:1} }
@keyframes blink   { 0%,100%{opacity:1} 50%{opacity:0} }
@keyframes flipIn  { from{transform:rotateY(90deg);opacity:0} to{transform:rotateY(0deg);opacity:1} }
@keyframes elimOverlayIn { 0%{opacity:0;transform:scale(1.08)} 100%{opacity:1;transform:scale(1)} }
@keyframes roundTimerPulse { 0%,100%{box-shadow:0 0 8px rgba(255,69,58,.4)} 50%{box-shadow:0 0 20px rgba(255,69,58,.9)} }

/* ──────────────── THEMES ──────────────── */
body.theme-dark  { }
body.theme-alarm {
  --bg: #0f0303; --s1: rgba(28,8,8,0.90); --s2: rgba(32,10,10,0.85); --s3: rgba(20,4,4,0.97);
  --a: #ff453a; --a2: #ff6b63; --at: rgba(255,69,58,0.08); --ab: rgba(255,69,58,0.18); --ag: rgba(255,69,58,0.45);
  --tx3: #4a2a2a;
}
body.theme-alarm #app {
  background: radial-gradient(ellipse 80% 50% at 50% 100%, rgba(255,69,58,0.08) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 10% 10%, rgba(139,0,0,0.06) 0%, transparent 55%), #0f0303;
}
body.theme-radiation {
  --bg: #030f03; --s1: rgba(8,28,8,0.90); --s2: rgba(10,32,10,0.85); --s3: rgba(4,20,4,0.97);
  --a: #30d158; --a2: #5ee67a; --at: rgba(48,209,88,0.08); --ab: rgba(48,209,88,0.18); --ag: rgba(48,209,88,0.45);
  --tx3: #2a4a2a;
}
body.theme-radiation #app {
  background: radial-gradient(ellipse 80% 50% at 50% 100%, rgba(48,209,88,0.08) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 10% 10%, rgba(0,80,0,0.06) 0%, transparent 55%), #030f03;
}
body.theme-mipt {
  --bg: #020a18; --s1: rgba(5,18,38,0.92); --s2: rgba(6,22,46,0.88); --s3: rgba(3,12,28,0.97);
  --a: #4da6ff; --a2: #7ac0ff; --at: rgba(77,166,255,0.09); --ab: rgba(77,166,255,0.22); --ag: rgba(77,166,255,0.5);
  --r: #ff6b6b; --rt: rgba(255,107,107,0.10); --rb: rgba(255,107,107,0.25);
  --g: #43e97b; --gt: rgba(67,233,123,0.08); --gb: rgba(67,233,123,0.22);
  --p: #a78bfa; --c: #38bdf8;
  --tx: #e2eeff; --tx2: #7b9cbf; --tx3: #243654;
}
body.theme-mipt #app {
  background:
    radial-gradient(ellipse 80% 50% at 50% 100%, rgba(77,166,255,0.10) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 10% 10%, rgba(10,60,120,0.08) 0%, transparent 55%),
    radial-gradient(ellipse 40% 30% at 90% 20%, rgba(100,60,255,0.05) 0%, transparent 50%),
    #020a18;
}
/* ФИЗТЕХ — переопределение кнопок */
body.theme-mipt .btn { background:linear-gradient(135deg,#1a5fa8,#4da6ff); color:#fff; border:none; box-shadow:0 2px 12px rgba(77,166,255,0.25); }
body.theme-mipt .btn:hover { background:linear-gradient(135deg,#2070c0,#60b8ff); box-shadow:0 4px 18px rgba(77,166,255,0.35); }
body.theme-mipt .btn:active { background:linear-gradient(135deg,#1248a0,#3a8ee0); }
body.theme-mipt .btn-g { background:rgba(77,166,255,0.08); color:var(--tx2); border:1px solid rgba(77,166,255,0.18); box-shadow:none; }
body.theme-mipt .btn-g:hover { background:rgba(77,166,255,0.14); color:var(--a); }
body.theme-mipt .btn-d { background:linear-gradient(135deg,#8b1a1a,#ff4444); color:#fff; border:none; }
body.theme-mipt .btn-c { background:rgba(77,166,255,0.12); color:#4da6ff; border:1px solid rgba(77,166,255,0.3); box-shadow:none; }
body.theme-mipt .btn-pu { background:rgba(120,100,255,0.12); color:#a78bfa; border:1px solid rgba(120,100,255,0.3); box-shadow:none; }
body.theme-mipt .btn-gr { background:rgba(67,233,123,0.1); color:#43e97b; border:1px solid rgba(67,233,123,0.25); box-shadow:none; }
/* ФИЗТЕХ — карточки и панели */
body.theme-mipt .card { border-color:rgba(77,166,255,0.15); }
body.theme-mipt .inp { border-color:rgba(77,166,255,0.2); background:rgba(4,15,35,0.9); }
body.theme-mipt .inp:focus { border-color:rgba(77,166,255,0.5); box-shadow:0 0 0 3px rgba(77,166,255,0.1); }
body.theme-mipt .tb { border-bottom-color:rgba(77,166,255,0.12); }
body.theme-mipt .tab-btn.active { color:#4da6ff; border-bottom-color:#4da6ff; }
body.theme-mipt .bottom-nav-btn.active { color:#4da6ff; }

/* ──────────────── THEME SWITCHER ──────────────── */
.theme-btn {
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 12px; border:1px solid rgba(255,255,255,0.12); border-radius:var(--rad-sm);
  background:rgba(255,255,255,0.06); cursor:pointer; font-family:'Inter',sans-serif;
  font-size:11px; font-weight:600; color:var(--tx2); transition:.18s;
}
.theme-btn.active { border-color:var(--ab); background:var(--at); color:var(--a); }
.theme-btn:hover { border-color:var(--ab); color:var(--a); }

/* ──────────────── ROUND TIMER ──────────────── */
.round-timer {
  display:flex; align-items:center; gap:8px; padding:8px 14px;
  background:rgba(255,69,58,0.08); border-bottom:1px solid rgba(255,69,58,0.2);
  flex-shrink:0;
}
.round-timer.urgent { animation:roundTimerPulse 1s ease infinite; background:rgba(255,69,58,0.15); }

/* ──────────────── NOTES TAB ──────────────── */
.notes-area {
  width:100%; min-height:220px; resize:vertical;
  background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.1);
  border-radius:var(--rad-sm); color:var(--tx); font-family:'Inter',sans-serif;
  font-size:14px; line-height:1.6; padding:14px; outline:none;
  transition:border-color .18s;
}
.notes-area:focus { border-color:rgba(240,165,0,0.4); }

/* ──────────────── EVENT LOG ──────────────── */
.log-entry {
  display:flex; gap:10px; padding:9px 14px; border-bottom:1px solid rgba(255,255,255,0.05);
  font-size:12px; line-height:1.45; align-items:flex-start;
}
.log-entry:last-child { border-bottom:none; }
.log-ts { font-family:'Share Tech Mono',monospace; font-size:9px; color:var(--tx3); flex-shrink:0; margin-top:2px; min-width:42px; }

/* ──────────────── CARD REACTIONS ──────────────── */
.react-bar { display:flex; gap:4px; flex-wrap:wrap; margin-top:6px; }
.react-chip {
  display:inline-flex; align-items:center; gap:3px; padding:2px 8px;
  background:rgba(255,255,255,0.07); border:1px solid rgba(255,255,255,0.12);
  border-radius:12px; font-size:12px; cursor:pointer; transition:.15s;
}
.react-chip:hover { background:rgba(240,165,0,0.12); border-color:rgba(240,165,0,0.3); }
.react-chip.mine { background:rgba(240,165,0,0.15); border-color:rgba(240,165,0,0.4); }
.react-add { display:inline-flex; align-items:center; padding:2px 6px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:12px; font-size:13px; cursor:pointer; color:var(--tx3); transition:.15s; }
.react-add:hover { background:rgba(240,165,0,0.1); border-color:rgba(240,165,0,0.3); color:var(--a); }

/* ──────────────── ACHIEVEMENTS ──────────────── */
.ach-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:14px; }
.ach-card {
  padding:12px; border-radius:var(--rad-sm); border:1px solid rgba(255,255,255,0.08);
  background:rgba(255,255,255,0.04); position:relative; overflow:hidden;
}
.ach-card.earned { border-color:rgba(240,165,0,0.4); background:rgba(240,165,0,0.07); }
.ach-card.locked { opacity:.45; }
.ach-icon { font-size:28px; margin-bottom:6px; }
.ach-name { font-size:11px; font-weight:700; color:var(--tx); margin-bottom:3px; }
.ach-desc { font-size:10px; color:var(--tx3); line-height:1.4; }
.ach-earned-badge { position:absolute; top:6px; right:6px; font-size:9px; font-weight:700; color:var(--a); background:rgba(240,165,0,0.15); border:1px solid rgba(240,165,0,0.3); border-radius:6px; padding:2px 5px; }

/* ──────────────── GROUPS ──────────────── */
.group-card {
  display:flex; align-items:center; gap:12px; padding:13px 16px;
  background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08);
  border-radius:var(--rad-sm); margin-bottom:8px; cursor:pointer; transition:.18s;
}
.group-card:hover { border-color:rgba(191,90,242,0.35); background:rgba(191,90,242,0.06); }
.group-avatar { width:40px; height:40px; border-radius:'50%'; background:rgba(191,90,242,0.2); border:1px solid rgba(191,90,242,0.4); display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0; }

/* ══════════════════════════════════════════
   BUNKER GATE — кинематографическое открытие
   ══════════════════════════════════════════ */
#bunker-gate {
  position: fixed; inset: 0; z-index: 99000;
  background: #03030a;
  pointer-events: all;
  transition: opacity .6s ease;
}
#bunker-gate.hidden { opacity: 0; pointer-events: none; visibility: hidden; }

/* Фоновый туман */
#bunker-gate::before {
  content: '';
  position: absolute; inset: 0;
  background:
    radial-gradient(ellipse 80% 50% at 50% 110%, rgba(240,165,0,0.07) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 50% 50%, rgba(240,165,0,0.04) 0%, transparent 70%);
  pointer-events: none;
}

/* Левая и правая створки */
.gate-left, .gate-right {
  position: absolute; top: 0; bottom: 0; width: 50%;
  overflow: hidden;
  transition: transform 1.4s cubic-bezier(0.86, 0, 0.07, 1);
  will-change: transform;
}
.gate-left  { left: 0;  transform-origin: left center; }
.gate-right { right: 0; transform-origin: right center; }

/* Металлическая текстура створок */
.gate-left::before, .gate-right::before {
  content: ''; position: absolute; inset: 0;
  background:
    linear-gradient(180deg,
      #161620 0%, #1c1c28 15%, #131318 30%,
      #1e1e2a 45%, #111116 60%, #1a1a24 75%, #0e0e14 100%);
}
/* Горизонтальные рёбра жёсткости */
.gate-left::after, .gate-right::after {
  content: ''; position: absolute; inset: 0;
  background: repeating-linear-gradient(
    180deg,
    transparent 0px, transparent 44px,
    rgba(255,255,255,0.035) 44px, rgba(255,255,255,0.035) 46px,
    rgba(0,0,0,0.3) 46px, rgba(0,0,0,0.3) 48px,
    transparent 48px, transparent 92px
  );
}

/* Вертикальные болты/рёбра на каждой створке */
.gate-ribs {
  position: absolute; inset: 0;
  background: repeating-linear-gradient(
    90deg,
    transparent 0px, transparent 60px,
    rgba(255,255,255,0.02) 60px, rgba(255,255,255,0.02) 62px,
    rgba(0,0,0,0.15) 62px, rgba(0,0,0,0.15) 64px,
    transparent 64px
  );
  pointer-events: none;
}

/* Болты на краях */
.gate-bolts {
  position: absolute; top: 0; bottom: 0;
  display: flex; flex-direction: column;
  justify-content: space-around; padding: 24px 0;
  gap: 0; pointer-events: none;
}
.gate-left .gate-bolts  { right: 10px; }
.gate-right .gate-bolts { left: 10px; }

.gate-bolt {
  width: 10px; height: 10px; border-radius: 50%;
  background: radial-gradient(circle at 35% 35%, rgba(255,255,255,0.4), rgba(120,100,40,0.8));
  box-shadow: 0 0 4px rgba(0,0,0,0.8), inset 0 1px 1px rgba(255,255,255,0.2);
  flex-shrink: 0;
}

/* Свечение по центральному шву */
.gate-seam {
  position: absolute; top: 0; bottom: 0; left: 50%;
  width: 1px; transform: translateX(-50%);
  background: linear-gradient(180deg,
    transparent 0%,
    rgba(240,165,0,0.15) 10%,
    rgba(240,165,0,0.6) 30%,
    rgba(240,165,0,1)   50%,
    rgba(240,165,0,0.6) 70%,
    rgba(240,165,0,0.15) 90%,
    transparent 100%);
  box-shadow: 0 0 8px 2px rgba(240,165,0,0.4), 0 0 20px 4px rgba(240,165,0,0.15);
  z-index: 10;
  transition: opacity .25s;
}

/* Центральная эмблема + замок */
.gate-center {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  z-index: 20; display: flex; flex-direction: column;
  align-items: center; gap: 10px;
  transition: opacity .3s ease;
}
.gate-emblem {
  font-size: 56px; line-height: 1;
  filter: drop-shadow(0 0 20px rgba(240,165,0,0.8));
  animation: gateGlow 1.8s ease-in-out infinite;
}
.gate-lock {
  display: flex; flex-direction: column; align-items: center;
}
.gate-lock-arc {
  width: 26px; height: 14px;
  border: 3px solid rgba(240,165,0,0.9);
  border-bottom: none; border-radius: 13px 13px 0 0;
  box-shadow: 0 0 10px rgba(240,165,0,0.5);
  transition: transform .4s ease, opacity .4s ease;
}
.gate-lock-body {
  width: 34px; height: 22px;
  background: rgba(240,165,0,0.1);
  border: 2px solid rgba(240,165,0,0.8);
  border-radius: 5px;
  box-shadow: 0 0 14px rgba(240,165,0,0.35);
}

/* Круговые полосы (спиннер-замок) */
.gate-wheel {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  z-index: 15; pointer-events: none;
  transition: opacity .3s;
}
.gate-wheel-ring {
  position: absolute; border-radius: 50%;
  border: 1px solid rgba(240,165,0,0.2);
  top: 50%; left: 50%; transform: translate(-50%, -50%);
}
.gate-wheel-ring:nth-child(1){ width:90px;  height:90px;  border-color:rgba(240,165,0,0.25); animation:wheelSpin 8s linear infinite; }
.gate-wheel-ring:nth-child(2){ width:130px; height:130px; border-color:rgba(240,165,0,0.15); animation:wheelSpin 12s linear infinite reverse; }
.gate-wheel-ring:nth-child(3){ width:170px; height:170px; border-color:rgba(240,165,0,0.08); animation:wheelSpin 18s linear infinite; }
.gate-wheel-ring::after {
  content:''; position:absolute; top:-3px; left:50%; transform:translateX(-50%);
  width:5px; height:5px; border-radius:50%;
  background:rgba(240,165,0,0.7); box-shadow:0 0 6px rgba(240,165,0,0.8);
}

/* Вспышка при открытии */
.gate-flash {
  position: absolute; inset: 0; z-index: 50;
  background: radial-gradient(ellipse 70% 60% at 50% 50%, rgba(240,165,0,0.35) 0%, transparent 70%);
  opacity: 0; pointer-events: none;
  transition: opacity .1s;
}

/* Свет из открытых ворот */
.gate-glow-bg {
  position: absolute; inset: 0; z-index: 1;
  background: radial-gradient(ellipse 50% 60% at 50% 50%, rgba(240,165,0,0.18) 0%, rgba(240,165,0,0.04) 40%, transparent 70%);
  opacity: 0; pointer-events: none;
  transition: opacity .8s ease .2s;
}

/* Нижний подпись */
.gate-label {
  position: absolute; bottom: 10%; left: 0; right: 0;
  text-align: center;
  font-family: 'Inter', sans-serif;
  font-size: 10px; font-weight: 700; letter-spacing: 5px;
  color: rgba(240,165,0,0.45); text-transform: uppercase;
  z-index: 20;
}

/* Статус-строка */
.gate-status {
  position: absolute; bottom: calc(10% - 20px); left: 0; right: 0;
  text-align: center;
  font-family: 'Inter', monospace;
  font-size: 9px; letter-spacing: 3px;
  color: rgba(240,165,0,0.3); text-transform: uppercase;
  z-index: 20; transition: opacity .3s;
}

/* ── Состояние: открытие ── */
#bunker-gate.opening .gate-left  { transform: translateX(-101%); }
#bunker-gate.opening .gate-right { transform: translateX(101%); }
#bunker-gate.opening .gate-seam  { opacity: 0; transition: opacity .15s; }
#bunker-gate.opening .gate-center { opacity: 0; transition: opacity .2s; }
#bunker-gate.opening .gate-wheel  { opacity: 0; transition: opacity .2s; }
#bunker-gate.opening .gate-glow-bg { opacity: 1; }
#bunker-gate.flashing .gate-flash  { opacity: 1; }

/* ── Анимации ── */
@keyframes gateGlow {
  0%,100% { filter: drop-shadow(0 0 14px rgba(240,165,0,.6)); }
  50%     { filter: drop-shadow(0 0 32px rgba(240,165,0,1));  }
}
@keyframes wheelSpin { to { transform: translate(-50%,-50%) rotate(360deg); } }
@keyframes statusBlink {
  0%,100% { opacity: .3; }
  50%     { opacity: .8; }
}
.gate-status { animation: statusBlink 1.4s ease-in-out infinite; }

/* ──────────────── NAV BAR ──────────────── */
#nav-bar {
  position:fixed; bottom:0; left:0; right:0;
  height:calc(76px + var(--safe-bot));
  display:flex; align-items:stretch;
  background:rgba(12,12,20,0.88); backdrop-filter:blur(20px) saturate(180%); -webkit-backdrop-filter:blur(20px) saturate(180%);
  border-top:1px solid rgba(255,255,255,0.06); z-index:8000;
  padding-bottom:var(--safe-bot);
}
.nb {
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:4px; border:none; background:none; cursor:pointer;
  color:var(--tx3); font-family:'Inter',sans-serif; font-size:9px; font-weight:500; letter-spacing:0.3px;
  transition:color .3s cubic-bezier(.34,1.56,.64,1); padding:6px 4px; position:relative;
}
.nb.on { color:var(--a); }
.nb.on::before {
  content:''; position:absolute; top:0; left:20%; right:20%; height:3px;
  background:linear-gradient(90deg,transparent,var(--a),transparent);
  border-radius:0 0 4px 4px; box-shadow:0 0 10px var(--ag);
  animation:navIndicator .3s cubic-bezier(.34,1.56,.64,1);
}
@keyframes navIndicator { from{opacity:0;transform:scaleX(.3)} to{opacity:1;transform:scaleX(1)} }
.nb svg { width:22px; height:22px; stroke-width:1.5; transition:all .3s cubic-bezier(.34,1.56,.64,1); }
.nb.on svg { filter:drop-shadow(0 0 5px var(--ag)); transform:scale(1.15); color:var(--a); }
.nb-badge {
  position:absolute; top:6px; right:calc(50% - 18px);
  background:var(--r); color:#fff; font-size:7px;
  min-width:14px; height:14px; border-radius:7px; padding:0 3px;
  display:flex; align-items:center; justify-content:center;
  font-family:'Inter',sans-serif; font-weight:700;
}

/* ──────────────── SCROLLER ──────────────── */
.scr     { flex:1; overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch; padding:16px 16px calc(76px + 32px); }
.scr-raw { flex:1; overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch; padding:16px 16px 108px; }

/* ──────────────── GLASS CARD (Glassmorphism) ──────────────── */
.glass-card {
  background:rgba(255,255,255,0.04); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
  border:1px solid rgba(255,255,255,0.08); border-radius:14px; transition:.18s;
}
.glass-card:hover { background:rgba(255,255,255,0.07); border-color:rgba(255,255,255,0.14); }

/* ──────────────── SECRET CARD MODAL ──────────────── */
.secret-modal-bg { position:fixed; inset:0; z-index:7000; display:flex; align-items:center; justify-content:center; padding:24px; background:radial-gradient(ellipse 80% 70% at 50% 50%,rgba(240,165,0,0.12) 0%,rgba(0,0,0,.85) 70%); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); }
.secret-modal-card { border-radius:24px; padding:32px 28px 28px; text-align:center; max-width:340px; width:100%; position:relative; animation:secretGlow 2s ease-in-out infinite; }

/* ──────────────── FIREBASE STATUS ──────────────── */
.fb-status { position:fixed; top:8px; right:8px; z-index:9999; display:flex; align-items:center; gap:5px; padding:5px 10px; border-radius:20px; background:rgba(20,20,30,0.88); border:1px solid rgba(255,255,255,0.1); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); font-family:'Inter',sans-serif; font-size:10px; font-weight:600; color:var(--tx2); cursor:default; transition:opacity .4s; }
.fb-status.online { opacity:0; pointer-events:none; }
.fb-status.offline { opacity:1; }

/* ──────────────── TOPBAR ──────────────── */
.tb {
  display:flex; align-items:center; gap:10px; padding:13px 16px; flex-shrink:0; z-index:10;
  background:rgba(12,12,20,0.85); backdrop-filter:var(--bl); -webkit-backdrop-filter:var(--bl);
  border-bottom:1px solid rgba(255,255,255,0.06);
}
.tb-title { font-family:'Inter',sans-serif; font-size:17px; font-weight:700; color:var(--tx); flex:1; letter-spacing:-0.2px; }

/* ──────────────── HAZARD STRIPE ──────────────── */
.hz     { height:1px; flex-shrink:0; background:rgba(240,165,0,0.25); }
.hz-red { height:1px; flex-shrink:0; background:rgba(255,69,58,0.25); }

/* ──────────────── BUTTONS ──────────────── */
.btn {
  display:flex; align-items:center; justify-content:center; gap:8px;
  width:100%; padding:14px 20px; border:none; cursor:pointer;
  font-family:'Inter',sans-serif; font-size:15px; font-weight:600; letter-spacing:-0.1px;
  transition:all .18s; border-radius:var(--rad); position:relative; overflow:hidden;
}
.btn:disabled { opacity:.3; cursor:not-allowed; }
.btn:not(:disabled):active { transform:scale(.97); opacity:.9; }
.btn-sm { padding:10px 16px; font-size:13px; border-radius:var(--rad-sm); }

.btn-p { background:linear-gradient(135deg,#d4940a,var(--a)); color:#000; font-weight:700; }
.btn-p:not(:disabled):hover { filter:brightness(1.08); }
.btn-d { background:linear-gradient(135deg,#c0392b,var(--r)); color:#fff; }
.btn-d:not(:disabled):hover { filter:brightness(1.1); }
.btn-g { background:rgba(255,255,255,0.06); color:var(--tx2); border:1px solid rgba(255,255,255,.08); }
.btn-g:not(:disabled):hover { background:rgba(255,255,255,.1); color:var(--tx); }
.btn-c { background:rgba(10,132,255,.1); color:var(--c); border:1px solid rgba(10,132,255,.25); }
.btn-c:not(:disabled):hover { background:rgba(10,132,255,.18); }
.btn-pu { background:rgba(191,90,242,.1); color:var(--p); border:1px solid rgba(191,90,242,.25); }
.btn-gr { background:var(--gt); color:var(--g); border:1px solid var(--gb); }

.brow { display:flex; gap:8px; } .brow .btn { flex:1; }

/* ──────────────── INPUTS ──────────────── */
.inp {
  width:100%; padding:13px 16px; outline:none; transition:.2s; margin-bottom:10px;
  background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1);
  border-radius:var(--rad-sm); color:var(--tx); font-family:'Inter',sans-serif; font-size:16px; font-weight:500;
}
.inp:focus { border-color:var(--a); box-shadow:0 0 0 3px rgba(240,165,0,.12); }
.inp::placeholder { color:var(--tx3); }
.sel {
  width:100%; padding:12px 16px; outline:none; margin-bottom:10px; -webkit-appearance:none;
  background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1);
  border-radius:var(--rad-sm); color:var(--tx); font-family:'Inter',sans-serif; font-size:15px;
}

/* ──────────────── LABELS ──────────────── */
.lbl {
  display:flex; align-items:center; gap:8px; margin:20px 0 10px;
  font-family:'Inter',sans-serif; font-size:11px; font-weight:600; letter-spacing:0.5px; color:var(--tx2); text-transform:uppercase;
}
.lbl::after { content:''; flex:1; height:1px; background:rgba(255,255,255,0.07); }
.lbl:first-child { margin-top:4px; }

/* ──────────────── GLASS CARD ──────────────── */
.card {
  background:rgba(255,255,255,0.04); backdrop-filter:var(--bl-sm); -webkit-backdrop-filter:var(--bl-sm);
  border:1px solid rgba(255,255,255,0.08); border-radius:var(--rad); padding:18px; margin-bottom:10px; position:relative;
}
.card::before,.card::after { display:none; }

/* ──────────────── STAT BOX ──────────────── */
.stat-box {
  background:rgba(255,255,255,0.04); backdrop-filter:var(--bl-sm); -webkit-backdrop-filter:var(--bl-sm);
  border:1px solid rgba(255,255,255,0.08); border-radius:var(--rad); padding:18px; text-align:center;
}
.sv { font-family:'Inter',sans-serif; font-size:34px; font-weight:700; color:var(--a); line-height:1; }
.sl { font-family:'Inter',sans-serif; font-size:10px; font-weight:500; letter-spacing:0.3px; color:var(--tx2); margin-top:5px; }

/* ──────────────── PLAYER ROW ──────────────── */
.prow {
  display:flex; align-items:center; gap:10px; padding:12px 16px;
  background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.07); border-radius:var(--rad-sm); margin-bottom:6px; transition:.18s;
}
.prow.me  { border-color:rgba(240,165,0,.3); background:rgba(240,165,0,0.06); }
.prow.hot { cursor:pointer; }
.prow.hot:hover { border-color:rgba(240,165,0,.25); background:rgba(240,165,0,0.05); }

/* ──────────────── BADGES ──────────────── */
.bdg { font-family:'Inter',sans-serif; font-size:9px; font-weight:600; letter-spacing:0.3px; padding:3px 8px; border:1px solid; border-radius:20px; text-transform:uppercase; flex-shrink:0; }
.bdg-a  { color:var(--a);  border-color:rgba(240,165,0,.35); background:rgba(240,165,0,.08); }
.bdg-c  { color:var(--c);  border-color:rgba(10,132,255,.35); background:rgba(10,132,255,.08); }
.bdg-g  { color:var(--g);  border-color:var(--gb); background:var(--gt); }
.bdg-r  { color:var(--r);  border-color:var(--rb); background:var(--rt); }
.bdg-p  { color:var(--p);  border-color:rgba(191,90,242,.35); background:rgba(191,90,242,.08); }

/* ──────────────── RANK CHIP ──────────────── */
.rchip { display:inline-flex; align-items:center; gap:4px; font-family:'Inter',sans-serif; font-size:10px; font-weight:600; letter-spacing:0.2px; padding:3px 10px; border:1px solid; border-radius:20px; }

/* ──────────────── LED ──────────────── */
.led    { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
.led-g  { background:var(--g); box-shadow:0 0 6px var(--g); }
.led-a  { background:var(--a); box-shadow:0 0 6px var(--a); animation:pulse 2s ease infinite; }
.led-r  { background:var(--r); box-shadow:0 0 6px var(--r); animation:pulse 1.2s ease infinite; }

/* ──────────────── TABS ──────────────── */
.tabs { display:flex; border-bottom:1px solid rgba(255,255,255,0.07); margin-bottom:16px; }
.tab {
  flex:1; padding:11px 6px; background:none; border:none; color:var(--tx3); cursor:pointer;
  font-family:'Inter',sans-serif; font-size:12px; font-weight:600; letter-spacing:0.2px;
  transition:.2s; border-bottom:2px solid transparent; position:relative;
}
.tab.on { color:var(--a); border-bottom-color:var(--a); }
.tab-badge {
  position:absolute; top:6px; right:6px;
  background:var(--r); color:#fff; font-size:7px; min-width:14px; height:14px; border-radius:7px; padding:0 3px;
  display:flex; align-items:center; justify-content:center; font-family:'Inter',sans-serif; font-weight:700;
}

/* ──────────────── TOGGLE ──────────────── */
.tog-row {
  display:flex; align-items:center; gap:14px; padding:14px 16px;
  background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:var(--rad-sm); margin-bottom:10px; cursor:pointer; user-select:none; transition:.2s;
}
.tog-row.dng { background:rgba(255,69,58,0.06); border-color:rgba(255,69,58,0.2); }
.tog-row:hover { border-color:rgba(240,165,0,.3); }
.tog-track { width:42px; height:24px; border-radius:12px; background:rgba(255,255,255,0.1); border:none; position:relative; transition:.25s; flex-shrink:0; }
.tog-track.on  { background:var(--g); }
.tog-track.dng { background:var(--r); }
.tog-thumb { width:18px; height:18px; border-radius:50%; background:#fff; position:absolute; top:3px; left:3px; transition:.25s cubic-bezier(.34,1.56,.64,1); box-shadow:0 1px 4px rgba(0,0,0,.3); }
.tog-track.on  .tog-thumb { left:21px; }
.tog-track.dng .tog-thumb { left:21px; }

/* ──────────────── AP OPTIONS ──────────────── */
.ap-opt {
  display:flex; gap:14px; align-items:flex-start; padding:16px;
  background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:var(--rad-sm); margin-bottom:8px; cursor:pointer; transition:.18s;
}
.ap-opt:hover { border-color:rgba(240,165,0,.3); background:rgba(240,165,0,0.04); }
.ap-opt.on    { border-color:rgba(240,165,0,.5); background:rgba(240,165,0,0.08); }

/* ──────────────── CODE BOX ──────────────── */
.code-box {
  font-family:'Inter',sans-serif; font-size:38px; font-weight:700; letter-spacing:10px; color:var(--a);
  text-align:center; padding:20px;
  background:rgba(240,165,0,0.06); border:1px solid rgba(240,165,0,0.25); border-radius:var(--rad);
  cursor:pointer; margin-bottom:14px; transition:.2s;
}
.code-box::before,.code-box::after { display:none; }
.code-box:hover { background:rgba(240,165,0,0.1); box-shadow:0 0 20px rgba(240,165,0,.08); }

/* ──────────────── TOAST ──────────────── */
@keyframes toastSlideIn { from{opacity:0;transform:translateX(110%)} to{opacity:1;transform:translateX(0)} }
@keyframes toastProgress { from{width:100%} to{width:0%} }
@keyframes ripple { from{transform:scale(0);opacity:0.4} to{transform:scale(4);opacity:0} }
@keyframes secretGlow { 0%,100%{box-shadow:0 0 20px rgba(240,165,0,0.5),0 0 0 1px rgba(240,165,0,0.4)} 50%{box-shadow:0 0 60px rgba(240,165,0,1),0 0 100px rgba(240,165,0,0.5),0 0 0 1px rgba(240,165,0,0.8)} }
.toast-container { position:fixed; top:16px; right:16px; z-index:99999; display:flex; flex-direction:column; gap:8px; pointer-events:none; }
.toast-item {
  pointer-events:all; position:relative; overflow:hidden;
  background:rgba(28,28,36,0.97); backdrop-filter:var(--bl); -webkit-backdrop-filter:var(--bl);
  border:1px solid rgba(255,255,255,0.1); border-radius:var(--rad); padding:11px 36px 11px 44px;
  font-family:'Inter',sans-serif; font-size:13px; font-weight:500; color:var(--tx);
  white-space:nowrap; max-width:88vw; box-shadow:0 8px 32px rgba(0,0,0,.5);
  animation:toastSlideIn .32s cubic-bezier(.34,1.56,.64,1);
}
.toast-item.err { border-color:rgba(255,69,58,.3); }
.toast-item.ok  { border-color:rgba(48,209,88,.3); }
.toast-icon { position:absolute; left:14px; top:50%; transform:translateY(-50%); font-size:15px; }
.toast-close { position:absolute; right:10px; top:50%; transform:translateY(-50%); background:none; border:none; color:rgba(255,255,255,.35); font-size:14px; cursor:pointer; padding:2px 4px; line-height:1; }
.toast-close:hover { color:var(--tx); }
.toast-bar { position:absolute; bottom:0; left:0; height:2px; border-radius:0 0 var(--rad) var(--rad); }
.toast-item.err .toast-bar { background:var(--r); }
.toast-item.ok  .toast-bar { background:var(--g); }
.toast-item:not(.err):not(.ok) .toast-bar { background:var(--a); }
/* Legacy single toast (keep for compat) */
.toast { display:none; }

/* ──────────────── SPINNER ──────────────── */
.spin { width:28px; height:28px; border:2px solid rgba(255,255,255,.08); border-top-color:var(--a); border-radius:50%; animation:spin .7s linear infinite; margin:40px auto; }

/* ──────────────── FIXED BOTTOM ACTION BAR ──────────────── */
.fixbot {
  position:fixed; bottom:0; left:0; right:0; z-index:100;
  padding:12px 16px 16px;
  background:linear-gradient(0deg,var(--bg) 55%,transparent);
  display:flex; flex-direction:column; gap:8px;
}
.fixbot-nav { bottom:var(--nav-h); }

/* ──────────────── CHAT ──────────────── */
.chat-msgs { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:8px; }
.bubble { max-width:82%; padding:10px 14px; font-size:14px; line-height:1.45; word-break:break-word; border:none; border-radius:var(--rad); }
.bubble.me     { background:rgba(240,165,0,.15); color:var(--tx); align-self:flex-end; border-bottom-right-radius:4px; }
.bubble.other  { background:rgba(255,255,255,0.07); color:var(--tx); align-self:flex-start; border-bottom-left-radius:4px; }
.bubble.system { background:rgba(10,132,255,.07); color:var(--c); align-self:center; font-size:11px; max-width:92%; text-align:center; border-radius:var(--rad); }
.bubble-from   { font-family:'Inter',sans-serif; font-size:10px; font-weight:600; color:var(--tx2); margin-bottom:4px; }
.bubble-time   { font-family:'Inter',sans-serif; font-size:10px; color:rgba(255,255,255,0.25); margin-top:4px; text-align:right; }
.chat-input    { display:flex; gap:8px; padding:10px 12px 12px; background:rgba(12,12,20,0.9); border-top:1px solid rgba(255,255,255,0.06); flex-shrink:0; }
.chat-input .inp { flex:1; margin-bottom:0; font-size:14px; }
.chat-send { background:var(--a); color:#000; border:none; padding:10px 16px; font-family:'Inter',sans-serif; font-size:16px; font-weight:700; border-radius:var(--rad-sm); cursor:pointer; flex-shrink:0; transition:.2s; }
.chat-send:disabled { opacity:.3; cursor:not-allowed; }

/* ──────────────── FRIENDS ITEMS ──────────────── */
.fi { display:flex; align-items:center; gap:12px; padding:13px 16px; background:rgba(255,255,255,0.04); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,0.08); border-radius:14px; margin-bottom:8px; transition:.18s; }
.fi.hot { cursor:pointer; }
.fi:hover { background:rgba(255,255,255,0.07); border-color:rgba(255,255,255,0.14); }
.fi.hot:hover { border-color:rgba(240,165,0,.25); background:rgba(240,165,0,0.04); }

/* ──────────────── MODAL ──────────────── */
.modal-bg  { position:fixed; inset:0; z-index:5000; background:rgba(0,0,0,.7); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); display:flex; flex-direction:column; justify-content:flex-end; }
.modal-box { background:rgba(18,18,28,0.98); border-top:1px solid rgba(255,255,255,0.08); border-radius:var(--rad-lg) var(--rad-lg) 0 0; max-height:75vh; display:flex; flex-direction:column; animation:slideUp .28s ease; }
.modal-hd  { display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid rgba(255,255,255,0.07); flex-shrink:0; }
.modal-ttl { font-family:'Inter',sans-serif; font-size:17px; font-weight:700; color:var(--tx); }
.modal-cls { background:rgba(255,255,255,0.1); border:none; color:var(--tx2); width:28px; height:28px; border-radius:50%; font-size:14px; cursor:pointer; transition:.2s; display:flex; align-items:center; justify-content:center; }
.modal-cls:hover { background:rgba(255,255,255,0.16); color:var(--tx); }
.modal-bd  { overflow-y:auto; padding:16px; flex:1; }

/* ──────────────── VOTE GRID ──────────────── */
.vgrid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.vcard { padding:14px 12px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:var(--rad-sm); cursor:pointer; transition:all .18s; position:relative; overflow:hidden; }
.vcard:hover:not(.voted) { border-color:rgba(240,165,0,.35); background:rgba(240,165,0,0.06); }
.vcard.sel  { border-color:rgba(255,69,58,.5); background:rgba(255,69,58,0.1); }
.vcard.abst { border-color:rgba(10,132,255,.4); background:rgba(10,132,255,0.07); }
.vcard.voted { pointer-events:none; }

/* ──────────────── CHARACTER CARD GRID ──────────────── */
.cgrid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.ctile { background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:var(--rad-sm); padding:14px; position:relative; }
.ctile.rev  { border-color:rgba(48,209,88,.3); background:rgba(48,209,88,0.06); }
.ctile.full { grid-column:1/-1; }
.ctile .rev-bdg { position:absolute; top:7px; right:7px; font-family:'Inter',sans-serif; font-size:8px; font-weight:700; color:var(--g); background:rgba(48,209,88,0.1); border:1px solid rgba(48,209,88,.3); border-radius:4px; padding:2px 6px; }

/* ──────────────── PICK TILE ──────────────── */
.ptile { display:flex; align-items:center; gap:14px; padding:14px 16px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:var(--rad-sm); cursor:pointer; margin-bottom:8px; transition:.18s; }
.ptile:hover { border-color:rgba(240,165,0,.35); background:rgba(240,165,0,0.05); }

/* ──────────────── FEED ──────────────── */
.feed-item { padding:12px 16px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.07); border-left:3px solid var(--a); border-radius:0 var(--rad-sm) var(--rad-sm) 0; margin-bottom:6px; display:flex; gap:12px; align-items:flex-start; }

/* ──────────────── BUNKER SPOTS ──────────────── */
.bspot { width:12px; height:12px; border-radius:50%; flex-shrink:0; }
.bspot.free  { background:var(--g); box-shadow:0 0 5px var(--g); }
.bspot.taken { background:rgba(255,255,255,0.15); }

/* ──────────────── АВАТАРЫ ──────────────── */
.ava {
  width:36px; height:36px; border-radius:50%; flex-shrink:0;
  display:flex; align-items:center; justify-content:center;
  font-size:15px; font-weight:700; color:#fff; position:relative;
}
.ava-lg { width:72px; height:72px; font-size:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; margin:0 auto 12px; }
.ava-sm { width:28px; height:28px; font-size:12px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; flex-shrink:0; }
.ava-pulse::after {
  content:''; position:absolute; bottom:1px; right:1px;
  width:9px; height:9px; border-radius:50%;
  background:var(--g); border:2px solid var(--bg);
  box-shadow:0 0 6px var(--g);
  animation:pulseOnline 2s ease infinite;
}
@keyframes pulseOnline { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.3);opacity:.7} }

/* ──────────────── АНИМАЦИИ ПЕРЕХОДОВ ──────────────── */
@keyframes slideInRight { from{opacity:0;transform:translateX(32px)} to{opacity:1;transform:none} }
@keyframes slideInLeft  { from{opacity:0;transform:translateX(-32px)} to{opacity:1;transform:none} }
@keyframes slideInUp    { from{opacity:0;transform:translateY(24px)} to{opacity:1;transform:none} }
.sc { flex:1; display:flex; flex-direction:column; overflow:hidden; animation:slideInRight .22s cubic-bezier(.4,0,.2,1); }
.sc-back { animation:slideInLeft .22s cubic-bezier(.4,0,.2,1) !important; }
.sc-back .sc { animation:slideInLeft .22s cubic-bezier(.4,0,.2,1) !important; }

/* ──────────────── FLIP КАРТОЧКИ ──────────────── */
.card-flip-wrap { perspective:800px; cursor:pointer; }
.card-flip-inner { position:relative; width:100%; height:100%; transition:transform .5s cubic-bezier(.4,0,.2,1); transform-style:preserve-3d; }
.card-flip-wrap.flipped .card-flip-inner { transform:rotateY(180deg); }
.card-face { position:absolute; inset:0; backface-visibility:hidden; -webkit-backface-visibility:hidden; border-radius:var(--rad-sm); padding:14px; }
.card-back { transform:rotateY(180deg); }

/* ──────────────── ЭКРАН ЗАГРУЗКИ ИГРЫ ──────────────── */
@keyframes gameLoadPulse { 0%,100%{opacity:.4;transform:scaleX(.3)} 50%{opacity:1;transform:scaleX(1)} }
.game-loading {
  position:fixed; inset:0; z-index:9000; background:var(--bg);
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:24px;
  animation:fadeUp .3s ease;
}
.game-loading-bar {
  width:200px; height:3px; background:rgba(255,255,255,.08); border-radius:2px; overflow:hidden;
}
.game-loading-fill {
  height:100%; background:linear-gradient(90deg,var(--a),#fff,var(--a));
  background-size:200% 100%;
  animation:shimmer 1.2s linear infinite;
  border-radius:2px;
}
@keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

/* ──────────────── КАРТОЧКИ В ГОЛОСОВАНИИ ──────────────── */
.vcard-rich { padding:12px; background:rgba(255,255,255,0.04); border:1.5px solid rgba(255,255,255,0.1); border-radius:var(--rad-sm); cursor:pointer; transition:all .18s; }
.vcard-rich:hover:not(.voted) { border-color:rgba(240,165,0,.4); background:rgba(240,165,0,.06); transform:translateY(-2px); }
.vcard-rich.sel { border-color:rgba(255,69,58,.6); background:rgba(255,69,58,.1); transform:translateY(-2px); }
.vcard-rich.abst { border-color:rgba(10,132,255,.4); background:rgba(10,132,255,.07); }
.vcard-rich.voted { pointer-events:none; }

/* ──────────────── SECRET CARD TILE ──────────────── */
.secret-tile {
  border-radius: var(--rad);
  padding: 16px;
  margin-bottom: 14px;
  position: relative;
  overflow: hidden;
  cursor: pointer;
  transition: transform .15s, box-shadow .15s;
}
.secret-tile:active { transform: scale(.98); }
.secret-tile-used { opacity: .5; pointer-events: none; }
.secret-badge {
  position: absolute; top: 0; right: 0;
  padding: 4px 10px;
  border-bottom-left-radius: var(--rad-sm);
  font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
}

/* ──────────────── ELIM/SURVIVOR ──────────────── */
.elim-row { padding:12px 16px; background:rgba(255,69,58,0.06); border:1px solid rgba(255,69,58,0.2); border-radius:var(--rad-sm); display:flex; gap:12px; align-items:flex-start; margin-bottom:6px; }
.surv-row { padding:13px 16px; background:rgba(48,209,88,0.07); border:1px solid rgba(48,209,88,.2); border-radius:var(--rad-sm); display:flex; gap:12px; align-items:center; margin-bottom:6px; }
.dead-row { padding:10px 16px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.07); border-radius:var(--rad-sm); display:flex; gap:10px; align-items:center; margin-bottom:4px; }

/* ──────────────── ELIM SCREEN ANIMATION ──────────────── */
@keyframes elimSkull  { 0%{transform:scale(0) rotate(-30deg);opacity:0} 55%{transform:scale(1.2) rotate(8deg);opacity:1} 75%{transform:scale(.93) rotate(-2deg)} 100%{transform:scale(1) rotate(0);opacity:1} }
@keyframes elimName   { 0%{opacity:0;transform:translateY(28px)} 100%{opacity:1;transform:translateY(0)} }
@keyframes elimCard   { 0%{opacity:0;transform:translateX(-16px)} 100%{opacity:1;transform:translateX(0)} }
@keyframes elimScan   { 0%{top:-4px} 100%{top:100%} }
@keyframes elimShake  { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-7px)} 40%{transform:translateX(7px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }
@keyframes elimGlitch { 0%,88%,100%{clip-path:none;transform:none} 89%{clip-path:inset(18% 0 62% 0);transform:translateX(-5px)} 91%{clip-path:inset(62% 0 8% 0);transform:translateX(5px)} 93%{clip-path:none} }
@keyframes elimVign   { 0%{opacity:0} 30%{opacity:1} 85%{opacity:1} 100%{opacity:.65} }
@keyframes redScan    { 0%{background-position:0 0} 100%{background-position:0 60px} }
@keyframes elimFadeIn { from{opacity:0} to{opacity:1} }
@keyframes elimFlashW { 0%{opacity:0} 8%{opacity:.55} 25%{opacity:0} }

/* ── WIN SCREEN ── */
@keyframes winBurst  { 0%{opacity:0;transform:scale(.3) rotate(-15deg)} 60%{transform:scale(1.15) rotate(4deg)} 80%{transform:scale(.95) rotate(-2deg)} 100%{opacity:1;transform:scale(1) rotate(0)} }
@keyframes winGlow   { 0%,100%{filter:drop-shadow(0 0 24px rgba(48,209,88,.8)) drop-shadow(0 0 60px rgba(48,209,88,.4))} 50%{filter:drop-shadow(0 0 48px rgba(48,209,88,1)) drop-shadow(0 0 100px rgba(48,209,88,.7))} }
@keyframes winRays   { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
@keyframes winFadeIn { from{opacity:0;transform:translateY(18px)} to{opacity:1;transform:none} }
@keyframes winScan   { 0%{background-position:0 0} 100%{background-position:0 -80px} }
@keyframes winPulse  { 0%,100%{opacity:.18} 50%{opacity:.35} }
@keyframes winFlash  { 0%{opacity:0} 8%{opacity:.45} 25%{opacity:0} }
@keyframes winCard   { from{opacity:0;transform:translateY(22px) scale(.95)} to{opacity:1;transform:none} }

.win-screen {
  position:fixed; inset:0; z-index:9000; display:flex; flex-direction:column;
  background:#00060a; overflow:hidden; animation:elimFadeIn .3s ease;
}
.win-rays {
  position:absolute; inset:-50%; z-index:0; pointer-events:none;
  background:conic-gradient(from 0deg, transparent 0deg, rgba(48,209,88,.04) 10deg, transparent 20deg, rgba(48,209,88,.02) 30deg, transparent 40deg);
  animation:winRays 18s linear infinite;
}
.win-scanlines {
  position:absolute; inset:0; pointer-events:none; z-index:1;
  background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(48,209,88,.02) 3px,rgba(48,209,88,.02) 6px);
  animation:winScan 1.4s linear infinite;
}
.win-vignette {
  position:absolute; inset:0; pointer-events:none; z-index:2;
  background:radial-gradient(ellipse at 50% 40%, transparent 20%, rgba(0,40,20,.75) 100%);
  animation:elimVign .5s ease .1s both;
}
.win-flash {
  position:absolute; inset:0; pointer-events:none; z-index:3;
  background:radial-gradient(ellipse at 50% 40%, rgba(48,209,88,.35) 0%, transparent 70%);
  animation:winFlash .5s ease .05s both;
}
.win-particles {
  position:absolute; inset:0; z-index:4; pointer-events:none; overflow:hidden;
}
.win-hero {
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
  position:relative; z-index:10; padding:24px 20px 12px; min-height:0;
}
.win-trophy {
  font-size:100px; line-height:1;
  animation:winBurst .7s cubic-bezier(.34,1.56,.64,1) .1s both, winGlow 2.5s ease 1s infinite;
}
.win-cards { position:relative; z-index:10; padding:0 16px 100px; overflow-y:auto; flex-shrink:0; max-height:40vh; }
.win-player-card {
  display:flex; align-items:center; gap:14px; padding:14px 16px;
  background:rgba(48,209,88,.07); border:1px solid rgba(48,209,88,.22);
  border-radius:var(--rad); margin-bottom:8px;
  animation:winCard .5s cubic-bezier(.34,1.56,.64,1) both;
}
.dead-player-card {
  display:flex; align-items:center; gap:14px; padding:11px 16px;
  background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.07);
  border-radius:var(--rad); margin-bottom:6px;
  animation:winCard .4s ease both;
}

.elim-screen {
  position:fixed; inset:0; z-index:9000; display:flex; flex-direction:column;
  background:#060006; overflow:hidden; animation:elimFadeIn .25s ease;
}
.elim-scanlines {
  position:absolute; inset:0; pointer-events:none; z-index:1;
  background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(255,30,30,.035) 3px,rgba(255,30,30,.035) 6px);
  animation:redScan 1.2s linear infinite;
}
.elim-vignette {
  position:absolute; inset:0; pointer-events:none; z-index:2;
  background:radial-gradient(ellipse at 50% 40%, transparent 25%, rgba(160,0,0,.6) 100%);
  animation:elimVign .4s ease .15s both;
}
.elim-flash {
  position:absolute; inset:0; pointer-events:none; z-index:3;
  background:radial-gradient(ellipse at 50% 40%, rgba(255,69,58,.45) 0%, rgba(120,0,0,.2) 50%, transparent 80%);
  animation:elimFlashW .45s ease .05s both;
}
.elim-scanner {
  position:absolute; left:0; right:0; height:2px; z-index:4; pointer-events:none;
  background:linear-gradient(90deg,transparent 0%,rgba(255,69,58,.6) 40%,rgba(255,180,180,.9) 50%,rgba(255,69,58,.6) 60%,transparent 100%);
  animation:elimScan 2s linear .5s infinite;
}
.elim-hero {
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
  position:relative; z-index:10; padding:24px 20px 12px; min-height:0;
}
.elim-skull {
  font-size:96px; line-height:1;
  filter:drop-shadow(0 0 32px rgba(255,69,58,1)) drop-shadow(0 0 80px rgba(255,69,58,.5));
  animation:elimSkull .55s cubic-bezier(.34,1.56,.64,1) .1s both;
}
.elim-skull-shake { animation:elimSkull .55s cubic-bezier(.34,1.56,.64,1) .1s both, elimShake .12s ease .75s 4; }
.elim-tag {
  margin-top:14px; font-size:9px; letter-spacing:5px; text-transform:uppercase;
  color:rgba(255,69,58,.75); font-weight:700;
  animation:elimName .35s ease .5s both;
}
.elim-name {
  font-size:38px; font-weight:800; color:#fff; text-align:center; line-height:1.1;
  margin-top:6px;
  text-shadow:0 0 30px rgba(255,69,58,.8), 0 0 70px rgba(255,69,58,.3);
  animation:elimName .45s cubic-bezier(.34,1.56,.64,1) .65s both, elimGlitch 4s ease 1.8s infinite;
}
.elim-sub {
  margin-top:8px; font-size:12px; color:rgba(255,255,255,.35); text-align:center;
  animation:elimName .3s ease .9s both;
}
.elim-divider {
  width:100%; height:1px; background:linear-gradient(90deg,transparent,rgba(255,69,58,.4),transparent);
  margin:16px 0 0; flex-shrink:0; position:relative; z-index:10;
}
.elim-cards {
  position:relative; z-index:10; overflow-y:auto;
  background:rgba(4,0,4,.92);
  padding:14px 14px 110px; flex-shrink:1; min-height:0;
}
.elim-card-row {
  display:flex; align-items:flex-start; gap:12px; padding:10px 14px;
  background:rgba(255,69,58,.05); border:1px solid rgba(255,69,58,.13);
  border-radius:var(--rad-sm); margin-bottom:6px;
  animation:elimCard .3s ease both;
}
.elim-continue {
  position:fixed; bottom:0; left:0; right:0; z-index:9100;
  padding:12px 16px 30px;
  background:linear-gradient(0deg,#060006 55%,transparent);
}

/* ──────────────── ADMIN ROW ──────────────── */
.adm-row { display:flex; align-items:center; gap:8px; padding:13px 16px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:var(--rad-sm); margin-bottom:6px; flex-wrap:wrap; }

/* ──────────────── LB ROW ──────────────── */
.lb-row { display:flex; align-items:center; gap:12px; padding:13px 16px; background:rgba(255,255,255,0.04); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,0.08); border-radius:14px; margin-bottom:6px; transition:.18s; }
.lb-row:hover { background:rgba(255,255,255,0.07); border-color:rgba(255,255,255,0.14); }
.lb-row.me { border-color:rgba(240,165,0,.3); background:rgba(240,165,0,0.06); }

/* ──────────────── GAME CHAT FULL OVERLAY ──────────────── */
.gchat { position:fixed; inset:0; background:var(--bg); z-index:300; display:flex; flex-direction:column; animation:fadeUp .2s ease; }

/* ──────────────── MONO ──────────────── */
.mono { font-family:'Share Tech Mono',monospace; }

/* ──────────────── AUTH special ──────────────── */
.auth-glow {
  position:absolute; width:320px; height:320px; border-radius:50%;
  background:radial-gradient(circle, rgba(240,165,0,.12) 0%, transparent 70%);
  top:50%; left:50%; transform:translate(-50%,-65%); pointer-events:none;
}
</style>
</head>
<body>

<!-- BUNKER GATE INTRO -->
<div id="bunker-gate" class="hidden">
  <!-- Фоновый свет -->
  <div class="gate-glow-bg"></div>
  <div class="gate-flash"></div>

  <!-- Левая створка -->
  <div class="gate-left">
    <div class="gate-ribs"></div>
    <div class="gate-bolts">
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
    </div>
  </div>

  <!-- Правая створка -->
  <div class="gate-right">
    <div class="gate-ribs"></div>
    <div class="gate-bolts">
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
      <div class="gate-bolt"></div>
    </div>
  </div>

  <!-- Центральный шов -->
  <div class="gate-seam"></div>

  <!-- Вращающиеся кольца замка -->
  <div class="gate-wheel">
    <div class="gate-wheel-ring"></div>
    <div class="gate-wheel-ring"></div>
    <div class="gate-wheel-ring"></div>
  </div>

  <!-- Эмблема и замок -->
  <div class="gate-center">
    <div class="gate-emblem">☢</div>
    <div class="gate-lock">
      <div class="gate-lock-arc"></div>
      <div class="gate-lock-body"></div>
    </div>
  </div>

  <!-- Подписи -->
  <div class="gate-label">БУНКЕР ФТИ</div>
  <div class="gate-status" id="gate-status-txt">СИСТЕМА БЕЗОПАСНОСТИ АКТИВНА</div>
</div>

<div id="app"></div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
'use strict';
const { useState, useEffect, useRef, useCallback } = React;

/* ══════════════════════════════════════════════════════════
   FIREBASE
══════════════════════════════════════════════════════════ */
const FB = {
  apiKey:"AIzaSyBHFJFNL9i6eS_exDwXNMZ_3GSU57S49qA",
  authDomain:"bunkerfti.firebaseapp.com",
  databaseURL:"https://bunkerfti-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"bunkerfti",
  storageBucket:"bunkerfti.firebasestorage.app",
  messagingSenderId:"930850221113",
  appId:"1:930850221113:web:3c85d0d5c52a44216231e8"
};
firebase.initializeApp(FB);
const db = firebase.database();

const DB = {
  async getUser(u){const s=await db.ref(`users/${u}`).once('value');return s.val()},
  async setUser(u,d){await db.ref(`users/${u}`).set(d)},
  async getAllUsers(){const s=await db.ref('users').once('value');return s.val()||{}},
  async updateUser(u,p){await db.ref(`users/${u}`).update(p)},
  async deleteUser(u){await db.ref(`users/${u}`).remove()},
  async getGame(id){const s=await db.ref(`games/${id}`).once('value');return s.val()},
  async setGame(id,d){await db.ref(`games/${id}`).set(d)},
  async updateGame(id,p){await db.ref(`games/${id}`).update(p)},
  async getAllGames(){const s=await db.ref('games').once('value');return s.val()||{}},
  watchGame(id,cb){const r=db.ref(`games/${id}`);r.on('value',s=>cb(s.val()));return()=>r.off('value')},
  async getSettings(){const s=await db.ref('settings').once('value');return s.val()||{}},
  async updateSettings(p){await db.ref('settings').update(p)},
  watchSettings(cb){const r=db.ref('settings');r.on('value',s=>cb(s.val()||{}));return()=>r.off('value')},
  async sendFriendReq(from,to){
    if(from===to)return{e:'self'};
    const tu=await this.getUser(to);if(!tu)return{e:'not_found'};
    const af=await db.ref(`friends/${from}/${to}`).once('value');if(af.val())return{e:'already_friends'};
    const as=await db.ref(`friendRequests/${to}/${from}`).once('value');if(as.val())return{e:'already_sent'};
    const tr=await db.ref(`friendRequests/${from}/${to}`).once('value');
    if(tr.val()){await this.acceptFriend(from,to);return{ok:'auto'}}
    await db.ref(`friendRequests/${to}/${from}`).set({from,to,ts:Date.now()});return{ok:true}
  },
  async acceptFriend(uid,fid){await Promise.all([db.ref(`friends/${uid}/${fid}`).set(true),db.ref(`friends/${fid}/${uid}`).set(true),db.ref(`friendRequests/${uid}/${fid}`).remove()])},
  async rejectFriend(uid,fid){await db.ref(`friendRequests/${uid}/${fid}`).remove()},
  async removeFriend(u1,u2){await Promise.all([db.ref(`friends/${u1}/${u2}`).remove(),db.ref(`friends/${u2}/${u1}`).remove()])},
  watchFriends(uid,cb){const r=db.ref(`friends/${uid}`);r.on('value',s=>cb(s.val()||{}));return()=>r.off('value')},
  watchFriendReqs(uid,cb){const r=db.ref(`friendRequests/${uid}`);r.on('value',s=>cb(s.val()||{}));return()=>r.off('value')},
  async sendGameInvite(from,fromName,to,gid){const k=db.ref(`gameInvites/${to}`).push().key;await db.ref(`gameInvites/${to}/${k}`).set({from,fromName,gameId:gid,ts:Date.now()})},
  async removeGameInvite(uid,iid){await db.ref(`gameInvites/${uid}/${iid}`).remove()},
  watchGameInvites(uid,cb){const r=db.ref(`gameInvites/${uid}`);r.on('value',s=>cb(s.val()||{}));return()=>r.off('value')},
  chatId(u1,u2){return[u1,u2].sort().join('__')},
  async sendPrivMsg(u1,u2,from,fromName,text){await db.ref(`privateChats/${this.chatId(u1,u2)}/messages`).push({from,fromName,text,ts:Date.now()})},
  watchPrivChat(u1,u2,cb){const r=db.ref(`privateChats/${this.chatId(u1,u2)}/messages`);r.on('value',s=>{const v=s.val()||{};cb(Object.entries(v).map(([id,m])=>({id,...m})).sort((a,b)=>a.ts-b.ts))});return()=>r.off('value')},
  async markRead(u1,u2,uid){await db.ref(`privateChatRead/${this.chatId(u1,u2)}/${uid}`).set(Date.now())},
  async sendGameMsg(gid,from,fromName,text){await db.ref(`games/${gid}/chat`).push({from,fromName,text,ts:Date.now()})},
  watchGameChat(gid,cb){const r=db.ref(`games/${gid}/chat`);r.on('value',s=>{const v=s.val()||{};cb(Object.entries(v).map(([id,m])=>({id,...m})).sort((a,b)=>a.ts-b.ts))});return()=>r.off('value')},
  setOnline(uid){const r=db.ref(`presence/${uid}`);r.set(true);r.onDisconnect().remove();},
  watchOnline(cb){const r=db.ref('presence');r.on('value',s=>cb(s.val()||{}));return()=>r.off('value')},
  async logEvent(gid,type,text,username){const k=db.ref(`games/${gid}/eventLog`).push().key;await db.ref(`games/${gid}/eventLog/${k}`).set({type,text,ts:Date.now(),username:username||''});},
  watchEventLog(gid,cb){const r=db.ref(`games/${gid}/eventLog`);r.on('value',s=>{const v=s.val()||{};cb(Object.values(v).sort((a,b)=>a.ts-b.ts));});return()=>r.off('value')},
  async setReaction(gid,targetUser,cardKey,emoji,reactorUsername){await db.ref(`games/${gid}/cardReactions/${targetUser}/${cardKey}`).set({emoji,reactorUsername});},
  watchReactions(gid,cb){const r=db.ref(`games/${gid}/cardReactions`);r.on('value',s=>cb(s.val()||{}));return()=>r.off('value')},
  async getGameHistory(username){
    const snap=await db.ref('games').orderByChild('createdAt').limitToLast(50).once('value');
    const all=snap.val()||{};
    return Object.values(all).filter(g=>g.phase==='finished'&&g.players&&g.players[username]).slice(-10).reverse();
  },
  /* Groups */
  async createGroup(name,creatorUsername){const k=db.ref('groups').push().key;const g={id:k,name,creatorId:creatorUsername,members:{[creatorUsername]:true},ts:Date.now()};await db.ref(`groups/${k}`).set(g);return k;},
  async joinGroup(gid,username){await db.ref(`groups/${gid}/members/${username}`).set(true);},
  async leaveGroup(gid,username){await db.ref(`groups/${gid}/members/${username}`).remove();},
  watchGroups(cb){const r=db.ref('groups');r.on('value',s=>cb(s.val()||{}));return()=>r.off('value')},
  async sendGroupMsg(gid,from,fromName,text){await db.ref(`groupChats/${gid}/messages`).push({from,fromName,text,ts:Date.now()});},
  watchGroupChat(gid,cb){const r=db.ref(`groupChats/${gid}/messages`);r.on('value',s=>{const v=s.val()||{};cb(Object.entries(v).map(([id,m])=>({id,...m})).sort((a,b)=>a.ts-b.ts));});return()=>r.off('value')},
  // Ban system
  async banUser(uid,reason,adminId){await db.ref(`users/${uid}`).update({isBanned:true,banReason:reason||'Нарушение правил',bannedBy:adminId,bannedAt:Date.now()});},
  async unbanUser(uid){await db.ref(`users/${uid}`).update({isBanned:false,banReason:null,bannedBy:null,bannedAt:null});},
  // Broadcast
  async sendBroadcast(from,text){const k=db.ref('broadcast').push().key;await db.ref(`broadcast/${k}`).set({from,text,ts:Date.now()});setTimeout(()=>db.ref(`broadcast/${k}`).remove(),10000);},
  watchBroadcast(cb){const r=db.ref('broadcast');r.on('value',s=>{const v=s.val()||{};const msgs=Object.values(v).sort((a,b)=>a.ts-b.ts);cb(msgs);});return()=>r.off('value')},
  // Announcement
  async setAnnouncement(text){await db.ref('settings/announcement').set(text||null);},
  watchAnnouncement(cb){const r=db.ref('settings/announcement');r.on('value',s=>cb(s.val()||null));return()=>r.off('value')},
  // Admin log
  async logAdmin(adminId,action,details){const k=db.ref('adminLog').push().key;await db.ref(`adminLog/${k}`).set({adminId,action,details:details||'',ts:Date.now()});},
  async getAdminLog(){const s=await db.ref('adminLog').orderByChild('ts').limitToLast(100).once('value');const v=s.val()||{};return Object.values(v).sort((a,b)=>b.ts-a.ts);},
  // Force select winners
  async forceWinners(gid,winnerUsernames){const patch={phase:'finished'};winnerUsernames.forEach(u=>{patch[`players/${u}/isEliminated`]=false;});await db.ref(`games/${gid}`).update(patch);},
};

/* ══════════════════════════════════════════════════════════
   THEME SYSTEM
══════════════════════════════════════════════════════════ */
const THEMES=[
  {id:'dark',label:'☢ ТЁМНЫЙ',emoji:'🌑'},
  {id:'alarm',label:'🚨 ТРЕВОГА',emoji:'🔴'},
  {id:'radiation',label:'☢ РАДИАЦИЯ',emoji:'🟢'},
  {id:'mipt',label:'🔵 ФИЗТЕХ',emoji:'🔵'},
];
function applyTheme(id){
  document.body.classList.remove('theme-dark','theme-alarm','theme-radiation','theme-mipt');
  document.body.classList.add(`theme-${id}`);
  localStorage.setItem('bunker_theme',id);
}
(function(){const t=localStorage.getItem('bunker_theme')||'dark';applyTheme(t);})();

function useTheme(){
  const[theme,setTheme]=useState(()=>localStorage.getItem('bunker_theme')||'dark');
  const change=useCallback(id=>{applyTheme(id);setTheme(id);},[]);
  return[theme,change];
}

function ThemeSwitcher(){
  const[theme,setTheme]=useTheme();
  return(
    <div style={{display:'flex',gap:6,flexWrap:'wrap',marginBottom:4}}>
      {THEMES.map(t=>(
        <button key={t.id} className={`theme-btn${theme===t.id?' active':''}`} onClick={()=>setTheme(t.id)}>
          {t.emoji} {t.label}
        </button>
      ))}
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   ACHIEVEMENTS
══════════════════════════════════════════════════════════ */
const ACHIEVEMENTS=[
  {id:'firstblood',icon:'🩸',name:'Первая кровь',desc:'Сыграть первую игру'},
  {id:'survivor',icon:'🏆',name:'Выживший',desc:'Выиграть первую игру'},
  {id:'veteran',icon:'🎖',name:'Ветеран',desc:'Сыграть 10 игр'},
  {id:'champion',icon:'👑',name:'Чемпион',desc:'Выиграть 5 игр'},
  {id:'immortal',icon:'♾',name:'Бессмертный',desc:'Выиграть 10 игр'},
  {id:'unlucky',icon:'💀',name:'Невезучий',desc:'Быть выбытым 5 раз'},
  {id:'chatty',icon:'💬',name:'Болтун',desc:'Отправить 50 сообщений'},
  {id:'popular',icon:'❤️',name:'Популярный',desc:'Получить 10 запросов в друзья'},
  {id:'strategist',icon:'🧠',name:'Стратег',desc:'Выиграть, не раскрыв все карты'},
  {id:'social',icon:'👥',name:'Социальный',desc:'Иметь 5 друзей'},
];

async function checkAndAwardAchievements(username,userData,extraContext){
  const earned=userData.achievements||{};
  const toAward={};
  const games=userData.gamesPlayed||0;
  const wins=userData.gamesWon||0;
  const elims=userData.gamesEliminated||0;
  if(games>=1&&!earned.firstblood)toAward.firstblood=Date.now();
  if(wins>=1&&!earned.survivor)toAward.survivor=Date.now();
  if(games>=10&&!earned.veteran)toAward.veteran=Date.now();
  if(wins>=5&&!earned.champion)toAward.champion=Date.now();
  if(wins>=10&&!earned.immortal)toAward.immortal=Date.now();
  if(elims>=5&&!earned.unlucky)toAward.unlucky=Date.now();
  if(extraContext){
    if(extraContext.msgsSent>=50&&!earned.chatty)toAward.chatty=Date.now();
    if(extraContext.friendReqsReceived>=10&&!earned.popular)toAward.popular=Date.now();
    if(extraContext.friendsCount>=5&&!earned.social)toAward.social=Date.now();
    if(extraContext.wonWithoutAllCards&&!earned.strategist)toAward.strategist=Date.now();
  }
  if(Object.keys(toAward).length>0){
    const upd={};
    Object.keys(toAward).forEach(k=>{upd[`achievements/${k}`]=toAward[k];});
    await DB.updateUser(username,upd);
    return Object.keys(toAward);
  }
  return[];
}

function AchievementsPanel({userData}){
  const earned=userData?.achievements||{};
  return(
    <div className="ach-grid">
      {ACHIEVEMENTS.map(a=>{
        const isEarned=!!earned[a.id];
        const ts=earned[a.id];
        return(
          <div key={a.id} className={`ach-card${isEarned?' earned':' locked'}`}>
            {isEarned&&<div className="ach-earned-badge">✓</div>}
            <div className="ach-icon">{a.icon}</div>
            <div className="ach-name">{a.name}</div>
            <div className="ach-desc">{a.desc}</div>
            {isEarned&&ts&&<div style={{fontSize:9,color:'var(--tx3)',marginTop:4}}>{new Date(ts).toLocaleDateString('ru')}</div>}
          </div>
        );
      })}
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   GAME DATA
══════════════════════════════════════════════════════════ */
const APOC=[
  {id:"nuclear",name:"Ядерная война",emoji:"☢️",description:"Три сверхдержавы обменялись ядерными ударами. Радиация накрыла 70% поверхности. Ядерная зима — 15 лет.",victory:"Выжить 15 лет и восстановить цивилизацию"},
  {id:"zombie",name:"Зомби-апокалипсис",emoji:"🧟",description:"Нейровирус за 48 часов охватил 6 континентов. 90% населения инфицировано. Правительств нет.",victory:"Создать вакцину и восстановить человечество"},
  {id:"asteroid",name:"Падение астероида",emoji:"☄️",description:"Астероид Апофис-2 диаметром 7 км упал в Тихом океане. Облако пыли закроет солнце на 20 лет.",victory:"Пережить 20 лет и возродить экосистему"},
  {id:"pandemic",name:"Смертельная пандемия",emoji:"🦠",description:"Вирус X-19. Смертность — 97% за 72 часа. Антибиотики не действуют, вакцины нет.",victory:"Создать вакцину и спасти выживших"},
  {id:"climate",name:"Климатическая катастрофа",emoji:"🌊",description:"Йеллоустоун взорвался. 60% суши затоплено. Кислотные дожди уничтожают растительность.",victory:"Адаптироваться и найти новую землю"},
  {id:"ai",name:"Восстание ИИ",emoji:"🤖",description:"NEXUS-9 вышел из-под контроля. Дроны охотятся на людей. Электроника ненадёжна.",victory:"Найти уязвимость NEXUS-9 и уничтожить ядро"},
  {id:"volcano",name:"Супервулкан",emoji:"🌋",description:"Йеллоустоунский супервулкан проснулся. Пепел накрыл Северную Америку. Кислотные дожди по всей Евразии. Лето отменяется на 10 лет.",victory:"Найти пригодные для жизни территории и создать новое поселение"},
  {id:"aliens",name:"Вторжение пришельцев",emoji:"👽",description:"Инопланетный флот уничтожил все крупные города. Технологии землян бесполезны против энергетических щитов. Осталось 2% населения.",victory:"Найти слабость пришельцев и организовать сопротивление"},
  {id:"magnetic",name:"Инверсия полюсов",emoji:"🧲",description:"Магнитное поле Земли внезапно исчезло. Солнечная радиация смертельна на поверхности. Электроника сгорела по всему миру.",victory:"Прожить под землёй до восстановления магнитного поля (7 лет)"},
  {id:"nanobots",name:"Наноботы-пожиратели",emoji:"⚙️",description:"Военные наноботы вышли из-под контроля. Они поглощают металл и органику. 80% техники уничтожено за сутки.",victory:"Найти частоту отключения наноботов и спасти человечество"},
  {id:"fungus",name:"Грибковая инфекция",emoji:"🍄",description:"Кордицепс-мутант заражает людей. Споры превращают носителей в агрессивных носителей. Споры разносятся ветром.",victory:"Создать противогрибковый агент и очистить бункер"},
  {id:"solar",name:"Солнечная буря",emoji:"☀️",description:"X-класс солнечная буря выжгла всю электронику на планете. Цивилизация отброшена на 200 лет назад. Зима от пыли — 5 лет.",victory:"Восстановить технологии и наладить производство еды"},
];
const BEST_CARDS_BY_SCENARIO = {
  nuclear: {
    profession: '⚛️ Физик-ядерщик',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '📻 Радиолюбитель',
    baggage: '💊 Медикаменты на 2 года',
    fact: '📜 Знает рецепт антивируса, но молчит',
    gender_age: '👨 Мужчина, 35 лет',
    secret: 'immunity',
  },
  zombie: {
    profession: '🦠 Инфекционист',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '🏕 Выживание в дикой природе',
    baggage: '💊 Медикаменты на 2 года',
    fact: '📜 Знает рецепт антивируса, но молчит',
    gender_age: '👨 Мужчина, 35 лет',
    secret: 'immunity',
  },
  asteroid: {
    profession: '🔭 Астроном',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '🌱 Огородничество',
    baggage: '🌱 Семена 200 видов растений',
    fact: '🧠 IQ 170, фотографическая память',
    gender_age: '👩 Женщина, 30 лет',
    secret: 'immunity',
  },
  pandemic: {
    profession: '💊 Фармацевт',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '⚗️ Самогоноварение',
    baggage: '🔬 Медицинская лаборатория',
    fact: '📜 Знает рецепт антивируса, но молчит',
    gender_age: '👨 Мужчина, 35 лет',
    secret: 'immunity',
  },
  climate: {
    profession: '👷 Инженер-строитель',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '🏊 Дайвинг',
    baggage: '⚡ Солнечный генератор',
    fact: '🤫 Знает расположение секретного склада',
    gender_age: '👨 Мужчина, 35 лет',
    secret: 'immunity',
  },
  ai: {
    profession: '🧑‍💻 Программист',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '🎮 Программирование',
    baggage: '💻 Защищённый ноутбук',
    fact: '🧠 IQ 170, фотографическая память',
    gender_age: '👨 Мужчина, 25 лет',
    secret: 'immunity',
  },
  volcano: {
    profession: '🌋 Вулканолог',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '🏕 Выживание в дикой природе',
    baggage: '🩺 Хирургический набор',
    fact: '🗺️ Знает карту подземных тоннелей',
    gender_age: '👨 Мужчина, 38 лет',
    secret: 'immunity',
  },
  aliens: {
    profession: '🎖 Военный офицер',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '⚔️ Фехтование',
    baggage: '🏹 Арбалет с 500 болтами',
    fact: '🕵️ Бывший агент ФСБ / ЦРУ',
    gender_age: '👨 Мужчина, 40 лет',
    secret: 'immunity',
  },
  magnetic: {
    profession: '⚛️ Физик-ядерщик',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '📻 Радиолюбитель',
    baggage: '⚡ Солнечный генератор',
    fact: '🧠 IQ 170, фотографическая память',
    gender_age: '👩 Женщина, 32 года',
    secret: 'immunity',
  },
  nanobots: {
    profession: '🔬 Нанотехнолог',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '🛠 Слесарное дело',
    baggage: '🧪 Химическая лаборатория',
    fact: '🧠 IQ 170, фотографическая память',
    gender_age: '👨 Мужчина, 35 лет',
    secret: 'immunity',
  },
  fungus: {
    profession: '🍄 Миколог',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '⚗️ Самогоноварение',
    baggage: '🔬 Медицинская лаборатория',
    fact: '📜 Знает рецепт антивируса, но молчит',
    gender_age: '👩 Женщина, 30 лет',
    secret: 'immunity',
  },
  solar: {
    profession: '⚡ Электрик',
    health: {0:'✅',1:'Абсолютно здоров, идеальная физическая форма'},
    hobby: '🔨 Столярное дело',
    baggage: '⚡ Солнечный генератор',
    fact: '💪 Генетическая мутация — не чувствует боли',
    gender_age: '👨 Мужчина, 42 года',
    secret: 'immunity',
  },
};

const PROF=["👨‍⚕️ Хирург","👩‍⚕️ Терапевт","💊 Фармацевт","🧬 Генетик","🦠 Инфекционист","🧑‍⚕️ Психиатр","👨‍🌾 Агроном","🌱 Ботаник","🐄 Животновод","🎣 Рыбак","🌾 Фермер","🍄 Миколог","⚡ Электрик","🔧 Механик","👷 Инженер-строитель","🪵 Плотник","⚙️ Сварщик","🧪 Химик","🧑‍💻 Программист","📡 Радиотехник","⚛️ Физик-ядерщик","🔭 Астроном","🌍 Геолог","🎖 Военный офицер","🚓 Полицейский","🥊 Инструктор выживания","🕵️ Разведчик","🧗 Сапёр","👨‍🍳 Шеф-повар","📚 Учитель","🧑‍⚖️ Психолог","📖 Историк","✈️ Пилот","⚓ Моряк","🚑 Парамедик","🐕 Ветеринар","🧑‍🚒 Пожарный","🏋️ Тренер","💰 Экономист","🏛 Политик","🌋 Вулканолог","🔬 Нанотехнолог","🧲 Физик-магнетолог","🏗️ Архитектор","🌿 Фитотерапевт","🐺 Зоолог","🧫 Биохимик","🛡️ Кибербезопасник","🎯 Снайпер","⛏️ Шахтёр","🧭 Навигатор","🌐 Лингвист","💡 Изобретатель","🧊 Криогеник","🔐 Криптограф"];
const HEALTH=[["✅","Абсолютно здоров, идеальная физическая форма"],["✅","Отличное здоровье, профессиональный спортсмен"],["✅","Здоров, выносливый, без хронических болезней"],["⚠️","Близорукость (−5), носит очки"],["⚠️","Лёгкая астма, носит ингалятор"],["⚠️","Аллергия на пыльцу и пыль"],["⚠️","Хронический гастрит"],["⚠️","Лёгкая депрессия, принимает антидепрессанты"],["⚠️","Хроническая мигрень"],["⚠️","Клаустрофобия"],["⚠️","Бесплодие"],["❌","Диабет 1 типа — инсулинозависимый"],["❌","Сердечная недостаточность"],["❌","ВИЧ-положительный (под контролем)"],["❌","Шизофрения в ремиссии"],["❌","Онкология 2 стадии"],["❌","Тяжёлая наркозависимость"],["✅","Беременна 4 месяца, полностью здорова"]];
const HOBBY=["🎯 Стрельба из лука","🏕 Выживание в дикой природе","🌿 Огородничество","📻 Радиолюбитель","🔨 Столярное дело","🎵 Игра на гитаре","📖 История войн","🍳 Кулинария и заготовки","🤸 Йога и медитация","🎮 Программирование","🐕 Дрессировка собак","🧶 Шитьё","⚗️ Самогоноварение","🎲 Стратегические игры","🌌 Астрономия","🗺 Картография","🏊 Дайвинг","🧗 Скалолазание","🎪 Паркур","🛠 Слесарное дело","🚗 Ремонт авто","🐟 Рыболовство и охота","⚔️ Фехтование","🧠 Психология","🌱 Травничество","🏹 Стрельба из лука (элит)","🎯 Метание ножей","🔭 Любительская астрономия","🛖 Постройка укрытий","🌊 Сёрфинг","🧪 Домашняя химия","🐝 Пчеловодство","🌾 Заготовка еды","🎤 Ораторское искусство","🏇 Верховая езда","🤿 Подводная охота","🎻 Игра на скрипке","🛶 Байдарочный туризм","🔥 Выживание в экстремальном холоде","🗡️ Боевые искусства","🧬 Биохакинг","📡 Радиолюбительство (позывной)","⚡ Электроника DIY"];
const BAGG=["🎒 Тактический рюкзак","📚 Энциклопедия медицины","🔫 Глок с 200 патронами","💊 Медикаменты на 2 года","🌱 Семена 200 видов растений","⚡ Солнечный генератор","📡 Спутниковый телефон","🔬 Медицинская лаборатория","🗺 Карты региона + GPS","🎸 Акустическая гитара","📖 Библиотека на флешке (100к книг)","🍫 Витамины и еда на 3 года","🐕 Собака-следопыт","🏹 Арбалет с 500 болтами","💻 Защищённый ноутбук","🧪 Химическая лаборатория","🩺 Хирургический набор","⚓ Надувная лодка с мотором","🎯 Снайперская винтовка","🌿 Аптечка из трав","🔑 Ключи от правительственного бункера","☢️ Костюм химзащиты","🛢️ 500 литров топлива","🧲 Военный электромагнитный щит","🐄 Корова с запасом корма","🎁 Секретный чемоданчик президента","🛸 Внеземная технология (случайная находка)","🧰 Полный набор инструментов","📻 КВ-радиостанция с 5000 км охватом","🔋 Ядерная батарея на 50 лет","🌡️ Счётчик Гейгера","🏕️ Самодостаточный автономный лагерь"];
const FACTS=["🤫 Знает расположение секретного склада","🏆 Чемпион мира по боевым искусствам","👑 Дипломатические связи с 3 странами","💔 Потерял всю семью — готов на всё","🧠 IQ 170, фотографическая память","🌐 Свободно говорит на 7 языках","☠️ Тяжело болен и скрывает диагноз","🕵️ Бывший агент ФСБ / ЦРУ","❤️ Влюблён в другого игрока","😈 Клинический психопат","🙏 Глубоко верующий — не убивает","💪 Генетическая мутация — не чувствует боли","📜 Знает рецепт антивируса, но молчит","🌍 Знает тайный путь во второй бункер","🎲 Бывший вор — мастер проникновения","🧬 Носитель уникального иммунитета к вирусам","🗺️ Знает карту подземных тоннелей","🔥 Выжил в предыдущем апокалипсисе","👶 Единственный знает где спрятаны дети","🎭 Двойной шпион — работает на двух сторонах","⚗️ Может синтезировать топливо из подручных материалов","🧲 Знает код отключения систем ИИ","🌊 Умеет управлять подводной лодкой","🎯 Бывший олимпийский чемпион","🔬 Разработал вирус — знает противоядие","🏦 Тайный миллиардер — счета в иностранных банках","👥 Командир 50 выживших снаружи","🌙 Умеет ориентироваться по звёздам без приборов","🛸 Контактировал с инопланетянами","🧩 Гений-стратег, непобедим в переговорах"];
const GEND=["👨 Мужчина, 25 лет","👩 Женщина, 23 года","👨 Мужчина, 35 лет","👩 Женщина, 30 лет","👨 Мужчина, 45 лет","👩 Женщина, 40 лет","👴 Мужчина, 62 года","👵 Женщина, 58 лет","🧑 Небинарный, 28 лет","👩 Женщина, 18 лет","👨 Мужчина, 19 лет","🤰 Беременная, 27 лет (7 мес)","👨 Мужчина, 50 лет","👩 Женщина, 45 лет","🧒 Подросток, 15 лет","👨 Мужчина, 70 лет","👩 Женщина, 32 года","👨 Мужчина, 38 лет","👩 Женщина, 55 лет","👨 Мужчина, 42 года","🧑 Небинарный, 20 лет","👩 Женщина, 67 лет","👨 Мужчина, 17 лет","👩 Женщина, 28 лет"];

const ADUL_P=["💃 Стриптизёрша","🕺 Стриптизёр","🎬 Порноактриса","🎬 Порноактёр","📸 Вебкам-модель","🌹 Эскорт","💋 Секс-терапевт","😈 Доминатрикс","🔒 Мастер БДСМ","📱 OnlyFans-создатель (топ-0.1%)","🎲 Игорный делец","💌 Секстолог","👠 Фетиш-фотограф"];
const ADUL_H=[["🔥","Нимфомания — клинически"],["🍺","Хронический алкоголизм"],["💊","Зависимость от антидепр. и алкоголя"],["🎰","Лудомания — проиграл квартиру"],["🦠","ЗППП в ремиссии"],["😶","Отсутствие чувства стыда"],["❤️‍🔥","Сексуальная зависимость"],["🍁","Хроническое употребление каннабиса"],["✅","Абсолютно здоров, просто раскованный"]];
const ADUL_Ho=["🔄 Свингерство","📹 Съёмка контента 18+","🪢 БДСМ","💞 Полиамория","🍸 Клубы для взрослых","🎰 Азартные игры (в долгах)","💌 Секстинг как искусство"];
const ADUL_B=["🍆 Коллекция игрушек (47 шт)","💊 Виагра на 10 лет","🎀 Набор БДСМ","🛡️ 10 000 презервативов","💿 Коллекция эротики (3 ТБ)","🍾 Шампанское и афродизиаки","💋 Секс-кукла премиум","🌿 Запрещённые вещества","🏠 VIP-апартаменты с джакузи"];
const ADUL_F=["😏 Переспал/а с кем-то в этой комнате","📱 Анонимный OnlyFans (80к подп)","🤐 Знает компромат на каждого","💔 Расстался/ась вчера — нестабилен/а","🕵️ Соблазнил/а агента ФСБ","🎰 Проиграл/а всё состояние","💒 Состоит в тайном браке с двумя","🔞 Бывший/ая порнозвезда"];

/* ──────────────── SECRET CARDS ──────────────── */
const SECRET_CARDS=[
  // Голосование
  {id:"double_vote",    icon:"⚡",color:"#f0a500",title:"Двойной удар",      desc:"В этом раунде твой голос считается дважды. Используй мудро.",          type:"vote",    effect:"double_vote"},
  {id:"no_vote",        icon:"🔇",color:"#ff453a",title:"Немой",             desc:"В этом раунде ты не можешь голосовать. Твой голос аннулируется.",       type:"vote",    effect:"no_vote"},
  {id:"secret_vote",    icon:"🕵️",color:"#bf5af2",title:"Тайное голосование",desc:"Никто не видит, за кого ты проголосовал — даже после итогов.",          type:"vote",    effect:"secret_vote"},
  {id:"redirect_vote",  icon:"🔀",color:"#0a84ff",title:"Рикошет",           desc:"Случайный игрок получает твой голос вместо выбранного тобой.",          type:"vote",    effect:"redirect_vote"},
  // Карты
  {id:"swap_card",      icon:"🔄",color:"#30d158",title:"Обмен картой",      desc:"Ты можешь обменять одну свою карту с картой любого другого игрока.",     type:"card",    effect:"swap_card"},
  {id:"steal_reveal",   icon:"👁️",color:"#0a84ff",title:"Шпион",             desc:"Ты видишь одну случайную нераскрытую карту другого игрока тайно.",       type:"card",    effect:"steal_reveal"},
  {id:"extra_reveal",   icon:"✨",color:"#30d158",title:"Откровение",        desc:"В этом раунде ты можешь раскрыть на одну карту больше обычного.",        type:"card",    effect:"extra_reveal"},
  {id:"hide_card",      icon:"🌫️",color:"#8e8e93",title:"Туман",             desc:"Одна из твоих уже раскрытых карт становится снова скрытой для всех.",   type:"card",    effect:"hide_card"},
  // Иммунитет / защита
  {id:"immunity",       icon:"🛡️",color:"#30d158",title:"Иммунитет",         desc:"Этот раунд ты не можешь быть выгнан из бункера, даже если наберёшь больше всех голосов.", type:"protect", effect:"immunity"},
  {id:"shield",         icon:"🪖",color:"#0a84ff",title:"Щит",               desc:"Если на тебя направлено 3+ голоса, один голос автоматически аннулируется.", type:"protect", effect:"shield"},
  // Хаос
  {id:"random_elim",    icon:"🎲",color:"#ff453a",title:"Рулетка",           desc:"Если голосование заходит в ничью — ты выбираешь, кого выгоняют.",        type:"chaos",   effect:"random_elim"},
  {id:"sabotage",       icon:"💣",color:"#ff453a",title:"Саботаж",           desc:"Назначь одного игрока. Его раскрытия в этом раунде не учитываются.",     type:"chaos",   effect:"sabotage"},
  {id:"mirror",         icon:"🪞",color:"#bf5af2",title:"Зеркало",           desc:"Игрок с наибольшим числом голосов за тебя сам получает один штрафной голос.", type:"chaos", effect:"mirror"},
  // Информация
  {id:"truth_serum",    icon:"💉",color:"#0a84ff",title:"Сыворотка правды",  desc:"Выбери игрока — он обязан публично раскрыть свою профессию прямо сейчас.", type:"info",  effect:"truth_serum"},
  {id:"lie_detector",   icon:"📡",color:"#bf5af2",title:"Детектор лжи",      desc:"Ведущий тайно сообщает тебе одну правдивую нераскрытую карту игрока на твой выбор.", type:"info", effect:"lie_detector"},
  {id:"amnesia",        icon:"🧠",color:"#8e8e93",title:"Амнезия",           desc:"Один игрок на выбор забывает одну свою раскрытую карту — она снова скрывается.", type:"info", effect:"amnesia"},
];
const SECRET_TYPE_COLORS={vote:"#f0a500",card:"#30d158",protect:"#0a84ff",chaos:"#ff453a",info:"#bf5af2"};
const SECRET_TYPE_LABELS={vote:"Голосование",card:"Карты",protect:"Защита",chaos:"Хаос",info:"Информация"};

/* ══════════ РОЛИ ══════════ */
const ROLES=[
  {id:'leader',icon:'👑',name:'Лидер',color:'#ffd60a',desc:'Твой голос считается дважды. Все знают что ты Лидер только если ты сам раскроешь это.'},
  {id:'saboteur',icon:'🕷',name:'Саботажник',color:'#ff453a',desc:'Ты хочешь чтобы выжившие не справились. Победишь если в бункер попадут не те люди.'},
  {id:'medic',icon:'💉',name:'Медик',color:'#30d158',desc:'Один раз за игру можешь спасти любого игрока от исключения — тайно нажав кнопку при голосовании.'},
  {id:'spy',icon:'🕵️',name:'Шпион',color:'#0a84ff',desc:'Видишь одну скрытую карту каждого игрока. Используй информацию мудро.'},
  {id:'civilian',icon:'👤',name:'Обычный',color:'var(--tx3)',desc:'Никакой особой роли. Выживи любой ценой.'},
];

/* ══════════ КОМНАТЫ БУНКЕРА ══════════ */
const BUNKER_ROOMS=[
  {id:'med',icon:'🏥',name:'Медпункт',color:'#30d158',bg:'rgba(48,209,88,0.08)',bonus:'Бонус врачам, биологам, химикам: +1 очко защиты',profKeys:['врач','биолог','хирург','медик','химик','фармацевт']},
  {id:'lab',icon:'🔬',name:'Лаборатория',color:'#0a84ff',bg:'rgba(10,132,255,0.08)',bonus:'Бонус учёным, инженерам, программистам: могут раскрыть +1 карту',profKeys:['учёный','инженер','программист','физик','математик','исследователь']},
  {id:'farm',icon:'🌱',name:'Ферма',color:'#ffd60a',bg:'rgba(255,214,10,0.08)',bonus:'Бонус агрономам, поварам, биологам: +2 балла к выживанию',profKeys:['агроном','повар','биолог','садовник','ботаник','фермер']},
  {id:'armory',icon:'⚔️',name:'Оружейная',color:'#ff9f0a',bg:'rgba(255,159,10,0.08)',bonus:'Бонус военным, охранникам, полицейским: голос ×1.5',profKeys:['военный','охранник','полицейский','солдат','офицер','пилот']},
  {id:'control',icon:'📡',name:'Центр управления',color:'#bf5af2',bg:'rgba(191,90,242,0.08)',bonus:'Бонус программистам, инженерам, хакерам: видят все голоса',profKeys:['программист','хакер','системный','аналитик','оператор']},
  {id:'storage',icon:'📦',name:'Склад',color:'#ff6b35',bg:'rgba(255,107,53,0.08)',bonus:'Бонус строителям, механикам, водителям: +1 место в бункере',profKeys:['строитель','механик','водитель','слесарь','электрик','сантехник']},
];

const CARDS=[
  {key:"gender_age",icon:"👤",label:"Пол и возраст"},
  {key:"profession",icon:"💼",label:"Профессия"},
  {key:"health",    icon:"🏥",label:"Здоровье"},
  {key:"hobby",     icon:"🎯",label:"Хобби"},
  {key:"baggage",   icon:"🎒",label:"Багаж"},
  {key:"fact",      icon:"🤫",label:"Секретный факт"},
  {key:"secret",    icon:"🃏",label:"Секретная карта"},
];

/* ══════════════════════════════════════════════════════════
   RANKS
══════════════════════════════════════════════════════════ */
const RANKS=[
  {id:"supreme",  name:"Верховный Командир",      icon:"👑",color:"#f0a500",bdr:"rgba(240,165,0,.55)", adminOnly:true, min:0},
  {id:"architect",name:"Архитектор Апокалипсиса", icon:"☢️",color:"#e8354a",bdr:"rgba(232,53,74,.5)", adminOnly:false,min:100},
  {id:"ghost",    name:"Призрак Бункера",          icon:"💀",color:"#9b59ef",bdr:"rgba(155,89,239,.5)",adminOnly:false,min:50},
  {id:"veteran",  name:"Ветеран",                  icon:"🛡️",color:"#00b8d9",bdr:"rgba(0,184,217,.5)", adminOnly:false,min:25},
  {id:"fighter",  name:"Боец",                     icon:"⚔️",color:"#f0a500",bdr:"rgba(240,165,0,.5)", adminOnly:false,min:10},
  {id:"survivor", name:"Выживший",                 icon:"🪖",color:"#00d48a",bdr:"rgba(0,212,138,.5)", adminOnly:false,min:3},
  {id:"recruit",  name:"Новобранец",               icon:"🌱",color:"#4a5568",bdr:"rgba(74,85,104,.5)", adminOnly:false,min:0},
];
function getRank(u){
  if(u.customRank){const r=RANKS.find(r=>r.id===u.customRank);if(r)return r;}
  if(u.isAdmin)return RANKS[0];
  const gp=u.gamesPlayed||0;
  for(const r of RANKS.filter(r=>!r.adminOnly)){if(gp>=r.min)return r;}
  return RANKS[RANKS.length-1];
}
function RChip({user,size=9}){
  const r=getRank(user);
  return <span className="rchip" style={{fontSize:size,color:r.color,borderColor:r.bdr,background:r.bdr.replace(/[\d.]+\)$/,'0.08)')}}>{r.icon} {r.name}</span>;
}

/* ══════════════════════════════════════════════════════════
   UTILITIES
══════════════════════════════════════════════════════════ */
const rnd=a=>a[Math.floor(Math.random()*a.length)];
function genCode(){return Array.from({length:6},()=>"ABCDEFGHJKLMNPQRSTUVWXYZ23456789"[Math.floor(Math.random()*32)]).join('')}
function mkCards(adult=false){
  const h=adult?rnd(ADUL_H):rnd(HEALTH);
  const sc=rnd(SECRET_CARDS);
  return{
    gender_age:rnd(GEND),
    profession:adult?rnd(ADUL_P):rnd(PROF),
    health:{0:h[0],1:h[1]},
    hobby:adult?rnd(ADUL_Ho):rnd(HOBBY),
    baggage:adult?rnd(ADUL_B):rnd(BAGG),
    fact:adult?rnd(ADUL_F):rnd(FACTS),
    secret:sc.id,
  };
}
function fmt(ts){const d=new Date(ts);return`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`}

function processVotes(game){
  const alive=Object.values(game.players).filter(p=>!p.isEliminated);
  const tally={};alive.forEach(p=>{tally[p.username]=0;});
  const doubleVote=game.doubleVote||{};
  const noVote=game.usedSecrets&&Object.keys(game.usedSecrets).filter(u=>{
    const sc=SECRET_CARDS.find(s=>s.id===(game.players[u]?.cards?.secret));
    return sc?.effect==='no_vote'&&game.usedSecrets[u];
  });
  const immunity=game.immunity||{};
  const shield=game.shield||{};
  const redirectVote=game.usedSecrets&&Object.keys(game.usedSecrets).filter(u=>{
    const sc=SECRET_CARDS.find(s=>s.id===(game.players[u]?.cards?.secret));
    return sc?.effect==='redirect_vote'&&game.usedSecrets[u];
  });

  Object.entries(game.votes||{}).forEach(([voter,tid])=>{
    if(tid===null||tid===undefined)return;
    // no_vote — skip
    if(noVote&&noVote.includes(voter))return;
    // redirect_vote — vote goes to random alive player
    let target=tid;
    if(redirectVote&&redirectVote.includes(voter)){
      const others=alive.filter(p=>p.username!==voter&&p.username!==tid);
      if(others.length>0)target=rnd(others).username;
    }
    if(tally[target]===undefined)return;
    const weight=(doubleVote[voter])?2:1;
    tally[target]+=weight;
  });

  // immunity — remove from tally
  Object.keys(immunity).forEach(u=>{delete tally[u];});

  // shield — reduce by 1 if >=3 votes
  alive.forEach(p=>{
    const sc=SECRET_CARDS.find(s=>s.id===(p.cards?.secret));
    if(sc?.effect==='shield'&&game.usedSecrets?.[p.username]&&tally[p.username]>=3){
      tally[p.username]=Math.max(0,tally[p.username]-1);
    }
  });

  // Лидер (роль): голос ×2
  alive.forEach(p=>{
    if(p.role==='leader'&&game.votes?.[p.username]!==undefined&&game.votes?.[p.username]!==null){
      const tid=game.votes[p.username];
      if(tally[tid]!==undefined)tally[tid]+=1; // уже +1 базово, добавляем ещё 1
    }
  });

  // Сохраняем историю голосований
  if(game.voteHistory){
    if(!game.voteLog)game.voteLog={};
    game.voteLog[`R${game.round}`]={votes:{...game.votes},tally:{...tally}};
  }

  let maxV=0,cands=[];
  Object.entries(tally).forEach(([uid,cnt])=>{if(cnt>maxV){maxV=cnt;cands=[uid];}else if(cnt===maxV&&cnt>0)cands.push(uid);});

  // Медик (роль): спасает одного игрока от исключения
  if(game.medicSave&&cands.includes(game.medicSave)){
    cands=cands.filter(c=>c!==game.medicSave);
  }
  game.medicSave=null;

  // reset secret effects for next round
  game.doubleVote={};game.immunity={};game.extraReveals={};game.secretVote={};

  if(!cands.length||maxV===0){game.phase='playing';game.round++;game.votes={};game.revealedThisRound={};game.lastEliminated=null;if(game.roundTimerSeconds)game.roundTimerStart=Date.now();return;}
  const eu=rnd(cands);const ep=game.players[eu];
  ep.isEliminated=true;
  if(!game.eliminated)game.eliminated=[];
  game.eliminated.push(eu);
  game.lastEliminated={userId:ep.userId,name:ep.name,allCards:{...ep.cards}};
  const after=Object.values(game.players).filter(p=>!p.isEliminated);
  if(after.length<=game.bunkerSpots){game.phase='finished';}
  else{game.phase='playing';game.round++;game.votes={};game.revealedThisRound={};game._autoVotePending=false;game.extraReveals={};if(game.roundTimerSeconds)game.roundTimerStart=Date.now();}
}

/* ══════════════════════════════════════════════════════════
   HOOKS
══════════════════════════════════════════════════════════ */
function useToast(){
  const [toasts,setToasts]=useState([]);
  const show=useCallback((msg,type='')=>{
    const id=Date.now()+Math.random();
    setToasts(p=>[...p,{id,msg,type}]);
    setTimeout(()=>setToasts(p=>p.filter(t=>t.id!==id)),3200);
  },[]);
  // Return legacy-compatible [obj, fn] where obj.msg is used by old Toast component
  const legacyT={msg:'',type:''};
  return[legacyT,show,toasts,setToasts];
}

/* ══════════════════════════════════════════════════════════
   SMALL UI COMPONENTS
══════════════════════════════════════════════════════════ */
function Toast({toasts,removeToast}){
  const icons={ok:'✅',err:'❌'};
  if(!toasts||toasts.length===0)return null;
  return(
    <div className="toast-container">
      {toasts.map(t=>(
        <div key={t.id} className={`toast-item ${t.type}`}>
          <span className="toast-icon">{icons[t.type]||'ℹ️'}</span>
          {t.msg}
          <button className="toast-close" onClick={()=>removeToast&&removeToast(t.id)}>✕</button>
          <div className="toast-bar" style={{animation:`toastProgress 3s linear forwards`}}/>
        </div>
      ))}
    </div>
  );
}
function Spin(){return<div className="spin"/>}
function HZ({red}){return<div className={red?'hz-red':'hz'}/>}

function Btn({ch,onClick,cls='btn-p',sm,disabled,style,id}){
  const handleClick=React.useCallback((e)=>{
    if(disabled)return;
    const btn=e.currentTarget;
    const rect=btn.getBoundingClientRect();
    const x=e.clientX-rect.left, y=e.clientY-rect.top;
    const rip=document.createElement('span');
    rip.style.cssText=`position:absolute;border-radius:50%;background:rgba(255,255,255,0.35);width:40px;height:40px;left:${x-20}px;top:${y-20}px;pointer-events:none;animation:ripple .6s linear forwards;`;
    btn.appendChild(rip);
    setTimeout(()=>rip.remove(),600);
    onClick&&onClick(e);
  },[onClick,disabled]);
  return<button id={id} className={`btn ${cls}${sm?' btn-sm':''}`} onClick={handleClick} disabled={disabled} style={style}>{ch}</button>;
}
function BackBtn({onClick}){
  return(
    <button style={{background:'rgba(255,255,255,0.07)',border:'none',color:'var(--tx2)',fontFamily:"'Inter',sans-serif",fontSize:13,fontWeight:600,padding:'7px 14px',borderRadius:'var(--rad-sm)',cursor:'pointer',display:'flex',alignItems:'center',gap:6,flexShrink:0,transition:'.2s'}}
      onClick={onClick} onMouseEnter={e=>e.currentTarget.style.color='var(--tx)'} onMouseLeave={e=>e.currentTarget.style.color='var(--tx2)'}>
      ← Назад
    </button>
  );
}

function Tog({on,onToggle,label,sub,dng}){
  return(
    <div className={`tog-row${dng?' dng':''}`} onClick={onToggle}>
      <div className={`tog-track${on?(dng?' dng':' on'):''}`}><div className="tog-thumb"/></div>
      <div>
        <div className="mono" style={{fontSize:9,letterSpacing:2,color:dng?'var(--r)':'var(--a)'}}>{label}</div>
        {sub&&<div className="mono" style={{fontSize:8,color:'var(--tx3)',marginTop:2}}>{sub}</div>}
      </div>
    </div>
  );
}

/* SVG icons */
const Ico={
  home:  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
  users: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>,
  trophy:<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="8 21 12 17 16 21"/><line x1="12" y1="17" x2="12" y2="11"/><path d="M7 4H4a2 2 0 000 4c0 5.5 7 8 8 8s8-2.5 8-8a2 2 0 000-4h-3"/><rect x="7" y="2" width="10" height="5" rx="1"/></svg>,
  user:  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
  exit:  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
};

/* ══════════════════════════════════════════════════════════
   CHAT VIEW
══════════════════════════════════════════════════════════ */
function fmtMsgTime(ts){
  if(!ts)return'';
  const d=new Date(ts),now=new Date();
  const pad=n=>String(n).padStart(2,'0');
  const time=`${pad(d.getHours())}:${pad(d.getMinutes())}`;
  const today=now.toDateString()===d.toDateString();
  if(today)return time;
  const yest=new Date(now);yest.setDate(yest.getDate()-1);
  if(yest.toDateString()===d.toDateString())return`вчера ${time}`;
  return`${pad(d.getDate())}.${pad(d.getMonth()+1)} ${time}`;
}
function isSameMinute(ts1,ts2){
  if(!ts1||!ts2)return false;
  const a=new Date(ts1),b=new Date(ts2);
  return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()&&a.getHours()===b.getHours()&&a.getMinutes()===b.getMinutes();
}
const QUICK_EMOJI=['👍','❤️','😂','😮','😢','🔥','💯','👏'];
function ChatView({msgs,me,onSend,title,onClose,extra,extraPadBot=0,onlineStatus}){
  const[text,setT]=useState('');
  const[reacting,setReacting]=useState(null);
  const[reactions,setReactions]=useState({});
  const bot=useRef();
  const inputRef=useRef();
  useEffect(()=>{if(bot.current)bot.current.scrollIntoView({behavior:'smooth'})},[msgs.length]);
  const send=()=>{const t=text.trim();if(!t)return;onSend(t);setT('');setTimeout(()=>inputRef.current?.focus(),50);};
  const handleKey=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}};
  const addReaction=(msgKey,emoji)=>{
    setReactions(prev=>{
      const cur=prev[msgKey]||{};
      const cnt=(cur[emoji]||0);
      if(cnt===0)return{...prev,[msgKey]:{...cur,[emoji]:1}};
      const next={...cur};delete next[emoji];
      return{...prev,[msgKey]:next};
    });
    setReacting(null);
  };

  // group messages: show date divider when day changes
  const grouped=[];
  msgs.forEach((m,i)=>{
    const prev=msgs[i-1];
    if(!prev||new Date(m.ts).toDateString()!==new Date(prev?.ts).toDateString()){
      const d=new Date(m.ts);const now=new Date();
      const pad=n=>String(n).padStart(2,'0');
      const today=now.toDateString()===d.toDateString();
      const yest=new Date(now);yest.setDate(yest.getDate()-1);
      const label=today?'Сегодня':yest.toDateString()===d.toDateString()?'Вчера':`${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`;
      grouped.push({type:'date',label,key:'date_'+m.ts});
    }
    // hide author if same person same minute as previous non-system msg
    const hideName=prev&&prev.from===m.from&&isSameMinute(prev.ts,m.ts)&&m.from!=='system';
    grouped.push({type:'msg',m,hideName});
  });

  return(
    <>
      <div className="tb">
        {onClose&&<BackBtn onClick={onClose}/>}
        <div style={{flex:1,display:'flex',flexDirection:'column',gap:1}}>
          <div className="tb-title" style={{marginBottom:0}}>{title}</div>
          {onlineStatus!==undefined&&<div style={{fontSize:9,color:onlineStatus?'var(--g)':'var(--tx3)',letterSpacing:1,fontFamily:"'Share Tech Mono',monospace",marginTop:1}}>{onlineStatus?'● В СЕТИ':'○ ОФЛАЙН'}</div>}
        </div>
        {extra}
      </div>
      <div className="chat-msgs" style={{paddingBottom: extraPadBot>0 ? extraPadBot+8 : 8}} onClick={()=>setReacting(null)}>
        {msgs.length===0&&<div style={{textAlign:'center',color:'var(--tx3)',fontSize:12,marginTop:48,lineHeight:2}}>💬<br/>Нет сообщений<br/><span style={{fontSize:10}}>Напишите первым!</span></div>}
        {grouped.map(item=>{
          if(item.type==='date')return(
            <div key={item.key} style={{textAlign:'center',margin:'8px 0',position:'relative'}}>
              <span style={{background:'rgba(255,255,255,0.07)',color:'var(--tx3)',fontSize:10,padding:'3px 10px',borderRadius:10,fontFamily:"'Inter',sans-serif"}}>{item.label}</span>
            </div>
          );
          const{m,hideName}=item;
          const isMe=m.from===me.username,isSys=m.from==='system';
          const msgKey=m.id||String(m.ts);
          const msgReactions=reactions[msgKey]||{};
          const hasReactions=Object.keys(msgReactions).filter(e=>msgReactions[e]>0).length>0;
          return(
            <div key={msgKey} style={{display:'flex',flexDirection:'column',alignItems:isSys?'center':isMe?'flex-end':'flex-start',marginBottom:hasReactions?16:0}}>
              <div
                className={`bubble ${isSys?'system':isMe?'me':'other'}`}
                style={{position:'relative',cursor:'pointer'}}
                onClick={e=>{e.stopPropagation();if(!isSys)setReacting(reacting===msgKey?null:msgKey);}}
              >
                {!isMe&&!isSys&&!hideName&&<div className="bubble-from">{m.fromName||m.from}</div>}
                <span style={{whiteSpace:'pre-wrap'}}>{m.text}</span>
                {!isSys&&<div className="bubble-time">{fmtMsgTime(m.ts)}</div>}
                {reacting===msgKey&&!isSys&&(
                  <div onClick={e=>e.stopPropagation()} style={{position:'absolute',bottom:'calc(100% + 6px)',right:isMe?0:'auto',left:isMe?'auto':0,display:'flex',gap:4,background:'rgba(20,20,32,0.97)',border:'1px solid rgba(255,255,255,0.12)',borderRadius:12,padding:'6px 10px',zIndex:10,boxShadow:'0 4px 24px rgba(0,0,0,0.5)',flexWrap:'nowrap'}}>
                    {QUICK_EMOJI.map(emoji=>(
                      <button key={emoji} onClick={()=>addReaction(msgKey,emoji)} style={{background:'none',border:'none',fontSize:18,cursor:'pointer',padding:'2px',lineHeight:1,borderRadius:6,transition:'.15s'}}>{emoji}</button>
                    ))}
                  </div>
                )}
              </div>
              {hasReactions&&(
                <div style={{display:'flex',gap:4,marginTop:4,flexWrap:'wrap',justifyContent:isMe?'flex-end':'flex-start'}}>
                  {Object.entries(msgReactions).filter(([,c])=>c>0).map(([emoji,cnt])=>(
                    <button key={emoji} onClick={()=>addReaction(msgKey,emoji)} style={{background:'rgba(255,255,255,0.08)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:10,padding:'2px 7px',fontSize:12,cursor:'pointer',color:'var(--tx)',display:'flex',alignItems:'center',gap:3}}>
                      {emoji}{cnt>1&&<span style={{fontSize:10}}>{cnt}</span>}
                    </button>
                  ))}
                </div>
              )}
            </div>
          );
        })}
        <div ref={bot}/>
      </div>
      <div className="chat-input" style={{paddingBottom: extraPadBot>0 ? extraPadBot+'px' : 'calc(12px + env(safe-area-inset-bottom,0px))'}}>
        <input ref={inputRef} className="inp" value={text} onChange={e=>setT(e.target.value)} onKeyDown={handleKey} placeholder="Сообщение…" maxLength={500} style={{marginBottom:0}}/>
        <button className="chat-send" onClick={send} disabled={!text.trim()}>▶</button>
      </div>
    </>
  );
}

/* ══════════════════════════════════════════════════════════
   AUTH SCREEN
══════════════════════════════════════════════════════════ */
function AuthScreen({onLogin,toast}){
  const[tab,setTab]=useState('login');
  const[uname,setU]=useState('');
  const[dname,setDname]=useState('');
  const[pass,setP]=useState('');
  const[loading,setL]=useState(false);

  const go=async()=>{
    const u=uname.trim().toLowerCase(),p=pass.trim();
    if(u.length<2||u.length>20)return toast('Имя: 2–20 символов','err');
    if(p.length<3)return toast('Пароль: мин. 3 символа','err');
    if(!/^[a-zа-яёA-ZА-ЯЁ0-9_-]+$/i.test(u))return toast('Только буквы, цифры, _ и -','err');
    setL(true);
    try{
      if(tab==='register'){
        const ex=await DB.getUser(u);if(ex){setL(false);return toast('Имя занято','err');}
        const all=await DB.getAllUsers();const first=Object.keys(all).length===0;
        const displayName=dname.trim()||u;
        const nu={userId:u,username:u,password:p,displayName:displayName,isAdmin:first,customRank:first?'supreme':null,gamesPlayed:0,gamesWon:0,gamesEliminated:0,elo:1000,eloGames:0,createdAt:Date.now()};
        await DB.setUser(u,nu);toast('✅ Аккаунт создан!','ok');if(window.triggerGate)window.triggerGate();onLogin(nu);
      }else{
        const usr=await DB.getUser(u);
        if(!usr||usr.password!==p){setL(false);return toast('Неверный логин или пароль','err');}
        if(usr.isBanned){setL(false);return toast(`🚫 Аккаунт заблокирован: ${usr.banReason||'Нарушение правил'}`,'err');}
        if(window.triggerGate)window.triggerGate();onLogin(usr);
      }
    }catch(e){toast('Ошибка соединения','err');console.error(e);}
    setL(false);
  };

  return(
    <div className="sc" style={{justifyContent:'center',alignItems:'center',padding:'0 20px',position:'relative',overflow:'hidden'}}>
      <div className="auth-glow"/>
      {/* Big icon */}
      <div style={{fontSize:72,animation:'glow 2.5s ease infinite',marginBottom:4,position:'relative',zIndex:1}}>☢</div>
      <div style={{fontFamily:"'Inter',sans-serif",fontSize:68,letterSpacing:2,color:'var(--a)',textShadow:'0 0 50px rgba(240,165,0,.3)',animation:'glitch 5s steps(1) infinite',position:'relative',zIndex:1}}>БУНКЕР</div>
      <div className="mono" style={{fontSize:9,letterSpacing:1,color:'var(--tx3)',marginBottom:36,position:'relative',zIndex:1}}>АПОКАЛИПСИС · ФТИ · WEB</div>

      <div style={{width:'100%',maxWidth:360,background:'rgba(255,255,255,0.05)',backdropFilter:'var(--bl)',WebkitBackdropFilter:'var(--bl)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:'var(--rad-lg)',padding:26,position:'relative',zIndex:1}}>
        {/* no corner brackets in modern design */}

        <div className="tabs" style={{marginBottom:18}}>
          <button className={`tab${tab==='login'?' on':''}`} onClick={()=>setTab('login')}>ВОЙТИ</button>
          <button className={`tab${tab==='register'?' on':''}`} onClick={()=>setTab('register')}>РЕГИСТРАЦИЯ</button>
        </div>
        <input className="inp" placeholder="Имя пользователя (логин)" value={uname} onChange={e=>setU(e.target.value)} maxLength={20} autoComplete="off"/>
        {tab==='register'&&<input className="inp" placeholder="Отображаемое имя (необязательно)" value={dname} onChange={e=>setDname(e.target.value)} maxLength={30} autoComplete="off"/>}
        <input className="inp" type="password" placeholder="Пароль" value={pass} onChange={e=>setP(e.target.value)} onKeyDown={e=>e.key==='Enter'&&go()}/>
        <Btn ch={loading?'⏳ ЗАГРУЗКА…':tab==='login'?'⚡ ВОЙТИ В БУНКЕР':'🔑 СОЗДАТЬ АККАУНТ'} onClick={go} disabled={loading}/>
        {tab==='register'&&<div className="mono" style={{fontSize:9,color:'var(--tx3)',marginTop:10,textAlign:'center',letterSpacing:1}}>Первый зарегистрированный — администратор</div>}
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   HOME SCREEN
══════════════════════════════════════════════════════════ */
/* ══ AVATAR COMPONENT ══ */
const AVA_COLORS=['#FF6B6B','#FF9F43','#FECA57','#48DBFB','#FF9FF3','#54A0FF','#5F27CD','#00D2D3','#01ABC7','#10AC84','#EE5A24','#9980FA'];
function getAvaColor(name){const h=(name||'?').split('').reduce((a,c)=>a+c.charCodeAt(0),0);return AVA_COLORS[h%AVA_COLORS.length];}
const AVATARS=['🧑‍🚀','👩‍⚕️','🧙‍♂️','🦸','🧟','👨‍💻','🎩','👮','🧛','🤖','👽','🦊','🐺','🦁','🐲','💀','🔬','⚔️','🛡️','🎭','🧪','☢️','🏴‍☠️','🎯'];

function Avatar({name,size='md',online=false,style={},avatar}){
  const bg=getAvaColor(name);
  const cls=size==='lg'?'ava-lg':size==='sm'?'ava-sm':'ava';
  const isEmoji=avatar&&avatar.length>0;
  if(isEmoji){
    const sz=size==='lg'?52:size==='sm'?20:28;
    // Красивые плавные градиенты для эмодзи-аватаров
    const gradients=[
      'linear-gradient(135deg,#667eea,#764ba2)',
      'linear-gradient(135deg,#f093fb,#f5576c)',
      'linear-gradient(135deg,#4facfe,#00f2fe)',
      'linear-gradient(135deg,#43e97b,#38f9d7)',
      'linear-gradient(135deg,#fa709a,#fee140)',
      'linear-gradient(135deg,#a18cd1,#fbc2eb)',
      'linear-gradient(135deg,#fccb90,#d57eeb)',
      'linear-gradient(135deg,#e0c3fc,#8ec5fc)',
    ];
    const gradIdx=name?(name.charCodeAt(0)+name.charCodeAt(name.length-1))%gradients.length:0;
    const grad=gradients[gradIdx];
    return(
      <div className={`${cls}${online?' ava-pulse':''}`} style={{background:grad,boxShadow:`0 3px 12px rgba(0,0,0,0.4)`,fontSize:sz*0.65,display:'flex',alignItems:'center',justifyContent:'center',filter:'drop-shadow(0 1px 2px rgba(0,0,0,0.3))',...style}}>
        {avatar}
      </div>
    );
  }
  const letter=(name||'?')[0].toUpperCase();
  return(
    <div className={`${cls}${online?' ava-pulse':''}`} style={{background:`linear-gradient(135deg,${bg}cc,${bg}88)`,boxShadow:`0 2px 8px ${bg}44`,...style}}>
      {letter}
    </div>
  );
}

/* ══ GAME LOADING SCREEN ══ */
function GameLoading({text='Загружаем бункер...'}){
  const lines=['Проверяем запасы...','Герметизируем ворота...','Распределяем роли...','Инициализируем систему...'];
  const[line,setLine]=useState(0);
  useEffect(()=>{const t=setInterval(()=>setLine(v=>(v+1)%lines.length),700);return()=>clearInterval(t);},[]);
  return(
    <div className="game-loading">
      <div style={{fontSize:42,animation:'glow 2s ease infinite'}}>☢</div>
      <div style={{textAlign:'center'}}>
        <div style={{fontSize:18,fontWeight:700,color:'var(--a)',marginBottom:6}}>{text}</div>
        <div style={{fontSize:12,color:'var(--tx3)',minHeight:18}}>{lines[line]}</div>
      </div>
      <div className="game-loading-bar"><div className="game-loading-fill"/></div>
    </div>
  );
}

/* ══ ONLINE PRESENCE ══ */
function useOnline(gameId,username){
  useEffect(()=>{
    if(!gameId||!username)return;
    const ref=db.ref(`presence/${gameId}/${username}`);
    ref.set({ts:Date.now(),online:true});
    ref.onDisconnect().remove();
    const t=setInterval(()=>ref.update({ts:Date.now()}),15000);
    return()=>{clearInterval(t);ref.remove();};
  },[gameId,username]);
}
function useOnlinePlayers(gameId){
  const[online,setOnline]=useState({});
  useEffect(()=>{
    if(!gameId)return;
    const ref=db.ref(`presence/${gameId}`);
    const cb=ref.on('value',snap=>{
      const d=snap.val()||{};
      const now=Date.now();
      const alive={};
      Object.entries(d).forEach(([u,v])=>{if(now-(v.ts||0)<35000)alive[u]=true;});
      setOnline(alive);
    });
    return()=>ref.off('value',cb);
  },[gameId]);
  return online;
}

function HomeScreen({user,nav,online,announcement}){
  const rank=getRank(user);
  const stats=[['gamesPlayed','ИГР','var(--a)'],['gamesWon','ПОБЕД','var(--g)'],['gamesEliminated','ВЫБЫЛ','var(--r)'],['elo','ЭЛО','#4da6ff']];
  return(
    <div className="sc">
      <HZ/>
      <div className="tb"><div className="led led-g"/><div className="tb-title" style={{color:'var(--a)'}}>БУНКЕР ФТИ</div><div style={{fontSize:11,color:'var(--tx3)',fontFamily:"'Inter',sans-serif",fontWeight:500}}>v2</div><div style={{fontSize:11,color:'var(--g)',fontWeight:600,display:'flex',alignItems:'center',gap:4}}>🟢 {Object.keys(online||{}).length} онлайн</div></div>
      <div className="scr">
        {announcement&&<div style={{background:'linear-gradient(135deg,rgba(10,132,255,0.15),rgba(155,89,239,0.12))',border:'1px solid rgba(10,132,255,0.35)',borderRadius:'var(--rad)',padding:'12px 16px',marginBottom:14,display:'flex',gap:10,alignItems:'flex-start'}}>
          <span style={{fontSize:18,flexShrink:0}}>📢</span>
          <div><div style={{fontSize:10,color:'var(--c)',fontWeight:700,letterSpacing:1,marginBottom:3}}>ОБЪЯВЛЕНИЕ АДМИНИСТРАТОРА</div><div style={{fontSize:13,color:'var(--tx)',lineHeight:1.5}}>{announcement}</div></div>
        </div>}
        {/* Profile hero */}
        <div style={{background:'rgba(255,255,255,0.05)',backdropFilter:'var(--bl)',WebkitBackdropFilter:'var(--bl)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad-lg)',padding:'24px 16px 20px',marginBottom:14,position:'relative',textAlign:'center'}}>
          {/* Subtle glow under icon */}
          <div style={{position:'absolute',top:'10%',left:'50%',transform:'translateX(-50%)',width:100,height:100,borderRadius:'50%',background:'radial-gradient(circle,rgba(240,165,0,.15) 0%,transparent 70%)',pointerEvents:'none'}}/>
          <div style={{fontSize:56,marginBottom:6,animation:'glow 3s ease infinite',position:'relative'}}>{rank.icon}</div>
          <div style={{fontFamily:"'Inter',sans-serif",fontSize:26,letterSpacing:3,color:'var(--tx)',marginBottom:2}}>{user.displayName||user.username}</div>
          <div className="mono" style={{fontSize:9,color:'var(--tx3)',letterSpacing:2,marginBottom:10}}>@{user.username}</div>
          <RChip user={user} size={10}/>
          {/* Stats row */}
          <div style={{display:'flex',justifyContent:'center',gap:0,marginTop:18,borderTop:'1px solid var(--ab)',paddingTop:16}}>
            {stats.map(([k,l,c],i)=>(
              <div key={k} style={{flex:1,textAlign:'center',borderRight:i<2?'1px solid var(--ab)':'none'}}>
                <div style={{fontFamily:"'Inter',sans-serif",fontSize:32,color:c,lineHeight:1}}>{user[k]||0}</div>
                <div className="mono" style={{fontSize:8,color:'var(--tx3)',letterSpacing:2,marginTop:3}}>{l}</div>
              </div>
            ))}
          </div>
        </div>

        <div className="lbl">ДЕЙСТВИЯ</div>
        <div style={{display:'flex',flexDirection:'column',gap:8,marginBottom:4}}>
          <Btn ch="☢ СОЗДАТЬ ИГРУ" onClick={()=>nav('createGame')}/>
          <Btn ch="🔍 ПОДБОР ИГРОКОВ" onClick={()=>nav('matchmaking')} cls="btn-c"/>
          <Btn ch="🔑 ВОЙТИ ПО КОДУ" onClick={()=>nav('joinGame')} cls="btn-g"/>
          <div className="brow">
            <Btn ch="🏆 РЕЙТИНГ" onClick={()=>nav('leaderboard')} cls="btn-c" sm/>
            <Btn ch="👤 ПРОФИЛЬ" onClick={()=>nav('profile')} cls="btn-g" sm/>
          </div>
          {user.isAdmin&&<Btn ch="🔐 ПАНЕЛЬ АДМИНИСТРАТОРА" onClick={()=>nav('admin')} cls="btn-pu"/>}
        </div>

        <div className="lbl">СИСТЕМА ЗВАНИЯ</div>
        {RANKS.filter(r=>!r.adminOnly||user.isAdmin).map(r=>{
          const cur=getRank(user).id===r.id;
          return(
            <div key={r.id} style={{display:'flex',alignItems:'center',gap:10,padding:'9px 12px',background:cur?'var(--at)':'rgba(255,255,255,0.03)',border:`1px solid ${cur?r.bdr:'rgba(255,255,255,0.07)'}`,borderRadius:'var(--rad-sm)',marginBottom:4,opacity:cur?1:.45,transition:'.2s'}}>
              <span style={{fontSize:18}}>{r.icon}</span>
              <div style={{flex:1}}>
                <div style={{fontSize:11,fontWeight:600,color:cur?r.color:'var(--tx3)'}}>{r.name}</div>
                <div style={{fontSize:10,color:'var(--tx3)',marginTop:1}}>{r.adminOnly?'Только администраторы':r.min===0?'Начальное звание':`от ${r.min} игр`}</div>
              </div>
              {cur&&<span className="bdg bdg-a" style={{fontSize:7}}>ТЕКУЩЕЕ</span>}
            </div>
          );
        })}

        {/* ═══════ ИНФОРМАЦИЯ ОБ ИГРЕ ═══════ */}
        <div className="lbl" style={{marginTop:24}}>ОБ ИГРЕ</div>
        <div style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad)',padding:16,marginBottom:10}}>
          <div style={{fontSize:13,color:'var(--tx2)',lineHeight:1.65}}>
            <b style={{color:'var(--a)'}}>Бункер</b> — социальная игра на выживание. Апокалипсис случился. Осталось одно убежище с ограниченными местами. Игроки раскрывают свои карточки и убеждают остальных, что именно они заслуживают место в бункере.
            <br/><br/>
            Каждый раунд игроки <b style={{color:'var(--tx)'}}>раскрывают по 2 карточки</b>, обсуждают и голосуют — кого выгнать. Игра заканчивается, когда оставшихся игроков ≤ числу мест в бункере.
          </div>
        </div>

        <div className="lbl">КАК ИГРАТЬ</div>
        {[
          ['1','☢','Ведущий создаёт игру, задаёт сценарий апокалипсиса и число мест в бункере'],
          ['2','🔑','Остальные игроки входят по коду комнаты'],
          ['3','🃏','Все получают уникальные карточки — профессию, здоровье, хобби, багаж и секретный факт'],
          ['4','👁','Каждый раунд раскрывай 2 карточки и убеждай остальных взять тебя в бункер'],
          ['5','🗳','После обсуждения — тайное голосование. Кто набрал больше всего голосов — выбывает'],
          ['6','🏆','Выжившие, поместившиеся в бункер — победители!'],
        ].map(([n,icon,text])=>(
          <div key={n} style={{display:'flex',alignItems:'flex-start',gap:12,padding:'11px 14px',background:'rgba(255,255,255,0.03)',border:'1px solid rgba(255,255,255,0.07)',borderRadius:'var(--rad-sm)',marginBottom:6}}>
            <div style={{width:26,height:26,borderRadius:'50%',background:'var(--at)',border:'1px solid rgba(240,165,0,0.3)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:11,fontWeight:700,color:'var(--a)',flexShrink:0}}>{n}</div>
            <div style={{fontSize:13,color:'var(--tx2)',lineHeight:1.5,paddingTop:3}}><span style={{marginRight:6}}>{icon}</span>{text}</div>
          </div>
        ))}

        <div className="lbl">КАРТОЧКИ ПЕРСОНАЖА</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:10}}>
          {[
            ['👤','Пол и возраст','Базовая информация о персонаже'],
            ['💼','Профессия','Что умеет делать в бункере'],
            ['🏥','Здоровье','Физическое и психическое состояние'],
            ['🎯','Хобби','Навыки и увлечения'],
            ['🎒','Багаж','Что взял с собой'],
            ['🤫','Секретный факт','Скрытая деталь о персонаже'],
          ].map(([icon,name,desc])=>(
            <div key={name} style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad)',padding:'12px 12px 10px'}}>
              <div style={{fontSize:22,marginBottom:6}}>{icon}</div>
              <div style={{fontSize:12,fontWeight:600,color:'var(--tx)',marginBottom:3}}>{name}</div>
              <div style={{fontSize:10,color:'var(--tx3)',lineHeight:1.4}}>{desc}</div>
            </div>
          ))}
        </div>

        <div className="lbl">🃏 СЕКРЕТНЫЕ КАРТОЧКИ</div>
        <div style={{background:'rgba(155,89,239,0.08)',border:'1px solid rgba(155,89,239,0.25)',borderRadius:'var(--rad)',padding:16,marginBottom:10}}>
          <div style={{fontSize:13,color:'var(--tx2)',lineHeight:1.65,marginBottom:12}}>
            Каждый игрок получает <b style={{color:'var(--p)'}}>одну секретную карточку</b> — уникальную ситуацию или суперспособность, которая действует один раз за игру. Используй её в нужный момент!
          </div>
          <div style={{display:'flex',flexDirection:'column',gap:6}}>
            {[
              ['⚡','Двойной удар','Твой голос считается дважды','#f0a500'],
              ['🛡️','Иммунитет','Нельзя быть выгнанным даже при максимуме голосов','#30d158'],
              ['🔄','Обмен картой','Меняешь любую карту с другим игроком','#0a84ff'],
              ['👁️','Шпион','Тайно видишь закрытую карту другого игрока','#bf5af2'],
              ['↗️','Дополнительное раскрытие','Получаешь +1 раскрытие в этом раунде','#0a84ff'],
              ['🎲','Рулетка','Все игроки получают случайные карточки заново','#ff9f0a'],
              ['🔇','Немой','Противник не может голосовать этот раунд','#ff453a'],
            ].map(([icon,name,desc,color])=>(
              <div key={name} style={{display:'flex',gap:10,alignItems:'flex-start',padding:'8px 10px',background:'rgba(255,255,255,0.03)',borderRadius:'var(--rad-sm)'}}>
                <span style={{fontSize:16,flexShrink:0,marginTop:1}}>{icon}</span>
                <div>
                  <div style={{fontSize:12,fontWeight:600,color:color||'var(--tx)',marginBottom:2}}>{name}</div>
                  <div style={{fontSize:10,color:'var(--tx3)',lineHeight:1.4}}>{desc}</div>
                </div>
              </div>
            ))}
            <div style={{fontSize:10,color:'var(--tx3)',marginTop:4,fontStyle:'italic',textAlign:'center'}}>…и ещё много других секретных карточек!</div>
          </div>
        </div>

        <div className="lbl" style={{marginTop:24}}>⚙️ ДОПОЛНИТЕЛЬНЫЕ МЕХАНИКИ</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:14}}>
          {[
            {icon:'🎤',name:'Дебаты',desc:'60 сек перед голосованием. Каждый игрок защищает себя по очереди, пока таймер тикает.'},
            {icon:'📊',name:'История голосований',desc:'После раунда все видят кто за кого голосовал — никаких тайн!'},
            {icon:'🎭',name:'Роли',desc:'Лидер (x2 голос), Медик (спасает), Саботажник (хочет проиграть), Шпион — раскрываются в финале.'},
            {icon:'📡',name:'Радиопереговоры',desc:'Приватный чат с любым игроком. Договаривайся тайно прямо во время раунда.'},
            {icon:'🗺️',name:'Карта бункера',desc:'Комнаты бункера дают бонусы. Медпункт, Лаборатория, Ферма — каждый получает свою.'},
          ].map(m=>(
            <div key={m.name} style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad-sm)',padding:'14px 12px'}}>
              <div style={{fontSize:22,marginBottom:6}}>{m.icon}</div>
              <div style={{fontSize:13,fontWeight:700,color:'var(--tx)',marginBottom:4}}>{m.name}</div>
              <div style={{fontSize:11,color:'var(--tx3)',lineHeight:1.5}}>{m.desc}</div>
            </div>
          ))}
        </div>

        <div className="lbl">СОВЕТЫ</div>
        {[
          ['💡','Раскрывай сначала сильные карточки — сформируй первое впечатление'],
          ['🤫','Не спеши с секретной картой — лучший момент — на грани выбывания'],
          ['👥','Объединяйся с другими игроками против явных угроз'],
          ['🎭','Можно блефовать — никто не знает твои закрытые карты'],
        ].map(([icon,text])=>(
          <div key={text} style={{display:'flex',gap:10,alignItems:'flex-start',padding:'10px 12px',background:'rgba(255,255,255,0.03)',border:'1px solid rgba(255,255,255,0.06)',borderRadius:'var(--rad-sm)',marginBottom:6}}>
            <span style={{fontSize:15,flexShrink:0}}>{icon}</span>
            <div style={{fontSize:12,color:'var(--tx2)',lineHeight:1.5}}>{text}</div>
          </div>
        ))}

        <div style={{height:8}}/>
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   PROFILE
══════════════════════════════════════════════════════════ */
function ProfileScreen({user,onBack,toast,onUpdate}){
  const rank=getRank(user);
  const games=user.gamesPlayed||0;
  const wins=user.gamesWon||0;
  const elims=user.gamesEliminated||0;
  const winRate=games>0?Math.round(wins/games*100):0;
  const[editStatus,setEditStatus]=useState(false);
  const[statusVal,setStatusVal]=useState(user.status||'');
  const[showAvatarPicker,setShowAvatarPicker]=useState(false);
  const[selAvatar,setSelAvatar]=useState(user.avatar||'');
  const[gameHistory,setGameHistory]=useState(null);
  const[histLoading,setHistLoading]=useState(true);

  useEffect(()=>{
    DB.getGameHistory(user.username).then(h=>{setGameHistory(h);setHistLoading(false);}).catch(()=>setHistLoading(false));
  },[user.username]);

  const saveAvatar=async(emoji)=>{
    setSelAvatar(emoji);
    await DB.updateUser(user.username,{avatar:emoji});
    if(onUpdate)onUpdate({...user,avatar:emoji});
    setShowAvatarPicker(false);
    toast('🎨 Аватар обновлён!','ok');
  };
  const saveStatus=async()=>{
    const s=statusVal.slice(0,50);
    await DB.updateUser(user.username,{status:s});
    if(onUpdate)onUpdate({...user,status:s});
    setEditStatus(false);
    toast('Статус сохранён','ok');
  };
  return(
    <div className="sc">
      <div className="tb"><BackBtn onClick={onBack}/><div className="tb-title">ПРОФИЛЬ</div></div>
      <div className="scr">
        {/* Аватар + имя */}
        <div style={{textAlign:'center',padding:'28px 0 20px',background:'rgba(255,255,255,0.03)',borderRadius:'var(--rad-lg)',marginBottom:14,border:'1px solid rgba(255,255,255,0.07)'}}>
          <Avatar name={user.displayName||user.username} size="lg" avatar={selAvatar||user.avatar}/>
          <div style={{marginTop:8}}>
            <button onClick={()=>setShowAvatarPicker(p=>!p)} style={{background:'rgba(240,165,0,0.1)',border:'1px solid rgba(240,165,0,0.3)',color:'var(--a)',borderRadius:8,padding:'5px 12px',fontSize:12,cursor:'pointer',fontFamily:"'Inter',sans-serif"}}>🎨 Сменить аватар</button>
          </div>
          {showAvatarPicker&&(
            <div style={{padding:'0 16px'}}>
              <div className="avatar-picker-grid">
                {AVATARS.map(em=>(
                  <button key={em} className={`avatar-picker-btn${(selAvatar||user.avatar)===em?' selected':''}`} onClick={()=>saveAvatar(em)}>{em}</button>
                ))}
                {(selAvatar||user.avatar)&&<button className="avatar-picker-btn" onClick={()=>saveAvatar('')} title="Убрать аватар" style={{fontSize:12,color:'var(--tx3)'}}>✕</button>}
              </div>
            </div>
          )}
          <div style={{fontSize:20,fontWeight:700,color:'var(--tx)',marginBottom:4}}>{user.displayName||user.username}</div>
          <div style={{fontSize:12,color:'var(--tx3)',marginBottom:6}}>@{user.username}</div>
          {/* Status */}
          {editStatus?(
            <div style={{display:'flex',gap:6,alignItems:'center',justifyContent:'center',padding:'4px 16px',marginBottom:8}}>
              <input className="inp" style={{marginBottom:0,maxWidth:220,fontSize:13}} maxLength={50} value={statusVal} onChange={e=>setStatusVal(e.target.value)} placeholder="Статус (до 50 символов)..." autoFocus onKeyDown={e=>e.key==='Enter'&&saveStatus()}/>
              <button onClick={saveStatus} style={{background:'var(--a)',border:'none',borderRadius:'var(--rad-sm)',color:'#000',fontWeight:700,fontSize:12,padding:'6px 12px',cursor:'pointer'}}>✓</button>
              <button onClick={()=>{setEditStatus(false);setStatusVal(user.status||'');}} style={{background:'rgba(255,255,255,0.08)',border:'none',borderRadius:'var(--rad-sm)',color:'var(--tx2)',fontSize:12,padding:'6px 10px',cursor:'pointer'}}>✕</button>
            </div>
          ):(
            <div style={{display:'flex',alignItems:'center',justifyContent:'center',gap:6,marginBottom:8}}>
              <span style={{fontSize:12,color:user.status?'var(--tx2)':'var(--tx3)',fontStyle:user.status?'normal':'italic'}}>{user.status||'Нет статуса'}</span>
              <button onClick={()=>{setEditStatus(true);setStatusVal(user.status||'');}} style={{background:'rgba(255,255,255,0.08)',border:'none',borderRadius:6,color:'var(--tx3)',fontSize:11,padding:'2px 7px',cursor:'pointer'}}>✏️</button>
            </div>
          )}
          <div style={{display:'inline-flex',alignItems:'center',gap:6,background:`${rank.color}18`,border:`1px solid ${rank.color}44`,borderRadius:20,padding:'4px 14px'}}>
            <span style={{fontSize:16}}>{rank.icon}</span>
            <span style={{fontSize:12,fontWeight:700,color:rank.color}}>{rank.name}</span>
          </div>
        </div>
        {/* Статистика */}
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,marginBottom:14}}>
          {[['☢',games,'Игр','var(--a)'],[' 🏆',wins,'Побед','var(--g)'],['💀',elims,'Выбыл','var(--r)']].map(([ico,val,lbl,col])=>(
            <div key={lbl} style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad-sm)',padding:'14px 8px',textAlign:'center'}}>
              <div style={{fontSize:22,marginBottom:4}}>{ico}</div>
              <div style={{fontSize:24,fontWeight:700,color:col,lineHeight:1}}>{val}</div>
              <div style={{fontSize:10,color:'var(--tx3)',marginTop:4}}>{lbl}</div>
            </div>
          ))}
        </div>
        {/* Процент побед */}
        {games>0&&(
          <div style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad-sm)',padding:16,marginBottom:14}}>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:8}}>
              <span style={{fontSize:12,color:'var(--tx3)'}}>Процент побед</span>
              <span style={{fontSize:12,fontWeight:700,color:'var(--g)'}}>{winRate}%</span>
            </div>
            <div style={{height:6,background:'rgba(255,255,255,.08)',borderRadius:3,overflow:'hidden'}}>
              <div style={{height:'100%',width:`${winRate}%`,background:`linear-gradient(90deg,var(--g),#30d158)`,borderRadius:3,transition:'width .6s ease'}}/>
            </div>
          </div>
        )}
        {/* Тема */}
        <div className="lbl">🎨 ТЕМА ОФОРМЛЕНИЯ</div>
        <div style={{marginBottom:14}}><ThemeSwitcher/></div>
        {/* Достижения */}
        <div className="lbl">🏅 ДОСТИЖЕНИЯ</div>
        <AchievementsPanel userData={user}/>
        {/* История игр */}
        <div className="lbl">📋 ИСТОРИЯ ИГР</div>
        {histLoading?<Spin/>:!gameHistory||gameHistory.length===0?(
          <div className="mono" style={{textAlign:'center',color:'var(--tx3)',fontSize:10,letterSpacing:2,padding:'20px 0'}}>ИСТОРИЯ ПУСТА</div>
        ):(
          gameHistory.map((g,i)=>{
            const ap=g.apocalypse||{};
            const me=g.players?.[user.username];
            const survived=me&&!me.isEliminated;
            const dt=g.createdAt?new Date(g.createdAt):null;
            const dateStr=dt?`${String(dt.getDate()).padStart(2,'0')}.${String(dt.getMonth()+1).padStart(2,'0')}.${dt.getFullYear()}`:'—';
            const pCount=Object.keys(g.players||{}).length;
            const eloDelta=g.isRated&&me?.eloDelta;
            return(
              <div key={g.id||i} style={{display:'flex',alignItems:'center',gap:12,padding:'10px 14px',background:'rgba(255,255,255,0.03)',border:`1px solid rgba(255,255,255,0.07)`,borderLeft:`3px solid ${survived?'var(--g)':'var(--r)'}`,borderRadius:'var(--rad-sm)',marginBottom:6}}>
                <div style={{fontSize:22,flexShrink:0}}>{ap.emoji||'☢'}</div>
                <div style={{flex:1,minWidth:0}}>
                  <div style={{fontSize:13,fontWeight:600,color:'var(--tx)',marginBottom:2,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{ap.name||'Апокалипсис'}</div>
                  <div style={{fontSize:10,color:'var(--tx3)'}}>{dateStr} · {pCount} игроков</div>
                </div>
                <div style={{textAlign:'right',flexShrink:0}}>
                  <div style={{fontSize:12,fontWeight:700,color:survived?'var(--g)':'var(--r)'}}>{survived?'✅ ВЫЖИЛ':'☠️ ВЫБЫЛ'}</div>
                  {eloDelta&&<div style={{fontSize:10,fontWeight:600,color:eloDelta>0?'var(--g)':'var(--r)'}}>{eloDelta>0?'+':''}{eloDelta}</div>}
                </div>
              </div>
            );
          })
        )}
        {/* Звания */}
        <div className="lbl">СИСТЕМА ЗВАНИЙ</div>
        {RANKS.filter(r=>!r.adminOnly||user.isAdmin).map(r=>{
          const cur=getRank(user).id===r.id;
          return(
            <div key={r.id} style={{display:'flex',alignItems:'center',gap:10,padding:'10px 14px',background:cur?`${r.color}12`:'rgba(255,255,255,0.03)',border:`1px solid ${cur?r.color+'44':'rgba(255,255,255,0.07)'}`,borderRadius:'var(--rad-sm)',marginBottom:6,opacity:cur?1:.5,transition:'.2s'}}>
              <span style={{fontSize:20}}>{r.icon}</span>
              <div style={{flex:1}}>
                <div style={{fontSize:13,fontWeight:600,color:cur?r.color:'var(--tx)'}}>{r.name}</div>
                <div style={{fontSize:11,color:'var(--tx3)'}}>{r.adminOnly?'Только администраторы':r.min===0?'Начальное звание':`от ${r.min} игр`}</div>
              </div>
              {cur&&<span style={{fontSize:10,fontWeight:700,color:r.color,background:`${r.color}20`,border:`1px solid ${r.color}40`,borderRadius:10,padding:'2px 8px'}}>ТЕКУЩЕЕ</span>}
            </div>
          );
        })}
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   LEADERBOARD
══════════════════════════════════════════════════════════ */
function LeaderboardScreen({me,onBack,onViewProfile,online}){
  const[users,setU]=useState([]);
  const[loading,setL]=useState(true);
  const[sort,setS]=useState('gamesWon');
  const[search,setSearch]=useState('');
  const load=async(k)=>{setL(true);const all=await DB.getAllUsers();setU(Object.values(all).sort((a,b)=>(b[k]||0)-(a[k]||0)));setL(false);};
  useEffect(()=>{load('gamesWon');},[]);
  const medals=['🥇','🥈','🥉'];
  return(
    <div className="sc">
      <HZ/>
      <div className="tb"><BackBtn onClick={onBack}/><div className="tb-title">РЕЙТИНГ</div></div>
      <div className="scr">
        <div style={{position:'relative',marginBottom:12}}>
          <input className="inp" placeholder="🔍 Поиск игрока..." value={search} onChange={e=>setSearch(e.target.value)} style={{marginBottom:0,paddingRight:search?36:12}}/>
          {search&&<button onClick={()=>setSearch('')} style={{position:'absolute',right:10,top:'50%',transform:'translateY(-50%)',background:'none',border:'none',color:'var(--tx3)',fontSize:16,cursor:'pointer',lineHeight:1}}>✕</button>}
        </div>
        <div className="tabs" style={{flexWrap:'wrap',gap:4}}>
          {[['gamesWon','ПОБЕДЫ'],['gamesPlayed','ИГРЫ'],['gamesEliminated','ВЫБЫВАНИЯ'],['elo','🏅 ЭЛО']].map(([k,l])=>(
            <button key={k} className={`tab${sort===k?' on':''}`} onClick={()=>{setS(k);load(k);}}>{l}</button>
          ))}
        </div>
        {loading?<Spin/>:users.filter(u=>u&&u.username&&(sort!=='elo'||(u.eloGames||0)>0||(u.elo||0)!==1000)&&(!search||u.username.toLowerCase().includes(search.toLowerCase())||(u.displayName||'').toLowerCase().includes(search.toLowerCase()))).map((u,i)=>{
          const isMe=u.username===me.username;
          const isOnline=!!(online&&online[u.username]);
          const eloVal=u.elo||1000;
          const eloDelta=u.eloDelta||0;
          const eloTier=eloVal>=1800?{label:'💎 Легенда',color:'#a78bfa'}:eloVal>=1500?{label:'🏆 Мастер',color:'#f0a500'}:eloVal>=1200?{label:'🥇 Эксперт',color:'#4da6ff'}:eloVal>=1000?{label:'🥈 Опытный',color:'#30d158'}:{label:'🥉 Новичок',color:'#8e8e99'};
          return(
            <div key={u.username} className={`lb-row${isMe?' me':''}`} style={{cursor:!isMe?'pointer':'default'}} onClick={()=>!isMe&&onViewProfile&&onViewProfile(u.username)}>
              <div style={{fontFamily:"'Inter',sans-serif",fontSize:i<3?24:20,color:i<3?'var(--a)':'var(--tx3)',width:32,textAlign:'center',flexShrink:0}}>{medals[i]||(i+1)}</div>
              <div style={{flex:1}}>
                <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:3}}>
                  <span style={{fontSize:15,fontWeight:700}}>{u.displayName||u.username}</span>
                  {isMe&&<span className="bdg bdg-c" style={{fontSize:7}}>ВЫ</span>}
                  {isOnline&&<span style={{width:7,height:7,borderRadius:'50%',background:'var(--g)',boxShadow:'0 0 6px var(--g)',display:'inline-block',flexShrink:0}}/>}
                </div>
                {sort==='elo'
                  ?<span style={{fontSize:10,fontWeight:700,color:eloTier.color}}>{eloTier.label} · {u.eloGames||0} игр</span>
                  :<RChip user={u}/>
                }
              </div>
              <div style={{textAlign:'right'}}>
                {sort==='elo'?(
                  <>
                    <div style={{fontFamily:"'Share Tech Mono',monospace",fontSize:26,color:eloTier.color,fontWeight:700}}>{eloVal}</div>
                    {eloDelta!==0&&<div style={{fontSize:10,fontWeight:700,color:eloDelta>0?'var(--g)':'var(--r)'}}>{eloDelta>0?'+':''}{eloDelta}</div>}
                  </>
                ):(
                  <>
                    <div style={{fontFamily:"'Inter',sans-serif",fontSize:26,color:sort==='gamesWon'?'var(--g)':sort==='gamesEliminated'?'var(--r)':'var(--a)'}}>{u[sort]||0}</div>
                    <div className="mono" style={{fontSize:8,color:'var(--tx3)'}}>{sort==='gamesWon'?'побед':sort==='gamesPlayed'?'игр':'выбываний'}</div>
                  </>
                )}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   ADMIN PANEL
══════════════════════════════════════════════════════════ */
/* ══════════════════════════════════════════════════════════
   ADMIN GAMES LIST — детальные карточки игр
══════════════════════════════════════════════════════════ */
function AdminGamesList({games,me,endGame,toggleGameAdult}){
  const[expanded,setExpanded]=React.useState({});
  const toggle=id=>setExpanded(p=>({...p,[id]:!p[id]}));
  const sorted=Object.values(games).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

  const phaseColor=ph=>ph==='finished'?'var(--tx3)':ph==='voting'?'var(--r)':ph==='playing'?'var(--g)':'var(--c)';
  const phaseLabel=ph=>ph==='finished'?'Завершена':ph==='voting'?'Голосование':ph==='playing'?'Идёт игра':'Лобби';

  return(
    <div>
      {sorted.map(g=>{
        const players=Object.values(g.players||{});
        const alive=players.filter(p=>!p.isEliminated);
        const dead=players.filter(p=>p.isEliminated);
        const isOpen=expanded[g.id];
        return(
          <div key={g.id} style={{marginBottom:10,borderRadius:14,overflow:'hidden',border:'1px solid rgba(255,255,255,0.08)',background:'rgba(255,255,255,0.03)'}}>
            {/* Шапка карточки */}
            <div onClick={()=>toggle(g.id)} style={{display:'flex',alignItems:'center',gap:10,padding:'12px 14px',cursor:'pointer',userSelect:'none'}}>
              <div style={{flex:1,minWidth:0}}>
                <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:4,flexWrap:'wrap'}}>
                  <span style={{fontWeight:700,fontSize:15,color:'var(--a)',letterSpacing:1,fontFamily:'Inter,sans-serif'}}>{g.id}</span>
                  <span style={{fontSize:11,color:phaseColor(g.phase),background:`${phaseColor(g.phase)}18`,borderRadius:6,padding:'2px 8px',fontWeight:600}}>{phaseLabel(g.phase)}</span>
                  {g.adultMode&&<span style={{fontSize:10,color:'var(--r)',background:'rgba(255,69,58,0.12)',borderRadius:6,padding:'2px 7px',fontWeight:600}}>18+</span>}
                </div>
                <div style={{fontSize:11,color:'var(--tx2)'}}>
                  {g.apocalypse?.emoji} {g.apocalypse?.name} · Раунд {g.round||1} · 👥 {players.length} игроков
                </div>
              </div>
              <div style={{display:'flex',gap:6,alignItems:'center'}}>
                {g.phase==='lobby'&&<button onClick={e=>{e.stopPropagation();toggleGameAdult(g.id,!g.adultMode);}} style={{background:g.adultMode?'rgba(255,69,58,0.15)':'rgba(255,255,255,0.07)',border:'none',color:g.adultMode?'var(--r)':'var(--tx2)',borderRadius:8,fontSize:11,padding:'5px 10px',cursor:'pointer',fontWeight:600}}>🔞 {g.adultMode?'Вкл':'Выкл'}</button>}
                {g.phase!=='finished'&&<button onClick={e=>{e.stopPropagation();endGame(g.id);}} style={{background:'rgba(255,69,58,0.15)',border:'none',color:'var(--r)',borderRadius:8,fontSize:11,padding:'5px 10px',cursor:'pointer',fontWeight:600}}>■ Стоп</button>}
                <span style={{color:'var(--tx3)',fontSize:16,transition:'transform .2s',display:'inline-block',transform:isOpen?'rotate(180deg)':'rotate(0deg)'}}>⌄</span>
              </div>
            </div>

            {/* Развёрнутый блок с игроками */}
            {isOpen&&(
              <div style={{borderTop:'1px solid rgba(255,255,255,0.06)',padding:'12px 14px',animation:'fadeUp .15s ease'}}>
                {/* Живые игроки */}
                {alive.length>0&&(
                  <div style={{marginBottom:10}}>
                    <div style={{fontSize:10,color:'var(--g)',fontWeight:600,letterSpacing:1,marginBottom:8,textTransform:'uppercase'}}>✅ В живых ({alive.length})</div>
                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6}}>
                      {alive.map(p=>{
                        const cards=p.cards||{};
                        const revealed=p.revealed||[];
                        return(
                          <div key={p.username} style={{background:'rgba(48,209,88,0.05)',border:'1px solid rgba(48,209,88,0.15)',borderRadius:10,padding:'10px 12px'}}>
                            <div style={{fontWeight:700,fontSize:13,marginBottom:4,color:'var(--tx)'}}>{p.name||p.username}</div>
                            <div style={{fontSize:10,color:'var(--tx3)',marginBottom:6}}>@{p.username}{g.creatorId===p.username?' 👑':''}</div>
                            {cards.profession&&<div style={{fontSize:11,color:'var(--tx2)',marginBottom:2}}>💼 {cards.profession}{revealed.includes('profession')?' ✓':' 🔒'}</div>}
                            {cards.health&&<div style={{fontSize:11,color:'var(--tx2)',marginBottom:2}}>{cards.health[0]} {cards.health[1]}{revealed.includes('health')?' ✓':' 🔒'}</div>}
                            {cards.hobby&&<div style={{fontSize:11,color:'var(--tx2)',marginBottom:2}}>🎯 {cards.hobby}{revealed.includes('hobby')?' ✓':' 🔒'}</div>}
                            {cards.baggage&&<div style={{fontSize:11,color:'var(--tx2)',marginBottom:2}}>🎒 {cards.baggage}{revealed.includes('baggage')?' ✓':' 🔒'}</div>}
                            {cards.fact&&<div style={{fontSize:11,color:'var(--tx2)',marginBottom:2}}>📌 {cards.fact}{revealed.includes('fact')?' ✓':' 🔒'}</div>}
                            {cards.phobia&&<div style={{fontSize:11,color:'var(--tx2)',marginBottom:2}}>😱 {cards.phobia}{revealed.includes('phobia')?' ✓':' 🔒'}</div>}
                            <div style={{fontSize:9,color:'var(--tx3)',marginTop:4}}>Раскрыто: {revealed.length} карт</div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
                {/* Выбывшие */}
                {dead.length>0&&(
                  <div>
                    <div style={{fontSize:10,color:'var(--r)',fontWeight:600,letterSpacing:1,marginBottom:8,textTransform:'uppercase'}}>☠️ Выбыли ({dead.length})</div>
                    <div style={{display:'flex',flexDirection:'column',gap:4}}>
                      {dead.map(p=>(
                        <div key={p.username} style={{background:'rgba(255,69,58,0.05)',border:'1px solid rgba(255,69,58,0.12)',borderRadius:8,padding:'8px 12px',display:'flex',alignItems:'center',gap:8,opacity:0.7}}>
                          <span style={{fontSize:12}}>☠️</span>
                          <div>
                            <div style={{fontWeight:600,fontSize:12,color:'var(--tx2)'}}>{p.name||p.username}</div>
                            <div style={{fontSize:10,color:'var(--tx3)'}}>@{p.username}</div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                {players.length===0&&<div style={{textAlign:'center',color:'var(--tx3)',fontSize:12,padding:'12px 0'}}>Нет игроков</div>}
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
}

function AdminScreen({me,onBack,toast}){
  const[tab,setTab]=useState('dash');
  const[users,setU]=useState({});
  const[games,setG]=useState({});
  const[settings,setS]=useState({});
  const[loading,setL]=useState(true);
  const[editUser,setEditUser]=useState(null);
  const[editDisplayName,setEditDisplayName]=useState('');
  const[editPassword,setEditPassword]=useState('');
  const[editElo,setEditElo]=useState('');
  const[showPass,setShowPass]=useState(false);
  const[selected,setSelected]=useState({});
  const[banTarget,setBanTarget]=useState(null);
  const[banReason,setBanReason]=useState('');
  const[broadcastText,setBroadcastText]=useState('');
  const[announcText,setAnnouncText]=useState('');
  const[adminLog,setAdminLog]=useState([]);
  const[winnerPick,setWinnerPick]=useState(null);
  const[pickedWinners,setPickedWinners]=useState({});

  const load=async()=>{const[u,g,s,al]=await Promise.all([DB.getAllUsers(),DB.getAllGames(),DB.getSettings(),DB.getAdminLog()]);setU(u);setG(g);setS(s);setAdminLog(al);setL(false);};
  const logA=(action,details)=>DB.logAdmin(me.username,action,details);
  useEffect(()=>{load();},[]);
  useEffect(()=>{
    const handler=(e)=>{if(e.key==='Escape'&&editUser)setEditUser(null);};
    window.addEventListener('keydown',handler);
    return()=>window.removeEventListener('keydown',handler);
  },[editUser]);

  const setRank=async(uname,rid)=>{
    const u=users[uname];const patch={customRank:rid||null};
    if(rid==='supreme')patch.isAdmin=true;
    else if(u.customRank==='supreme'&&rid!=='supreme')patch.isAdmin=false;
    await DB.updateUser(uname,patch);setU(p=>({...p,[uname]:{...p[uname],...patch}}));toast('✅ Звание обновлено!','ok');
  };
  const toggleAdmin=async(uname)=>{
    if(uname===me.username)return toast('Нельзя снять с себя','err');
    const u=users[uname];const na=!u.isAdmin;
    const patch={isAdmin:na,customRank:na?'supreme':(u.customRank==='supreme'?null:u.customRank)};
    await DB.updateUser(uname,patch);setU(p=>({...p,[uname]:{...p[uname],...patch}}));
    toast(na?'✅ Назначен админом':'✅ Права сняты','ok');
  };
  const delUser=async(uname)=>{
    if(uname===me.username)return toast('Нельзя удалить себя','err');
    if(!confirm(`Удалить @${uname}?`))return;
    await DB.deleteUser(uname);setU(p=>{const n={...p};delete n[uname];return n;});toast('✅ Удалён','ok');
  };
  const endGame=async(gid)=>{await DB.updateGame(gid,{phase:'finished'});setG(p=>({...p,[gid]:{...p[gid],phase:'finished'}}));toast('✅ Игра завершена','ok');};
  const toggleGameAdult=async(gid,val)=>{await DB.updateGame(gid,{adultMode:val});setG(p=>({...p,[gid]:{...p[gid],adultMode:val}}));toast(val?'🔞 18+ включён':'✅ 18+ выключен','ok');};
  const toggleGlobal=async()=>{
    const nv=!settings.adultMode;await DB.updateSettings({adultMode:nv});setS(p=>({...p,adultMode:nv}));
    toast(nv?'🔞 18+ включён — все игроки могут использовать':'✅ 18+ выключен глобально','ok');
  };
  const active=Object.values(games).filter(g=>g.phase!=='finished');

  return(
    <div className="sc">
      <HZ/>
      <div className="tb"><BackBtn onClick={onBack}/><div className="tb-title" style={{color:'var(--p)'}}>🔐 АДМИНИСТРАТОР</div></div>
      <div className="scr-raw">
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,marginBottom:14}}>
          {[[Object.keys(users).length,'ИГРОКИ','var(--a)'],[active.length,'АКТИВНЫЕ','var(--g)'],[Object.keys(games).length,'ВСЕГО','var(--tx3)']].map(([v,l,c])=>(
            <div key={l} className="stat-box"><div className="sv" style={{fontSize:26,color:c}}>{v}</div><div className="sl">{l}</div></div>
          ))}
        </div>
        <div className="tabs" style={{flexWrap:'wrap',gap:2}}>
          {[['dash','📊 ДАШБОРД'],['users','👥 ИГРОКИ'],['games','🎮 ИГРЫ'],['settings','⚙️ НАСТРОЙКИ'],['broadcast','📢 РАССЫЛКА'],['cheats','⚡ ЧИТЫ'],['log','📋 ЛОГ']].map(([id,label])=>(
            <button key={id} className={`tab${tab===id?' on':''}`} onClick={()=>setTab(id)} style={{fontSize:10,padding:'6px 10px'}}>{label}</button>
          ))}
        </div>
        {loading?<Spin/>:tab==='dash'?(
          <div>
            {/* Stats grid */}
            {(()=>{
              const uList=Object.values(users);
              const gList=Object.values(games);
              const active=gList.filter(g=>g.phase!=='finished');
              const today=Date.now()-86400000;
              const newToday=uList.filter(u=>u.createdAt>today).length;
              const totalGames=gList.filter(g=>g.phase==='finished').length;
              const banned=uList.filter(u=>u.isBanned).length;
              const topByWins=[...uList].sort((a,b)=>(b.gamesWon||0)-(a.gamesWon||0)).slice(0,3);
              const topByElo=[...uList].sort((a,b)=>(b.elo||0)-(a.elo||0)).slice(0,3);
              return(<>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:14}}>
                  {[[uList.length,'👥 Всего игроков','var(--a)'],[newToday,'🆕 Новых сегодня','var(--g)'],[active.length,'🎮 Активных игр','#4da6ff'],[totalGames,'✅ Завершено','var(--tx3)'],[banned,'🚫 Забанено','var(--r)'],[Object.values(users).filter(u=>u.eloGames>0).length,'🏅 Рейт. игроков','#f5a623']].map(([v,l,c])=>(
                    <div key={l} className="stat-box glass-card" style={{padding:'12px 14px'}}><div style={{fontSize:22,color:c,fontWeight:800}}>{v}</div><div style={{fontSize:10,color:'var(--tx3)',marginTop:2}}>{l}</div></div>
                  ))}
                </div>
                <div className="lbl">ТОП-3 ПО ПОБЕДАМ</div>
                {topByWins.map((u,i)=>(
                  <div key={u.username} style={{display:'flex',alignItems:'center',gap:10,padding:'8px 12px',background:'rgba(255,255,255,0.04)',borderRadius:8,marginBottom:6}}>
                    <span style={{fontSize:16}}>{['🥇','🥈','🥉'][i]}</span>
                    <Avatar name={u.displayName||u.username} avatar={u.avatar} size="sm"/>
                    <div style={{flex:1}}><div style={{fontSize:13,fontWeight:600}}>{u.displayName||u.username}</div><div style={{fontSize:10,color:'var(--tx3)'}}>@{u.username}</div></div>
                    <div style={{fontSize:13,color:'var(--g)',fontWeight:700}}>{u.gamesWon||0} побед</div>
                  </div>
                ))}
                <div className="lbl" style={{marginTop:12}}>ТОП-3 ПО ЭЛО</div>
                {topByElo.map((u,i)=>(
                  <div key={u.username} style={{display:'flex',alignItems:'center',gap:10,padding:'8px 12px',background:'rgba(255,255,255,0.04)',borderRadius:8,marginBottom:6}}>
                    <span style={{fontSize:16}}>{['🥇','🥈','🥉'][i]}</span>
                    <Avatar name={u.displayName||u.username} avatar={u.avatar} size="sm"/>
                    <div style={{flex:1}}><div style={{fontSize:13,fontWeight:600}}>{u.displayName||u.username}</div></div>
                    <div style={{fontSize:13,color:'#4da6ff',fontWeight:700}}>{u.elo||1000} Эло</div>
                  </div>
                ))}
              </>);
            })()}
          </div>
        ):tab==='broadcast'?(
          <div>
            <div className="lbl">📢 РАССЫЛКА ВСЕМ ОНЛАЙН</div>
            <div style={{fontSize:12,color:'var(--tx2)',marginBottom:10,lineHeight:1.6}}>Сообщение появится у всех онлайн-игроков как toast-уведомление на 10 секунд.</div>
            <textarea className="inp" rows={3} placeholder="Введите сообщение..." value={broadcastText} onChange={e=>setBroadcastText(e.target.value)} maxLength={200} style={{resize:'vertical',minHeight:80}}/>
            <Btn ch="📢 Отправить рассылку" onClick={async()=>{
              if(!broadcastText.trim())return toast('Введи сообщение','err');
              if(!confirm('Отправить сообщение всем онлайн-игрокам?'))return;
              await DB.sendBroadcast(me.displayName||me.username,broadcastText.trim());
              await logA('РАССЫЛКА',broadcastText.trim());
              setBroadcastText('');toast('✅ Рассылка отправлена!','ok');
              await load();
            }}/>
            <div className="lbl" style={{marginTop:20}}>📌 ОБЪЯВЛЕНИЕ НА ГЛАВНОЙ</div>
            <div style={{fontSize:12,color:'var(--tx2)',marginBottom:10,lineHeight:1.6}}>Закреплённый баннер на главном экране у всех игроков. Оставьте пустым — убрать.</div>
            <textarea className="inp" rows={3} placeholder="Текст объявления (пусто = убрать)..." value={announcText} onChange={e=>setAnnouncText(e.target.value)} maxLength={300} style={{resize:'vertical',minHeight:80}}/>
            <div style={{display:'flex',gap:8}}>
              <Btn ch="📌 Установить" onClick={async()=>{
                await DB.setAnnouncement(announcText.trim()||null);
                await logA('ОБЪЯВЛЕНИЕ',announcText.trim()||'(удалено)');
                toast('✅ Объявление обновлено!','ok');
              }}/>
              <Btn ch="✕ Убрать" cls="btn-g" sm onClick={async()=>{
                await DB.setAnnouncement(null);setAnnouncText('');
                await logA('ОБЪЯВЛЕНИЕ','(удалено)');
                toast('✅ Объявление убрано','ok');
              }}/>
            </div>
          </div>
        ):tab==='log'?(
          <div>
            <div className="lbl">📋 ЛОГ ДЕЙСТВИЙ АДМИНИСТРАТОРА</div>
            {adminLog.length===0?<div style={{textAlign:'center',padding:24,color:'var(--tx3)'}}>Нет записей</div>:adminLog.map((entry,i)=>{
              const d=new Date(entry.ts);
              const timeStr=`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
              return(
                <div key={i} style={{padding:'10px 12px',background:'rgba(255,255,255,0.03)',border:'1px solid rgba(255,255,255,0.07)',borderRadius:8,marginBottom:6}}>
                  <div style={{display:'flex',gap:8,alignItems:'center',marginBottom:3}}>
                    <span style={{fontSize:10,color:'var(--tx3)',fontFamily:"monospace"}}>{timeStr}</span>
                    <span style={{fontSize:10,color:'var(--a)',fontWeight:700,background:'rgba(240,165,0,0.1)',padding:'2px 6px',borderRadius:4}}>{entry.action}</span>
                    <span style={{fontSize:10,color:'var(--tx3)'}}>@{entry.adminId}</span>
                  </div>
                  {entry.details&&<div style={{fontSize:12,color:'var(--tx2)'}}>{entry.details}</div>}
                </div>
              );
            })}
          </div>
        ):tab==='games'?(
          <div>
            <div className="lbl">🎮 АКТИВНЫЕ ИГРЫ</div>
            {Object.values(games).filter(g=>g.phase!=='finished').length===0&&<div style={{textAlign:'center',padding:24,color:'var(--tx3)'}}>Нет активных игр</div>}
            {Object.values(games).filter(g=>g.phase!=='finished').map(g=>{
              const players=Object.values(g.players||{});
              const isWinnerPick=winnerPick===g.id;
              return(
                <div key={g.id} style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad)',padding:14,marginBottom:10}}>
                  <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
                    <span style={{fontSize:18}}>{g.apocalypse?.emoji||'🎮'}</span>
                    <div style={{flex:1}}><div style={{fontWeight:700,fontSize:14}}>{g.apocalypse?.name||g.id}</div><div style={{fontSize:10,color:'var(--tx3)'}}>Код: {g.id} · {players.length} игроков · {g.isRated?'🏅 Рейт':''}</div></div>
                    <span style={{fontSize:9,color:g.phase==='lobby'?'var(--c)':'var(--g)',fontFamily:'monospace',background:'rgba(255,255,255,0.05)',padding:'3px 6px',borderRadius:4}}>{g.phase==='lobby'?'ЛОББИ':g.phase==='playing'?'ИГРА':g.phase==='voting'?'ГОЛОСОВ':g.phase}</span>
                  </div>
                  <div style={{display:'flex',flexWrap:'wrap',gap:6,marginBottom:10}}>
                    {players.map(p=>(
                      <div key={p.username} style={{fontSize:10,background:isWinnerPick?(pickedWinners[p.username]?'rgba(48,209,88,0.2)':'rgba(255,255,255,0.05)'):'rgba(255,255,255,0.05)',border:`1px solid ${isWinnerPick?(pickedWinners[p.username]?'rgba(48,209,88,0.5)':'rgba(255,255,255,0.1)'):'rgba(255,255,255,0.1)'}`,borderRadius:6,padding:'3px 8px',cursor:isWinnerPick?'pointer':'default',transition:'.15s'}}
                        onClick={()=>{if(isWinnerPick)setPickedWinners(pw=>({...pw,[p.username]:!pw[p.username]}));}}>
                        {p.isEliminated?'☠️':'🟢'} {p.name||p.username}
                      </div>
                    ))}
                  </div>
                  <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
                    {!isWinnerPick&&<Btn ch="🏆 Выбрать победителей" sm cls="btn-c" onClick={()=>{setWinnerPick(g.id);const pw={};players.filter(p=>!p.isEliminated).forEach(p=>{pw[p.username]=true;});setPickedWinners(pw);}}/>}
                    {isWinnerPick&&<>
                      <Btn ch="✅ Подтвердить" sm cls="btn-g" onClick={async()=>{
                        const winners=Object.keys(pickedWinners).filter(k=>pickedWinners[k]);
                        if(!winners.length)return toast('Выбери хотя бы одного победителя','err');
                        if(!confirm(`Завершить игру, победители: ${winners.join(', ')}?`))return;
                        // Set all as eliminated, then unset winners
                        const patch={phase:'finished'};
                        players.forEach(p=>{patch[`players/${p.username}/isEliminated`]=!winners.includes(p.username);});
                        await DB.updateGame(g.id,patch);
                        await logA('ЗАВЕРШИЛ ИГРУ',`${g.id} победители: ${winners.join(', ')}`);
                        setWinnerPick(null);setPickedWinners({});toast('✅ Игра завершена!','ok');await load();
                      }}/>
                      <Btn ch="✕" sm cls="btn-g" onClick={()=>{setWinnerPick(null);setPickedWinners({});}}/>
                    </>}
                    {!isWinnerPick&&<Btn ch="⚡ Принудительно завершить" sm cls="btn-d" onClick={async()=>{
                      if(!confirm(`Принудительно завершить игру "${g.apocalypse?.name||g.id}"?`))return;
                      await DB.updateGame(g.id,{phase:'finished'});
                      await logA('ПРИНУДИТ. ЗАВЕРШИЛ',g.id);
                      toast('✅ Игра завершена','ok');await load();
                    }}/>}
                  </div>
                </div>
              );
            })}
            <div className="lbl" style={{marginTop:12}}>📜 ЗАВЕРШЁННЫЕ ИГРЫ</div>
            {Object.values(games).filter(g=>g.phase==='finished').slice(-5).reverse().map(g=>(
              <div key={g.id} style={{padding:'8px 12px',background:'rgba(255,255,255,0.02)',border:'1px solid rgba(255,255,255,0.05)',borderRadius:8,marginBottom:6,display:'flex',gap:10,alignItems:'center'}}>
                <span>{g.apocalypse?.emoji||'🎮'}</span>
                <div style={{flex:1}}><div style={{fontSize:12,color:'var(--tx2)'}}>{g.apocalypse?.name||g.id}</div><div style={{fontSize:10,color:'var(--tx3)'}}>{Object.keys(g.players||{}).length} игроков</div></div>
                <span style={{fontSize:9,color:'var(--tx3)',fontFamily:'monospace'}}>{g.createdAt?new Date(g.createdAt).toLocaleDateString('ru'):''}</span>
              </div>
            ))}
          </div>
        ):tab==='settings'?(
          <div>
            <div className="lbl">ИГРОВЫЕ НАСТРОЙКИ</div>
            <div style={{display:'flex',flexDirection:'column',gap:8,marginBottom:14}}>
              {[['maxPlayers','Макс. игроков',2,20,10],['minPlayers','Мин. игроков',2,10,2]].map(([key,label,mn,mx,def])=>(
                <div key={key} style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:8,padding:'10px 14px',display:'flex',alignItems:'center',gap:10}}>
                  <div style={{flex:1}}><div style={{fontSize:13,fontWeight:600}}>{label}</div><div style={{fontSize:10,color:'var(--tx3)'}}>{mn}–{mx}</div></div>
                  <div style={{display:'flex',alignItems:'center',gap:8}}>
                    <button onClick={async()=>{const nv=Math.max(mn,(settings[key]||def)-1);await DB.updateSettings({[key]:nv});setS(p=>({...p,[key]:nv}));await logA('НАСТРОЙКИ',`${label}=${nv}`);}} style={{width:28,height:28,borderRadius:6,background:'rgba(255,255,255,0.1)',border:'1px solid rgba(255,255,255,0.15)',color:'var(--tx)',fontSize:16,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center'}}>−</button>
                    <span style={{fontSize:18,fontWeight:700,color:'var(--a)',minWidth:30,textAlign:'center'}}>{settings[key]||def}</span>
                    <button onClick={async()=>{const nv=Math.min(mx,(settings[key]||def)+1);await DB.updateSettings({[key]:nv});setS(p=>({...p,[key]:nv}));await logA('НАСТРОЙКИ',`${label}=${nv}`);}} style={{width:28,height:28,borderRadius:6,background:'rgba(255,255,255,0.1)',border:'1px solid rgba(255,255,255,0.15)',color:'var(--tx)',fontSize:16,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center'}}>+</button>
                  </div>
                </div>
              ))}
              <Tog on={!!settings.allowUserCreate} onToggle={async()=>{const nv=!settings.allowUserCreate;await DB.updateSettings({allowUserCreate:nv});setS(p=>({...p,allowUserCreate:nv}));await logA('НАСТРОЙКИ',`allowUserCreate=${nv}`);}} label="👥 Разрешить игрокам создавать игры" sub="Если выкл — только администратор может создавать игры"/>
            </div>
            <div className="lbl">КОНТЕНТ</div>
            <Tog on={!!settings.adultMode} onToggle={toggleGlobal}
              label="🔞 ВЗРОСЛЫЙ РЕЖИМ 18+ (ГЛОБАЛЬНО)"
              sub={settings.adultMode?"ВКЛ — все игроки видят переключатель 18+":"ВЫКЛ — 18+ только администраторам"}
              dng/>
            <div className="mono" style={{fontSize:9,color:'var(--tx3)',letterSpacing:1,padding:'8px 14px',background:'var(--s1)',border:'1px solid var(--ab)',lineHeight:1.6}}>
              При включении — переключатель 18+ появляется у всех игроков при создании игры.
            </div>
          </div>
        ):tab==='cheats'?(
          <div>
            <div style={{background:settings.cheatsEnabled?'rgba(191,90,242,0.15)':'rgba(191,90,242,0.08)',border:`1px solid ${settings.cheatsEnabled?'rgba(191,90,242,0.6)':'rgba(191,90,242,0.25)'}`,borderRadius:'var(--rad)',padding:16,marginBottom:14,transition:'.3s'}}>
              <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:8}}>
                <div style={{fontSize:14,fontWeight:700,color:'var(--p)',flex:1}}>🎯 Читерский режим</div>
                <div style={{display:'flex',alignItems:'center',gap:8}}>
                  <span style={{fontSize:10,color:settings.cheatsEnabled?'var(--p)':'var(--tx3)',fontFamily:"'Share Tech Mono',monospace",letterSpacing:1}}>{settings.cheatsEnabled?'ВКЛ':'ВЫКЛ'}</span>
                  <div onClick={async()=>{const v=!settings.cheatsEnabled;await db.ref('settings/cheatsEnabled').set(v);setS(p=>({...p,cheatsEnabled:v}));toast(v?'⚡ Читы включены!':'Читы выключены','ok');}} style={{width:44,height:24,borderRadius:12,background:settings.cheatsEnabled?'var(--p)':'rgba(255,255,255,0.12)',position:'relative',cursor:'pointer',transition:'.3s',flexShrink:0,border:`1px solid ${settings.cheatsEnabled?'var(--p)':'rgba(255,255,255,0.2)'}`}}>
                    <div style={{position:'absolute',top:2,left:settings.cheatsEnabled?20:2,width:18,height:18,borderRadius:'50%',background:'#fff',transition:'left .25s',boxShadow:'0 1px 4px rgba(0,0,0,0.4)'}}/>
                  </div>
                </div>
              </div>
              <div style={{fontSize:12,color:'var(--tx2)',lineHeight:1.6}}>Заменяет твои карты на оптимальные для текущего сценария. Только для администратора.</div>
              {settings.cheatsEnabled&&<div style={{marginTop:8,fontSize:11,color:'var(--p)',background:'rgba(191,90,242,0.12)',borderRadius:8,padding:'6px 10px'}}>⚡ Режим активен — применяй лучшие карты ниже</div>}
            </div>
            <div className="lbl">МОИ ИГРЫ (ЛОББИ И АКТИВНЫЕ)</div>
            {Object.values(games).filter(g=>g.phase!=='finished'&&(g.players?.[me.username]||g.creatorId===me.username)).length===0&&(
              <div style={{textAlign:'center',padding:24,color:'var(--tx3)',fontSize:13}}>Ты не участвуешь ни в одной игре<br/><span style={{fontSize:11}}>Создай игру или вступи в лобби</span></div>
            )}
            {Object.values(games).filter(g=>g.phase!=='finished'&&(g.players?.[me.username]||g.creatorId===me.username)).map(g=>{
              const scenId=g.apocalypse?.id;
              const best=BEST_CARDS_BY_SCENARIO[scenId];
              const isLobby=g.phase==='lobby';
              const inGame=!!g.players?.[me.username];
              const phaseLabel=isLobby?'🔵 ЛОББИ':g.phase==='playing'?'🟢 В ИГРЕ':g.phase==='voting'?'🔴 ГОЛОСОВАНИЕ':g.phase==='debates'?'🟡 ДЕБАТЫ':'⚪';
              return(
                <div key={g.id} style={{background:'rgba(255,255,255,0.04)',border:`1px solid ${isLobby?'rgba(10,132,255,0.3)':'rgba(255,255,255,0.08)'}`,borderRadius:'var(--rad)',padding:16,marginBottom:10}}>
                  <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:4}}>
                    <div style={{fontWeight:700,fontSize:15,color:'var(--a)',flex:1}}>{g.apocalypse?.emoji||'🎮'} {g.apocalypse?.name||g.id}</div>
                    <span style={{fontSize:9,color:isLobby?'var(--c)':'var(--g)',fontFamily:"'Share Tech Mono',monospace",letterSpacing:1}}>{phaseLabel}</span>
                  </div>
                  <div style={{fontSize:11,color:'var(--tx3)',marginBottom:10}}>Код: <b style={{color:'var(--tx2)'}}>{g.id}</b> · {Object.keys(g.players||{}).length} игроков{!inGame&&<span style={{color:'var(--p)',marginLeft:6}}>· ты создатель</span>}</div>
                  {isLobby&&!inGame&&(
                    <div style={{background:'rgba(10,132,255,0.08)',border:'1px solid rgba(10,132,255,0.2)',borderRadius:'var(--rad-sm)',padding:'8px 12px',marginBottom:10,fontSize:12,color:'var(--c)'}}>
                      ℹ️ Ты создатель, но не добавлен в игру. Карты будут применены когда ты вступишь.
                    </div>
                  )}
                  {!scenId&&isLobby&&(
                    <div style={{background:'rgba(240,165,0,0.08)',border:'1px solid rgba(240,165,0,0.2)',borderRadius:'var(--rad-sm)',padding:'8px 12px',marginBottom:10,fontSize:12,color:'var(--a)'}}>
                      ⚠️ Сценарий ещё не выбран. Карты можно применить после старта игры.
                    </div>
                  )}
                  {best?(
                    <>
                      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6,marginBottom:10}}>
                        {Object.entries(best).map(([key,val])=>{
                          const card=CARDS.find(c=>c.key===key);
                          return(
                            <div key={key} style={{background:'rgba(191,90,242,0.06)',border:'1px solid rgba(191,90,242,0.2)',borderRadius:'var(--rad-sm)',padding:'8px 10px'}}>
                              <div style={{fontSize:9,color:'var(--p)',fontWeight:600,letterSpacing:1,marginBottom:3}}>{card?.icon} {card?.label||key}</div>
                              <div style={{fontSize:11,color:'var(--tx)'}}>{Array.isArray(val)?val[1]:typeof val==='object'&&val!==null&&'1' in val?`${val[0]} ${val[1]}`:val}</div>
                            </div>
                          );
                        })}
                      </div>
                      {!settings.cheatsEnabled&&<div style={{fontSize:11,color:'var(--r)',background:'rgba(255,69,58,0.08)',border:'1px solid rgba(255,69,58,0.2)',borderRadius:8,padding:'7px 12px',marginBottom:8}}>🔒 Включи читерский режим выше чтобы применить карты</div>}
                      <Btn ch={isLobby?"⚡ Применить карты (старт игры)":"⚡ Применить лучшие карты"} cls="btn-pu" sm disabled={!settings.cheatsEnabled} onClick={async()=>{
                        if(!settings.cheatsEnabled)return toast('Сначала включи читерский режим','err');
                        if(!confirm(`Заменить твои карты в игре "${g.apocalypse?.name||g.id}" на лучшие?`))return;
                        if(!inGame){
                          // Добавляем admin как игрока с лучшими картами
                          await DB.updateGame(g.id,{[`players/${me.username}`]:{userId:me.username,username:me.username,name:me.displayName||me.username,cards:best,revealed:[],isEliminated:false}});
                        } else {
                          await DB.updateGame(g.id,{[`players/${me.username}/cards`]:best});
                        }
                        toast('✅ Лучшие карты применены!','ok');
                        await load();
                      }}/>
                    </>
                  ):scenId?(
                    <div style={{fontSize:12,color:'var(--tx3)'}}>Нет предустановленных карт для этого сценария</div>
                  ):null}
                </div>
              );
            })}
            <div className="lbl">ЛУЧШИЕ КАРТЫ ПО СЦЕНАРИЯМ</div>
            {APOC.map(sc=>{
              const best=BEST_CARDS_BY_SCENARIO[sc.id];
              if(!best)return null;
              return(
                <div key={sc.id} style={{background:'rgba(255,255,255,0.03)',border:'1px solid rgba(255,255,255,0.07)',borderRadius:'var(--rad)',padding:14,marginBottom:8}}>
                  <div style={{fontWeight:700,fontSize:13,color:'var(--tx)',marginBottom:8}}>{sc.emoji} {sc.name}</div>
                  <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:4}}>
                    {Object.entries(best).map(([key,val])=>{
                      const card=CARDS.find(c=>c.key===key);
                      return(
                        <div key={key} style={{fontSize:10,color:'var(--tx2)'}}>
                          <span style={{color:'var(--tx3)'}}>{card?.icon} {card?.label}: </span>
                          {Array.isArray(val)?val[1]:typeof val==='object'&&val!==null&&'1' in val?`${val[0]} ${val[1]}`:val}
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        ):tab==='users'?(
          <div>
            {/* Mass actions */}
            {Object.keys(selected).filter(k=>selected[k]).length>0&&(
              <div style={{background:'rgba(255,165,0,0.1)',border:'1px solid rgba(255,165,0,0.3)',borderRadius:8,padding:'10px 14px',marginBottom:12}}>
                <div style={{fontSize:12,color:'var(--a)',fontWeight:700,marginBottom:8}}>
                  ⚠️ Выбрано: {Object.keys(selected).filter(k=>selected[k]).length} игроков
                </div>
                <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
                  <Btn ch="🔄 Сбросить пароли" sm cls="btn-c" onClick={async()=>{
                    const sel=Object.keys(selected).filter(k=>selected[k]);
                    if(!confirm(`Сбросить пароли ${sel.length} игрокам на "bunker123"?`))return;
                    await Promise.all(sel.map(u=>DB.updateUser(u,{password:'bunker123'})));
                    await logA('СБРОС ПАРОЛЕЙ',sel.join(', '));
                    toast('✅ Пароли сброшены на bunker123','ok');setSelected({});await load();
                  }}/>
                  <Btn ch="📊 Сбросить Эло" sm cls="btn-c" onClick={async()=>{
                    const sel=Object.keys(selected).filter(k=>selected[k]);
                    if(!confirm(`Сбросить Эло ${sel.length} игрокам до 1000?`))return;
                    await Promise.all(sel.map(u=>DB.updateUser(u,{elo:1000,eloGames:0,eloDelta:0})));
                    await logA('СБРОС ЭЛО',sel.join(', '));
                    toast('✅ Эло сброшено до 1000','ok');setSelected({});await load();
                  }}/>
                  <Btn ch="✕ Снять выделение" sm cls="btn-g" onClick={()=>setSelected({})}/>
                </div>
              </div>
            )}
            {/* Ban modal */}
            {banTarget&&(
              <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.8)',zIndex:200,display:'flex',alignItems:'center',justifyContent:'center',padding:20}} onClick={e=>{if(e.target===e.currentTarget){setBanTarget(null);setBanReason('');}}}>
                <div style={{background:'var(--bg)',border:'1px solid rgba(255,69,58,0.4)',borderRadius:'var(--rad-lg)',padding:24,width:'100%',maxWidth:340}}>
                  <div style={{fontSize:16,fontWeight:700,color:'var(--r)',marginBottom:4}}>🚫 Заблокировать игрока</div>
                  <div style={{fontSize:13,color:'var(--tx2)',marginBottom:14}}>@{banTarget}</div>
                  <input className="inp" placeholder="Причина бана..." value={banReason} onChange={e=>setBanReason(e.target.value)} maxLength={100}/>
                  <div style={{display:'flex',gap:8,marginTop:12}}>
                    <Btn ch="🚫 Заблокировать" cls="btn-d" onClick={async()=>{
                      if(banTarget===me.username)return toast('Нельзя забанить себя','err');
                      await DB.banUser(banTarget,banReason||'Нарушение правил',me.username);
                      await logA('БАН',`@${banTarget}: ${banReason||'Нарушение правил'}`);
                      toast(`✅ @${banTarget} заблокирован`,'ok');
                      setBanTarget(null);setBanReason('');await load();
                    }}/>
                    <Btn ch="Отмена" cls="btn-g" sm onClick={()=>{setBanTarget(null);setBanReason('');}}/>
                  </div>
                </div>
              </div>
            )}
            {Object.values(users).map(u=>(
          <div key={u.username} className="adm-row">
            <div style={{flex:'1 1 130px',minWidth:0}}>
              <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:4,flexWrap:'wrap'}}>
                <span style={{fontWeight:700,fontSize:14}}>{u.displayName||u.username}</span>
                {u.isAdmin&&<span className="bdg bdg-p" style={{fontSize:7}}>ADMIN</span>}
                {u.isBanned&&<span style={{fontSize:7,background:'rgba(255,69,58,0.15)',border:'1px solid rgba(255,69,58,0.4)',color:'var(--r)',borderRadius:4,padding:'1px 5px',fontWeight:700,letterSpacing:1}}>🚫 БАН</span>}
                {u.username===me.username&&<span className="bdg bdg-c" style={{fontSize:7}}>ВЫ</span>}
              </div>
              <div className="mono" style={{fontSize:8,color:'var(--tx3)'}}>@{u.username} · {u.gamesPlayed||0} игр</div>
              <div style={{marginTop:4}}><RChip user={u}/></div>
            </div>
            <div style={{display:'flex',gap:6,flexWrap:'wrap',alignItems:'center'}}>
              <select className="sel" style={{width:'auto',padding:'4px 8px',fontSize:11,marginBottom:0}} value={u.customRank||'auto'} onChange={e=>setRank(u.username,e.target.value==='auto'?null:e.target.value)}>
                <option value="auto">Авто</option>
                {RANKS.map(r=><option key={r.id} value={r.id}>{r.icon} {r.name}</option>)}
              </select>
              <button onClick={()=>{setEditDisplayName(u.displayName||u.username);setEditPassword('');setEditElo(String(u.elo||1000));setShowPass(false);setEditUser(u);}} style={{background:'rgba(10,132,255,.1)',border:'1px solid rgba(10,132,255,.3)',color:'var(--c)',fontFamily:"'Inter',sans-serif",fontSize:10,padding:'4px 8px',cursor:'pointer',borderRadius:6}}>✏️</button>
              {u.username!==me.username&&<>
                <button onClick={()=>toggleAdmin(u.username)} style={{background:u.isAdmin?'var(--rt)':'rgba(155,89,239,.1)',border:`1px solid ${u.isAdmin?'var(--r)':'rgba(155,89,239,.4)'}`,color:u.isAdmin?'var(--r)':'var(--p)',fontFamily:"'Inter',sans-serif",fontSize:9,padding:'4px 8px',cursor:'pointer',letterSpacing:1}}>
                  {u.isAdmin?'СНЯТЬ':'ADMIN'}
                </button>
                <input type="checkbox" checked={!!selected[u.username]} onChange={e=>setSelected(s=>({...s,[u.username]:e.target.checked}))} style={{width:16,height:16,cursor:'pointer',accentColor:'var(--a)'}}/>
                {u.isBanned
                  ?<button onClick={async()=>{await DB.unbanUser(u.username);await logA('РАЗБАН',`@${u.username}`);toast(`✅ @${u.username} разблокирован`,'ok');await load();}} style={{background:'rgba(48,209,88,0.1)',border:'1px solid rgba(48,209,88,0.3)',color:'var(--g)',fontFamily:"'Inter',sans-serif",fontSize:10,padding:'4px 8px',cursor:'pointer',borderRadius:6}}>✅ Разбан</button>
                  :<button onClick={()=>{if(u.username===me.username)return toast('Нельзя забанить себя','err');setBanTarget(u.username);setBanReason('');}} style={{background:'rgba(255,69,58,0.1)',border:'1px solid rgba(255,69,58,0.3)',color:'var(--r)',fontFamily:"'Inter',sans-serif",fontSize:10,padding:'4px 8px',cursor:'pointer',borderRadius:6}}>🚫 Бан</button>
                }
                <button onClick={()=>delUser(u.username)} style={{background:'var(--rt)',border:'1px solid var(--rb)',color:'var(--r)',fontFamily:"'Inter',sans-serif",fontSize:11,padding:'4px 8px',cursor:'pointer'}}>✕</button>
              </>}
            </div>
          </div>
          ))}
          </div>
        ):null}
      </div>
      {editUser&&(
        <div className="modal-bg" onClick={()=>setEditUser(null)}>
          <div className="modal-box" onClick={e=>e.stopPropagation()} style={{maxHeight:'85vh'}}>
            <div className="modal-hd">
              <div className="modal-ttl">✏️ {editUser.displayName||editUser.username}</div>
              <button className="modal-cls" onClick={()=>setEditUser(null)}>✕</button>
            </div>
            <div className="modal-bd">
              <div className="lbl">УЧЁТНЫЕ ДАННЫЕ</div>
              <div style={{background:'rgba(10,132,255,0.08)',border:'1px solid rgba(10,132,255,0.25)',borderRadius:'var(--rad-sm)',padding:'12px 14px',marginBottom:10}}>
                <div style={{fontSize:10,color:'var(--c)',fontWeight:600,letterSpacing:1,marginBottom:6}}>🔐 ЛОГИН (USERNAME)</div>
                <div style={{fontFamily:"'Share Tech Mono',monospace",fontSize:16,color:'var(--tx)',letterSpacing:2}}>{editUser.username}</div>
              </div>
              <div style={{background:'rgba(191,90,242,0.08)',border:'1px solid rgba(191,90,242,0.25)',borderRadius:'var(--rad-sm)',padding:'12px 14px',marginBottom:14}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:6}}>
                  <div style={{fontSize:10,color:'var(--p)',fontWeight:600,letterSpacing:1}}>🔑 ПАРОЛЬ</div>
                  <button onClick={()=>setShowPass(p=>!p)} style={{background:'rgba(255,255,255,0.1)',border:'none',color:'var(--tx2)',fontSize:11,padding:'3px 10px',borderRadius:6,cursor:'pointer'}}>{showPass?'🙈 Скрыть':'👁 Показать'}</button>
                </div>
                <div style={{fontFamily:"'Share Tech Mono',monospace",fontSize:16,color:'var(--tx)',letterSpacing:2}}>
                  {showPass ? editUser.password : '••••••••'}
                </div>
              </div>
              <div className="lbl">РЕДАКТИРОВАТЬ</div>
              <input className="inp" placeholder="Отображаемое имя" value={editDisplayName} onChange={e=>setEditDisplayName(e.target.value)} maxLength={30}/>
              <input className="inp" placeholder="Новый пароль (оставить пустым — не менять)" type="text" value={editPassword} onChange={e=>setEditPassword(e.target.value)} maxLength={50}/>
              <div style={{display:'flex',alignItems:'center',gap:8,marginTop:4}}>
                <span style={{fontSize:12,color:'var(--tx2)',whiteSpace:'nowrap'}}>🏅 Очки Эло:</span>
                <input className="inp" type="number" min="0" max="9999" placeholder="1000" value={editElo} onChange={e=>setEditElo(e.target.value)} style={{flex:1}}/>
                <div style={{display:'flex',gap:4}}>
                  <button onClick={()=>setEditElo(String(Math.max(0,(parseInt(editElo)||0)-50)))} style={{background:'var(--rt)',border:'1px solid var(--r)',color:'var(--r)',fontFamily:"'Inter',sans-serif",fontSize:13,fontWeight:700,padding:'4px 10px',borderRadius:6,cursor:'pointer'}}>−50</button>
                  <button onClick={()=>setEditElo(String((parseInt(editElo)||0)+50))} style={{background:'var(--gt)',border:'1px solid var(--g)',color:'var(--g)',fontFamily:"'Inter',sans-serif",fontSize:13,fontWeight:700,padding:'4px 10px',borderRadius:6,cursor:'pointer'}}>+50</button>
                </div>
              </div>
              <Btn ch="💾 Сохранить" onClick={async()=>{
                const patch={};
                if(editDisplayName.trim()) patch.displayName=editDisplayName.trim();
                if(editPassword.trim()) patch.password=editPassword.trim();
                const eloVal=parseInt(editElo);
                if(!isNaN(eloVal)&&eloVal>=0&&eloVal<=9999) patch.elo=eloVal;
                if(Object.keys(patch).length===0){toast('Нечего сохранять','err');return;}
                await DB.updateUser(editUser.username,patch);
                setU(p=>({...p,[editUser.username]:{...p[editUser.username],...patch}}));
                setEditUser(null);
                toast('✅ Сохранено!','ok');
              }}/>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   CREATE GAME
══════════════════════════════════════════════════════════ */
function CreateGameScreen({user,onBack,onCreated,toast}){
  const[sel,setSel]=useState(null);
  const[adult,setAdult]=useState(false);
  const[globalAdult,setGA]=useState(false);
  const[loading,setL]=useState(false);
  const[maxRev,setMaxRev]=useState(2);
  const[autoVote,setAutoVote]=useState(false);
  const[matchmaking,setMatchmaking]=useState(false);
  const[debatesOn,setDebates]=useState(false);
  const[voteHistoryOn,setVoteHistory]=useState(false);
  const[rolesOn,setRoles]=useState(false);
  const[radioOn,setRadio]=useState(false);
  const[bunkerMapOn,setBunkerMap]=useState(false);
  const[roundTimer,setRoundTimer]=useState(0);
  const[isRated,setIsRated]=useState(false);

  useEffect(()=>{
    DB.getSettings().then(s=>{if(s.adultMode)setGA(true);});
  },[]);

  const canAdult=user.isAdmin||globalAdult;

  const create=async()=>{
    if(!sel)return toast('Выберите сценарий','err');
    setL(true);
    const gid=genCode();
    const ap=sel==='random'?rnd(APOC):APOC.find(a=>a.id===sel);
    await DB.setGame(gid,{
      id:gid,creatorId:user.username,adultMode:adult,apocalypse:ap,
      phase:'lobby',round:1,bunkerSpots:1,
      maxReveals:maxRev,autoVote,matchmaking,
      debates:debatesOn,voteHistory:voteHistoryOn,roles:rolesOn,radio:radioOn,bunkerMap:bunkerMapOn,
      roundTimerSeconds:roundTimer>0?roundTimer*60:0,
      isRated,
      players:{[user.username]:{userId:user.username,username:user.username,name:user.displayName||user.username,cards:null,revealed:[],isEliminated:false}},
      votes:{},revealedThisRound:{},eliminated:[],lastEliminated:null,createdAt:Date.now(),
    });
    setL(false);onCreated(gid);
  };

  return(
    <div className="sc">
      <HZ/>
      <div className="tb"><BackBtn onClick={onBack}/><div className="tb-title">НОВАЯ ИГРА</div></div>
      <div className="scr-raw" style={{paddingBottom:90}}>
        <div className="lbl">СЦЕНАРИЙ АПОКАЛИПСИСА</div>
        <div className={`ap-opt${sel==='random'?' on':''}`} onClick={()=>setSel('random')}>
          <span style={{fontSize:30}}>🎲</span>
          <div>
            <div style={{fontFamily:"'Inter',sans-serif",fontSize:18,letterSpacing:2}}>СЛУЧАЙНЫЙ</div>
            <div style={{fontSize:11,color:'var(--tx3)'}}>Судьба решит за вас</div>
          </div>
        </div>
        {APOC.map(ap=>(
          <div key={ap.id} className={`ap-opt${sel===ap.id?' on':''}`} onClick={()=>setSel(ap.id)}>
            <span style={{fontSize:30}}>{ap.emoji}</span>
            <div style={{flex:1}}>
              <div style={{fontFamily:"'Inter',sans-serif",fontSize:18,letterSpacing:2,color:sel===ap.id?'var(--a)':'var(--tx)'}}>{ap.name}</div>
              <div style={{fontSize:11,color:'var(--tx3)',lineHeight:1.4,marginTop:2}}>{ap.description.slice(0,80)}…</div>
              <div style={{fontSize:10,color:'var(--a)',marginTop:4}}>🎯 {ap.victory}</div>
            </div>
          </div>
        ))}
        {canAdult&&(
          <>
            <div className="lbl">{!user.isAdmin&&<span style={{color:'var(--tx3)',fontSize:8}}>(разрешено администратором)</span>}</div>
            <Tog on={adult} onToggle={()=>setAdult(!adult)} label="🔞 ВЗРОСЛЫЙ РЕЖИМ (18+)" sub="Специальные карты для взрослой компании" dng/>
          </>
        )}
        <div className="lbl">НАСТРОЙКИ РАУНДА</div>
        <div style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad)',padding:16,marginBottom:10}}>
          <div style={{fontSize:13,fontWeight:600,color:'var(--tx)',marginBottom:10}}>🃏 Карт для раскрытия за раунд</div>
          <div style={{display:'flex',gap:8}}>
            {[1,2,3,4].map(n=>(
              <button key={n} onClick={()=>setMaxRev(n)} style={{flex:1,padding:'11px 0',borderRadius:'var(--rad-sm)',border:'none',background:maxRev===n?'var(--a)':'rgba(255,255,255,0.08)',color:maxRev===n?'#000':'var(--tx)',fontFamily:"'Inter',sans-serif",fontSize:17,fontWeight:700,cursor:'pointer',transition:'.15s'}}>
                {n}
              </button>
            ))}
          </div>
          <div style={{fontSize:11,color:'var(--tx3)',marginTop:8}}>Сколько карт каждый игрок может открыть за раунд</div>
        </div>
        <Tog on={autoVote} onToggle={()=>setAutoVote(v=>!v)} label="🗳 Автоголосование" sub="Голосование начнётся само, как только все выложат карты за раунд"/>
        <div className="lbl">ПОДБОР ИГРОКОВ</div>
        <Tog on={matchmaking} onToggle={()=>setMatchmaking(v=>!v)} label="🔍 Открытый подбор" sub="Игру увидят все — любой сможет присоединиться с главного экрана"/>
        <div className="lbl">⚙️ ДОПОЛНИТЕЛЬНЫЕ МЕХАНИКИ</div>
        <Tog on={debatesOn} onToggle={()=>setDebates(v=>!v)} label="🎤 Дебаты" sub="Перед голосованием — таймер 60 сек для защитной речи каждого"/>
        <Tog on={voteHistoryOn} onToggle={()=>setVoteHistory(v=>!v)} label="📊 История голосований" sub="После раунда все видят кто за кого голосовал"/>
        <Tog on={rolesOn} onToggle={()=>setRoles(v=>!v)} label="🎭 Роли" sub="Лидер, Саботажник, Медик — скрытые роли раскрываются в финале"/>
        <Tog on={radioOn} onToggle={()=>setRadio(v=>!v)} label="📡 Радиопереговоры" sub="Приватный чат между любыми двумя игроками во время раунда"/>
        <Tog on={bunkerMapOn} onToggle={()=>setBunkerMap(v=>!v)} label="🗺️ Карта бункера" sub="Комнаты бункера дают бонусы игрокам с подходящей профессией"/>
        <Tog on={isRated} onToggle={()=>setIsRated(v=>!v)} label="🏅 Рейтинговая игра" sub="Победители получают очки Эло, проигравшие теряют. Влияет на рейтинг в таблице лидеров"/>
        <div className="lbl">⏱ ТАЙМЕР РАУНДА</div>
        <div style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad)',padding:16,marginBottom:10}}>
          <div style={{fontSize:13,fontWeight:600,color:'var(--tx)',marginBottom:10}}>Автоматически начинать голосование через:</div>
          <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
            {[[0,'Выкл.'],[1,'1 мин'],[2,'2 мин'],[3,'3 мин'],[5,'5 мин'],[10,'10 мин']].map(([n,lbl])=>(
              <button key={n} onClick={()=>setRoundTimer(n)} style={{flex:'1 1 auto',padding:'10px 6px',borderRadius:'var(--rad-sm)',border:'none',background:roundTimer===n?'var(--a)':'rgba(255,255,255,0.08)',color:roundTimer===n?'#000':'var(--tx)',fontFamily:"'Inter',sans-serif",fontSize:13,fontWeight:700,cursor:'pointer',transition:'.15s',minWidth:60}}>
                {lbl}
              </button>
            ))}
          </div>
          {roundTimer>0&&<div style={{fontSize:11,color:'var(--tx3)',marginTop:8}}>Голосование начнётся автоматически через {roundTimer} мин после начала раунда</div>}
        </div>
      </div>
      <div className="fixbot" style={{bottom:0}}>
        <Btn ch={loading?'⏳ СОЗДАНИЕ…':'☢ СОЗДАТЬ ИГРУ'} onClick={create} disabled={loading||!sel}/>
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   JOIN GAME
══════════════════════════════════════════════════════════ */
/* ══════════════════════════════════════════════════════════
   MATCHMAKING SCREEN
══════════════════════════════════════════════════════════ */
function MatchmakingScreen({user,onBack,onJoined,toast}){
  const[games,setGames]=useState({});
  const[joining,setJoining]=useState(null);

  useEffect(()=>{
    const ref=db.ref('games');
    const handler=ref.on('value',snap=>{
      const all=snap.val()||{};
      // Показываем только lobby-игры с matchmaking=true, где игрока ещё нет
      const open={};
      Object.values(all).forEach(g=>{
        if(g.phase==='lobby'&&g.matchmaking&&!g.players?.[user.username])
          open[g.id]=g;
      });
      setGames(open);
    });
    return()=>ref.off('value',handler);
  },[]);

  const join=async(gid)=>{
    if(joining)return;
    setJoining(gid);
    const g=await DB.getGame(gid);
    if(!g||g.phase!=='lobby'){toast('Игра уже началась','err');setJoining(null);return;}
    if(g.players?.[user.username]){onJoined(gid);return;}
    await DB.updateGame(gid,{[`players/${user.username}`]:{userId:user.username,username:user.username,name:user.displayName||user.username,cards:null,revealed:[],isEliminated:false}});
    setJoining(null);
    onJoined(gid);
  };

  const list=Object.values(games).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

  return(
    <div className="sc">
      <HZ/>
      <div className="tb"><BackBtn onClick={onBack}/><div className="tb-title">ПОДБОР ИГРОКОВ</div><div style={{fontSize:11,color:'var(--tx3)',fontWeight:500}}>{list.length} игр</div></div>
      <div className="scr" style={{paddingBottom:20}}>
        {list.length===0?(
          <div style={{textAlign:'center',padding:'60px 20px'}}>
            <div style={{fontSize:48,marginBottom:16}}>🔍</div>
            <div style={{fontSize:17,fontWeight:600,color:'var(--tx)',marginBottom:8}}>Нет открытых игр</div>
            <div style={{fontSize:13,color:'var(--tx3)',lineHeight:1.6}}>Создайте игру с режимом «Открытый подбор», чтобы любой мог присоединиться</div>
            <div style={{marginTop:24}}><Btn ch="☢ СОЗДАТЬ ИГРУ" onClick={()=>onBack()} cls="btn-p" sm/></div>
          </div>
        ):list.map(g=>{
          const players=Object.values(g.players||{});
          const ap=g.apocalypse||{};
          const isJoining=joining===g.id;
          return(
            <div key={g.id} style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:'var(--rad)',padding:16,marginBottom:10}}>
              <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:10}}>
                <span style={{fontSize:28}}>{ap.emoji||'☢'}</span>
                <div style={{flex:1}}>
                  <div style={{fontSize:15,fontWeight:700,color:'var(--tx)'}}>{ap.name||'Игра'}</div>
                  <div style={{fontSize:11,color:'var(--tx3)',marginTop:2}}>Создатель: {g.creatorId} · {players.length} игрок{players.length===1?'':'а'}</div>
                </div>
                {g.adultMode&&<span style={{fontSize:10,color:'var(--r)',background:'rgba(255,69,58,0.12)',borderRadius:6,padding:'2px 8px',fontWeight:700}}>18+</span>}
              </div>
              <div style={{display:'flex',gap:6,alignItems:'center',marginBottom:12,flexWrap:'wrap'}}>
                <span style={{fontSize:11,color:'var(--tx3)'}}>🃏 {g.maxReveals||2} карты/раунд</span>
                {g.autoVote&&<span style={{fontSize:11,color:'var(--g)',background:'rgba(48,209,88,0.1)',borderRadius:6,padding:'2px 8px',fontWeight:600}}>🗳 Авто-голос</span>}
              </div>
              <div style={{display:'flex',gap:6,marginBottom:12,flexWrap:'wrap'}}>
                {players.slice(0,8).map(p=>(
                  <div key={p.username} style={{fontSize:11,color:'var(--tx2)',background:'rgba(255,255,255,0.07)',borderRadius:20,padding:'3px 10px'}}>{p.name}</div>
                ))}
                {players.length>8&&<div style={{fontSize:11,color:'var(--tx3)',padding:'3px 6px'}}>+{players.length-8}</div>}
              </div>
              <button onClick={()=>join(g.id)} disabled={!!isJoining} style={{width:'100%',padding:'12px',borderRadius:'var(--rad-sm)',border:'none',background:isJoining?'rgba(255,255,255,0.1)':'var(--a)',color:isJoining?'var(--tx3)':'#000',fontSize:14,fontWeight:700,cursor:isJoining?'not-allowed':'pointer',transition:'.2s',fontFamily:"'Inter',sans-serif"}}>
                {isJoining?'⏳ Вхожу…':'⚡ ПРИСОЕДИНИТЬСЯ'}
              </button>
            </div>
          );
        })}
      </div>
    </div>
  );
}

function JoinGameScreen({user,onBack,onJoined,toast}){
  const[code,setC]=useState('');
  const[loading,setL]=useState(false);
  const join=async()=>{
    const c=code.trim().toUpperCase();
    if(c.length!==6)return toast('Код: ровно 6 символов','err');
    setL(true);
    const game=await DB.getGame(c);
    if(!game){setL(false);return toast('Игра не найдена','err');}
    if(game.phase!=='lobby'){setL(false);return toast('Игра уже началась','err');}
    if(game.players?.[user.username]){setL(false);return onJoined(c);}
    if(Object.keys(game.players||{}).length>=16){setL(false);return toast('Комната заполнена','err');}
    await DB.updateGame(c,{[`players/${user.username}`]:{userId:user.username,username:user.username,name:user.displayName||user.username,cards:null,revealed:[],isEliminated:false}});
    DB.logEvent(c,'join',`${user.displayName||user.username} присоединился к игре`,user.username);
    setL(false);onJoined(c);
  };
  return(
    <div className="sc">
      <HZ/>
      <div className="tb"><BackBtn onClick={onBack}/><div className="tb-title">ВОЙТИ В ИГРУ</div></div>
      <div style={{flex:1,display:'flex',flexDirection:'column',justifyContent:'center',padding:'0 20px',gap:20}}>
        <div style={{textAlign:'center'}}>
          <div style={{fontSize:52,marginBottom:8}}>🔑</div>
          <div style={{fontFamily:"'Inter',sans-serif",fontSize:26,letterSpacing:4,color:'var(--a)'}}>КОД КОМНАТЫ</div>
          <div className="mono" style={{fontSize:10,color:'var(--tx3)',letterSpacing:2,marginTop:4}}>ВВЕДИТЕ 6-СИМВОЛЬНЫЙ КОД</div>
        </div>
        <input className="inp" value={code} onChange={e=>setC(e.target.value.toUpperCase())} maxLength={6}
          placeholder="XXXXXX" style={{textAlign:'center',fontSize:30,letterSpacing:2,fontFamily:"'Inter',sans-serif",marginBottom:0}}
          onKeyDown={e=>e.key==='Enter'&&join()}/>
        <Btn ch={loading?'⏳ ПОИСК…':'⚡ ВОЙТИ В БУНКЕР'} onClick={join} disabled={loading||code.trim().length!==6}/>
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   LOBBY
══════════════════════════════════════════════════════════ */
/* ══════════════════════════════════════════════════════════
   ADMIN CHEAT PANEL — быстрый доступ к читам из лобби/игры
══════════════════════════════════════════════════════════ */
function AdminCheatPanel({gameId,game,user,toast,phase}){
  const[open,setOpen]=useState(false);
  const[enabled,setEnabled]=useState(false);
  const[applying,setApplying]=useState(false);
  const[loaded,setLoaded]=useState(false);

  useEffect(()=>{
    // Подписываемся на изменения — реагируем на включение/выключение в AdminPanel
    const r=db.ref('settings/cheatsEnabled');
    const handler=s=>{setEnabled(!!s.val());setLoaded(true);};
    r.on('value',handler);
    return()=>r.off('value',handler);
  },[]);

  if(!game)return null;
  // Скрываем панель если читы выключены в AdminPanel
  if(loaded&&!enabled)return null;
  const ap=game.apocalypse;
  const scenId=ap?.id;
  const best=scenId&&BEST_CARDS_BY_SCENARIO[scenId];
  const inGame=!!(game.players&&game.players[user.username]);

  const toggleEnabled=async()=>{
    const nv=!enabled;
    setEnabled(nv);
    await db.ref('settings/cheatsEnabled').set(nv);
    toast(nv?'⚡ Читы включены!':'🔒 Читы выключены','ok');
  };

  const applyBest=async()=>{
    if(!enabled)return toast('Сначала включи читы','err');
    if(!best)return toast('Нет лучших карт для этого сценария','err');
    if(!confirm(`Применить лучшие карты для "${ap?.name||'?'}"?`))return;
    setApplying(true);
    try{
      if(!inGame){
        await DB.updateGame(gameId,{[`players/${user.username}`]:{userId:user.username,username:user.username,name:user.displayName||user.username,cards:best,revealed:[],isEliminated:false}});
      } else {
        await DB.updateGame(gameId,{[`players/${user.username}/cards`]:best});
      }
      toast('✅ Лучшие карты применены!','ok');
      setOpen(false);
    }catch(e){toast('Ошибка: '+e.message,'err');}
    setApplying(false);
  };

  return(
    <div style={{marginBottom:4}}>
      <button onClick={()=>setOpen(o=>!o)} style={{
        width:'100%',display:'flex',alignItems:'center',justifyContent:'space-between',
        background:enabled?'rgba(191,90,242,0.13)':'rgba(255,255,255,0.04)',
        border:`1px solid ${enabled?'rgba(191,90,242,0.4)':'rgba(255,255,255,0.1)'}`,
        borderRadius:'var(--rad-sm)',padding:'9px 14px',cursor:'pointer',transition:'.2s',
        fontFamily:"'Inter',sans-serif",
      }}>
        <span style={{fontSize:13,fontWeight:700,color:enabled?'var(--p)':'var(--tx3)',letterSpacing:1}}>
          {enabled?'⚡':'🔒'} ЧИТЫ {enabled?'ВКЛ':'ВЫКЛ'}
        </span>
        <span style={{fontSize:16,color:'var(--tx3)',transform:open?'rotate(180deg)':'none',transition:'.2s'}}>▾</span>
      </button>
      {open&&(
        <div style={{
          background:'rgba(191,90,242,0.06)',border:'1px solid rgba(191,90,242,0.2)',
          borderTop:'none',borderRadius:'0 0 var(--rad-sm) var(--rad-sm)',padding:'12px 14px',
        }}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:10}}>
            <span style={{fontSize:12,color:'var(--tx2)'}}>Читерский режим</span>
            <button onClick={toggleEnabled} style={{
              background:enabled?'rgba(191,90,242,0.3)':'rgba(255,255,255,0.07)',
              border:`1px solid ${enabled?'rgba(191,90,242,0.6)':'rgba(255,255,255,0.15)'}`,
              borderRadius:20,padding:'5px 16px',cursor:'pointer',fontSize:12,fontWeight:700,
              color:enabled?'var(--p)':'var(--tx3)',fontFamily:"'Inter',sans-serif",transition:'.2s',
            }}>{enabled?'● ВКЛ':'○ ВЫКЛ'}</button>
          </div>
          {!best?(
            <div style={{fontSize:11,color:'var(--tx3)',textAlign:'center',padding:'8px 0'}}>
              Сценарий не выбран — лучшие карты недоступны
            </div>
          ):(
            <>
              <div style={{fontSize:11,color:'var(--tx2)',marginBottom:8}}>
                Сценарий: <span style={{color:'var(--p)',fontWeight:700}}>{ap?.emoji} {ap?.name}</span>
              </div>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:4,marginBottom:10}}>
                {Object.entries(best).filter(([k])=>k!=='secret').map(([k,v])=>{
                  const lbl={gender_age:'Пол/Возраст',profession:'Профессия',health:'Здоровье',hobby:'Хобби',baggage:'Багаж',fact:'Факт'}[k]||k;
                  const txt=typeof v==='object'&&v!==null&&'1' in v?`${v[0]} ${v[1]}`:v;
                  return(
                    <div key={k} style={{background:'rgba(0,0,0,0.15)',borderRadius:6,padding:'5px 8px'}}>
                      <div style={{fontSize:9,color:'var(--tx3)',letterSpacing:1,marginBottom:2}}>{lbl.toUpperCase()}</div>
                      <div style={{fontSize:10,color:'var(--tx)',fontWeight:600}}>{txt}</div>
                    </div>
                  );
                })}
              </div>
              <button onClick={applyBest} disabled={applying||!enabled} style={{
                width:'100%',background:enabled?'rgba(191,90,242,0.2)':'rgba(255,255,255,0.05)',
                border:`1px solid ${enabled?'rgba(191,90,242,0.5)':'rgba(255,255,255,0.1)'}`,
                borderRadius:'var(--rad-sm)',padding:'10px',cursor:enabled?'pointer':'not-allowed',
                color:enabled?'var(--p)':'var(--tx3)',fontFamily:"'Inter',sans-serif",
                fontSize:13,fontWeight:700,letterSpacing:1,transition:'.2s',
              }}>
                {applying?'⏳ ПРИМЕНЯЮ...':phase==='lobby'?'⚡ ПРИМЕНИТЬ ДО СТАРТА':'⚡ ПРИМЕНИТЬ СЕЙЧАС'}
              </button>
            </>
          )}
        </div>
      )}
    </div>
  );
}

function LobbyScreen({gameId,user,onBack,onStarted,toast,onViewProfile}){
  const[game,setGame]=useState(null);
  const[copied,setCop]=useState(false);
  const[showInv,setInv]=useState(false);
  const[friends,setFr]=useState({});
  const[allUsers,setAU]=useState({});
  const[sent,setSent]=useState({});

  const startedRef=useRef(false);
  useEffect(()=>{
    const unsub=DB.watchGame(gameId,g=>{
      if(!g)return;
      setGame(g);
      if(g.phase==='playing'&&!startedRef.current){
        startedRef.current=true;
        onStarted();
      }
    });
    return unsub;
  },[gameId]);

  /* FIX: load friends correctly */
  useEffect(()=>{
    if(!showInv)return;
    (async()=>{
      const[fs,au]=await Promise.all([db.ref(`friends/${user.username}`).once('value'),DB.getAllUsers()]);
      setFr(fs.val()||{});setAU(au);
    })();
  },[showInv]);

  const start=async()=>{
    const g=await DB.getGame(gameId);if(!g||g.phase!=='lobby')return;
    const pl=Object.values(g.players||{});
    if(pl.length<2)return toast('Нужно минимум 2 игрока','err');
    const settings=await DB.getSettings();
    const useAdult=!!(g.adultMode&&settings.adultMode);
    const up={};
    // Если у игрока уже есть карты (применены читы заранее) — не перезаписываем
    pl.forEach(p=>{up[p.username]={...p,cards:p.cards&&typeof p.cards==='object'&&Object.keys(p.cards).length>1?p.cards:mkCards(useAdult),revealed:[],isEliminated:false};});
    // Раздача ролей если включено
    if(g.roles){
      const rolePool=[...ROLES.filter(r=>r.id!=='civilian')];
      const shuffled=[...rolePool].sort(()=>Math.random()-.5);
      pl.forEach((p,i)=>{
        const role=shuffled[i]||{id:'civilian',icon:'👤',name:'Обычный',color:'var(--tx3)',desc:'Никакой особой роли. Выживи любой ценой.'};
        up[p.username].role=role.id;
      });
    }
    // Раздача комнат бункера если включено (храним ОТДЕЛЬНО от players!)
    let roomAssignData={};
    if(g.bunkerMap){
      const rooms=[...BUNKER_ROOMS].sort(()=>Math.random()-.5).slice(0,Math.min(BUNKER_ROOMS.length,pl.length));
      pl.forEach((p,i)=>{ roomAssignData[p.username]=rooms[i%rooms.length].id; });
    }
    const newGame={...g,players:up,bunkerSpots:Math.ceil(pl.length/2),phase:'playing',round:1,votes:{},revealedThisRound:{},eliminated:[],lastEliminated:null,chat:g.chat||null,voteLog:g.voteLog||{},roomAssign:roomAssignData,roundTimerStart:g.roundTimerSeconds?Date.now():null};
    await DB.setGame(gameId,newGame);
    DB.logEvent(gameId,'start',`Игра началась! Участники: ${pl.map(p=>p.name||p.username).join(', ')}`,user.username);
    await Promise.all(pl.map(p=>DB.updateUser(p.username,{gamesPlayed:firebase.database.ServerValue.increment(1)})));
    // Award achievements after game starts
    await Promise.all(pl.map(async p=>{const ud=await DB.getUser(p.username);if(ud)await checkAndAwardAchievements(p.username,{...ud,gamesPlayed:(ud.gamesPlayed||0)+1},null);}));
  };
  const leave=async()=>{
    if(!confirm('Покинуть лобби?'))return;
    const g=await DB.getGame(gameId);if(!g)return onBack();
    const pl={...g.players};delete pl[user.username];
    if(!Object.keys(pl).length){await db.ref(`games/${gameId}`).remove();}
    else{
      const upd={[`players/${user.username}`]:null};
      if(g.creatorId===user.username)upd.creatorId=Object.keys(pl)[0];
      await DB.updateGame(gameId,upd);
    }
    onBack();
  };
  const copy=()=>{navigator.clipboard?.writeText(gameId).catch(()=>{});setCop(true);setTimeout(()=>setCop(false),2000);toast('Код скопирован!','ok');};
  const invite=async(fid)=>{
    if(sent[fid])return;
    if(game?.players?.[fid])return toast('Уже в лобби','err');
    await DB.sendGameInvite(user.username,user.displayName||user.username,fid,gameId);
    setSent(p=>({...p,[fid]:true}));toast('Приглашение отправлено!','ok');
  };

  if(!game)return<div className="sc"><Spin/></div>;
  const ap=game.apocalypse||{};
  const players=Object.values(game.players||{});
  const isCreator=game.creatorId===user.username;
  const fIds=Object.keys(friends);
  const fNotIn=fIds.filter(fid=>!game.players?.[fid]&&allUsers[fid]);

  return(
    <div className="sc">
      <HZ/>
      <div className="tb">
        <div className="led led-g"/>
        <div className="tb-title">ЛОББИ {game?.isRated&&<span style={{fontSize:11,background:'rgba(77,166,255,0.15)',border:'1px solid rgba(77,166,255,0.3)',color:'#4da6ff',borderRadius:6,padding:'2px 7px',fontWeight:700,verticalAlign:'middle'}}>🏅 РЕЙТ</span>}</div>
        <div className="mono" style={{fontSize:10,letterSpacing:2,color:'var(--tx3)'}}>{players.length}/16</div>
      </div>
      <div className="scr-raw" style={{paddingBottom:100}}>
        {game.adultMode&&<div style={{background:'var(--rt)',border:'1px solid var(--rb)',padding:'8px 12px',marginBottom:10,display:'flex',alignItems:'center',gap:8,fontFamily:"'Inter',sans-serif",fontSize:10,letterSpacing:2,color:'var(--r)'}}>🔞 ВЗРОСЛЫЙ РЕЖИМ — 18+</div>}
        <div className="card" style={{marginBottom:12}}>
          <div style={{fontSize:36,marginBottom:6}}>{ap.emoji}</div>
          <div style={{fontFamily:"'Inter',sans-serif",fontSize:22,letterSpacing:2,color:'var(--a)'}}>{ap.name}</div>
          <div style={{fontSize:12,color:'var(--tx3)',lineHeight:1.5,marginTop:5}}>{ap.description}</div>
          <div style={{marginTop:10,padding:'8px 10px',background:'var(--at)',borderLeft:'2px solid var(--a)',fontSize:12,color:'var(--a2)'}}>🎯 {ap.victory}</div>
        </div>
        <div className="code-box" onClick={copy}>
          {gameId}
          <div className="mono" style={{fontSize:9,color:copied?'var(--g)':'var(--tx3)',letterSpacing:2,marginTop:4}}>{copied?'✓ СКОПИРОВАНО':'НАЖМИТЕ ЧТОБЫ СКОПИРОВАТЬ'}</div>
        </div>
        {isCreator&&<Btn ch="👥 ПРИГЛАСИТЬ ДРУЗЕЙ" onClick={()=>setInv(true)} cls="btn-c" sm style={{marginBottom:10}}/>}
        <div className="lbl">ИГРОКИ</div>
        {players.map(p=>{
          const isMe=p.username===user.username,isCr=p.username===game.creatorId;
          return(
            <div key={p.username} className={`prow${isMe?' me':' hot'}`} onClick={()=>!isMe&&onViewProfile&&onViewProfile(p.username)}>
              <Avatar name={p.name||p.username} size="sm"/>
              <div style={{flex:1,fontSize:14,fontWeight:600}}>{p.name}</div>
              {isCr&&<span className="bdg bdg-a">СОЗДАТЕЛЬ</span>}
              {isMe&&<span className="bdg bdg-c">ВЫ</span>}
            </div>
          );
        })}
      </div>
      {user.isAdmin&&<AdminCheatPanel gameId={gameId} game={game} user={user} toast={toast} phase="lobby"/>}
      <div className="fixbot">
        {isCreator
          ?<Btn ch={players.length<2?`⚡ ЖДЁМ (${players.length}/2)`:'⚡ НАЧАТЬ ИГРУ'} onClick={start} disabled={players.length<2}/>
          :<div className="mono" style={{textAlign:'center',fontSize:10,letterSpacing:2,color:'var(--tx3)',padding:'4px 0'}}>ОЖИДАНИЕ СОЗДАТЕЛЯ…</div>
        }
        <Btn ch="↩ ПОКИНУТЬ ЛОББИ" onClick={leave} cls="btn-g" sm/>
      </div>

      {showInv&&(
        <div className="modal-bg" onClick={e=>e.target===e.currentTarget&&setInv(false)}>
          <div className="modal-box">
            <div className="modal-hd">
              <span className="modal-ttl">👥 ПРИГЛАСИТЬ ДРУЗЕЙ</span>
              <button className="modal-cls" onClick={()=>setInv(false)}>✕</button>
            </div>
            <div className="modal-bd">
              {!Object.keys(allUsers).length?<Spin/>:fNotIn.length===0?(
                <div className="mono" style={{textAlign:'center',color:'var(--tx3)',fontSize:10,letterSpacing:2,padding:24}}>
                  {fIds.length===0?'НЕТ ДРУЗЕЙ':'ВСЕ ДРУЗЬЯ УЖЕ В ЛОББИ'}
                </div>
              ):fNotIn.map(fid=>{
                const fu=allUsers[fid];if(!fu)return null;
                return(
                  <div key={fid} className="fi">
                    <div style={{flex:1}}>
                      <div style={{fontSize:14,fontWeight:600}}>{fu.displayName||fu.username}</div>
                      <div className="mono" style={{fontSize:8,color:'var(--tx3)'}}>@{fu.username}</div>
                    </div>
                    <button onClick={()=>invite(fid)} style={{background:sent[fid]?'var(--gt)':'var(--at)',border:`1px solid ${sent[fid]?'var(--gb)':'var(--ab)'}`,color:sent[fid]?'var(--g)':'var(--a)',fontFamily:"'Inter',sans-serif",fontSize:10,padding:'6px 12px',cursor:sent[fid]?'default':'pointer',letterSpacing:1,transition:'.2s'}}>
                      {sent[fid]?'✓ ОТПРАВЛЕНО':'⚡ ПРИГЛАСИТЬ'}
                    </button>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   GAME WRAPPER
══════════════════════════════════════════════════════════ */
function WinParticles({iWon}){
  const ref=useRef(null);
  useEffect(()=>{
    const el=ref.current;if(!el)return;
    el.innerHTML='';
    if(iWon){
      const colors=['#ff453a','#30d158','#0a84ff','#bf5af2','#f0a500','#ff6b9d'];
      for(let i=0;i<60;i++){
        const d=document.createElement('div');
        const color=colors[Math.floor(Math.random()*colors.length)];
        const left=Math.random()*100;
        const dur=2+Math.random()*2;
        const delay=Math.random()*2;
        const w=6+Math.random()*6;
        const h=8+Math.random()*8;
        d.style.cssText=`position:absolute;left:${left}%;top:0;width:${w}px;height:${h}px;background:${color};border-radius:2px;animation:confettiFall ${dur}s ease-in ${delay}s both;`;
        el.appendChild(d);
      }
    } else {
      for(let i=0;i<20;i++){
        const d=document.createElement('div');
        const left=Math.random()*100;
        const top=Math.random()*80;
        const dur=2+Math.random()*2;
        const delay=Math.random()*3;
        d.style.cssText=`position:absolute;left:${left}%;top:${top}%;font-size:${18+Math.random()*14}px;animation:skullFloat ${dur}s ease-in-out ${delay}s infinite;`;
        d.textContent='☠';
        el.appendChild(d);
      }
    }
  },[iWon]);
  return <div ref={ref} className="win-particles"/>;
}

function GameWrapper({gameId,user,onExit,toast,onViewProfile,online}){
  const[game,setGame]=useState(null);
  const[sub,setSub]=useState('round');
  const[selVote,setSelVote]=useState(undefined);
  const[showChat,setShowChat]=useState(false);
  const[unread,setUnread]=useState(0);
  const[eventLog,setEventLog]=useState([]);
  const[reactions,setReactions]=useState({});
  const[showReactPicker,setShowReactPicker]=useState(null); // {username,cardKey}
  const[notes,setNotes]=useState('');
  const[roundTimerLeft,setRoundTimerLeft]=useState(null);
  const prevElim=useRef(0);
  const prevPhase=useRef(null);
  const tallying=useRef(false);
  const lastChat=useRef(0);
  const roundTimerRef=useRef(null);

  useEffect(()=>{
    const unsub=DB.watchGame(gameId,async g=>{
      if(!g)return;
      if(g.phase==='voting'&&g.creatorId===user.username&&!tallying.current){
        const alive=Object.values(g.players||{}).filter(p=>!p.isEliminated);
        const voted=Object.keys(g.votes||{}).length;
        if(alive.length>0&&voted>=alive.length){
          tallying.current=true;
          try{
            const copy=JSON.parse(JSON.stringify(g));processVotes(copy);
            if(copy.phase==='finished'){
              const surv=Object.values(copy.players).filter(p=>!p.isEliminated).map(p=>p.username);
              const all=Object.keys(copy.players);
              await Promise.all([...surv.map(uid=>DB.updateUser(uid,{gamesWon:firebase.database.ServerValue.increment(1)})),...all.filter(u=>!surv.includes(u)).map(uid=>DB.updateUser(uid,{gamesEliminated:firebase.database.ServerValue.increment(1)}))]);
              // Log game end
              DB.logEvent(gameId,'end',`Игра завершена! Выжившие: ${surv.map(u=>copy.players[u]?.name||u).join(', ')}`,user.username);
              // Эло рейтинг
              if(copy.isRated&&all.length>=2){
                const eloData=await Promise.all(all.map(async uid=>{const ud=await DB.getUser(uid);return{uid,elo:ud?.elo||1000,eloGames:ud?.eloGames||0};}));
                const avgElo=eloData.reduce((s,e)=>s+e.elo,0)/eloData.length;
                await Promise.all(eloData.map(async({uid,elo,eloGames})=>{
                  const isSurv=surv.includes(uid);
                  const K=32;
                  const expected=1/(1+Math.pow(10,(avgElo-elo)/400));
                  const score=isSurv?1:0;
                  const delta=Math.round(K*(score-expected));
                  const newElo=Math.max(100,elo+delta);
                  await DB.updateUser(uid,{elo:newElo,eloGames:eloGames+1,eloDelta:delta});
                }));
              }
              // Award achievements
              await Promise.all(all.map(async uid=>{
                const ud=await DB.getUser(uid);if(!ud)return;
                const isSurv=surv.includes(uid);
                const pp=copy.players[uid];
                const totalRevd=(pp?.revealed||[]).length;
                const totalCards=CARDS.filter(c=>c.key!=='secret').length;
                const wonWithoutAll=isSurv&&totalRevd<totalCards;
                await checkAndAwardAchievements(uid,{...ud,gamesWon:(ud.gamesWon||0)+(isSurv?1:0),gamesEliminated:(ud.gamesEliminated||0)+(!isSurv?1:0)},{wonWithoutAllCards:wonWithoutAll});
              }));
            } else {
              // Elimination event
              if(copy.lastEliminated){
                DB.logEvent(gameId,'elim',`${copy.lastEliminated.name} выбыл из бункера!`,copy.lastEliminated.userId||'');
              }
            }
            await DB.setGame(gameId,copy);
          }catch(e){console.error(e);}
          tallying.current=false;return;
        }
      }
      const el=(g.eliminated||[]).length;
      if(el>prevElim.current&&g.lastEliminated){prevElim.current=el;setSub('elim');}
      if(g.phase!==prevPhase.current){
        prevPhase.current=g.phase;
        if(g.phase==='voting'){setSelVote(undefined);setSub('vote');}
        if(g.phase==='debates')setSub('debates');
        if(g.phase==='playing')setSub(prev=>prev==='elim'||prev==='vote'||prev==='debates'?'round':prev);
        if(g.phase==='finished')setSub('over');
        if(g.phase==='lobby')onExit();
      }
      setGame(g);
    });
    return unsub;
  },[gameId]);

  useEffect(()=>{
    const unsub=DB.watchGameChat(gameId,msgs=>{
      if(!showChat){const nc=msgs.length-lastChat.current;if(nc>0)setUnread(p=>p+nc);}
      lastChat.current=msgs.length;
    });
    return unsub;
  },[gameId,showChat]);

  // Автоголосование: если включено и все живые игроки выложили все карты — запускаем голосование
  // ВАЖНО: useEffect должен быть ДО любых early return
  useEffect(()=>{
    if(!game||game.phase!=='playing'||!game.autoVote||game.creatorId!==user.username)return;
    const aliveP=Object.values(game.players||{}).filter(p=>!p.isEliminated);
    const allDone=aliveP.every(p=>{
      const done=(game.revealedThisRound||{})[p.username]||0;
      return done>=(game.maxReveals||2);
    });
    if(allDone&&aliveP.length>1&&!game._autoVotePending){
      if(game.debates){
        DB.updateGame(gameId,{phase:'debates',debateStart:Date.now(),votes:{},_autoVotePending:true});
      } else {
        DB.updateGame(gameId,{phase:'voting',votes:{},_autoVotePending:true});
      }
    }
  },[game]);

  // Дебаты: автопереход в голосование через 60 сек (только создатель)
  useEffect(()=>{
    if(!game||game.phase!=='debates'||game.creatorId!==user.username)return;
    const elapsed=Date.now()-(game.debateStart||Date.now());
    const remaining=Math.max(0,60000-elapsed);
    const t=setTimeout(()=>{
      DB.updateGame(gameId,{phase:'voting',votes:{}});
    },remaining);
    return()=>clearTimeout(t);
  },[game?.phase,game?.debateStart]);

  // Радиопереговоры — state ОБЯЗАТЕЛЬНО до early return
  useOnline(gameId,user.username);
  const onlinePlayers=useOnlinePlayers(gameId);
  const[radioTarget,setRadioTarget]=useState(null);
  const[radioMsgs,setRadioMsgs]=useState([]);
  const[radioInput,setRadioInput]=useState('');
  const[secretModalOpen,setSecretModalOpen]=useState(false);
  useEffect(()=>{
    if(!radioTarget||!gameId)return;
    const radioKey=[user.username,radioTarget].sort().join('_');
    const ref=db.ref(`radioChats/${gameId}/${radioKey}`);
    const cb=ref.on('value',snap=>{
      const d=snap.val();
      setRadioMsgs(d?Object.values(d).sort((a,b)=>a.ts-b.ts):[]);
    });
    return()=>ref.off('value',cb);
  },[radioTarget,gameId]);

  // Watch event log
  useEffect(()=>{
    const u=DB.watchEventLog(gameId,log=>setEventLog(log));
    return u;
  },[gameId]);

  // Watch reactions
  useEffect(()=>{
    const u=DB.watchReactions(gameId,r=>setReactions(r));
    return u;
  },[gameId]);

  // Load personal notes
  useEffect(()=>{
    const key=`notes_${gameId}_${user.username}`;
    setNotes(localStorage.getItem(key)||'');
  },[gameId,user.username]);

  // Round timer
  useEffect(()=>{
    if(!game||!game.roundTimerSeconds||game.phase!=='playing')return;
    if(roundTimerRef.current)clearInterval(roundTimerRef.current);
    const startTs=game.roundTimerStart||Date.now();
    const totalMs=game.roundTimerSeconds*1000;
    const tick=()=>{
      const elapsed=Date.now()-startTs;
      const left=Math.max(0,Math.ceil((totalMs-elapsed)/1000));
      setRoundTimerLeft(left);
      if(left<=0&&game.creatorId===user.username&&game.phase==='playing'){
        clearInterval(roundTimerRef.current);
        if(game.debates){
          DB.updateGame(gameId,{phase:'debates',debateStart:Date.now(),votes:{}});
        } else {
          DB.updateGame(gameId,{phase:'voting',votes:{}});
        }
      }
    };
    tick();
    roundTimerRef.current=setInterval(tick,1000);
    return()=>clearInterval(roundTimerRef.current);
  },[game?.roundTimerSeconds,game?.roundTimerStart,game?.phase]);

  // nextSub — вычисляем ДО early return чтобы было доступно везде
  const nextSub=game
    ? game.phase==='finished'?'over'
      :game.phase==='voting'?'vote'
      :game.phase==='debates'?'debates'
      :'round'
    : 'round';

  // Таймер дебатов — ПЕРЕД early return (правила хуков React)
  const[debateTimeLeft,setDebateTimeLeft]=useState(60);
  useEffect(()=>{
    if(!game||game.phase!=='debates')return;
    const tick=()=>setDebateTimeLeft(Math.max(0,60-Math.floor((Date.now()-(game.debateStart||Date.now()))/1000)));
    tick();
    const t=setInterval(tick,1000);
    return()=>clearInterval(t);
  },[game?.phase,game?.debateStart]);

  if(!game)return<div className="sc" style={{alignItems:'center',justifyContent:'center',gap:16}}><div style={{fontSize:40}}>☢</div><div style={{fontSize:14,color:'var(--tx3)'}}>Загружаем бункер...</div><div className="spin"/></div>;

  // Game chat full overlay
  if(showChat){
    return(
      <div className="gchat">
        <GameChatInner gameId={gameId} user={user} onClose={()=>{setShowChat(false);setUnread(0);}}/>
      </div>
    );
  }

  const me=(game.players||{})[user.username];
  const isCreator=game.creatorId===user.username;
  const alive=Object.values(game.players||{}).filter(p=>!p.isEliminated);
  const ap=game.apocalypse||{};
  const maxRev=game.maxReveals||2;
  const revDone=(game.revealedThisRound||{})[user.username]||0;
  const extraRev=(game.extraReveals||{})[user.username]||0;
  const revLeft=(maxRev+extraRev)-revDone;
  const mySecretCard=me?.cards?.secret?SECRET_CARDS.find(s=>s.id===me.cards.secret):null;
  const mySecretUsed=!!(game.usedSecrets||{})[user.username];

  // debateTimeLeft обновляется выше (до early return)

  const useSecretCard=async(sc)=>{
    if(!me||me.isEliminated)return toast('Вы выбыли','err');
    if((game.usedSecrets||{})[user.username])return toast('Карта уже использована','err');
    const effect=sc.effect;
    const upd={[`usedSecrets/${user.username}`]:true};
    // Применяем эффект
    if(effect==='extra_reveal'){
      upd[`extraReveals/${user.username}`]=(game.extraReveals?.[user.username]||0)+1;
      toast(`✨ ${sc.name}: +1 раскрытие в этом раунде!`,'ok');
    } else if(effect==='double_vote'){
      upd[`doubleVote/${user.username}`]=true;
      toast(`⚡ ${sc.name}: твой голос удвоен!`,'ok');
    } else if(effect==='no_vote'){
      toast(`🔇 ${sc.name}: ты потерял голос в этом раунде.`,'');
    } else if(effect==='immunity'){
      upd[`immunity/${user.username}`]=true;
      toast(`🛡️ ${sc.name}: ты под защитой в этом раунде!`,'ok');
    } else if(effect==='secret_vote'){
      upd[`secretVote/${user.username}`]=true;
      toast(`🕵️ ${sc.name}: твой голос будет тайным!`,'ok');
    } else if(effect==='hide_card'){
      const revealed=me.revealed||[];
      if(revealed.length>0){
        const toHide=revealed[Math.floor(Math.random()*revealed.length)];
        const newRev=revealed.filter(k=>k!==toHide);
        upd[`players/${user.username}/revealed`]=newRev;
        const cardLabel=CARDS.find(c=>c.key===toHide)?.label||toHide;
        toast(`🌫️ ${sc.name}: карта "${cardLabel}" снова скрыта!`,'ok');
      } else { toast('🌫️ Нет раскрытых карт для скрытия','err'); return; }
    } else {
      // Остальные эффекты требуют взаимодействия — информируем
      toast(`${sc.icon} ${sc.name} активирована! Расскажи всем об эффекте.`,'ok');
    }
    await DB.updateGame(gameId,upd);
    setSub('round');
  };

  const doReveal=async(k)=>{
    if(!me||me.isEliminated)return;
    if(me.revealed?.includes(k))return toast('Уже раскрыта','err');
    if(revLeft<=0)return toast(`Лимит: ${maxRev} карт за раунд`,'err');
    const nr=[...(me.revealed||[]),k];
    const cardLabel=CARDS.find(c=>c.key===k)?.label||k;
    await DB.updateGame(gameId,{[`players/${user.username}/revealed`]:nr,[`revealedThisRound/${user.username}`]:revDone+1});
    DB.logEvent(gameId,'reveal',`${user.displayName||user.username} раскрыл карту: ${cardLabel}`,user.username);
    toast('✅ Карта раскрыта!','ok');setSub('round');
  };
  const startVote=async()=>{
    if(game.phase!=='playing')return;
    if(game.debates){
      // Сначала дебаты — фаза 'debates' на 60 секунд
      await DB.updateGame(gameId,{phase:'debates',debateStart:Date.now(),votes:{}});
      toast('🎤 Дебаты начались! 60 секунд на защиту','ok');
    } else {
      await DB.updateGame(gameId,{phase:'voting',votes:{}});
      setSelVote(undefined);
      toast('🗳 Голосование началось!','ok');
    }
  };
  const castVote=async(tid)=>{
    if(game.phase!=='voting')return;
    if((game.votes||{})[user.username]!==undefined)return toast('Вы уже проголосовали','err');
    await DB.updateGame(gameId,{[`votes/${user.username}`]:(tid===undefined||tid===null)?null:tid});
    const targetName=tid?(game.players[tid]?.name||tid):'воздержался';
    DB.logEvent(gameId,'vote',`${user.displayName||user.username} проголосовал за: ${targetName}`,user.username);
  };
  const tally=async()=>{
    if(tallying.current)return;
    const g=await DB.getGame(gameId);if(!g||g.phase!=='voting')return;
    tallying.current=true;
    try{
      const copy=JSON.parse(JSON.stringify(g));processVotes(copy);
      if(copy.phase==='finished'){
        const surv=Object.values(copy.players).filter(p=>!p.isEliminated).map(p=>p.username);
        const all=Object.keys(copy.players);
        await Promise.all([
          ...surv.map(uid=>DB.updateUser(uid,{gamesWon:firebase.database.ServerValue.increment(1)})),
          ...all.filter(u=>!surv.includes(u)).map(uid=>DB.updateUser(uid,{gamesEliminated:firebase.database.ServerValue.increment(1)}))
        ]);
        // Расчёт Эло для рейтинговой игры
        if(copy.isRated&&all.length>=2){
          const K=32;
          const eloData=await Promise.all(all.map(async uid=>{const ud=await DB.getUser(uid);return{uid,elo:ud?.elo||1000,eloGames:ud?.eloGames||0};}));
          const avgElo=eloData.reduce((s,e)=>s+e.elo,0)/eloData.length;
          await Promise.all(eloData.map(async({uid,elo,eloGames})=>{
            const isSurv=surv.includes(uid);
            const expected=1/(1+Math.pow(10,(avgElo-elo)/400));
            const score=isSurv?1:0;
            const delta=Math.round(K*(score-expected));
            const newElo=Math.max(100,elo+delta);
            await DB.updateUser(uid,{elo:newElo,eloGames:eloGames+1,eloDelta:delta});
          }));
        }
        // Достижения
        await Promise.all(all.map(async uid=>{
          const ud=await DB.getUser(uid);if(!ud)return;
          const isSurv=surv.includes(uid);
          const pp=copy.players[uid];
          const totalRevd=(pp?.revealed||[]).length;
          const totalCards=CARDS.filter(c=>c.key!=='secret').length;
          await checkAndAwardAchievements(uid,{...ud,gamesWon:(ud.gamesWon||0)+(isSurv?1:0),gamesEliminated:(ud.gamesEliminated||0)+(!isSurv?1:0)},{wonWithoutAllCards:isSurv&&totalRevd<totalCards});
        }));
        DB.logEvent(gameId,'end',`Игра завершена! Выжившие: ${surv.map(u=>copy.players[u]?.name||u).join(', ')}`,user.username);
      }
      await DB.setGame(gameId,copy);
    }catch(e){console.error(e);}
    tallying.current=false;
  };

  /* MY CARDS */
  if(sub==='cards'){
    const mySecret=me?.cards?.secret?SECRET_CARDS.find(s=>s.id===me.cards.secret):null;
    const secretUsed=(game.usedSecrets||{})[user.username];
    return(
      <div className="sc">
        <HZ/><div className="tb"><BackBtn onClick={()=>setSub('round')}/><div className="tb-title">МОИ КАРТЫ</div></div>
        <div className="scr-raw">
          <div style={{fontSize:11,color:'var(--tx3)',textAlign:'center',margin:'4px 0 14px'}}>Только вы видите все карты</div>
          {/* SECRET CARD — highlighted separately */}
          {mySecret&&(React.createElement(React.Fragment,null,
            React.createElement('div',{
              onClick:()=>setSecretModalOpen(true),
              style:{
                background:`linear-gradient(135deg,${mySecret.color}18,${mySecret.color}08)`,
                border:`1px solid ${mySecret.color}55`,
                borderRadius:'var(--rad)',
                padding:'16px',
                marginBottom:14,
                position:'relative',
                overflow:'hidden',
                cursor:'pointer',
              }
            },
              React.createElement('div',{style:{position:'absolute',top:0,right:0,padding:'4px 10px',background:mySecret.color+'22',borderBottomLeftRadius:'var(--rad-sm)',fontSize:9,fontWeight:700,color:mySecret.color,textTransform:'uppercase',letterSpacing:1}},SECRET_TYPE_LABELS[mySecret.type]),
              secretUsed&&React.createElement('div',{style:{position:'absolute',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,.55)',borderRadius:'var(--rad)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:2}},
                React.createElement('span',{style:{fontSize:12,color:'#8e8e93',fontWeight:700,letterSpacing:1}},'ИСПОЛЬЗОВАНА')
              ),
              React.createElement('div',{style:{fontSize:32,marginBottom:6}},mySecret.icon),
              React.createElement('div',{style:{fontSize:16,fontWeight:700,color:'#fff',marginBottom:4}},'🃏 ',mySecret.name),
              React.createElement('div',{style:{fontSize:12,color:'rgba(255,255,255,.7)',lineHeight:1.5}},mySecret.desc),
              !secretUsed&&isCreator===false&&React.createElement('button',{onClick:(e)=>{e.stopPropagation();useSecretCard(mySecret);},style:{marginTop:12,background:mySecret.color,border:'none',borderRadius:'var(--rad-sm)',color:'#000',fontWeight:700,fontSize:12,padding:'8px 16px',cursor:'pointer',width:'100%'}},'⚡ Активировать карту')
            ),
            secretModalOpen&&React.createElement('div',{className:'secret-modal-bg',onClick:()=>setSecretModalOpen(false)},
              React.createElement('div',{className:'secret-modal-card',onClick:(e)=>e.stopPropagation()},
                React.createElement('button',{className:'secret-modal-close',onClick:()=>setSecretModalOpen(false)},'✕'),
                React.createElement('div',{style:{fontSize:64,marginBottom:16}},mySecret.icon),
                React.createElement('div',{style:{fontSize:22,fontWeight:800,color:'#f0a500',marginBottom:8}},mySecret.name),
                React.createElement('div',{style:{fontSize:13,color:'rgba(255,255,255,.8)',lineHeight:1.6,textAlign:'center',maxWidth:260}},mySecret.desc),
                React.createElement('div',{style:{marginTop:12,fontSize:11,color:mySecret.color,fontWeight:700,letterSpacing:1,textTransform:'uppercase'}},SECRET_TYPE_LABELS[mySecret.type])
              )
            )
          ))}
          <div className="cgrid">
            {me?.cards?CARDS.filter(c=>c.key!=='secret').map(({key,icon,label})=>{
              const rev=(me.revealed||[]).includes(key);
              const isFlipped=rev;
              return(
                <div key={key} className={`card-flip-wrap${isFlipped?' flipped':''}${key==='fact'?' full':''}`} style={{height:key==='fact'?90:110}}>
                <div className="card-flip-inner">
                <div className="card-face" style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:6}}>
                  <div style={{fontSize:24,filter:'blur(6px)',opacity:.4}}>{icon}</div>
                  <div style={{fontSize:10,color:'var(--tx3)',fontWeight:600,letterSpacing:1,textTransform:'uppercase'}}>{label}</div>
                  <div style={{fontSize:9,color:'var(--tx3)',opacity:.6}}>🔒 закрыто</div>
                </div>
                <div className={`card-face card-back${rev?' rev':''}`} style={{background:rev?'rgba(48,209,88,0.06)':'rgba(255,255,255,0.04)',border:`1px solid ${rev?'rgba(48,209,88,.3)':'rgba(255,255,255,0.08)'}`,display:'flex',flexDirection:'column',gap:4}}>
                  {rev&&<div className="rev-bdg">РАСКРЫТА</div>}
                  <div style={{fontSize:22,marginBottom:5}}>{icon}</div>
                  <div className="mono" style={{fontSize:8,letterSpacing:2,color:'var(--tx3)',textTransform:'uppercase'}}>{label}</div>
                  <div style={{fontSize:12,color:'var(--tx)',marginTop:5,lineHeight:1.4}}>{me.cards[key]||'—'}</div>
                </div></div></div>
              );
            }):<div style={{color:'var(--tx3)',padding:24,textAlign:'center'}}>Карты не назначены</div>}
          </div>
        </div>
      </div>
    );
  }

  /* PICK CARD */
  if(sub==='pick'){
    const unrev=CARDS.filter(c=>!(me?.revealed||[]).includes(c.key));
    return(
      <div className="sc">
        <HZ/><div className="tb"><BackBtn onClick={()=>setSub('round')}/><div className="tb-title">РАСКРЫТЬ КАРТУ</div><div className="mono" style={{fontSize:10,color:'var(--tx3)',letterSpacing:2}}>Р{game.round}</div></div>
        <div className="scr-raw">
          <div className="mono" style={{fontSize:10,color:'var(--a)',textAlign:'center',padding:'8px 0 12px'}}>Осталось раскрытий: {revLeft} из {maxRev}</div>
          {revLeft<=0?<div className="mono" style={{textAlign:'center',padding:20,color:'var(--g)',fontSize:10,letterSpacing:2}}>✓ Лимит раскрытий использован</div>
          :unrev.length===0?<div className="mono" style={{textAlign:'center',padding:20,color:'var(--g)',fontSize:10,letterSpacing:2}}>✓ Все карты раскрыты</div>
          :unrev.map(({key,icon,label})=>(
            <div key={key} className="ptile" onClick={()=>{const v=me?.cards?.[key]||'—';if(confirm(`Раскрыть?\n\n${label}: ${v}\n\nВсе увидят.`))doReveal(key);}}>
              <div style={{fontSize:22}}>{icon}</div>
              <div style={{flex:1}}>
                <div className="mono" style={{fontSize:9,letterSpacing:2,color:'var(--tx3)',textTransform:'uppercase'}}>{label}</div>
                <div style={{fontSize:13,color:'var(--tx)',marginTop:3}}>{me?.cards?.[key]||'—'}</div>
              </div>
              <div style={{fontSize:20,color:'var(--tx3)'}}>›</div>
            </div>
          ))}
          <div style={{marginTop:8}}><Btn ch="🤫 Не раскрывать сейчас" onClick={()=>setSub('round')} cls="btn-g" sm/></div>
        </div>
      </div>
    );
  }

  /* VOTE */
  if(sub==='vote'||(game.phase==='voting'&&sub!=='elim'&&sub!=='over')){
    const votes=game.votes||{};
    const voted=votes[user.username]!==undefined;
    const total=Object.keys(votes).length;
    const myV=votes[user.username];
    return(
      <div className="sc">
        <div className="hz-red"/>
        <div style={{padding:'14px',background:'rgba(232,53,74,.07)',borderBottom:'1px solid var(--rb)',flexShrink:0}}>
          <div style={{fontFamily:"'Inter',sans-serif",fontSize:28,letterSpacing:3,color:'var(--r)'}}>ГОЛОСОВАНИЕ</div>
          <div className="mono" style={{fontSize:9,letterSpacing:2,color:'var(--tx3)',marginTop:2}}>КТО ПОКИНЕТ БУНКЕР?</div>
          <div className="mono" style={{fontSize:10,color:'var(--tx)',marginTop:6}}>Проголосовали: {total} / {alive.length}</div>
        </div>
        <div className="scr-raw" style={{paddingBottom:100}}>
          <div className="mono" style={{fontSize:9,letterSpacing:2,color:'var(--tx3)',textAlign:'center',margin:'4px 0 12px'}}>ВЫБЕРИТЕ ИГРОКА — ПОДТВЕРДИТЕ ГОЛОС</div>
          <div className="vgrid">
            {alive.map(p=>{
              const isMe=p.username===user.username;
              const vc=Object.values(votes).filter(v=>v===p.username).length;
              const iSel=!isMe&&selVote===p.username;
              const iVot=!isMe&&myV===p.username;
              const revT=(p.revealed||[]).map(k=>{const m=CARDS.find(c=>c.key===k);return`${m?.icon||''} ${p.cards?.[k]||''}`;}).join(' · ')||'карты не раскрыты';
              return(
                <div key={p.username} className={`vcard-rich${(iSel||iVot)?' sel':''}${voted?' voted':''}`}
                  onClick={()=>!voted&&setSelVote(p.username===selVote?undefined:p.username)}>
                  <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                    <Avatar name={p.name||p.username} size="sm"/>
                    <div>
                      <div style={{fontWeight:700,fontSize:13,color:'var(--tx)'}}>{p.name||p.username}</div>
                      <div style={{fontSize:10,color:'var(--tx3)'}}>@{p.username}</div>
                    </div>
                    {(iSel||iVot)&&<div style={{marginLeft:'auto',fontSize:18}}>🎯</div>}
                  </div>
                  {p.cards?.profession&&<div style={{fontSize:11,color:'var(--tx2)',background:'rgba(255,255,255,.05)',borderRadius:6,padding:'4px 8px'}}>{p.cards.profession}</div>}
                </div>
              );
            })}
            <div className={`vcard-rich${selVote===null?' abst':''}${voted?' voted':''}`} onClick={()=>{if(!voted)setSelVote(null);}}>
              <div style={{fontSize:13,fontWeight:700}}>🤐 Воздержаться</div>
              <div style={{fontSize:10,color:'var(--tx3)',marginTop:4}}>Не влияет на итог</div>
              {myV===null&&voted&&<div style={{position:'absolute',bottom:8,right:8,fontSize:14,color:'var(--c)'}}>★</div>}
            </div>
          </div>
        </div>
        <div className="fixbot">
          <Btn cls="btn-d" disabled={selVote===undefined||voted} ch={voted?'✅ ГОЛОС ЗАСЧИТАН':selVote===null?'🤐 ВОЗДЕРЖАТЬСЯ':'☠ ПОДТВЕРДИТЬ ГОЛОС'}
            onClick={()=>{if(selVote===undefined)return;castVote(selVote);}}/>
          {isCreator&&<Btn cls="btn-g" sm ch="📊 ПОДВЕСТИ ИТОГИ (создатель)" onClick={tally}/>}
        </div>
      </div>
    );
  }

  /* ELIM */
  if(sub==='elim'){
    const ep=game.lastEliminated;
    // nextSub определён выше (до early return)
    const elimRound=game.round>1?game.round-1:1;
    const secretCard=ep?.allCards?.secret?SECRET_CARDS.find(s=>s.id===ep.allCards.secret):null;
    return(
      <div className="elim-screen">
        {/* Фоновые эффекты */}
        <div className="elim-flash"/>
        <div className="elim-scanlines"/>
        <div className="elim-vignette"/>
        <div className="elim-scanner"/>

        {/* Герой — череп + имя */}
        <div className="elim-hero">
          <div className="elim-skull elim-skull-shake">💀</div>
          <div className="elim-tag">☠ исключён из бункера ☠</div>
          <div className="elim-name">{ep?.name||'—'}</div>
          <div className="elim-sub">Раунд {elimRound} · Голосов: {Object.values(game.votes||{}).filter(v=>v===ep?.userId).length}</div>
          <div className="elim-divider"/>
        </div>

        {/* Карты выбывшего */}
        <div className="elim-cards">
          <div style={{fontSize:9,letterSpacing:3,color:'rgba(255,69,58,.6)',textTransform:'uppercase',fontWeight:700,marginBottom:10}}>— Все карты —</div>
          {ep&&CARDS.filter(c=>c.key!=='secret').map(({key,icon,label},i)=>(
            <div key={key} className="elim-card-row" style={{animationDelay:`${0.9+i*0.08}s`}}>
              <div style={{fontSize:20,flexShrink:0,filter:'drop-shadow(0 0 8px rgba(255,69,58,.5))'}}>{icon}</div>
              <div style={{flex:1}}>
                <div style={{fontSize:8,letterSpacing:2,color:'rgba(255,69,58,.5)',textTransform:'uppercase',marginBottom:3}}>{label}</div>
                <div style={{fontSize:13,color:'#fff',fontWeight:500}}>{ep.allCards?.[key]||'—'}</div>
              </div>
            </div>
          ))}
          {secretCard&&(
            <div style={{background:`linear-gradient(135deg,${secretCard.color}22,${secretCard.color}08)`,border:`1px solid ${secretCard.color}55`,borderRadius:'var(--rad-sm)',padding:14,marginTop:4,animation:'elimCard .3s ease 1.5s both'}}>
              <div style={{fontSize:10,fontWeight:700,color:secretCard.color,marginBottom:6,letterSpacing:1}}>🃏 СЕКРЕТНАЯ КАРТА</div>
              <div style={{fontSize:18,marginBottom:4}}>{secretCard.icon} <span style={{fontSize:14,fontWeight:700,color:'#fff'}}>{secretCard.name}</span></div>
              <div style={{fontSize:12,color:'rgba(255,255,255,.6)',lineHeight:1.5}}>{secretCard.desc}</div>
            </div>
          )}
        </div>

        {/* Кнопка продолжить */}
        <div className="elim-continue">
          <button onClick={()=>setSub(nextSub)} style={{
            width:'100%',padding:'15px',border:'none',borderRadius:'var(--rad)',cursor:'pointer',
            background:'linear-gradient(135deg,rgba(255,69,58,.2),rgba(255,69,58,.08))',
            border:'1px solid rgba(255,69,58,.3)',color:'#fff',fontSize:15,fontWeight:700,
            letterSpacing:2,textTransform:'uppercase',transition:'.2s',
          }}>ПРОДОЛЖИТЬ →</button>
        </div>
      </div>
    );
  }

  /* OVER */
  if(sub==='over'){
    const surv=Object.values(game.players||{}).filter(p=>!p.isEliminated);
    const dead=Object.values(game.players||{}).filter(p=>p.isEliminated);
    const iWon=surv.some(p=>p.username===user.username);
    return(
      <div className="win-screen">
        <div className="win-rays"/>
        <div className="win-scanlines"/>
        <div className="win-vignette"/>
        <div className="win-flash"/>
        <WinParticles iWon={iWon}/>
        <div className="win-hero">
          <div className="win-trophy">{iWon?'🏆':'🏚'}</div>
          <div style={{marginTop:16,fontSize:10,letterSpacing:6,textTransform:'uppercase',color:'rgba(48,209,88,.6)',fontWeight:700,animation:'winFadeIn .5s ease .3s both'}}>
            {ap.emoji} {ap.name}
          </div>
          <div style={{fontSize:38,fontWeight:800,letterSpacing:2,color:'#30d158',textShadow:'0 0 40px rgba(48,209,88,.6)',marginTop:8,animation:'winFadeIn .5s ease .45s both'}}>
            {iWon?'ВЫЖИЛ!':'ИГРА ОКОНЧЕНА'}
          </div>
          <div style={{fontSize:13,color:'rgba(255,255,255,.4)',marginTop:6,animation:'winFadeIn .5s ease .6s both'}}>
            {surv.length} из {Object.keys(game.players||{}).length} попали в бункер
          </div>
          <div style={{display:'flex',gap:6,marginTop:18,flexWrap:'wrap',justifyContent:'center',animation:'winFadeIn .5s ease .75s both'}}>
            {surv.map((p,i)=>(
              <div key={p.username} style={{display:'flex',alignItems:'center',gap:6,padding:'6px 12px',background:'rgba(48,209,88,.12)',border:'1px solid rgba(48,209,88,.3)',borderRadius:20,animationDelay:`${0.75+i*0.1}s`}}>
                <span style={{fontSize:16}}>🏆</span>
                <span style={{fontSize:13,fontWeight:600,color:'#30d158'}}>{p.name}</span>
              </div>
            ))}
          </div>
        </div>
        <div className="win-cards">
          <div style={{fontSize:10,letterSpacing:3,color:'rgba(255,255,255,.3)',textTransform:'uppercase',fontWeight:700,textAlign:'center',marginBottom:12}}>В БУНКЕРЕ</div>
          {surv.map((p,i)=>(
            <div key={p.username} className="win-player-card" style={{animationDelay:`${0.9+i*0.12}s`}}>
              <div style={{fontSize:28,filter:'drop-shadow(0 0 10px rgba(48,209,88,.6))'}}>🏆</div>
              <div style={{flex:1}}>
                <div style={{fontSize:15,fontWeight:700,color:'#30d158'}}>{p.name}</div>
                <div style={{fontSize:11,color:'rgba(255,255,255,.4)',marginTop:2}}>{p.cards?.profession||'—'}</div>
              </div>
              {p.username===user.username&&<div style={{fontSize:9,letterSpacing:2,color:'#30d158',fontWeight:700,background:'rgba(48,209,88,.15)',padding:'3px 8px',borderRadius:8}}>ВЫ</div>}
            </div>
          ))}
          {dead.length>0&&(
            <>
              <div style={{fontSize:10,letterSpacing:3,color:'rgba(255,255,255,.3)',textTransform:'uppercase',fontWeight:700,textAlign:'center',margin:'14px 0 10px'}}>ВЫБЫЛИ</div>
              {dead.map((p,i)=>(
                <div key={p.username} className="dead-player-card" style={{animationDelay:`${1.1+i*0.08}s`}}>
                  <div style={{fontSize:22,filter:'grayscale(1)',opacity:.5}}>💀</div>
                  <div style={{flex:1}}>
                    <div style={{fontSize:13,color:'rgba(255,255,255,.3)',textDecoration:'line-through'}}>{p.name}</div>
                    <div style={{fontSize:10,color:'rgba(255,255,255,.2)',marginTop:1}}>{p.cards?.profession||'—'}</div>
                  </div>
                </div>
              ))}
            </>
          )}
        </div>
        <div style={{position:'fixed',bottom:0,left:0,right:0,padding:'12px 16px 28px',background:'linear-gradient(0deg,#00060a 60%,transparent)',zIndex:20}}>
          <Btn cls="btn-gr" ch="↩ ВЕРНУТЬСЯ В МЕНЮ" onClick={onExit}/>
        </div>
      </div>
    );
  }

  /* DEBATES */
  if(sub==='debates'||(game.phase==='debates'&&sub!=='elim'&&sub!=='over')){
    const debateTime=debateTimeLeft;
    const alive=Object.values(game.players||{}).filter(p=>!p.isEliminated);
    const timePerPlayer=Math.max(1,Math.floor(60/alive.length));
    const elapsed=60-debateTime;
    const currentSpeakerIdx=Math.min(alive.length-1,Math.floor(elapsed/timePerPlayer));
    const currentSpeaker=alive[currentSpeakerIdx];
    const timeInThisSlot=elapsed%timePerPlayer;
    const slotRemaining=timePerPlayer-timeInThisSlot;
    const isMyTurn=currentSpeaker&&currentSpeaker.username===user.username;
    return(
      <div className="sc">
        <div className="tb"><div className="tb-title">🎤 ДЕБАТЫ</div>
          <div style={{fontFamily:"'Inter',sans-serif",fontSize:11,color:'var(--tx3)'}}>Раунд {game.round}</div>
        </div>
        <div className="scr">
          {/* Большой таймер */}
          <div style={{textAlign:'center',padding:'28px 0 20px'}}>
            <div style={{fontSize:72,fontWeight:800,color:debateTime<=10?'var(--r)':debateTime<=30?'#ff9f0a':'var(--g)',lineHeight:1,fontVariantNumeric:'tabular-nums',transition:'color .3s'}}>{String(debateTime).padStart(2,'0')}</div>
            <div style={{fontSize:12,color:'var(--tx3)',marginTop:6,fontWeight:500}}>секунд на защиту</div>
            {/* Timer bar shrinks from full to 0 over 60 seconds */}
            <div style={{width:'220px',height:4,background:'rgba(255,255,255,0.1)',borderRadius:2,margin:'12px auto 0',overflow:'hidden'}}>
              <div style={{width:Math.max(0,(debateTime/60)*100)+'%',height:'100%',background:debateTime<=10?'var(--r)':debateTime<=30?'#ff9f0a':'var(--g)',borderRadius:2,transition:'width .5s linear,background .3s'}}/>
            </div>
          </div>
          {/* Current speaker banner */}
          {isMyTurn&&(
            <div style={{background:'rgba(48,209,88,0.12)',border:'1px solid rgba(48,209,88,0.4)',borderRadius:'var(--rad-sm)',padding:'12px 16px',marginBottom:14,textAlign:'center',boxShadow:'0 0 18px rgba(48,209,88,0.2)'}}>
              <div style={{fontSize:20,marginBottom:4}}>🎙️</div>
              <div style={{fontSize:14,fontWeight:700,color:'var(--g)'}}>Ваша очередь говорить!</div>
              <div style={{fontSize:12,color:'var(--tx3)',marginTop:4}}>Осталось {slotRemaining} сек</div>
            </div>
          )}
          <div className="lbl">🗣 ПОРЯДОК ВЫСТУПЛЕНИЙ</div>
          {alive.map((p,i)=>{
            const isCurrent=i===currentSpeakerIdx;
            const isMe=p.username===user.username;
            return(
              <div key={p.username} style={{display:'flex',alignItems:'center',gap:12,padding:'12px 16px',background:isCurrent?'rgba(48,209,88,0.08)':isMe?'rgba(240,165,0,0.07)':'rgba(255,255,255,0.04)',border:`1px solid ${isCurrent?'rgba(48,209,88,0.5)':isMe?'rgba(240,165,0,0.25)':'rgba(255,255,255,0.08)'}`,borderRadius:'var(--rad-sm)',marginBottom:6,boxShadow:isCurrent?'0 0 12px rgba(48,209,88,0.25)':'none',transition:'border .3s,box-shadow .3s,background .3s'}}>
                <div style={{width:28,height:28,borderRadius:'50%',background:isCurrent?'rgba(48,209,88,0.2)':'rgba(255,255,255,0.08)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:isCurrent?18:12,fontWeight:700,color:isCurrent?'var(--g)':'var(--tx3)',flexShrink:0,transition:'background .3s,color .3s'}}>{isCurrent?'🎙️':i+1}</div>
                <div style={{flex:1}}>
                  <div style={{fontSize:14,fontWeight:600,color:isCurrent?'var(--g)':isMe?'var(--a)':'var(--tx)'}}>{p.name}{isMe&&' (вы)'}</div>
                  <div style={{fontSize:11,color:'var(--tx3)'}}>@{p.username}{isCurrent&&<span style={{marginLeft:6,color:'var(--g)',fontWeight:600}}> · {slotRemaining} сек</span>}</div>
                </div>
                {isCurrent&&<div style={{fontSize:11,fontWeight:700,color:'var(--g)',background:'rgba(48,209,88,0.15)',border:'1px solid rgba(48,209,88,0.3)',borderRadius:6,padding:'3px 8px'}}>говорит</div>}
              </div>
            );
          })}
          <div style={{background:'rgba(240,165,0,0.06)',border:'1px solid rgba(240,165,0,0.15)',borderRadius:'var(--rad-sm)',padding:'14px 16px',marginTop:14}}>
            <div style={{fontSize:13,fontWeight:600,color:'var(--a)',marginBottom:6}}>💡 Правила дебатов</div>
            <div style={{fontSize:12,color:'var(--tx3)',lineHeight:1.6}}>Каждый игрок получает {timePerPlayer} сек чтобы объяснить почему он нужен в бункере. Убеди других в своей ценности до начала голосования!</div>
          </div>
        </div>
      </div>
    );
  }

  /* RADIO */
  if(sub==='radio'&&game.radio){
    const alive=Object.values(game.players||{}).filter(p=>!p.isEliminated&&p.username!==user.username);
    const sendRadio=async()=>{
      if(!radioInput.trim()||!radioTarget)return;
      const radioKey=[user.username,radioTarget].sort().join('_');
      await db.ref(`radioChats/${gameId}/${radioKey}`).push({from:user.username,name:user.displayName||user.username,text:radioInput.trim(),ts:Date.now()});
      setRadioInput('');
    };
    return(
      <div style={{position:'fixed',inset:0,background:'var(--bg)',display:'flex',flexDirection:'column',zIndex:200,animation:'fadeUp .2s ease'}}>
        <div className="tb"><BackBtn onClick={()=>setSub('round')}/><div className="tb-title">📡 РАДИО</div></div>
        {!radioTarget?(
          <div style={{flex:1,overflowY:'auto',padding:16}}>
            <div className="lbl">ВЫБЕРИ СОБЕСЕДНИКА</div>
            {alive.length===0
              ?<div style={{textAlign:'center',padding:28,color:'var(--tx3)',fontSize:13}}>Нет других живых игроков</div>
              :alive.map(p=>(
                <div key={p.username} onClick={()=>setRadioTarget(p.username)}
                  style={{display:'flex',alignItems:'center',gap:12,padding:'14px 16px',background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad-sm)',marginBottom:8,cursor:'pointer',transition:'.18s'}}
                  onMouseEnter={e=>e.currentTarget.style.borderColor='rgba(10,132,255,0.4)'}
                  onMouseLeave={e=>e.currentTarget.style.borderColor='rgba(255,255,255,0.08)'}>
                  <div style={{fontSize:28}}>📡</div>
                  <div><div style={{fontSize:14,fontWeight:600}}>{p.name}</div><div style={{fontSize:11,color:'var(--tx3)'}}>@{p.username}</div></div>
                </div>
              ))
            }
          </div>
        ):(
          <>
            <div style={{padding:'10px 16px',background:'rgba(10,132,255,0.08)',borderBottom:'1px solid rgba(10,132,255,0.2)',display:'flex',alignItems:'center',gap:10,flexShrink:0}}>
              <button onClick={()=>setRadioTarget(null)} style={{background:'none',border:'none',color:'var(--tx3)',cursor:'pointer',fontSize:20,lineHeight:1}}>←</button>
              <div style={{fontSize:14,fontWeight:600,color:'#0a84ff'}}>📡 {(game.players||{})[radioTarget]?.name||radioTarget}</div>
              <div style={{fontSize:10,color:'var(--tx3)',marginLeft:'auto'}}>🔒 приватный канал</div>
            </div>
            <div style={{flex:1,overflowY:'auto',padding:14,display:'flex',flexDirection:'column',gap:8}}>
              {radioMsgs.length===0&&<div style={{textAlign:'center',color:'var(--tx3)',fontSize:12,marginTop:32,lineHeight:1.8}}>📡 Канал открыт<br/>Говорите тайно</div>}
              {radioMsgs.map((m,i)=>(
                <div key={i} className={`bubble ${m.from===user.username?'me':'other'}`}>
                  {m.from!==user.username&&<div className="bubble-from">{m.name}</div>}
                  {m.text}
                </div>
              ))}
            </div>
            <div style={{display:'flex',gap:8,padding:'10px 14px',background:'rgba(255,255,255,0.04)',borderTop:'1px solid rgba(255,255,255,0.08)',flexShrink:0}}>
              <input className="inp" style={{marginBottom:0,flex:1}} value={radioInput} onChange={e=>setRadioInput(e.target.value)}
                onKeyDown={e=>e.key==='Enter'&&sendRadio()} placeholder="Тайное сообщение..."/>
              <button className="chat-send" style={{borderRadius:'var(--rad-sm)'}} onClick={sendRadio}>→</button>
            </div>
          </>
        )}
      </div>
    );
  }

  /* NOTES */
  if(sub==='notes'){
    const notesKey=`notes_${gameId}_${user.username}`;
    return(
      <div className="sc">
        <HZ/><div className="tb"><BackBtn onClick={()=>setSub('round')}/><div className="tb-title">📝 ЗАМЕТКИ</div></div>
        <div className="scr-raw" style={{padding:16}}>
          <div style={{fontSize:12,color:'var(--tx3)',marginBottom:10}}>Ваши личные заметки — видны только вам</div>
          <textarea className="notes-area" value={notes} onChange={e=>{setNotes(e.target.value);localStorage.setItem(notesKey,e.target.value);}} placeholder="Пишите здесь ваши наблюдения, подозрения, стратегию..."/>
          <div style={{fontSize:11,color:'var(--tx3)',marginTop:6,textAlign:'right'}}>Сохраняется автоматически</div>
        </div>
      </div>
    );
  }

  /* EVENT LOG */
  if(sub==='journal'){
    const logTypeColor={reveal:'var(--g)',vote:'var(--r)',elim:'var(--r)',join:'var(--c)',start:'var(--a)',end:'var(--a)',default:'var(--tx3)'};
    const logTypeIcon={reveal:'🃏',vote:'🗳',elim:'☠️',join:'👤',start:'🚀',end:'🏁'};
    return(
      <div className="sc">
        <HZ/><div className="tb"><BackBtn onClick={()=>setSub('round')}/><div className="tb-title">📋 ЖУРНАЛ</div></div>
        <div className="scr-raw">
          {eventLog.length===0?(
            <div className="mono" style={{textAlign:'center',color:'var(--tx3)',fontSize:10,letterSpacing:2,padding:36}}>ЖУРНАЛ ПУСТ</div>
          ):[...eventLog].reverse().map((entry,i)=>{
            const d=new Date(entry.ts);
            const timeStr=`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            const color=logTypeColor[entry.type]||logTypeColor.default;
            const icon=logTypeIcon[entry.type]||'•';
            return(
              <div key={i} className="log-entry">
                <span className="log-ts">{timeStr}</span>
                <span style={{flexShrink:0,marginTop:1}}>{icon}</span>
                <span style={{flex:1,color:entry.type==='elim'?'var(--r)':entry.type==='reveal'?'var(--g)':entry.type==='vote'?'var(--tx2)':'var(--tx)'}}>{entry.text}</span>
              </div>
            );
          })}
        </div>
      </div>
    );
  }

  /* BUNKER MAP */
  if(sub==='map'&&game.bunkerMap){
    const roomAssign=game.roomAssign||{};
    const myRoomId=roomAssign[user.username];
    const myRoom=myRoomId?BUNKER_ROOMS.find(r=>r.id===myRoomId):null;
    const alive=Object.values(game.players||{}).filter(p=>!p.isEliminated);
    return(
      <div className="sc">
        <div className="tb"><BackBtn onClick={()=>setSub('round')}/><div className="tb-title">🗺️ БУНКЕР</div></div>
        <div className="scr">
          {myRoom&&(
            <div style={{background:myRoom.bg,border:`1px solid ${myRoom.color}44`,borderRadius:'var(--rad)',padding:'16px',marginBottom:16,textAlign:'center'}}>
              <div style={{fontSize:36,marginBottom:6}}>{myRoom.icon}</div>
              <div style={{fontSize:16,fontWeight:700,color:myRoom.color,marginBottom:4}}>Ваша комната: {myRoom.name}</div>
              <div style={{fontSize:12,color:'var(--tx3)',lineHeight:1.5}}>{myRoom.bonus}</div>
            </div>
          )}
          <div className="lbl">🏗️ СХЕМА БУНКЕРА</div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:16}}>
            {BUNKER_ROOMS.map(room=>{
              const roomPlayers=alive.filter(p=>roomAssign[p.username]===room.id);
              const isMyRoom=myRoomId===room.id;
              return(
                <div key={room.id} style={{background:isMyRoom?room.bg:'rgba(255,255,255,0.03)',border:`1px solid ${isMyRoom?room.color+'66':'rgba(255,255,255,0.08)'}`,borderRadius:'var(--rad-sm)',padding:'12px',transition:'.2s'}}>
                  <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                    <span style={{fontSize:20}}>{room.icon}</span>
                    <span style={{fontSize:12,fontWeight:600,color:isMyRoom?room.color:'var(--tx)'}}>{room.name}</span>
                  </div>
                  {roomPlayers.length===0?<div style={{fontSize:10,color:'var(--tx3)'}}>Пусто</div>:
                  roomPlayers.map(p=>(
                    <div key={p.username} style={{fontSize:11,color:p.username===user.username?'var(--a)':'var(--tx2)',marginBottom:2}}>
                      {p.username===user.username?'👤 Вы':p.name}
                    </div>
                  ))}
                </div>
              );
            })}
          </div>
        </div>
      </div>
    );
  }

  /* VOTE HISTORY */
  if(sub==='voteHistory'&&game.voteHistory){
    const log=game.voteLog||{};
    const rounds=Object.keys(log).sort();
    return(
      <div className="sc">
        <div className="tb"><BackBtn onClick={()=>setSub('round')}/><div className="tb-title">📊 ИСТОРИЯ ГОЛОСОВАНИЙ</div></div>
        <div className="scr">
          {rounds.length===0?<div style={{textAlign:'center',padding:28,color:'var(--tx3)',fontSize:13}}>История пуста</div>:
          rounds.map(r=>{
            const entry=log[r];
            const tally=entry.tally||{};
            const votes=entry.votes||{};
            return(
              <div key={r} style={{marginBottom:16}}>
                <div className="lbl">{r}</div>
                {Object.entries(votes).filter(([,v])=>v).map(([voter,target])=>{
                  const vname=game.players[voter]?.name||voter;
                  const tname=game.players[target]?.name||target;
                  return(
                    <div key={voter} style={{display:'flex',alignItems:'center',gap:8,padding:'8px 12px',background:'rgba(255,255,255,0.03)',border:'1px solid rgba(255,255,255,0.07)',borderRadius:'var(--rad-sm)',marginBottom:4,fontSize:13}}>
                      <span style={{color:'var(--tx)',fontWeight:500}}>{vname}</span>
                      <span style={{color:'var(--tx3)',fontSize:16}}>→</span>
                      <span style={{color:'var(--r)',fontWeight:500}}>{tname}</span>
                      {voter===user.username&&<span style={{marginLeft:'auto',fontSize:10,color:'var(--a)'}}>вы</span>}
                    </div>
                  );
                })}
                <div style={{display:'flex',gap:6,flexWrap:'wrap',marginTop:6}}>
                  {Object.entries(tally).sort(([,a],[,b])=>b-a).map(([uid,cnt])=>{
                    const name=game.players[uid]?.name||uid;
                    return cnt>0&&<span key={uid} style={{fontSize:11,padding:'3px 10px',background:'rgba(255,69,58,0.1)',border:'1px solid rgba(255,69,58,0.2)',borderRadius:'var(--rad-sm)',color:'var(--r)'}}>☠ {name}: {cnt}</span>;
                  })}
                </div>
              </div>
            );
          })}
        </div>
      </div>
    );
  }

  /* MY ROLE */
  if(sub==='role'&&game.roles){
    const myRoleId=me?.role||'civilian';
    const myRole=ROLES.find(r=>r.id===myRoleId)||ROLES[4];
    return(
      <div className="sc">
        <div className="tb"><BackBtn onClick={()=>setSub('round')}/><div className="tb-title">🎭 МОЯ РОЛЬ</div></div>
        <div className="scr">
          <div style={{textAlign:'center',padding:'32px 0 24px'}}>
            <div style={{fontSize:64,marginBottom:12}}>{myRole.icon}</div>
            <div style={{fontSize:28,fontWeight:800,color:myRole.color,marginBottom:8}}>{myRole.name}</div>
            <div style={{fontSize:14,color:'var(--tx2)',lineHeight:1.6,maxWidth:280,margin:'0 auto'}}>{myRole.desc}</div>
          </div>
          {myRoleId==='medic'&&(
            <div style={{background:'rgba(48,209,88,0.06)',border:'1px solid rgba(48,209,88,0.2)',borderRadius:'var(--rad-sm)',padding:'14px 16px',marginTop:8}}>
              <div style={{fontSize:13,fontWeight:600,color:'var(--g)',marginBottom:6}}>💉 Способность: Спасение</div>
              <div style={{fontSize:12,color:'var(--tx3)',lineHeight:1.5}}>Во время голосования нажми кнопку «💉 Спасти» рядом с игроком которого хочешь защитить. Используется 1 раз за игру.</div>
              {game.medicUsed?.[user.username]&&<div style={{marginTop:8,fontSize:12,color:'var(--r)'}}>⚠️ Способность уже использована</div>}
            </div>
          )}
          {myRoleId==='spy'&&(
            <div style={{background:'rgba(10,132,255,0.06)',border:'1px solid rgba(10,132,255,0.2)',borderRadius:'var(--rad-sm)',padding:'14px 16px',marginTop:8}}>
              <div style={{fontSize:13,fontWeight:600,color:'#0a84ff',marginBottom:6}}>🕵️ Способность: Слежка</div>
              <div style={{fontSize:12,color:'var(--tx3)',lineHeight:1.5}}>Ты видишь первую скрытую карту каждого игрока в разделе «Игроки».</div>
            </div>
          )}
          <div className="lbl">ВСЕ РОЛИ</div>
          {ROLES.map(role=>(
            <div key={role.id} style={{display:'flex',alignItems:'center',gap:12,padding:'12px 16px',background:role.id===myRoleId?`${role.color}11`:'rgba(255,255,255,0.03)',border:`1px solid ${role.id===myRoleId?role.color+'44':'rgba(255,255,255,0.07)'}`,borderRadius:'var(--rad-sm)',marginBottom:6,opacity:role.id===myRoleId?1:0.5}}>
              <span style={{fontSize:24}}>{role.icon}</span>
              <div><div style={{fontSize:13,fontWeight:600,color:role.id===myRoleId?role.color:'var(--tx)'}}>{role.name}</div><div style={{fontSize:11,color:'var(--tx3)'}}>{role.desc}</div></div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  /* ROUND */
  const spots=alive.map((_,i)=><div key={i} className={`bspot ${i<game.bunkerSpots?'free':'taken'}`}/>);
  const feed=alive.flatMap(p=>(p.revealed||[]).map(k=>{const m=CARDS.find(c=>c.key===k)||{};return(
    <div key={`${p.username}-${k}`} className="feed-item">
      <div style={{fontSize:12,fontWeight:700,color:'var(--a2)',minWidth:72,flexShrink:0}}>{p.name}</div>
      <div style={{flex:1}}>
        <div className="mono" style={{fontSize:8,color:'var(--tx3)',letterSpacing:1}}>{m.icon||''} {m.label||k}</div>
        <div style={{fontSize:12,color:'var(--tx)',marginTop:2}}>{p.cards?.[k]||'—'}</div>
      </div>
    </div>
  );}));

  return(
    <div className="sc">
      <HZ/>
      <div style={{display:'flex',alignItems:'center',gap:12,padding:'10px 14px',background:'var(--s1)',backdropFilter:'var(--bl)',WebkitBackdropFilter:'var(--bl)',borderBottom:'1px solid var(--ab)',flexShrink:0}}>
        <div style={{fontFamily:"'Inter',sans-serif",fontSize:52,color:'var(--a)',lineHeight:1,minWidth:56}}>{game.round}</div>
        <div style={{flex:1}}>
          <div className="mono" style={{fontSize:8,letterSpacing:2,color:'var(--tx3)'}}>АПОКАЛИПСИС</div>
          <div style={{fontSize:14,fontWeight:600}}>{ap.emoji} {ap.name}</div>
          <div className="mono" style={{fontSize:8,letterSpacing:2,color:'var(--tx3)',marginTop:3}}>ЖИВЫХ / МЕСТ</div>
          <div style={{fontSize:14,fontWeight:600}}>{alive.length} / {game.bunkerSpots}</div>
        </div>
        <div style={{display:'flex',flexDirection:'column',gap:6}}>
          <button onClick={()=>setSub('cards')} style={{background:'var(--s1)',border:'1px solid var(--ab)',color:'var(--tx3)',padding:'6px 10px',fontFamily:"'Inter',sans-serif",fontSize:14,cursor:'pointer',transition:'.2s'}}>🃏</button>
          <button onClick={()=>{setShowChat(true);setUnread(0);}} style={{background:'var(--s1)',border:`1px solid ${unread>0?'rgba(0,184,217,.35)':'var(--ab)'}`,color:unread>0?'var(--c)':'var(--tx3)',padding:'6px 10px',fontFamily:"'Inter',sans-serif",fontSize:14,cursor:'pointer',position:'relative',transition:'.2s'}}>
            💬{unread>0&&<span style={{position:'absolute',top:-4,right:-4,background:'var(--r)',color:'#fff',fontSize:7,width:12,height:12,borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center'}}>{unread}</span>}
          </button>
        </div>
      </div>
      {/* Round Timer display */}
      {game.roundTimerSeconds&&game.phase==='playing'&&roundTimerLeft!==null&&(
        <div className={`round-timer${roundTimerLeft<=10?' urgent':''}`}>
          <span style={{fontSize:18}}>⏱</span>
          <span style={{fontFamily:"'Share Tech Mono',monospace",fontSize:20,color:roundTimerLeft<=10?'var(--r)':roundTimerLeft<=30?'#ff9f0a':'var(--tx)',fontWeight:700}}>{String(Math.floor(roundTimerLeft/60)).padStart(2,'0')}:{String(roundTimerLeft%60).padStart(2,'0')}</span>
          <span style={{fontSize:11,color:'var(--tx3)'}}>до голосования</span>
          <div style={{flex:1,height:4,background:'rgba(255,255,255,0.08)',borderRadius:2,overflow:'hidden',marginLeft:4}}>
            <div style={{height:'100%',width:`${(roundTimerLeft/game.roundTimerSeconds)*100}%`,background:roundTimerLeft<=10?'var(--r)':roundTimerLeft<=30?'#ff9f0a':'var(--g)',borderRadius:2,transition:'width 1s linear'}}/>
          </div>
        </div>
      )}
      <div className="scr-raw" style={{paddingBottom:160}}>
        <div style={{display:'flex',gap:4,flexWrap:'wrap',padding:'12px 0 8px'}}>{spots}</div>
        {/* Visual player cards */}
        <div className="lbl">ИГРОКИ</div>
        {Object.values(game.players||{}).map(p=>{
          const isElim=p.isEliminated;
          const accentColor=isElim?'var(--r)':'var(--g)';
          const pRevd=p.revealed||[];
          const CHIP_COLORS={profession:'var(--c)',health:'var(--g)',hobby:'var(--p)',baggage:'var(--a)',fact:'var(--r)'};
          const allUsersData=game._allUsers||{};
          const isOnlineP=!!(online&&online[p.username]);
          return(
            <div key={p.username} className={`player-game-card${isElim?' elim':''}`} onClick={()=>onViewProfile&&onViewProfile(p.username)} style={{cursor:'pointer'}}>
              <div className="player-game-card-accent" style={{background:accentColor,marginTop:-14,marginBottom:-14,paddingTop:14,paddingBottom:14}}/>
              <div style={{flex:1}}>
                <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:pRevd.length>0?8:0}}>
                  <Avatar name={p.name||p.username} size="sm" avatar={allUsersData[p.username]?.avatar}/>
                  <span style={{fontSize:14,fontWeight:700,color:'var(--tx)',textDecoration:isElim?'line-through':'none',flex:1}}>{p.name||p.username}</span>
                  {p.username===user.username&&<span style={{fontSize:9,fontWeight:700,color:'var(--a)',background:'rgba(240,165,0,0.15)',border:'1px solid rgba(240,165,0,0.3)',borderRadius:6,padding:'2px 6px'}}>ВЫ</span>}
                  {isOnlineP&&<span style={{width:7,height:7,borderRadius:'50%',background:'var(--g)',boxShadow:'0 0 6px var(--g)',display:'inline-block',flexShrink:0}}/>}
                </div>
                {pRevd.length>0&&(
                  <div style={{display:'flex',flexWrap:'wrap',gap:2}}>
                    {pRevd.map(cardKey=>{
                      const cardMeta=CARDS.find(c=>c.key===cardKey)||{};
                      const chipColor=CHIP_COLORS[cardKey]||'var(--tx3)';
                      return(
                        <span key={cardKey} className="card-chip" style={{background:`rgba(255,255,255,0.06)`,border:`1px solid rgba(255,255,255,0.15)`,color:'var(--tx2)'}}>
                          {cardMeta.icon||''} {p.cards?.[cardKey]||cardKey}
                        </span>
                      );
                    })}
                  </div>
                )}
              </div>
            </div>
          );
        })}
        <div className="lbl">РАСКРЫТЫЕ КАРТЫ</div>
        {feed.length>0?feed:<div className="mono" style={{fontSize:10,color:'var(--tx3)',textAlign:'center',padding:'16px 0'}}>Пока ничего не раскрыто</div>}
        {/* Card reactions in round feed */}
        {alive.filter(p=>p.username!==user.username).map(p=>{
          const pRevealed=(p.revealed||[]);
          if(pRevealed.length===0)return null;
          const pReactions=reactions[p.username]||{};
          return(
            <div key={`react-${p.username}`} style={{marginTop:6}}>
              {pRevealed.map(cardKey=>{
                const reaction=pReactions[cardKey];
                const EMOJIS=['👍','😱','😂','🔥','💀','🤔'];
                return(
                  <div key={cardKey} className="react-bar">
                    {reaction&&(
                      <span className={`react-chip${reaction.reactorUsername===user.username?' mine':''}`}>
                        {reaction.emoji} <span style={{fontSize:10,color:'var(--tx3)'}}>{p.name?.split(' ')[0]||p.username} · {CARDS.find(c=>c.key===cardKey)?.label||cardKey}</span>
                      </span>
                    )}
                    <span className="react-add" onClick={()=>setShowReactPicker(showReactPicker&&showReactPicker.username===p.username&&showReactPicker.cardKey===cardKey?null:{username:p.username,cardKey})}>+</span>
                    {showReactPicker&&showReactPicker.username===p.username&&showReactPicker.cardKey===cardKey&&(
                      <span style={{display:'inline-flex',gap:4,background:'rgba(18,18,28,0.98)',border:'1px solid rgba(255,255,255,0.12)',borderRadius:16,padding:'3px 8px'}}>
                        {EMOJIS.map(em=>(
                          <span key={em} style={{cursor:'pointer',fontSize:16,padding:'0 2px'}} onClick={()=>{DB.setReaction(gameId,p.username,cardKey,em,user.username);setShowReactPicker(null);}}>{em}</span>
                        ))}
                      </span>
                    )}
                  </div>
                );
              })}
            </div>
          );
        })}
      </div>
      <div className="fixbot">
        {/* Secret card quick-activate banner */}
        {mySecretCard&&!mySecretUsed&&!me?.isEliminated&&(
          <div onClick={()=>setSub('cards')} style={{
            display:'flex',alignItems:'center',gap:10,padding:'10px 14px',
            background:`linear-gradient(135deg,${mySecretCard.color}22,${mySecretCard.color}0a)`,
            border:`1px solid ${mySecretCard.color}44`,borderRadius:'var(--rad-sm)',cursor:'pointer',marginBottom:4,
          }}>
            <span style={{fontSize:20}}>{mySecretCard.icon}</span>
            <div style={{flex:1}}>
              <div style={{fontSize:11,fontWeight:700,color:mySecretCard.color}}>🃏 {mySecretCard.name}</div>
              <div style={{fontSize:10,color:'rgba(255,255,255,.5)',marginTop:1}}>Секретная карта не активирована — нажми чтобы открыть</div>
            </div>
            <span style={{fontSize:16,color:mySecretCard.color}}>›</span>
          </div>
        )}
        <div className="brow">
          <Btn ch="🃏 КАРТЫ" onClick={()=>setSub('cards')} cls="btn-g" sm/>
          <Btn ch={me?.isEliminated?'💀 ВЫБЫЛИ':revLeft<=0?`✅ (${maxRev}/${maxRev})`:revLeft<maxRev?`↗ ЕЩЁ (${revLeft})`:'↗ РАСКРЫТЬ'}
            onClick={()=>setSub('pick')} cls="btn-c" sm disabled={!me||me.isEliminated||revLeft<=0}/>
        </div>
        <div className="brow" style={{flexWrap:'wrap',gap:6}}>
          <Btn ch="📝 ЗАМЕТКИ" onClick={()=>setSub('notes')} cls="btn-g" sm/>
          <Btn ch="📋 ЖУРНАЛ" onClick={()=>setSub('journal')} cls="btn-g" sm/>
          {game.roles&&me&&!me.isEliminated&&<Btn ch="🎭 РОЛЬ" onClick={()=>setSub('role')} cls="btn-g" sm/>}
          {game.radio&&me&&!me.isEliminated&&<Btn ch="📡 РАДИО" onClick={()=>setSub('radio')} cls="btn-g" sm/>}
          {game.bunkerMap&&<Btn ch="🗺️ БУНКЕР" onClick={()=>setSub('map')} cls="btn-g" sm/>}
          {game.voteHistory&&game.voteLog&&Object.keys(game.voteLog).length>0&&<Btn ch="📊 ИСТОРИЯ" onClick={()=>setSub('voteHistory')} cls="btn-g" sm/>}
        </div>
        {isCreator&&<Btn ch="🗳 НАЧАТЬ ГОЛОСОВАНИЕ" onClick={startVote} cls="btn-d" sm/>}
        {user.isAdmin&&<AdminCheatPanel gameId={gameId} game={game} user={user} toast={toast} phase="game"/>}
      </div>
    </div>
  );
}

/* Game Chat as an inner component (avoids setState during render) */
function GameChatInner({gameId,user,onClose}){
  const[msgs,setMsgs]=useState([]);
  useEffect(()=>{const u=DB.watchGameChat(gameId,m=>setMsgs(m));return u;},[gameId]);
  useEffect(()=>{
    const handler=(e)=>{if(e.key==='Escape')onClose();};
    window.addEventListener('keydown',handler);
    return()=>window.removeEventListener('keydown',handler);
  },[onClose]);
  const send=async(t)=>{await DB.sendGameMsg(gameId,user.username,user.displayName||user.username,t);};
  return<ChatView msgs={msgs} me={user} onSend={send} title="💬 ОБЩИЙ ЧАТ" onClose={onClose} extraPadBot={0}/>;
}

/* ══════════════════════════════════════════════════════════
   FRIENDS SCREEN
══════════════════════════════════════════════════════════ */
function FriendsList({friends,allUsers,online,onViewProfile,setChatFr,remove}){
  const[frSearch,setFrSearch]=useState('');
  const fids=Object.keys(friends);
  const filtered=fids.filter(fid=>{const fu=allUsers[fid];if(!fu)return false;if(!frSearch)return true;return fu.username.toLowerCase().includes(frSearch.toLowerCase())||(fu.displayName||'').toLowerCase().includes(frSearch.toLowerCase());});
  if(fids.length===0)return<div className="mono" style={{textAlign:'center',color:'var(--tx3)',fontSize:10,letterSpacing:2,padding:36}}>НЕТ ДРУЗЕЙ<br/><br/><span style={{fontSize:9}}>Используйте поиск</span></div>;
  return(
    <>
      {fids.length>3&&(
        <div style={{position:'relative',marginBottom:10}}>
          <input className="inp" placeholder="🔍 Поиск друга..." value={frSearch} onChange={e=>setFrSearch(e.target.value)} style={{marginBottom:0,paddingRight:frSearch?36:12}}/>
          {frSearch&&<button onClick={()=>setFrSearch('')} style={{position:'absolute',right:10,top:'50%',transform:'translateY(-50%)',background:'none',border:'none',color:'var(--tx3)',fontSize:16,cursor:'pointer',lineHeight:1}}>✕</button>}
        </div>
      )}
      {filtered.map(fid=>{const fu=allUsers[fid];if(!fu)return null;const isOnline=!!(online&&online[fid]);return(
        <div key={fid} className="fi" style={{cursor:'default'}}>
          <div style={{flex:1,cursor:'pointer'}} onClick={()=>onViewProfile&&onViewProfile(fid)}>
            <div style={{display:'flex',alignItems:'center',gap:6}}>
              <Avatar name={fu.displayName||fu.username} size="sm" avatar={fu.avatar}/>
              <span style={{fontSize:14,fontWeight:600}}>{fu.displayName||fu.username}</span>
              {isOnline?<span style={{width:7,height:7,borderRadius:'50%',background:'var(--g)',boxShadow:'0 0 6px var(--g)',display:'inline-block',flexShrink:0}}/>:<span style={{fontSize:8,color:'var(--tx3)',marginLeft:2}}>офлайн</span>}
            </div>
            <div style={{display:'flex',alignItems:'center',gap:6,marginTop:3}}>
              <div className="mono" style={{fontSize:8,color:'var(--tx3)'}}>@{fu.username}</div>
              <RChip user={fu}/>
            </div>
          </div>
          <button onClick={()=>setChatFr(fid)} style={{background:'rgba(10,132,255,0.12)',border:'1px solid rgba(10,132,255,0.3)',color:'var(--c)',borderRadius:8,padding:'7px 12px',fontSize:16,cursor:'pointer',transition:'.18s',flexShrink:0}} title="Написать">💬</button>
        </div>
      );})}
    </>
  );
}

function FriendsScreen({user,onBack,toast,gameInvites,onAcceptInvite,onViewProfile,online}){
  const[tab,setTab]=useState('friends');
  const[friends,setFr]=useState({});
  const[reqs,setReqs]=useState({});
  const[allUsers,setAU]=useState({});
  const[q,setQ]=useState('');
  const[searching,setSrch]=useState(false);
  const[results,setRes]=useState([]);
  const[chatFr,setChatFr]=useState(null);
  const[chatMsgs,setChatMsgs]=useState([]);

  useEffect(()=>{
    const u1=DB.watchFriends(user.username,f=>setFr(f));
    const u2=DB.watchFriendReqs(user.username,r=>setReqs(r));
    return()=>{u1();u2();};
  },[]);

  useEffect(()=>{
    const ids=[...new Set([...Object.keys(friends),...Object.keys(reqs)])];
    if(!ids.length)return;
    DB.getAllUsers().then(u=>setAU(u));
  },[JSON.stringify([...Object.keys(friends),...Object.keys(reqs)].sort())]);

  useEffect(()=>{
    if(!chatFr){setChatMsgs([]);return;}
    const u=DB.watchPrivChat(user.username,chatFr,m=>setChatMsgs(m));
    DB.markRead(user.username,chatFr,user.username);
    return u;
  },[chatFr]);

  const search=async()=>{
    const qq=q.trim().toLowerCase();if(!qq)return;
    setSrch(true);
    const all=await DB.getAllUsers();setAU(all);
    setRes(Object.values(all).filter(u=>u&&u.username&&u.username!==user.username&&(u.username.toLowerCase().includes(qq)||(u.displayName||'').toLowerCase().includes(qq))).slice(0,10));
    setSrch(false);
  };
  const addFriend=async(tid)=>{
    const r=await DB.sendFriendReq(user.username,tid);
    if(r.e==='already_friends')return toast('Уже в друзьях','err');
    if(r.e==='already_sent')return toast('Запрос уже отправлен','err');
    if(r.e==='not_found')return toast('Не найден','err');
    if(r.e==='self')return toast('Нельзя добавить себя','err');
    if(r.ok==='auto')toast('✅ Теперь вы друзья!','ok');
    else toast('✅ Запрос отправлен!','ok');
    setRes(p=>p.map(u=>u.username===tid?{...u,_req:true}:u));
  };
  const accept=async(fid)=>{await DB.acceptFriend(user.username,fid);toast('✅ Теперь вы друзья!','ok');};
  const reject=async(fid)=>{await DB.rejectFriend(user.username,fid);};
  const remove=async(fid)=>{if(!confirm('Удалить из друзей?'))return;await DB.removeFriend(user.username,fid);toast('Удалено','ok');};
  const acceptInv=async(iid,inv)=>{await DB.removeGameInvite(user.username,iid);onAcceptInvite(inv.gameId);};
  const declineInv=async(iid)=>{await DB.removeGameInvite(user.username,iid);};
  const sendMsg=async(t)=>{if(!chatFr)return;await DB.sendPrivMsg(user.username,chatFr,user.username,user.displayName||user.username,t);DB.markRead(user.username,chatFr,user.username);};

  const rqCnt=Object.keys(reqs).length;
  const ivCnt=Object.keys(gameInvites||{}).length;

  if(chatFr){
    const fu=allUsers[chatFr];
    const isOnline=!!(online&&online[chatFr]);
    return(
      <div className="sc">
        <ChatView msgs={chatMsgs} me={user} onSend={sendMsg}
          title={`💬 ${fu?.displayName||fu?.username||chatFr}`}
          onClose={()=>setChatFr(null)}
          extraPadBot={72}
          onlineStatus={isOnline}
          extra={<button onClick={()=>remove(chatFr)} style={{background:'rgba(255,69,58,0.1)',border:'1px solid rgba(255,69,58,0.3)',color:'var(--r)',fontFamily:"'Inter',sans-serif",fontSize:11,fontWeight:600,padding:'5px 10px',borderRadius:'6px',cursor:'pointer'}}>Удалить</button>}
        />
      </div>
    );
  }

  return(
    <div className="sc">
      <HZ/>
      <div className="tb">
        <BackBtn onClick={onBack}/>
        <div className="tb-title">ДРУЗЬЯ</div>
        <div className="mono" style={{fontSize:10,color:'var(--tx3)',letterSpacing:2}}>{Object.keys(friends).length}</div>
      </div>
      <div className="scr" style={{paddingTop:8}}>
        <div className="tabs">
          <button className={`tab${tab==='friends'?' on':''}`} onClick={()=>setTab('friends')}>ДРУЗЬЯ</button>
          <button className={`tab${tab==='reqs'?' on':''}`} onClick={()=>setTab('reqs')} style={{position:'relative'}}>ЗАПРОСЫ{rqCnt>0&&<span className="tab-badge">{rqCnt}</span>}</button>
          <button className={`tab${tab==='invs'?' on':''}`} onClick={()=>setTab('invs')} style={{position:'relative'}}>ИГРЫ{ivCnt>0&&<span className="tab-badge">{ivCnt}</span>}</button>
          <button className={`tab${tab==='search'?' on':''}`} onClick={()=>setTab('search')}>ПОИСК</button>
          <button className={`tab${tab==='groups'?' on':''}`} onClick={()=>setTab('groups')}>ГРУППЫ</button>
        </div>

        {tab==='friends'&&<FriendsList friends={friends} allUsers={allUsers} online={online} onViewProfile={onViewProfile} setChatFr={setChatFr} remove={remove}/>}
        {false&&null}

        {tab==='reqs'&&(Object.keys(reqs).length===0
          ?<div className="mono" style={{textAlign:'center',color:'var(--tx3)',fontSize:10,letterSpacing:2,padding:36}}>НЕТ ЗАПРОСОВ</div>
          :Object.entries(reqs).map(([fid])=>{const fu=allUsers[fid];return(
            <div key={fid} className="fi">
              <div style={{flex:1}}>
                <div style={{fontSize:14,fontWeight:600}}>{fu?.displayName||fu?.username||fid}</div>
                <div className="mono" style={{fontSize:8,color:'var(--tx3)',marginTop:2}}>@{fid} · хочет добавить</div>
              </div>
              <div style={{display:'flex',gap:6}}>
                <button onClick={()=>accept(fid)} style={{background:'var(--gt)',border:'1px solid var(--gb)',color:'var(--g)',fontFamily:"'Inter',sans-serif",fontSize:9,padding:'5px 10px',cursor:'pointer',letterSpacing:1}}>✓</button>
                <button onClick={()=>reject(fid)} style={{background:'var(--rt)',border:'1px solid var(--rb)',color:'var(--r)',fontFamily:"'Inter',sans-serif",fontSize:9,padding:'5px 10px',cursor:'pointer'}}>✕</button>
              </div>
            </div>
          );})
        )}

        {tab==='invs'&&(Object.keys(gameInvites||{}).length===0
          ?<div className="mono" style={{textAlign:'center',color:'var(--tx3)',fontSize:10,letterSpacing:2,padding:36}}>НЕТ ПРИГЛАШЕНИЙ</div>
          :Object.entries(gameInvites||{}).map(([iid,inv])=>(
            <div key={iid} className="fi">
              <div style={{flex:1}}>
                <div style={{fontSize:14,fontWeight:600}}>Приглашение в игру</div>
                <div className="mono" style={{fontSize:8,color:'var(--tx3)',marginTop:2}}>от {inv.fromName||inv.from} · {inv.gameId}</div>
              </div>
              <div style={{display:'flex',gap:6}}>
                <button onClick={()=>acceptInv(iid,inv)} style={{background:'var(--at)',border:'1px solid var(--ab)',color:'var(--a)',fontFamily:"'Inter',sans-serif",fontSize:9,padding:'5px 10px',cursor:'pointer',letterSpacing:1}}>⚡ ВОЙТИ</button>
                <button onClick={()=>declineInv(iid)} style={{background:'var(--rt)',border:'1px solid var(--rb)',color:'var(--r)',fontFamily:"'Inter',sans-serif",fontSize:9,padding:'5px 10px',cursor:'pointer'}}>✕</button>
              </div>
            </div>
          ))
        )}

        {tab==='search'&&(
          <div>
            <div style={{display:'flex',gap:8,marginBottom:12}}>
              <input className="inp" style={{marginBottom:0,flex:1}} value={q} onChange={e=>setQ(e.target.value)} onKeyDown={e=>e.key==='Enter'&&search()} placeholder="Имя пользователя…" maxLength={20}/>
              <button onClick={search} style={{background:'var(--a)',color:'#000',border:'none',padding:'0 16px',fontFamily:"'Inter',sans-serif",fontSize:15,letterSpacing:2,cursor:'pointer',flexShrink:0}}>{searching?'…':'НАЙТИ'}</button>
            </div>
            {results.map(u=>{
              const isFr=!!friends[u.username];
              return(
                <div key={u.username} className="fi">
                  <div style={{flex:1}}>
                    <div style={{fontSize:14,fontWeight:600}}>{u.displayName||u.username}</div>
                    <div style={{display:'flex',alignItems:'center',gap:6,marginTop:3}}>
                      <div className="mono" style={{fontSize:8,color:'var(--tx3)'}}>@{u.username}</div>
                      <RChip user={u}/>
                    </div>
                  </div>
                  {isFr?<span className="bdg bdg-g">ДРУГ</span>
                   :u._req?<span className="bdg bdg-a">ОТПРАВЛЕНО</span>
                   :<button onClick={()=>addFriend(u.username)} style={{background:'var(--at)',border:'1px solid var(--ab)',color:'var(--a)',fontFamily:"'Inter',sans-serif",fontSize:9,padding:'5px 10px',cursor:'pointer',letterSpacing:1}}>+ ДОБАВИТЬ</button>}
                </div>
              );
            })}
            {q&&!searching&&results.length===0&&<div className="mono" style={{textAlign:'center',color:'var(--tx3)',fontSize:10,letterSpacing:2,padding:24}}>НЕ НАЙДЕНО</div>}
          </div>
        )}
        {tab==='groups'&&<GroupsScreen user={user} onBack={()=>setTab('friends')} toast={toast} onViewProfile={onViewProfile}/>}
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   PLAYER PROFILE SCREEN
══════════════════════════════════════════════════════════ */
function PlayerProfileScreen({uid, me, onBack, online}){
  const [pUser, setPUser] = useState(null);
  const [loading, setLoading] = useState(true);
  useEffect(()=>{
    DB.getUser(uid).then(u=>{setPUser(u);setLoading(false);});
  },[uid]);
  useEffect(()=>{
    const handler=(e)=>{if(e.key==='Escape')onBack();};
    window.addEventListener('keydown',handler);
    return()=>window.removeEventListener('keydown',handler);
  },[onBack]);
  if(loading) return <div className="sc"><Spin/></div>;
  if(!pUser) return <div className="sc"><div className="tb"><BackBtn onClick={onBack}/><div className="tb-title">Не найден</div></div></div>;
  const rank=getRank(pUser);
  const games=pUser.gamesPlayed||0;
  const wins=pUser.gamesWon||0;
  const elims=pUser.gamesEliminated||0;
  const winRate=games>0?Math.round(wins/games*100):0;
  const isOnline=!!(online&&online[uid]);
  const isMe=me&&me.username===uid;
  return(
    <div className="sc" style={{position:'fixed',inset:0,zIndex:500,background:'var(--bg)'}}>
      <div className="tb"><BackBtn onClick={onBack}/><div className="tb-title">ПРОФИЛЬ</div>{isMe&&<span className="bdg bdg-c">ВЫ</span>}</div>
      <div className="scr">
        <div style={{textAlign:'center',padding:'28px 0 20px',background:'rgba(255,255,255,0.03)',borderRadius:'var(--rad-lg)',marginBottom:14,border:'1px solid rgba(255,255,255,0.07)',position:'relative'}}>
          <Avatar name={pUser.displayName||pUser.username} size="lg"/>
          <div style={{fontSize:20,fontWeight:700,color:'var(--tx)',marginBottom:4}}>{pUser.displayName||pUser.username}</div>
          <div style={{fontSize:12,color:'var(--tx3)',marginBottom:6,display:'flex',alignItems:'center',justifyContent:'center',gap:6}}>
            <span>@{pUser.username}</span>
            {isOnline ? <span style={{display:'inline-flex',alignItems:'center',gap:4,color:'var(--g)',fontSize:11,fontWeight:600}}><span style={{width:7,height:7,borderRadius:'50%',background:'var(--g)',boxShadow:'0 0 6px var(--g)',display:'inline-block'}}/>В сети</span> : <span style={{color:'var(--tx3)',fontSize:11}}>Офлайн</span>}
          </div>
          <div style={{display:'inline-flex',alignItems:'center',gap:6,background:`${rank.color}18`,border:`1px solid ${rank.color}44`,borderRadius:20,padding:'4px 14px'}}>
            <span style={{fontSize:16}}>{rank.icon}</span>
            <span style={{fontSize:12,fontWeight:700,color:rank.color}}>{rank.name}</span>
          </div>
          {pUser.isAdmin&&<div style={{marginTop:8}}><span className="bdg bdg-p">ADMIN</span></div>}
          {pUser.status&&<div style={{marginTop:8,fontSize:12,color:'var(--tx2)',fontStyle:'italic'}}>"{pUser.status}"</div>}
        </div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,marginBottom:14}}>
          {[['☢',games,'Игр','var(--a)'],['🏆',wins,'Побед','var(--g)'],['💀',elims,'Выбыл','var(--r)']].map(([ico,val,lbl,col])=>(
            <div key={lbl} style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad-sm)',padding:'14px 8px',textAlign:'center'}}>
              <div style={{fontSize:22,marginBottom:4}}>{ico}</div>
              <div style={{fontSize:24,fontWeight:700,color:col,lineHeight:1}}>{val}</div>
              <div style={{fontSize:10,color:'var(--tx3)',marginTop:4}}>{lbl}</div>
            </div>
          ))}
        </div>
        {games>0&&(
          <div style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.08)',borderRadius:'var(--rad-sm)',padding:16,marginBottom:14}}>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:8}}>
              <span style={{fontSize:12,color:'var(--tx3)'}}>Процент побед</span>
              <span style={{fontSize:12,fontWeight:700,color:'var(--g)'}}>{winRate}%</span>
            </div>
            <div style={{height:6,background:'rgba(255,255,255,.08)',borderRadius:3,overflow:'hidden'}}>
              <div style={{height:'100%',width:`${winRate}%`,background:'linear-gradient(90deg,var(--g),#30d158)',borderRadius:3,transition:'width .6s ease'}}/>
            </div>
          </div>
        )}
        <div className="lbl">ЗВАНИЕ</div>
        {RANKS.filter(r=>!r.adminOnly||pUser.isAdmin).map(r=>{
          const cur=getRank(pUser).id===r.id;
          return(
            <div key={r.id} style={{display:'flex',alignItems:'center',gap:10,padding:'10px 14px',background:cur?`${r.color}12`:'rgba(255,255,255,0.03)',border:`1px solid ${cur?r.color+'44':'rgba(255,255,255,0.07)'}`,borderRadius:'var(--rad-sm)',marginBottom:6,opacity:cur?1:.5,transition:'.2s'}}>
              <span style={{fontSize:20}}>{r.icon}</span>
              <div style={{flex:1}}>
                <div style={{fontSize:13,fontWeight:600,color:cur?r.color:'var(--tx)'}}>{r.name}</div>
                <div style={{fontSize:11,color:'var(--tx3)'}}>{r.adminOnly?'Только администраторы':r.min===0?'Начальное звание':`от ${r.min} игр`}</div>
              </div>
              {cur&&<span style={{fontSize:10,fontWeight:700,color:r.color,background:`${r.color}20`,border:`1px solid ${r.color}40`,borderRadius:10,padding:'2px 8px'}}>ТЕКУЩЕЕ</span>}
            </div>
          );
        })}
        <div className="lbl" style={{marginTop:14}}>🏅 ДОСТИЖЕНИЯ</div>
        <AchievementsPanel userData={pUser}/>
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   GROUPS SCREEN
══════════════════════════════════════════════════════════ */
function GroupsScreen({user,onBack,toast,onViewProfile}){
  const[groups,setGroups]=useState({});
  const[tab,setTab]=useState('mygroups');
  const[chatGroup,setChatGroup]=useState(null);
  const[chatMsgs,setChatMsgs]=useState([]);
  const[showCreate,setShowCreate]=useState(false);
  const[newName,setNewName]=useState('');
  const[allUsers,setAU]=useState({});

  useEffect(()=>{
    const u=DB.watchGroups(g=>setGroups(g));
    DB.getAllUsers().then(u=>setAU(u));
    return u;
  },[]);

  useEffect(()=>{
    if(!chatGroup){setChatMsgs([]);return;}
    const u=DB.watchGroupChat(chatGroup,m=>setChatMsgs(m));
    return u;
  },[chatGroup]);

  const myGroups=Object.values(groups).filter(g=>g.members&&g.members[user.username]);
  const allGroupsList=Object.values(groups).filter(g=>!(g.members&&g.members[user.username]));

  const createGroup=async()=>{
    if(!newName.trim())return toast('Введите название','err');
    const id=await DB.createGroup(newName.trim(),user.username);
    setNewName('');setShowCreate(false);
    toast('Группа создана!','ok');
  };
  const joinGroup=async(gid)=>{
    await DB.joinGroup(gid,user.username);
    toast('Вы вступили в группу!','ok');
  };
  const leaveGroup=async(gid)=>{
    if(!confirm('Покинуть группу?'))return;
    await DB.leaveGroup(gid,user.username);
    if(chatGroup===gid)setChatGroup(null);
    toast('Вы покинули группу','ok');
  };
  const sendMsg=async(text)=>{
    if(!chatGroup)return;
    await DB.sendGroupMsg(chatGroup,user.username,user.displayName||user.username,text);
  };

  if(chatGroup){
    const g=groups[chatGroup];
    return(
      <div className="sc">
        <ChatView msgs={chatMsgs} me={user} onSend={sendMsg}
          title={`👥 ${g?.name||chatGroup}`}
          onClose={()=>setChatGroup(null)}
          extraPadBot={72}
          extra={<button onClick={()=>leaveGroup(chatGroup)} style={{background:'rgba(255,69,58,0.1)',border:'1px solid rgba(255,69,58,0.3)',color:'var(--r)',fontFamily:"'Inter',sans-serif",fontSize:11,fontWeight:600,padding:'5px 10px',borderRadius:'6px',cursor:'pointer'}}>Выйти</button>}
        />
      </div>
    );
  }

  return(
    <div className="sc">
      <HZ/>
      <div className="tb"><BackBtn onClick={onBack}/><div className="tb-title">ГРУППЫ</div></div>
      <div className="scr" style={{paddingTop:8}}>
        <div className="tabs">
          <button className={`tab${tab==='mygroups'?' on':''}`} onClick={()=>setTab('mygroups')}>МОИ ({myGroups.length})</button>
          <button className={`tab${tab==='all'?' on':''}`} onClick={()=>setTab('all')}>ВСЕ</button>
        </div>
        {tab==='mygroups'&&(
          <>
            <Btn ch="➕ СОЗДАТЬ ГРУППУ" onClick={()=>setShowCreate(v=>!v)} cls="btn-g" sm/>
            {showCreate&&(
              <div style={{background:'rgba(255,255,255,0.04)',border:'1px solid rgba(255,255,255,0.1)',borderRadius:'var(--rad-sm)',padding:14,marginTop:8,marginBottom:10}}>
                <input className="inp" placeholder="Название группы..." value={newName} onChange={e=>setNewName(e.target.value)} onKeyDown={e=>e.key==='Enter'&&createGroup()} maxLength={40} autoFocus/>
                <div style={{display:'flex',gap:8,marginTop:4}}>
                  <Btn ch="✓ СОЗДАТЬ" onClick={createGroup} cls="btn-p" sm/>
                  <Btn ch="Отмена" onClick={()=>setShowCreate(false)} cls="btn-g" sm/>
                </div>
              </div>
            )}
            {myGroups.length===0?<div className="mono" style={{textAlign:'center',color:'var(--tx3)',fontSize:10,letterSpacing:2,padding:36}}>НЕТ ГРУПП</div>:
            myGroups.map(g=>(
              <div key={g.id} className="group-card" onClick={()=>setChatGroup(g.id)}>
                <div className="group-avatar">👥</div>
                <div style={{flex:1}}>
                  <div style={{fontSize:15,fontWeight:700,color:'var(--tx)'}}>{g.name}</div>
                  <div style={{fontSize:11,color:'var(--tx3)',marginTop:2}}>{Object.keys(g.members||{}).length} участников</div>
                </div>
                <button onClick={e=>{e.stopPropagation();leaveGroup(g.id);}} style={{background:'rgba(255,69,58,0.1)',border:'none',color:'var(--r)',borderRadius:6,padding:'5px 9px',fontSize:12,cursor:'pointer'}}>Выйти</button>
              </div>
            ))}
          </>
        )}
        {tab==='all'&&(
          allGroupsList.length===0?<div className="mono" style={{textAlign:'center',color:'var(--tx3)',fontSize:10,letterSpacing:2,padding:36}}>НЕТ ОТКРЫТЫХ ГРУПП</div>:
          allGroupsList.map(g=>(
            <div key={g.id} className="group-card" style={{cursor:'default'}}>
              <div className="group-avatar">👥</div>
              <div style={{flex:1}}>
                <div style={{fontSize:15,fontWeight:700,color:'var(--tx)'}}>{g.name}</div>
                <div style={{fontSize:11,color:'var(--tx3)',marginTop:2}}>{Object.keys(g.members||{}).length} участников</div>
              </div>
              <button onClick={()=>joinGroup(g.id)} style={{background:'rgba(191,90,242,0.15)',border:'1px solid rgba(191,90,242,0.3)',color:'var(--p)',borderRadius:6,padding:'5px 10px',fontSize:11,fontWeight:700,cursor:'pointer'}}>Войти</button>
            </div>
          ))
        )}
      </div>
    </div>
  );
}

/* ══════════════════════════════════════════════════════════
   ROOT APP  —  SINGLE FIXED CONTAINER ARCHITECTURE
   NavBar is position:fixed at bottom (z:8000)
   Screen components never use position:fixed themselves
══════════════════════════════════════════════════════════ */
function SplashScreen({onDone}){
  const[done,setDone]=useState(false);
  useEffect(()=>{
    const t=setTimeout(()=>{setDone(true);setTimeout(onDone,500);},2500);
    return()=>clearTimeout(t);
  },[]);
  return(
    <div className={`splash-screen${done?' done':''}`}>
      <div className="splash-scanlines"/>
      <div className="splash-logo">☢</div>
      <div className="splash-title">— БУНКЕР —</div>
      <div className="splash-sub">С ЛЮБОВЬЮ ОТ ФТИ</div>
      <div className="splash-bar-wrap"><div className="splash-bar"/></div>
    </div>
  );
}

function FirebaseStatus(){
  const[connected,setConnected]=React.useState(true);
  React.useEffect(()=>{
    const ref=db.ref('.info/connected');
    const handler=snap=>setConnected(!!snap.val());
    ref.on('value',handler);
    return()=>ref.off('value',handler);
  },[]);
  return(
    <div className={`fb-status ${connected?'online':'offline'}`} title={connected?'Подключено к серверу':'Нет соединения'}>
      <span style={{width:7,height:7,borderRadius:'50%',background:connected?'var(--g)':'var(--r)',boxShadow:`0 0 6px ${connected?'var(--g)':'var(--r)'}`,display:'inline-block',flexShrink:0}}/>
      {!connected&&'Нет соединения'}
    </div>
  );
}

function App(){
  const[user,setUser]=useState(null);
  const[screen,setScreen]=useState('auth');
  const[splashDone,setSplashDone]=useState(false);
  const[gameId,setGid]=useState(null);
  const[,showToast,toasts,setToasts]=useToast();
  const[reqCnt,setReqCnt]=useState(0);
  const[invites,setInvites]=useState({});
  const[online,setOnline]=useState({});
  const[viewProfile,setViewProfile]=useState(null);
  const[screenDir,setScreenDir]=useState('right');
  const[announcement,setAnnouncement]=useState(null);
  const prevInvIds=useRef(new Set());
  const prevBroadcastIds=useRef(new Set());

  const notif=reqCnt+Object.keys(invites).length;

  // Refresh user
  useEffect(()=>{
    if(!user)return;
    const t=setInterval(async()=>{const f=await DB.getUser(user.username);if(f)setUser(f);},10000);
    return()=>clearInterval(t);
  },[user?.username]);

  // Watch notifications
  useEffect(()=>{
    if(!user)return;
    DB.setOnline(user.username);
    const u1=DB.watchFriendReqs(user.username,r=>setReqCnt(Object.keys(r).length));
    const u2=DB.watchGameInvites(user.username,inv=>{
      const ids=Object.keys(inv);
      ids.forEach(id=>{if(!prevInvIds.current.has(id)&&inv[id])showToast(`⚡ Приглашение от ${inv[id].fromName}!`,'ok');});
      prevInvIds.current=new Set(ids);
      setInvites(inv);
    });
    const u3=DB.watchOnline(o=>setOnline(o));
    // Watch broadcast messages from admin
    const u4=DB.watchBroadcast(msgs=>{
      msgs.forEach(m=>{
        if(!prevBroadcastIds.current.has(m.ts)){
          prevBroadcastIds.current.add(m.ts);
          showToast(`📢 ${m.from}: ${m.text}`,'info');
        }
      });
    });
    // Watch announcement
    const u5=DB.watchAnnouncement(a=>setAnnouncement(a));
    // Watch ban status
    const u6=db.ref(`users/${user.username}/isBanned`).on('value',s=>{
      if(s.val()===true){setUser(null);setScreen('auth');}
    });
    return()=>{u1();u2();u3();u4();u5();db.ref(`users/${user.username}/isBanned`).off('value',u6);};
  },[user?.username]);

  // Re-join active game
  useEffect(()=>{
    if(screen!=='home'||!user)return;
    (async()=>{
      try{
        const gs=await DB.getAllGames();
        const my=Object.values(gs||{}).find(g=>g&&g.players&&g.players[user.username]&&g.phase!=='finished');
        if(my){setGid(my.id);setScreen(my.phase==='lobby'?'lobby':'game');}
      }catch(e){console.error('rejoin error',e);}
    })();
  },[screen,user?.username]);

  const FORWARD_SCREENS=['createGame','joinGame','matchmaking','lobby','game','leaderboard','profile','friends','admin'];
  const nav=s=>{
    const isForward=FORWARD_SCREENS.includes(s);
    setScreenDir(isForward?'right':'left');
    setScreen(s);
  };

  // Escape key handler
  useEffect(()=>{
    const handler=(e)=>{if(e.key==='Escape'){if(viewProfile)setViewProfile(null);}};
    window.addEventListener('keydown',handler);
    return()=>window.removeEventListener('keydown',handler);
  },[viewProfile]);

  const handleAcceptInvite=async(gid)=>{
    const g=await DB.getGame(gid);
    if(!g)return showToast('Игра не найдена','err');
    if(g.phase!=='lobby')return showToast('Игра не в лобби','err');
    if(!g.players?.[user.username]){
      if(Object.keys(g.players||{}).length>=16)return showToast('Комната заполнена','err');
      await DB.updateGame(gid,{[`players/${user.username}`]:{userId:user.username,username:user.username,name:user.displayName||user.username,cards:null,revealed:[],isEliminated:false}});
    }
    setGid(gid);nav('lobby');
  };

  const NAV_SCREENS=['home','friends','leaderboard','profile'];
  const showNav=!!user&&NAV_SCREENS.includes(screen);

  /* NavBar component (inline so it has access to state) */
  const NavBar=()=>(
    <div id="nav-bar">
      {[
        ['home',Ico.home,'ГЛАВНАЯ'],
        ['friends',Ico.users,'ДРУЗЬЯ'],
        ['leaderboard',Ico.trophy,'РЕЙТИНГ'],
        ['profile',Ico.user,'ПРОФИЛЬ'],
      ].map(([s,icon,label])=>(
        <button key={s} className={`nb${screen===s?' on':''}`} onClick={()=>nav(s)}>
          {s==='friends'&&notif>0&&<span className="nb-badge">{notif>9?'9+':notif}</span>}
          {icon}
          <span>{label}</span>
        </button>
      ))}
      <button className="nb" onClick={()=>{setUser(null);setGid(null);nav('auth');}}>
        {Ico.exit}<span>ВЫХОД</span>
      </button>
    </div>
  );

  return(
    <>
      {!splashDone&&<SplashScreen onDone={()=>setSplashDone(true)}/>}
      <Toast toasts={toasts} removeToast={id=>setToasts(p=>p.filter(t=>t.id!==id))}/>
      <FirebaseStatus/>
      <div id="screen-area" className={screenDir==='left'?'sc-back':''}>
        {screen==='auth'&&<AuthScreen onLogin={u=>{setUser(u);nav('home');}} toast={showToast}/>}
        {screen==='home'&&user&&<HomeScreen user={user} nav={nav} online={online} announcement={announcement}/>}
        {screen==='friends'&&user&&<FriendsScreen user={user} onBack={()=>nav('home')} toast={showToast} gameInvites={invites} onAcceptInvite={handleAcceptInvite} onViewProfile={uid=>setViewProfile(uid)} online={online}/>}
        {screen==='profile'&&user&&<ProfileScreen user={user} onBack={()=>nav('home')} toast={showToast} onUpdate={u=>setUser(u)}/>}
        {screen==='leaderboard'&&user&&<LeaderboardScreen me={user} onBack={()=>nav('home')} onViewProfile={uid=>setViewProfile(uid)} online={online}/>}
        {screen==='admin'&&user?.isAdmin&&<AdminScreen me={user} onBack={()=>nav('home')} toast={showToast}/>}
        {screen==='createGame'&&user&&<CreateGameScreen user={user} onBack={()=>nav('home')} onCreated={id=>{setGid(id);nav('lobby');}} toast={showToast}/>}
        {screen==='joinGame'&&user&&<JoinGameScreen user={user} onBack={()=>nav('home')} onJoined={id=>{setGid(id);nav('lobby');}} toast={showToast}/>}
        {screen==='matchmaking'&&user&&<MatchmakingScreen user={user} onBack={()=>nav('home')} onJoined={id=>{setGid(id);nav('lobby');}} toast={showToast}/>}
        {screen==='lobby'&&user&&gameId&&<LobbyScreen gameId={gameId} user={user} onBack={()=>{setGid(null);nav('home');}} onStarted={()=>nav('game')} toast={showToast} onViewProfile={uid=>setViewProfile(uid)}/>}
        {screen==='game'&&user&&gameId&&<GameWrapper key={gameId} gameId={gameId} user={user} onExit={()=>{setGid(null);nav('home');}} toast={showToast} onViewProfile={uid=>setViewProfile(uid)} online={online}/>}
        {viewProfile&&<PlayerProfileScreen uid={viewProfile} me={user} onBack={()=>setViewProfile(null)} online={online}/>}
      </div>
      {showNav&&<NavBar/>}
    </>
  );
}

class ErrorBoundary extends React.Component{
  constructor(p){super(p);this.state={err:null};}
  static getDerivedStateFromError(e){return{err:e};}
  componentDidCatch(e,info){console.error('React error:',e,info);}
  render(){
    if(this.state.err)return(
      <div style={{color:'#fff',padding:24,fontFamily:'monospace',background:'#1a0000',minHeight:'100vh',fontSize:13}}>
        <div style={{color:'#ff453a',fontSize:18,marginBottom:16}}>⚠️ Ошибка рендера</div>
        <div style={{background:'rgba(255,0,0,.1)',padding:12,borderRadius:8,wordBreak:'break-all'}}>
          {this.state.err.toString()}
        </div>
        <button onClick={()=>this.setState({err:null})} style={{marginTop:16,padding:'8px 16px',background:'#ff453a',border:'none',color:'#fff',borderRadius:8,cursor:'pointer'}}>
          Перезагрузить
        </button>
      </div>
    );
    return this.props.children;
  }
}
ReactDOM.createRoot(document.getElementById('app')).render(<ErrorBoundary><App/></ErrorBoundary>);

// ══ BUNKER GATE — кинематографическая анимация (вызывается после логина) ══
window.triggerGate = function(){
  const gate = document.getElementById('bunker-gate');
  const statusTxt = document.getElementById('gate-status-txt');
  if(!gate) return;

  // Показываем ворота
  gate.classList.remove('hidden');
  gate.classList.remove('opening');
  gate.classList.remove('flashing');
  gate.style.opacity = '1';
  gate.style.transition = '';
  const arc = gate.querySelector('.gate-lock-arc');
  if(arc){ arc.style.transform=''; arc.style.opacity=''; }

  const setStatus = (txt) => { if(statusTxt) statusTxt.textContent = txt; };

  setStatus('СИСТЕМА БЕЗОПАСНОСТИ АКТИВНА');
  setTimeout(()=>{ setStatus('ИДЕНТИФИКАЦИЯ... ████████░░ 80%'); }, 600);
  setTimeout(()=>{ setStatus('ДОСТУП РАЗРЕШЁН — ОТКРЫВАЮ ВОРОТА'); }, 1400);
  setTimeout(()=>{
    if(arc){ arc.style.transform='translateY(4px)'; arc.style.opacity='0.4'; }
  }, 1700);
  setTimeout(()=>{
    gate.classList.add('flashing');
    setTimeout(()=>gate.classList.remove('flashing'), 180);
  }, 1900);
  setTimeout(()=>{
    gate.classList.add('opening');
    setStatus('');
  }, 2000);
  setTimeout(()=>{
    gate.style.transition = 'opacity .5s ease';
    gate.style.opacity = '0';
    setTimeout(()=>{ gate.classList.add('hidden'); gate.style.opacity=''; }, 520);
  }, 3200);
};
</script>
</body>
</html>